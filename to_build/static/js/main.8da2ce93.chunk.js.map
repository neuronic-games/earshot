{"version":3,"sources":["models/utils/matrix.ts","models/utils/promise/index.ts","models/utils/getMimeType.ts","../../../binaural-meet/libs/lib-jitsi-meet/service/xmpp/XMPPEvents.js","../../../binaural-meet/libs/lib-jitsi-meet/JitsiConferenceEvents.js","stores/participants/localPlugins/DevicePreference.ts","stores/participants/ParticipantBase.ts","stores/participants/LocalParticipant.ts","stores/participants/RemoteParticipant.ts","stores/participants/Participants.ts","models/api/ConnectionForScreenContent.ts","stores/sharedContents/SharedContentTracks.ts","stores/sharedContents/SharedContents.ts","../../../binaural-meet/libs/lib-jitsi-meet/service/RTC/MediaType.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/browser/index.js","models/locales/index.ts","models/locales/en.ts","models/locales/ja.ts","../../../binaural-meet/libs/lib-jitsi-meet/modules/statistics/statistics.js","stores/RoomInfo.ts","../../../binaural-meet/libs/lib-jitsi-meet/service/RTC/RTCEvents.js","models/api/index.ts","../../../binaural-meet/libs/lib-jitsi-meet/service/statistics/AnalyticsEvents.js","models/api/MessageType.ts","../../../binaural-meet/libs/lib-jitsi-meet/modules/sdp/SDPUtil.js","../../../binaural-meet/libs/lib-jitsi-meet/service/RTC/MediaDirection.js","stores/sharedContents/SharedContentCreator.ts","../../../binaural-meet/libs/lib-jitsi-meet/modules/RTC/RTCUtils.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/util/GlobalOnErrorHandler.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/RTC/RTC.js","../../../binaural-meet/libs/lib-jitsi-meet/service/RTC/VideoType.js","../../../binaural-meet/libs/lib-jitsi-meet/JitsiTrackErrors.js","models/ISharedContent.ts","models/Participant.ts","stores/ErrorInfo.ts","models/utils/jitsiTrack.ts","../../../binaural-meet/libs/lib-jitsi-meet/JitsiTrackEvents.js","models/url/index.ts","models/url/parameters.ts","../../../binaural-meet/libs/lib-jitsi-meet/index.js","components/Constants.ts","../../../binaural-meet/libs/lib-jitsi-meet/JitsiConferenceErrors.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/sdp/SDP.js","../../../binaural-meet/libs/lib-jitsi-meet/JitsiTrackError.js","../../../binaural-meet/libs/lib-jitsi-meet/service/RTC/CodecMimeType.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/util/Listenable.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/detection/DetectionEvents.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/xmpp/xmpp.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/videosipgw/VideoSIPGWConstants.js","../../../binaural-meet/libs/lib-jitsi-meet/JitsiConnectionEvents.js","../../../binaural-meet/libs/lib-jitsi-meet/service/statistics/Events.js","stores/Chat.ts","models/api/Constants.ts","models/utils/coordinates.ts","../../../binaural-meet/libs/lib-jitsi-meet/modules/settings/Settings.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/sdp/SdpTransformUtil.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/util/MathUtil.js","../../../binaural-meet/libs/lib-jitsi-meet/service/connectivity/ConnectionQualityEvents.js","stores/participants/index.ts","../../../binaural-meet/libs/lib-jitsi-meet/modules/xmpp/JingleSessionState.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/proxyconnection/constants.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/statistics/CallStats.js","stores/Map.ts","../../../binaural-meet/libs/lib-jitsi-meet/modules/util/RandomUtil.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/xmpp/ConnectionPlugin.js","models/trafficControl/PriorityCalculator.ts","models/middleware/trafficControl.ts","models/utils/utils.ts","../../../binaural-meet/libs/lib-jitsi-meet/JitsiConnectionErrors.js","models/utils/color.ts","../../../binaural-meet/libs/lib-jitsi-meet/modules/xmpp/XmppConnection.js","../../../binaural-meet/libs/lib-jitsi-meet/service/RTC/SignalingEvents.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/statistics/constants.js","models/api/Notification.ts","../../../binaural-meet/libs/lib-jitsi-meet/modules/util/Deferred.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/RTC/ScreenObtainer.js","../../../binaural-meet/libs/lib-jitsi-meet/service/RTC/CameraFacingMode.js","../../../binaural-meet/libs/lib-jitsi-meet/JitsiMediaDevicesEvents.js","models/api/Connection.ts","models/api/ConnectionDefs.ts","../../../binaural-meet/libs/lib-jitsi-meet/modules/util/ScriptUtil.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/connectivity/ParticipantConnectionStatus.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/connectivity/NetworkInfo.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/RTC/JitsiLocalTrack.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/recording/recordingXMLUtils.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/e2ee/OlmAdapter.js","models/api/Gyazo.ts","../../../binaural-meet/libs/lib-jitsi-meet/modules/e2ee/E2EEncryption.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/xmpp/JingleSessionPC.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/sdp/SDPDiffer.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/RTC/TPCUtils.js","stores/ConnectionInfo.ts","models/api/CORS.ts","../../../binaural-meet/libs/lib-jitsi-meet/modules/statistics/LocalStatsCollector.js","../../../binaural-meet/libs/lib-jitsi-meet/JitsiTranscriptionStatus.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/xmpp/MediaSessionEvents.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/RTC/JitsiTrack.js","../../../binaural-meet/libs/lib-jitsi-meet/service/RTC/Resolutions.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/detection/TrackVADEmitter.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/webaudio/WebAudioUtils.js","../../../binaural-meet/libs/lib-jitsi-meet/service/e2eping/E2ePingEvents.js","stores/MapObject.ts","stores/utils.ts","../../../binaural-meet/libs/lib-jitsi-meet/modules/statistics/SpeakerStats.js","../../../binaural-meet/libs/lib-jitsi-meet/JitsiMediaDevices.js","../../../binaural-meet/libs/lib-jitsi-meet/service/authentication/AuthenticationEvents.js","stores/index.ts","../../../binaural-meet/libs/lib-jitsi-meet/modules/e2ee/crypto-utils.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/xmpp/Caps.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/detection/VADAudioAnalyser.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/recording/JibriSession.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/transcription/audioRecorder.js","../../../binaural-meet/libs/lib-jitsi-meet/JitsiConnection.js","../../../binaural-meet/libs/lib-jitsi-meet/JitsiConference.js","../../../binaural-meet/libs/lib-jitsi-meet/JitsiConferenceEventManager.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/browser/BrowserCapabilities.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/statistics/AnalyticsAdapter.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/statistics/PerformanceObserverStats.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/statistics/RTPStatsCollector.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/util/EventEmitterForwarder.js","../../../binaural-meet/libs/lib-jitsi-meet/JitsiParticipant.js","../../../binaural-meet/libs/lib-jitsi-meet/authenticateAndUpgradeRole.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/e2ee/E2EEContext.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/xmpp/ResumeTask.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/util/Retry.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/xmpp/StropheLastSuccess.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/xmpp/strophe.ping.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/xmpp/strophe.emuc.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/xmpp/ChatRoom.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/xmpp/AVModeration.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/xmpp/Lobby.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/xmpp/moderator.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/util/UsernameGenerator.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/xmpp/strophe.jingle.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/util/AsyncQueue.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/util/StringUtils.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/xmpp/JingleSession.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/xmpp/SignalingLayerImpl.js","../../../binaural-meet/libs/lib-jitsi-meet/service/RTC/SignalingLayer.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/xmpp/strophe.logger.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/xmpp/strophe.rayo.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/xmpp/strophe.util.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/RTC/CodecSelection.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/RTC/BridgeChannel.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/RTC/TraceablePeerConnection.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/sdp/LocalSdpMunger.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/sdp/RtxModifier.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/sdp/SdpConsistency.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/RTC/JitsiRemoteTrack.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/connectivity/ConnectionQuality.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/connectivity/IceFailedHandling.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/detection/NoAudioSignalDetection.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/detection/P2PDominantSpeakerDetection.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/detection/VADNoiseDetection.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/detection/VADTalkMutedDetection.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/e2eping/e2eping.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/event/Jvb121EventGenerator.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/qualitycontrol/ReceiveVideoController.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/qualitycontrol/SendVideoController.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/recording/RecordingManager.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/statistics/AudioOutputProblemDetector.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/statistics/AvgRTPStatsReporter.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/statistics/SpeakerStatsCollector.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/transcription/transcriber.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/version/ComponentsVersions.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/videosipgw/VideoSIPGW.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/videosipgw/JitsiVideoSIPGWSession.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/detection/ActiveDeviceDetector.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/proxyconnection/ProxyConnectionService.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/proxyconnection/ProxyConnectionPC.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/recording/recordingConstants.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/statistics/PrecallTest.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/util/AuthUtil.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/webaudio/AudioMixer.js","models/api/ConferenceSync.ts","models/api/Conference.ts","../../../binaural-meet/libs/lib-jitsi-meet/JitsiMeetJS.js","../../../binaural-meet/libs/lib-jitsi-meet/service/statistics/constants.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/transcription/recordingResult.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/transcription/transcriptionServices/SphinxTranscriptionService.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/transcription/word.js","../../../binaural-meet/libs/lib-jitsi-meet/modules/transcription/transcriptionServices/AbstractTranscriptionService.js","hooks/ChatStore.ts","hooks/MapStore.ts","hooks/ParticipantsStore.ts","hooks/SharedContentsStore.ts","components/error/AfkDialog.tsx","images/usage.en.png","images/usage.ja.png","components/error/TheEntrance.tsx","components/error/ErrorDialog.tsx","components/utils/formatter.tsx","components/footer/adminConfig/RemoteTrackLimitControl.tsx","components/footer/adminConfig/AdminConfigForm.tsx","components/footer/BroadcastControl.tsx","components/utils/MoreButton.tsx","components/footer/FabEx.tsx","components/footer/share/CameraSelector.tsx","components/footer/share/Input.tsx","components/footer/share/ImageInput.tsx","components/footer/share/SharedDialogItem.tsx","components/footer/share/Menu.tsx","components/footer/share/TextInput.tsx","components/footer/share/ShareDialog.tsx","components/footer/share/ShareButton.tsx","components/footer/StereoAudioSwitch.tsx","components/footer/Footer.tsx","components/utils/styles.ts","components/avatar/ImageAvatar.tsx","components/utils/index.ts","components/leftBar/Chat.tsx","models/api/Settings.ts","components/map/ShareLayer/GDrive.tsx","components/map/ShareLayer/PDF.tsx","components/map/ShareLayer/ScreenContent.tsx","components/map/ShareLayer/Text.tsx","models/audio/NodeGroup.ts","stores/AudioParameters/StereoParameters.ts","components/map/ShareLayer/YouTube.tsx","components/map/ShareLayer/Content.tsx","components/map/ShareLayer/SharedContentForm.tsx","components/map/ShareLayer/RndContent.tsx","images/earshot-on.png","images/earshot-off.png","components/map/ShareLayer/SharedContent.tsx","components/leftBar/ContentList.tsx","components/map/ParticipantsLayer/LocalParticipantForm.tsx","components/map/ParticipantsLayer/RemoteParticipantForm.tsx","components/leftBar/StatusDialog.tsx","components/leftBar/ParticipantList.tsx","components/leftBar/LeftBar.tsx","components/map/MainScreen.tsx","components/map/Base/Base.tsx","components/utils/KeyHandler.ts","components/avatar/StreamAvatar.tsx","components/avatar/ComposedAvatar.tsx","components/avatar/ConnectedAvatar.tsx","images/whoo-emoticons_voice.png","components/map/ParticipantsLayer/Participant.tsx","components/map/ParticipantsLayer/LocalParticipant.tsx","components/utils/DragHandler.ts","components/map/ParticipantsLayer/MouseCursor.tsx","components/map/ParticipantsLayer/RemoteParticipant.tsx","components/map/ParticipantsLayer/Participants.tsx","components/map/ShareLayer/PastedContent.tsx","components/map/ShareLayer/ShareLayer.tsx","components/map/BackgroundLayer/Background.tsx","components/map/map.tsx","components/App.tsx","stores/AudioParameters/index.ts","models/audio/ConnectedGroup.ts","models/audio/StereoManager.ts","models/audio/index.ts","models/audio/ConnectedManager.ts","models/middleware/chooseDevice.ts","index.tsx"],"names":["extractScaleX","matrix","Math","abs","sign","a","sqrt","pow","c","extractScaleY","d","b","extractRotation","atan2","transfromAt","center","tranform","baseMatrix","tm","DOMMatrix","translate","itm","translateSelf","reduce","p","multiplySelf","transformPoint2D","point","e","f","rotateVector2D","resolveAtEnd","func","Promise","resolve","reject","err","getMimeType","url","xhttp","XMLHttpRequest","timeout","open","onreadystatechange","this","readyState","LOADING","type","getResponseHeader","abort","send","module","exports","ADD_ICE_CANDIDATE_FAILED","AUDIO_MUTED_BY_FOCUS","VIDEO_MUTED_BY_FOCUS","AUTHENTICATION_REQUIRED","BRIDGE_DOWN","CALL_ACCEPTED","CALL_INCOMING","CALL_ENDED","CHAT_ERROR_RECEIVED","CONFERENCE_PROPERTIES_CHANGED","CONNECTION_ESTABLISHED","CONNECTION_FAILED","CONNECTION_INTERRUPTED","CONNECTION_RESTORED","CONNECTION_ICE_FAILED","CONNECTION_RESTARTED","CONNECTION_STATUS_CHANGED","DISPLAY_NAME_CHANGED","EMUC_ROOM_ADDED","EMUC_ROOM_REMOVED","ETHERPAD","FOCUS_DISCONNECTED","FOCUS_LEFT","GRACEFUL_SHUTDOWN","ICE_RESTARTING","ICE_RESTART_SUCCESS","KICKED","LOCAL_ROLE_CHANGED","MEETING_ID_SET","MESSAGE_RECEIVED","INVITE_MESSAGE_RECEIVED","PRIVATE_MESSAGE_RECEIVED","MUC_MEMBER_BOT_TYPE_CHANGED","MUC_DESTROYED","MUC_JOINED","MUC_MEMBER_JOINED","MUC_MEMBER_LEFT","MUC_LOBBY_MEMBER_JOINED","MUC_LOBBY_MEMBER_UPDATED","MUC_LOBBY_MEMBER_LEFT","MUC_DENIED_ACCESS","MUC_LEFT","MUC_ROLE_CHANGED","MUC_LOCK_CHANGED","MUC_MEMBERS_ONLY_CHANGED","PARTICIPANT_AUDIO_MUTED","PARTICIPANT_VIDEO_MUTED","PARTICIPANT_VIDEO_TYPE_CHANGED","PARTICIPANT_FEATURES_CHANGED","PASSWORD_REQUIRED","PHONE_NUMBER_CHANGED","PRESENCE_RECEIVED","PRESENCE_STATUS","PROMPT_FOR_LOGIN","READY_TO_JOIN","RECORDER_STATE_CHANGED","REMOTE_STATS","RENEGOTIATION_FAILED","RESERVATION_ERROR","ROOM_CONNECT_ERROR","ROOM_CONNECT_NOT_ALLOWED_ERROR","ROOM_JOIN_ERROR","ROOM_CONNECT_MEMBERS_ONLY_ERROR","ROOM_MAX_USERS_ERROR","SENDING_CHAT_MESSAGE","SENDING_PRIVATE_CHAT_MESSAGE","SESSION_ACCEPT_TIMEOUT","SPEAKER_STATS_RECEIVED","CONFERENCE_TIMESTAMP_RECEIVED","AV_MODERATION_APPROVED","AV_MODERATION_RECEIVED","AV_MODERATION_CHANGED","AV_MODERATION_PARTICIPANT_APPROVED","START_MUTED_FROM_FOCUS","SUBJECT_CHANGED","SUSPEND_DETECTED","TRANSCRIPTION_STATUS_CHANGED","TRANSPORT_INFO","VIDEO_SIP_GW_AVAILABILITY_CHANGED","VIDEO_SIP_GW_SESSION_STATE_CHANGED","ICE_CONNECTION_STATE_CHANGED","JSON_MESSAGE_RECEIVED","AUDIO_INPUT_STATE_CHANGE","AUTH_STATUS_CHANGED","BEFORE_STATISTICS_DISPOSED","CONFERENCE_ERROR","CONFERENCE_FAILED","CONFERENCE_JOINED","CONFERENCE_LEFT","CONFERENCE_UNIQUE_ID_SET","DATA_CHANNEL_OPENED","DOMINANT_SPEAKER_CHANGED","CONFERENCE_CREATED_TIMESTAMP","DTMF_SUPPORT_CHANGED","ENDPOINT_MESSAGE_RECEIVED","ENDPOINT_STATS_RECEIVED","JVB121_STATUS","PARTICIPANT_KICKED","LAST_N_ENDPOINTS_CHANGED","LOCK_STATE_CHANGED","SERVER_REGION_CHANGED","_MEDIA_SESSION_STARTED","_MEDIA_SESSION_ACTIVE_CHANGED","MEMBERS_ONLY_CHANGED","NO_AUDIO_INPUT","NOISY_MIC","PARTICIPANT_CONN_STATUS_CHANGED","PARTCIPANT_FEATURES_CHANGED","PARTICIPANT_PROPERTY_CHANGED","P2P_STATUS","PROPERTIES_CHANGED","START_MUTED_POLICY_CHANGED","STARTED_MUTED","TALK_WHILE_MUTED","TRACK_ADDED","TRACK_AUDIO_LEVEL_CHANGED","TRACK_MUTE_CHANGED","TRACK_REMOVED","USER_JOINED","USER_LEFT","USER_ROLE_CHANGED","USER_STATUS_CHANGED","BOT_TYPE_CHANGED","LOBBY_USER_JOINED","LOBBY_USER_UPDATED","LOBBY_USER_LEFT","DevicePreference","makeObservable","observable","TracksStore","ref","audio","getOriginalStream","avatarOk","avatar","undefined","track","mute","newLevel","audioLevel","getTrack","muted","computed","action","ParticipantBase","shallow","bound","isLocal","information","defaultInformation","defaultRemoteInformation","muteAudio","muteVideo","color","length","name","getRandomColorRGB","textColor","findTextColorRGB","reverseRGB","findReverseColorRGB","rgb2Color","physics","Object","assign","MapObject","defaultPhysics","position","show","LocalParticipant","devicePreference","informationToSend","loadInformationFromStorage","urlParameters","useStereoAudio","headphone","muteMic","cameraOn","loadMediaSettingsFromStorage","loadPhysicsFromStorage","autorun","gravatar","src","avatarSrc","includes","email","hash","md5","trim","toLowerCase","checkImageUrl","then","catch","tpv","thirdPersonView","micMuted","speakerMuted","muteSpeaker","info","isLocalStorage","storage","sessionStorage","localStorage","setItem","JSON","stringify","getItem","infoInStr","parse","muteStatus","stream","device","soundLocalizationBase","rv","settingStrInLocal","settingStrInSession","settingLocal","settingSession","setting","pose","str","config","remoteVideoLimit","remoteAudioLimit","TrackStates","RemoteParticipant","id","informationReceived","lastDistance","called","participants","local_","box","remote","size","get","local","participantId","newParticipant","located","set","delete","clear","setLocalId","localId","getParticipantId","isAudioTrack","tracks","addEventListener","onMuteChanged","PARTICIPANT_SIZE","Map","Set","ConnectionForContent","jitsiConnection","jitsiConference","initJitsiConnection","initJitsiConference","connection","conference","on","JitsiMeetJS","events","myUserId","setPerceptibles","setDisplayName","contentTrackCarrierName","join","setSenderVideoConstraint","addTrack","console","error","removeTrack","assert","getLocalTracks","JitsiConnection","connect","leave","disconnect","reason","log","EventEmitter","CID_MAINSCREEN","contentTrackLog","SharedContentTracks","sharedContents","remoteTrackPool","localMainConnection","contentCarriers","clearAllRemotes","clearLocalContentCarriers","carrierMap","remoteMains","remoteContents","forEach","localContents","trackSet","cid","createConnectionForContent","Array","from","localMains","mains","addLocalMains","has","addRemoteContent","pid","addRemoteMain","bmRelayServer","toString","localParticipant","myContents","pool","add","carrierId","removeRemoteMain","removeRemoteContent","enable","find","init","sync","sendMainScreenCarrier","onended","removeLocalMain","values","filter","getType","keys","sort","tracks_","MediaStream","caRemote","caLocal","clearLocalMains","conn","content","updateByLocal","ev","removeByLocal","stopStream","newTrackSet","warn","isVideoTrack","contentLog","contentDebug","zorderComp","zorder","ParticipantContents","contents","contentIdCounter","beforeChangeEditing","pendToRemoves","owner","wallpapers","oldWallPapers","newLocalId","participantsStore","key","fps","screenFps","editing","callback","participant","pasted","shareContent","createContent","moveContentToTop","addLocalContent","getParticipant","roomContents","bgs","isContentWallpaper","same","t","_","isEqual","cs","targets","changed","com","intersectionMap","disposeContent","sendMyContents","newAll","removeDuplicated","push","newSorted","idx","zIndex","all","sorted","saveWallpaper","nWallpapers","findIndex","slice","loadWallpaper","newWallPapers","getWallpaper","removeSameWallpaper","newStore","room","extractContentDatas","wpStores","oldStr","wps","curWp","loaded","store","lc","newContent","getUniqueId","updateAll","pc","cidTake","updated","callBy","take","takeContentsFromDead","sendMessage","MessageType","PARTICIPANT_LEFT","checkAndGetContent","sendContentUpdateRequest","roomContentsInfo","getOrTakeContent","toRemove","sendContentRemoveRequest","sendLeftContentRemoveRequest","removeMyContent","bmRelaySocket","WebSocket","OPEN","pushOrUpdateMessageViaRelay","cids","CONTENT_UPDATE_REQUEST_BY_ID","onUpdateContent","updateRemoteContents","newContents","map","remove","diffMap","removeRemoteContents","pidLeave","participantLeave","allPids","cur","next","pendToRemoveParticipant","clearConnection","setEditing","clearLocalContent","clearRemoteContent","AUDIO","PRESENTER","VIDEO","BrowserCapabilities","options","i18n","useTranslation","useTrans","resources","en","translation","enAbout","enTopPageUrl","enMoreInfo","YourName","Venue","EnterTheVenue","Contents","shareImport","shareDownload","shareIframe","shareText","shareImage","shareZoneImage","shareWhiteboard","shareCamera","shareScreenBackground","stopScreenBackground","shareScreenContent","stopScreen","frameRateSetting","shareMouse","stopMouse","ttCreateAndshare","ttMicMute","headphoneL1Chrome","headphoneL1","headphoneL2","etConnection","emConnection","etMicPermission","emMicPermission","etNoMic","emNoMic","emClose","emNeverShow","etNoChannel","emNoChannel","etRetry","emRetry","imageDropzoneText","lsTitle","lsName","lsColor","lsColorAvatar","lsColorText","lsAutoColor","lsImage","lsEmail","lsImageFile","btSave","btCancel","lsNotifyCall","lsNotifyTouch","lsNotifyNear","lsNotifyYarn","rsCall","lsNotification","rsConnectYarnPhone","rsCutYarnPhone","rsChatTo","ctPin","ctUnpin","ctProximity","ctUnProximity","ctEdit","ctEndEdit","ctEditIframe","ctEndEditIframe","ctEditText","ctEndEditText","ctEditWhiteboard","ctEndEditWhiteboard","ctEditGDrive","ctEndEditGDrive","ctEndEditYoutube","ctEditYoutube","ctMoveTop","ctMoveBottom","ctWallpaper","ctUnWallpaper","ctCopyToClipboard","ctDelete","ctClose","ctName","ctFocus","ctFrameVisible","ctFrameInvisible","ctOpaque","ctTransparent","upload","Save","Clear","Cancel","broadcastMyVoice","soundLocalizationBasedOn","slAvatar","slUser","usage","cmJoined","cmLeft","cmNameChanged","cmCallBy","cmCallTo","cmToAll","cmToName","cmSend","cmPrivateFrom","cmPrivateTo","noCalled","noTouched","noNear","noYarn","afkTitle","afkMessage","gdFailed","videoLimit","audioLimit","ja","i18nSupportedLngs","i18nOptions","supportedLngs","fallbackLng","interpolation","escapeValue","i18nInit","use","initReactI18next","i18nLanguageDetector","_instances","logger","require","getLogger","__filename","isCallstatsLoaded","_initCallStatsBackend","CallStats","isBackendInitialized","initBackend","callStatsID","callStatsSecret","userName","aliasName","applicationName","getWiFiStatsMethod","confID","siteID","Statistics","xmpp","rtpStatsMap","eventEmitter","callStatsIntegrationEnabled","enableCallStats","disableThirdPartyRequests","callStatsApplicationLogsDisabled","browser","isReactNative","ScriptUtil","loadScript","customScriptUrl","CALLSTATS_SCRIPT_URL","loadCallStatsAPI","callsStatsInstances","instances","audioLevelsEnabled","disableAudioLevels","pcStatsInterval","audioLevelsInterval","longTasksStatsInterval","analytics","defineProperty","prototype","startRemoteStats","peerconnection","stopRemoteStats","rtpStats","RTPStats","start","localStats","startLocalStats","LocalStats","addAudioLevelListener","listener","StatisticsEvents","removeAudioLevelListener","removeListener","addBeforeDisposedListener","removeBeforeDisposedListener","addConnectionStatsListener","removeConnectionStatsListener","addByteSentStatsListener","removeByteSentStatsListener","addLongTasksStatsListener","attachLongTasksStats","supportsPerformanceObserver","performanceObserverStats","PerformanceObserverStats","JitsiConferenceEvents","startObserver","stopObserver","getLongTasksStats","removeLongTasksStatsListener","setSpeakerList","speakerList","isP2P","dispose","emit","callStats","stopCallStats","tpc","tpcId","_stopRemoteStats","removeAllListeners","stopLocalStats","i","splice","stop","startCallStats","remoteUserID","newInstance","_getAllCallStatsInstances","csInstances","statistics","callStatsInstance","sendTerminateEvent","isCallstatsEnabled","sendConnectionResumeOrHoldEvent","isResume","instance","sendResumeOrHoldEvent","sendIceConnectionFailedEvent","sendMuteEvent","sendScreenSharingEvent","ssrc","sendDominantSpeakerEvent","roomJid","sendActiveDeviceListEvent","devicesData","globalSet","associateStreamWithVideoTag","userId","usageLabel","containerId","sendGetUserMediaFailed","JitsiTrackError","Error","stack","gum","constraintName","constraints","message","formatJitsiTrackErrorForCallStats","sendCreateOfferFailed","sendCreateAnswerFailed","sendSetLocalDescFailed","sendSetRemoteDescFailed","sendAddIceCandidateFailed","sendLog","m","globalSubSet","stats","value","csPerStats","sendApplicationLog","sendFeedback","overall","comment","sendEvent","FEEDBACK","rating","LOCAL_JID","reportGlobalError","sendAnalyticsAndLog","event","eventToLog","properties","sendAnalytics","eventName","RoomInfo","defaultBackgroundFill","defaultBackgroundColor","val","backgroundFill","backgroundColor","backgroundLeftFill","CREATE_ANSWER_FAILED","CREATE_OFFER_FAILED","DATA_CHANNEL_OPEN","ENDPOINT_CONN_STATUS_CHANGED","LASTN_ENDPOINT_CHANGED","PERCEPTIBLE_CHANGED","PERMISSIONS_CHANGED","SENDER_VIDEO_CONSTRAINTS_CHANGED","LASTN_VALUE_CHANGED","LOCAL_TRACK_SSRC_UPDATED","LOCAL_TRACK_MAX_ENABLED_RESOLUTION_CHANGED","TRACK_ATTACHED","REMOTE_TRACK_ADDED","REMOTE_TRACK_MUTE","REMOTE_TRACK_REMOVED","REMOTE_TRACK_UNMUTE","SET_LOCAL_DESCRIPTION_FAILED","SET_REMOTE_DESCRIPTION_FAILED","AUDIO_OUTPUT_DEVICE_CHANGED","DEVICE_LIST_CHANGED","DEVICE_LIST_WILL_CHANGE","DEVICE_LIST_AVAILABLE","LOCAL_UFRAG_CHANGED","REMOTE_UFRAG_CHANGED","TYPE_OPERATIONAL","TYPE_PAGE","TYPE_TRACK","TYPE_UI","ACTION_JINGLE_RESTART","ACTION_JINGLE_SA_TIMEOUT","ACTION_JINGLE_SI_RECEIVED","ACTION_JINGLE_SI_TIMEOUT","ACTION_JINGLE_TERMINATE","ACTION_JINGLE_TR_RECEIVED","ACTION_JINGLE_TR_SUCCESS","ACTION_P2P_DECLINED","ACTION_P2P_ESTABLISHED","ACTION_P2P_FAILED","ACTION_P2P_SWITCH_TO_JVB","AVAILABLE_DEVICE","CONNECTION_DISCONNECTED","ICE_DURATION","ICE_ESTABLISHMENT_DURATION_DIFF","ICE_STATE_CHANGED","NO_BYTES_SENT","TRACK_UNMUTED","createBridgeDownEvent","bridgeDown","actionSubject","createConnectionFailedEvent","errorType","errorMessage","details","attributes","createConferenceEvent","source","createConnectionStageReachedEvent","stage","createE2eRttEvent","region","rtt","createFocusLeftEvent","createGetUserMediaEvent","createParticipantConnectionStatusEvent","createJingleEvent","createNoDataFromSourceEvent","mediaType","createP2PEvent","createRemotelyMutedEvent","createRtpStatsEvent","createTransportStatsEvent","createAudioOutputProblemEvent","userID","localAudioLevels","remoteAudioLevels","createBridgeChannelClosedEvent","code","createTtfmEvent","StoredMessageType","PARTICIPANT_AFK","PARTICIPANT_TRACKSTATES","PARTICIPANT_INFO","MAIN_SCREEN_CARRIER","MY_CONTENT","InstantMessageType","PARTICIPANT_TRACKLIMITS","YARN_PHONE","CHAT_MESSAGE","CALL_REMOTE","MUTE_VIDEO","MUTE_AUDIO","RELOAD_BROWSER","KICK","ObjectArrayMessageType","CONTENT_UPDATE_REQUEST","CONTENT_INFO_UPDATE","ObjectArrayMessageTypes","StringArrayMessageType","LEFT_CONTENT_REMOVE_REQUEST","CONTENT_REMOVE_REQUEST","PARTICIPANT_OUT","MOUSE_OUT","CONTENT_OUT","StringArrayMessageTypes","ClientToServerOnlyMessageType","REQUEST_ALL","REQUEST_RANGE","REQUEST_PARTICIPANT_STATES","PARTICIPANT_POSE","PARTICIPANT_MOUSE","PARTICIPANT_ON_STAGE","ROOM_PROP","REQUEST_TO","FRAGMENT_HEAD","FRAGMENT_CONTENT","SDPUtil","filterSpecialChars","text","replace","iceparams","mediadesc","sessiondesc","pwd","ufrag","data","findLine","parseICEUfrag","parseICEPwd","line","substring","buildICEUfrag","frag","buildICEPwd","parseMID","parseMLine","parts","split","media","shift","port","proto","pop","fmt","buildMLine","mline","parseRTPMap","clockrate","channels","parseSCTPMap","buildRTPMap","el","getAttribute","parseCrypto","tag","parseFingerprint","fingerprint","parseFmtp","parseICECandidate","candidate","elems","foundation","component","protocol","priority","ip","generation","tcptype","network","random","substr","buildICECandidate","cand","hasOwnAttribute","parseSSRC","desc","lines","parseRTCPFB","pt","params","parseExtmap","indexOf","direction","uri","haystack","needle","sessionpart","j","findLines","needles","candidateToJingle","candidateFromJingle","isFirefox","parsePrimaryVideoSsrc","videoMLine","numSsrcs","ssrcs","ssrcInfo","index","array","numGroups","ssrcGroups","primarySsrc","fidGroup","group","semantics","simGroup","generateSsrc","RandomUtil","randomInt","getSsrcAttribute","mLine","attributeName","ssrcLine","attribute","parseGroupSsrcs","ssrcGroup","ssrcStr","parseInt","getMedia","sdp","getUfrag","ufragLines","startsWith","preferCodec","codecName","matchingPayloadTypes","rtp","codec","payload","payloadTypes","payloads","reverse","payloadIndex","unshift","stripCodec","highProfile","h264Pts","removePts","stripH264HighCodec","CodecMimeType","H264","fmtp","item","rtxApts","rtxPts","allPts","Number","keepPts","MediaDirection","INACTIVE","rtcpFb","RECVONLY","SENDONLY","SENDRECV","defaultContent","mapObjectDefaultValue","ownerName","originalSize","pinned","shareType","makeThemContents","them","GoogleAuth","SharedContentImp","noFrame","opacity","proximity","cloneDeep","Date","now","makeItPdf","urlStr","mouseOnMap","createContentOfIframe","URL","hostname","paramStrs","search","pathname","param","fileIdStart","fileId","getProxiedUrl","finally","createContentOfText","texts","messages","time","scroll","slen","ceil","max","STRING_SCALE_H","createContentOfImage","imageFile","offset","_type","resolutionFunc","rejectionFunc","uploadToGyazo","createContentOfImageUrl","getImageSize","updateSigninStatus","isSignedIn","createContentOfPdf","file","gapi","client","apiKey","clientId","scope","discoveryDocs","auth2","getAuthInstance","listen","createContentOfVideo","settings","getSettings","width","height","extractData","extract","extractContentData","extractDataAndId","extractContentDataAndIds","execCopy","temp","document","createElement","selectionStart","selectionEnd","s","style","left","body","appendChild","focus","result","execCommand","blur","removeChild","copyContentToClipboard","tms","prev","paramUrl","pre","getGDriveUrl","getParamsFromUrl","isGDrivePreviewScrollable","mimeType","comp","app","paramStr","getStringFromParams","getInformationOfGDriveContent","setApiKey","load","drive","files","fields","debug","top","TEN_YEAR","order","floor","TIME_RESOLUTION_IN_MS","moveContentToBottom","bottom","makeContentWallpaper","flag","usesAdapter","availableDevicesPollTimer","DEFAULT_CONSTRAINTS","video","ideal","min","audioOutputDeviceId","audioOutputChanged","disableAP","disableAEC","disableNS","disableAGC","stereo","featureDetectionAudioEl","isAudioOutputDeviceChangeAvailable","setSinkId","availableDevices","emptyFuncton","updateGrantedPermissions","um","audioTracksReceived","Boolean","getAudioTracks","videoTracksReceived","getVideoTracks","grantedPermissions","RTCEvents","sendDeviceListToAnalytics","deviceList","audioInputDeviceCount","kind","audioOutputDeviceCount","videoInputDeviceCount","videoOutputDeviceCount","deviceId","groupId","label","updateKnownDevices","pds","newDevices","mediaDeviceInfoToJSON","facing","compareAvailableMediaDevices","rtcUtils","audioQuality","window","clearInterval","RTCPeerConnectionType","RTCPeerConnection","attachMediaStream","getStreamID","getTrackID","wrapAttachMediaStream","element","srcObject","pcConstraints","isChromiumBased","optional","googScreencastMinBitrate","googCpuOveruseDetection","screenObtainer","isDeviceListAvailable","enumerateDevices","ds","supportsDeviceChangeEvent","navigator","mediaDevices","setInterval","devices","umDevices","gumTimeout","timeoutExpired","isNaN","setTimeout","JitsiTrackErrors","getUserMedia","clearTimeout","jitsiError","isSupported","obtainStream","requestedDevices","missingDevices","audioDeviceRequested","videoDeviceRequested","otherOptions","mediaStreamsMetaData","maybeRequestDesktopDevice","desktopSharingSourceDevice","matchingDevice","_getUserMedia","sourceType","_getDesktopMedia","bind","maybeRequestCaptureDevices","requestedCaptureDevices","clonedeep","Resolutions","resolution","r","isWebKitBased","cameraDeviceId","facingMode","CameraFacingMode","USER","autoGainControl","micDeviceId","echoCancellation","noiseSuppression","channelCount","getConstraints","desktopStream","sourceId","desktopAudioTracks","desktopAudioStream","desktopVideoTracks","desktopVideoStream","videoType","VideoType","DESKTOP","avStream","audioTracks","audioStream","effects","videoTracks","videoStream","CAMERA","stopMediaStream","deviceType","mediaStream","getTracks","release","isDeviceChangeAvailable","some","deviceData","hasOwnProperty","googSuspendBelowMinBitrate","Listenable","origAttachMediaStream","res","apply","arguments","getAudioOutputDevice","ex","GlobalOnErrorHandler","callUnhandledRejectionHandler","promise","handlers","oldOnErrorHandler","onerror","oldOnUnhandledRejection","onunhandledrejection","args","handler","addHandler","callErrorHandler","errHandler","peerConnectionIdCounter","rtcTrackIdCounter","_createLocalTracks","mediaStreamMetaData","metaData","safeCounterIncrement","JitsiLocalTrack","rtcId","RTC","peerConnections","localTracks","_channel","_lastN","_lastNEndpoints","_maxFrameHeight","_selectedEndpoints","_lastNChangeListener","_onLastNChanged","_onDeviceListChanged","_updateAudioOutputForAudioTracks","_videoType","RTCUtils","addListener","_channelOpenListener","wsUrl","BridgeChannel","logError","msgType","_receiverVideoConstraints","sendNewReceiverVideoConstraintsMessage","sendSelectedEndpointsMessage","_selectedEndpoint","sendReceiverVideoConstraintMessage","sendSetLastNMessage","sendVideoTypeMessage","lastNEndpoints","oldLastNEndpoints","leavingLastNEndpoints","enteringLastNEndpoints","isInLastN","mode","close","isOpen","maxFrameHeight","ids","signaling","iceConfig","abtestSuspendVideo","setSuspendVideo","addPermanentProperties","enableInsertableStreams","encodedInsertableStreams","forceEncodedAudioInsertableStreams","forceEncodedVideoInsertableStreams","usesUnifiedPlan","sdpSemantics","forceTurnRelay","iceTransportPolicy","bundlePolicy","newConnection","TraceablePeerConnection","traceablePeerConnection","localVideo","MediaType","localAudio","remoteTracks","pcRemoteTracks","getRemoteTracks","concat","mutePromises","audioTrack","unmute","videoTrack","pos","getTrackBySSRC","setAudioLevel","to","sendEndpointStatsMessage","sendSetPercieveEventMessage","PERCEPTIBLES_CHANGED","remoteAudioTracks","setAudioOutput","tracksInfo","obtainAudioAndVideoPermissions","eventType","elSelector","getCurrentlyAvailableMediaDevices","arePermissionsGrantedForAvailableDevices","getEventDataForActiveDevice","setAudioOutputDevice","isUserStreamById","streamId","isDesktopSharingEnabled","NONE","CONSTRAINT_FAILED","ELECTRON_DESKTOP_PICKER_ERROR","ELECTRON_DESKTOP_PICKER_NOT_FOUND","GENERAL","NOT_FOUND","PERMISSION_DENIED","SCREENSHARING_GENERIC_ERROR","SCREENSHARING_USER_CANCELED","TIMEOUT","TRACK_IS_DISPOSED","TRACK_NO_STREAM_FOUND","UNSUPPORTED_RESOLUTION","doseContentEditingUseKeyinput","canContentBeAWallpaper","isContentEditable","CONTENT_OUT_OF_RANGE_VALUE","compTextMessage","t1","t2","notifyCall","notifyTouch","notifyNear","notifyYarn","onStage","awayFromKeyboard","inProximity","getColorOfParticipant","errorInfo","videoInputs","audioInputs","audioOutputs","canvas","oscillator","keyInputUsers","setType","types","diffSet","supressedTypes","skipEntrance","sendInformation","testBot","when","checkConnection","startTestBot","state","ConnectionStates","CONNECTED","checkMic","getLocalMicTrack","checkRemote","checkChannel","_jitsiConference","rtc","counter","ctxA","AudioContext","createOscillator","destination","createMediaStreamDestination","ctx","getContext","MAP_SIZE","frequency","setValueAtTime","currentTime","colors","nearest","priorityCalculator","tracksToAccept","endpointId","fillStyle","beginPath","ellipse","PI","fill","chars","randChar","move","addV2","mulV2","cos","sin","win","requestIdleCallback","moveTask","vidoeStream","captureStream","audioTrackInfo","videoTrackInfo","createJitisLocalTracksFromStream","setLocalCameraTrack","setLocalMicTrack","LOCAL_TRACK_STOPPED","TRACK_AUDIO_OUTPUT_CHANGED","TRACK_VIDEOTYPE_CHANGED","NO_DATA_FROM_SOURCE","urlObj","decodeURI","prop","searchParams","decodeGetParams","location","href","default","MAP_CENTER","CHAT_ERROR","CONFERENCE_DESTROYED","CONFERENCE_MAX_USERS","CONNECTION_ERROR","CONFERENCE_RESTARTED","NOT_ALLOWED_ERROR","MEMBERS_ONLY_ERROR","CONFERENCE_ACCESS_DENIED","ICE_FAILED","INCOMPATIBLE_SERVER_VERSIONS","OFFER_ANSWER_FAILED","PASSWORD_NOT_SUPPORTED","VIDEOBRIDGE_NOT_AVAILABLE","SDP","mediaI","session","raw","failICE","removeTcpCandidates","removeUdpCandidates","getMediaSsrcMap","mediaSSRCs","mediaindex","mid","linessrc","containsSSRC","medias","toJingle","elem","thecreator","xmlns","up","assrcline","creator","amidline","attrs","rtpmap","afmtpline","fmtpParameters","k","rtcpFbToJingle","ssrcMap","availableSsrc","ssrcParameters","ssrcSdpLine","kv","v","ridLines","usesRidsForSimulcast","rids","ridLine","ridInfo","rid","extmapLines","extmap","senders","transportToJingle","sctpmap","sctpAttrs","number","streams","setupLine","setup","iceParameters","payloadtype","feedback","rtcpFbFromJingle","feedbackElementTrrInt","attr","each","fb","hasAttribute","fromJingle","jingle","sessionId","groups","$","jingle2media","transport","sctp","streamCount","payloadType","setAttribute","__","parameter","hdrExt","TRACK_ERROR_TO_MESSAGE_MAP","isArray","constraint","failedConstraintName","mandatory","minWidth","minHeight","getResolutionFromFailedConstraint","create","constructor","OPUS","VP8","VP9","removeEventListener","off","DETECTOR_STATE_CHANGE","VAD_NOISY_DEVICE","VAD_REPORT_PUBLISHED","VAD_SCORE_PUBLISHED","VAD_TALK_WHILE_MUTED","FAILURE_REGEX","DEFAULT_STUN_SERVERS","urls","JITSI_MEET_MUC_TYPE","FEATURE_JIGASI","FEATURE_E2EE","XMPP","token","disconnectInProgress","connectionTimes","authenticatedUser","initStropheUtil","initStropheLogger","xmppPing","domain","hosts","enableWebsocketResume","serviceUrl","shard","websocketKeepAlive","websocketKeepAliveUrl","XmppConnection","createConnection","bosh","deploymentInfo","Events","CONN_SHARD_CHANGED","shard_changed","suspend_time","ping","getPingSuspendTime","time_since_last_success","getTimeSinceLastSuccess","JitsiConnectionEvents","JitsiConnectionErrors","_initStrophePlugins","caps","Caps","clientNode","initFeaturesList","addFeature","disableRtx","isVersionLessThan","enableOpusRed","supportsAudioRed","enableRemb","enableTcc","enableLipSync","rayo","E2EEncryption","credentials","status","msg","performance","statusStr","Strophe","getStatusString","XMPPEvents","Status","ATTACHED","_sysMessageHandler","_stropheConn","deleteHandler","sendDiscoInfo","getStunAndTurnCredentials","jid","_resetState","getFeaturesAndIdentities","features","identities","NS","PING","_processDiscoInfoIdentities","errmsg","password","connected","getResourceFromJid","CONNFAIL","anonymousConnectionFailed","connectionFailed","lastErrorMsg","ERROR","DISCONNECTED","stopInterval","wasIntentionalDisconnect","errMsg","_getConnectionFailedReasonDetails","lastErrorStatus","getLastErrorStatus","AUTHFAIL","lastFailedRawMessage","getConnection","getLastFailedMessage","_parseConnectionFailedMessage","identity","avModerationComponentAddress","speakerStatsComponentAddress","conferenceDurationComponentAddress","lobbySupported","processLobbyFeatures","fr","endsWith","_onPrivateMessage","matches","exec","_addSysHandler","_onSystemMessage","connectionHandler","foundIceServers","onReceiveStunAndTurnCredentials","parseDiscoInfo","attaching","attach","sid","anonymousdomain","configDomain","_connect","roomName","onCreateResource","roomjid","customDomain","muc","mucNickname","randomHexString","emuc","createRoom","getLog","dial","pingDomain","sessions","disconnectListener","_cleanupXmppConnection","isUsingWebSocket","flush","evType","sendUnavailableBeacon","jvb","iceServers","p2p","p2pStunServers","stunServers","addConnectionPlugin","MucConnectionPlugin","JingleConnectionPlugin","RayoConnectionPlugin","lastResponseHeaders","headersArr","headers","header","$msg","jsonString","json","jsonMessage","parsedJson","tryParseJSONAndVerify","users","created_timestamp","STATUS_AVAILABLE","STATUS_UNDEFINED","STATUS_BUSY","STATE_ON","STATE_OFF","STATE_PENDING","STATE_RETRYING","STATE_FAILED","ERROR_NO_CONNECTION","ERROR_SESSION_EXISTS","WRONG_STATE","DISPLAY_NAME_REQUIRED","AUDIO_LEVEL","BEFORE_DISPOSED","BYTE_SENT_STATS","CONNECTION_STATS","LONG_TASKS_STATS","ChatMessage","avatarUrl","timestamp","chat","limitMessages","oldName","cm","getColor","old","new","addMessage","CONNECTING","roomInfoPeeperName","subV2","mulV","v2","mulV3","normV","sum","degree2Radian","degree","radian2Degree","radian","getRelativePose","base","relative","orientation","translatedPosition","rotatedPosition","convertToAudioCoordinate","rotateVector2DByDegree","vector","rad","crossProduct","vec1","vec2","vectorLength","vec","rotate90ClockWise","round","n","pose2Str","mouse2Str","mouse","str2Pose","poseArray","str2Mouse","mouseArray","_callStatsUserName","_machineId","_p8","_storage","jitsiLocalStorage","externalStorage","username","UsernameGenerator","generateUsername","generateCallStatsUserName","amDid","jitsiMeetId","generateJitsiMeetId","removeItem","parsePrimarySSRC","parseSecondarySSRC","_getSSRCCount","MLineWrap","ssrcNumber","attrName","ssrcObj","ssrcNum","primarySSRC","msid","findGroup","fecGroup","findGroupByPrimarySSRC","videoSSRCs","getSSRCs","ssrcGroupInfo","secondarySsrc","groupInfo","oldSSRC","newSSRC","SdpTransformWrap","rawSDP","parsedSDP","transform","selectedMLine","nextValue","MAX_SAFE_INTEGER","calculateAverage","valueArray","filterPositiveValues","RunningAverage","average","LOCAL_STATS_UPDATED","REMOTE_STATS_UPDATED","PENDING","ACTIVE","ENDED","ACTIONS","ACCEPT","INITIATE","TERMINATE","UNAVAILABLE","_fabrics","wrtcFuncNames","fabricEvent","reportType","hasFabric","fabrics","backendInitialized","_addNewFabric","_emptyReportQueue","fabricAttributes","remoteEndpointType","backend","endpointType","peer","server","ret","addNewFabric","fabricUsage","multiplex","_addNewFabricCallback","success","streamEndpointId","callStatsId","associateMstWithUserID","reportsQueue","_reportEvent","sendFabricEvent","fabricTerminated","_reportError","eventData","atLeastOneFabric","defaultInstance","csInstance","defaultConfID","defaultPC","report","errorData","_error","reportError","theBackend","methodName","originalMethod","theArguments","originalReportError","call","exception","configParams","CallStatsBackend","callstats","_traceAndCatchBackendCalls","applicationVersion","getName","match","initialize","_initCallback","attachWifiStatsHandler","addresses","conferenceID","sendUserFeedback","HALF","loadMatrixFromStorage","screenSize","committedMatrix","toWindow","fromWindow","saveMatrixToStorage","l","inverse","obj","im","diff","newMat","preMultiplySelf","setMatrix","setCommittedMatrix","offsetFromElement","lt","rb","margin","ar","DOMMatrixReadOnly","randomElement","arr","randomHexDigit","len","randomAlphanumStr","getConnectionPluginDefinition","ConnectionPluginListenable","priorityLog","extractPropsFromLocalParticipant","PriorityCalculator","updateSet","limits","limitUpdated","priorityMaps","lastPriority","disposers","_enabled","disable","localChangeDisposer","oldRemoteParticipants","remoteChangeDisposer","newRemoteParticipants","added","onRemoveParticipant","onAddParticipant","oldRemoteContents","remoteContentsChangeDisposer","newRemoteContents","onRemoveContent","onAddContent","remoteDiposers","rp","disposer","priorityMap","yarnPhones","haveUpdates","calcPriority","trackInfo","extractParticipantTrackInfo","calcPriorityValue","done","extractContentTrackInfo","prioritizedTrackInfoLists","mainTracks","remoteMainTrack","list","mainTrack","mainInfo","extractMainTrackInfo","newLists","nMuted","prioritizedEidLists","infos","delta","sz","intervalHandle","connectionInfo","memoedUpdater","setLimits","memo","update","videoConstraints","onStageEndpoints","setReceiverConstraints","input","isChromium","test","userAgent","vendor","shallowEqualsForMap","map1","map2","testVal","property","isSmartphone","isPortrait","parent","screen","isSelfUrl","host","img","Image","onload","CONNECTION_DROPPED_ERROR","OTHER_ERROR","SERVER_ERROR","charCodeAt","num","rgb","isDarkColor","g","getRandomColor","rgb2Colors","rgba","alpha","_options","pingOptions","Connection","_usesWebsocket","maxRetries","_rawInputTracker","LastSuccessTracker","startTracking","_resumeTask","ResumeTask","_deferredIQs","PingConnectionPlugin","getTimeSinceLastServerResponse","onPingThresholdExceeded","_onPingErrorThresholdExceeded","_oneSuccessfulConnect","websocket","_proto","socket","_status","disco","disconnecting","service","plugin","_stropheConnectionCb","pass","targetCallback","blockCallback","_maybeEnableStreamResume","_keepAliveAndCheckShard","_maybeStartWSKeepAlive","_processDeferredIQs","cancel","startInterval","_tryResumingConnection","_wsKeepAlive","CONN_STATUS_CHANGED","_closeSocket","_onClose","_clearDeferredIQs","streamManagement","getResumeToken","intervalWithJitter","fetch","response","responseShard","deferred","iq","timeLeft","sendIQ","stanza","errback","closeWebsocket","sendPresence","sendBeacon","_changeConnectStatus","DISCONNECTING","_buildBody","pres","$pres","CLIENT","cnode","tree","serialize","_abortAllRequests","_doDisconnect","schedule","PEER_MUTED_CHANGED","PEER_VIDEO_TYPE_CHANGED","SPEAKERS_AUDIO_LEVELS","getNotificationPermission","Notification","permission","requestPermission","notification","title","Deferred","clearRejectTimeout","_timeout","ms","SS_DEFAULT_FRAME_RATE","ScreenObtainer","_createObtainStreamMethod","isNWJS","onSuccess","onFailure","JitsiMeetNW","obtainDesktopStream","isElectron","obtainScreenOnElectron","supportsGetDisplayMedia","obtainScreenFromGetDisplayMediaRN","obtainScreenFromGetDisplayMedia","_getAudioConstraints","JitsiMeetScreenObtainer","openDesktopPicker","desktopSharingFrameRate","desktopSharingSources","streamType","screenShareAudio","audioConstraints","optionalConstraints","chromeMediaSource","chromeMediaSourceId","minFrameRate","maxFrameRate","maxWidth","maxHeight","errorCallback","getDisplayMedia","frameRate","cursor","errorDetails","errorName","errorMsg","errorStack","ENVIRONMENT","PERMISSION_PROMPT_IS_SHOWN","SLOW_GET_USER_MEDIA","connLog","global","jquery","jQuery","initOptions","useIPv6","disableSimulcast","enableWindowOnErrorHandler","enableAnalyticsLogging","disableThiredPartyRequests","desktopSharingChromeExtId","desktopSharingChromeDisabled","desktopSharingChromeSources","desktopSharingChromeMinExtVersion","desktopSharingFirefoxDisabled","_jitsiConnection","_store","Conference","version","screenOptions","setLogLevel","onStateChanged","conferenceName","uninit","leaveAll","leaveConference","reload","reconnect","changeState","Store","ConnectionInfoStore","currentExecutingScript","async","prepend","relativeURL","loadCallback","tagName","script","referenceNode","getElementsByTagName","scriptEl","scriptSrc","baseScriptSrc","lastIndexOf","parentNode","insertBefore","ParticipantConnectionStatus","INTERRUPTED","RESTORING","ParticipantConnectionStatusHandler","trackTimers","connStatusFromJvb","outOfLastNTimeout","rtcMuteTimeout","rtcMutedTimestamp","enteredLastNTimestamp","restoringTimers","connectionStatusMap","_onEndpointConnStatusChanged","onEndpointConnStatusChanged","_onP2PStatus","refreshConnectionStatusForAll","_onUserLeft","onUserLeft","supportsVideoMuteOnConnInterrupted","_onTrackRtcMuted","onTrackRtcMuted","_onTrackRtcUnmuted","onTrackRtcUnmuted","_onRemoteTrackAdded","onRemoteTrackAdded","_onRemoteTrackRemoved","onRemoteTrackRemoved","_onSignallingMuteChanged","onSignallingMuteChanged","_onTrackVideoTypeChanged","onTrackVideoTypeChanged","_onLastNValueChanged","clearRtcMutedTimestamp","isActive","figureOutConnectionStatus","newStatus","getConnectionStatus","getId","_setConnectionStatus","remoteTrack","JitsiTrackEvents","hasAnyVideoRTCMuted","hasAnyVideoTrackWebRTCMuted","_getVideoFrozenTimeout","getParticipants","getParticipantById","inP2PMode","isP2PActive","isRestoringTimedOut","_isRestoringTimedout","audioOnlyMode","getLastN","isVideoMuted","isVideoTrackFrozen","isConnActiveByJvb","newState","_getNewStateForP2PMode","_getNewStateForJvbMode","_clearRestoringTimer","oldConnectionStatus","connectionStatus","nowMs","maybeSendParticipantConnectionStatusEvent","startedMs","getTracksByMediaType","_changeConnectionStatus","participantConnectionStatus","leavingLastN","enteringLastN","rTimer","isMuted","isConnectionActiveByJvb","isRestoringTimedout","NETWORK_INFO_EVENT","networkInfo","_current","isOnline","_setEffectInProgress","effect","isEnabled","_startStreamEffect","maxEnabledResolution","_constraints","_prevSetMuted","_facingMode","_trackEnded","_hasSentData","_testDataSent","_realDeviceId","_trackMutedTS","_onDeviceListWillChange","oldRealDeviceId","_setRealDeviceIdFromDeviceList","_onAudioOutputDeviceChanged","_initNoDataFromSourceHandlers","_isNoDataFromSourceEventsEnabled","_setHandler","_fireNoDataFromSourceEvent","isReceivingData","storedMSID","getMSID","_streamEffect","_originalStream","_setStream","startEffect","stopEffect","_stopStreamEffect","_switchStreamEffect","containers","cont","_queueSetMuted","setMuted","_setMuted","disposed","logMuteInfo","doesVideoMuteByStreamRemove","enabled","_removeStreamFromConferenceAsMute","_unregisterHandlers","streamOptions","getDeviceId","getCameraFacingMode","streamsInfo","streamInfo","_addStreamToConferenceAsUnmute","_sendMuteStatus","_addLocalTrackAsUnmute","successCallback","_removeLocalTrackAsMute","setEffect","detach","_maybeFireTrackAttached","bytesSent","iceConnectionState","getConnectionState","trackSettings","_stopStreamInProgress","_switchCamera","_effectEnabled","JitsiTrack","getFocusRecordingUpdate","presence","jibriStatus","initiator","recordingMode","sessionID","getHiddenDomainUpdate","liveStreamViewURLContainer","liveStreamViewURL","textContent","modeContainer","sessionIDContainer","getSessionIdFromIq","jibri","getSessionId","sessionIdContainer","isFromFocus","OLM_MESSAGE_TYPE","OLM_MESSAGE_TYPES","kOlmData","Symbol","OlmAdapterEvents","OLM_ID_KEY_READY","PARTICIPANT_E2EE_CHANNEL_READY","PARTICIPANT_KEY_UPDATED","OlmAdapter","_conf","_init","_key","_keyIndex","_reqs","_sessionInitialization","_bootstrapOlm","_onEndpointMessageReceived","_onConferenceLeft","_onParticipantLeft","_onParticipantPropertyChanged","promises","localParticipantId","getFeatures","_sendSessionInit","allSettled","pId","olmData","_getParticipantOlmData","uuid","uuidv4","ciphertext","_encryptKeyInfo","setRejectTimeout","_sendMessage","free","clearParticipantSession","Olm","_olmAccount","Account","idKeys","identity_keys","_idKey","curve25519","get_library_version","keyInfo","base64js","fromByteArray","keyIndex","encrypt","olm","_sendError","Session","create_outbound","idKey","otKey","ack","pendingSessionUuid","create_inbound","remove_one_time_keys","decrypt","safeJsonParse","toByteArray","lastKey","oldValue","newValue","isE2EEEnabled","generate_one_time_keys","otKeys","one_time_keys","mark_keys_as_published","imageData","formData","FormData","append","method","responseJson","_conferenceJoined","_enabling","_e2eeCtx","E2EEContext","_olmAdapter","_ratchetKey","debounce","_ratchetKeyImpl","_rotateKey","_rotateKeyImpl","_onParticipantJoined","_onMediaSessionStarted","_onLocalTrackAdded","_setupReceiverE2EEForTrack","_trackMuteChanged","_onOlmIdKeyReady","_onParticipantE2EEChannelReady","_onParticipantKeyUpdated","initSessions","cleanup","clearAllParticipantsSessions","setLocalParticipantProperty","_restartMediaSessions","_generateKey","updateKey","setKey","crypto","getRandomValues","Uint8Array","_getMediaSessions","_setupSenderE2EEForTrack","importKey","material","ratchet","newKey","updateCurrentKey","receiver","findReceiverForTrack","handleReceiver","sender","findSenderForTrack","handleSender","supportsInsertableStreams","testing","disableE2EE","IQ_TIMEOUT","JingleSessionPC","localJid","remoteJid","mediaConstraints","isInitiator","_bridgeSessionId","_cachedOldLocalSdp","_cachedNewLocalSdp","_iceCheckingStartedTimestamp","_gatheringStartedTimestamp","localRecvMaxFrameHeight","_localVideoActive","_remoteVideoActive","_gatheringReported","lasticecandidate","closed","remoteRecvMaxFrameHeight","signalingLayer","SignalingLayerImpl","modificationQueue","AsyncQueue","wasConnected","establishmentDuration","_xmppListeners","onXmppStatusChanged","_removeSenderVideoConstraintsChangeListener","JingleSessionState","isReconnect","wasstable","webrtcIceUdpDisable","webrtcIceTcpDisable","pcOptions","gatherStats","maxstats","capScreenshareBitrate","videoQuality","supportsUnifiedPlan","enableUnifiedOnChrome","_abtestSuspendVideoEnabled","preferH264","disableH264","preferredCodec","startSilent","createPeerConnection","onicecandidate","phase","sendIceCandidate","onsignalingstatechange","signalingState","connectionState","oniceconnectionstatechange","isStable","usesTerminateForRestart","enableIceRestart","supportsRestartByTerminate","iceStarted","onnegotiationneeded","remoteDescription","finishedCallback","oldSdp","localDescription","_renegotiate","newSdp","notifyMySSRCUpdate","setChatRoom","localSDP","ice","sdpMLineIndex","jcand","errorMesssage","usedrip","dripContainer","sendIceCandidates","candidates","_assertNotEnded","$iq","initiatorJid","cands","sdpMid","fingerprintLine","tmp","required","newJingleErrorHandler","sessionInfo","sendIQ2","iceCandidates","rtcCandidate","RTCIceCandidate","iceCandidate","addIceCandidate","outerHTML","ssrcElement","setSSRCOwner","i3","ssrcInfoElement","generateRecvonlySsrc","getConfiguredVideoCodec","jingleOffer","failure","setOfferAnswerCycle","sendSessionAccept","workFunction","addTracks","localTrack","createOffer","offerSdp","setLocalDescription","sendSessionInitiate","jingleAnswer","jingleOfferAnswerIq","newRemoteSdp","_processNewJingleOfferIq","oldLocalSdp","bridgeSessionId","sendContentModify","newLocalSdp","preferred","disabled","current","setVideoCodecs","jingleOfferElem","enableForcedReload","sendTransportAccept","originalOffer","clone","newFingerprint","accept","responder","responderJid","sessionModify","setReceiverVideoConstraint","transportAccept","medialines","transportReject","setMaxBitRate","videoActive","setMediaTransferActive","setSenderVideoDegradationPreference","sendSessionTerminate","sessionTerminate","reasonDescription","restart","requestRestart","terminate","reasonCondition","reasonText","sourceAddElem","currentRemoteSdp","addSsrcInfo","i1","i2","_addOrRemoveRemoteStream","finishCallback","removeSsrcInfo","getRemoteSourceInfoByParticipant","_processRemoteRemoveSource","removeRemoteTracks","newLocalSDP","isAdd","logPrefix","readSsrcInfo","addOrRemoveSsrcInfo","_parseSsrcInfoFromSourceAdd","_parseSsrcInfoFromSourceRemove","_processRemoteAddSource","offerIq","remoteSdp","desiredDirection","getDesiredMediaDirection","optionalRemoteSdp","RTCSessionDescription","_initiatorRenegotiate","_responderRenegotiate","setRemoteDescription","createAnswer","answer","offer","oldTrack","newTrack","clearRecvonlySsrc","replaceTrack","shouldRenegotiate","sourceRemoveElem","ssrcLines","operationName","oldSDP","currentLocalSDP","sdpDiff","SDPDiffer","addedMedia","getNewMedia","removedMedia","_addRemoveTrackAsMuteUnmute","setSenderMaxBitrates","isMute","oldLocalSDP","removeTrackMute","addTrackUnmute","_verifyNoSSRCChanged","audioActive","logAudioStr","logVideoStr","isSessionActive","audioActiveChanged","setAudioTransferActive","pcVideoActiveChanged","setVideoTransferActive","jingleContents","newVideoSenders","parseVideoSenders","newMaxFrameHeight","parseMaxFrameHeight","MediaSessionEvents","REMOTE_VIDEO_CONSTRAINTS_CHANGED","_modifyRemoteVideoActive","remoteVideoSenders","isRemoteVideoActive","newSDP","sdpDiffer","request","failureCb","errResponse","errorElSel","errorReasonSel","errorMsgSel","shutdown","abTesting","enableSuspendVideoTest","_getInitiatorJid","integerHash","videoContents","maxFrameHeightSel","JingleSession","arrayEquals","array1","array2","equals","mySDP","otherSDP","myMedias","othersMedias","newMedia","othersMediaIdx","myMedia","othersMedia","otherSsrcGroup","matched","mySsrcGroup","modify","sdpMediaSsrcs","modified","mediaSsrc","nv","SIM_LAYER_RIDS","TPCUtils","videoBitrates","localStreamEncodingsConfig","active","maxBitrate","high","low","scaleResolutionDownBy","transceiver","trackRemoved","getTransceivers","getTrackId","isSimulcastOn","description","parsedSdp","reorderedSsrcs","sources","write","usesSdpMungingForSimulcast","simulcast_03","simulcast","SIM_LAYER_2_RID","SIM_LAYER_3_RID","simulcastLine","isVersionGreaterThan","transceiverInit","sendEncodings","_getStreamEncodings","addTransceiver","_findTransceiver","localVideoHeightConstraints","encoding","localSSRCs","_addedStreams","setEncodings","parameters","getParameters","encodings","setParameters","transceivers","every","ConnectionInfo","apiVersion","CORS_PROXY_URL","corsProxyUrl","head","webkitAudioContext","context","LocalStatsCollector","interval","intervalId","intervalMilis","suspend","isLocalStatsSupported","resume","analyser","createAnalyser","smoothingTimeConstant","fftSize","createMediaStreamSource","frequencyBinCount","getByteTimeDomainData","samples","maxVolume","parseFloat","toFixed","timeDomainDataToAudioLevel","lastLevel","animateLevel","ON","OFF","trackHandler2Prop","streamInactiveHandler","trackMediaType","_streamInactiveHandler","oninactive","_addMediaStreamInactiveHandler","container","_onTrackAttach","_attachTTFMTracker","_onTrackDetach","newAudioLevel","supportsReceiverStats","isWebRTCTrackMuted","getStreamId","trackId","TrackVADEmitter","procNodeSampleRate","vadProcessor","jitsiLocalTrack","_procNodeSampleRate","_vadProcessor","_localTrack","_bufferResidue","Float32Array","_audioContext","createAudioContext","sampleRate","getRequiredPCMFrequency","_vadSampleSize","getSampleLength","_onAudioProcess","_initializeAudioContext","_audioSource","_audioProcessingNode","createScriptProcessor","audioEvent","inData","inputBuffer","getChannelData","completeInData","sampleTimestamp","pcmSample","vadScore","calculateAudioFrameVAD","score","pcmData","onaudioprocess","_disconnectAudioGraph","getDeviceLabel","_connectAudioGraph","_destroyed","_cleanupResources","AudioContextImpl","E2E_RTT_CHANGED","defaultValue","deep","shallowObservable","SpeakerStats","displayName","isLocalStats","_userId","_isLocalStats","setDominantSpeaker","totalDominantSpeakerTime","_dominantSpeakerStart","_hasLeft","newName","isNowDominantSpeaker","isDominantSpeaker","timeElapsed","total","AUDIO_PERMISSION_NAME","PERMISSION_GRANTED_STATUS","VIDEO_PERMISSION_NAME","JitsiMediaDevices","_eventEmitter","_permissions","JitsiMediaDevicesEvents","_logOutputDevice","permissions","_handlePermissionsChange","_permissionsApiSupported","self","query","_parsePermissionState","onchange","results","supported","permissionStatus","TypeError","deviceID","IDENTITY_UPDATED","textEncoder","TextEncoder","subtle","deriveBits","salt","encode","ArrayBuffer","keyBytes","IDENTITY_PROPERTIES","IDENTITY_PROPERTIES_FOR_COMPARE","compareIdentities","node","category","rooms","externalFeatures","_addChatRoom","_removeChatRoom","addNamespace","CAPS","feature","submit","external","_generateVersion","_updateRoomWithExternalFeatures","removeFeature","removeFromPresence","children","addOrReplaceInPresence","_getDiscoInfo","_fixChatRoomPresenceMap","ver","sortedIdentities","accumulatedValue","sortedFeatures","b64_sha1","generateSha","_identities","_features","_notifyVersionChanged","VADAudioAnalyser","createVADProcessor","_createVADProcessor","_vadEmitter","_isVADEmitterRunning","_detectionServices","_vadInitTracker","_processVADScore","_trackAdded","_trackRemoved","vadService","detector","_stopVADEmitter","_startVADEmitter","processVADScore","changeMuteState","isLocalAudioTrack","vadEmitter","getTrackLabel","_changeDetectorsMuteState","destroy","reset","JibriSession","_connection","_mode","_setSessionID","setStatus","_sessionID","_initiator","_liveStreamViewURL","_terminator","appData","broadcastId","focusMucJid","_createIQ","recordingXMLUtils","_setErrorFromIq","errorIq","setError","RecordingResult","AUDIO_WEBM","AUDIO_OGG","TrackRecorder","recorder","startTime","startRecorder","trackRecorder","stopRecorder","determineCorrectFileType","MediaRecorder","isTypeSupported","AudioRecorder","recorders","fileType","isRecording","instantiateTrackRecorder","updateNames","originalStream","ondataavailable","dataEvent","recorderToRemove","getDisplayName","download","blob","Blob","createObjectURL","click","revokeObjectURL","getRecordingResults","getFileType","appID","errType","ANALYTICS_CONNECTION_DISCONNECTED","getJid","setToken","JitsiConference","getConnectionTimes","getLogs","getJingleLog","metadata","ua","getXmppLog","eventManager","JitsiConferenceEventManager","componentsVersions","ComponentsVersions","jvbJingleSession","lastDominantSpeaker","dtmfManager","somebodySupportsDTMF","authEnabled","startAudioMuted","startVideoMuted","startMutedPolicy","isMutedByFocus","mutedByFocusActor","isVideoMutedByFocus","mutedVideoByFocusActor","wasStopped","connectionQuality","ConnectionQuality","avgRtpStatsReporter","AvgRTPStatsReporter","avgRtpStatsN","_audioOutputProblemDetector","AudioOutputProblemDetector","isJvbConnectionInterrupted","speakerStatsCollector","SpeakerStatsCollector","deferredStartP2PTask","delay","backToP2PDelay","isP2PConnectionInterrupted","p2pJingleSession","videoSIPGWHandler","VideoSIPGW","recordingManager","RecordingManager","_conferenceJoinAnalyticsEventSent","isE2EESupported","_e2eEncryption","resourceCreator","isAuthenticatedUser","getNodeFromJid","setupXMPPListeners","codecSettings","disabledCodec","enforcePreferredCodec","jvbCodec","p2pCodec","codecSelection","CodecSelection","_statsCurrentId","statisticsId","Settings","callStatsUserName","statsId","_onIceConnectionInterrupted","_onIceConnectionRestored","_onIceConnectionEstablished","_updateProperties","_sendConferenceJoinAnalyticsEvent","e2eping","E2ePing","setupRTCListeners","receiveVideoController","ReceiveVideoController","sendVideoController","SendVideoController","_peerConnStatusRtcMuteTimeout","_peerConnStatusOutOfLastNTimeout","callStatsThreshold","statisticsDisplayName","callStatsCustomScriptUrl","setupChatRoomListeners","setupStatisticsListeners","enableTalkWhileMuted","supportsVADDetection","_audioAnalyser","vadTalkMutedDetection","VADTalkMutedDetection","DetectionEvents","addVADDetectionService","enableNoisyMicDetection","vadNoiseDetection","VADNoiseDetection","enableNoAudioDetection","_noAudioSignalDetection","NoAudioSignalDetection","hasAudioSignal","setLastN","channelLastN","jvb121Status","Jvb121EventGenerator","p2pDominantSpeakerDetection","P2PDominantSpeakerDetection","userRegion","getPreferredCodec","_maybeSetSITimeout","authenticateAndUpgradeRole","isJoined","joined","isP2PEnabled","isP2PTestModeEnabled","p2pTestMode","onLocalTrackRemoved","closeBridgeChannel","_sendConferenceLeftAnalyticsEvent","_delayedIceFailed","removeXMPPListeners","onMemberLeft","_getActiveMediaSession","isAuthEnabled","isLoggedIn","authIdentity","getAuthLogin","isExternalAuthEnabled","moderator","getExternalAuthUrl","urlForPopup","getPopupLoginUrl","getLoginUrl","getLocalAudioTrack","getLocalVideoTrack","getPerformanceStats","longTasksStats","eventId","addCommandListener","command","addPresenceListener","removeCommandListener","removePresenceListener","sendTextMessage","elementName","sendPrivateTextMessage","sendPrivateMessage","sendCommand","sendCommandOnce","removeCommand","setSubject","subject","isModerator","getTranscriber","transcriber","Transcriber","localAudioTracks","getTranscriptionStatus","transcriptionStatus","_fireAudioLevelChangeEvent","activeTpc","getActivePeerConnection","_fireMuteChangeEvent","actorParticipant","muteParticipant","myroomjid","actorId","_getInitialLocalTracks","isStartAudioMuted","isStartVideoMuted","_setConference","removeLocalTrack","muteHandler","audioLevelHandler","_doReplaceTrack","_setupNewTrack","setVideoType","replaceTrackPromises","videoTypeTagName","getFromPresence","addLocalTrack","setAudioMute","setVideoMute","addAsUnmutePromises","addTrackAsUnmute","removeAsMutePromises","removeTrackAsMute","getRole","role","isHidden","getDomainFromJid","hiddenDomain","lock","lockRoom","JitsiConferenceErrors","unlock","selectParticipant","selectParticipants","participantIds","selectEndpoints","lastN","isInteger","RangeError","isVideoActive","perceptibles","getParticipantCount","countHidden","grantOwner","setAffiliation","revokeOwner","isMyself","isMembersOnly","kickParticipant","kick","_maybeClearSITimeout","_sessionInitiateTimeout","muteMediaType","onMemberJoined","nick","statsID","botType","fullJid","JitsiParticipant","setRole","setBotType","setFeatures","_updateFeatures","_maybeStartOrStopP2P","_onMucJoined","_supportsDTMF","updateDTMFSupport","setProperty","_onMemberBotTypeChanged","botParticipant","getBotType","mediaSessions","removePromises","removeRemoteStreamsOnLeave","removedTracks","onMemberKicked","isSelfPresence","kickedParticipantId","kickedParticipant","onLocalRoleChanged","onUserRoleChanged","onDisplayNameChanged","_displayName","_tracks","emitter","onCallAccepted","setAnswer","onTransportInfo","transportInfo","addIceCandidates","removedTrack","_onIncomingCallP2P","jingleSession","rejectReason","_shouldBeInP2PMode","_rejectIncomingCall","_acceptP2PIncomingCall","onIncomingCall","isFocus","_acceptJvbIncomingCall","serverRegion","_setBridgeChannel","acceptOffer","_suspendMediaTransferForJvbConnection","webSocket","first","initializeBridgeChannel","onCallEnded","forceJvb121","p2pFailed","_stopP2PSession","onSuspendDetected","supportsDTMF","isDTMFSupported","sendTones","tones","duration","pause","peerConnection","startRecording","stopRecording","isSIPCallingSupported","hangup","startTranscriber","stopTranscriber","getPhoneNumber","getPhonePin","getMeetingUniqueId","getMeetingId","setStartMutedPolicy","policy","getStartMutedPolicy","removeLocalParticipantProperty","getLocalParticipantProperty","presMap","nodes","overallFeedback","detailedFeedback","getSsrcByTrack","getLocalSSRC","getSSRC","remoteUserId","getUsageLabel","_isFocus","mucJid","_fireIncompatibleVersionsEvent","sendEndpointMessage","sendChannelMessage","broadcastEndpointMessage","sendThroughVideobridge","messageType","messageToSend","isConnectionInterrupted","_onConferenceRestarted","restartInProgress","_onIceConnectionFailed","IceFailedHandling","remoteID","getStatsID","_addRemoteJVBTracks","_addRemoteTracks","_addRemoteP2PTracks","logName","p2pEstablishmentDuration","jvbEstablishmentDuration","forceJVB121Ratio","establishmentDurationDiff","_setP2PStatus","_removeRemoteJVBTracks","analyticsKeys","getProperty","_maybeClearDeferredStartP2P","_removeRemoteTracks","_removeRemoteP2PTracks","sessionNickname","_resumeMediaTransferForJvbConnection","_startP2PSession","newP2PJingleSession","invite","userLeftEvent","peers","peerCount","shouldBeInP2P","myId","peersId","hasBotPeer","hasFeature","wasP2PEstablished","getP2PConnectionState","startP2PSession","peerJid","stopP2PSession","getSpeakerStats","getStats","setPreferredReceiveMaxFrameHeight","setPreferredSendMaxFrameHeight","createVideoSIPGWSession","sipAddress","VideoSIPGWConstants","meetingId","perf","toggleE2EE","setEnabled","isLobbySupported","getLobby","membersOnlyEnabled","enableLobby","disableLobby","joinLobby","lobbyDenyAccess","denyAccess","lobbyApproveAccess","approveAccess","isAVModerationSupported","getAVModeration","enableAVModeration","disableAVModeration","avModerationApprove","approve","xmppListeners","chatRoom","chatRoomForwarder","EventEmitterForwarder","actor","forward","getStatus","setTerminator","setInitiator","setParticipantPropertyListener","recorderSession","logObject","getError","AuthenticationEvents","txt","myJid","ts","dominant","previous","_addConferenceXMPPListener","audioMuted","videoMuted","ignoreStartMuted","createdTimestamp","actorJid","level","_onByteSentStatsReceived","getVersion","isChrome","isOpera","_bowser","isEngine","RTCRtpTransceiver","matchMedia","_getChromiumBasedVersion","setCodecPreferences","RTCRtpReceiver","getCapabilities","ondevicechange","PerformanceObserver","supportedEntryTypes","RTCRtpSender","createEncodedStreams","createEncodedVideoStreams","ReadableStream","postMessage","codecs","process","versions","chromium","BrowserDetection","AnalyticsAdapter","analyticsHandlers","cache","permanentProperties","setAnalyticsHandlers","_setUserProperties","_sendEvent","setUserProperties","_verifyRequiredFields","objectType","containerType","objectId","_maybeCacheEvent","statsInterval","longTasks","maxDuration","performanceStatsInterval","avgRatePerMinute","getAverage","maxDurationMs","longTaskEventHandler","entries","getEntries","task","observer","observe","buffered","longTasksIntervalId","_lastTimeStamp","rate","addNext","calculatePacketLoss","lostPackets","totalPackets","SsrcStats","loss","bitrate","framerate","ConferenceStats","bandwidth","packetLoss","StatsCollector","baselineAudioLevelsReport","currentAudioLevelsReport","currentStatsReport","previousStatsReport","audioLevelReportHistory","audioLevelsIntervalId","conferenceStats","audioLevelsIntervalMilis","statsIntervalId","statsIntervalMilis","ssrc2stats","setLoss","setResolution","addBitrate","resetBitrate","setFramerate","setCodec","startAudioLevelStats","audioLevels","getAudioLevels","processAudioLevelReport","processStats","processStatsReport","_processAndEmitReport","audioCodec","videoCodec","bitrateDownload","bitrateUpload","resolutions","framerates","audioBitrateDownload","audioBitrateUpload","videoBitrateDownload","videoBitrateUpload","ssrcStats","isDownloadStream","packetsTotal","packetsLost","userResolutions","userFramerates","codecDesc","userCodecs","localAvgAudioLevels","avgAudioLevels","avgAudioLevel","currentValue","getNonNegativeValue","_calculateBitrate","before","fieldName","bytesNow","bytesBefore","bytesProcessed","timeMs","bitrateKbps","byteSentStats","nominated","availableIncomingBitrate","availableOutgoingBitrate","remoteUsedCandidate","remoteCandidateId","localUsedCandidate","localCandidateId","remoteIpAddress","address","remotePort","localIpAddress","localPort","localip","conferenceStatsTransport","localCandidateType","candidateType","remoteCandidateType","networkType","currentRoundTripTime","packetsNow","packetsBefore","packetsDiff","packetsLostNow","packetsLostBefore","packetsLostDiff","frameHeight","frameWidth","framesPerSecond","codecId","codecShortType","remoteSource","localVideoTracks","framesSent","numberOfActiveStreams","getActiveSimulcastStreams","trackIdentifier","getSsrcByTrackId","dest","srcEvent","Function","hidden","_jid","_id","_conference","_role","_hidden","_statsID","_connectionStatus","_properties","_identity","jitsiTrack","_isMediaTypeMuted","newRole","newFeatures","_botType","newBotType","rejectPromise","onLoginSuccessful","roomPassword","canceled","authenticate","authenticationError","connectionError","kJitsiE2EE","E2EEcontext","baseUrl","ljm","querySelector","workerUrl","workerBlob","blobUrl","_worker","Worker","operation","receiverStreams","createEncodedAudioStreams","readableStream","readable","writableStream","writable","senderStreams","stropheConnection","_resumeRetryN","_retryDelay","_cancelResume","_networkOnlineListener","NetworkInfo","_scheduleResume","_resumeTimeout","getJitterDelay","retryDelay","_resumeConnection","resumeToken","pattern","oldToken","retry","minDelay","LastRequestTracker","_lastSuccess","_lastFailedMessage","xmppConnection","originalRawInput","rawInput","rawMessage","failedPings","_onPingThresholdExceeded","_getTimeSinceLastServerResponse","pingInterval","pingTimeout","pingThreshold","threshold","pingTimestampsToKeep","pingExecIntervals","_addPingExecutionTimestamp","_lastServerCheck","getTime","pingIntervals","maxInterval","previousTS","currentInterval","ConnectionPlugin","onPresence","onPresenceUnavailable","onPresenceError","onMessage","onMute","onMuteVideo","getBareJidFromJid","ChatRoom","createNonAnonymousRoom","parser","packet2JSON","xmlElement","child","getText","xmlunescape","json2packet","packet","filterNodeFromPresenceJSON","nodeName","MEMBERS_AFFILIATIONS","members","presHandlers","_removeConnListeners","noBridgeAvailable","Moderator","lobby","Lobby","avModeration","AVModeration","initPresenceMap","lastPresences","phoneNumber","phonePin","participantPropertyListener","locked","JitsiTranscriptionStatus","xns","presenceUpdateTime","disableFocus","allocateConferenceFocus","onConnStatusChanged","fromJoin","billingId","presenceSyncTime","getInfo","DISCO_INFO","meetingIdValEl","setMeetingId","membersOnly","lobbyRoomField","setLobbyRoomJid","disableDiscoInfo","getForm","form","formSubmit","member","statusEl","hasStatusUpdate","hasVersionUpdate","xElement","getElementsByTagNameNS","mucUserItem","affiliation","getFocusUserJid","isHiddenDomain","fromHiddenDomain","xEl","extractIdentityInformation","userInfo","user","_extractFeatures","discoRoomInfo","_initFocus","memberOfThis","displayJids","restartByTerminateSupported","att","phone","pin","processNode","var","focusFeatures","tagHandlers","skipEvents","onMucMemberLeft","destroySelect","reasonSelect","doLeave","isKick","membersKeys","actorNick","actorSelect","onParticipantLeft","subjectText","stamp","dateParts","passwordSelect","lobbyRoomJid","lobbyRoomNode","grantIQ","kickIQ","onError","onNotSupported","formsubmit","formToSubmit","matchingNodes","handlerIdx","sendVideoInfoPresence","sendAudioInfoPresence","audioMutedTagName","addAudioInfoToPresence","videoMutedTagName","addVideoInfoToPresence","mutedNode","codecTypeNode","videoTypeNode","codecType","isSipGatewayEnabled","iqToFocus","onMucLeft","doReject","clean","_xmpp","_mainRoom","_momderationEnabledByType","_whitelistAudio","_whitelistVideo","_onMessage","jidToWhitelist","newWhitelists","whitelists","fireEventApprovedJids","oldList","newList","x","approved","EMAIL_COMMAND","mainRoom","maybeJoinLobbyRoom","_maybeJoinLobbyRoom","setMembersOnly","lobbyRoom","invitePassword","_leaveLobbyRoom","memberRoomJid","msgToSend","createExpBackoffTimer","step","count","origin","xmppService","getNextTimeout","getNextErrorTimeout","externalAuthEnabled","sipGatewayEnabled","attachEvent","setFocusUserJid","focusJid","focusUserJid","getFocusComponent","focusComponent","createConferenceIq","openSctp","machineUID","machineId","audioPacketDelay","startBitrate","minBitrate","octo","probability","openBridgeChannel","parseSessionId","resultIq","parseConfigOptions","authenticationEnabled","_allocateConferenceFocusSuccess","_allocateConferenceFocusError","invalidSession","reservationErr","errorCode","errorTextNode","waitMs","retrySec","urlCallback","failureCallback","_getLoginUrl","popup","urlCb","decodeURIComponent","logout","logoutUrl","names","suffix","jvbIceConfig","p2pIceConfig","offerToReceiveAudio","offerToReceiveVideo","onJingle","fromJid","sess","startMuted","modifyContents","replaceTransport","successTime","sendTransportReject","addRemoteStream","removeRemoteStream","me","onTerminated","v2Res","v2Err","v1Res","v1Err","iceservers","dict","credential","useTurnUdp","updateLog","_queue","queue","_processQueueTasks","_stopped","kill","string","doInitialize","ssrcOwners","oldChatRoom","_audioMuteHandler","_videoMuteHandler","_videoTypeHandler","SignalingEvents","getMediaPresenceInfo","SignalingLayer","StropheLogger","logIncoming","rawOutput","logOutgoing","RAYO_XMLNS","onRayo","roomPass","req","resource","callResource","resetLastErrorStatusRegExpr","lastErrorStatusRegExpr","trace","LogLevel","WARN","DEBUG","errStatusCapture","FATAL","BINDREQUIRED","AUTHENTICATING","_getCodecMimeType","jvbPreferredCodec","_isCodecSupported","p2pPreferredCodec","_selectPreferredCodec","_onMediaSessionStared","mediaSession","selectedCodec","remoteParticipants","peerMediaInfo","getPeerMediaInfo","_areRetriesEnabled","_closedFromClient","datachannel","createDataChannel","_handleChannel","_wsUrl","_initWebSocket","ws","timeoutS","_retryTimeout","closeEvent","once","_stopConnectionRetries","_startConnectionRetries","_send","colibriClass","msgPayload","jsonObject","endpointIds","selectedEndpoints","maxFrameHeightPixels","channel","onopen","onmessage","dominantSpeakerEndpoint","previousSpeakers","endpoint","onclose","_retryWebSocketConnection","DEGRADATION_PREFERENCE_CAMERA","HD_BITRATE","audioTransferActive","_dtmfSender","_dtmfTonesQueue","videoTransferActive","localUfrag","remoteUfrag","_peerVideoTypeChanged","_peerMutedChanged","safeConstraints","rtcStatsSFUP2P","standardVideoBitrates","standard","maxBitratesVideo","tpcUtils","statsinterval","_usesUnifiedPlan","_usesTransceiverCodecPreferences","supportsCodecPreferences","interop","Interop","Simulcast","numOfLayers","explodeRemoteSimulcast","sdpConsistency","SdpConsistency","localSdpMunger","LocalSdpMunger","getLocalEndpointId","rtxModifier","RtxModifier","senderVideoMaxHeight","what","onTrack","evt","_remoteTrackAdded","_remoteTrackRemoved","onaddstream","_remoteStreamAdded","onremovestream","_remoteStreamRemoved","ondatachannel","_processStat","stat","statValue","endTime","times","dumpSDP","isAddOperation","hasLocalSource","hasAnyTracksOfType","mediaTransferActive","_getReceiversByEndpointIds","endpoints","remoteTrackIds","getReceivers","_setVideoType","setMute","audioReceivers","getSynchronizationSources","endpointTrackMap","mediaTrack","primarySsrcs","fidLines","getTargetVideoBitrates","currentCodec","toUpperCase","findTrackById","onaddtrack","onremovetrack","streamAudioTracks","streamVideoTracks","mediaLines","remoteSDP","mls","trackSsrc","ownerEndpointId","getSSRCOwner","_createRemoteTrack","remoteTracksMap","existingTrack","JitsiRemoteTrack","isUserStream","_removeRemoteTrackById","_getRemoteTrackById","removedAudioTrack","removedVideoTrack","_removeRemoteTrack","toBeRemoved","normalizePlanB","firstSsrcs","newSsrcLines","filteredLines","ssrcId","cnameLine","replaceDefaultUnifiedPlanMsid","resStr","_getSSRC","_injectSsrcGroupForUnifiedSimulcast","fidGroups","getters","toPlanB","maybeAddMutedLocalVideoTracksToSDP","transformer","audioMedia","selectMedia","videoMedia","toRawSDP","enforceSendRecv","transformStreamIdentifiers","_adjustRemoteMediaDirection","_isSharingScreen","_mungeCodecOrder","codecPreference","bitrates","hdBitrate","limit","containsTrack","webrtcStream","_addStream","generateNewStreamSSRCInfo","setPrimarySsrc","setSsrcCache","rtxSsrcMapping","rtxSsrc","promiseChain","_assertTrackBelongs","webRtcStream","addStream","_removeStream","removeStream","doesBelong","defaultCodec","isMediaStreamInPc","findSenderByKind","getSenders","opts","_ensureSimulcastGroupIsLast","localSdp","sdpStr","videoStartIndex","simStartIndex","otherStartIndex","simEndIndex","simStr","otherEndIndex","sdpHead","simStrTrimmed","sdpTail","_adjustLocalMediaDirection","modifiedDirection","desiredAudioDirection","desiredVideoDirection","hasRemoteSource","_mungeOpus","opusMaxAverageBitrate","mLines","fmtpOpus","fmtpConfig","parseParams","sdpChanged","maxaveragebitrate","mungedConfig","toUnifiedPlan","localVideoTrack","videoSender","preference","degradationPreference","updateEncodingsResolution","planBScreenSharing","presenterEnabled","scaleFactor","layer","currentDescription","mungeRemoteDescription","insertUnifiedPlanSimulcastReceive","ensureCorrectOrderOfSsrcs","newHeight","encodingsEnabledState","getLocalStreamHeightConstraints","ldStreamIndex","interToneGap","rtpSender","dtmf","localAudioTrack","createDTMFSender","ontonechange","_onToneChange","toneBuffer","insertDTMF","tone","clearVideoSsrcCache","peerTracks","_removePeerConnection","_createOfferOrAnswer","isOffer","handleSuccess","resultSdp","resolveFn","rejectFn","hasPrimarySsrcCached","makeVideoPrimarySsrcsConsistent","mungeLocalDescription","modifyRtxSsrcs","groupsMap","groupSSRCs","extractSSRCMap","_processLocalSSRCsMap","capabilities","handleFailure","_extractPrimarySSRC","trackMSID","newSSRCNum","oldSSRCNum","usernameFragment","activeStreams","currNumSsrcs","localEndpointId","localVideos","isInPeerConnection","requiredSSRCs","ssrcCache","cachedPrimarySsrc","primaryCname","removeSSRC","addSSRCAttribute","addSSRCGroup","modifyRtxSsrcs2","pcId","mediaSection","streamAndTrackIDs","_generateMsidAttribute","msidLine","generatedMsid","_addMutedLocalVideoTracksToSDP","sessionDesc","audioMLine","_transformMediaIdentifiers","updateAssociatedRtxStream","primarySsrcInfo","primarySsrcMsid","primarySsrcCname","cname","previousRtxSSRC","getRtxSSRC","removeGroupsWithSSRC","correspondingRtxSsrcs","ssrcMapping","sdpTransformer","getSSRCCount","primaryVideoSsrcs","getPrimaryVideoSSRCs","getSSRCAttrValue","correspondingRtxSsrc","previousAssociatedRtxStream","containsAnySSRCGroups","findGroups","removeGroupsBySemantics","injectRecvOnly","newPrimarySsrc","getPrimaryVideoSsrc","replaceSSRC","ttfmTrackerAudioAttached","ttfmTrackerVideoAttached","containerEvents","hasBeenMuted","_bindTrackHandlers","_containerHandlers","_containerEventHandler","_onTrackMute","_onTrackUnmute","gumStart","gumEnd","gumDuration","ttfm","_playCallback","_getStatus","kSimulcastFormats","layers","target","targetRN","getTarget","millisSinceStart","videoQualitySettings","simulcastFormat","targetHeight","rampUp","_localStats","jvbRTT","_lastConnectionQualityUpdate","_remoteStats","_timeIceConnected","_timeVideoUnmuted","ConferenceEvents","_updateLocalConnectionQuality","ConnectionQualityEvents","_broadcastLocalStats","_updateRemoteStats","_updateLocalStats","_maybeUpdateUnmuteTime","bridgeCount","resolutionName","quality","activeTPC","prevConnectionQuality","diffSeconds","updateLocalConnectionQuality","_calculateConnectionQuality","explicitlyDisabled","useTerminateForRestart","reloadClient","jvbConnection","jvbConnIceState","getIceConnectionState","sendIceFailedNotification","_canceled","_iceFailedTimeout","_actOnIceFailed","_timeoutTrigger","_hasAudioInput","_audioLevel","_eventFired","_clearTriggerTimeout","_audioTrack","_handleAudioInputStateChange","_handleNoAudioInputDetection","myUserID","_processing","_scoreArray","_audioLvlArray","_active","_calculateNoisyScore","scoreAvg","audioLevelAvg","_setActiveState","avgAudioLvl","_processTimeout","posAudioLevels","_recordValues","_calculateVADScore","E2E_PING_REQUEST","E2E_PING_RESPONSE","ParticipantWrapper","requests","lastRequestId","clearIntervals","sendRequest","handleResponse","maybeSendAnalytics","isDataChannelOpen","pingIntervalMs","analyticsInterval","analyticsIntervalMs","requestId","requestMessage","timeSent","E2ePingEvents","Infinity","participantJoined","participantLeft","messageReceived","dataChannelOpened","participantWrapper","handleRequest","_jvb121","evaluateStatus","oldStatus","ReceiverVideoConstraints","_defaultConstraints","defaultConstraints","_rtc","startLastN","useNewBandwidthAllocationStrategy","updateLastN","setNewReceiverVideoConstraints","updateReceiveResolution","remoteEndpointIds","oldConstraints","updateSelectedEndpoints","newConstraints","updateReceiverVideoConstraints","p2pSession","layerSuspensionEnabled","enableLayerSuspension","_propagateSendMaxFrameHeight","_senderVideoConstraints","idealHeight","sendMaxFrameHeight","selectSendMaxFrameHeight","activeMediaSession","getRemoteRecvMaxFrameHeight","preferredSendMaxFrameHeight","_sessions","_chatRoom","_handleFocusPresence","_handleJibriPresence","getSession","getID","_addSession","_emitSessionUpdate","_createSession","setLiveStreamViewURL","_localAudioLevelCache","_reportedParticipants","_audioProblemCandidates","_numberOfRemoteAudioLevelsReceived","_onLocalAudioLevelsReport","_onRemoteAudioLevelReceived","_clearUserData","numberOfReports","isAudioMuted","localAudioLevelsString","AverageStatReport","calculate","ConnectionAvgStats","_n","_sampleIdx","_avgRTT","_avgRemoteRTTMap","_avgRtpStatsReporter","_avgEnd2EndRTT","_onConnectionStats","_calculateAvgStats","_onRemoteStatsUpdated","_processRemoteStats","supportsRTTStatistics","batchReport","appendReport","jvbEnd2EndRTT","jvbStatsMonitor","avgRemoteRTT","_calculateAvgRemoteRTT","avgLocalRTT","_resetAvgStats","remoteAvg","avg","validData","rttAvg","_avgAudioBitrateUp","_avgAudioBitrateDown","_avgVideoBitrateUp","_avgVideoBitrateDown","_avgBandwidthUp","_avgBandwidthDown","_avgPacketLossTotal","_avgPacketLossUp","_avgPacketLossDown","_avgRemoteFPS","_avgRemoteScreenFPS","_avgLocalFPS","_avgLocalScreenFPS","_avgRemoteCameraPixels","_avgRemoteScreenPixels","_avgLocalCameraPixels","_avgLocalScreenPixels","_avgCQ","_cachedTransportStats","_onLocalStatsUpdated","_maybeSendTransportAnalyticsEvent","_onP2PStatusChanged","p2pStatsMonitor","_onJvb121StatusChanged","_resetAvgJvbStats","confSize","supportsBandwidthStatistics","_calculateAvgVideoFps","_calculateAvgVideoPixels","peerResolutions","peerPixelsSum","myID","peerID","videosResolution","peerAvgPixels","_calculatePeerAvgVideoPixels","videos","peerSsrcCount","peerSsrcPixels","peerFpsSum","videosFps","peerAvgFPS","_calculatePeerAvgVideoFps","peerSsrcFps","transportStats","dominantSpeakerId","_onDominantSpeaker","_onUserJoin","_onUserLeave","_onDisplayNameChange","_updateStats","oldDominantSpeaker","newDominantSpeaker","savedUser","markAsHasLeft","newStats","speakerStatsToUpdate","SphinxService","BEFORE_STATE","RECORDING_STATE","TRANSCRIBING_STATE","FINISHED_STATE","audioRecorder","transcriptionService","transcription","lineLength","blobCallBack","wordArray","getUTCMilliseconds","wordObject","begin","end","word","maybeMerge","hasPopulatedArrays","twoDimensionalArray","callBack","recordingResult","merge","arrays","potentialWords","pushWordToSortedArray","lowestWordArray","wordToAdd","updateTranscription","foundSmaller","wordToCompare","getTranscription","getState","processVersions","mucResource","getComponentVersion","componentName","sessionStateChangeListener","sessionStateChanged","handleJibriSIPState","Constants","sipaddress","setState","failure_reason","JitsiVideoSIPGWSession","addStateListener","removeStateListener","STATE_CHANGED","_sendJibriIQ","failureReason","oldState","displayname","nodeTree","getActiveAudioDevice","audioDevices","devicePromiseArray","micDevice","devicePromise","outcomeArray","successfulPromises","rejectedPromises","rejectReasons","stopActiveDevices","deviceLabel","ProxyConnectionService","_peerConnection","_onFatalError","_onSendMessage","_onRemoteStream","getPeerJid","_convertStringToXML","$jingle","_createPeerConnection","receiveVideo","processMessage","_selfCloseConnection","xml","xmlDom","DOMParser","parseFromString","onRemoteStream","onSendMessage","ProxyConnectionPC","jitsiRemoteTrack","isVideo","convertVideoToDesktop","jitsiLocalTracks","createLocalTracks","stringifiedIq","XMLSerializer","serializeToString","onConnectionClosed","receiveAudio","_onError","_onSessionAccept","_onSessionInitiate","_onSessionTerminate","_onTransportInfo","connectionStub","iceConfigStub","roomStub","BUSY","RESOURCE_CONSTRAINT","SERVICE_UNAVAILABLE","FILE","STREAM","PRECALL_TEST_RESULTS","_initialized","api","_loadScript","_initialize","appId","appSecret","disablePrecalltest","execute","makePrecallTest","getTokenAuthUrl","urlPattern","roleUpgrade","AudioMixer","_started","_streamsToMix","_streamMSSArray","_mixedMSD","streamMSS","PropertyType","FRAGMENTING_LENGTH","syncLog","ConferenceSync","fragmentedMessages","fragmentedMessageHead","sendPoseMessageNow","sendMouseMessageNow","sendOnStage","sendTrackStates","sendAfkChanged","channelOpened","poseStr","mouseStr","trackStates","updatedContents","sendFragmentedMessage","removedIds","contentsToSend","roomInfo","onUpdateProp","caller","calledBy","icon","afk","found","kickTimes","kt","pids","updateByRemoteRequest","participantNameChanged","states","distance","NEAR","TOUCH","connectedPids","onMainScreenCarrier","cs_","checkDuplicatedWallpaper","replaceRemoteContents","cds","removeByRemoteRequest","removeLeftContentByRemoteRequest","onParticipantTrackLimits","addRemoteTrack","removeRemoteTrack","onChatMessage","onCallRemote","onKicked","onAfkChanged","onParticipantInfo","onParticipantTrackState","onParticipantPose","onParticipantMouse","onParticipantOnStage","onYarnPhone","onMuteAudio","onReloadBrower","onMyContent","onContentUpdateRequest","onContentRemoveRequest","onLeftContentRemoveRequest","callTo","sendParticipantInfo","calcWait","sendPoseMessage","poseWait","lastPoseStr","newWait","throttle","updateTimeForProperty","lastPoseStrProprty","setPoseProperty","period","wait","sendMouseMessage","sendMouse","yarnPhoneUpdated","msgs","onRoomProp","sendAllAboutMe","onContentInfoUpdate","onParticipantOut","onMouseOut","onContentOut","checkInfo","trackLog","eventLog","CONF","stringArrayMessageTypesForClient","lastRequestTime","lastReceivedTime","messagesToSendToRelay","relayRttLast","relayRttAverage","stopStep","localMicTrack","localCameraTrack","receivedMessages","createJitsiConference","KICK_WAIT_MIN","registerJistiConferenceEvents","jc","showState","observeEnd","arg","logStr","deadline","onBmMessage","REQUEST_INTERVAL","REQUEST_WAIT_TIMEOUT","visibleArea","audibleArea","sendMessageViaRelay","resolveFunc","doSetLocalMicTrack","doSetLocalCameraTrack","bitRateAlreadyReduced","encording","maxBitrateForVideo","maxBitrateForAudio","sendMessageViaJitsi","viaBridge","onOpen","onClose","setHandler","sendRandP","oldV","ne","waitAndSend","onConferenceJoined","onLocalTrackAdded","reduceBitrate","REMOTE_TRACK_VIDEOTYPE_CHANGING","newType","REMOTE_TRACK_VIDEOTYPE_CHANGED","oldType","timeStamp","observeStart","connectToRelayServer","Logger","getAnalyticsAttributesFromOptions","video_requested","_mergeNamespaceAndModule","constants","recording","recordingConstants","sipVideoGW","detection","errors","errorTypes","logLevels","levels","getGlobalOnErrorHandler","aprops","isWebRtcSupported","setLogLevelById","addGlobalLogTransport","globalTransport","addGlobalTransport","removeGlobalLogTransport","removeGlobalTransport","setGlobalLogOptions","setGlobalOptions","oldfirePermissionPromptIsShownEvent","promiseFulfilled","firePermissionPromptIsShownEvent","fireSlowPromiseEvent","restOptions","firePermissionPrompt","emitEvent","mStream","currentlyAvailableMediaDevices","setVideoTrackContentHints","createTrackVADEmitter","localAudioDeviceId","createAudioMixer","isMultipleAudioInputSupported","isCollectingLocalStats","lineno","colno","setNetworkInfo","updateNetworkInfo","hint","contentHint","precallTest","util","AuthUtil","Word","TranscriptionService","sphinxURL","toReturn","getURL","audioFileBlob","DONE","responseText","setRequestHeader","formatResponse","objects","filler","verify","getWord","getBeginTime","getEndTime","audioBlob","StoreContext","createContext","StoreProvider","Provider","useStore","useContext","AfkDialog","useEffect","evKey","preventDefault","stopPropagation","DialogContent","fontSize","Button","variant","textTransform","autoFocus","onKeyDown","onClick","TheEntrance","props","useParticipants","useState","setName","savedRoom","setRoom","save","saveInformationToStorage","onKeyPress","tfIStyle","tfLStyle","tfDivStyle","right","display","language","changeLanguage","float","usageJa","usageEn","alt","TextField","multiline","inputProps","InputLabelProps","onChange","fullWidth","Box","mt","dialogs","ErrorDialogFrame","Dialog","DialogTitle","ErrorDialog","mb","ml","acceleratorText2El","MAX","MySlider","Grid","spacing","Slider","valueLabelDisplay","aria-labelledby","setValue","valueLabelFormat","RemoteTrackLimitControl","useObserver","videoSlider","audioSlider","FormControlLabel","control","passMatched","sendTrackLimits","roomProps","btnColor","AdminConfigForm","React","clearName","setClearName","showFillPicker","setShowFillPicker","showColorPicker","setShowColorPicker","fillButton","useRef","colorButton","textForFill","textForColor","marginTop","currentTarget","newPassword","setRoomProp","removeAllContents","Popover","anchorEl","anchorOrigin","vertical","horizontal","disableAlpha","BroadcastControl","audioBroadcastSwitch","Switch","checked","setPhysics","Container","moreButtonControl","setShowMore","onMouseOver","nativeEvent","sourceCapabilities","firesTouchEvents","MoreButton","useMapStore","Zoom","in","IconButton","className","onClickMore","buttonRef","iconColor","htmlColor","useStyles","makeStyles","theme","marginLeft","marginRight","marginBottom","pointerEvents","FabMain","classes","showMore","divRef","Fab","onContextMenu","onFocus","FabWithTooltip","Tooltip","placement","arrow","paddingTop","CameraSelectorMember","CameraSelector","setStep","useContents","videoMenuItems","cameras","selected","videoInputDevice","keyStr","String","fromCharCode","MenuItem","makeMenuItem","closeVideoMenu","did","keyNum","Input","onFinishInput","inputField","List","ListItem","ImageInput","setFiles","field","acceptedFiles","dropzoneText","imageContent","ShareDialogItem","textEl","button","dense","ListItemAvatar","ListItemText","primary","secondary","secondEl","startCapture","capturedTracks","ShareMenu","useContentsStore","useParticipantsStore","sharing","main","showMouse","fileInput","openMore","setOpenMore","importFile","downloadFile","downloadItems","createText","tc","createWhiteboard","rand","Uint32Array","randStr","createScreen","closeAllScreens","screenAsBackgrouond","whiteboard24Regular","Divider","cursorDefaultOutline","FormControl","RadioGroup","row","aria-label","setScreenFps","Radio","paddingLeft","bxWindowClose","Collapse","unmountOnExit","items","importItems","TextInput","textLabel","ShareDialog","pasteEnabled","menu","iframe","image","zoneimage","none","camera","page","getPage","onExited","onPointerMove","setMouse","clientX","clientY","root","ShareButton","setShowDialog","windowArrowUp","iconSize","showDialog","SoundLocalizationSetting","alignItems","saveMediaSettingsToStorage","StereoAudioSwitch","setButton","anchorReference","padding","outline","wrapper","wrapperInner","Member","timeoutOut","touched","Footer","setShow","showAdmin","setShowAdmin","showShare","setShowShareRaw","setShowShare","containerRef","adminButton","muteA","muteS","muteV","deviceInfos","setDeviceInfos","micMenuEl","setMicMenuEl","speakerMenuEl","setSpeakerMenuEl","videoMenuEl","setVideoMenuEl","checkMouseOnBottom","mouseOnBottom","setShowFooter","ctrlKey","metaKey","altKey","useMemo","audioInputDevice","audioOutputDevice","micMenuItems","speakerMenuItems","closeMicMenu","closeSpeakerMenu","broadcastControl","fabSize","updateDevices","closeAdmin","onClickCapture","Menu","keepMounted","megaphoneIcon","styleCommon","back","styleForSplit","resizerVertical","background","boxSizing","backgroundClip","borderLeft","borderRight","resizerHorizontal","borderTop","borderBottom","styleForList","justifyContent","justifyItems","userSelect","userDrag","whiteSpace","outer","avatarCommon","BORDER_CONTENT","addBoarder","border","borderStyle","borderWidth","borderColor","imageAvatar","textAlign","verticalAlign","textAvatar","RawImageAvatar","initial","Avatar","ImageAvatar","formatTimestamp","textDate","year","getFullYear","month","getMonth","date","getDate","getHours","getMinutes","getSeconds","colorMapBlack","private","colorMapWhite","ChatLine","scale","lineHeight","colorMap","backColor","wordWrap","focusOn","sendChatMessage","sendTo","ChatInBar","setText","flexDirection","overflowY","overflowX","noValidate","autoComplete","nameTo","InputProps","onBlur","useTransparent","iframeEdit","iframeVScrool","divScroll","overflow","divClip","divError","updateUrl","updateAndSend","GDrive","scrolling","scrollTop","onscroll","doSendScroll","mine","INTERVAL","sendScroll","endScroll","vscroll","onWheel","GlobalWorkerOptions","workerSrc","newProps","mainUrl","pages","renderTask","textDiv","annotationDiv","prevSize","pageNum","viewport1","getViewport","updateOnly","viewport","render","canvasContext","getTextContent","childNodes","renderTextLayer","textDivs","transformOrigin","numPages","pageText","getDocument","cMapUrl","cMapPacked","doc","isFinite","stopper","onMouseDown","onMouseUp","onPointerDown","onPointerUp","PDF","refCanvas","refTextDiv","refAnnotationDiv","updateProps","onDoubleClick","CANVAS_SCALE","onPointerEnter","showTop","onPointerLeave","xs","ScreenContent","locals","remotes","simulcastRatios","checkVideoSize","newSize","sx","sy","onMuteLater","onmute","onunmute","autoplay","setTrack","TextMember","isStatic","abortScroll","onUpdateTexts","div","newTexts","scrollLeft","newUrl","sendText","messagesToSend","TextEdit","sendTextLaterRef","leading","sendTextLater","css","visibility","font","resize","letterSpacing","TextDiv","overflowWrap","cssEdit","Fragment","suppressContentEditableWarning","textEditing","Node","selection","getSelection","rangeCount","getRangeAt","removeAllRanges","range","createRange","selectNode","addRange","textToShow","makeLink","regResult","disp","rel","cssText","textEdit","Text","setBeforeChangeEditing","indices","newMessage","focusToEdit","last","urlReg","urlRegExp","RegExp","handleScroll","onScroll","audioEx","BROADCAST_DISTANCE","NodeGroup","playMode","audibility","sourceNode","audioElement","gainNode","pannerNode","audioDeviceId","_defaultPannerRefDistance","createGainNode","createPannerNode","updateAudibility","createAudioElement","play","updateVolume","updateSourceStream","setPlayMode","participant_pose","dist","mul","refDistance","positionX","orientationX","positionY","positionZ","orientationY","orientationZ","setPosition","setOrientation","updateVolumeWithAssets","_x","_y","cLength","xPos","yPos","cPose","diffX","diffY","xContent","yContent","cW1","cH1","volume","touchStatus","xParticipant","yParticipant","getContentsStatus","rolloffFactor","broadcast","defaultPannerRefDistance","gain","createGain","createPanner","Audio","REFDISTANCE_MAX","stereoParameters","refDistanceNormal","setBroadcast","bcast","PLAYTIME_TOLERANCE","getCurrentTimestamp","YTMember","player","goal","skipOnPlaying","pauseIntervalTimer","lastCurrentTimePaused","playTimeout","pauseTimeout","prevRelPos","volumeUI","volumeDist","prevVolumeDist","volumeIntervalTimer","paramStr2map","paramArray","paramArray2map","clearAllTimer","ytSeekAndPlay","seekTo","getPlaybackRate","getPlaylist","getPlaylistIndex","getCurrentTime","seekTarget","onTime","getDuration","playVideoAt","seek","TIMETOSEEK","ytSeekAndPause","pauseCheck","indexStr","ytUpdateState","sep","paramMap2Str","ytPauseInterval","calcVolume","setVolume","checkPositionsForVolume","curVolume","getVolume","updateUIVolume","relPos","YouTube","oldParams","setPlaybackRate","newPlaying","moveToPlay","newPaused","moveToPause","selfPlayed","YouTubePlayer","unMute","indexUpdated","started","loadList","listType","contentTypeIcons","icons","zoneimg","youtube","gdrive","GoogleDriveIcon","whiteboard","pdf","filePdfBox","editButtonTip","RawContent","Content","Row","left1","left2","right2","right1","cellstyle","TableRow","TableCell","align","SharedContentFormMember","SharedContentForm","closeForm","popoverProps","autoHideTitle","extractPopoverProps","TITLE_HEIGHT","clipboardCopy","Table","TableBody","pinOffIcon","pinIcon","imageLine","imageOutlineBadged","biImage","biImageNoFrame","biDashCircleDotted","biPlusCircleFill","restore","RndContentMember","buttons","dragCanceled","_down","downTime","upTime","_item","_timer","_borderTimer","RndContent","setPose","setSize","resizeBase","setResizeBase","resizeBasePos","setResizeBasePos","showTitle","setShowTitle","showForm","setShowForm","preciseOrientation","setPreciseOrientation","dragging","setDragging","rnd","showBorder","setShowBorder","mapStore","setPoseAndSizeToRnd","resizable","rotation","titleHeight","updatePosition","y","updateSize","updateHandler","useLayoutEffect","isFixed","handlerForTitle","onDrag","down","xy","newOri","shiftKey","lv","rotateFromWindow","cv","dragHandler","onDragStart","Element","PointerEvent","setPointerCapture","pointerId","onDragEnd","releasePointerCapture","dir","savePhysicsToStorage","showHideTimer","onMouseMove","onTouchStart","onTouchEnd","handlerForContent","contentRef","formRef","gestureForContent","useGesture","gestureForTitle","theContent","rndContainer","titlePosition","titleContainer","edit","titleButton","note","onShare","dashed","rndCls","enableResizing","resizeDisable","resizeEnable","disableDragging","onResizeStart","onResize","cd","posChange","deltaPos","ratio","onResizeStop","buttonStyle","mat","rotateSelf","hideAll","borderRadius","boxShadow","heihgt","bottomLeft","bottomRight","topLeft","topRight","sharedContentHandler","updateLocalOnly","SharedContent","ContentLine","contentProps","typeIcon","requestContent","ContentList","localeCompare","elements","iStyle","LocalParticipantForm","setFile","showTextColorPicker","setShowTextColorPicker","closeConfig","clearAvatarSrc","uploadAvatarSrc","textColorButton","getColorRGB","textRgb","getTextColorRGB","onSubmit","Checkbox","RemoteParticipantForm","setKick","setClear","Remote","messageServer","StatusDialog","setUpdate","nSessions","pairs","bytesReceived","remoteCandidateIds","poperProps","Popper","Paper","ParticipantLine","RawParticipantList","showStat","setShowStat","remoteIds","statusProps","pa","pb","sensitivity","remoteElements","localElement","ParticipantList","defaultTextLineHeight","textLineStyle","LeftBar","stores","doSetScale","onPinch","da","md","setScale","currentScale","targetScale","limitScale","eventOptions","passive","defaultSize","resizerClassName","paneStyle","videoContainer","setStream","MainScreen","mainStream","videoRef","debugVideos","setDebugVideos","refs","showAllTracks","createRef","newVideos","localStreams","getLocalStreams","remoteStreams","getRemoteStreams","ok","remoteTrackMaps","remoteTrackMap","elementFlags","debugVideo","maxScale","minScale","BaseMember","prebThirdPersonView","mouseDown","downXpos","downYpos","upXpos","upYpos","Base","mem","mapRot","newMatrix","rotateMap","avatarRot","changeMatrix","radius1","radius2","cosAngle","angle","acos","timeDiff","remoteX","remoteY","mouseX","mouseY","ma","scaleSelf","onPinchEnd","movement","onWheelEnd","onMove","touches","onResizeOuter","visualViewport","deltaY","offsetLeft","offsetParent","setScreenSize","clientWidth","clientHeight","setLeft","KeyHandlerPlainState","timerId","timerAgain","clipPath","videoLargerWidth","mirror","videoLargerHeight","StreamAvatar","videoLargerWidthClass","videoLargerHeightClass","onloadedmetadata","defaultProps","ComposedAvatar","remainProps","ConnectedAvatar","showVideo","avatarStream","MemoedAvatar","SVG_RATIO","pointerRotate","pointer","iconProximity","more","RawParticipant","mapData","participantProps","mousePosition","outerRadius","AUDIOLEVELSCALE","svgCenter","inProxZone","audioMeterSteps","audioMeter","cy","cx","stroke","strokeDasharray","strokeDashoffset","iconMeter","Participant","HALF_DEGREE","WHOLE_DEGREE","scrollMap","posOnScreen","RATIO","norm","mapMove","trans","transMap","rotateToWindow","scrollAgain","localDelta","smoothedDelta","moveParticipant","keycodesUse","onTimer","preventList","stopList","timerFunc","onKeyUp","KeyHandlerPlain","participantMoved","deltaF","deltaA","relatedKeyPressed","newA","newPos","moveParticipantByKey","drag","handle","onTouchMove","bindObject","clsToFind","cls","getNamedItem","checkClass","onPointerOut","deltaT","DragHandler","setShowConfig","preventScroll","styleProps","showConfig","moreControl","openConfig","MemoedLocalParticipant","MouseCursor","viewBox","points","strokeWidth","openForm","Line","x1","y1","x2","y2","ParticipantsLayer","remoteMouseCursors","localMouseCursor","PastedContent","onPaste","dataTransfer","clipboardData","getAsFile","getAsString","ext","dropEffect","pastedContent","setPasted","nc","slContainer","ShareLayer","transparent","filtered","logo","Background","App","clsSplit","sharedContentsStore","chatStore","refDiv","refPane","able","setAble","press","capture","pane2Style","minSize","stereoParametersStore","ConnectedGroup","contentTrack","updatePose","relativePose","localPose","remotePose","fromLT","getRelativePoseFromObject","updateStream","updatePannerConfig","updateBroadcast","StereoManager","audioContext","audioDestination","audioOutputMuted","accepts","manager","connectedGroups","participantsMemo","contentsMemo","onPopulationChange","newRemotes","onScreenContentsChange","removeContent","addContent","removeSpeaker","addSpeaker","switchPlayMode","audioManager","getLocalCameraTrack","onStart","renderDOM","ReactDOM","getElementById","configure","enforceActions","startPromise","connectConference","stopImmediatePropagation","returnValue","connectionStart","joinConference"],"mappings":"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","file":"static/js/main.8da2ce93.chunk.js","sourcesContent":["export function multiply(matrix: (DOMMatrix | DOMMatrixReadOnly)[]) {\r\n  return matrix.reduce((p: DOMMatrix, c) => p.multiplySelf(c), new DOMMatrix())\r\n}\r\n\r\nexport function extractScaleX(matrix: DOMMatrix | DOMMatrixReadOnly) {\r\n  return Math.abs(Math.sign(matrix.a) * Math.sqrt(Math.pow(matrix.a, 2) + Math.pow(matrix.c, 2)))\r\n}\r\n\r\nexport function extractScaleY(matrix: DOMMatrix | DOMMatrixReadOnly) {\r\n  return Math.abs(Math.sign(matrix.d) * Math.sqrt(Math.pow(matrix.b, 2) + Math.pow(matrix.d, 2)))\r\n}\r\n\r\nexport function extractScale(matrix: DOMMatrix | DOMMatrixReadOnly): [number, number] {\r\n  return [\r\n    extractScaleX(matrix),\r\n    extractScaleY(matrix),\r\n  ]\r\n}\r\n\r\nexport function extractRotation(matrix: DOMMatrix | DOMMatrixReadOnly): number {\r\n  return Math.atan2(-matrix.c, matrix.a)\r\n}\r\n\r\nexport function transfromAt(center:[number, number], tranform: DOMMatrixReadOnly, baseMatrix:DOMMatrixReadOnly) {\r\n  const tm = (new DOMMatrix()).translate(-center[0], -center[1])\r\n  const itm = (new DOMMatrix()).translateSelf(...center)\r\n  const newMatrix = multiply([itm, tranform, tm, baseMatrix])\r\n\r\n  return newMatrix\r\n}\r\n\r\nexport function transformPoint2D(\r\n  matrix: DOMMatrixReadOnly | DOMMatrix, point: [number, number]): [number, number] {\r\n  return [\r\n    matrix.a * point[0] + matrix.c * point[1] + matrix.e,\r\n    matrix.b * point[0] + matrix.d * point[1] + matrix.f,\r\n  ]\r\n}\r\n\r\nexport function rotateVector2D(\r\n  matrix: DOMMatrixReadOnly | DOMMatrix, point: [number, number]): [number, number] {\r\n  return [\r\n    matrix.a * point[0] + matrix.c * point[1],\r\n    matrix.b * point[0] + matrix.d * point[1],\r\n  ]\r\n}\r\n","export function resolveAtEnd(func: () => void): () => Promise<void> {\r\n  return () => new Promise((resolve: () => void, reject: (reason: any) => void) => {\r\n    try {\r\n      func()\r\n      resolve()\r\n    } catch (err) {\r\n      reject(err)\r\n      throw err\r\n    }\r\n  })\r\n}\r\n","export function getMimeType(url: string){\r\n  return new Promise((resolve, reject)=>{\r\n    const xhttp = new XMLHttpRequest()\r\n    xhttp.timeout = 5000\r\n    xhttp.open('GET', url)\r\n    xhttp.onreadystatechange = function () {\r\n      if (this.readyState === this.LOADING) {\r\n        const type = this.getResponseHeader(\"Content-Type\")\r\n        this.abort()\r\n        resolve(type)\r\n      }\r\n    }\r\n    xhttp.send()\r\n  })\r\n}\r\n","const XMPPEvents = {\r\n    /**\r\n     * Indicates error while adding ice candidate.\r\n     */\r\n    ADD_ICE_CANDIDATE_FAILED: 'xmpp.add_ice_candidate_failed',\r\n\r\n    // Designates an event indicating that the focus has asked us to mute our\r\n    // audio.\r\n    AUDIO_MUTED_BY_FOCUS: 'xmpp.audio_muted_by_focus',\r\n\r\n    // Designates an event indicating that the focus has asked us to disable our\r\n    // camera.\r\n    VIDEO_MUTED_BY_FOCUS: 'xmpp.video_muted_by_focus',\r\n    AUTHENTICATION_REQUIRED: 'xmpp.authentication_required',\r\n    BRIDGE_DOWN: 'xmpp.bridge_down',\r\n\r\n    /**\r\n     * Triggered when 'session-accept' is received from the responder.\r\n     */\r\n    CALL_ACCEPTED: 'xmpp.callaccepted.jingle',\r\n\r\n    // Designates an event indicating that an offer (e.g. Jingle\r\n    // session-initiate) was received.\r\n    CALL_INCOMING: 'xmpp.callincoming.jingle',\r\n\r\n    // Triggered when Jicofo kills our media session, this can happen while\r\n    // we're still in the MUC, when it decides to terminate the media session.\r\n    // For example when the session is idle for too long, because we're the only\r\n    // person in the conference room.\r\n    CALL_ENDED: 'xmpp.callended.jingle',\r\n    CHAT_ERROR_RECEIVED: 'xmpp.chat_error_received',\r\n\r\n    // The conference properties (as advertised by jicofo) have changed\r\n    CONFERENCE_PROPERTIES_CHANGED: 'xmpp.conference_properties_changed',\r\n\r\n    /**\r\n     * This event is triggered when the ICE connects for the first time.\r\n     */\r\n    CONNECTION_ESTABLISHED: 'xmpp.connection.connected',\r\n\r\n    // Designates an event indicating that the connection to the XMPP server\r\n    // failed.\r\n    CONNECTION_FAILED: 'xmpp.connection.failed',\r\n\r\n    // Designates an event indicating that the media (ICE) connection was\r\n    // interrupted. This should go to the RTC module.\r\n    CONNECTION_INTERRUPTED: 'xmpp.connection.interrupted',\r\n\r\n    // Designates an event indicating that the media (ICE) connection was\r\n    // restored. This should go to the RTC module.\r\n    CONNECTION_RESTORED: 'xmpp.connection.restored',\r\n\r\n    // Designates an event indicating that the media (ICE) connection failed.\r\n    // This should go to the RTC module.\r\n    CONNECTION_ICE_FAILED: 'xmpp.connection.ice.failed',\r\n\r\n    // Designates an event indicating that the call has been migrated to a different\r\n    // bridge and that the client needs to be restarted for a successful transition.\r\n    CONNECTION_RESTARTED: 'xmpp.connection.restart',\r\n\r\n    /**\r\n     * Designates an event indicating connection status changes.\r\n     */\r\n    CONNECTION_STATUS_CHANGED: 'xmpp.connection.status.changed',\r\n\r\n    // Designates an event indicating that the display name of a participant\r\n    // has changed.\r\n    DISPLAY_NAME_CHANGED: 'xmpp.display_name_changed',\r\n\r\n    /**\r\n     * Chat room instance have been added to Strophe.emuc plugin.\r\n     */\r\n    EMUC_ROOM_ADDED: 'xmpp.emuc_room_added',\r\n\r\n    /**\r\n     * Chat room instance have been removed from Strophe.emuc plugin.\r\n     */\r\n    EMUC_ROOM_REMOVED: 'xmpp.emuc_room_removed',\r\n    ETHERPAD: 'xmpp.etherpad',\r\n    FOCUS_DISCONNECTED: 'xmpp.focus_disconnected',\r\n    FOCUS_LEFT: 'xmpp.focus_left',\r\n    GRACEFUL_SHUTDOWN: 'xmpp.graceful_shutdown',\r\n\r\n    /**\r\n     * Event fired when 'transport-replace' Jingle message has been received,\r\n     * before the new offer is set on the PeerConnection.\r\n     */\r\n    ICE_RESTARTING: 'rtc.ice_restarting',\r\n\r\n    /**\r\n     * Event fired after the 'transport-replace' message has been processed\r\n     * and the new offer has been set successfully.\r\n     */\r\n    ICE_RESTART_SUCCESS: 'rtc.ice_restart_success',\r\n\r\n    /**\r\n     * Designates an event indicating that we were kicked from the XMPP MUC.\r\n     * @param {boolean} isSelfPresence - whether it is for local participant\r\n     * or another participant.\r\n     * @param {string} actorJid - the jid of the participant who was initator\r\n     * of the kick.\r\n     * @param {?string} participantJid - when it is not a kick for local participant,\r\n     * this is the jid of the participant which was kicked.\r\n     */\r\n    KICKED: 'xmpp.kicked',\r\n\r\n    // Designates an event indicating that our role in the XMPP MUC has changed.\r\n    LOCAL_ROLE_CHANGED: 'xmpp.localrole_changed',\r\n\r\n    /**\r\n     * Event fired when the unique meeting id is set.\r\n     */\r\n    MEETING_ID_SET: 'xmpp.meeting_id_set',\r\n\r\n    // Designates an event indicating that an XMPP message in the MUC was\r\n    // received.\r\n    MESSAGE_RECEIVED: 'xmpp.message_received',\r\n\r\n    // Designates an event indicating that an invite XMPP message in the MUC was\r\n    // received.\r\n    INVITE_MESSAGE_RECEIVED: 'xmpp.invite_message_received',\r\n\r\n    // Designates an event indicating that a private XMPP message in the MUC was\r\n    // received.\r\n    PRIVATE_MESSAGE_RECEIVED: 'xmpp.private_message_received',\r\n\r\n    // Designates an event indicating that a bot participant type had changed\r\n    MUC_MEMBER_BOT_TYPE_CHANGED: 'xmpp.muc_member_bot_type_changed',\r\n\r\n    // Designates an event indicating that the XMPP MUC was destroyed.\r\n    MUC_DESTROYED: 'xmpp.muc_destroyed',\r\n\r\n    // Designates an event indicating that we have joined the XMPP MUC.\r\n    MUC_JOINED: 'xmpp.muc_joined',\r\n\r\n    // Designates an event indicating that a participant joined the XMPP MUC.\r\n    MUC_MEMBER_JOINED: 'xmpp.muc_member_joined',\r\n\r\n    // Designates an event indicating that a participant left the XMPP MUC.\r\n    MUC_MEMBER_LEFT: 'xmpp.muc_member_left',\r\n\r\n    // Designates an event indicating that a participant joined the lobby XMPP MUC.\r\n    MUC_LOBBY_MEMBER_JOINED: 'xmpp.muc_lobby_member_joined',\r\n\r\n    // Designates an event indicating that a participant in the lobby XMPP MUC has been updated\r\n    MUC_LOBBY_MEMBER_UPDATED: 'xmpp.muc_lobby_member_updated',\r\n\r\n    // Designates an event indicating that a participant left the XMPP MUC.\r\n    MUC_LOBBY_MEMBER_LEFT: 'xmpp.muc_lobby_member_left',\r\n\r\n    // Designates an event indicating that a participant was denied access to a conference from the lobby XMPP MUC.\r\n    MUC_DENIED_ACCESS: 'xmpp.muc_denied access',\r\n\r\n    // Designates an event indicating that local participant left the muc\r\n    MUC_LEFT: 'xmpp.muc_left',\r\n\r\n    // Designates an event indicating that the MUC role of a participant has\r\n    // changed.\r\n    MUC_ROLE_CHANGED: 'xmpp.muc_role_changed',\r\n\r\n    // Designates an event indicating that the MUC has been locked or unlocked.\r\n    MUC_LOCK_CHANGED: 'xmpp.muc_lock_changed',\r\n\r\n    // Designates an event indicating that the MUC members only config has changed.\r\n    MUC_MEMBERS_ONLY_CHANGED: 'xmpp.muc_members_only_changed',\r\n\r\n    // Designates an event indicating that a participant in the XMPP MUC has\r\n    // advertised that they have audio muted (or unmuted).\r\n    PARTICIPANT_AUDIO_MUTED: 'xmpp.audio_muted',\r\n\r\n    // Designates an event indicating that a participant in the XMPP MUC has\r\n    // advertised that they have video muted (or unmuted).\r\n    PARTICIPANT_VIDEO_MUTED: 'xmpp.video_muted',\r\n\r\n    // Designates an event indicating that the video type (e.g. 'camera' or\r\n    // 'screen') for a participant has changed.\r\n    // Note: currently this event fires every time we receive presence from\r\n    // someone (regardless of whether or not the \"video type\" changed).\r\n    PARTICIPANT_VIDEO_TYPE_CHANGED: 'xmpp.video_type',\r\n\r\n    /**\r\n     * Indicates that the features of the participant has been changed.\r\n     */\r\n    PARTICIPANT_FEATURES_CHANGED: 'xmpp.participant_features_changed',\r\n    PASSWORD_REQUIRED: 'xmpp.password_required',\r\n\r\n    /**\r\n     * Indicates that phone number changed.\r\n     */\r\n    PHONE_NUMBER_CHANGED: 'conference.phoneNumberChanged',\r\n    PRESENCE_RECEIVED: 'xmpp.presence_received',\r\n    PRESENCE_STATUS: 'xmpp.presence_status',\r\n    PROMPT_FOR_LOGIN: 'xmpp.prompt_for_login',\r\n\r\n    // xmpp is connected and obtained user media\r\n    READY_TO_JOIN: 'xmpp.ready_to_join',\r\n\r\n    /**\r\n     * Indicates that recording state changed.\r\n     */\r\n    RECORDER_STATE_CHANGED: 'xmpp.recorderStateChanged',\r\n\r\n    // Designates an event indicating that we received statistics from a\r\n    // participant in the MUC.\r\n    REMOTE_STATS: 'xmpp.remote_stats',\r\n\r\n    /**\r\n     * Indicates that the offer / answer renegotiation has failed.\r\n     */\r\n    RENEGOTIATION_FAILED: 'xmpp.renegotiation_failed',\r\n    RESERVATION_ERROR: 'xmpp.room_reservation_error',\r\n    ROOM_CONNECT_ERROR: 'xmpp.room_connect_error',\r\n    ROOM_CONNECT_NOT_ALLOWED_ERROR: 'xmpp.room_connect_error.not_allowed',\r\n    ROOM_JOIN_ERROR: 'xmpp.room_join_error',\r\n    ROOM_CONNECT_MEMBERS_ONLY_ERROR: 'xmpp.room_connect_error.members_only',\r\n\r\n    /**\r\n     * Indicates that max users limit has been reached.\r\n     */\r\n    ROOM_MAX_USERS_ERROR: 'xmpp.room_max_users_error',\r\n\r\n    // Designates an event indicating that we sent an XMPP message to the MUC.\r\n    SENDING_CHAT_MESSAGE: 'xmpp.sending_chat_message',\r\n\r\n    // Designates an event indicating that we sent a private XMPP message to\r\n    // a specific user of the muc.\r\n    SENDING_PRIVATE_CHAT_MESSAGE: 'xmpp.sending_private_chat_message',\r\n\r\n    /**\r\n     * Event fired when we do not get our 'session-accept' acknowledged by\r\n     * Jicofo. It most likely means that there is serious problem with our\r\n     * connection or XMPP server and we should reload the conference.\r\n     *\r\n     * We have seen that to happen in BOSH requests race condition when the BOSH\r\n     * request table containing the 'session-accept' was discarded by Prosody.\r\n     * Jicofo does send the RESULT immediately without any condition, so missing\r\n     * packets means that most likely it has never seen our IQ.\r\n     */\r\n    SESSION_ACCEPT_TIMEOUT: 'xmpp.session_accept_timeout',\r\n\r\n    /**\r\n     * Event fired when speaker stats update message is received.\r\n     */\r\n    SPEAKER_STATS_RECEIVED: 'xmpp.speaker_stats_received',\r\n\r\n    /**\r\n     * Event fired when conference creation timestamp is received.\r\n     */\r\n    CONFERENCE_TIMESTAMP_RECEIVED: 'xmpp.conference_timestamp_received',\r\n\r\n    /**\r\n     * Event fired when we receive a message for AV moderation approved for the local participant.\r\n     */\r\n    AV_MODERATION_APPROVED: 'xmpp.av_moderation.approved',\r\n\r\n    /**\r\n     * Event fired when we receive a message for AV moderation.\r\n     */\r\n    AV_MODERATION_RECEIVED: 'xmpp.av_moderation.received',\r\n\r\n    /**\r\n     * Event fired when the moderation enable/disable changes.\r\n     */\r\n    AV_MODERATION_CHANGED: 'xmpp.av_moderation.changed',\r\n\r\n    /**\r\n     * Event fired when we receive message that a new jid was approved.\r\n     */\r\n    AV_MODERATION_PARTICIPANT_APPROVED: 'xmpp.av_moderation.participant.approved',\r\n\r\n    // Designates an event indicating that we should join the conference with\r\n    // audio and/or video muted.\r\n    START_MUTED_FROM_FOCUS: 'xmpp.start_muted_from_focus',\r\n\r\n    // Designates an event indicating that the subject of the XMPP MUC has\r\n    // changed.\r\n    SUBJECT_CHANGED: 'xmpp.subject_changed',\r\n\r\n    // FIXME: how does it belong to XMPP ? - it's detected by the PeerConnection\r\n    // suspending detected\r\n    SUSPEND_DETECTED: 'xmpp.suspend_detected',\r\n\r\n    /**\r\n     * Notifies for transcription status changes. The event provides the\r\n     * following parameters to its listeners:\r\n     *\r\n     * @param {String} status - The new status.\r\n     */\r\n    TRANSCRIPTION_STATUS_CHANGED: 'xmpp.transcription_status_changed',\r\n\r\n    /**\r\n     * Event fired when 'transport-info' with new ICE candidates is received.\r\n     */\r\n    TRANSPORT_INFO: 'xmpp.transportinfo.jingle',\r\n\r\n    /**\r\n     * Indicates that video SIP GW state changed.\r\n     *\r\n     * @param {VideoSIPGWConstants} status - Any of the following statuses:\r\n     * STATUS_BUSY, STATUS_AVAILABLE or STATUS_UNDEFINED.\r\n     */\r\n    VIDEO_SIP_GW_AVAILABILITY_CHANGED: 'xmpp.videoSIPGWAvailabilityChanged',\r\n\r\n    /**\r\n     * Indicates that video SIP GW Session state changed.\r\n     * The statuses are any of the following statuses:\r\n     * STATE_ON, STATE_OFF, STATE_PENDING, STATE_RETRYING, STATE_FAILED.\r\n     * {@see VideoSIPGWConstants}\r\n     *\r\n     * @param {options} event - {address, oldState, newState, displayName}.\r\n     */\r\n    VIDEO_SIP_GW_SESSION_STATE_CHANGED:\r\n        'xmpp.videoSIPGWSessionStateChanged',\r\n\r\n    // Designates an event indicating that the local ICE connection state has\r\n    // changed.\r\n    ICE_CONNECTION_STATE_CHANGED: 'xmpp.ice_connection_state_changed',\r\n\r\n    /**\r\n     * Event which is emitted when the body in an XMPP message in the MUC\r\n     * contains JSON\r\n     */\r\n    JSON_MESSAGE_RECEIVED: 'xmmp.json_message_received'\r\n};\r\n\r\nmodule.exports = XMPPEvents;\r\n","/**\r\n * The events for the conference.\r\n */\r\n\r\n/**\r\n * Event indicates that the current conference audio input switched between audio\r\n * input states,i.e. with or without audio input.\r\n */\r\nexport const AUDIO_INPUT_STATE_CHANGE = 'conference.audio_input_state_changed';\r\n\r\n/**\r\n * Indicates that authentication status changed.\r\n */\r\nexport const AUTH_STATUS_CHANGED = 'conference.auth_status_changed';\r\n\r\n/**\r\n * Fired just before the statistics module is disposed and it's the last chance\r\n * to submit some logs to the statistics service (ex. CallStats if enabled),\r\n * before it's disconnected.\r\n */\r\nexport const BEFORE_STATISTICS_DISPOSED = 'conference.beforeStatisticsDisposed';\r\n\r\n/**\r\n * Indicates that an error occured.\r\n */\r\nexport const CONFERENCE_ERROR = 'conference.error';\r\n\r\n/**\r\n * Indicates that conference failed.\r\n */\r\nexport const CONFERENCE_FAILED = 'conference.failed';\r\n\r\n/**\r\n * Indicates that conference has been joined. The event does NOT provide any\r\n * parameters to its listeners.\r\n */\r\nexport const CONFERENCE_JOINED = 'conference.joined';\r\n\r\n/**\r\n * Indicates that conference has been left.\r\n */\r\nexport const CONFERENCE_LEFT = 'conference.left';\r\n\r\n/**\r\n * Indicates that the conference unique identifier has been set.\r\n */\r\nexport const CONFERENCE_UNIQUE_ID_SET = 'conference.unique_id_set';\r\n\r\n/**\r\n * Indicates that the connection to the conference has been established\r\n * XXX This is currently fired whenVthe *ICE* connection enters 'connected'\r\n * state for the first time.\r\n */\r\nexport const CONNECTION_ESTABLISHED = 'conference.connectionEstablished';\r\n\r\n/**\r\n * Indicates that the connection to the conference has been interrupted for some\r\n * reason.\r\n * XXX This is currently fired when the *ICE* connection is interrupted.\r\n */\r\nexport const CONNECTION_INTERRUPTED = 'conference.connectionInterrupted';\r\n\r\n/**\r\n * Indicates that the connection to the conference has been restored.\r\n * XXX This is currently fired when the *ICE* connection is restored.\r\n */\r\nexport const CONNECTION_RESTORED = 'conference.connectionRestored';\r\n\r\n/**\r\n * A connection to the video bridge's data channel has been established.\r\n */\r\nexport const DATA_CHANNEL_OPENED = 'conference.dataChannelOpened';\r\n\r\n/**\r\n * A user has changed it display name\r\n */\r\nexport const DISPLAY_NAME_CHANGED = 'conference.displayNameChanged';\r\n\r\n/**\r\n * The dominant speaker was changed.\r\n */\r\nexport const DOMINANT_SPEAKER_CHANGED = 'conference.dominantSpeaker';\r\n\r\n/**\r\n * UTC conference timestamp when first participant joined.\r\n */\r\nexport const CONFERENCE_CREATED_TIMESTAMP = 'conference.createdTimestamp';\r\n\r\n/**\r\n * Indicates that DTMF support changed.\r\n */\r\nexport const DTMF_SUPPORT_CHANGED = 'conference.dtmfSupportChanged';\r\n\r\n/**\r\n * Indicates that a message from another participant is received on data\r\n * channel.\r\n */\r\nexport const ENDPOINT_MESSAGE_RECEIVED = 'conference.endpoint_message_received';\r\n\r\n/**\r\n * Indicates that a message for the remote endpoint statistics has been received on the bridge channel.\r\n */\r\nexport const ENDPOINT_STATS_RECEIVED = 'conference.endpoint_stats_received';\r\n\r\n/**\r\n * NOTE This is lib-jitsi-meet internal event and can be removed at any time !\r\n *\r\n * Event emitted when conference transits, between one to one and multiparty JVB\r\n * conference. If the conference switches to P2P it's neither one to one nor\r\n * a multiparty JVB conference, but P2P (the status argument of this event will\r\n * be <tt>false</tt>).\r\n *\r\n * The first argument is a boolean which carries the previous value and\r\n * the seconds argument is a boolean with the new status. The event is emitted\r\n * only if the previous and the new values are different.\r\n *\r\n * @type {string}\r\n */\r\nexport const JVB121_STATUS = 'conference.jvb121Status';\r\n\r\n/**\r\n * You are kicked from the conference.\r\n * @param {JitsiParticipant} the participant that initiated the kick.\r\n */\r\nexport const KICKED = 'conference.kicked';\r\n\r\n/**\r\n * Participant was kicked from the conference.\r\n * @param {JitsiParticipant} the participant that initiated the kick.\r\n * @param {JitsiParticipant} the participant that was kicked.\r\n */\r\nexport const PARTICIPANT_KICKED = 'conference.participant_kicked';\r\n\r\n/**\r\n * The Last N set is changed.\r\n *\r\n * @param {Array<string>|null} leavingEndpointIds the ids of all the endpoints\r\n * which are leaving Last N\r\n * @param {Array<string>|null} enteringEndpointIds the ids of all the endpoints\r\n * which are entering Last N\r\n */\r\nexport const LAST_N_ENDPOINTS_CHANGED = 'conference.lastNEndpointsChanged';\r\n\r\n/**\r\n * Indicates that the room has been locked or unlocked.\r\n */\r\nexport const LOCK_STATE_CHANGED = 'conference.lock_state_changed';\r\n\r\n/**\r\n * Indicates that the region of the media server (jitsi-videobridge) that we\r\n * are connected to changed (or was initially set).\r\n * @type {string} the region.\r\n */\r\nexport const SERVER_REGION_CHANGED = 'conference.server_region_changed';\r\n\r\n/**\r\n * An event(library-private) fired when a new media session is added to the conference.\r\n * @type {string}\r\n * @private\r\n */\r\nexport const _MEDIA_SESSION_STARTED = 'conference.media_session.started';\r\n\r\n/**\r\n * An event(library-private) fired when the conference switches the currently active media session.\r\n * @type {string}\r\n * @private\r\n */\r\nexport const _MEDIA_SESSION_ACTIVE_CHANGED = 'conference.media_session.active_changed';\r\n\r\n/**\r\n * Indicates that the conference had changed to members only enabled/disabled.\r\n * The first argument of this event is a <tt>boolean</tt> which when set to\r\n * <tt>true</tt> means that the conference is running in members only mode.\r\n * You may need to use Lobby if supported to ask for permissions to enter the conference.\r\n */\r\nexport const MEMBERS_ONLY_CHANGED = 'conference.membersOnlyChanged';\r\n\r\n/**\r\n * New text message was received.\r\n */\r\nexport const MESSAGE_RECEIVED = 'conference.messageReceived';\r\n\r\n/**\r\n * Event indicates that the current selected input device has no signal\r\n */\r\nexport const NO_AUDIO_INPUT = 'conference.no_audio_input';\r\n\r\n/**\r\n * Event indicates that the current microphone used by the conference is noisy.\r\n */\r\nexport const NOISY_MIC = 'conference.noisy_mic';\r\n\r\n/**\r\n * New private text message was received.\r\n */\r\nexport const PRIVATE_MESSAGE_RECEIVED = 'conference.privateMessageReceived';\r\n\r\n/**\r\n * Event fired when JVB sends notification about interrupted/restored user's\r\n * ICE connection status or we detect local problem with the video track.\r\n * First argument is the ID of the participant and\r\n * the seconds is a string indicating if the connection is currently\r\n * - active - the connection is active\r\n * - inactive - the connection is inactive, was intentionally interrupted by\r\n * the bridge\r\n * - interrupted - a network problem occurred\r\n * - restoring - the connection was inactive and is restoring now\r\n *\r\n * The current status value can be obtained by calling\r\n * JitsiParticipant.getConnectionStatus().\r\n */\r\nexport const PARTICIPANT_CONN_STATUS_CHANGED\r\n    = 'conference.participant_conn_status_changed';\r\n\r\n/**\r\n * Indicates that the features of the participant has been changed.\r\n */\r\nexport const PARTCIPANT_FEATURES_CHANGED\r\n    = 'conference.partcipant_features_changed';\r\n\r\n/**\r\n * Indicates that a the value of a specific property of a specific participant\r\n * has changed.\r\n */\r\nexport const PARTICIPANT_PROPERTY_CHANGED\r\n    = 'conference.participant_property_changed';\r\n\r\n/**\r\n * Indicates that the conference has switched between JVB and P2P connections.\r\n * The first argument of this event is a <tt>boolean</tt> which when set to\r\n * <tt>true</tt> means that the conference is running on the P2P connection.\r\n */\r\nexport const P2P_STATUS = 'conference.p2pStatus';\r\n\r\n/**\r\n * Indicates that phone number changed.\r\n */\r\nexport const PHONE_NUMBER_CHANGED = 'conference.phoneNumberChanged';\r\n\r\n/**\r\n * The conference properties changed.\r\n * @type {string}\r\n */\r\nexport const PROPERTIES_CHANGED = 'conference.propertiesChanged';\r\n\r\n/**\r\n * Indicates that recording state changed.\r\n */\r\nexport const RECORDER_STATE_CHANGED = 'conference.recorderStateChanged';\r\n\r\n/**\r\n * Indicates that video SIP GW state changed.\r\n * @param {VideoSIPGWConstants} status.\r\n */\r\nexport const VIDEO_SIP_GW_AVAILABILITY_CHANGED\r\n    = 'conference.videoSIPGWAvailabilityChanged';\r\n\r\n/**\r\n * Indicates that video SIP GW Session state changed.\r\n * @param {options} event - {\r\n *     {string} address,\r\n *     {VideoSIPGWConstants} oldState,\r\n *     {VideoSIPGWConstants} newState,\r\n *     {string} displayName}\r\n * }.\r\n */\r\nexport const VIDEO_SIP_GW_SESSION_STATE_CHANGED\r\n    = 'conference.videoSIPGWSessionStateChanged';\r\n\r\n/**\r\n * Indicates that start muted settings changed.\r\n */\r\nexport const START_MUTED_POLICY_CHANGED\r\n    = 'conference.start_muted_policy_changed';\r\n\r\n/**\r\n * Indicates that the local user has started muted.\r\n */\r\nexport const STARTED_MUTED = 'conference.started_muted';\r\n\r\n/**\r\n * Indicates that subject of the conference has changed.\r\n */\r\nexport const SUBJECT_CHANGED = 'conference.subjectChanged';\r\n\r\n/**\r\n * Indicates that DTMF support changed.\r\n */\r\nexport const SUSPEND_DETECTED = 'conference.suspendDetected';\r\n\r\n/**\r\n * Event indicates that local user is talking while he muted himself\r\n */\r\nexport const TALK_WHILE_MUTED = 'conference.talk_while_muted';\r\n\r\n/**\r\n * A new media track was added to the conference. The event provides the\r\n * following parameters to its listeners:\r\n *\r\n * @param {JitsiTrack} track the added JitsiTrack\r\n */\r\nexport const TRACK_ADDED = 'conference.trackAdded';\r\n\r\n/**\r\n * Audio levels of a media track ( attached to the conference) was changed.\r\n */\r\nexport const TRACK_AUDIO_LEVEL_CHANGED = 'conference.audioLevelsChanged';\r\n\r\n/**\r\n * A media track ( attached to the conference) mute status was changed.\r\n * @param {JitsiParticipant|null} the participant that initiated the mute\r\n * if it is a remote mute.\r\n */\r\nexport const TRACK_MUTE_CHANGED = 'conference.trackMuteChanged';\r\n\r\n/**\r\n * The media track was removed from the conference. The event provides the\r\n * following parameters to its listeners:\r\n *\r\n * @param {JitsiTrack} track the removed JitsiTrack\r\n */\r\nexport const TRACK_REMOVED = 'conference.trackRemoved';\r\n\r\n/**\r\n * Notifies for transcription status changes. The event provides the\r\n * following parameters to its listeners:\r\n *\r\n * @param {String} status - The new status.\r\n */\r\nexport const TRANSCRIPTION_STATUS_CHANGED\r\n    = 'conference.transcriptionStatusChanged';\r\n\r\n\r\n/**\r\n * A new user joined the conference.\r\n */\r\nexport const USER_JOINED = 'conference.userJoined';\r\n\r\n/**\r\n * A user has left the conference.\r\n */\r\nexport const USER_LEFT = 'conference.userLeft';\r\n\r\n/**\r\n * User role changed.\r\n */\r\nexport const USER_ROLE_CHANGED = 'conference.roleChanged';\r\n\r\n/**\r\n * User status changed.\r\n */\r\nexport const USER_STATUS_CHANGED = 'conference.statusChanged';\r\n\r\n/**\r\n * Event indicates that the bot participant type changed.\r\n */\r\nexport const BOT_TYPE_CHANGED = 'conference.bot_type_changed';\r\n\r\n/**\r\n * A new user joined the lobby room.\r\n */\r\nexport const LOBBY_USER_JOINED = 'conference.lobby.userJoined';\r\n\r\n/**\r\n * A user from the lobby room has been update.\r\n */\r\nexport const LOBBY_USER_UPDATED = 'conference.lobby.userUpdated';\r\n\r\n/**\r\n * A user left the lobby room.\r\n */\r\nexport const LOBBY_USER_LEFT = 'conference.lobby.userLeft';\r\n\r\n/**\r\n * The local participant was approved to be able to unmute.\r\n * @param {options} event - {\r\n *     {MediaType} mediaType\r\n * }.\r\n */\r\nexport const AV_MODERATION_APPROVED = 'conference.av_moderation.approved';\r\n\r\n/**\r\n * AV Moderation was enabled/disabled. The actor is the participant that is currently in the meeting,\r\n * or undefined if that participant has left the meeting.\r\n *\r\n * @param {options} event - {\r\n *     {boolean} enabled,\r\n *     {MediaType} mediaType,\r\n *     {JitsiParticipant} actor\r\n * }.\r\n */\r\nexport const AV_MODERATION_CHANGED = 'conference.av_moderation.changed';\r\n\r\n/**\r\n * AV Moderation, report for user being approved to unmute.\r\n * @param {options} event - {\r\n *     {JitsiParticipant} participant,\r\n *     {MediaType} mediaType\r\n * }.\r\n */\r\nexport const AV_MODERATION_PARTICIPANT_APPROVED = 'conference.av_moderation.participant.approved';\r\n","import {makeObservable, observable} from 'mobx'\r\n\r\nexport class DevicePreference {\r\n  constructor() {\r\n    makeObservable(this)\r\n  }\r\n  [id: string]: string|undefined\r\n  @observable audioInputDevice:string|undefined = undefined\r\n  @observable videoInputDevice:string|undefined = undefined\r\n  @observable audioOutputDevice:string|undefined = undefined\r\n}\r\n","import {\r\n  defaultInformation, defaultPhysics,\r\n  defaultRemoteInformation,\r\n  LocalInformation, ParticipantBase as IParticipantBase, Physics, RemoteInformation, Tracks\r\n} from '@models/Participant'\r\nimport {findReverseColorRGB, findTextColorRGB, getRandomColorRGB, rgb2Color} from '@models/utils'\r\nimport {Mouse} from '@models/utils'\r\nimport {MapObject} from '@stores/MapObject'\r\nimport {Store} from '@stores/utils'\r\nimport {JitsiTrack} from 'lib-jitsi-meet'\r\nimport {action, computed, makeObservable, observable} from 'mobx'\r\n\r\nexport class TracksStore<T extends JitsiTrack> implements Tracks{\r\n  constructor(){\r\n    makeObservable(this)\r\n  }\r\n  @observable.ref audio:T|undefined = undefined\r\n  @observable audioLevel = 0\r\n  @observable.ref avatar:T|undefined = undefined\r\n  @observable avatarOk = this.avatar ? !this.avatar.getTrack().muted : true\r\n  @computed get audioStream() { return this.audio?.getOriginalStream() }\r\n  @computed get avatarStream() { return this.avatarOk ? this.avatar?.getOriginalStream() : undefined }\r\n  @action onMuteChanged(track: JitsiTrack, mute: boolean) {\r\n    if (track === this.avatar) {\r\n      this.avatarOk = !mute\r\n    }\r\n  }\r\n  @action setAudioLevel(newLevel: number) {\r\n    this.audioLevel = newLevel\r\n  }\r\n}\r\n\r\n\r\nexport class ParticipantBase extends MapObject implements Store<IParticipantBase> {\r\n  @observable id = ''\r\n  @observable.shallow tracks = new TracksStore<JitsiTrack>()\r\n  @observable.shallow physics = defaultPhysics\r\n  @observable.shallow mouse:Mouse = {position:[0, 0], show:false}\r\n  @observable awayFromKeyboard = false\r\n  @observable.shallow information: LocalInformation | RemoteInformation\r\n  @observable muteAudio = false\r\n  @observable muteSpeaker = false\r\n  @observable muteVideo = false\r\n  // determines whether the audio would be rendered\r\n  @computed get showAudio () {\r\n    return !this.muteAudio\r\n  }\r\n  // determines whether the video would be rendered\r\n  @computed get showVideo () {\r\n    return !this.muteVideo\r\n  }\r\n\r\n  constructor(isLocal=false) {\r\n    super()\r\n    makeObservable(this)\r\n    if (isLocal){\r\n      this.information = defaultInformation\r\n    }else{\r\n      this.information = defaultRemoteInformation\r\n    }\r\n  }\r\n\r\n  getColor() {\r\n    let color = this.information.color\r\n    if (!color.length) {\r\n      if (this.information.name.length){\r\n        color = getRandomColorRGB(this.information.name)\r\n      }else{\r\n        color = [0xD0, 0xD0, 0xE0]\r\n      }\r\n    }\r\n    let textColor = this.information.textColor\r\n    if (!textColor.length) {\r\n      textColor = findTextColorRGB(color)\r\n    }\r\n    const reverseRGB = findReverseColorRGB(color)\r\n    const colors = [rgb2Color(color), rgb2Color(textColor), rgb2Color(reverseRGB)]\r\n\r\n    return colors\r\n  }\r\n\r\n  getColorRGB() {\r\n    return this.information.color.length ? this.information.color : getRandomColorRGB(this.information.name)\r\n  }\r\n  getTextColorRGB() {\r\n    let textColor = this.information.textColor\r\n    if (!textColor.length) {\r\n      let color = this.information.color\r\n      if (!color.length) {\r\n        color = getRandomColorRGB(this.information.name)\r\n      }\r\n      textColor = findTextColorRGB(color)\r\n    }\r\n\r\n    return textColor\r\n  }\r\n\r\n  @action.bound\r\n  setPhysics(physics: Partial<Physics>) {\r\n    Object.assign(this.physics, physics)\r\n  }\r\n}\r\n","import {LocalInformation, LocalParticipant as ILocalParticipant, Physics, RemoteInformation, TrackStates} from '@models/Participant'\r\nimport {urlParameters} from '@models/url'\r\nimport {Pose2DMap} from '@models/utils'\r\nimport {checkImageUrl} from '@models/utils'\r\nimport {Store} from '@stores/utils'\r\nimport md5 from 'md5'\r\nimport {action, computed, makeObservable, observable} from 'mobx'\r\nimport {autorun} from 'mobx'\r\nimport {DevicePreference} from './localPlugins'\r\nimport {ParticipantBase} from './ParticipantBase'\r\n// config.js\r\ndeclare const config:any                  //  from ../../config.js included from index.html\r\n\r\nexport interface MediaSettings{\r\n  stream:{\r\n    muteVideo: boolean,\r\n    muteAudio: boolean,\r\n    muteSpeaker: boolean,\r\n  },\r\n  device:DevicePreference,\r\n  headphone: boolean,\r\n  soundLocalizationBase: string,\r\n}\r\n\r\ninterface PhysicsInfo{\r\n  pose: Pose2DMap,\r\n  physics: Physics,\r\n}\r\n\r\nexport class LocalParticipant extends ParticipantBase implements Store<ILocalParticipant> {\r\n  devicePreference = new DevicePreference()\r\n  @observable useStereoAudio = false  //  will be override by url switch\r\n  @observable thirdPersonView = config.thirdPersonView as boolean\r\n  @observable soundLocalizationBase = config.soundLocalizationBase ? config.soundLocalizationBase : 'user'\r\n  @observable remoteVideoLimit = config.remoteVideoLimit || -1 as number\r\n  @observable remoteAudioLimit = config.remoteAudioLimit || -1 as number\r\n  @observable audioInputDevice:string|undefined = undefined\r\n  @observable videoInputDevice:string|undefined = undefined\r\n  @observable audioOutputDevice:string|undefined = undefined\r\n\r\n  information = this.information as LocalInformation\r\n  @observable.ref informationToSend:RemoteInformation|undefined\r\n  @action setThirdPersonView(tpv: boolean) { this.thirdPersonView = tpv }\r\n  @computed get trackStates():TrackStates {\r\n    return {\r\n      micMuted: this.muteAudio,\r\n      speakerMuted: this.muteSpeaker,\r\n      headphone: this.useStereoAudio,\r\n    }\r\n  }\r\n  get info():LocalInformation { return this.information as LocalInformation}\r\n\r\n  constructor() {\r\n    super(true)\r\n    this.informationToSend = undefined\r\n    makeObservable(this)\r\n    this.loadInformationFromStorage()\r\n    if (urlParameters.name) { this.information.name = urlParameters.name }\r\n    this.useStereoAudio = urlParameters.headphone !== null ? true : false\r\n    //  console.debug('URL headphone', urlParameters.headphone)\r\n    this.muteAudio = urlParameters.muteMic !== null ? true : false\r\n    //  console.debug('URL muteMic', urlParameters.muteMic)\r\n    this.muteVideo = urlParameters.cameraOn !== null ? false : true\r\n    //  console.debug('URL cameraOn', urlParameters.cameraOn)\r\n    this.loadMediaSettingsFromStorage()\r\n    this.loadPhysicsFromStorage()\r\n    autorun(() => {\r\n      const gravatar = 'https://www.gravatar.com/avatar/'\r\n      let src = this.information.avatarSrc\r\n      if ((!src || src.includes(gravatar, 0)) && this.information.email){\r\n        const hash = md5(this.information.email.trim().toLowerCase())\r\n        src = `${gravatar}${hash}?d=404`\r\n      }\r\n      if (src){\r\n        checkImageUrl(src).then((src)=>{\r\n          this.information.avatarSrc = src\r\n        }).catch(()=>{\r\n          this.information.avatarSrc = ''\r\n        })\r\n      }\r\n    })\r\n  }\r\n\r\n  //  send infomration to other participants\r\n  @action sendInformation(){\r\n    const {email, ...info} = this.information\r\n    this.informationToSend = info\r\n  }\r\n  //  save and load participant's name etc.\r\n  saveInformationToStorage(isLocalStorage:boolean) {\r\n    let storage = sessionStorage\r\n    if (isLocalStorage) { storage = localStorage }\r\n    //  console.log(storage === localStorage ? 'Save to localStorage' : 'Save to sessionStorage')\r\n    storage.setItem('localParticipantInformation', JSON.stringify(this.information))\r\n  }\r\n  @action.bound\r\n  loadInformationFromStorage() {\r\n    let storage = localStorage\r\n    if (sessionStorage.getItem('localParticipantInformation')) {\r\n      storage = sessionStorage\r\n    }\r\n    //  console.debug(storage === localStorage ? 'Load from localStorage' : 'Load from sessionStorage')\r\n    const infoInStr = storage.getItem('localParticipantInformation')\r\n    if (infoInStr) {\r\n      Object.assign(this.information, JSON.parse(infoInStr))\r\n    }\r\n  }\r\n\r\n  //  Save and MediaSettings etc.\r\n  saveMediaSettingsToStorage() {\r\n    const muteStatus:MediaSettings = {\r\n      stream:{\r\n        muteVideo: this.muteVideo,\r\n        muteAudio: this.muteAudio,\r\n        muteSpeaker: this.muteSpeaker,\r\n      },\r\n      device:this.devicePreference,\r\n      headphone: this.useStereoAudio,\r\n      soundLocalizationBase: this.soundLocalizationBase,\r\n    }\r\n    //  console.log(storage === localStorage ? 'Save to localStorage' : 'Save to sessionStorage')\r\n    localStorage.setItem('localParticipantStreamControl', JSON.stringify(muteStatus))\r\n    sessionStorage.setItem('localParticipantStreamControl', JSON.stringify(muteStatus))\r\n  }\r\n  @action.bound\r\n  loadMediaSettingsFromStorage(rv?: MediaSettings) {\r\n    const settingStrInLocal = localStorage.getItem('localParticipantStreamControl')\r\n    const settingStrInSession = sessionStorage.getItem('localParticipantStreamControl')\r\n    let settingLocal: MediaSettings|undefined = undefined\r\n    let settingSession: MediaSettings|undefined = undefined\r\n    if (settingStrInLocal) { settingLocal = JSON.parse(settingStrInLocal) as MediaSettings }\r\n    if (settingStrInSession) { settingSession = JSON.parse(settingStrInSession) as MediaSettings }\r\n    const setting = settingLocal\r\n    if (setting){\r\n      setting.stream.muteVideo = true\r\n      if (settingSession){ setting.stream.muteVideo = settingSession.stream.muteVideo }\r\n      if (rv){\r\n        Object.assign(rv, setting)\r\n      }else{\r\n        Object.assign(this, setting.stream)\r\n        Object.assign(this.devicePreference, setting.device)\r\n        this.useStereoAudio = setting.headphone\r\n        this.soundLocalizationBase = setting.soundLocalizationBase\r\n      }\r\n    }\r\n  }\r\n\r\n  //  Save and load physics\r\n  savePhysicsToStorage(isLocalStorage:boolean) {\r\n    let storage = sessionStorage\r\n    if (isLocalStorage) { storage = localStorage }\r\n    //  console.log(storage === localStorage ? 'Save to localStorage' : 'Save to sessionStorage')\r\n    const physics: PhysicsInfo = {\r\n      pose: this.pose,\r\n      physics: this.physics,\r\n    }\r\n    storage.setItem('localParticipantPhysics', JSON.stringify(physics))\r\n  }\r\n  @action.bound\r\n  loadPhysicsFromStorage() {\r\n    let storage = localStorage\r\n    if (sessionStorage.getItem('localParticipantPhysics')) {\r\n      storage = sessionStorage\r\n    }\r\n    //  console.debug(storage === localStorage ? 'Load from localStorage' : 'Load from sessionStorage')\r\n    const str = storage.getItem('localParticipantPhysics')\r\n    if (str) {\r\n      const physics = JSON.parse(str) as PhysicsInfo\r\n      Object.assign(this.physics, physics.physics)\r\n      Object.assign(this.pose, physics.pose)\r\n    }\r\n  }\r\n\r\n}\r\n","import {RemoteInformation, RemoteParticipant as IRemoteParticipant, TrackStates as ITrackStates} from '@models/Participant'\r\nimport {action, makeObservable, observable} from 'mobx'\r\nimport {Store} from '../utils'\r\nimport {ParticipantBase} from './ParticipantBase'\r\n\r\nclass TrackStates implements Store<ITrackStates>{\r\n  @observable micMuted = false\r\n  @observable speakerMuted = false\r\n  @observable headphone = false\r\n  constructor(){\r\n    makeObservable(this)\r\n  }\r\n}\r\n\r\nexport class RemoteParticipant extends ParticipantBase implements Store<IRemoteParticipant> {\r\n  information:RemoteInformation = this.information as RemoteInformation\r\n  informationReceived = false\r\n  @observable trackStates = new TrackStates()\r\n  @observable called = false\r\n  lastDistance = 0\r\n  constructor(id:string) {\r\n    super()\r\n    makeObservable(this)\r\n    this.id = id\r\n  }\r\n  @action call(){\r\n    this.called = true\r\n  }\r\n}\r\n","import { PARTICIPANT_SIZE } from '@models/Participant'\r\nimport {JitsiRemoteTrack} from 'lib-jitsi-meet'\r\nimport {action, computed, makeObservable, observable} from 'mobx'\r\nimport {LocalParticipant} from './LocalParticipant'\r\nimport {RemoteParticipant} from './RemoteParticipant'\r\n\r\nexport class Participants {\r\n  constructor() {\r\n    makeObservable(this)\r\n  }\r\n\r\n  @observable.shallow readonly remote = new Map<string, RemoteParticipant>()\r\n  local_ = observable.box(new LocalParticipant())\r\n\r\n  @observable.shallow readonly yarnPhones = new Set<string>()\r\n  @observable yarnPhoneUpdated = false\r\n\r\n  @computed get count(): number {\r\n    return this.remote.size\r\n  }\r\n\r\n  @computed get local(): LocalParticipant {\r\n    return this.local_.get()\r\n  }\r\n\r\n  @computed get localId(): string {\r\n    return this.local.id\r\n  }\r\n\r\n  @action\r\n  setLocalId(id: string) {\r\n    this.local.id = id\r\n  }\r\n\r\n  @action\r\n  join(participantId: string) {\r\n    //  console.debug(`${participantId} join`)\r\n    const newParticipant = new RemoteParticipant(participantId)\r\n    newParticipant.physics.located = false\r\n    this.remote.set(participantId, newParticipant)\r\n  }\r\n\r\n  @action\r\n  leave(participantId: string) {\r\n    this.remote.delete(participantId)\r\n  }\r\n\r\n  @action leaveAll(){\r\n    this.remote.clear()\r\n    this.setLocalId('')\r\n  }\r\n\r\n  find(participantId: string): LocalParticipant | RemoteParticipant | undefined {\r\n    if (participantId === this.localId) {\r\n\r\n      return this.local\r\n    }\r\n\r\n    const res = this.remote.get(participantId)\r\n\r\n    return res\r\n  }\r\n\r\n  addRemoteTrack(track: JitsiRemoteTrack):boolean {\r\n    const remote = this.remote.get(track.getParticipantId())\r\n    if (!remote) { return false }\r\n    if (track.isAudioTrack()) {\r\n      remote.tracks.audio = track\r\n    } else {\r\n      remote.tracks.avatar = track\r\n      track.getTrack().addEventListener('ended', () => { remote.tracks.avatar = undefined })\r\n      track.getTrack().addEventListener('mute', () => { remote.tracks.onMuteChanged(track, true) })\r\n      track.getTrack().addEventListener('unmute', () => { remote.tracks.onMuteChanged(track, false) })\r\n    }\r\n\r\n    return true\r\n  }\r\n  removeRemoteTrack(track: JitsiRemoteTrack):boolean {\r\n    const remote = this.remote.get(track.getParticipantId())\r\n    if (!remote) { return false }\r\n    if (track.isAudioTrack()) {\r\n      remote.tracks.audio = undefined\r\n    } else {\r\n      remote.tracks.avatar = undefined\r\n    }\r\n\r\n    return true\r\n  }\r\n\r\n  isLocal(participantId: string) {\r\n    return participantId === this.localId\r\n  }\r\n\r\n  audibleArea(){\r\n    return [this.local.pose.position[0], this.local.pose.position[1], PARTICIPANT_SIZE * 7]\r\n  }\r\n}\r\n\r\nconst participants = new Participants()\r\ndeclare const d:any\r\nd.participants = participants\r\nexport default participants\r\n","import {connection} from '@models/api'\r\nimport {contentTrackCarrierName} from '@models/api/Constants'\r\nimport {assert} from '@models/utils'\r\nimport {EventEmitter} from 'events'\r\nimport JitsiMeetJS, {JitsiLocalTrack} from 'lib-jitsi-meet'\r\n\r\n// config.js\r\ndeclare const config:any                  //  from ../../config.js included from index.html\r\n\r\n\r\nexport class ConnectionForContent extends EventEmitter {\r\n  private jitsiConnection?: JitsiMeetJS.JitsiConnection\r\n  private jitsiConference?: JitsiMeetJS.JitsiConference\r\n  public localId = ''\r\n\r\n  public init() {\r\n    return new Promise<string>((resolve, reject) => {\r\n      this.initJitsiConnection().then(() => {\r\n        if (this.jitsiConnection) {\r\n          this.jitsiConference = this.jitsiConnection.initJitsiConference(connection.conference.name, config)\r\n          this.jitsiConference.on(JitsiMeetJS.events.conference.CONFERENCE_JOINED, () => {\r\n            this.localId = this.jitsiConference!.myUserId()\r\n            this.jitsiConference?.setPerceptibles([[], []])\r\n            resolve('')\r\n          })\r\n          this.jitsiConference.setDisplayName(contentTrackCarrierName)\r\n          this.jitsiConference.join('')\r\n          this.jitsiConference.setSenderVideoConstraint(1080)\r\n        }else {\r\n          reject('No connection has been established.')\r\n        }\r\n      })\r\n    })\r\n  }\r\n\r\n  public addTrack(track:JitsiLocalTrack) {\r\n    if (this.jitsiConference) {\r\n      this.jitsiConference.addTrack(track)\r\n    }else {\r\n      console.error('Not joined to conference yet.')\r\n    }\r\n  }\r\n  public removeTrack(track:JitsiLocalTrack):Promise<any> {\r\n    if (this.jitsiConference) {\r\n\r\n      return this.jitsiConference.removeTrack(track)\r\n    }\r\n    console.error('Not joined to conference yet.')\r\n\r\n    return Promise.reject()\r\n  }\r\n  public getParticipantId() {\r\n    assert(this.jitsiConference)\r\n\r\n    return this.localId\r\n  }\r\n  public getLocalTracks() {\r\n    const tracks = this.jitsiConference?.getLocalTracks()\r\n\r\n    return tracks ? tracks : []\r\n  }\r\n\r\n  private initJitsiConnection(): Promise < string > {\r\n    return new Promise<string>(\r\n      (resolve, reject) => {\r\n        this.jitsiConnection = new JitsiMeetJS.JitsiConnection(null, undefined, config)\r\n        this.jitsiConnection.addEventListener(JitsiMeetJS.events.connection.CONNECTION_ESTABLISHED, () => {\r\n          resolve(JitsiMeetJS.events.connection.CONNECTION_ESTABLISHED)\r\n        })\r\n        this.jitsiConnection.addEventListener(JitsiMeetJS.events.connection.CONNECTION_FAILED, () => {\r\n          reject(JitsiMeetJS.events.connection.CONNECTION_FAILED)\r\n        })\r\n        this.jitsiConnection.connect()\r\n      },\r\n    )\r\n  }\r\n\r\n  public disconnect(): Promise < any > {\r\n    const rv = new Promise((resolve, reject)=>{\r\n      if (this.jitsiConnection) {\r\n        if (this.jitsiConference){\r\n          this.jitsiConference.leave().then(()=>{\r\n            this.jitsiConnection?.disconnect().then(() => {\r\n              resolve('')\r\n            }).catch(reason=>{\r\n              console.log(`ConnForCont: Fail to disconnect by ${reason}. I'm:${this.localId}`)\r\n            })\r\n          }).catch(reason => {\r\n            console.log(`ConnForCont: Fail to leave by ${reason}. I'm:${this.localId}`)\r\n          })\r\n        }else{\r\n          this.jitsiConnection?.disconnect().then(() => {\r\n            resolve('')\r\n          }).catch(reason => {\r\n            console.log(`ConnForCont no conf: Fail to disconnect by ${reason}. I'm:${this.localId}`)\r\n          })\r\n        }\r\n      }else{\r\n        reject('No connection has been established.')\r\n      }\r\n    })\r\n\r\n    return rv\r\n  }\r\n}\r\n","import {connection} from '@models/api'\r\nimport {ConnectionForContent} from '@models/api/ConnectionForScreenContent'\r\nimport {ISharedContent} from '@models/ISharedContent'\r\nimport {assert} from '@models/utils'\r\nimport {SharedContents} from '@stores/sharedContents/SharedContents'\r\nimport {JitsiLocalTrack, JitsiRemoteTrack, JitsiTrack} from 'lib-jitsi-meet'\r\nimport {action, computed, makeObservable, observable} from 'mobx'\r\n\r\n// config.js\r\ndeclare const config:any             //  from ../../config.js included from index.html\r\n\r\nexport const CID_MAINSCREEN = 'mainScreen'\r\n\r\nconst LOG_CONTENT_TRACK = true\r\nconst contentTrackLog = LOG_CONTENT_TRACK ? console.log : () => {}\r\n\r\nexport class SharedContentTracks {\r\n  private sharedContents:SharedContents\r\n  //  Map<pid (of content carrier), cid / screen map>\r\n  @observable.shallow public carrierMap = new Map<string, string>()\r\n  //  remote tracks whose content or screen is not received yet.\r\n  remoteTrackPool = new Map<string, Set<JitsiRemoteTrack>>()\r\n  //\r\n  constructor(sharedContents: SharedContents) {\r\n    makeObservable(this)\r\n    this.sharedContents = sharedContents\r\n  }\r\n  //  stores\r\n  //  connection for localMain\r\n  localMainConnection?:ConnectionForContent = undefined\r\n  //  tracks for local main\r\n  @observable.shallow localMains: Set<JitsiLocalTrack> = new Set()\r\n  //  connection for localContents  key is cid\r\n  contentCarriers: Map<string, ConnectionForContent> = new Map()\r\n  //  tracks for local contents\r\n  @observable localContents: Map<string, Set<JitsiLocalTrack>> = new Map()\r\n\r\n  //  Map of participantId->track for main screen from remotes\r\n  @observable remoteMains: Map<string, Set<JitsiRemoteTrack>> = new Map()\r\n  //  Map of contentId -> track for content tracks from remotes\r\n  @observable remoteContents: Map<string, Set<JitsiRemoteTrack>> = new Map()\r\n\r\n  // -----------------------------------------------------------------\r\n  //  Public interface\r\n  public clearConnection(){\r\n    this.clearAllRemotes()\r\n    this.clearLocalContentCarriers()\r\n  }\r\n  public clearAllRemotes(){\r\n    this.carrierMap.clear()\r\n    this.remoteTrackPool.clear()\r\n    this.remoteMains.clear()\r\n    this.remoteContents.clear()\r\n  }\r\n\r\n  public clearLocalContentCarriers(){\r\n    this.contentCarriers.forEach(c => c.disconnect())\r\n    this.contentCarriers.clear()\r\n    this.localMainConnection?.disconnect()\r\n    this.localMainConnection = undefined\r\n  }\r\n  public restoreLocalCarriers(){\r\n    this.localContents.forEach((trackSet, cid)=>{\r\n      this.createConnectionForContent(cid, Array.from(trackSet))\r\n    })\r\n    if (this.localMains.size){\r\n      const mains = this.localMains\r\n      this.localMains = new Set()\r\n      this.addLocalMains(Array.from(mains))\r\n    }\r\n  }\r\n\r\n  public onUpdateContent(c: ISharedContent) {\r\n    contentTrackLog(`update SC: id:${c.id} pid:${c.url} cid in map:${this.carrierMap.get(c.url)}`)\r\n    if (c.url) {\r\n      assert(!this.carrierMap.has(c.url) || this.carrierMap.get(c.url) === c.id)\r\n      this.carrierMap.set(c.url, c.id)\r\n      const tracks = this.remoteTrackPool.get(c.url)\r\n      this.remoteTrackPool.delete(c.url)\r\n      tracks?.forEach((track) => {\r\n        this.addRemoteContent(track)\r\n      })\r\n    }\r\n  }\r\n\r\n  public addRemoteTrack(track: JitsiRemoteTrack) {\r\n    const pid = track.getParticipantId()\r\n    const cid = this.carrierMap.get(pid)\r\n\r\n    if (!cid) {\r\n      let pool = this.remoteTrackPool.get(pid)\r\n      if (!pool) {\r\n        pool = new Set<JitsiRemoteTrack>()\r\n        this.remoteTrackPool.set(pid, pool)\r\n      }\r\n      pool.add(track)\r\n    }else if (cid === CID_MAINSCREEN) {\r\n      this.addRemoteMain(track)\r\n    }else {\r\n      if (config.bmRelayServer){\r\n        if (this.contentCarriers.has(cid)){\r\n          contentTrackLog(`SC addRT:Local: cid:${cid} pid:${track.getParticipantId()} track:${track.toString()}`)\r\n        }else{\r\n          contentTrackLog(`SC addRT:cid:${cid} pid:${track.getParticipantId()} track:${track.toString()}`)\r\n          this.addRemoteContent(track)\r\n        }\r\n      }else{\r\n        if (this.sharedContents.localParticipant.myContents.has(cid)) {\r\n          contentTrackLog(`SC addRT:Local: cid:${cid} pid:${track.getParticipantId()} track:${track.toString()}`)\r\n        }else {\r\n          contentTrackLog(`SC addRT:cid:${cid} pid:${track.getParticipantId()} track:${track.toString()}`)\r\n          this.addRemoteContent(track)\r\n        }\r\n      }\r\n    }\r\n  }\r\n  public removeRemoteTrack(track: JitsiRemoteTrack) {\r\n    const carrierId = track.getParticipantId()\r\n    const cid = this.carrierMap.get(carrierId)\r\n    if (cid === CID_MAINSCREEN) {\r\n      this.removeRemoteMain(track)\r\n    }else if (cid) {\r\n      this.removeRemoteContent(track)\r\n    }else {\r\n      const tracks = this.remoteTrackPool.get(track.getParticipantId())\r\n      tracks?.delete(track)\r\n      if (tracks?.size === 0) {\r\n        this.remoteTrackPool.delete(track.getParticipantId())\r\n      }\r\n    }\r\n  }\r\n  public onMainScreenCarrier(carrierId: string, enable: boolean) {\r\n    if (enable) {\r\n      this.carrierMap.set(carrierId, CID_MAINSCREEN)\r\n      const tracks = this.remoteTrackPool.get(carrierId)\r\n      tracks?.forEach(track => this.addRemoteMain(track))\r\n      this.remoteTrackPool.delete(carrierId)\r\n    }else {\r\n      this.remoteMains.delete(carrierId)\r\n      this.carrierMap.delete(carrierId)\r\n    }\r\n  }\r\n\r\n  // -----------------------------------------------------------------\r\n  //  Functions for the MainScreen\r\n  @action public addLocalMains(tracks: JitsiLocalTrack[]) {\r\n    assert(tracks.length)\r\n    if (!tracks.find(track => this.localMains.has(track))) {\r\n      //  add tracks to localMainConnection\r\n      tracks.forEach(track => this.localMains.add(track))\r\n      if (!this.localMainConnection) {\r\n        this.localMainConnection = new ConnectionForContent()\r\n        this.localMainConnection.init().then(() => {\r\n          connection.conference.sync.sendMainScreenCarrier(true)\r\n          tracks.forEach(track => this.localMainConnection!.addTrack(track))\r\n        })\r\n      }else {\r\n        tracks.forEach(track => this.localMainConnection!.addTrack(track))\r\n      }\r\n      //  set onended\r\n      tracks.forEach(track => track.getTrack().onended = () => {\r\n        contentTrackLog('stop sharing screen of ', track)\r\n        this.removeLocalMain(track)\r\n      })\r\n    }else {\r\n      console.error(`addLocalMain: one of track in ${tracks} already in localMains.`)\r\n    }\r\n  }\r\n  @action public removeLocalMain(track: JitsiLocalTrack) {\r\n    if (!this.localMains.delete(track)) {\r\n      console.error(`removeLocalMain: track ${track} not found in localMains.`)\r\n\r\n      return\r\n    }\r\n    connection.conference.sync.sendMainScreenCarrier(false)\r\n    this.localMainConnection!.removeTrack(track).then(() => {\r\n      if (this.localMainConnection!.getLocalTracks().length === 0) {\r\n        this.localMainConnection!.disconnect()\r\n        this.localMainConnection = undefined\r\n      }\r\n    })\r\n  }\r\n  @action public clearLocalMains() {\r\n    const mains = new Set(this.localMains)\r\n    for (const track of mains) {\r\n      this.removeLocalMain(track)\r\n    }\r\n  }\r\n\r\n  @computed get mainStream(): MediaStream|undefined {\r\n    let tracks:JitsiTrack[] = []\r\n    if (this.localMains.size) {\r\n      tracks = Array.from(this.localMains.values()).filter(track => track.getType() !== 'audio')\r\n    } else {\r\n      const keys = Array.from(this.remoteMains.keys())\r\n      if (keys.length) {\r\n        keys.sort()\r\n        const tracks_ = this.remoteMains.get(keys[keys.length - 1])\r\n        if (tracks_) { tracks =  Array.from(tracks_.values()) }\r\n      }\r\n    }\r\n    if (tracks.length) {\r\n      const stream = new MediaStream()\r\n      for (const track of tracks) {\r\n        stream.addTrack(track.getTrack())\r\n      }\r\n\r\n      return stream\r\n    }\r\n\r\n    return undefined\r\n  }\r\n\r\n  @action private addRemoteMain(track: JitsiRemoteTrack) {\r\n    const caRemote = track.getParticipantId()\r\n    const caLocal = this.localMainConnection?.getParticipantId()\r\n    if (caRemote > (caLocal ? caLocal : '')) {\r\n      //  remote carrierId is larger and I have to stop screen shareing\r\n      this.clearLocalMains()\r\n    }\r\n\r\n    if (!this.remoteMains.has(track.getParticipantId())) {\r\n      this.remoteMains.set(track.getParticipantId(), new Set())\r\n    }\r\n    this.remoteMains.get(track.getParticipantId())?.add(track)\r\n  }\r\n  @action private removeRemoteMain(track: JitsiRemoteTrack) {\r\n    this.remoteMains.get(track.getParticipantId())?.delete(track)\r\n    if (this.remoteMains.get(track.getParticipantId())?.size === 0) {\r\n      this.remoteMains.delete(track.getParticipantId())\r\n      this.carrierMap.delete(track.getParticipantId())\r\n    }\r\n  }\r\n\r\n  // -----------------------------------------------------------------\r\n  //  Functions for contents\r\n  @action addLocalContent(cid:string, tracks: JitsiLocalTrack[]) {\r\n    assert(tracks.length)\r\n    const trackSet = new Set(this.localContents.get(cid))\r\n    tracks.forEach(track => trackSet!.add(track))\r\n    assert(!this.localContents.has(cid))\r\n    this.localContents.set(cid, trackSet)\r\n    this.createConnectionForContent(cid, tracks)\r\n  }\r\n  private createConnectionForContent(cid: string, tracks: JitsiLocalTrack[]){\r\n    const conn = new ConnectionForContent()\r\n    this.contentCarriers.set(cid, conn)\r\n    conn.init().then(() => {\r\n      this.carrierMap.set(conn.getParticipantId(), cid)\r\n      const content = this.sharedContents.find(cid)\r\n      assert(content)\r\n      content.url = conn.getParticipantId()\r\n      this.sharedContents.updateByLocal(Object.assign({}, content))\r\n      tracks.forEach(track => conn.addTrack(track))\r\n      tracks[0].getTrack().onended = (ev) => {\r\n        this.sharedContents.removeByLocal(cid)\r\n      }\r\n    })\r\n  }\r\n\r\n  @action clearLocalContent(cid: string) {\r\n    const tracks = this.localContents.get(cid)\r\n    tracks?.forEach((track) => {\r\n      track.getTrack().onended = null\r\n      track.stopStream()\r\n    })\r\n    if (tracks) {\r\n      const conn = this.contentCarriers.get(cid)\r\n      assert(conn)\r\n      this.carrierMap.delete(conn.getParticipantId())\r\n      tracks.forEach(track => conn.removeTrack(track).then(() => {\r\n        if (conn.getLocalTracks().length === 0) { conn.disconnect() }\r\n      }))\r\n    }\r\n    this.localContents.delete(cid)\r\n    this.contentCarriers.delete(cid)\r\n  }\r\n  @action private addRemoteContent(track: JitsiRemoteTrack) {\r\n    const cid = this.carrierMap.get(track.getParticipantId())\r\n    if (cid) {\r\n      const trackSet = this.remoteContents.get(cid)\r\n      const newTrackSet = new Set<JitsiRemoteTrack>(trackSet)\r\n      newTrackSet.add(track)\r\n      this.remoteContents.set(cid, newTrackSet)\r\n    }else {\r\n      console.warn(`No cid found for carrier ${track.getParticipantId()} of track ${track.toString()}`)\r\n    }\r\n  }\r\n  @action private removeRemoteContent(track: JitsiRemoteTrack) {\r\n    const cid = this.carrierMap.get(track.getParticipantId())\r\n    if (cid) {\r\n      const trackSet = this.remoteContents.get(cid)\r\n      trackSet?.delete(track)\r\n      if (trackSet?.size === 0) {\r\n        this.remoteContents.delete(cid)\r\n        this.carrierMap.delete(cid)\r\n      }\r\n    }else {\r\n      console.warn(`No cid found for carrier ${track.getParticipantId()} of track ${track.toString()}`)\r\n    }\r\n  }\r\n  @action clearRemoteContent(cid: string) {\r\n    const content = this.sharedContents.find(cid)\r\n    if (content && content.url) {\r\n      this.carrierMap.delete(content.url)\r\n      this.remoteContents.delete(cid)\r\n    }else {\r\n      console.warn(`No pid found for content ${cid}`)\r\n    }\r\n  }\r\n\r\n  //  utility used by PriorityCalculator\r\n  remoteMainTrack(): (JitsiRemoteTrack|undefined)[] | undefined {\r\n    if (this.localMains.size === 0) {\r\n      const keys = Array.from(this.remoteMains.keys())\r\n      if (keys.length) {\r\n        keys.sort()\r\n        const trackSet = this.remoteMains.get(keys[keys.length - 1])\r\n        if (trackSet) {\r\n          const tracks = Array.from(trackSet)\r\n\r\n          return [tracks.find(track => track.isVideoTrack()), tracks.find(track => track.isAudioTrack())]\r\n        }\r\n      }\r\n    }\r\n\r\n    return undefined\r\n  }\r\n}\r\n","import {connection} from '@models/api'\r\nimport {MessageType} from '@models/api/MessageType'\r\nimport {isContentWallpaper, ISharedContent, SharedContentInfo, WallpaperStore} from '@models/ISharedContent'\r\nimport {diffMap, intersectionMap} from '@models/utils'\r\nimport {assert} from '@models/utils'\r\nimport {default as participantsStore} from '@stores/participants/Participants'\r\nimport participants from '@stores/participants/Participants'\r\nimport {EventEmitter} from 'events'\r\nimport _ from 'lodash'\r\nimport {action, autorun, computed, makeObservable, observable} from 'mobx'\r\nimport {createContent, extractContentDatas, moveContentToTop} from './SharedContentCreator'\r\nimport {SharedContentTracks} from './SharedContentTracks'\r\n\r\nexport const CONTENTLOG = false      // show manipulations and sharing of content\r\nexport const contentLog = CONTENTLOG ? console.log : (a:any) => {}\r\nexport const contentDebug = CONTENTLOG ? console.debug : (a:any) => {}\r\n\r\n// config.js\r\ndeclare const config:any             //  from ../../config.js included from index.html\r\n\r\nfunction zorderComp(a:ISharedContent, b:ISharedContent) {\r\n  return a.zorder - b.zorder\r\n}\r\n\r\nexport class ParticipantContents{\r\n  constructor(pid: string) {\r\n    assert(!config.bmRelayServer)\r\n    makeObservable(this)\r\n    this.participantId = pid\r\n  }\r\n  participantId = ''\r\n  @observable.shallow myContents = new Map<string, ISharedContent>()\r\n}\r\n\r\nexport class SharedContents extends EventEmitter {\r\n  private contentIdCounter = 0\r\n  private localId = ''\r\n  constructor() {\r\n    super()\r\n    makeObservable(this)\r\n    autorun(() => {\r\n      //  sync localId to participantsStore\r\n      const newLocalId = participantsStore.localId\r\n      Array.from(this.owner.keys()).forEach((key) => {\r\n        if (this.owner.get(key) === this.localId) {\r\n          this.owner.set(key, newLocalId)\r\n        }\r\n      })\r\n      const local = this.participants.get(this.localId)\r\n      if (local) {\r\n        this.participants.delete(this.localId)\r\n        local.participantId = newLocalId\r\n        this.participants.set(newLocalId, local)\r\n      }\r\n      this.localId = newLocalId\r\n      contentLog(`Set new local id ${this.localId}`)\r\n    })\r\n    const fps = localStorage.getItem('screenFps')\r\n    if (fps){ this.screenFps = JSON.parse(fps) }\r\n    autorun(() => {\r\n      localStorage.setItem('screenFps', JSON.stringify(this.screenFps))\r\n    })\r\n  }\r\n  @action setEditing(id: string){\r\n    if (id !== this.editing && this.beforeChangeEditing){\r\n      this.beforeChangeEditing(this.editing, id)\r\n    }\r\n    this.editing = id\r\n  }\r\n  private beforeChangeEditing?: (cur:string, next:string) => void = undefined\r\n  public setBeforeChangeEditing(callback?: (cur:string, next:string)=>void, id?:string){\r\n    if (!id || id === this.editing){\r\n      this.beforeChangeEditing = callback\r\n    }\r\n  }\r\n\r\n  // -----------------------------------------------------------------\r\n  //  Contents\r\n  //  All shared contents in Z order. Observed by component.\r\n  tracks = new SharedContentTracks(this)\r\n  @observable pasteEnabled = true\r\n  @observable editing = ''    //  the user editing content\r\n  @observable.shallow all: ISharedContent[] = []\r\n  @observable.shallow sorted: ISharedContent[] = []\r\n  //  Contents by owner  used only when no relay server exists.\r\n  participants: Map < string, ParticipantContents > = new Map<string, ParticipantContents>()\r\n  pendToRemoves: Map < string, ParticipantContents > = new Map<string, ParticipantContents>()\r\n  //  Contents by room  used only when a relay server exsits.\r\n  @observable.shallow roomContents = new Map<string, ISharedContent>()\r\n  //  Contents info     used only when a relay server exsits.\r\n  @observable.shallow roomContentsInfo = new Map<string, SharedContentInfo>()\r\n\r\n  getParticipant(pid: string) {\r\n    assert(!config.bmRelayServer)\r\n    //  prepare participantContents\r\n    let participant = this.participants.get(pid)\r\n    if (!participant) {\r\n      participant = new ParticipantContents(pid)\r\n      this.participants.set(pid, participant)\r\n    }\r\n\r\n    return participant\r\n  }\r\n\r\n  //  pasted content\r\n  @observable.ref pasted:ISharedContent = createContent()\r\n  @action setPasted(c:ISharedContent) {\r\n    console.log('setPasted:', c)\r\n    this.pasted = c\r\n  }\r\n  @action sharePasted() {\r\n    this.shareContent(this.pasted)\r\n    this.pasted = createContent()\r\n  }\r\n  //  share content\r\n  @action shareContent(content:ISharedContent) {\r\n    moveContentToTop(content)\r\n    this.addLocalContent(content)\r\n  }\r\n\r\n  @computed get localParticipant(): ParticipantContents {\r\n    return this.getParticipant(this.localId)\r\n  }\r\n\r\n  //  Map<cid, pid>, map from contentId to participantId\r\n  owner: Map<string, string> = new Map<string, string>()\r\n\r\n  public find(cid: string) {\r\n    if (config.bmRelayServer){\r\n      return this.roomContents.get(cid)\r\n    }else{\r\n      const pid = this.owner.get(cid)\r\n      if (pid) {\r\n        return this.participants.get(pid)?.myContents.get(cid)\r\n      }\r\n    }\r\n\r\n    return undefined\r\n  }\r\n\r\n  removeSameWallpaper(bgs: ISharedContent[]) {\r\n    assert(!config.bmRelayServer)\r\n\r\n    let rv = false\r\n    this.localParticipant.myContents.forEach((c) => {\r\n      if (isContentWallpaper(c)) {\r\n        const same = bgs.find(t => c.url === t.url && _.isEqual(c.pose, t.pose))\r\n        if (same) {\r\n          //  const pid = this.owner.get(same.id)\r\n          if (same.id !== c.id && same.zorder <= c.zorder) {\r\n            this.removeByLocal(c.id)\r\n            rv = true\r\n            console.warn(`My wallpapers id:${c.id} url:${c.url} removed.`)\r\n          }\r\n        }\r\n      }\r\n    })\r\n\r\n    return rv\r\n  }\r\n\r\n  checkDuplicatedWallpaper(pid: string, cs: ISharedContent[]) {\r\n    assert(!config.bmRelayServer)\r\n\r\n    if (config.bmRelayServer){ return }\r\n\r\n    const targets = cs.filter(isContentWallpaper)\r\n    this.localParticipant.myContents.forEach((c) => {\r\n      if (isContentWallpaper(c)) {\r\n        const same = targets.find(t => c.url === t.url && _.isEqual(c.pose, t.pose))\r\n        if (same && same.zorder <= c.zorder) {\r\n          this.removeByLocal(c.id)\r\n          console.warn(`My wallpapers id:${c.id} url:${c.url} removed.`)\r\n        }\r\n      }\r\n    })\r\n  }\r\n\r\n  private removeDuplicated() {\r\n    assert(!config.bmRelayServer)\r\n\r\n    let changed = false\r\n    this.participants.forEach((remote) => {\r\n      if (remote.participantId > this.localParticipant.participantId) {\r\n        const com = intersectionMap(remote.myContents, this.localParticipant.myContents)\r\n        com.forEach((c, cid) => {\r\n          this.disposeContent(c)\r\n          this.localParticipant.myContents.delete(cid)\r\n        })\r\n        changed = changed || com.size !== 0\r\n      }\r\n    })\r\n    if (changed) {\r\n      connection.conference.sync.sendMyContents()\r\n    }\r\n  }\r\n  private updateAll() {\r\n    const newAll:ISharedContent[] = []\r\n    if (config.bmRelayServer){\r\n      Object.assign(newAll, Array.from(this.roomContents.values()))\r\n    }else{\r\n      this.removeDuplicated()\r\n      this.participants.forEach((participant) => {\r\n        newAll.push(...participant.myContents.values())\r\n      })\r\n      this.pendToRemoves.forEach((participant) => {\r\n        newAll.push(...participant.myContents.values())\r\n      })\r\n    }\r\n    const newSorted = Array.from(newAll).sort(zorderComp)\r\n    newSorted.forEach((c, idx) => {c.zIndex = idx+1})\r\n\r\n    //  update observed values\r\n    this.all = newAll\r\n    this.sorted = newSorted\r\n\r\n    if (!config.bmRelayServer){\r\n      this.saveWallpaper()\r\n    }\r\n  }\r\n\r\n  //  wallpaper contents\r\n  wallpapers = ''\r\n  private getWallpaper() {\r\n    let nWallpapers = this.sorted.findIndex((c) => !isContentWallpaper(c))\r\n    if (nWallpapers < 0) { nWallpapers = this.sorted.length }\r\n\r\n    return this.sorted.slice(0, nWallpapers)\r\n  }\r\n  private oldWallPapers: ISharedContent[] = []\r\n  private saveWallpaper() {\r\n    if (!this.localId) { return }\r\n    if (!this.wallpapers) { this.loadWallpaper() }\r\n    let newWallPapers = this.getWallpaper()\r\n    if (newWallPapers.find((c, idx) => c !== this.oldWallPapers[idx])\r\n     || newWallPapers.length !== this.oldWallPapers.length){\r\n       this.oldWallPapers = newWallPapers //  save old one to compare next time.\r\n      //  check dupulicated wall papers.\r\n      if (this.removeSameWallpaper(newWallPapers)) { newWallPapers = this.getWallpaper() }\r\n      //  update wallpapers in localStorage\r\n      const newStore:WallpaperStore = {room:connection.conference.name, contents:extractContentDatas(newWallPapers)}\r\n      let wpStores:WallpaperStore[] = []\r\n      const oldStr = localStorage.getItem('wallpapers')\r\n      if (oldStr) { wpStores = JSON.parse(oldStr) as WallpaperStore[] }\r\n      const idx = wpStores.findIndex(wps => wps.room ===  newStore.room)\r\n      idx === -1 ? wpStores.push(newStore) : wpStores[idx] = newStore\r\n      localStorage.setItem('wallpapers', JSON.stringify(wpStores))\r\n    }\r\n  }\r\n  loadWallpaper() {\r\n    if (this.wallpapers) { return }         //  already loaded\r\n    const curWp = this.getWallpaper()\r\n    if (curWp.length) {                     //  already exist\r\n      this.wallpapers = JSON.stringify(curWp)\r\n\r\n      return\r\n    }\r\n\r\n    //  load wallpapers from local storage\r\n    const str = localStorage.getItem('wallpapers')\r\n    if (!str) {\r\n      this.wallpapers = JSON.stringify([])\r\n    }else {\r\n      const wpStores = JSON.parse(str) as WallpaperStore[]\r\n      const loaded = wpStores.find(store => store.room === connection.conference.name)\r\n      if (loaded) {\r\n        loaded.contents.forEach((lc) => {\r\n          const newContent = createContent()\r\n          Object.assign(newContent, lc)\r\n          this.addLocalContent(newContent)\r\n        })\r\n        this.wallpapers = JSON.stringify(this.getWallpaper())\r\n      }\r\n    }\r\n  }\r\n\r\n  //  add\r\n  addLocalContent(c:ISharedContent) {\r\n    if (config.bmRelayServer){\r\n      if (!c.id) { c.id = this.getUniqueId() }\r\n      this.updateByLocal(c)\r\n    }else{\r\n      if (!participantsStore.localId) {\r\n        console.error('addLocalContant() failed. Invalid Participant ID.')\r\n\r\n        return\r\n      }\r\n      if (!c.id) { c.id = this.getUniqueId() }\r\n      this.localParticipant.myContents.set(c.id, c)\r\n      this.owner.set(c.id, participantsStore.localId)\r\n      //  console.log('addLocalConent', c)\r\n      this.updateAll()\r\n      connection.conference.sync.sendMyContents()\r\n    }\r\n  }\r\n\r\n  takeContentsFromDead(pc: ParticipantContents, cidTake?: string){\r\n    //  console.log(`Take ${cidTake} from pid:${pc.participantId}`)\r\n    let updated = false\r\n    pc.myContents.forEach((c, cid) => {\r\n      if (cidTake && cidTake !== cid) { return }\r\n      if (c.type === 'screen' || c.type === 'camera') {\r\n        pc.myContents.delete(cid)\r\n        this.owner.delete(cid)\r\n        this.disposeContent(c)\r\n      }else {\r\n        this.localParticipant.myContents.set(cid, c)\r\n        pc.myContents.delete(cid)\r\n        this.owner.set(cid, this.localId)\r\n        updated = true\r\n        contentLog('set owner for cid=', cid, ' pid=', this.localId)\r\n      }\r\n    })\r\n    if (pc.myContents.size === 0){\r\n      this.participants.delete(pc.participantId)\r\n      this.pendToRemoves.delete(pc.participantId)\r\n    }\r\n\r\n    return updated\r\n  }\r\n\r\n  private getOrTakeContent(cid: string, callBy?:string) {\r\n    const pid = this.owner.get(cid)\r\n    if (pid) {\r\n      const pc = this.participants.get(pid)\r\n      if (pc) {\r\n        if (pid === this.localId || participants.remote.has(pid)){\r\n          return {pid, pc, take:false}  //  get content\r\n        }else{\r\n          //  The participant own the contents is already left but not notified.\r\n          this.takeContentsFromDead(pc)\r\n          connection.conference.sendMessage(MessageType.PARTICIPANT_LEFT, pid)\r\n\r\n          return {pid: this.localId, pc: this.participants.get(this.localId), take:true}\r\n        }\r\n      }else{\r\n        const pc = this.pendToRemoves.get(pid)\r\n        if (pc){\r\n          if (this.takeContentsFromDead(pc, cid)){\r\n            return {pid: this.localId, pc: this.participants.get(this.localId), take:true}\r\n          }\r\n        }\r\n      }\r\n    }\r\n    console.error(`${callBy}: No owner for cid=${cid}`)\r\n\r\n    return {pid, pc:undefined, take:false}\r\n  }\r\n\r\n  private checkAndGetContent(cid: string, callBy?:string) {\r\n    const pid = this.owner.get(cid)\r\n    if (pid) {\r\n      const pc = pid ? this.participants.get(pid) : undefined\r\n      if (!pc) {\r\n        console.error(`${callBy}: Owner does not have cid=${cid}`)\r\n      }\r\n\r\n      return {pid, pc}\r\n    }\r\n    console.error(`${callBy}: No owner for cid=${cid}`)\r\n\r\n    return {pid, pc:undefined}\r\n  }\r\n\r\n  //  Temporaly update local only no sync with other participant.\r\n  //  This makes non-detectable inconsistency and must call updateByLocal() soon later.\r\n  updateLocalOnly(newContent: ISharedContent){\r\n    if (config.bmRelayServer){\r\n      this.roomContents.set(newContent.id, newContent)\r\n    }else{\r\n      const pc = this.checkAndGetContent(newContent.id, 'updateByLocal').pc\r\n      if (pc) {\r\n        pc.myContents.set(newContent.id, newContent)\r\n      }\r\n    }\r\n    this.updateAll()\r\n  }\r\n  //  updated by local user\r\n  updateByLocal(newContent: ISharedContent) {\r\n    if (config.bmRelayServer){\r\n      this.roomContents.set(newContent.id, newContent)\r\n      connection.conference.sync.sendContentUpdateRequest('', [newContent])\r\n      this.updateAll()\r\n      this.roomContentsInfo.set(newContent.id, newContent)\r\n    }else{\r\n      const {pid, pc} = this.getOrTakeContent(newContent.id, 'updateByLocal')\r\n      if (pc) {\r\n        if (pid === this.localId) {\r\n          pc.myContents.set(newContent.id, newContent)\r\n          this.updateAll()\r\n          connection.conference.sync.sendMyContents()\r\n        }else if (pid) {\r\n          connection.conference.sync.sendContentUpdateRequest(pid, [newContent])\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  //  removed by local user\r\n  removeByLocal(cid: string) {\r\n    if (config.bmRelayServer){\r\n      const toRemove = this.roomContents.get(cid)\r\n      if (toRemove){\r\n        this.disposeContent(toRemove)\r\n        this.roomContents.delete(cid)\r\n      }\r\n      connection.conference.sync.sendContentRemoveRequest('', [cid])\r\n      this.roomContentsInfo.delete(cid)\r\n      this.updateAll()\r\n    }else{\r\n      const {pid, pc, take} = this.getOrTakeContent(cid, 'removeByLocal')\r\n      //console.log(`remove by local pid:${pid} take;${take} cid:${cid}.`)\r\n      if (pc) {\r\n        if (take){\r\n          //  if take the content from pendToRemoves, remove from pendToRemove in remotes.\r\n          console.log(`sendLeftContentRemoveRequest of ${cid}.`)\r\n          connection.conference.sync.sendLeftContentRemoveRequest([cid])\r\n        }\r\n\r\n        //  remove the content\r\n        if (pid === this.localId) {\r\n          this.removeMyContent(cid)\r\n          connection.conference.sync.sendMyContents()\r\n        }else if (pid) {\r\n          if (participants.remote.has(pid)){\r\n            connection.conference.sync.sendContentRemoveRequest(pid, [cid])\r\n          }\r\n        }\r\n      } else if (pid && connection.conference.bmRelaySocket?.readyState === WebSocket.OPEN) {\r\n        //  remove participant remaining in relay server\r\n        if (!participants.remote.has(pid)){\r\n          //connection.conference.sendMessageViaRelay(MessageType.PARTICIPANT_LEFT, pid)\r\n          connection.conference.pushOrUpdateMessageViaRelay(MessageType.PARTICIPANT_LEFT, [pid])\r\n        }\r\n      }\r\n    }\r\n  }\r\n  //  request content by id which is not sent yet.\r\n  requestContent(cids: string[]){\r\n    if (config.bmRelayServer){\r\n      //connection.conference.sendMessageViaRelay(MessageType.CONTENT_UPDATE_REQUEST_BY_ID, cids)\r\n      connection.conference.pushOrUpdateMessageViaRelay(MessageType.CONTENT_UPDATE_REQUEST_BY_ID, cids)\r\n    }\r\n  }\r\n  //  Update request from remote.\r\n  updateByRemoteRequest(cs: ISharedContent[]) {\r\n    if (config.bmRelayServer){\r\n      for (const c of cs) {\r\n        this.roomContents.set(c.id, c)\r\n        if ((c.type === 'screen' || c.type === 'camera')) {\r\n          this.tracks.onUpdateContent(c)\r\n        }\r\n      }\r\n    }else{\r\n      const local = this.getParticipant(this.localId)\r\n      for (const c of cs) {\r\n        const pid = this.owner.get(c.id)\r\n        if (pid === this.localId) {\r\n          local.myContents.set(c.id, c)\r\n        }else {\r\n          console.error(`Update request of ${c.id} is for ${pid} and not for me.`)\r\n        }\r\n      }\r\n      connection.conference.sync.sendMyContents()\r\n    }\r\n    this.updateAll()\r\n  }\r\n  //  Remove request from remote.\r\n  removeByRemoteRequest(cids: string[]) {\r\n    if (config.bmRelayServer){\r\n      for (const cid of cids) {\r\n        const toRemove = this.roomContents.get(cid)\r\n        if (toRemove){\r\n          this.disposeContent(toRemove)\r\n          this.roomContents.delete(cid)\r\n        }\r\n        contents.roomContentsInfo.delete(cid)\r\n      }\r\n      this.updateAll()\r\n    }else{\r\n      for (const cid of cids){\r\n        const {pid, pc} = this.checkAndGetContent(cid, 'removeByRemoteRequest')\r\n        if (pc) {\r\n          if (pid === this.localId) {\r\n            this.removeMyContent(cid)\r\n          }else {\r\n            console.error('remote try to remove my content')\r\n          }\r\n        }\r\n      }\r\n      connection.conference.sync.sendMyContents()\r\n    }\r\n  }\r\n  removeLeftContentByRemoteRequest(cids: string[]) {\r\n    assert(!config.bmRelayServer)\r\n\r\n    for (const cid of cids){\r\n      const pid = this.owner.get(cid)\r\n      if (pid){\r\n        let pc = this.pendToRemoves.get(pid)\r\n        if (!pc) { pc = this.participants.get(pid) }\r\n        if (pc){\r\n          pc.myContents.delete(cid)\r\n          this.owner.delete(cid)\r\n          if (pc.myContents.size === 0){\r\n            this.participants.delete(pid)\r\n            this.pendToRemoves.delete(pid)\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n  //  remove my content\r\n  private removeMyContent(cid:string, pid?: string){\r\n    assert(!config.bmRelayServer)\r\n\r\n    if (!pid) { pid = this.localId }\r\n    const pc = this.getParticipant(pid)\r\n    const toRemove = pc.myContents.get(cid)\r\n    if (toRemove) {\r\n      this.disposeContent(toRemove)\r\n      pc.myContents.delete(cid)\r\n      this.owner.delete(cid)\r\n      this.updateAll()\r\n      if (pid === this.localId){\r\n        connection.conference.sync.sendMyContents()\r\n      }\r\n    }else {\r\n      console.log(`I don't have ${cid} to remove.`)\r\n    }\r\n  }\r\n\r\n  //  replace remote contents of an remote user by remote.\r\n  replaceRemoteContents(cs: ISharedContent[], pid:string) {\r\n    assert(!config.bmRelayServer)\r\n\r\n    if (pid === contents.localId) {\r\n      console.error('A remote tries to replace local contents.')\r\n    }\r\n    this.updateRemoteContents(cs, pid)\r\n    const participant = this.getParticipant(pid)\r\n    if (participant) {\r\n      const newContents = new Map(cs.map(c => [c.id, c]))\r\n      const remove = diffMap(participant.myContents, newContents)\r\n      this.removeRemoteContents(Array.from(remove.keys()), pid)\r\n    }\r\n  }\r\n\r\n  //  Update remote contents by remote.\r\n  private updateRemoteContents(cs: ISharedContent[], pid:string) {\r\n    assert(!config.bmRelayServer)\r\n\r\n    if (pid === contents.localId) {\r\n      console.error('A remote tries to updates local contents.')\r\n    }\r\n    cs.forEach((c) => {\r\n      this.pendToRemoves.forEach(pc => pc.myContents.delete(c.id))        //  check pendToRemoves\r\n\r\n      const remote = this.getParticipant(pid)\r\n      contentLog(`updateContents for participant:${pid}`)\r\n      contentDebug(` update ${c.id} by ${c}`)\r\n      contentDebug(' myContents=', JSON.stringify(remote?.myContents))\r\n\r\n      //  set owner\r\n      if (remote.myContents.has(c.id)) {\r\n        const owner = this.owner.get(c.id)\r\n        if (owner !== pid) {\r\n          console.error(`Owner not match for cid=${c.id} owner=${owner} pid=${pid}.`)\r\n        }\r\n      }else {\r\n        this.owner.set(c.id, pid)\r\n      }\r\n      //  set content\r\n      remote.myContents.set(c.id, c)\r\n      //  update track in cases of track based contents.\r\n      if (c.type === 'screen' || c.type === 'camera') {\r\n        this.tracks.onUpdateContent(c)\r\n      }\r\n    })\r\n    this.pendToRemoves.forEach(pc => {\r\n      if (pc.myContents.size === 0){ this.pendToRemoves.delete(pc.participantId) }\r\n    })\r\n    this.updateAll()\r\n  }\r\n  //  Remove remote contents by remote.\r\n  private removeRemoteContents(cids: string[], pid:string) {\r\n    assert(!config.bmRelayServer)\r\n\r\n    if (pid === contents.localId) {\r\n      console.error('Remote removes local contents.')\r\n    }\r\n    const pc = this.getParticipant(pid)\r\n    cids.forEach((cid) => {\r\n      const c = pc.myContents.get(cid)\r\n      if (c) {\r\n        this.disposeContent(c)\r\n        pc.myContents.delete(cid)\r\n        this.owner.delete(cid)\r\n      }else {\r\n        console.error(`removeByRemote: failed to find content cid=${cid}`)\r\n      }\r\n    })\r\n    this.updateAll()\r\n  }\r\n\r\n  //  If I'm the next, obtain the contents\r\n  onParticipantLeft(pidLeave:string) {\r\n    if (!config.bmRelayServer){\r\n\r\n      contentLog('onParticipantLeft called with pid = ', pidLeave)\r\n      const participantLeave = this.participants.get(pidLeave)\r\n      if (participantLeave) {\r\n        const allPids = Array.from(participantsStore.remote.keys())\r\n        allPids.push(this.localId)\r\n        allPids.sort()\r\n        const idx = allPids.findIndex(cur => cur > pidLeave)\r\n        const next = allPids[idx >= 0 ? idx : 0]\r\n        contentLog('next = ', next)\r\n        let updated = false\r\n        if (next === this.localId) {\r\n          contentLog('Next is me')\r\n          updated = this.takeContentsFromDead(participantLeave) || updated\r\n          contentLog('remove:', pidLeave, ' current:', JSON.stringify(allPids))\r\n          contentLog('local contents sz:', this.localParticipant.myContents.size,\r\n                     ' json:', JSON.stringify(Array.from(this.localParticipant.myContents.keys())))\r\n        } else {\r\n          contentLog('Next is remote')\r\n          this.pendToRemoveParticipant(participantLeave)\r\n        }\r\n        this.updateAll()\r\n        if (updated){\r\n          connection.conference.sync.sendMyContents()\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  private pendToRemoveParticipant(pc: ParticipantContents){\r\n    assert(!config.bmRelayServer)\r\n\r\n    const removes = Array.from(pc.myContents.values()).filter(c => c.type === 'camera' || c.type ==='screen')\r\n    removes.forEach(c => {\r\n      pc.myContents.delete(c.id)\r\n      this.owner.delete(c.id)\r\n    })\r\n    this.pendToRemoves.set(pc.participantId, pc)\r\n    this.participants.delete(pc.participantId)\r\n  }\r\n\r\n  clearAllRemotes(){\r\n    if (config.bmRelayServer){\r\n      this.roomContents.clear()\r\n    }else{\r\n      const remotes = Array.from(this.participants.keys()).filter(key => key !== this.localId)\r\n      remotes.forEach(pid=>this.participants.delete(pid))\r\n      this.tracks.clearConnection()\r\n    }\r\n  }\r\n\r\n  removeAllContents(){\r\n    if (config.bmRelayServer){\r\n      const cids = Array.from(this.roomContents.keys())\r\n      connection.conference.sync.sendContentRemoveRequest('', cids)\r\n      this.roomContents.clear()\r\n    }else{\r\n      this.participants.forEach((pc, pid) => {\r\n        if (pid !== this.localId){\r\n          const cs = Array.from(pc.myContents.values())\r\n          connection.conference.sync.sendContentRemoveRequest(pid, cs.map(c => c.id))\r\n        }\r\n      })\r\n      this.pendToRemoves.forEach(pc => {\r\n        const cs = Array.from(pc.myContents.values())\r\n        connection.conference.sync.sendLeftContentRemoveRequest(cs.map(c => c.id))\r\n      })\r\n      this.owner.clear()\r\n      this.participants.clear()\r\n      this.pendToRemoves.clear()\r\n      connection.conference.sync.sendMyContents()\r\n    }\r\n    this.updateAll()\r\n  }\r\n\r\n  // create a new unique content id\r\n  getUniqueId(): string {\r\n    const pid = participantsStore.localId\r\n    while (1) {\r\n      this.contentIdCounter += 1\r\n      const id = `${pid}_${this.contentIdCounter}`\r\n      if (config.bmRelayServer){\r\n        if (!this.roomContents.has(id)) { return id }\r\n      }else{\r\n        if (!this.owner.has(id)) { return id }\r\n      }\r\n    }\r\n\r\n    //  eslint-disable-next-line no-unreachable\r\n    return ''\r\n  }\r\n\r\n  disposeContent(c: ISharedContent) {\r\n    if (c.id === this.editing){\r\n      this.setEditing('')\r\n    }\r\n    if (c.type === 'screen' || c.type === 'camera') {\r\n      if (this.tracks.contentCarriers.has(c.id)){\r\n        this.tracks.clearLocalContent(c.id)\r\n      }else{\r\n        this.tracks.clearRemoteContent(c.id)\r\n      }\r\n    }\r\n  }\r\n\r\n  //  screen fps setting\r\n  @observable screenFps = 5\r\n  @action setScreenFps(fps: number){ this.screenFps = fps }\r\n}\r\n\r\nconst contents = new SharedContents()\r\ndeclare const d:any\r\nd.contents = contents\r\nexport default contents\r\n","/**\r\n * The audio type.\r\n */\r\nexport const AUDIO = 'audio';\r\n\r\n/**\r\n * The presenter type.\r\n */\r\nexport const PRESENTER = 'presenter';\r\n\r\n/**\r\n * The video type.\r\n */\r\nexport const VIDEO = 'video';\r\n","import BrowserCapabilities from './BrowserCapabilities';\r\n\r\nexport default new BrowserCapabilities();\r\n","import i18n, {TOptions} from 'i18next'\r\nimport i18nLanguageDetector from 'i18next-browser-languagedetector'\r\nimport {initReactI18next, useTranslation as useTrans} from 'react-i18next'\r\nimport {EnKeyList, enTranslate} from './en'\r\nimport {JaKeyList, jaTranslate} from './ja'\r\n\r\nexport type KeyList = EnKeyList & JaKeyList\r\nexport function t(key: KeyList, options?:string | TOptions) {\r\n  return i18n.t(key, options)\r\n}\r\nexport interface UseTranslationResponse{\r\n  t:(key: KeyList) => string\r\n  i18n: typeof i18n\r\n  ready: boolean\r\n}\r\nexport function useTranslation():UseTranslationResponse {\r\n  const res = useTrans()\r\n\r\n  return res as UseTranslationResponse\r\n}\r\n\r\nconst resources = {\r\n  en: {translation: enTranslate},\r\n  ja: {translation: jaTranslate},\r\n}\r\nexport const i18nSupportedLngs = Object.keys(resources)\r\nexport const i18nOptions = {\r\n  resources,\r\n  supportedLngs:i18nSupportedLngs,\r\n  fallbackLng: i18nSupportedLngs[0],\r\n  interpolation: {escapeValue: false},\r\n}\r\nexport function i18nInit() {\r\n  return i18n.use(initReactI18next).use(i18nLanguageDetector).init(i18nOptions)\r\n}\r\n","export const enTranslate = {\r\n  enAbout: 'A video chat with a 2D map, where you will hear others\\' voices based on the location.'\r\n    + ' It holds multiple conversations in a venue parallelly, and you may walk around between them.'\r\n    + ' Sharing screens, cameras, texts, images, YouTube, and documents on google drive are supported.'\r\n    + ' You may drop or paste on the map.',\r\n  enTopPageUrl: '',\r\n  enMoreInfo: '',\r\n  YourName: 'Your name',\r\n  Venue: 'Lobby',\r\n  EnterTheVenue: 'Enter the lobby',\r\n  Contents: 'Contents',\r\n  'Create and Share': 'Create and Share',\r\n  'Share Text':'Share Text',\r\n  'Share iframe':'Share web page (Can\\'t display many sites)',\r\n  'Share image':'Share image',\r\n  'Share zone image':'Share zone image',\r\n  'Select video camera to share':'Select video camera to share',\r\n  shareImport: '_Import shared items from file',\r\n  shareDownload: '_Download shared items as a file',\r\n  shareIframe: 'I_frame',\r\n  shareText: '_Text (can paste directly)',\r\n  shareImage: 'Ima_ge (can paste directly)',\r\n  shareZoneImage: 'Zone Ima_ge (can paste directly)',\r\n  shareWhiteboard: '_Whiteboard',\r\n  shareCamera: '_Camera',\r\n  shareScreenBackground:'Screen as the _background',\r\n  stopScreenBackground:'Stop _background screen',\r\n  shareScreenContent:'_Screen',\r\n  stopScreen:'C_lose all screen and camera windows',\r\n  frameRateSetting: 'Frame rate:',\r\n  fps: 'fps',\r\n  shareMouse:'_Mouse cursor',\r\n  stopMouse: 'Stop sharing _Mouse cursor',\r\n  ttCreateAndshare: '_Create and share',\r\n  ttMicMute: '_Mic mute',\r\n  headphoneL1Chrome: 'Stereo headphone (Caution: no echo cancel)',\r\n  headphoneL1: 'Stereo headphone',\r\n  headphoneL2: 'Monaural speaker',\r\n  etConnection: 'No connection',\r\n  emConnection: 'Please check internet connection. EarShot Chat uses https. If internet is OK, the server may have problems.',\r\n  etMicPermission: 'No permission to use microphone',\r\n  emMicPermission: 'Your browser does not permit to use microphone. Please give me the permission and reload your browser.',\r\n  etNoMic: 'No microphone',\r\n  emNoMic: 'Please check if your PC has a microphone. EarShot Chat requires it.',\r\n  emClose: 'Close',\r\n  emNeverShow: 'Never show this in this session',\r\n  etNoChannel: 'No data channel',\r\n  emNoChannel: 'Please check firewall setting. EarShot Chat connect to https (port 443/TCP) and port 8801-8810/UDP or 80/TCP.',\r\n//  etRetry: 'Reconnecting',\r\n//  emRetry: 'The connection had been cut off and trying to reconnect. Please check internet connection.',\r\n  etRetry: 'Please reload',\r\n  emRetry: 'The connection had been cut off once. Please click the reload button of the browser.',\r\n  imageDropzoneText:'Drag and drop images here or click',\r\n  lsTitle:'Avatar and notification setting',\r\n  lsName: 'Name',\r\n  lsColor: 'Color',\r\n  lsColorAvatar:'Avatar',\r\n  lsColorText:'Text',\r\n  lsAutoColor:'Auto',\r\n  lsImage: 'Avatar image',\r\n  lsEmail: 'Input email to use Gravatar\\'s image',\r\n  lsImageFile: 'Upload file to use image file',\r\n  btSave: 'Save and close',\r\n  btCancel: 'Cancel change',\r\n  lsNotifyCall: 'Called',\r\n  lsNotifyTouch: 'Touched',\r\n  lsNotifyNear: 'Approached',\r\n  lsNotifyYarn: 'Yarn phone',\r\n  rsCall: 'Call',\r\n  lsNotification: 'Notification',\r\n  rsConnectYarnPhone: 'Connect yarn phone',\r\n  rsCutYarnPhone: 'Disconnect yarn phone',\r\n  rsChatTo: 'Send chat only to {{name}}',\r\n  ctPin: 'Lock position and size',\r\n  ctUnpin: 'Unlock position and size',\r\n  ctProximity: 'Lock sound proximity',\r\n  ctUnProximity: 'Unlock sound proximity',\r\n  ctEdit: 'Start editing (No view sync)',\r\n  ctEndEdit: 'End editing (Sync view)',\r\n  ctEditIframe: 'Browse page (No sync)',\r\n  ctEndEditIframe: 'End browse (No sync)',\r\n  ctEditText: 'Edit (No scroll sync)',\r\n  ctEndEditText: 'End edit (Sync scroll)',\r\n  ctEditWhiteboard: 'Edit (No scroll sync)',\r\n  ctEndEditWhiteboard: 'End edit (No scroll sync)',\r\n  ctEditGDrive: 'Edit/Update (No scroll sync)',\r\n  ctEndEditGDrive: 'End edit (No auto-update)',\r\n  ctEndEditYoutube: 'Sync play pos',\r\n  ctEditYoutube: 'No sync',\r\n  ctMoveTop: 'Move to the top',\r\n  ctMoveBottom: 'Move to the bottom',\r\n  ctWallpaper: 'Make this wallpaper',\r\n  ctUnWallpaper: 'Remove this from wallpaper',\r\n  ctCopyToClipboard: 'Copy to clipboard',\r\n  ctDelete: 'Delete',\r\n  ctClose: 'Close',\r\n  ctName: 'Titile',\r\n  ctFocus: 'Show it in the center',\r\n  ctFrameVisible: 'Normal frame',\r\n  ctFrameInvisible: 'Invisible frame',\r\n  ctOpaque: 'Opaque',\r\n  ctTransparent: 'Transparent',\r\n  upload: 'Upload',\r\n  Save: 'Save',\r\n  Clear: 'Clear',\r\n  Cancel: 'Cancel',\r\n  broadcastMyVoice: 'Broadcast my voice',\r\n  soundLocalizationBasedOn: 'Sound localization based on',\r\n  slAvatar: 'Avatar (avatar\\'s direction)',\r\n  slUser: 'User (top is front)',\r\n  usage: 'How to use',\r\n  cmJoined: '{{name}} joined.',\r\n  cmLeft: '{{name}} Left.',\r\n  cmNameChanged: '{{old}} changed its name to {{new}}.',\r\n  cmCallBy: '{{name}} called you.',\r\n  cmCallTo: 'You called {{name}}.',\r\n  cmToAll: 'To all',\r\n  cmToName: 'To {{name}}',\r\n  cmSend: 'Send (CTRL+Enter)',\r\n  cmPrivateFrom: 'Private from {{name}}',\r\n  cmPrivateTo: 'Private to {{name}}',\r\n  noCalled: '{{name}} called you.',\r\n  noTouched: '{{name}} touched you.',\r\n  noNear: '{{name}} approached you.',\r\n  noYarn: '{{name}} connected yarn.',\r\n  afkTitle: 'In away from keyboard mode (L / Esc)',\r\n  afkMessage: 'Hit any key or click mouse to return.',\r\n  gdFailed: 'The file in Google Drive could not be accessed.\\r\\nChange the file-sharing settings so that everyone on the Internet can see it.',\r\n  videoLimit: 'Limit on the number of video streams',\r\n  audioLimit: 'Limit on the number of audio streams',\r\n}\r\nexport type EnKeyList = keyof typeof enTranslate\r\n","export const jaTranslate = {\r\n  enAbout: '2D'\r\n  + ''\r\n  + 'YouTubeGoogleURL/',\r\n  enTopPageUrl: '',\r\n  enMoreInfo: '',\r\n  YourName: '',\r\n  Venue: '',\r\n  EnterTheVenue: '',\r\n  Contents: '',\r\n  'Create and Share': ' (c)',\r\n  'Share Text':'',\r\n  'Share iframe':'Web()',\r\n  'Share image':'',\r\n  'Share zone image':'',\r\n  'Select video camera to share':'',\r\n  shareImport: ' (_i)',\r\n  shareDownload: ' (_d)',\r\n  shareIframe: 'Web (_f)',\r\n  shareText: ' (_t / )',\r\n  shareImage: ' (_g / )',\r\n  shareZoneImage: ' (_g / )',\r\n  shareWhiteboard: ' (_w)',\r\n  shareCamera: ' (_c)',\r\n  shareScreenBackground:' (_b)',\r\n  stopScreenBackground:' (_b)',\r\n  shareScreenContent:' (_s)',\r\n  stopScreen:' (_l)',\r\n  shareMouse:' (_m)',\r\n  fps: 'fps',\r\n  ttCreateAndshare: ' (_c)',\r\n  stopMouse: ' (_m)',\r\n  frameRateSetting: '',\r\n  ttMicMute: ' (_m)',\r\n  headphoneL1Chrome: ' ( / :)',\r\n  headphoneL1: ' ()',\r\n  headphoneL2: ' ()',\r\n  etConnection: '',\r\n  emConnection: 'EarShot Chat https ',\r\n  etMicPermission: '',\r\n  emMicPermission: 'URL',\r\n  etNoMic: '',\r\n  emNoMic: 'EarShot Chat',\r\n  emClose: '',\r\n  emNeverShow: '',\r\n  etNoChannel: '',\r\n  emNoChannel: 'EarShot Chat  https(443)8801-881080',\r\n//  etRetry: '',\r\n//  emRetry: '',\r\n  etRetry: '',\r\n  emRetry: '()',\r\n  imageDropzoneText:'',\r\n  lsTitle:'',\r\n  lsColor:'',\r\n  lsColorAvatar:'',\r\n  lsColorText:'',\r\n  lsAutoColor:'',\r\n  lsName: '',\r\n  lsImage: '',\r\n  lsEmail: 'GravatarEmail',\r\n  lsImageFile: '',\r\n  btSave: '',\r\n  btCancel: '  ',\r\n  lsNotification: '',\r\n  lsNotifyCall: '',\r\n  lsNotifyTouch: '',\r\n  lsNotifyNear: '',\r\n  lsNotifyYarn: '',\r\n  rsCall: '',\r\n  rsConnectYarnPhone: '',\r\n  rsCutYarnPhone: '',\r\n  rsChatTo: '{{name}}',\r\n  ctPin: '/',\r\n  ctUnpin: '/',\r\n  ctProximity: '/',\r\n  ctUnProximity: '/',\r\n  ctEditIframe: ' ()',\r\n  ctEndEditIframe: ' ()',\r\n  ctEditText: ' ()',\r\n  ctEndEditText: ' ()',\r\n  ctEditWhiteboard: ' ()',\r\n  ctEndEditWhiteboard: ' ()',\r\n  ctEditGDrive: ' ()',\r\n  ctEndEditGDrive: ' ()',\r\n  ctEndEditYoutube: '',\r\n  ctEditYoutube: '',\r\n  ctMoveTop: '',\r\n  ctMoveBottom: '',\r\n  ctWallpaper: '',\r\n  ctUnWallpaper: '',\r\n  ctCopyToClipboard: '',\r\n  ctFocus: '',\r\n  ctDelete: '',\r\n  ctClose: '',\r\n  ctName: '',\r\n  ctFrameVisible: '',\r\n  ctFrameInvisible: '',\r\n  ctOpaque: '',\r\n  ctTransparent: '',\r\n  upload: '',\r\n  Save: '',\r\n  Clear: '',\r\n  Cancel: '',\r\n  broadcastMyVoice: '',\r\n  soundLocalizationBasedOn: '',\r\n  slAvatar: '',\r\n  slUser: '()',\r\n  usage: '',\r\n  cmJoined: '{{name}}',\r\n  cmLeft: '{{name}}',\r\n  cmNameChanged: '{{old}}  {{new}} ',\r\n  cmCallBy: '{{name}}',\r\n  cmCallTo: '{{name}}',\r\n  cmToAll: '',\r\n  cmToName: '{{name}}',\r\n  cmSend: ' (CTRL+Enter)',\r\n  cmPrivateFrom: '{{name}}',\r\n  cmPrivateTo: '{{name}}',\r\n  noCalled: '{{name}}',\r\n  noTouched: '{{name}}',\r\n  noNear: '{{name}}',\r\n  noYarn: '{{name}}',\r\n  afkTitle: ' (L / Esc)',\r\n  afkMessage: '',\r\n  gdFailed: 'Google Drive\\r\\n',\r\n  videoLimit: '',\r\n  audioLimit: '',\r\n}\r\nexport type JaKeyList = keyof typeof jaTranslate\r\n","import EventEmitter from 'events';\r\n\r\nimport * as JitsiConferenceEvents from '../../JitsiConferenceEvents';\r\nimport JitsiTrackError from '../../JitsiTrackError';\r\nimport { FEEDBACK } from '../../service/statistics/AnalyticsEvents';\r\nimport * as StatisticsEvents from '../../service/statistics/Events';\r\nimport browser from '../browser';\r\nimport ScriptUtil from '../util/ScriptUtil';\r\n\r\nimport analytics from './AnalyticsAdapter';\r\nimport CallStats from './CallStats';\r\nimport LocalStats from './LocalStatsCollector';\r\nimport { PerformanceObserverStats } from './PerformanceObserverStats';\r\nimport RTPStats from './RTPStatsCollector';\r\nimport { CALLSTATS_SCRIPT_URL } from './constants';\r\n\r\nconst logger = require('jitsi-meet-logger').getLogger(__filename);\r\n\r\n/**\r\n * Stores all active {@link Statistics} instances.\r\n * @type {Set<Statistics>}\r\n */\r\nlet _instances;\r\n\r\n/**\r\n * True if callstats API is loaded\r\n */\r\nlet isCallstatsLoaded = false;\r\n\r\n/**\r\n * Since callstats.io is a third party, we cannot guarantee the quality of their\r\n * service. More specifically, their server may take noticeably long time to\r\n * respond. Consequently, it is in our best interest (in the sense that the\r\n * intergration of callstats.io is pretty important to us but not enough to\r\n * allow it to prevent people from joining a conference) to (1) start\r\n * downloading their API as soon as possible and (2) do the downloading\r\n * asynchronously.\r\n *\r\n * @param {StatisticsOptions} options - Options to use for downloading and\r\n * initializing callstats backend.\r\n */\r\nfunction loadCallStatsAPI(options) {\r\n    if (!isCallstatsLoaded) {\r\n        ScriptUtil.loadScript(\r\n            options.customScriptUrl || CALLSTATS_SCRIPT_URL,\r\n            /* async */ true,\r\n            /* prepend */ true,\r\n            /* relativeURL */ undefined,\r\n            /* loadCallback */ () => _initCallStatsBackend(options)\r\n        );\r\n        isCallstatsLoaded = true;\r\n    }\r\n}\r\n\r\n/**\r\n * Initializes Callstats backend.\r\n *\r\n * @param {StatisticsOptions} options - The options to use for initializing\r\n * callstats backend.\r\n * @private\r\n */\r\nfunction _initCallStatsBackend(options) {\r\n    if (CallStats.isBackendInitialized()) {\r\n        return;\r\n    }\r\n\r\n    if (!CallStats.initBackend({\r\n        callStatsID: options.callStatsID,\r\n        callStatsSecret: options.callStatsSecret,\r\n        userName: options.userName,\r\n        aliasName: options.aliasName,\r\n        applicationName: options.applicationName,\r\n        getWiFiStatsMethod: options.getWiFiStatsMethod,\r\n        confID: options.confID,\r\n        siteID: options.siteID\r\n    })) {\r\n        logger.error('CallStats Backend initialization failed bad');\r\n    }\r\n}\r\n\r\n/**\r\n * callstats strips any additional fields from Error except for \"name\", \"stack\",\r\n * \"message\" and \"constraintName\". So we need to bundle additional information\r\n * from JitsiTrackError into error passed to callstats to preserve valuable\r\n * information about error.\r\n * @param {JitsiTrackError} error\r\n */\r\nfunction formatJitsiTrackErrorForCallStats(error) {\r\n    const err = new Error();\r\n\r\n    // Just copy original stack from error\r\n    err.stack = error.stack;\r\n\r\n    // Combine name from error's name plus (possibly) name of original GUM error\r\n    err.name = (error.name || 'Unknown error') + (error.gum && error.gum.error\r\n        && error.gum.error.name ? ` - ${error.gum.error.name}` : '');\r\n\r\n    // Put all constraints into this field. For constraint failed errors we will\r\n    // still know which exactly constraint failed as it will be a part of\r\n    // message.\r\n    err.constraintName = error.gum && error.gum.constraints\r\n        ? JSON.stringify(error.gum.constraints) : '';\r\n\r\n    // Just copy error's message.\r\n    err.message = error.message;\r\n\r\n    return err;\r\n}\r\n\r\n/**\r\n * Init statistic options\r\n * @param options\r\n */\r\nStatistics.init = function(options) {\r\n    Statistics.audioLevelsEnabled = !options.disableAudioLevels;\r\n    if (typeof options.pcStatsInterval === 'number') {\r\n        Statistics.pcStatsInterval = options.pcStatsInterval;\r\n    }\r\n\r\n    if (typeof options.audioLevelsInterval === 'number') {\r\n        Statistics.audioLevelsInterval = options.audioLevelsInterval;\r\n    }\r\n\r\n    if (typeof options.longTasksStatsInterval === 'number') {\r\n        Statistics.longTasksStatsInterval = options.longTasksStatsInterval;\r\n    }\r\n\r\n    Statistics.disableThirdPartyRequests = options.disableThirdPartyRequests;\r\n};\r\n\r\n/**\r\n * The options to configure Statistics.\r\n * @typedef {Object} StatisticsOptions\r\n * @property {string} applicationName - The application name to pass to\r\n * callstats.\r\n * @property {string} aliasName - The alias name to use when initializing callstats.\r\n * @property {string} userName - The user name to use when initializing callstats.\r\n * @property {string} confID - The callstats conference ID to use.\r\n * @property {string} callStatsID - Callstats credentials - the id.\r\n * @property {string} callStatsSecret - Callstats credentials - the secret.\r\n * @property {string} customScriptUrl - A custom lib url to use when downloading\r\n * callstats library.\r\n * @property {string} roomName - The room name we are currently in.\r\n */\r\n/**\r\n *\r\n * @param xmpp\r\n * @param {StatisticsOptions} options - The options to use creating the\r\n * Statistics.\r\n */\r\nexport default function Statistics(xmpp, options) {\r\n    /**\r\n     * {@link RTPStats} mapped by {@link TraceablePeerConnection.id} which\r\n     * collect RTP statistics for each peerconnection.\r\n     * @type {Map<string, RTPStats}\r\n     */\r\n    this.rtpStatsMap = new Map();\r\n    this.eventEmitter = new EventEmitter();\r\n    this.xmpp = xmpp;\r\n    this.options = options || {};\r\n\r\n    this.callStatsIntegrationEnabled\r\n        = this.options.callStatsID && this.options.callStatsSecret && this.options.enableCallStats\r\n\r\n            // Even though AppID and AppSecret may be specified, the integration\r\n            // of callstats.io may be disabled because of globally-disallowed\r\n            // requests to any third parties.\r\n            && (Statistics.disableThirdPartyRequests !== true);\r\n    if (this.callStatsIntegrationEnabled) {\r\n        this.callStatsApplicationLogsDisabled\r\n            = this.options.callStatsApplicationLogsDisabled;\r\n        if (browser.isReactNative()) {\r\n            _initCallStatsBackend(this.options);\r\n        } else {\r\n            loadCallStatsAPI(this.options);\r\n        }\r\n\r\n        if (!this.options.confID) {\r\n            logger.warn('\"confID\" is not defined');\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Stores {@link CallStats} instances for each\r\n     * {@link TraceablePeerConnection} (one {@link CallStats} instance serves\r\n     * one TPC). The instances are mapped by {@link TraceablePeerConnection.id}.\r\n     * @type {Map<number, CallStats>}\r\n     */\r\n    this.callsStatsInstances = new Map();\r\n\r\n    Statistics.instances.add(this);\r\n}\r\nStatistics.audioLevelsEnabled = false;\r\nStatistics.audioLevelsInterval = 200;\r\nStatistics.pcStatsInterval = 10000;\r\nStatistics.disableThirdPartyRequests = false;\r\nStatistics.analytics = analytics;\r\n\r\nObject.defineProperty(Statistics, 'instances', {\r\n    /**\r\n     * Returns the Set holding all active {@link Statistics} instances. Lazily\r\n     * initializes the Set to allow any Set polyfills to be applied.\r\n     * @type {Set<Statistics>}\r\n     */\r\n    get() {\r\n        if (!_instances) {\r\n            _instances = new Set();\r\n        }\r\n\r\n        return _instances;\r\n    }\r\n});\r\n\r\n/**\r\n * Starts collecting RTP stats for given peerconnection.\r\n * @param {TraceablePeerConnection} peerconnection\r\n */\r\nStatistics.prototype.startRemoteStats = function(peerconnection) {\r\n    this.stopRemoteStats(peerconnection);\r\n\r\n    try {\r\n        const rtpStats\r\n            = new RTPStats(\r\n                peerconnection,\r\n                Statistics.audioLevelsInterval,\r\n                Statistics.pcStatsInterval,\r\n                this.eventEmitter);\r\n\r\n        rtpStats.start(Statistics.audioLevelsEnabled);\r\n        this.rtpStatsMap.set(peerconnection.id, rtpStats);\r\n    } catch (e) {\r\n        logger.error(`Failed to start collecting remote statistics: ${e}`);\r\n    }\r\n};\r\n\r\nStatistics.localStats = [];\r\n\r\nStatistics.startLocalStats = function(stream, callback) {\r\n    if (!Statistics.audioLevelsEnabled) {\r\n        return;\r\n    }\r\n    const localStats = new LocalStats(stream, Statistics.audioLevelsInterval,\r\n        callback);\r\n\r\n    this.localStats.push(localStats);\r\n    localStats.start();\r\n};\r\n\r\nStatistics.prototype.addAudioLevelListener = function(listener) {\r\n    if (!Statistics.audioLevelsEnabled) {\r\n        return;\r\n    }\r\n    this.eventEmitter.on(StatisticsEvents.AUDIO_LEVEL, listener);\r\n};\r\n\r\nStatistics.prototype.removeAudioLevelListener = function(listener) {\r\n    if (!Statistics.audioLevelsEnabled) {\r\n        return;\r\n    }\r\n    this.eventEmitter.removeListener(StatisticsEvents.AUDIO_LEVEL, listener);\r\n};\r\n\r\nStatistics.prototype.addBeforeDisposedListener = function(listener) {\r\n    this.eventEmitter.on(StatisticsEvents.BEFORE_DISPOSED, listener);\r\n};\r\n\r\nStatistics.prototype.removeBeforeDisposedListener = function(listener) {\r\n    this.eventEmitter.removeListener(\r\n        StatisticsEvents.BEFORE_DISPOSED, listener);\r\n};\r\n\r\nStatistics.prototype.addConnectionStatsListener = function(listener) {\r\n    this.eventEmitter.on(StatisticsEvents.CONNECTION_STATS, listener);\r\n};\r\n\r\nStatistics.prototype.removeConnectionStatsListener = function(listener) {\r\n    this.eventEmitter.removeListener(\r\n        StatisticsEvents.CONNECTION_STATS,\r\n        listener);\r\n};\r\n\r\nStatistics.prototype.addByteSentStatsListener = function(listener) {\r\n    this.eventEmitter.on(StatisticsEvents.BYTE_SENT_STATS, listener);\r\n};\r\n\r\nStatistics.prototype.removeByteSentStatsListener = function(listener) {\r\n    this.eventEmitter.removeListener(StatisticsEvents.BYTE_SENT_STATS,\r\n        listener);\r\n};\r\n\r\n/**\r\n * Add a listener that would be notified on a LONG_TASKS_STATS event.\r\n *\r\n * @param {Function} listener a function that would be called when notified.\r\n * @returns {void}\r\n */\r\nStatistics.prototype.addLongTasksStatsListener = function(listener) {\r\n    this.eventEmitter.on(StatisticsEvents.LONG_TASKS_STATS, listener);\r\n};\r\n\r\n/**\r\n * Creates an instance of {@link PerformanceObserverStats} and starts the\r\n * observer that records the stats periodically.\r\n *\r\n * @returns {void}\r\n */\r\nStatistics.prototype.attachLongTasksStats = function(conference) {\r\n    if (!browser.supportsPerformanceObserver()) {\r\n        logger.warn('Performance observer for long tasks not supported by browser!');\r\n\r\n        return;\r\n    }\r\n\r\n    this.performanceObserverStats = new PerformanceObserverStats(\r\n        this.eventEmitter,\r\n        Statistics.longTasksStatsInterval);\r\n\r\n    conference.on(\r\n        JitsiConferenceEvents.CONFERENCE_JOINED,\r\n        () => this.performanceObserverStats.startObserver());\r\n    conference.on(\r\n        JitsiConferenceEvents.CONFERENCE_LEFT,\r\n        () => this.performanceObserverStats.stopObserver());\r\n};\r\n\r\n/**\r\n * Obtains the current value of the LongTasks event statistics.\r\n *\r\n * @returns {Object|null} stats object if the observer has been\r\n * created, null otherwise.\r\n */\r\nStatistics.prototype.getLongTasksStats = function() {\r\n    return this.performanceObserverStats\r\n        ? this.performanceObserverStats.getLongTasksStats()\r\n        : null;\r\n};\r\n\r\n/**\r\n * Removes the given listener for the LONG_TASKS_STATS event.\r\n *\r\n * @param {Function} listener the listener we want to remove.\r\n * @returns {void}\r\n */\r\nStatistics.prototype.removeLongTasksStatsListener = function(listener) {\r\n    this.eventEmitter.removeListener(StatisticsEvents.LONG_TASKS_STATS, listener);\r\n};\r\n\r\n/**\r\n * Updates the list of speakers for which the audio levels are to be calculated. This is needed for the jvb pc only.\r\n *\r\n * @param {Array<string>} speakerList The list of remote endpoint ids.\r\n * @returns {void}\r\n */\r\nStatistics.prototype.setSpeakerList = function(speakerList) {\r\n    for (const rtpStats of Array.from(this.rtpStatsMap.values())) {\r\n        if (!rtpStats.peerconnection.isP2P) {\r\n            rtpStats.setSpeakerList(speakerList);\r\n        }\r\n    }\r\n};\r\n\r\nStatistics.prototype.dispose = function() {\r\n    try {\r\n        // NOTE Before reading this please see the comment in stopCallStats...\r\n        //\r\n        // Here we prevent from emitting the event twice in case it will be\r\n        // triggered from stopCallStats.\r\n        // If the event is triggered from here it means that the logs will not\r\n        // be submitted anyway (because there is no CallStats instance), but\r\n        // we're doing that for the sake of some kind of consistency.\r\n        if (!this.callsStatsInstances.size) {\r\n            this.eventEmitter.emit(StatisticsEvents.BEFORE_DISPOSED);\r\n        }\r\n        for (const callStats of this.callsStatsInstances.values()) {\r\n            this.stopCallStats(callStats.tpc);\r\n        }\r\n        for (const tpcId of this.rtpStatsMap.keys()) {\r\n            this._stopRemoteStats(tpcId);\r\n        }\r\n        if (this.eventEmitter) {\r\n            this.eventEmitter.removeAllListeners();\r\n        }\r\n    } finally {\r\n        Statistics.instances.delete(this);\r\n    }\r\n};\r\n\r\nStatistics.stopLocalStats = function(stream) {\r\n    if (!Statistics.audioLevelsEnabled) {\r\n        return;\r\n    }\r\n\r\n    for (let i = 0; i < Statistics.localStats.length; i++) {\r\n        if (Statistics.localStats[i].stream === stream) {\r\n            const localStats = Statistics.localStats.splice(i, 1);\r\n\r\n            localStats[0].stop();\r\n            break;\r\n        }\r\n    }\r\n};\r\n\r\n/**\r\n * Stops remote RTP stats for given peerconnection ID.\r\n * @param {string} tpcId {@link TraceablePeerConnection.id}\r\n * @private\r\n */\r\nStatistics.prototype._stopRemoteStats = function(tpcId) {\r\n    const rtpStats = this.rtpStatsMap.get(tpcId);\r\n\r\n    if (rtpStats) {\r\n        rtpStats.stop();\r\n        this.rtpStatsMap.delete(tpcId);\r\n    }\r\n};\r\n\r\n/**\r\n * Stops collecting RTP stats for given peerconnection\r\n * @param {TraceablePeerConnection} tpc\r\n */\r\nStatistics.prototype.stopRemoteStats = function(tpc) {\r\n    this._stopRemoteStats(tpc.id);\r\n};\r\n\r\n// CALSTATS METHODS\r\n\r\n/**\r\n * Initializes the callstats.io API.\r\n * @param {TraceablePeerConnection} tpc the {@link TraceablePeerConnection}\r\n * instance for which CalStats will be started.\r\n * @param {string} remoteUserID\r\n */\r\nStatistics.prototype.startCallStats = function(tpc, remoteUserID) {\r\n    if (!this.callStatsIntegrationEnabled) {\r\n        return;\r\n    } else if (this.callsStatsInstances.has(tpc.id)) {\r\n        logger.error('CallStats instance for ${tpc} exists already');\r\n\r\n        return;\r\n    }\r\n\r\n    logger.info(`Starting CallStats for ${tpc}...`);\r\n\r\n    const newInstance\r\n        = new CallStats(\r\n            tpc,\r\n            {\r\n                confID: this.options.confID,\r\n                remoteUserID\r\n            });\r\n\r\n    this.callsStatsInstances.set(tpc.id, newInstance);\r\n};\r\n\r\n/**\r\n * Obtains the list of *all* {@link CallStats} instances collected from every\r\n * valid {@link Statistics} instance.\r\n * @return {Set<CallStats>}\r\n * @private\r\n */\r\nStatistics._getAllCallStatsInstances = function() {\r\n    const csInstances = new Set();\r\n\r\n    for (const statistics of Statistics.instances) {\r\n        for (const cs of statistics.callsStatsInstances.values()) {\r\n            csInstances.add(cs);\r\n        }\r\n    }\r\n\r\n    return csInstances;\r\n};\r\n\r\n/**\r\n * Removes the callstats.io instances.\r\n */\r\nStatistics.prototype.stopCallStats = function(tpc) {\r\n    const callStatsInstance = this.callsStatsInstances.get(tpc.id);\r\n\r\n    if (callStatsInstance) {\r\n        // FIXME the original purpose of adding BEFORE_DISPOSED event was to be\r\n        // able to submit the last log batch from jitsi-meet to CallStats. After\r\n        // recent changes we dispose the CallStats earlier\r\n        // (before Statistics.dispose), so we need to emit this event here to\r\n        // give this last chance for final log batch submission.\r\n        //\r\n        // Eventually there should be a separate module called \"log storage\"\r\n        // which should emit proper events when it's underlying\r\n        // CallStats instance is going away.\r\n        if (this.callsStatsInstances.size === 1) {\r\n            this.eventEmitter.emit(StatisticsEvents.BEFORE_DISPOSED);\r\n        }\r\n        this.callsStatsInstances.delete(tpc.id);\r\n\r\n        // The fabric needs to be terminated when being stopped\r\n        callStatsInstance.sendTerminateEvent();\r\n    }\r\n};\r\n\r\n/**\r\n * Returns true if the callstats integration is enabled, otherwise returns\r\n * false.\r\n *\r\n * @returns true if the callstats integration is enabled, otherwise returns\r\n * false.\r\n */\r\nStatistics.prototype.isCallstatsEnabled = function() {\r\n    return this.callStatsIntegrationEnabled;\r\n};\r\n\r\n/**\r\n * Logs either resume or hold event for the given peer connection.\r\n * @param {TraceablePeerConnection} tpc the connection for which event will be\r\n * reported\r\n * @param {boolean} isResume true for resume or false for hold\r\n */\r\nStatistics.prototype.sendConnectionResumeOrHoldEvent = function(tpc, isResume) {\r\n    const instance = this.callsStatsInstances.get(tpc.id);\r\n\r\n    if (instance) {\r\n        instance.sendResumeOrHoldEvent(isResume);\r\n    }\r\n};\r\n\r\n/**\r\n * Notifies CallStats and analytics (if present) for ice connection failed\r\n * @param {TraceablePeerConnection} tpc connection on which failure occurred.\r\n */\r\nStatistics.prototype.sendIceConnectionFailedEvent = function(tpc) {\r\n    const instance = this.callsStatsInstances.get(tpc.id);\r\n\r\n    if (instance) {\r\n        instance.sendIceConnectionFailedEvent();\r\n    }\r\n};\r\n\r\n/**\r\n * Notifies CallStats for mute events\r\n * @param {TraceablePeerConnection} tpc connection on which failure occurred.\r\n * @param {boolean} muted true for muted and false for not muted\r\n * @param {String} type \"audio\"/\"video\"\r\n */\r\nStatistics.prototype.sendMuteEvent = function(tpc, muted, type) {\r\n    const instance = tpc && this.callsStatsInstances.get(tpc.id);\r\n\r\n    CallStats.sendMuteEvent(muted, type, instance);\r\n};\r\n\r\n/**\r\n * Notifies CallStats for screen sharing events\r\n * @param start {boolean} true for starting screen sharing and\r\n * false for not stopping\r\n * @param {string|null} ssrc - optional ssrc value, used only when\r\n * starting screen sharing.\r\n */\r\nStatistics.prototype.sendScreenSharingEvent\r\n    = function(start, ssrc) {\r\n        for (const cs of this.callsStatsInstances.values()) {\r\n            cs.sendScreenSharingEvent(start, ssrc);\r\n        }\r\n    };\r\n\r\n/**\r\n * Notifies the statistics module that we are now the dominant speaker of the\r\n * conference.\r\n * @param {String} roomJid - The room jid where the speaker event occurred.\r\n */\r\nStatistics.prototype.sendDominantSpeakerEvent = function(roomJid) {\r\n    for (const cs of this.callsStatsInstances.values()) {\r\n        cs.sendDominantSpeakerEvent();\r\n    }\r\n\r\n    // xmpp send dominant speaker event\r\n    this.xmpp.sendDominantSpeakerEvent(roomJid);\r\n};\r\n\r\n/**\r\n * Notifies about active device.\r\n * @param {{deviceList: {String:String}}} devicesData - list of devices with\r\n *      their data\r\n */\r\nStatistics.sendActiveDeviceListEvent = function(devicesData) {\r\n    const globalSet = Statistics._getAllCallStatsInstances();\r\n\r\n    if (globalSet.size) {\r\n        for (const cs of globalSet) {\r\n            CallStats.sendActiveDeviceListEvent(devicesData, cs);\r\n        }\r\n    } else {\r\n        CallStats.sendActiveDeviceListEvent(devicesData, null);\r\n    }\r\n};\r\n\r\n/* eslint-disable max-params */\r\n\r\n/**\r\n * Lets the underlying statistics module know where is given SSRC rendered by\r\n * providing renderer tag ID.\r\n * @param {TraceablePeerConnection} tpc the connection to which the stream\r\n * belongs to\r\n * @param {number} ssrc the SSRC of the stream\r\n * @param {boolean} isLocal\r\n * @param {string} userId\r\n * @param {string} usageLabel  meaningful usage label of this stream like\r\n *        'microphone', 'camera' or 'screen'.\r\n * @param {string} containerId the id of media 'audio' or 'video' tag which\r\n *        renders the stream.\r\n */\r\nStatistics.prototype.associateStreamWithVideoTag = function(\r\n        tpc,\r\n        ssrc,\r\n        isLocal,\r\n        userId,\r\n        usageLabel,\r\n        containerId) {\r\n    const instance = this.callsStatsInstances.get(tpc.id);\r\n\r\n    if (instance) {\r\n        instance.associateStreamWithVideoTag(\r\n            ssrc,\r\n            isLocal,\r\n            userId,\r\n            usageLabel,\r\n            containerId);\r\n    }\r\n};\r\n\r\n/* eslint-enable max-params */\r\n\r\n/**\r\n * Notifies CallStats that getUserMedia failed.\r\n *\r\n * @param {Error} e error to send\r\n */\r\nStatistics.sendGetUserMediaFailed = function(e) {\r\n    const error\r\n        = e instanceof JitsiTrackError\r\n            ? formatJitsiTrackErrorForCallStats(e) : e;\r\n    const globalSet = Statistics._getAllCallStatsInstances();\r\n\r\n    if (globalSet.size) {\r\n        for (const cs of globalSet) {\r\n            CallStats.sendGetUserMediaFailed(error, cs);\r\n        }\r\n    } else {\r\n        CallStats.sendGetUserMediaFailed(error, null);\r\n    }\r\n};\r\n\r\n/**\r\n * Notifies CallStats that peer connection failed to create offer.\r\n *\r\n * @param {Error} e error to send\r\n * @param {TraceablePeerConnection} tpc connection on which failure occurred.\r\n */\r\nStatistics.prototype.sendCreateOfferFailed = function(e, tpc) {\r\n    const instance = this.callsStatsInstances.get(tpc.id);\r\n\r\n    if (instance) {\r\n        instance.sendCreateOfferFailed(e);\r\n    }\r\n};\r\n\r\n/**\r\n * Notifies CallStats that peer connection failed to create answer.\r\n *\r\n * @param {Error} e error to send\r\n * @param {TraceablePeerConnection} tpc connection on which failure occured.\r\n */\r\nStatistics.prototype.sendCreateAnswerFailed = function(e, tpc) {\r\n    const instance = this.callsStatsInstances.get(tpc.id);\r\n\r\n    if (instance) {\r\n        instance.sendCreateAnswerFailed(e);\r\n    }\r\n};\r\n\r\n/**\r\n * Notifies CallStats that peer connection failed to set local description.\r\n *\r\n * @param {Error} e error to send\r\n * @param {TraceablePeerConnection} tpc connection on which failure occurred.\r\n */\r\nStatistics.prototype.sendSetLocalDescFailed = function(e, tpc) {\r\n    const instance = this.callsStatsInstances.get(tpc.id);\r\n\r\n    if (instance) {\r\n        instance.sendSetLocalDescFailed(e);\r\n    }\r\n};\r\n\r\n/**\r\n * Notifies CallStats that peer connection failed to set remote description.\r\n *\r\n * @param {Error} e error to send\r\n * @param {TraceablePeerConnection} tpc connection on which failure occurred.\r\n */\r\nStatistics.prototype.sendSetRemoteDescFailed = function(e, tpc) {\r\n    const instance = this.callsStatsInstances.get(tpc.id);\r\n\r\n    if (instance) {\r\n        instance.sendSetRemoteDescFailed(e);\r\n    }\r\n};\r\n\r\n/**\r\n * Notifies CallStats that peer connection failed to add ICE candidate.\r\n *\r\n * @param {Error} e error to send\r\n * @param {TraceablePeerConnection} tpc connection on which failure occurred.\r\n */\r\nStatistics.prototype.sendAddIceCandidateFailed = function(e, tpc) {\r\n    const instance = this.callsStatsInstances.get(tpc.id);\r\n\r\n    if (instance) {\r\n        instance.sendAddIceCandidateFailed(e);\r\n    }\r\n};\r\n\r\n/**\r\n * Adds to CallStats an application log.\r\n *\r\n * @param {String} m a log message to send or an {Error} object to be reported\r\n */\r\nStatistics.sendLog = function(m) {\r\n    const globalSubSet = new Set();\r\n\r\n    // FIXME we don't want to duplicate logs over P2P instance, but\r\n    // here we should go over instances and call this method for each\r\n    // unique conference ID rather than selecting the first one.\r\n    // We don't have such use case though, so leaving as is for now.\r\n    for (const stats of Statistics.instances) {\r\n        if (stats.callStatsApplicationLogsDisabled) {\r\n            return;\r\n        }\r\n\r\n        if (stats.callsStatsInstances.size) {\r\n            globalSubSet.add(stats.callsStatsInstances.values().next().value);\r\n        }\r\n    }\r\n\r\n    if (globalSubSet.size) {\r\n        for (const csPerStats of globalSubSet) {\r\n            CallStats.sendApplicationLog(m, csPerStats);\r\n        }\r\n    } else {\r\n        CallStats.sendApplicationLog(m, null);\r\n    }\r\n};\r\n\r\n/**\r\n * Sends the given feedback through CallStats.\r\n *\r\n * @param overall an integer between 1 and 5 indicating the user's rating.\r\n * @param comment the comment from the user.\r\n * @returns {Promise} Resolves when callstats feedback has been submitted\r\n * successfully.\r\n */\r\nStatistics.prototype.sendFeedback = function(overall, comment) {\r\n    // Statistics.analytics.sendEvent is currently fire and forget, without\r\n    // confirmation of successful send.\r\n    Statistics.analytics.sendEvent(\r\n        FEEDBACK,\r\n        {\r\n            rating: overall,\r\n            comment\r\n        });\r\n\r\n    return CallStats.sendFeedback(this.options.confID, overall, comment);\r\n};\r\n\r\nStatistics.LOCAL_JID = require('../../service/statistics/constants').LOCAL_JID;\r\n\r\n/**\r\n * Reports global error to CallStats.\r\n *\r\n * @param {Error} error\r\n */\r\nStatistics.reportGlobalError = function(error) {\r\n    if (error instanceof JitsiTrackError && error.gum) {\r\n        Statistics.sendGetUserMediaFailed(error);\r\n    } else {\r\n        Statistics.sendLog(error);\r\n    }\r\n};\r\n\r\n/**\r\n * Sends event to analytics and logs a message to the logger/console. Console\r\n * messages might also be logged to callstats automatically.\r\n *\r\n * @param {string | Object} event the event name, or an object which\r\n * represents the entire event.\r\n * @param {Object} properties properties to attach to the event (if an event\r\n * name as opposed to an event object is provided).\r\n */\r\nStatistics.sendAnalyticsAndLog = function(event, properties = {}) {\r\n    if (!event) {\r\n        logger.warn('No event or event name given.');\r\n\r\n        return;\r\n    }\r\n\r\n    let eventToLog;\r\n\r\n    // Also support an API with a single object as an event.\r\n    if (typeof event === 'object') {\r\n        eventToLog = event;\r\n    } else {\r\n        eventToLog = {\r\n            name: event,\r\n            properties\r\n        };\r\n    }\r\n\r\n    logger.log(JSON.stringify(eventToLog));\r\n\r\n    // We do this last, because it may modify the object which is passed.\r\n    this.analytics.sendEvent(event, properties);\r\n};\r\n\r\n/**\r\n * Sends event to analytics.\r\n *\r\n * @param {string | Object} eventName the event name, or an object which\r\n * represents the entire event.\r\n * @param {Object} properties properties to attach to the event\r\n */\r\nStatistics.sendAnalytics = function(eventName, properties = {}) {\r\n    this.analytics.sendEvent(eventName, properties);\r\n};\r\n","import {action, makeObservable, observable} from 'mobx'\r\n\r\nexport class RoomInfo{\r\n  defaultBackgroundFill = [0xDF, 0xDB, 0xE5]\r\n  defaultBackgroundColor = [0xB9, 0xB2, 0xC4]\r\n  \r\n  @observable roomProps = new Map<string, string>()\r\n  @observable password=''\r\n  @observable newPassword=''\r\n  @observable passMatched=false\r\n  @observable backgroundFill = [0xFF, 0xFF, 0xFF]\r\n  @observable backgroundColor = [0xFF, 0xFF, 0xFF]\r\n  @observable backgroundLeftFill = [0xFF, 0xCC, 0xFF]\r\n\r\n  constructor() {\r\n    makeObservable(this)\r\n  }\r\n  @action onUpdateProp(key:string, val:string){\r\n    switch(key){\r\n      case 'backgroundFill': this.backgroundFill = JSON.parse(val); break\r\n      case 'backgroundColor': this.backgroundColor = JSON.parse(val); break\r\n      case 'backgroundLeftFill': this.backgroundLeftFill = JSON.parse(val); break\r\n    }\r\n  }\r\n}\r\n\r\nexport default new RoomInfo()\r\n","const RTCEvents = {\r\n    /**\r\n     * Indicates error while create answer call.\r\n     */\r\n    CREATE_ANSWER_FAILED: 'rtc.create_answer_failed',\r\n\r\n    /**\r\n     * Indicates error while create offer call.\r\n     */\r\n    CREATE_OFFER_FAILED: 'rtc.create_offer_failed',\r\n    DATA_CHANNEL_OPEN: 'rtc.data_channel_open',\r\n    ENDPOINT_CONN_STATUS_CHANGED: 'rtc.endpoint_conn_status_changed',\r\n    DOMINANT_SPEAKER_CHANGED: 'rtc.dominant_speaker_changed',\r\n    LASTN_ENDPOINT_CHANGED: 'rtc.lastn_endpoint_changed',\r\n    PERCEPTIBLE_CHANGED: 'rtc.perceptibles_changed',\r\n\r\n    /**\r\n     * Event emitted when the user granted/blocked a permission for the camera / mic.\r\n     * Used to keep track of the granted permissions on browsers which don't\r\n     * support the Permissions API.\r\n     */\r\n    PERMISSIONS_CHANGED: 'rtc.permissions_changed',\r\n\r\n    SENDER_VIDEO_CONSTRAINTS_CHANGED: 'rtc.sender_video_constraints_changed',\r\n\r\n    /**\r\n     * Event emitted when {@link RTC.setLastN} method is called to update with\r\n     * the new value set.\r\n     * The first argument is the value passed to {@link RTC.setLastN}.\r\n     */\r\n    LASTN_VALUE_CHANGED: 'rtc.lastn_value_changed',\r\n\r\n    /**\r\n     * Event emitted when ssrc for a local track is extracted and stored\r\n     * in {@link TraceablePeerConnection}.\r\n     * @param {JitsiLocalTrack} track which ssrc was updated\r\n     * @param {string} ssrc that was stored\r\n     */\r\n    LOCAL_TRACK_SSRC_UPDATED: 'rtc.local_track_ssrc_updated',\r\n\r\n    /**\r\n     * The max enabled resolution of a local video track was changed.\r\n     */\r\n    LOCAL_TRACK_MAX_ENABLED_RESOLUTION_CHANGED: 'rtc.local_track_max_enabled_resolution_changed',\r\n\r\n    TRACK_ATTACHED: 'rtc.track_attached',\r\n\r\n    /**\r\n     * Event fired when we remote track is added to the conference.\r\n     * 1st event argument is the added <tt>JitsiRemoteTrack</tt> instance.\r\n     **/\r\n    REMOTE_TRACK_ADDED: 'rtc.remote_track_added',\r\n\r\n    // FIXME get rid of this event in favour of NO_DATA_FROM_SOURCE event\r\n    // (currently implemented for local tracks only)\r\n    REMOTE_TRACK_MUTE: 'rtc.remote_track_mute',\r\n\r\n    /**\r\n     * Indicates that the remote track has been removed from the conference.\r\n     * 1st event argument is the removed {@link JitsiRemoteTrack} instance.\r\n     */\r\n    REMOTE_TRACK_REMOVED: 'rtc.remote_track_removed',\r\n\r\n    // FIXME get rid of this event in favour of NO_DATA_FROM_SOURCE event\r\n    // (currently implemented for local tracks only)\r\n    REMOTE_TRACK_UNMUTE: 'rtc.remote_track_unmute',\r\n\r\n    /**\r\n     * Indicates error while set local description.\r\n     */\r\n    SET_LOCAL_DESCRIPTION_FAILED: 'rtc.set_local_description_failed',\r\n\r\n    /**\r\n     * Indicates error while set remote description.\r\n     */\r\n    SET_REMOTE_DESCRIPTION_FAILED: 'rtc.set_remote_description_failed',\r\n    AUDIO_OUTPUT_DEVICE_CHANGED: 'rtc.audio_output_device_changed',\r\n    DEVICE_LIST_CHANGED: 'rtc.device_list_changed',\r\n\r\n    /**\r\n     * Indicates that the list with available devices will change.\r\n     */\r\n    DEVICE_LIST_WILL_CHANGE: 'rtc.device_list_will_change',\r\n    DEVICE_LIST_AVAILABLE: 'rtc.device_list_available',\r\n\r\n    /**\r\n     * Indicates that a message from another participant is received on\r\n     * data channel.\r\n     */\r\n    ENDPOINT_MESSAGE_RECEIVED: 'rtc.endpoint_message_received',\r\n\r\n    /**\r\n     * Indicates that the remote endpoint stats have been received on data channnel.\r\n     */\r\n    ENDPOINT_STATS_RECEIVED: 'rtc.endpoint_stats_received',\r\n\r\n    /**\r\n     * Designates an event indicating that the local ICE username fragment of\r\n     * the jingle session has changed.\r\n     * The first argument of the vent is <tt>TraceablePeerConnection</tt> which\r\n     * is the source of the event.\r\n     * The second argument is the actual \"ufrag\" string.\r\n     */\r\n    LOCAL_UFRAG_CHANGED: 'rtc.local_ufrag_changed',\r\n\r\n    /**\r\n     * Designates an event indicating that the local ICE username fragment of\r\n     * the jingle session has changed.\r\n     * The first argument of the vent is <tt>TraceablePeerConnection</tt> which\r\n     * is the source of the event.\r\n     * The second argument is the actual \"ufrag\" string.\r\n     */\r\n    REMOTE_UFRAG_CHANGED: 'rtc.remote_ufrag_changed'\r\n};\r\n\r\nmodule.exports = RTCEvents;\r\n","export * from './Constants'\r\nexport * from './Connection'\r\nexport * from './ConnectionDefs'\r\n","/**\r\n * This class exports constants and factory methods related to the analytics\r\n * API provided by AnalyticsAdapter. In order for entries in a database to be\r\n * somewhat easily traceable back to the code which produced them, events sent\r\n * through analytics should be defined here.\r\n *\r\n * Since the AnalyticsAdapter API can be used in different ways, for some events\r\n * it is more convenient to just define the event name as a constant. For other\r\n * events a factory function is easier.\r\n *\r\n * A general approach for adding a new event:\r\n * 1. Determine the event type: track, UI, page, or operational. If in doubt use\r\n * operational.\r\n * 2. Determine whether the event is related to other existing events, and\r\n * which fields are desired to be set: name, action, actionSubject, source.\r\n * 3. If the name is sufficient (the other fields are not important), use a\r\n * constant. Otherwise use a factory function.\r\n *\r\n * Note that the AnalyticsAdapter uses the events passed to its functions for\r\n * its own purposes, and might modify them. Because of this, factory functions\r\n * should create new objects.\r\n *\r\n */\r\n\r\n/**\r\n * The constant which identifies an event of type \"operational\".\r\n * @type {string}\r\n */\r\nexport const TYPE_OPERATIONAL = 'operational';\r\n\r\n/**\r\n * The constant which identifies an event of type \"page\".\r\n * @type {string}\r\n */\r\nexport const TYPE_PAGE = 'page';\r\n\r\n/**\r\n * The constant which identifies an event of type \"track\".\r\n * @type {string}\r\n */\r\nexport const TYPE_TRACK = 'track';\r\n\r\n/**\r\n * The constant which identifies an event of type \"ui\".\r\n * @type {string}\r\n */\r\nexport const TYPE_UI = 'ui';\r\n\r\n/**\r\n * The \"action\" value for Jingle events which indicates that the Jingle session\r\n * was restarted (TODO: verify/fix the documentation)\r\n * @type {string}\r\n */\r\nexport const ACTION_JINGLE_RESTART = 'restart';\r\n\r\n/**\r\n * The \"action\" value for Jingle events which indicates that a session-accept\r\n * timed out (TODO: verify/fix the documentation)\r\n * @type {string}\r\n */\r\nexport const ACTION_JINGLE_SA_TIMEOUT = 'session-accept.timeout';\r\n\r\n/**\r\n * The \"action\" value for Jingle events which indicates that a session-initiate\r\n * was received.\r\n * @type {string}\r\n */\r\nexport const ACTION_JINGLE_SI_RECEIVED = 'session-initiate.received';\r\n\r\n/**\r\n * The \"action\" value for Jingle events which indicates that a session-initiate\r\n * not arrived within a timeout (the value is specified in\r\n * the {@link JingleSessionPC}.\r\n * @type {string}\r\n */\r\nexport const ACTION_JINGLE_SI_TIMEOUT = 'session-initiate.timeout';\r\n\r\n/**\r\n * A constant for the \"terminate\" action for Jingle events. TODO: verify/fix\r\n * the documentation)\r\n * @type {string}\r\n */\r\nexport const ACTION_JINGLE_TERMINATE = 'terminate';\r\n\r\n/**\r\n * The \"action\" value for Jingle events which indicates that a transport-replace\r\n * was received.\r\n * @type {string}\r\n */\r\nexport const ACTION_JINGLE_TR_RECEIVED\r\n    = 'transport-replace.received';\r\n\r\n/**\r\n * The \"action\" value for Jingle events which indicates that a transport-replace\r\n * succeeded (TODO: verify/fix the documentation)\r\n * @type {string}\r\n */\r\nexport const ACTION_JINGLE_TR_SUCCESS\r\n    = 'transport-replace.success';\r\n\r\n/**\r\n * The \"action\" value for P2P events which indicates that P2P session initiate message has been rejected by the client\r\n * because the mandatory requirements were not met.\r\n * @type {string}\r\n */\r\nexport const ACTION_P2P_DECLINED = 'decline';\r\n\r\n/**\r\n * The \"action\" value for P2P events which indicates that a connection was\r\n * established (TODO: verify/fix the documentation)\r\n * @type {string}\r\n */\r\nexport const ACTION_P2P_ESTABLISHED = 'established';\r\n\r\n/**\r\n * The \"action\" value for P2P events which indicates that something failed.\r\n * @type {string}\r\n */\r\nexport const ACTION_P2P_FAILED = 'failed';\r\n\r\n/**\r\n * The \"action\" value for P2P events which indicates that a switch to\r\n * jitsi-videobridge happened.\r\n * @type {string}\r\n */\r\nexport const ACTION_P2P_SWITCH_TO_JVB = 'switch.to.jvb';\r\n\r\n/**\r\n * The name of an event which indicates an available device. We send one such\r\n * event per available device once when the available devices are first known,\r\n * and every time that they change\r\n * @type {string}\r\n *\r\n * Properties:\r\n *      audio_input_device_count: the number of audio input devices available at\r\n *          the time the event was sent.\r\n *      audio_output_device_count: the number of audio output devices available\r\n *          at the time the event was sent.\r\n *      video_input_device_count: the number of video input devices available at\r\n *          the time the event was sent.\r\n *      video_output_device_count: the number of video output devices available\r\n *          at the time the event was sent.\r\n *      device_id: an identifier of the device described in this event.\r\n *      device_group_id:\r\n *      device_kind: one of 'audioinput', 'audiooutput', 'videoinput' or\r\n *          'videooutput'.\r\n *      device_label: a string which describes the device.\r\n */\r\nexport const AVAILABLE_DEVICE = 'available.device';\r\n\r\n/**\r\n * This appears to be fired only in certain cases when the XMPP connection\r\n * disconnects (and it was intentional?). It is currently never observed to\r\n * fire in production.\r\n *\r\n * TODO: document\r\n *\r\n * Properties:\r\n *      message: an error message\r\n */\r\nexport const CONNECTION_DISCONNECTED = 'connection.disconnected';\r\n\r\n/**\r\n * Indicates that the user of the application provided feedback in terms of a\r\n * rating (an integer from 1 to 5) and an optional comment.\r\n * Properties:\r\n *      value: the user's rating (an integer from 1 to 5)\r\n *      comment: the user's comment\r\n */\r\nexport const FEEDBACK = 'feedback';\r\n\r\n/**\r\n * Indicates the duration of a particular phase of the ICE connectivity\r\n * establishment.\r\n *\r\n * Properties:\r\n *      phase: the ICE phase (e.g. 'gathering', 'checking', 'establishment')\r\n *      value: the duration in milliseconds.\r\n *      p2p: whether the associated ICE connection is p2p or towards a\r\n *          jitsi-videobridge\r\n *      initiator: whether the local Jingle peer is the initiator or responder\r\n *          in the Jingle session. XXX we probably actually care about the ICE\r\n *          role (controlling vs controlled), and we assume that this correlates\r\n *          with the Jingle initiator.\r\n */\r\nexport const ICE_DURATION = 'ice.duration';\r\n\r\n/**\r\n * Indicates the difference in milliseconds between the ICE establishment time\r\n * for the P2P and JVB connections (e.g. a value of 10 would indicate that the\r\n * P2P connection took 10ms more than JVB connection to establish).\r\n *\r\n * Properties:\r\n *      value: the difference in establishment durations in milliseconds.\r\n *\r\n */\r\nexport const ICE_ESTABLISHMENT_DURATION_DIFF\r\n    = 'ice.establishment.duration.diff';\r\n\r\n/**\r\n * Indicates that the ICE state has changed.\r\n *\r\n * Properties:\r\n *      state: the ICE state which was entered (e.g. 'checking', 'connected',\r\n *          'completed', etc).\r\n *      value: the time in milliseconds (as reported by\r\n *          window.performance.now()) that the state change occurred.\r\n *      p2p: whether the associated ICE connection is p2p or towards a\r\n *          jitsi-videobridge\r\n *      signalingState: The signaling state of the associated PeerConnection\r\n *      reconnect: whether the associated Jingle session is in the process of\r\n *          reconnecting (or is it ICE? TODO: verify/fix the documentation)\r\n */\r\nexport const ICE_STATE_CHANGED = 'ice.state.changed';\r\n\r\n/**\r\n * Indicates that no bytes have been sent for the track.\r\n *\r\n * Properties:\r\n *      mediaType: the media type of the local track ('audio' or 'video').\r\n */\r\nexport const NO_BYTES_SENT = 'track.no-bytes-sent';\r\n\r\n/**\r\n * Indicates that a track was unmuted (?).\r\n *\r\n * Properties:\r\n *      mediaType: the media type of the local track ('audio' or 'video').\r\n *      trackType: the type of the track ('local' or 'remote').\r\n *      value: TODO: document\r\n */\r\nexport const TRACK_UNMUTED = 'track.unmuted';\r\n\r\n/**\r\n * Creates an operational event which indicates that we have received a\r\n * \"bridge down\" event from jicofo.\r\n */\r\nexport const createBridgeDownEvent = function() {\r\n    const bridgeDown = 'bridge.down';\r\n\r\n    return {\r\n        action: bridgeDown,\r\n        actionSubject: bridgeDown,\r\n        type: TYPE_OPERATIONAL\r\n    };\r\n};\r\n\r\n/**\r\n * Creates an event which indicates that the XMPP connection failed\r\n * @param errorType TODO\r\n * @param errorMessage TODO\r\n * @param detail connection failed details.\r\n */\r\nexport const createConnectionFailedEvent\r\n    = function(errorType, errorMessage, details) {\r\n        return {\r\n            type: TYPE_OPERATIONAL,\r\n            action: 'connection.failed',\r\n            attributes: {\r\n                'error_type': errorType,\r\n                'error_message': errorMessage,\r\n                ...details\r\n            }\r\n        };\r\n    };\r\n\r\n/**\r\n * Creates a conference event.\r\n *\r\n * @param {string} action - The action of the event.\r\n * @param {Object} attributes - The attributes to be added to the event.\r\n * @returns {{type: string, source: string, action: string, attributes: object}}\r\n */\r\nexport function createConferenceEvent(action, attributes) {\r\n    return {\r\n        action,\r\n        attributes,\r\n        source: 'conference',\r\n        type: TYPE_OPERATIONAL\r\n    };\r\n}\r\n\r\n/**\r\n * Creates an operational event which indicates that a particular connection\r\n * stage was reached (i.e. the XMPP connection transitioned to the \"connected\"\r\n * state).\r\n *\r\n * @param stage the stage which was reached\r\n * @param attributes additional attributes for the event. This should be an\r\n * object with a \"value\" property indicating a timestamp in milliseconds\r\n * relative to the beginning of the document's lifetime.\r\n *\r\n */\r\nexport const createConnectionStageReachedEvent = function(stage, attributes) {\r\n    const action = 'connection.stage.reached';\r\n\r\n    return {\r\n        action,\r\n        actionSubject: stage,\r\n        attributes,\r\n        source: action,\r\n        type: TYPE_OPERATIONAL\r\n    };\r\n};\r\n\r\n/**\r\n * Creates an operational event for the end-to-end round trip time to a\r\n * specific remote participant.\r\n * @param participantId the ID of the remote participant.\r\n * @param region the region of the remote participant\r\n * @param rtt the rtt\r\n */\r\nexport const createE2eRttEvent = function(participantId, region, rtt) {\r\n    const attributes = {\r\n        'participant_id': participantId,\r\n        region,\r\n        rtt\r\n    };\r\n\r\n    return {\r\n        attributes,\r\n        name: 'e2e_rtt',\r\n        type: TYPE_OPERATIONAL\r\n    };\r\n};\r\n\r\n/**\r\n * Creates an event which indicates that the focus has left the MUC.\r\n */\r\nexport const createFocusLeftEvent = function() {\r\n    const action = 'focus.left';\r\n\r\n    return {\r\n        action,\r\n        actionSubject: action,\r\n        type: TYPE_OPERATIONAL\r\n    };\r\n};\r\n\r\n/**\r\n * Creates an event related to a getUserMedia call.\r\n *\r\n * @param action the type of the result that the event represents: 'error',\r\n * 'success', 'warning', etc.\r\n * @param attributes the attributes to attach to the event.\r\n * @returns {{type: string, source: string, name: string}}\r\n */\r\nexport const createGetUserMediaEvent = function(action, attributes = {}) {\r\n    return {\r\n        type: TYPE_OPERATIONAL,\r\n        source: 'get.user.media',\r\n        action,\r\n        attributes\r\n    };\r\n};\r\n\r\n/**\r\n * Creates an event related to remote participant connection status changes.\r\n *\r\n * @param attributes the attributes to attach to the event.\r\n * @returns {{type: string, source: string, name: string}}\r\n */\r\nexport const createParticipantConnectionStatusEvent = function(attributes = {}) {\r\n    const action = 'duration';\r\n\r\n    return {\r\n        type: TYPE_OPERATIONAL,\r\n        source: 'peer.conn.status',\r\n        action,\r\n        attributes\r\n    };\r\n};\r\n\r\n/**\r\n * Creates an event for a Jingle-related event.\r\n * @param action the action of the event\r\n * @param attributes attributes to add to the event.\r\n */\r\nexport const createJingleEvent = function(action, attributes = {}) {\r\n    return {\r\n        type: TYPE_OPERATIONAL,\r\n        action,\r\n        source: 'jingle',\r\n        attributes\r\n    };\r\n};\r\n\r\n/**\r\n * Creates an event which indicates that a local track was not able to read\r\n * data from its source (a camera or a microphone).\r\n *\r\n * @param mediaType {String} the media type of the local track ('audio' or\r\n * 'video').\r\n */\r\nexport const createNoDataFromSourceEvent = function(mediaType, value) {\r\n    return {\r\n        attributes: {\r\n            'media_type': mediaType,\r\n            value\r\n        },\r\n        action: 'track.no.data.from.source',\r\n        type: TYPE_OPERATIONAL\r\n    };\r\n};\r\n\r\n/**\r\n * Creates an event for a p2p-related event.\r\n * @param action the action of the event\r\n * @param attributes attributes to add to the event.\r\n */\r\nexport const createP2PEvent = function(action, attributes = {}) {\r\n    return {\r\n        type: TYPE_OPERATIONAL,\r\n        action,\r\n        source: 'p2p',\r\n        attributes\r\n    };\r\n};\r\n\r\n/**\r\n * Indicates that we received a remote command to mute.\r\n */\r\nexport const createRemotelyMutedEvent = function(mediaType) {\r\n    return {\r\n        type: TYPE_OPERATIONAL,\r\n        action: 'remotely.muted',\r\n        mediaType\r\n    };\r\n};\r\n\r\n/**\r\n * Creates an event which contains RTP statistics such as RTT and packet loss.\r\n *\r\n * All average RTP stats are currently reported under 1 event name, but with\r\n * different properties that allows to distinguish between a P2P call, a\r\n * call relayed through TURN or the JVB, and multiparty vs 1:1.\r\n *\r\n * The structure of the event is:\r\n *\r\n * {\r\n *      p2p: true,\r\n *      conferenceSize: 2,\r\n *      localCandidateType: \"relay\",\r\n *      remoteCandidateType: \"relay\",\r\n *      transportType: \"udp\",\r\n *\r\n *      // Average RTT of 200ms\r\n *      \"rtt.avg\": 200,\r\n *      \"rtt.samples\": \"[100, 200, 300]\",\r\n *\r\n *      // Average packet loss of 10%\r\n *      \"packet.loss.avg\": 10,\r\n *      \"packet.loss.samples\": '[5, 10, 15]'\r\n *\r\n *      // Difference in milliseconds in the end-to-end RTT between p2p and jvb.\r\n *      // The e2e RTT through jvb is 15ms shorter:\r\n *      \"rtt.diff\": 15,\r\n *\r\n *      // End-to-end RTT through JVB is ms.\r\n *      \"end2end.rtt.avg\" = 100\r\n * }\r\n *\r\n * Note that the value of the \"samples\" properties are (JSON encoded) strings,\r\n * and not JSON arrays, as events' attributes can not be nested. The samples are\r\n * currently included for debug purposes only and can be removed anytime soon\r\n * from the structure.\r\n *\r\n * Also note that not all of values are present in each event, as values are\r\n * obtained and calculated as part of different process/event pipe. For example\r\n * {@link ConnectionAvgStats} instances are doing the reports for each\r\n * {@link TraceablePeerConnection} and work independently from the main stats\r\n * pipe.\r\n */\r\nexport const createRtpStatsEvent = function(attributes) {\r\n    return {\r\n        type: TYPE_OPERATIONAL,\r\n        action: 'rtp.stats',\r\n        attributes\r\n    };\r\n};\r\n\r\n/**\r\n * Creates an event which contains the round trip time (RTT) to a set of\r\n * regions.\r\n *\r\n * @param attributes\r\n * @returns {{type: string, action: string, attributes: *}}\r\n */\r\nexport const createRttByRegionEvent = function(attributes) {\r\n    return {\r\n        type: TYPE_OPERATIONAL,\r\n        action: 'rtt.by.region',\r\n        attributes\r\n    };\r\n};\r\n\r\n/**\r\n * Creates an event which contains the local and remote ICE candidate types\r\n * for the transport that is currently selected.\r\n *\r\n * @param attributes\r\n * @returns {{type: string, action: string, attributes: *}}\r\n */\r\nexport const createTransportStatsEvent = function(attributes) {\r\n    return {\r\n        type: TYPE_OPERATIONAL,\r\n        action: 'transport.stats',\r\n        attributes\r\n    };\r\n};\r\n\r\n/**\r\n * Creates an event which contains information about the audio output problem (the user id of the affected participant,\r\n * the local audio levels and the remote audio levels that triggered the event).\r\n *\r\n * @param {string} userID - The user id of the affected participant.\r\n * @param {*} localAudioLevels - The local audio levels.\r\n * @param {*} remoteAudioLevels - The audio levels received from the participant.\r\n */\r\nexport function createAudioOutputProblemEvent(userID, localAudioLevels, remoteAudioLevels) {\r\n    return {\r\n        type: TYPE_OPERATIONAL,\r\n        action: 'audio.output.problem',\r\n        attributes: {\r\n            userID,\r\n            localAudioLevels,\r\n            remoteAudioLevels\r\n        }\r\n    };\r\n}\r\n\r\n/**\r\n * Creates an event which contains an information related to the bridge channel close event.\r\n *\r\n * @param {string} code - A code from {@link https://developer.mozilla.org/en-US/docs/Web/API/CloseEvent}\r\n * @param {string} reason - A string which describes the reason for closing the bridge channel.\r\n * @returns {{type: string, action: string, attributes: { code: string, reason: string }}}\r\n */\r\nexport const createBridgeChannelClosedEvent = function(code, reason) {\r\n    return {\r\n        type: TYPE_OPERATIONAL,\r\n        action: 'bridge-channel.error',\r\n        attributes: {\r\n            code,\r\n            reason\r\n        }\r\n    };\r\n};\r\n\r\n/**\r\n * Creates an event which indicates the Time To First Media (TTFM).\r\n * It is measured in milliseconds relative to the beginning of the document's\r\n * lifetime (i.e. the origin used by window.performance.now()), and it excludes\r\n * the following:\r\n * 1. The delay due to getUserMedia()\r\n * 2. The period between the MUC being joined and the reception of the Jingle\r\n * session-initiate from jicofo. This is because jicofo will not start a Jingle\r\n * session until there are at least 2 participants in the room.\r\n *\r\n * @param attributes the attributes to add to the event. Currently used fields:\r\n *      mediaType: the media type of the local track ('audio' or 'video').\r\n *      muted: whether the track has ever been muted (?)\r\n *      value: the TTMF in milliseconds.\r\n */\r\nexport const createTtfmEvent = function(attributes) {\r\n    return createConnectionStageReachedEvent('ttfm', attributes);\r\n};\r\n","//  messages forward only when participants are in the range.\r\nexport const ParticipantMessageType = {\r\n  PARTICIPANT_AFK: 'p_afk',                     //  boolean\r\n  PARTICIPANT_TRACKSTATES: 'p_trackSt',         //  boolean\r\n}\r\nexport type ParticipantMessageKeys = keyof typeof ParticipantMessageType\r\n\r\nexport const PoseMessageType = {\r\n  PARTICIPANT_POSE: 'mp',                       //  special text, -> presence and message\r\n  PARTICIPANT_MOUSE: 'mm',                      //  special text, -> presence and message\r\n  PARTICIPANT_ON_STAGE: 'p_onStage',            //  boolean\r\n}\r\n\r\nexport const StoredMessageType = {\r\n  ...ParticipantMessageType,\r\n  PARTICIPANT_INFO: 'p_info',                   //  RemoteInformation, -> presence\r\n  MAIN_SCREEN_CARRIER: 'main_screen_carrier',   //  {carrierId, enabled} -> presence\r\n  MY_CONTENT: 'my_content',                     //  ISharedContent[] -> presence, used only when no bmRelayServer exist\r\n}\r\n\r\nexport type StoredMessageKeys = keyof typeof StoredMessageType\r\n\r\nexport const InstantMessageType = {\r\n  PARTICIPANT_TRACKLIMITS: 'm_track_limits',    //  [number, number], message, Usually not used.\r\n  YARN_PHONE: 'YARN_PHONE',                     //  pids[] -> message\r\n  CHAT_MESSAGE: 'm_chat',                       //  ChatMessageToSend, -> text chat message\r\n  CALL_REMOTE: 'call_remote',                   //  pid:string, give notification to a remote user.\r\n  MUTE_VIDEO: 'm_mute_video',                   //  boolean, ask to mute video\r\n  MUTE_AUDIO: 'm_mute_audio',                   //  boolean, ask to mute audio\r\n  RELOAD_BROWSER: 'm_reload',                   //  not used, ask to reload browser\r\n  KICK: 'm_kick',                               //  reason:string\r\n}\r\nexport const InstantMessageTypes = new Set(Object.values(InstantMessageType))\r\n\r\n\r\n//  messages which can be merged.\r\nexport const ObjectArrayMessageType = {\r\n  CONTENT_UPDATE_REQUEST: 'c_update',     //  IShraedContent[]\r\n  CONTENT_INFO_UPDATE: 'c_info_update',   //  SharedContentInfo[], only bmRelayServer to clients.\r\n}\r\nexport const ObjectArrayMessageTypes = new Set(Object.values(ObjectArrayMessageType))\r\n\r\nexport const StringArrayMessageType = {\r\n  LEFT_CONTENT_REMOVE_REQUEST: 'left_c_remove',   //  ids:string[], only when no bmRelayServer\r\n  CONTENT_REMOVE_REQUEST: 'c_remove',             //  ids:string[]\r\n  PARTICIPANT_OUT: 'p_out',                       //  ids:stirng[]\r\n  MOUSE_OUT: 'm_out',                             //  ids:stirng[]\r\n  CONTENT_OUT: 'c_out',                           //  ids:stirng[]\r\n}\r\nexport const StringArrayMessageTypes = new Set(Object.values(StringArrayMessageType))\r\n\r\nexport const ClientToServerOnlyMessageType = {\r\n  CONTENT_UPDATE_REQUEST_BY_ID: 'c_update_by_id', //  cids:string[],\r\n  REQUEST_ALL: 'req_all',                       //  request all stored information\r\n  REQUEST_RANGE: 'req_range', //  rect:number[4], circle:number[3]. request updated message related to the range\r\n  REQUEST_PARTICIPANT_STATES: 'req_p_state',    //  -> message, to get states to display participant\r\n}\r\n\r\nexport const MessageType = {\r\n  ...ObjectArrayMessageType,\r\n  ...StringArrayMessageType,\r\n  ...InstantMessageType,\r\n  ...StoredMessageType,\r\n  ...PoseMessageType,\r\n  ...ClientToServerOnlyMessageType,\r\n\r\n  //  special\r\n  PARTICIPANT_LEFT: 'm_participant_left',       //  id:string,  remove info\r\n  ROOM_PROP:  'room_prop',                      //  [name:string, value:string], set room property\r\n  REQUEST_TO: 'req_to',                         //  ids:string[], request for info of specific participant\r\n\r\n  //  only for JVB\r\n  FRAGMENT_HEAD: 'frag_head',\r\n  FRAGMENT_CONTENT: 'frag_cont',\r\n}\r\nexport type MessageKeys = keyof typeof MessageType\r\n","import { getLogger } from 'jitsi-meet-logger';\r\nconst logger = getLogger(__filename);\r\n\r\nimport CodecMimeType from '../../service/RTC/CodecMimeType';\r\nimport MediaDirection from '../../service/RTC/MediaDirection';\r\nimport browser from '../browser';\r\nimport RandomUtil from '../util/RandomUtil';\r\n\r\nconst SDPUtil = {\r\n    filterSpecialChars(text) {\r\n        // XXX Neither one of the falsy values (e.g. null, undefined, false,\r\n        // \"\", etc.) \"contain\" special chars.\r\n        // eslint-disable-next-line no-useless-escape\r\n        return text ? text.replace(/[\\\\\\/\\{,\\}\\+]/g, '') : text;\r\n    },\r\n    iceparams(mediadesc, sessiondesc) {\r\n        let data = null;\r\n        let pwd, ufrag;\r\n\r\n        if ((ufrag = SDPUtil.findLine(mediadesc, 'a=ice-ufrag:', sessiondesc))\r\n                && (pwd\r\n                    = SDPUtil.findLine(\r\n                        mediadesc,\r\n                        'a=ice-pwd:',\r\n                        sessiondesc))) {\r\n            data = {\r\n                ufrag: SDPUtil.parseICEUfrag(ufrag),\r\n                pwd: SDPUtil.parseICEPwd(pwd)\r\n            };\r\n        }\r\n\r\n        return data;\r\n    },\r\n    parseICEUfrag(line) {\r\n        return line.substring(12);\r\n    },\r\n    buildICEUfrag(frag) {\r\n        return `a=ice-ufrag:${frag}`;\r\n    },\r\n    parseICEPwd(line) {\r\n        return line.substring(10);\r\n    },\r\n    buildICEPwd(pwd) {\r\n        return `a=ice-pwd:${pwd}`;\r\n    },\r\n    parseMID(line) {\r\n        return line.substring(6);\r\n    },\r\n    parseMLine(line) {\r\n        const data = {};\r\n        const parts = line.substring(2).split(' ');\r\n\r\n        data.media = parts.shift();\r\n        data.port = parts.shift();\r\n        data.proto = parts.shift();\r\n        if (parts[parts.length - 1] === '') { // trailing whitespace\r\n            parts.pop();\r\n        }\r\n        data.fmt = parts;\r\n\r\n        return data;\r\n    },\r\n    buildMLine(mline) {\r\n        return (\r\n            `m=${mline.media} ${mline.port} ${mline.proto} ${\r\n                mline.fmt.join(' ')}`);\r\n    },\r\n    parseRTPMap(line) {\r\n        const data = {};\r\n        let parts = line.substring(9).split(' ');\r\n\r\n        data.id = parts.shift();\r\n        parts = parts[0].split('/');\r\n        data.name = parts.shift();\r\n        data.clockrate = parts.shift();\r\n        data.channels = parts.length ? parts.shift() : '1';\r\n\r\n        return data;\r\n    },\r\n\r\n    /**\r\n     * Parses SDP line \"a=sctpmap:...\" and extracts SCTP port from it.\r\n     * @param line eg. \"a=sctpmap:5000 webrtc-datachannel\"\r\n     * @returns [SCTP port number, protocol, streams]\r\n     */\r\n    parseSCTPMap(line) {\r\n        const parts = line.substring(10).split(' ');\r\n        const sctpPort = parts[0];\r\n        const protocol = parts[1];\r\n\r\n        // Stream count is optional\r\n        const streamCount = parts.length > 2 ? parts[2] : null;\r\n\r\n\r\n        return [ sctpPort, protocol, streamCount ];// SCTP port\r\n    },\r\n    buildRTPMap(el) {\r\n        let line\r\n            = `a=rtpmap:${el.getAttribute('id')} ${el.getAttribute('name')}/${\r\n                el.getAttribute('clockrate')}`;\r\n\r\n        if (el.getAttribute('channels')\r\n            && el.getAttribute('channels') !== '1') {\r\n            line += `/${el.getAttribute('channels')}`;\r\n        }\r\n\r\n        return line;\r\n    },\r\n    parseCrypto(line) {\r\n        const data = {};\r\n        const parts = line.substring(9).split(' ');\r\n\r\n        data.tag = parts.shift();\r\n        data['crypto-suite'] = parts.shift();\r\n        data['key-params'] = parts.shift();\r\n        if (parts.length) {\r\n            data['session-params'] = parts.join(' ');\r\n        }\r\n\r\n        return data;\r\n    },\r\n    parseFingerprint(line) { // RFC 4572\r\n        const data = {};\r\n        const parts = line.substring(14).split(' ');\r\n\r\n        data.hash = parts.shift();\r\n        data.fingerprint = parts.shift();\r\n\r\n        // TODO assert that fingerprint satisfies 2UHEX *(\":\" 2UHEX) ?\r\n        return data;\r\n    },\r\n    parseFmtp(line) {\r\n        const data = [];\r\n        let parts = line.split(' ');\r\n\r\n        parts.shift();\r\n        parts = parts.join(' ').split(';');\r\n        for (let i = 0; i < parts.length; i++) {\r\n            let key = parts[i].split('=')[0];\r\n\r\n            while (key.length && key[0] === ' ') {\r\n                key = key.substring(1);\r\n            }\r\n            const value = parts[i].split('=')[1];\r\n\r\n            if (key && value) {\r\n                data.push({ name: key,\r\n                    value });\r\n            } else if (key) {\r\n                // rfc 4733 (DTMF) style stuff\r\n                data.push({ name: '',\r\n                    value: key });\r\n            }\r\n        }\r\n\r\n        return data;\r\n    },\r\n    parseICECandidate(line) {\r\n        const candidate = {};\r\n        const elems = line.split(' ');\r\n\r\n        candidate.foundation = elems[0].substring(12);\r\n        candidate.component = elems[1];\r\n        candidate.protocol = elems[2].toLowerCase();\r\n        candidate.priority = elems[3];\r\n        candidate.ip = elems[4];\r\n        candidate.port = elems[5];\r\n\r\n        // elems[6] => \"typ\"\r\n        candidate.type = elems[7];\r\n        candidate.generation = 0; // default value, may be overwritten below\r\n        for (let i = 8; i < elems.length; i += 2) {\r\n            switch (elems[i]) {\r\n            case 'raddr':\r\n                candidate['rel-addr'] = elems[i + 1];\r\n                break;\r\n            case 'rport':\r\n                candidate['rel-port'] = elems[i + 1];\r\n                break;\r\n            case 'generation':\r\n                candidate.generation = elems[i + 1];\r\n                break;\r\n            case 'tcptype':\r\n                candidate.tcptype = elems[i + 1];\r\n                break;\r\n            default: // TODO\r\n                logger.log(\r\n                    `parseICECandidate not translating \"${\r\n                        elems[i]}\" = \"${elems[i + 1]}\"`);\r\n            }\r\n        }\r\n        candidate.network = '1';\r\n\r\n        // not applicable to SDP -- FIXME: should be unique, not just random\r\n        // eslint-disable-next-line newline-per-chained-call\r\n        candidate.id = Math.random().toString(36).substr(2, 10);\r\n\r\n        return candidate;\r\n    },\r\n    buildICECandidate(cand) {\r\n        let line = [\r\n            `a=candidate:${cand.foundation}`,\r\n            cand.component,\r\n            cand.protocol,\r\n            cand.priority,\r\n            cand.ip,\r\n            cand.port,\r\n            'typ',\r\n            cand.type\r\n        ].join(' ');\r\n\r\n        line += ' ';\r\n        switch (cand.type) {\r\n        case 'srflx':\r\n        case 'prflx':\r\n        case 'relay':\r\n            if (cand.hasOwnAttribute('rel-addr')\r\n                    && cand.hasOwnAttribute('rel-port')) {\r\n                line += 'raddr';\r\n                line += ' ';\r\n                line += cand['rel-addr'];\r\n                line += ' ';\r\n                line += 'rport';\r\n                line += ' ';\r\n                line += cand['rel-port'];\r\n                line += ' ';\r\n            }\r\n            break;\r\n        }\r\n        if (cand.hasOwnAttribute('tcptype')) {\r\n            line += 'tcptype';\r\n            line += ' ';\r\n            line += cand.tcptype;\r\n            line += ' ';\r\n        }\r\n        line += 'generation';\r\n        line += ' ';\r\n        line += cand.hasOwnAttribute('generation') ? cand.generation : '0';\r\n\r\n        return line;\r\n    },\r\n    parseSSRC(desc) {\r\n        // proprietary mapping of a=ssrc lines\r\n        // TODO: see \"Jingle RTP Source Description\" by Juberti and P. Thatcher\r\n        // on google docs and parse according to that\r\n        const data = new Map();\r\n        const lines = desc.split('\\r\\n');\r\n\r\n        for (let i = 0; i < lines.length; i++) {\r\n            if (lines[i].substring(0, 7) === 'a=ssrc:') {\r\n                // FIXME: Use regex to smartly find the ssrc.\r\n                const ssrc = lines[i].split('a=ssrc:')[1].split(' ')[0];\r\n\r\n                if (!data.get(ssrc)) {\r\n                    data.set(ssrc, []);\r\n                }\r\n\r\n                data.get(ssrc).push(lines[i]);\r\n            }\r\n        }\r\n\r\n        return data;\r\n    },\r\n    parseRTCPFB(line) {\r\n        const parts = line.substr(10).split(' ');\r\n        const data = {};\r\n\r\n        data.pt = parts.shift();\r\n        data.type = parts.shift();\r\n        data.params = parts;\r\n\r\n        return data;\r\n    },\r\n    parseExtmap(line) {\r\n        const parts = line.substr(9).split(' ');\r\n        const data = {};\r\n\r\n        data.value = parts.shift();\r\n        if (data.value.indexOf('/') === -1) {\r\n            data.direction = 'both';\r\n        } else {\r\n            data.direction = data.value.substr(data.value.indexOf('/') + 1);\r\n            data.value = data.value.substr(0, data.value.indexOf('/'));\r\n        }\r\n        data.uri = parts.shift();\r\n        data.params = parts;\r\n\r\n        return data;\r\n    },\r\n    findLine(haystack, needle, sessionpart) {\r\n        let lines = haystack.split('\\r\\n');\r\n\r\n        for (let i = 0; i < lines.length; i++) {\r\n            if (lines[i].substring(0, needle.length) === needle) {\r\n                return lines[i];\r\n            }\r\n        }\r\n        if (!sessionpart) {\r\n            return false;\r\n        }\r\n\r\n        // search session part\r\n        lines = sessionpart.split('\\r\\n');\r\n        for (let j = 0; j < lines.length; j++) {\r\n            if (lines[j].substring(0, needle.length) === needle) {\r\n                return lines[j];\r\n            }\r\n        }\r\n\r\n        return false;\r\n    },\r\n    findLines(haystack, needle, sessionpart) {\r\n        let lines = haystack.split('\\r\\n');\r\n        const needles = [];\r\n\r\n        for (let i = 0; i < lines.length; i++) {\r\n            if (lines[i].substring(0, needle.length) === needle) {\r\n                needles.push(lines[i]);\r\n            }\r\n        }\r\n        if (needles.length || !sessionpart) {\r\n            return needles;\r\n        }\r\n\r\n        // search session part\r\n        lines = sessionpart.split('\\r\\n');\r\n        for (let j = 0; j < lines.length; j++) {\r\n            if (lines[j].substring(0, needle.length) === needle) {\r\n                needles.push(lines[j]);\r\n            }\r\n        }\r\n\r\n        return needles;\r\n    },\r\n    candidateToJingle(line) {\r\n        // a=candidate:2979166662 1 udp 2113937151 192.168.2.100 57698 typ host\r\n        // generation 0\r\n        //      <candidate component=... foundation=... generation=... id=...\r\n        // ip=... network=... port=... priority=... protocol=... type=.../>\r\n        if (line.indexOf('candidate:') === 0) {\r\n            // eslint-disable-next-line no-param-reassign\r\n            line = `a=${line}`;\r\n        } else if (line.substring(0, 12) !== 'a=candidate:') {\r\n            logger.log(\r\n                'parseCandidate called with a line that is not a candidate'\r\n                    + ' line');\r\n            logger.log(line);\r\n\r\n            return null;\r\n        }\r\n        if (line.substring(line.length - 2) === '\\r\\n') { // chomp it\r\n            // eslint-disable-next-line no-param-reassign\r\n            line = line.substring(0, line.length - 2);\r\n        }\r\n        const candidate = {};\r\n        const elems = line.split(' ');\r\n\r\n        if (elems[6] !== 'typ') {\r\n            logger.log('did not find typ in the right place');\r\n            logger.log(line);\r\n\r\n            return null;\r\n        }\r\n        candidate.foundation = elems[0].substring(12);\r\n        candidate.component = elems[1];\r\n        candidate.protocol = elems[2].toLowerCase();\r\n        candidate.priority = elems[3];\r\n        candidate.ip = elems[4];\r\n        candidate.port = elems[5];\r\n\r\n        // elems[6] => \"typ\"\r\n        candidate.type = elems[7];\r\n\r\n        candidate.generation = '0'; // default, may be overwritten below\r\n        for (let i = 8; i < elems.length; i += 2) {\r\n            switch (elems[i]) {\r\n            case 'raddr':\r\n                candidate['rel-addr'] = elems[i + 1];\r\n                break;\r\n            case 'rport':\r\n                candidate['rel-port'] = elems[i + 1];\r\n                break;\r\n            case 'generation':\r\n                candidate.generation = elems[i + 1];\r\n                break;\r\n            case 'tcptype':\r\n                candidate.tcptype = elems[i + 1];\r\n                break;\r\n            default: // TODO\r\n                logger.log(`not translating \"${elems[i]}\" = \"${elems[i + 1]}\"`);\r\n            }\r\n        }\r\n        candidate.network = '1';\r\n\r\n        // not applicable to SDP -- FIXME: should be unique, not just random\r\n        // eslint-disable-next-line newline-per-chained-call\r\n        candidate.id = Math.random().toString(36).substr(2, 10);\r\n\r\n        return candidate;\r\n    },\r\n    candidateFromJingle(cand) {\r\n        let line = 'a=candidate:';\r\n\r\n        line += cand.getAttribute('foundation');\r\n        line += ' ';\r\n        line += cand.getAttribute('component');\r\n        line += ' ';\r\n\r\n        let protocol = cand.getAttribute('protocol');\r\n\r\n        // use tcp candidates for FF\r\n\r\n        if (browser.isFirefox() && protocol.toLowerCase() === 'ssltcp') {\r\n            protocol = 'tcp';\r\n        }\r\n\r\n        line += protocol; // .toUpperCase(); // chrome M23 doesn't like this\r\n        line += ' ';\r\n        line += cand.getAttribute('priority');\r\n        line += ' ';\r\n        line += cand.getAttribute('ip');\r\n        line += ' ';\r\n        line += cand.getAttribute('port');\r\n        line += ' ';\r\n        line += 'typ';\r\n        line += ` ${cand.getAttribute('type')}`;\r\n        line += ' ';\r\n        switch (cand.getAttribute('type')) {\r\n        case 'srflx':\r\n        case 'prflx':\r\n        case 'relay':\r\n            if (cand.getAttribute('rel-addr')\r\n                    && cand.getAttribute('rel-port')) {\r\n                line += 'raddr';\r\n                line += ' ';\r\n                line += cand.getAttribute('rel-addr');\r\n                line += ' ';\r\n                line += 'rport';\r\n                line += ' ';\r\n                line += cand.getAttribute('rel-port');\r\n                line += ' ';\r\n            }\r\n            break;\r\n        }\r\n        if (protocol.toLowerCase() === 'tcp') {\r\n            line += 'tcptype';\r\n            line += ' ';\r\n            line += cand.getAttribute('tcptype');\r\n            line += ' ';\r\n        }\r\n        line += 'generation';\r\n        line += ' ';\r\n        line += cand.getAttribute('generation') || '0';\r\n\r\n        return `${line}\\r\\n`;\r\n    },\r\n\r\n    /**\r\n     * Parse the 'most' primary video ssrc from the given m line\r\n     * @param {object} mLine object as parsed from transform.parse\r\n     * @return {number} the primary video ssrc from the given m line\r\n     */\r\n    parsePrimaryVideoSsrc(videoMLine) {\r\n        const numSsrcs = videoMLine.ssrcs\r\n            .map(ssrcInfo => ssrcInfo.id)\r\n            .filter((ssrc, index, array) => array.indexOf(ssrc) === index)\r\n            .length;\r\n        const numGroups\r\n            = (videoMLine.ssrcGroups && videoMLine.ssrcGroups.length) || 0;\r\n\r\n        if (numSsrcs > 1 && numGroups === 0) {\r\n            // Ambiguous, can't figure out the primary\r\n            return;\r\n        }\r\n        let primarySsrc = null;\r\n\r\n        if (numSsrcs === 1) {\r\n            primarySsrc = videoMLine.ssrcs[0].id;\r\n        } else if (numSsrcs === 2) {\r\n            // Can figure it out if there's an FID group\r\n            const fidGroup\r\n                = videoMLine.ssrcGroups.find(\r\n                    group => group.semantics === 'FID');\r\n\r\n            if (fidGroup) {\r\n                primarySsrc = fidGroup.ssrcs.split(' ')[0];\r\n            }\r\n        } else if (numSsrcs >= 3) {\r\n            // Can figure it out if there's a sim group\r\n            const simGroup\r\n                = videoMLine.ssrcGroups.find(\r\n                    group => group.semantics === 'SIM');\r\n\r\n            if (simGroup) {\r\n                primarySsrc = simGroup.ssrcs.split(' ')[0];\r\n            }\r\n        }\r\n\r\n        return primarySsrc;\r\n    },\r\n\r\n    /**\r\n     * Generate an ssrc\r\n     * @returns {number} an ssrc\r\n     */\r\n    generateSsrc() {\r\n        return RandomUtil.randomInt(1, 0xffffffff);\r\n    },\r\n\r\n    /**\r\n     * Get an attribute for the given ssrc with the given attributeName\r\n     *  from the given mline\r\n     * @param {object} mLine an mLine object as parsed from transform.parse\r\n     * @param {number} ssrc the ssrc for which an attribute is desired\r\n     * @param {string} attributeName the name of the desired attribute\r\n     * @returns {string} the value corresponding to the given ssrc\r\n     *  and attributeName\r\n     */\r\n    getSsrcAttribute(mLine, ssrc, attributeName) {\r\n        for (let i = 0; i < mLine.ssrcs.length; ++i) {\r\n            const ssrcLine = mLine.ssrcs[i];\r\n\r\n            if (ssrcLine.id === ssrc\r\n                && ssrcLine.attribute === attributeName) {\r\n                return ssrcLine.value;\r\n            }\r\n        }\r\n    },\r\n\r\n    /**\r\n     * Parses the ssrcs from the group sdp line and\r\n     *  returns them as a list of numbers\r\n     * @param {object} the ssrcGroup object as parsed from\r\n     *  sdp-transform\r\n     * @returns {list<number>} a list of the ssrcs in the group\r\n     *  parsed as numbers\r\n     */\r\n    parseGroupSsrcs(ssrcGroup) {\r\n        return ssrcGroup\r\n            .ssrcs\r\n            .split(' ')\r\n            .map(ssrcStr => parseInt(ssrcStr, 10));\r\n    },\r\n\r\n    /**\r\n     * Get the mline of the given type from the given sdp\r\n     * @param {object} sdp sdp as parsed from transform.parse\r\n     * @param {string} type the type of the desired mline (e.g. \"video\")\r\n     * @returns {object} a media object\r\n     */\r\n    getMedia(sdp, type) {\r\n        return sdp.media.find(m => m.type === type);\r\n    },\r\n\r\n    /**\r\n     * Extracts the ICE username fragment from an SDP string.\r\n     * @param {string} sdp the SDP in raw text format\r\n     */\r\n    getUfrag(sdp) {\r\n        const ufragLines\r\n            = sdp.split('\\n').filter(line => line.startsWith('a=ice-ufrag:'));\r\n\r\n        if (ufragLines.length > 0) {\r\n            return ufragLines[0].substr('a=ice-ufrag:'.length);\r\n        }\r\n    },\r\n\r\n    /**\r\n     * Sets the given codecName as the preferred codec by moving it to the beginning\r\n     * of the payload types list (modifies the given mline in place). All instances\r\n     * of the codec are moved up.\r\n     * @param {object} mLine the mline object from an sdp as parsed by transform.parse\r\n     * @param {string} codecName the name of the preferred codec\r\n     */\r\n    preferCodec(mline, codecName) {\r\n        if (!mline || !codecName) {\r\n            return;\r\n        }\r\n\r\n        const matchingPayloadTypes = mline.rtp\r\n            .filter(rtp => rtp.codec && rtp.codec.toLowerCase() === codecName.toLowerCase())\r\n            .map(rtp => rtp.payload);\r\n\r\n        if (matchingPayloadTypes) {\r\n            // Call toString() on payloads to get around an issue within SDPTransform that sets\r\n            // payloads as a number, instead of a string, when there is only one payload.\r\n            const payloadTypes\r\n                = mline.payloads\r\n                .toString()\r\n                .split(' ')\r\n                .map(p => parseInt(p, 10));\r\n\r\n            for (const pt of matchingPayloadTypes.reverse()) {\r\n                const payloadIndex = payloadTypes.indexOf(pt);\r\n\r\n                payloadTypes.splice(payloadIndex, 1);\r\n                payloadTypes.unshift(pt);\r\n            }\r\n            mline.payloads = payloadTypes.join(' ');\r\n        }\r\n    },\r\n\r\n    /**\r\n     * Strips the given codec from the given mline. All related RTX payload\r\n     * types are also stripped. If the resulting mline would have no codecs,\r\n     * it's disabled.\r\n     *\r\n     * @param {object} mLine the mline object from an sdp as parsed by transform.parse.\r\n     * @param {string} codecName the name of the codec which will be stripped.\r\n     * @param {boolean} highProfile determines if only the high profile H264 codec needs to be\r\n     * stripped from the sdp when the passed codecName is H264.\r\n     */\r\n    stripCodec(mLine, codecName, highProfile = false) {\r\n        if (!mLine || !codecName) {\r\n            return;\r\n        }\r\n\r\n        const h264Pts = [];\r\n        let removePts = [];\r\n        const stripH264HighCodec = codecName.toLowerCase() === CodecMimeType.H264 && highProfile;\r\n\r\n        for (const rtp of mLine.rtp) {\r\n            if (rtp.codec\r\n                && rtp.codec.toLowerCase() === codecName.toLowerCase()) {\r\n                if (stripH264HighCodec) {\r\n                    h264Pts.push(rtp.payload);\r\n                } else {\r\n                    removePts.push(rtp.payload);\r\n                }\r\n            }\r\n        }\r\n\r\n        // high profile H264 codecs have 64 as the first two bytes of the profile-level-id.\r\n        if (stripH264HighCodec) {\r\n            removePts = mLine.fmtp\r\n                .filter(item => h264Pts.indexOf(item.payload) > -1 && item.config.includes('profile-level-id=64'))\r\n                .map(item => item.payload);\r\n        }\r\n\r\n        if (removePts.length > 0) {\r\n            // We also need to remove the payload types that are related to RTX\r\n            // for the codecs we want to disable.\r\n            const rtxApts = removePts.map(item => `apt=${item}`);\r\n            const rtxPts = mLine.fmtp.filter(\r\n                item => rtxApts.indexOf(item.config) !== -1);\r\n\r\n            removePts.push(...rtxPts.map(item => item.payload));\r\n\r\n            // Call toString() on payloads to get around an issue within\r\n            // SDPTransform that sets payloads as a number, instead of a string,\r\n            // when there is only one payload.\r\n            const allPts = mLine.payloads\r\n                .toString()\r\n                .split(' ')\r\n                .map(Number);\r\n            const keepPts = allPts.filter(pt => removePts.indexOf(pt) === -1);\r\n\r\n            if (keepPts.length === 0) {\r\n                // There are no other codecs, disable the stream.\r\n                mLine.port = 0;\r\n                mLine.direction = MediaDirection.INACTIVE;\r\n                mLine.payloads = '*';\r\n            } else {\r\n                mLine.payloads = keepPts.join(' ');\r\n            }\r\n\r\n            mLine.rtp = mLine.rtp.filter(\r\n                item => keepPts.indexOf(item.payload) !== -1);\r\n            mLine.fmtp = mLine.fmtp.filter(\r\n                item => keepPts.indexOf(item.payload) !== -1);\r\n            if (mLine.rtcpFb) {\r\n                mLine.rtcpFb = mLine.rtcpFb.filter(\r\n                    item => keepPts.indexOf(item.payload) !== -1);\r\n            }\r\n        }\r\n    }\r\n};\r\n\r\nexport default SDPUtil;\r\n","/* global module */\r\n/**\r\n * Enumeration of the media direction types.\r\n * @type {{INACTIVE: string, RECVONLY: string, SENDONLY: string, SENDRECV: string}}\r\n */\r\nconst MediaDirection = {\r\n    /**\r\n     * Media is send and receive is suspended.\r\n     */\r\n    INACTIVE: 'inactive',\r\n\r\n    /**\r\n     * Media is only received from remote peer.\r\n     */\r\n    RECVONLY: 'recvonly',\r\n\r\n    /**\r\n     * Media is only sent to the remote peer.\r\n     */\r\n    SENDONLY: 'sendonly',\r\n\r\n    /**\r\n     * Media is sent and received.\r\n     */\r\n    SENDRECV: 'sendrecv'\r\n};\r\n\r\nmodule.exports = MediaDirection;\r\n","import {getProxiedUrl} from '@models/api/CORS'\r\nimport {getImageSize, uploadToGyazo} from '@models/api/Gyazo'\r\nimport {ContentType, isContentWallpaper, ISharedContent, SharedContentData,\r\n  SharedContentId, TEN_YEAR, TextMessages, TIME_RESOLUTION_IN_MS} from '@models/ISharedContent'\r\nimport {Pose2DMap} from '@models/utils'\r\nimport {extract} from '@models/utils'\r\nimport { getMimeType } from '@models/utils'\r\nimport {MapData} from '@stores/Map'\r\nimport {defaultValue as mapObjectDefaultValue} from '@stores/MapObject'\r\nimport {JitsiLocalTrack} from 'lib-jitsi-meet'\r\nimport _ from 'lodash'\r\nimport participants from '../participants/Participants'\r\nimport sharedContents, {contentLog} from './SharedContents'\r\nimport { PastedContent } from '@components/map/ShareLayer/PastedContent'\r\nimport { Step } from '@components/footer/share/Step'\r\n\r\nexport const defaultContent: ISharedContent = Object.assign({}, mapObjectDefaultValue, {\r\n  name: '',\r\n  ownerName: '',\r\n  color: [],\r\n  textColor: [],\r\n  type: '' as ContentType,\r\n  url: '',\r\n  size: [0, 0] as [number, number],\r\n  originalSize: [0, 0] as [number, number],\r\n  id: '',\r\n  zorder: 0,\r\n  pinned: false,\r\n  shareType: '',\r\n})\r\n\r\nexport function makeThemContents(them: ISharedContent[]) {\r\n  return them\r\n}\r\n\r\nclass SharedContentImp implements ISharedContent {\r\n  name!: string\r\n  ownerName!: string\r\n  color!: number[]\r\n  textColor!: number[]\r\n  type!: ContentType\r\n  url!: string\r\n  id!: string\r\n  zorder!: number\r\n  pinned!: boolean\r\n  pose!: Pose2DMap\r\n  size!: [number, number]\r\n  originalSize!:[number, number]\r\n  noFrame?: boolean\r\n  opacity?: number\r\n  proximity?: boolean\r\n  shareType!: string\r\n  constructor() {\r\n    Object.assign(this, _.cloneDeep(defaultContent))\r\n  }\r\n}\r\n\r\nexport function createContent() {\r\n  const content = new SharedContentImp()\r\n  content.ownerName = participants.local.information.name\r\n  content.color = participants.local.information.color\r\n  content.textColor = participants.local.information.textColor\r\n  content.zorder = Date.now()\r\n  return content\r\n}\r\n\r\nfunction makeItPdf(pasted:ISharedContent, urlStr: string, map:MapData){\r\n  pasted.type = 'pdf'\r\n  pasted.url = urlStr\r\n  pasted.pose.position[0] = map.mouseOnMap[0]\r\n  pasted.pose.position[1] = map.mouseOnMap[1]\r\n  pasted.size[0] = 500\r\n  pasted.size[1] = pasted.size[0] * 1.41421356\r\n}\r\n\r\nexport function createContentOfIframe(urlStr: string, map: MapData) {\r\n  return new Promise<ISharedContent>((resolve, reject) => {\r\n    const pasted = createContent()\r\n    const url = new URL(urlStr)\r\n    if (url.hostname === 'youtu.be' || url.hostname === 'youtube.com' || url.hostname === 'www.youtube.com') {\r\n      const paramStrs = url.search.slice(1).split('&')\r\n      const params = new Map<string, string>(paramStrs.map(str => str.split('=') as [string, string]))\r\n      if (url.hostname === 'youtu.be') {\r\n        params.set('v', url.pathname.slice(1))\r\n      }\r\n      pasted.url = ''\r\n      for (const param of params) {\r\n        if (pasted.url === '') {\r\n          pasted.url = `${param[0]}=${param[1]}`\r\n        }else {\r\n          pasted.url = `${pasted.url}&${param[0]}=${param[1]}`\r\n        }\r\n      }\r\n      pasted.type = 'youtube'\r\n      pasted.pose.position[0] = map.mouseOnMap[0]\r\n      pasted.pose.position[1] = map.mouseOnMap[1]\r\n      pasted.size[0] = 640\r\n      pasted.size[1] = 380\r\n    }else if (url.hostname === 'drive.google.com' || url.hostname === 'docs.google.com') {  //  google drive\r\n      pasted.type = 'gdrive'\r\n      const fileIdStart = url.pathname.slice(url.pathname.indexOf('/d/') + 3)\r\n      const fileId = fileIdStart.slice(0, fileIdStart.indexOf('/'))\r\n      pasted.url = `id=${fileId}`\r\n      pasted.pose.position[0] = map.mouseOnMap[0]\r\n      pasted.pose.position[1] = map.mouseOnMap[1]\r\n      pasted.size[0] = 600\r\n      pasted.size[1] = 800\r\n    }else if (url.hostname === 'wbo.ophir.dev'){  //  whiteboard\r\n      pasted.type = 'whiteboard'\r\n      pasted.url = urlStr\r\n      pasted.pose.position[0] = map.mouseOnMap[0]\r\n      pasted.pose.position[1] = map.mouseOnMap[1]\r\n      pasted.size[0] = 600\r\n      pasted.size[1] = 700\r\n    }else if (url.pathname.substring(url.pathname.length-4) === '.pdf' ||\r\n      url.pathname.substring(url.pathname.length-4) === '.PDF' ){  //  pdf\r\n      makeItPdf(pasted, urlStr, map)\r\n    }else {  //  generic iframe\r\n      //  get mime type first\r\n      getMimeType(getProxiedUrl(urlStr)).then((type)=>{\r\n        if (type==='application/pdf'){\r\n          makeItPdf(pasted, urlStr, map)\r\n          resolve(pasted)\r\n        }\r\n      }).finally(()=>{\r\n        if (!pasted.type){\r\n          pasted.type = 'iframe'\r\n          pasted.url = urlStr\r\n          pasted.pose.position[0] = map.mouseOnMap[0]\r\n          pasted.pose.position[1] = map.mouseOnMap[1]\r\n          pasted.size[0] = 600\r\n          pasted.size[1] = 800\r\n          resolve(pasted)\r\n        }\r\n      })\r\n    }\r\n    if (pasted.type){\r\n      resolve(pasted)\r\n      contentLog(`${pasted.type} created url = ${pasted.url}`)\r\n    }\r\n})\r\n}\r\nexport function createContentOfText(message: string, map: MapData) {\r\n  const pasted = createContent()\r\n  pasted.type = 'text'\r\n  const textMessage = {\r\n    message,\r\n    pid: participants.localId,\r\n    name: participants.local.information.name,\r\n    color: participants.local.information.color,\r\n    textColor: participants.local.information.textColor,\r\n    time: Date.now(),\r\n  }\r\n  const texts: TextMessages = {messages:[textMessage], scroll:[0, 0]}\r\n  pasted.url = JSON.stringify(texts)\r\n  pasted.pose.position[0] = map.mouseOnMap[0]\r\n  pasted.pose.position[1] = map.mouseOnMap[1]\r\n  const slen = Math.ceil(Math.sqrt(message.length))\r\n  const STRING_SCALE_W = 20\r\n  const STRING_SCALE_H = 25\r\n  pasted.size[0] = Math.max(slen * STRING_SCALE_W, 200)\r\n  pasted.size[1] = Math.max(slen * STRING_SCALE_H, slen ? STRING_SCALE_H : STRING_SCALE_H * 3)\r\n\r\n  return pasted\r\n}\r\nexport function createContentOfImage(imageFile: Blob, map: MapData,  offset?:[number, number], _type?:Step)\r\n  : Promise<SharedContentImp> {\r\n  const promise = new Promise<SharedContentImp>((resolutionFunc, rejectionFunc) => {\r\n    uploadToGyazo(imageFile).then((url) => {\r\n      createContentOfImageUrl(url, map, offset, _type).then(resolutionFunc)\r\n    }).catch(rejectionFunc)\r\n  })\r\n\r\n  return promise\r\n}\r\n\r\nexport function createContentOfImageUrl(url: string, map: MapData,\r\n  offset?:[number, number], _type?:Step): Promise<SharedContentImp> {\r\n  const IMAGESIZE_LIMIT = 500\r\n  const promise = new Promise<SharedContentImp>((resolutionFunc, rejectionFunc) => {\r\n    getImageSize(url).then((size) => {\r\n      // console.log(\"mousePos:\" + (global as any).mousePositionOnMap)\r\n      const pasted = createContent()\r\n      console.log(\" TYPE \", _type)\r\n      pasted.type = 'img'\r\n      \r\n      if(_type === \"image\") {\r\n        pasted.shareType = \"img\"\r\n        pasted.noFrame = false\r\n      } else if(_type === \"zoneimage\") {\r\n        pasted.shareType = 'zoneimg'\r\n        pasted.noFrame = true\r\n      }\r\n      pasted.url = url\r\n      const max = size[0] > size[1] ? size[0] : size[1]\r\n      const scale = max > IMAGESIZE_LIMIT ? IMAGESIZE_LIMIT / max : 1\r\n      //pasted.size = [size[0] * scale, size[1] * scale]\r\n      pasted.size = [size[0], size[1]]\r\n      pasted.originalSize = [size[0], size[1]]\r\n      const CENTER = 0.5\r\n      for (let i = 0; i < pasted.pose.position.length; i += 1) {\r\n        if (offset) {\r\n          pasted.pose.position[i] = map.mouseOnMap[i] + offset[i]\r\n        }else {\r\n          pasted.pose.position[i] = map.mouseOnMap[i] - CENTER * pasted.size[i]\r\n        }\r\n      }\r\n      resolutionFunc(pasted)\r\n    })\r\n  })\r\n\r\n  return promise\r\n}\r\n\r\ndeclare const gapi:any    //  google api from index.html\r\nlet GoogleAuth:any        // Google Auth object.\r\n//  let isAuthorized = false\r\nfunction updateSigninStatus(isSignedIn:boolean) {\r\n  if (isSignedIn) {\r\n    //  isAuthorized = true\r\n  } else {\r\n    //isAuthorized = false\r\n  }\r\n}\r\n\r\nexport function createContentOfPdf(file: File, map: MapData, offset?:[number, number]): Promise<SharedContentImp> {\r\n  console.error('createContentOfPdf called.')\r\n  const promise = new Promise<SharedContentImp>((resolutionFunc, rejectionFunc) => {\r\n    if (gapi) {\r\n      const API_KEY = 'AIzaSyCE4B2cKycH0fVmBznwfr1ynnNf2qNEU9M'\r\n      const CLIENT_ID = '188672642721-3f8u1671ecugbl2ukhjmb18nv283upm0.apps.googleusercontent.com'\r\n      gapi.client.init(\r\n        {\r\n          apiKey: API_KEY,\r\n          clientId: CLIENT_ID,\r\n          scope: 'https://www.googleapis.com/auth/drive.appdata',\r\n          discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],\r\n        },\r\n      ).then(\r\n        () => {\r\n          console.log('Before getAuthInstance')\r\n          GoogleAuth = gapi.auth2.getAuthInstance()\r\n          // Listen for sign-in state changes.\r\n          console.log('Before listen updateSigninStatus')\r\n          GoogleAuth.isSignedIn.listen(updateSigninStatus)\r\n        },\r\n        (reason:any) => {\r\n          console.log('gapi.client.init failed:', reason)\r\n        },\r\n      )\r\n    }\r\n  })\r\n\r\n  return promise\r\n}\r\n\r\n\r\nexport function createContentOfVideo(tracks: JitsiLocalTrack[], map: MapData, type:ContentType) {\r\n  const pasted = createContent()\r\n  pasted.type = type\r\n  pasted.url = ''\r\n  pasted.pose.position[0] = map.mouseOnMap[0]\r\n  pasted.pose.position[1] = map.mouseOnMap[1]\r\n  const track = tracks.find(track => track.getType() === 'video')\r\n  const settings = track?.getTrack().getSettings()\r\n  if (settings) {\r\n    pasted.originalSize = [settings.width || 0, settings.height || 0]\r\n  }else {\r\n    pasted.originalSize = [0, 0]\r\n  }\r\n  pasted.size = [(pasted.originalSize[0] || 640) / 2, (pasted.originalSize[1] || 360) / 2]\r\n\r\n  return pasted\r\n}\r\n\r\nconst extractData = extract<SharedContentData>({\r\n  zorder: true, name: true, ownerName: true, color: true, textColor:true,\r\n  type: true, url: true, pose: true, size: true, originalSize: true, pinned: true, noFrame: true, opacity: true, proximity: true, shareType:true\r\n})\r\nexport function extractContentData(c:ISharedContent) {\r\n  return extractData(c)\r\n}\r\nexport function extractContentDatas(cs:ISharedContent[]) {\r\n  return cs.map(extractContentData)\r\n}\r\nconst extractDataAndId = extract<SharedContentData&SharedContentId>({\r\n  zorder: true, name: true, ownerName: true, color: true, textColor:true,\r\n  type: true, url: true, pose: true, size: true, originalSize: true,\r\n  pinned: true, noFrame: true, opacity:true, id: true, proximity: true, shareType:true,\r\n})\r\nexport function extractContentDataAndId(c: ISharedContent) {\r\n  return extractDataAndId(c)\r\n}\r\nexport function extractContentDataAndIds(cs: ISharedContent[]) {\r\n  return cs.map(extractDataAndId)\r\n}\r\n\r\n\r\nfunction execCopy(str: string){\r\n  const temp = document.createElement('textarea')\r\n  temp.value = str\r\n  temp.selectionStart = 0\r\n  temp.selectionEnd = temp.value.length\r\n  const s = temp.style\r\n  s.position = 'fixed'\r\n  s.left = '-100%'\r\n\r\n  document.body.appendChild(temp)\r\n  temp.focus()\r\n  const result = document.execCommand('copy')\r\n  temp.blur()\r\n  document.body.removeChild(temp)\r\n\r\n  return result\r\n}\r\n\r\nexport function copyContentToClipboard(c: ISharedContent){\r\n  if (c.type === 'text'){\r\n    const tms = JSON.parse(c.url) as TextMessages\r\n    const text = tms.messages.length ?\r\n      tms.messages.map(m => m.message).reduce((prev, cur) => prev ? (prev + '\\n') : '' + cur) : ''\r\n    execCopy(text)\r\n  }else if (c.type === 'youtube'){\r\n    const array = c.url.split('&')\r\n    const paramUrl = array.filter(s => {\r\n      const key = s.split('=')[0]\r\n\r\n      return key === 'v' || key === 'list' }\r\n    )\r\n    const param = paramUrl.length ? paramUrl.reduce((pre, cur) => (pre ? pre + '&' : '') + cur) : ''\r\n    execCopy(`https://www.youtube.com/watch?${param}`)\r\n  }else if (c.type === 'gdrive'){\r\n    const params = getParamsFromUrl(c.url)\r\n    const url = getGDriveUrl(true, params)\r\n    execCopy(url)\r\n  }else{\r\n    execCopy(c.url)\r\n  }\r\n}\r\n\r\nexport function isGDrivePreviewScrollable(mimeType?: string) {\r\n  if (!mimeType){ return true }\r\n\r\n  return !(\r\n    mimeType === 'application/vnd.google-apps.presentation'\r\n    || mimeType === 'application/vnd.google-apps.spreadsheet'\r\n    || mimeType.slice(0, 5) === 'image'\r\n    || mimeType.slice(0, 5) === 'video'\r\n    || mimeType.slice(0, 5) === 'audio'\r\n  )\r\n}\r\nexport function getGDriveUrl(editing: boolean, params: Map<string, string>){\r\n  const fileId = params.get('id')\r\n  let mimeType = params.get('mimeType')\r\n  mimeType = mimeType ? mimeType : ''\r\n  const comp = 'application/vnd.google-apps.'\r\n\r\n  let url = `https://drive.google.com/file/d/${fileId}/preview`\r\n  if (editing){\r\n    if (mimeType.substr(0, comp.length) === comp){\r\n      let app = mimeType.substr(comp.length)\r\n      if (app !== 'failed'){\r\n        if (app === 'spreadsheet'){ app = 'spreadsheets' }\r\n        url = `https://docs.google.com/${app}/d/${fileId}/edit`\r\n      }\r\n    }\r\n  }\r\n\r\n  return url\r\n}\r\nexport function getBeforeParamsOfUrl(url: string){\r\n  const start = url.indexOf('?')\r\n\r\n  return start < 0 ? url : url.substring(0, start)\r\n}\r\nexport function getParamsFromUrl(url: string){\r\n  const start = url.indexOf('?')\r\n  const paramStr = start >= 0 ? url.substr(start) : url\r\n  const params = new Map(paramStr.split('&').map(str => str.split('=') as [string, string]))\r\n\r\n  return params\r\n}\r\nexport function getStringFromParams(params: Map<string, string>){\r\n  let url = ''\r\n  params.forEach((val, key) => {\r\n    url = `${url}${url ? '&' : ''}${key}=${val}`\r\n  })\r\n\r\n  return url\r\n}\r\nexport function getInformationOfGDriveContent(fileId: string){\r\n  //  console.log('GAPI try to get mimeType')\r\n  const API_KEY = 'AIzaSyCE4B2cKycH0fVmBznwfr1ynnNf2qNEU9M'\r\n  const rv = new Promise<{name:string, mimeType:string}>((resolve, reject)=>{\r\n    if (gapi){\r\n      gapi.client.setApiKey(API_KEY)\r\n      gapi.client.load('drive', 'v3', () => {\r\n        gapi.client.drive.files.get({\r\n          fileId,\r\n          fields:'mimeType,name',\r\n        })\r\n        .then((result:any) => {\r\n          const body = JSON.parse(result.body)\r\n          //  console.log(`GAPI mimeType:${body.mimeType}  name:${body.name}`)\r\n          resolve({mimeType:body.mimeType, name: body.name})\r\n        }).catch((reason:any) => {\r\n          console.debug('GAPI error', reason)\r\n          reject(reason)\r\n        })\r\n      })\r\n    }else{\r\n      reject('gapi is not loaded')\r\n    }\r\n  })\r\n\r\n  return rv\r\n}\r\n\r\n//  change zorder to the top.\r\nexport function moveContentToTop(c: SharedContentImp) {\r\n  if (isContentWallpaper(c)){\r\n    let top = sharedContents.sorted.findIndex(c => c.zorder > TEN_YEAR)\r\n    if (top < 0){ top = sharedContents.sorted.length }\r\n    top -= 1\r\n    if (top >= 0){\r\n      const order = sharedContents.sorted[top].zorder + 1\r\n      c.zorder = order <= TEN_YEAR ? order : TEN_YEAR\r\n    }\r\n  }else{\r\n    c.zorder = Math.floor(Date.now() / TIME_RESOLUTION_IN_MS)\r\n  }\r\n}\r\n//  change zorder to the bottom.\r\nexport function moveContentToBottom(c: SharedContentImp) {\r\n  if (isContentWallpaper(c)){\r\n    const bottom = sharedContents.sorted[0]\r\n    if (bottom !== c) {\r\n      c.zorder = bottom.zorder - 1\r\n    }\r\n  }else{\r\n    const bottom = sharedContents.sorted.find(c => c.zorder > TEN_YEAR)\r\n    if (!bottom) {\r\n      moveContentToTop(c)\r\n    }else{\r\n      c.zorder = bottom.zorder - 1\r\n    }\r\n  }\r\n}\r\n//  change zorder to far below the bottom.\r\nexport function makeContentWallpaper(c: SharedContentImp, flag: boolean) {\r\n  //if (isContentWallpaper(c)) { return }\r\n  if (flag){\r\n    let zorder = TEN_YEAR - (Math.floor(Date.now() / TIME_RESOLUTION_IN_MS) - c.zorder)\r\n    if (zorder < 0){\r\n      zorder = c.zorder % TEN_YEAR\r\n    }\r\n    c.zorder = zorder\r\n  }else{\r\n    c.zorder = c.zorder + TEN_YEAR\r\n  }\r\n}\r\n","/* global\r\n          __filename,\r\n          MediaStreamTrack,\r\n          RTCIceCandidate: true,\r\n          RTCPeerConnection,\r\n          RTCSessionDescription: true\r\n*/\r\n\r\nimport EventEmitter from 'events';\r\nimport { getLogger } from 'jitsi-meet-logger';\r\nimport clonedeep from 'lodash.clonedeep';\r\n\r\nimport JitsiTrackError from '../../JitsiTrackError';\r\nimport * as JitsiTrackErrors from '../../JitsiTrackErrors';\r\nimport CameraFacingMode from '../../service/RTC/CameraFacingMode';\r\nimport RTCEvents from '../../service/RTC/RTCEvents';\r\nimport Resolutions from '../../service/RTC/Resolutions';\r\nimport VideoType from '../../service/RTC/VideoType';\r\nimport { AVAILABLE_DEVICE } from '../../service/statistics/AnalyticsEvents';\r\nimport browser from '../browser';\r\nimport SDPUtil from '../sdp/SDPUtil';\r\nimport Statistics from '../statistics/statistics';\r\nimport GlobalOnErrorHandler from '../util/GlobalOnErrorHandler';\r\nimport Listenable from '../util/Listenable';\r\n\r\nimport screenObtainer from './ScreenObtainer';\r\n\r\nconst logger = getLogger(__filename);\r\n\r\n// Require adapter only for certain browsers. This is being done for\r\n// react-native, which has its own shims, and while browsers are being migrated\r\n// over to use adapter's shims.\r\nif (browser.usesAdapter()) {\r\n    require('webrtc-adapter');\r\n}\r\n\r\nconst eventEmitter = new EventEmitter();\r\n\r\nconst AVAILABLE_DEVICES_POLL_INTERVAL_TIME = 3000; // ms\r\n\r\n/**\r\n * Default MediaStreamConstraints to use for calls to getUserMedia.\r\n *\r\n * @private\r\n */\r\nconst DEFAULT_CONSTRAINTS = {\r\n    video: {\r\n        height: {\r\n            ideal: 720,\r\n            max: 720,\r\n            min: 180\r\n        },\r\n        width: {\r\n            ideal: 1280,\r\n            max: 1280,\r\n            min: 320\r\n        }\r\n    }\r\n};\r\n\r\n// Currently audio output device change is supported only in Chrome and\r\n// default output always has 'default' device ID\r\nlet audioOutputDeviceId = 'default'; // default device\r\n// whether user has explicitly set a device to use\r\nlet audioOutputChanged = false;\r\n\r\n// Disables all audio processing\r\nlet disableAP = false;\r\n\r\n// Disables Acoustic Echo Cancellation\r\nlet disableAEC = false;\r\n\r\n// Disables Noise Suppression\r\nlet disableNS = false;\r\n\r\n// Disables Automatic Gain Control\r\nlet disableAGC = false;\r\n\r\n// Enables stereo.\r\nlet stereo = null;\r\n\r\nconst featureDetectionAudioEl = document.createElement('audio');\r\nconst isAudioOutputDeviceChangeAvailable\r\n    = typeof featureDetectionAudioEl.setSinkId !== 'undefined';\r\n\r\nlet availableDevices = [];\r\nlet availableDevicesPollTimer;\r\n\r\n/**\r\n * An empty function.\r\n */\r\nfunction emptyFuncton() {\r\n    // no-op\r\n}\r\n\r\n/**\r\n * Creates a constraints object to be passed into a call to getUserMedia.\r\n *\r\n * @param {Array} um - An array of user media types to get. The accepted\r\n * types are \"video\", \"audio\", and \"desktop.\"\r\n * @param {Object} options - Various values to be added to the constraints.\r\n * @param {string} options.cameraDeviceId - The device id for the video\r\n * capture device to get video from.\r\n * @param {Object} options.constraints - Default constraints object to use\r\n * as a base for the returned constraints.\r\n * @param {Object} options.desktopStream - The desktop source id from which\r\n * to capture a desktop sharing video.\r\n * @param {string} options.facingMode - Which direction the camera is\r\n * pointing to.\r\n * @param {string} options.micDeviceId - The device id for the audio capture\r\n * device to get audio from.\r\n * @param {Object} options.frameRate - used only for dekstop sharing.\r\n * @param {Object} options.frameRate.min - Minimum fps\r\n * @param {Object} options.frameRate.max - Maximum fps\r\n * @private\r\n * @returns {Object}\r\n */\r\nfunction getConstraints(um = [], options = {}) {\r\n    // Create a deep copy of the constraints to avoid any modification of\r\n    // the passed in constraints object.\r\n    const constraints = clonedeep(options.constraints || DEFAULT_CONSTRAINTS);\r\n\r\n    if (um.indexOf('video') >= 0) {\r\n        // The \"resolution\" option is a shortcut and takes precendence.\r\n        if (Resolutions[options.resolution]) {\r\n            const r = Resolutions[options.resolution];\r\n\r\n            constraints.video = {\r\n                height: { ideal: r.height },\r\n                width: { ideal: r.width }\r\n            };\r\n        }\r\n\r\n        if (!constraints.video) {\r\n            constraints.video = {};\r\n        }\r\n\r\n        // Override the constraints on Safari because of the following webkit bug.\r\n        // https://bugs.webkit.org/show_bug.cgi?id=210932\r\n        // Camera doesn't start on older macOS versions if min/max constraints are specified.\r\n        // TODO: remove this hack when the bug fix is available on Mojave, Sierra and High Sierra.\r\n        if (browser.isWebKitBased()) {\r\n            if (constraints.video.height && constraints.video.height.ideal) {\r\n                constraints.video.height = { ideal: constraints.video.height.ideal };\r\n            } else {\r\n                logger.warn('Ideal camera height missing, camera may not start properly');\r\n            }\r\n            if (constraints.video.width && constraints.video.width.ideal) {\r\n                constraints.video.width = { ideal: constraints.video.width.ideal };\r\n            } else {\r\n                logger.warn('Ideal camera width missing, camera may not start properly');\r\n            }\r\n        }\r\n        if (options.cameraDeviceId) {\r\n            constraints.video.deviceId = options.cameraDeviceId;\r\n        } else {\r\n            const facingMode = options.facingMode || CameraFacingMode.USER;\r\n\r\n            constraints.video.facingMode = facingMode;\r\n        }\r\n    } else {\r\n        constraints.video = false;\r\n    }\r\n\r\n    if (um.indexOf('audio') >= 0) {\r\n        if (!constraints.audio || typeof constraints.audio === 'boolean') {\r\n            constraints.audio = {};\r\n        }\r\n\r\n        constraints.audio = {\r\n            autoGainControl: !disableAGC && !disableAP,\r\n            deviceId: options.micDeviceId,\r\n            echoCancellation: !disableAEC && !disableAP,\r\n            noiseSuppression: !disableNS && !disableAP\r\n        };\r\n\r\n        if (stereo) {\r\n            Object.assign(constraints.audio, { channelCount: 2 });\r\n        }\r\n    } else {\r\n        constraints.audio = false;\r\n    }\r\n\r\n    return constraints;\r\n}\r\n\r\n/**\r\n * Updates the granted permissions based on the options we requested and the\r\n * streams we received.\r\n * @param um the options we requested to getUserMedia.\r\n * @param stream the stream we received from calling getUserMedia.\r\n */\r\nfunction updateGrantedPermissions(um, stream) {\r\n    const audioTracksReceived\r\n        = Boolean(stream) && stream.getAudioTracks().length > 0;\r\n    const videoTracksReceived\r\n        = Boolean(stream) && stream.getVideoTracks().length > 0;\r\n    const grantedPermissions = {};\r\n\r\n    if (um.indexOf('video') !== -1) {\r\n        grantedPermissions.video = videoTracksReceived;\r\n    }\r\n    if (um.indexOf('audio') !== -1) {\r\n        grantedPermissions.audio = audioTracksReceived;\r\n    }\r\n\r\n    eventEmitter.emit(RTCEvents.PERMISSIONS_CHANGED, grantedPermissions);\r\n}\r\n\r\n/**\r\n * Checks if new list of available media devices differs from previous one.\r\n * @param {MediaDeviceInfo[]} newDevices - list of new devices.\r\n * @returns {boolean} - true if list is different, false otherwise.\r\n */\r\nfunction compareAvailableMediaDevices(newDevices) {\r\n    if (newDevices.length !== availableDevices.length) {\r\n        return true;\r\n    }\r\n\r\n    /* eslint-disable newline-per-chained-call */\r\n\r\n    return (\r\n        newDevices.map(mediaDeviceInfoToJSON).sort().join('')\r\n            !== availableDevices\r\n                .map(mediaDeviceInfoToJSON).sort().join(''));\r\n\r\n    /* eslint-enable newline-per-chained-call */\r\n\r\n    /**\r\n     *\r\n     * @param info\r\n     */\r\n    function mediaDeviceInfoToJSON(info) {\r\n        return JSON.stringify({\r\n            kind: info.kind,\r\n            deviceId: info.deviceId,\r\n            groupId: info.groupId,\r\n            label: info.label,\r\n            facing: info.facing\r\n        });\r\n    }\r\n}\r\n\r\n/**\r\n * Sends analytics event with the passed device list.\r\n *\r\n * @param {Array<MediaDeviceInfo>} deviceList - List with info about the\r\n * available devices.\r\n * @returns {void}\r\n */\r\nfunction sendDeviceListToAnalytics(deviceList) {\r\n    const audioInputDeviceCount\r\n        = deviceList.filter(d => d.kind === 'audioinput').length;\r\n    const audioOutputDeviceCount\r\n        = deviceList.filter(d => d.kind === 'audiooutput').length;\r\n    const videoInputDeviceCount\r\n        = deviceList.filter(d => d.kind === 'videoinput').length;\r\n    const videoOutputDeviceCount\r\n        = deviceList.filter(d => d.kind === 'videooutput').length;\r\n\r\n    deviceList.forEach(device => {\r\n        const attributes = {\r\n            'audio_input_device_count': audioInputDeviceCount,\r\n            'audio_output_device_count': audioOutputDeviceCount,\r\n            'video_input_device_count': videoInputDeviceCount,\r\n            'video_output_device_count': videoOutputDeviceCount,\r\n            'device_id': device.deviceId,\r\n            'device_group_id': device.groupId,\r\n            'device_kind': device.kind,\r\n            'device_label': device.label\r\n        };\r\n\r\n        Statistics.sendAnalytics(AVAILABLE_DEVICE, attributes);\r\n    });\r\n}\r\n\r\n\r\n/**\r\n * Update known devices.\r\n *\r\n * @param {Array<Object>} pds - The new devices.\r\n * @returns {void}\r\n *\r\n * NOTE: Use this function as a shared callback to handle both the devicechange event  and the polling implementations.\r\n * This prevents duplication and works around a chrome bug (verified to occur on 68) where devicechange fires twice in\r\n * a row, which can cause async post devicechange processing to collide.\r\n */\r\nfunction updateKnownDevices(pds) {\r\n    if (compareAvailableMediaDevices(pds)) {\r\n        onMediaDevicesListChanged(pds);\r\n    }\r\n}\r\n\r\n/**\r\n * Event handler for the 'devicechange' event.\r\n *\r\n * @param {MediaDeviceInfo[]} devices - list of media devices.\r\n * @emits RTCEvents.DEVICE_LIST_CHANGED\r\n */\r\nfunction onMediaDevicesListChanged(devicesReceived) {\r\n    availableDevices = devicesReceived.slice(0);\r\n    logger.info('list of media devices has changed:', availableDevices);\r\n\r\n    sendDeviceListToAnalytics(availableDevices);\r\n\r\n    // Used by tracks to update the real device id before the consumer of lib-jitsi-meet receives the new device list.\r\n    eventEmitter.emit(RTCEvents.DEVICE_LIST_WILL_CHANGE, availableDevices);\r\n\r\n    eventEmitter.emit(RTCEvents.DEVICE_LIST_CHANGED, availableDevices);\r\n}\r\n\r\n/**\r\n *\r\n */\r\nclass RTCUtils extends Listenable {\r\n    /**\r\n     *\r\n     */\r\n    constructor() {\r\n        super(eventEmitter);\r\n    }\r\n\r\n    /**\r\n     * Depending on the browser, sets difference instance methods for\r\n     * interacting with user media and adds methods to native WebRTC-related\r\n     * objects. Also creates an instance variable for peer connection\r\n     * constraints.\r\n     *\r\n     * @param {Object} options\r\n     * @returns {void}\r\n     */\r\n    init(options = {}) {\r\n        if (typeof options.disableAEC === 'boolean') {\r\n            disableAEC = options.disableAEC;\r\n            logger.info(`Disable AEC: ${disableAEC}`);\r\n        }\r\n        if (typeof options.disableNS === 'boolean') {\r\n            disableNS = options.disableNS;\r\n            logger.info(`Disable NS: ${disableNS}`);\r\n        }\r\n        if (typeof options.disableAP === 'boolean') {\r\n            disableAP = options.disableAP;\r\n            logger.info(`Disable AP: ${disableAP}`);\r\n        }\r\n        if (typeof options.disableAGC === 'boolean') {\r\n            disableAGC = options.disableAGC;\r\n            logger.info(`Disable AGC: ${disableAGC}`);\r\n        }\r\n        if (typeof options.audioQuality?.stereo === 'boolean') {\r\n            stereo = options.audioQuality.stereo;\r\n            logger.info(`Stereo: ${stereo}`);\r\n        }\r\n\r\n        window.clearInterval(availableDevicesPollTimer);\r\n        availableDevicesPollTimer = undefined;\r\n\r\n        if (browser.isReactNative()) {\r\n            this.RTCPeerConnectionType = RTCPeerConnection;\r\n\r\n            this.attachMediaStream = undefined; // Unused on React Native.\r\n\r\n            this.getStreamID = function({ id }) {\r\n                // The react-native-webrtc implementation that we use at the\r\n                // time of this writing returns a number for the id of\r\n                // MediaStream. Let's just say that a number contains no special\r\n                // characters.\r\n                return (\r\n                    typeof id === 'number'\r\n                        ? id\r\n                        : SDPUtil.filterSpecialChars(id));\r\n            };\r\n            this.getTrackID = ({ id }) => id;\r\n        } else {\r\n            this.RTCPeerConnectionType = RTCPeerConnection;\r\n\r\n            this.attachMediaStream\r\n                = wrapAttachMediaStream((element, stream) => {\r\n                    if (element) {\r\n                        element.srcObject = stream;\r\n                    }\r\n                });\r\n\r\n            this.getStreamID = ({ id }) => id;\r\n            this.getTrackID = ({ id }) => id;\r\n        }\r\n\r\n        this.pcConstraints = browser.isChromiumBased() || browser.isReactNative()\r\n            ? { optional: [\r\n                { googScreencastMinBitrate: 100 },\r\n                { googCpuOveruseDetection: true }\r\n            ] }\r\n            : {};\r\n\r\n        screenObtainer.init(options);\r\n\r\n        if (this.isDeviceListAvailable()) {\r\n            this.enumerateDevices(ds => {\r\n                availableDevices = ds.slice(0);\r\n\r\n                logger.debug('Available devices: ', availableDevices);\r\n                sendDeviceListToAnalytics(availableDevices);\r\n\r\n                eventEmitter.emit(\r\n                    RTCEvents.DEVICE_LIST_AVAILABLE,\r\n                    availableDevices);\r\n\r\n                if (browser.supportsDeviceChangeEvent()) {\r\n                    navigator.mediaDevices.addEventListener(\r\n                        'devicechange',\r\n                        () => this.enumerateDevices(emptyFuncton));\r\n                } else {\r\n                    // Periodically poll enumerateDevices() method to check if\r\n                    // list of media devices has changed.\r\n                    availableDevicesPollTimer = window.setInterval(\r\n                        () => this.enumerateDevices(emptyFuncton),\r\n                        AVAILABLE_DEVICES_POLL_INTERVAL_TIME);\r\n                }\r\n            });\r\n        }\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param {Function} callback\r\n     */\r\n    enumerateDevices(callback) {\r\n        navigator.mediaDevices.enumerateDevices()\r\n            .then(devices => {\r\n                updateKnownDevices(devices);\r\n                callback(devices);\r\n            })\r\n            .catch(error => {\r\n                logger.warn(`Failed to  enumerate devices. ${error}`);\r\n                updateKnownDevices([]);\r\n                callback([]);\r\n            });\r\n    }\r\n\r\n    /**\r\n     * Acquires a media stream via getUserMedia that\r\n     * matches the given constraints\r\n     *\r\n     * @param {array} umDevices which devices to acquire (e.g. audio, video)\r\n     * @param {Object} constraints - Stream specifications to use.\r\n     * @param {number} timeout - The timeout in ms for GUM.\r\n     * @returns {Promise}\r\n     */\r\n    _getUserMedia(umDevices, constraints = {}, timeout = 0) {\r\n        return new Promise((resolve, reject) => {\r\n            let gumTimeout, timeoutExpired = false;\r\n\r\n            if (typeof timeout === 'number' && !isNaN(timeout) && timeout > 0) {\r\n                gumTimeout = setTimeout(() => {\r\n                    timeoutExpired = true;\r\n                    gumTimeout = undefined;\r\n                    reject(new JitsiTrackError(JitsiTrackErrors.TIMEOUT));\r\n                }, timeout);\r\n            }\r\n\r\n            navigator.mediaDevices.getUserMedia(constraints)\r\n                .then(stream => {\r\n                    logger.log('onUserMediaSuccess');\r\n                    updateGrantedPermissions(umDevices, stream);\r\n                    if (!timeoutExpired) {\r\n                        if (typeof gumTimeout !== 'undefined') {\r\n                            clearTimeout(gumTimeout);\r\n                        }\r\n                        resolve(stream);\r\n                    }\r\n                })\r\n                .catch(error => {\r\n                    logger.warn(`Failed to get access to local media. ${error} ${JSON.stringify(constraints)}`);\r\n                    const jitsiError = new JitsiTrackError(error, constraints, umDevices);\r\n\r\n                    if (!timeoutExpired) {\r\n                        if (typeof gumTimeout !== 'undefined') {\r\n                            clearTimeout(gumTimeout);\r\n                        }\r\n                        reject(error);\r\n                    }\r\n\r\n                    if (jitsiError.name === JitsiTrackErrors.PERMISSION_DENIED) {\r\n                        updateGrantedPermissions(umDevices, undefined);\r\n                    }\r\n\r\n                    // else {\r\n                    // Probably the error is not caused by the lack of permissions and we don't need to update them.\r\n                    // }\r\n                });\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Acquire a display stream via the screenObtainer. This requires extra\r\n     * logic compared to use screenObtainer versus normal device capture logic\r\n     * in RTCUtils#_getUserMedia.\r\n     *\r\n     * @returns {Promise} A promise which will be resolved with an object which\r\n     * contains the acquired display stream. If desktop sharing is not supported\r\n     * then a rejected promise will be returned.\r\n     */\r\n    _getDesktopMedia() {\r\n        if (!screenObtainer.isSupported()) {\r\n            return Promise.reject(new Error('Desktop sharing is not supported!'));\r\n        }\r\n\r\n        return new Promise((resolve, reject) => {\r\n            screenObtainer.obtainStream(\r\n                stream => {\r\n                    resolve(stream);\r\n                },\r\n                error => {\r\n                    reject(error);\r\n                });\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Private utility for determining if the passed in MediaStream contains\r\n     * tracks of the type(s) specified in the requested devices.\r\n     *\r\n     * @param {string[]} requestedDevices - The track types that are expected to\r\n     * be includes in the stream.\r\n     * @param {MediaStream} stream - The MediaStream to check if it has the\r\n     * expected track types.\r\n     * @returns {string[]} An array of string with the missing track types. The\r\n     * array will be empty if all requestedDevices are found in the stream.\r\n     */\r\n    _getMissingTracks(requestedDevices = [], stream) {\r\n        const missingDevices = [];\r\n\r\n        const audioDeviceRequested = requestedDevices.includes('audio');\r\n        const audioTracksReceived\r\n            = stream && stream.getAudioTracks().length > 0;\r\n\r\n        if (audioDeviceRequested && !audioTracksReceived) {\r\n            missingDevices.push('audio');\r\n        }\r\n\r\n        const videoDeviceRequested = requestedDevices.includes('video');\r\n        const videoTracksReceived\r\n            = stream && stream.getVideoTracks().length > 0;\r\n\r\n        if (videoDeviceRequested && !videoTracksReceived) {\r\n            missingDevices.push('video');\r\n        }\r\n\r\n        return missingDevices;\r\n    }\r\n\r\n    /**\r\n     * Gets streams from specified device types. This function intentionally\r\n     * ignores errors for upstream to catch and handle instead.\r\n     *\r\n     * @param {Object} options - A hash describing what devices to get and\r\n     * relevant constraints.\r\n     * @param {string[]} options.devices - The types of media to capture. Valid\r\n     * values are \"desktop\", \"audio\", and \"video\".\r\n     * @param {Object} options.desktopSharingFrameRate\r\n     * @param {Object} options.desktopSharingFrameRate.min - Minimum fps\r\n     * @param {Object} options.desktopSharingFrameRate.max - Maximum fps\r\n     * @param {String} options.desktopSharingSourceDevice - The device id or\r\n     * label for a video input source that should be used for screensharing.\r\n     * @returns {Promise} The promise, when successful, will return an array of\r\n     * meta data for the requested device type, which includes the stream and\r\n     * track. If an error occurs, it will be deferred to the caller for\r\n     * handling.\r\n     */\r\n    obtainAudioAndVideoPermissions(options) {\r\n        const {\r\n            timeout,\r\n            ...otherOptions\r\n        } = options;\r\n\r\n        const mediaStreamsMetaData = [];\r\n\r\n        // Declare private functions to be used in the promise chain below.\r\n        // These functions are declared in the scope of this function because\r\n        // they are not being used anywhere else, so only this function needs to\r\n        // know about them.\r\n\r\n        /**\r\n         * Executes a request for desktop media if specified in options.\r\n         *\r\n         * @returns {Promise}\r\n         */\r\n        const maybeRequestDesktopDevice = function() {\r\n            const umDevices = otherOptions.devices || [];\r\n            const isDesktopDeviceRequested\r\n                = umDevices.indexOf('desktop') !== -1;\r\n\r\n            if (!isDesktopDeviceRequested) {\r\n                return Promise.resolve();\r\n            }\r\n\r\n            const {\r\n                desktopSharingSourceDevice\r\n            } = otherOptions;\r\n\r\n            // Attempt to use a video input device as a screenshare source if\r\n            // the option is defined.\r\n            if (desktopSharingSourceDevice) {\r\n                const matchingDevice\r\n                    = availableDevices && availableDevices.find(device =>\r\n                        device.kind === 'videoinput'\r\n                            && (device.deviceId === desktopSharingSourceDevice\r\n                            || device.label === desktopSharingSourceDevice));\r\n\r\n                if (!matchingDevice) {\r\n                    return Promise.reject(new JitsiTrackError(\r\n                        { name: 'ConstraintNotSatisfiedError' },\r\n                        {},\r\n                        [ desktopSharingSourceDevice ]\r\n                    ));\r\n                }\r\n\r\n                const requestedDevices = [ 'video' ];\r\n                const constraints = {\r\n                    video: {\r\n                        deviceId: matchingDevice.deviceId\r\n\r\n                        // frameRate is omited here on purpose since this is a device that we'll pretend is a screen.\r\n                    }\r\n                };\r\n\r\n                return this._getUserMedia(requestedDevices, constraints, timeout)\r\n                    .then(stream => {\r\n                        return {\r\n                            sourceType: 'device',\r\n                            stream\r\n                        };\r\n                    });\r\n            }\r\n\r\n            return this._getDesktopMedia();\r\n        }.bind(this);\r\n\r\n        /**\r\n         * Creates a meta data object about the passed in desktopStream and\r\n         * pushes the meta data to the internal array mediaStreamsMetaData to be\r\n         * returned later.\r\n         *\r\n         * @param {MediaStreamTrack} desktopStream - A track for a desktop\r\n         * capture.\r\n         * @returns {void}\r\n         */\r\n        const maybeCreateAndAddDesktopTrack = function(desktopStream) {\r\n            if (!desktopStream) {\r\n                return;\r\n            }\r\n\r\n            const { stream, sourceId, sourceType } = desktopStream;\r\n\r\n            const desktopAudioTracks = stream.getAudioTracks();\r\n\r\n            if (desktopAudioTracks.length) {\r\n                const desktopAudioStream = new MediaStream(desktopAudioTracks);\r\n\r\n                mediaStreamsMetaData.push({\r\n                    stream: desktopAudioStream,\r\n                    sourceId,\r\n                    sourceType,\r\n                    track: desktopAudioStream.getAudioTracks()[0]\r\n                });\r\n            }\r\n\r\n            const desktopVideoTracks = stream.getVideoTracks();\r\n\r\n            if (desktopVideoTracks.length) {\r\n                const desktopVideoStream = new MediaStream(desktopVideoTracks);\r\n\r\n                mediaStreamsMetaData.push({\r\n                    stream: desktopVideoStream,\r\n                    sourceId,\r\n                    sourceType,\r\n                    track: desktopVideoStream.getVideoTracks()[0],\r\n                    videoType: VideoType.DESKTOP\r\n                });\r\n            }\r\n        };\r\n\r\n        /**\r\n         * Executes a request for audio and/or video, as specified in options.\r\n         * By default both audio and video will be captured if options.devices\r\n         * is not defined.\r\n         *\r\n         * @returns {Promise}\r\n         */\r\n        const maybeRequestCaptureDevices = function() {\r\n            const umDevices = otherOptions.devices || [ 'audio', 'video' ];\r\n            const requestedCaptureDevices = umDevices.filter(device => device === 'audio' || device === 'video');\r\n\r\n            if (!requestedCaptureDevices.length) {\r\n                return Promise.resolve();\r\n            }\r\n\r\n            const constraints = getConstraints(requestedCaptureDevices, otherOptions);\r\n\r\n            logger.info('Got media constraints: ', JSON.stringify(constraints));\r\n\r\n            return this._getUserMedia(requestedCaptureDevices, constraints, timeout);\r\n        }.bind(this);\r\n\r\n        /**\r\n         * Splits the passed in media stream into separate audio and video\r\n         * streams and creates meta data objects for each and pushes them to the\r\n         * internal array mediaStreamsMetaData to be returned later.\r\n         *\r\n         * @param {MediaStreamTrack} avStream - A track for with audio and/or\r\n         * video track.\r\n         * @returns {void}\r\n         */\r\n        const maybeCreateAndAddAVTracks = function(avStream) {\r\n            if (!avStream) {\r\n                return;\r\n            }\r\n\r\n            const audioTracks = avStream.getAudioTracks();\r\n\r\n            if (audioTracks.length) {\r\n                const audioStream = new MediaStream(audioTracks);\r\n\r\n                mediaStreamsMetaData.push({\r\n                    stream: audioStream,\r\n                    track: audioStream.getAudioTracks()[0],\r\n                    effects: otherOptions.effects\r\n                });\r\n            }\r\n\r\n            const videoTracks = avStream.getVideoTracks();\r\n\r\n            if (videoTracks.length) {\r\n                const videoStream = new MediaStream(videoTracks);\r\n\r\n                mediaStreamsMetaData.push({\r\n                    stream: videoStream,\r\n                    track: videoStream.getVideoTracks()[0],\r\n                    videoType: VideoType.CAMERA,\r\n                    effects: otherOptions.effects\r\n                });\r\n            }\r\n        };\r\n\r\n        return maybeRequestDesktopDevice()\r\n            .then(maybeCreateAndAddDesktopTrack)\r\n            .then(maybeRequestCaptureDevices)\r\n            .then(maybeCreateAndAddAVTracks)\r\n            .then(() => mediaStreamsMetaData)\r\n            .catch(error => {\r\n                mediaStreamsMetaData.forEach(({ stream }) => {\r\n                    this.stopMediaStream(stream);\r\n                });\r\n\r\n                return Promise.reject(error);\r\n            });\r\n    }\r\n\r\n    /**\r\n     * Checks whether it is possible to enumerate available cameras/microphones.\r\n     *\r\n     * @returns {boolean} {@code true} if the device listing is available;\r\n     * {@code false}, otherwise.\r\n     */\r\n    isDeviceListAvailable() {\r\n        return Boolean(\r\n            navigator.mediaDevices\r\n                && navigator.mediaDevices.enumerateDevices);\r\n    }\r\n\r\n    /**\r\n     * Returns true if changing the input (camera / microphone) or output\r\n     * (audio) device is supported and false if not.\r\n     * @params {string} [deviceType] - type of device to change. Default is\r\n     *      undefined or 'input', 'output' - for audio output device change.\r\n     * @returns {boolean} true if available, false otherwise.\r\n     */\r\n    isDeviceChangeAvailable(deviceType) {\r\n        return deviceType === 'output' || deviceType === 'audiooutput'\r\n            ? isAudioOutputDeviceChangeAvailable\r\n            : true;\r\n    }\r\n\r\n    /**\r\n     * A method to handle stopping of the stream.\r\n     * One point to handle the differences in various implementations.\r\n     * @param mediaStream MediaStream object to stop.\r\n     */\r\n    stopMediaStream(mediaStream) {\r\n        if (!mediaStream) {\r\n            return;\r\n        }\r\n\r\n        mediaStream.getTracks().forEach(track => {\r\n            if (track.stop) {\r\n                track.stop();\r\n            }\r\n        });\r\n\r\n        // leave stop for implementation still using it\r\n        if (mediaStream.stop) {\r\n            mediaStream.stop();\r\n        }\r\n\r\n        // The MediaStream implementation of the react-native-webrtc project has\r\n        // an explicit release method that is to be invoked in order to release\r\n        // used resources such as memory.\r\n        if (mediaStream.release) {\r\n            mediaStream.release();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Returns whether the desktop sharing is enabled or not.\r\n     * @returns {boolean}\r\n     */\r\n    isDesktopSharingEnabled() {\r\n        return screenObtainer.isSupported();\r\n    }\r\n\r\n    /**\r\n     * Sets current audio output device.\r\n     * @param {string} deviceId - id of 'audiooutput' device from\r\n     *      navigator.mediaDevices.enumerateDevices(), 'default' for default\r\n     *      device\r\n     * @returns {Promise} - resolves when audio output is changed, is rejected\r\n     *      otherwise\r\n     */\r\n    setAudioOutputDevice(deviceId) {\r\n        if (!this.isDeviceChangeAvailable('output')) {\r\n            return Promise.reject(\r\n                new Error('Audio output device change is not supported'));\r\n        }\r\n\r\n        return featureDetectionAudioEl.setSinkId(deviceId)\r\n            .then(() => {\r\n                audioOutputDeviceId = deviceId;\r\n                audioOutputChanged = true;\r\n\r\n                logger.log(`Audio output device set to ${deviceId}`);\r\n\r\n                eventEmitter.emit(RTCEvents.AUDIO_OUTPUT_DEVICE_CHANGED,\r\n                    deviceId);\r\n            });\r\n    }\r\n\r\n    /**\r\n     * Returns currently used audio output device id, '' stands for default\r\n     * device\r\n     * @returns {string}\r\n     */\r\n    getAudioOutputDevice() {\r\n        return audioOutputDeviceId;\r\n    }\r\n\r\n    /**\r\n     * Returns list of available media devices if its obtained, otherwise an\r\n     * empty array is returned/\r\n     * @returns {Array} list of available media devices.\r\n     */\r\n    getCurrentlyAvailableMediaDevices() {\r\n        return availableDevices;\r\n    }\r\n\r\n    /**\r\n     * Returns whether available devices have permissions granted\r\n     * @returns {Boolean}\r\n     */\r\n    arePermissionsGrantedForAvailableDevices() {\r\n        return availableDevices.some(device => Boolean(device.label));\r\n    }\r\n\r\n    /**\r\n     * Returns event data for device to be reported to stats.\r\n     * @returns {MediaDeviceInfo} device.\r\n     */\r\n    getEventDataForActiveDevice(device) {\r\n        const deviceList = [];\r\n        const deviceData = {\r\n            'deviceId': device.deviceId,\r\n            'kind': device.kind,\r\n            'label': device.label,\r\n            'groupId': device.groupId\r\n        };\r\n\r\n        deviceList.push(deviceData);\r\n\r\n        return { deviceList };\r\n    }\r\n\r\n    /**\r\n     * Configures the given PeerConnection constraints to either enable or\r\n     * disable (according to the value of the 'enable' parameter) the\r\n     * 'googSuspendBelowMinBitrate' option.\r\n     * @param constraints the constraints on which to operate.\r\n     * @param enable {boolean} whether to enable or disable the suspend video\r\n     * option.\r\n     */\r\n    setSuspendVideo(constraints, enable) {\r\n        if (!constraints.optional) {\r\n            constraints.optional = [];\r\n        }\r\n\r\n        // Get rid of all \"googSuspendBelowMinBitrate\" constraints (we assume\r\n        // that the elements of constraints.optional contain a single property).\r\n        constraints.optional\r\n            = constraints.optional.filter(\r\n                c => !c.hasOwnProperty('googSuspendBelowMinBitrate'));\r\n\r\n        if (enable) {\r\n            constraints.optional.push({ googSuspendBelowMinBitrate: 'true' });\r\n        }\r\n    }\r\n}\r\n\r\nconst rtcUtils = new RTCUtils();\r\n\r\n/**\r\n * Wraps original attachMediaStream function to set current audio output device\r\n * if this is supported.\r\n * @param {Function} origAttachMediaStream\r\n * @returns {Function}\r\n */\r\nfunction wrapAttachMediaStream(origAttachMediaStream) {\r\n    return function(element, stream) {\r\n        // eslint-disable-next-line prefer-rest-params\r\n        const res = origAttachMediaStream.apply(rtcUtils, arguments);\r\n\r\n        if (stream\r\n                && rtcUtils.isDeviceChangeAvailable('output')\r\n                && stream.getAudioTracks\r\n                && stream.getAudioTracks().length\r\n\r\n                // we skip setting audio output if there was no explicit change\r\n                && audioOutputChanged) {\r\n            element.setSinkId(rtcUtils.getAudioOutputDevice())\r\n                .catch(function(ex) {\r\n                    const err\r\n                        = new JitsiTrackError(ex, null, [ 'audiooutput' ]);\r\n\r\n                    GlobalOnErrorHandler.callUnhandledRejectionHandler({\r\n                        promise: this, // eslint-disable-line no-invalid-this\r\n                        reason: err\r\n                    });\r\n\r\n                    logger.warn(\r\n                        'Failed to set audio output device for the element.'\r\n                            + ' Default audio output device will be used'\r\n                            + ' instead',\r\n                        element,\r\n                        err);\r\n                });\r\n        }\r\n\r\n        return res;\r\n    };\r\n}\r\n\r\nexport default rtcUtils;\r\n","/**\r\n * This utility class defines custom onerror and onunhandledrejection functions.\r\n * The custom error handlers respect the previously-defined error handlers.\r\n * GlobalOnErrorHandler class provides utilities to add many custom error\r\n * handlers and to execute the error handlers directly.\r\n */\r\n\r\n\r\n/**\r\n * List with global error handlers that will be executed.\r\n */\r\nconst handlers = [];\r\n\r\n// If an old handler exists, also fire its events.\r\nconst oldOnErrorHandler = window.onerror;\r\n\r\n/**\r\n * Custom error handler that calls the old global error handler and executes\r\n * all handlers that were previously added.\r\n */\r\nfunction JitsiGlobalErrorHandler(...args) {\r\n    handlers.forEach(handler => handler(...args));\r\n    oldOnErrorHandler && oldOnErrorHandler(...args);\r\n}\r\n\r\n// If an old handler exists, also fire its events.\r\nconst oldOnUnhandledRejection = window.onunhandledrejection;\r\n\r\n/**\r\n * Custom handler that calls the old global handler and executes all handlers\r\n * that were previously added. This handler handles rejected Promises.\r\n */\r\nfunction JitsiGlobalUnhandledRejection(event) {\r\n    handlers.forEach(handler => handler(null, null, null, null, event.reason));\r\n    oldOnUnhandledRejection && oldOnUnhandledRejection(event);\r\n}\r\n\r\n// Setting the custom error handlers.\r\nwindow.onerror = JitsiGlobalErrorHandler;\r\nwindow.onunhandledrejection = JitsiGlobalUnhandledRejection;\r\n\r\nconst GlobalOnErrorHandler = {\r\n    /**\r\n     * Adds new error handlers.\r\n     * @param handler the new handler.\r\n     */\r\n    addHandler(handler) {\r\n        handlers.push(handler);\r\n    },\r\n\r\n    /**\r\n     * Calls the global error handler if there is one.\r\n     * @param error the error to pass to the error handler\r\n     */\r\n    callErrorHandler(error) {\r\n        const errHandler = window.onerror;\r\n\r\n        if (!errHandler) {\r\n            return;\r\n        }\r\n        errHandler(null, null, null, null, error);\r\n    },\r\n\r\n    /**\r\n     * Calls the global rejection handler if there is one.\r\n     * @param error the error to pass to the rejection handler.\r\n     */\r\n    callUnhandledRejectionHandler(error) {\r\n        const errHandler = window.onunhandledrejection;\r\n\r\n        if (!errHandler) {\r\n            return;\r\n        }\r\n        errHandler(error);\r\n    }\r\n};\r\n\r\n\r\nmodule.exports = GlobalOnErrorHandler;\r\n","/* global __filename */\r\n\r\nimport { getLogger } from 'jitsi-meet-logger';\r\n\r\nimport * as JitsiConferenceEvents from '../../JitsiConferenceEvents';\r\nimport * as MediaType from '../../service/RTC/MediaType';\r\nimport RTCEvents from '../../service/RTC/RTCEvents';\r\nimport VideoType from '../../service/RTC/VideoType';\r\nimport browser from '../browser';\r\nimport Statistics from '../statistics/statistics';\r\nimport GlobalOnErrorHandler from '../util/GlobalOnErrorHandler';\r\nimport Listenable from '../util/Listenable';\r\nimport { safeCounterIncrement } from '../util/MathUtil';\r\n\r\nimport BridgeChannel from './BridgeChannel';\r\nimport JitsiLocalTrack from './JitsiLocalTrack';\r\nimport RTCUtils from './RTCUtils';\r\nimport TraceablePeerConnection from './TraceablePeerConnection';\r\n\r\n\r\nconst logger = getLogger(__filename);\r\n\r\n/**\r\n * The counter used to generated id numbers assigned to peer connections\r\n * @type {number}\r\n */\r\nlet peerConnectionIdCounter = 0;\r\n\r\n/**\r\n * The counter used to generate id number for the local\r\n * <code>MediaStreamTrack</code>s.\r\n * @type {number}\r\n */\r\nlet rtcTrackIdCounter = 0;\r\n\r\n/**\r\n * Creates {@code JitsiLocalTrack} instances from the passed in meta information\r\n * about MedieaTracks.\r\n *\r\n * @param {Object[]} mediaStreamMetaData - An array of meta information with\r\n * MediaTrack instances. Each can look like:\r\n * {{\r\n *     stream: MediaStream instance that holds a track with audio or video,\r\n *     track: MediaTrack within the MediaStream,\r\n *     videoType: \"camera\" or \"desktop\" or falsy,\r\n *     sourceId: ID of the desktopsharing source,\r\n *     sourceType: The desktopsharing source type,\r\n *     effects: Array of effect types\r\n * }}\r\n */\r\nfunction _createLocalTracks(mediaStreamMetaData = []) {\r\n    return mediaStreamMetaData.map(metaData => {\r\n        const {\r\n            sourceId,\r\n            sourceType,\r\n            stream,\r\n            track,\r\n            videoType,\r\n            effects\r\n        } = metaData;\r\n\r\n        const { deviceId, facingMode } = track.getSettings();\r\n\r\n        // FIXME Move rtcTrackIdCounter to a static method in JitsiLocalTrack\r\n        // so RTC does not need to handle ID management. This move would be\r\n        // safer to do once the old createLocalTracks is removed.\r\n        rtcTrackIdCounter = safeCounterIncrement(rtcTrackIdCounter);\r\n\r\n        return new JitsiLocalTrack({\r\n            deviceId,\r\n            facingMode,\r\n            mediaType: track.kind,\r\n            rtcId: rtcTrackIdCounter,\r\n            sourceId,\r\n            sourceType,\r\n            stream,\r\n            track,\r\n            videoType: videoType || null,\r\n            effects\r\n        });\r\n    });\r\n}\r\n\r\n/**\r\n *\r\n */\r\nexport default class RTC extends Listenable {\r\n    /**\r\n     *\r\n     * @param conference\r\n     * @param options\r\n     */\r\n    constructor(conference, options = {}) {\r\n        super();\r\n        this.conference = conference;\r\n\r\n        /**\r\n         * A map of active <tt>TraceablePeerConnection</tt>.\r\n         * @type {Map.<number, TraceablePeerConnection>}\r\n         */\r\n        this.peerConnections = new Map();\r\n\r\n        this.localTracks = [];\r\n\r\n        this.options = options;\r\n\r\n        // BridgeChannel instance.\r\n        // @private\r\n        // @type {BridgeChannel}\r\n        this._channel = null;\r\n\r\n        /**\r\n         * The value specified to the last invocation of setLastN before the\r\n         * channel completed opening. If non-null, the value will be sent\r\n         * through a channel (once) as soon as it opens and will then be\r\n         * discarded.\r\n         * @private\r\n         * @type {number}\r\n         */\r\n        this._lastN = undefined;\r\n\r\n        /**\r\n         * Defines the last N endpoints list. It can be null or an array once\r\n         * initialised with a channel last N event.\r\n         * @type {Array<string>|null}\r\n         * @private\r\n         */\r\n        this._lastNEndpoints = null;\r\n\r\n        /**\r\n         * The number representing the maximum video height the local client\r\n         * should receive from the bridge.\r\n         *\r\n         * @type {number|undefined}\r\n         * @private\r\n         */\r\n        this._maxFrameHeight = undefined;\r\n\r\n        /**\r\n         * The endpoint IDs of currently selected participants.\r\n         *\r\n         * @type {Array}\r\n         * @private\r\n         */\r\n        this._selectedEndpoints = null;\r\n\r\n        // The last N change listener.\r\n        this._lastNChangeListener = this._onLastNChanged.bind(this);\r\n\r\n        this._onDeviceListChanged = this._onDeviceListChanged.bind(this);\r\n        this._updateAudioOutputForAudioTracks\r\n            = this._updateAudioOutputForAudioTracks.bind(this);\r\n\r\n        // The default video type assumed by the bridge.\r\n        this._videoType = VideoType.CAMERA;\r\n\r\n        // Switch audio output device on all remote audio tracks. Local audio\r\n        // tracks handle this event by themselves.\r\n        if (RTCUtils.isDeviceChangeAvailable('output')) {\r\n            RTCUtils.addListener(\r\n                RTCEvents.AUDIO_OUTPUT_DEVICE_CHANGED,\r\n                this._updateAudioOutputForAudioTracks\r\n            );\r\n\r\n            RTCUtils.addListener(\r\n                RTCEvents.DEVICE_LIST_CHANGED,\r\n                this._onDeviceListChanged\r\n            );\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Removes any listeners and stored state from this {@code RTC} instance.\r\n     *\r\n     * @returns {void}\r\n     */\r\n    destroy() {\r\n        RTCUtils.removeListener(RTCEvents.AUDIO_OUTPUT_DEVICE_CHANGED, this._updateAudioOutputForAudioTracks);\r\n        RTCUtils.removeListener(RTCEvents.DEVICE_LIST_CHANGED, this._onDeviceListChanged);\r\n\r\n        if (this._channelOpenListener) {\r\n            this.removeListener(\r\n                RTCEvents.DATA_CHANNEL_OPEN,\r\n                this._channelOpenListener\r\n            );\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Exposes the private helper for converting a WebRTC MediaStream to a\r\n     * JitsiLocalTrack.\r\n     *\r\n     * @param {Array<Object>} tracksInfo\r\n     * @returns {Array<JitsiLocalTrack>}\r\n     */\r\n    static createLocalTracks(tracksInfo) {\r\n        return _createLocalTracks(tracksInfo);\r\n    }\r\n\r\n    /**\r\n     * Creates the local MediaStreams.\r\n     * @param {object} [options] Optional parameters.\r\n     * @param {array} options.devices The devices that will be requested.\r\n     * @param {string} options.resolution Resolution constraints.\r\n     * @param {string} options.cameraDeviceId\r\n     * @param {string} options.micDeviceId\r\n     * @returns {*} Promise object that will receive the new JitsiTracks\r\n     */\r\n    static obtainAudioAndVideoPermissions(options) {\r\n        return RTCUtils.obtainAudioAndVideoPermissions(options)\r\n            .then(tracksInfo => _createLocalTracks(tracksInfo));\r\n\r\n    }\r\n\r\n    /**\r\n     * Initializes the bridge channel of this instance.\r\n     * At least one of both, peerconnection or wsUrl parameters, must be\r\n     * given.\r\n     * @param {RTCPeerConnection} [peerconnection] WebRTC peer connection\r\n     * instance.\r\n     * @param {string} [wsUrl] WebSocket URL.\r\n     */\r\n    initializeBridgeChannel(peerconnection, wsUrl) {\r\n        this._channel = new BridgeChannel(peerconnection, wsUrl, this.eventEmitter);\r\n\r\n        this._channelOpenListener = () => {\r\n            const logError = (error, msgType, value) => {\r\n                GlobalOnErrorHandler.callErrorHandler(error);\r\n                logger.error(`Cannot send ${msgType}(${JSON.stringify(value)}) endpoint message`, error);\r\n            };\r\n\r\n            // When the channel becomes available, tell the bridge about video selections so that it can do adaptive\r\n            // simulcast, we want the notification to trigger even if userJid is undefined, or null.\r\n            if (this._receiverVideoConstraints) {\r\n                try {\r\n                    this._channel.sendNewReceiverVideoConstraintsMessage(this._receiverVideoConstraints);\r\n                } catch (error) {\r\n                    logError(error, 'ReceiverVideoConstraints', this._receiverVideoConstraints);\r\n                }\r\n            }\r\n            if (this._selectedEndpoints) {\r\n                try {\r\n                    this._channel.sendSelectedEndpointsMessage(this._selectedEndpoints);\r\n                } catch (error) {\r\n                    logError(error, 'SelectedEndpointsChangedEvent', this._selectedEndpoint);\r\n                }\r\n            }\r\n            if (typeof this._maxFrameHeight !== 'undefined') {\r\n                try {\r\n                    this._channel.sendReceiverVideoConstraintMessage(this._maxFrameHeight);\r\n                } catch (error) {\r\n                    logError(error, 'ReceiverVideoConstraint', this._maxFrameHeight);\r\n                }\r\n            }\r\n            if (typeof this._lastN !== 'undefined' && this._lastN !== -1) {\r\n                try {\r\n                    this._channel.sendSetLastNMessage(this._lastN);\r\n                } catch (error) {\r\n                    logError(error, 'LastNChangedEvent', this._lastN);\r\n                }\r\n            }\r\n            try {\r\n                this._channel.sendVideoTypeMessage(this._videoType);\r\n            } catch (error) {\r\n                logError(error, 'VideoTypeMessage', this._videoType);\r\n            }\r\n\r\n            this.removeListener(RTCEvents.DATA_CHANNEL_OPEN, this._channelOpenListener);\r\n            this._channelOpenListener = null;\r\n        };\r\n        this.addListener(RTCEvents.DATA_CHANNEL_OPEN, this._channelOpenListener);\r\n\r\n        // Add Last N change listener.\r\n        this.addListener(RTCEvents.LASTN_ENDPOINT_CHANGED, this._lastNChangeListener);\r\n    }\r\n\r\n    /**\r\n     * Callback invoked when the list of known audio and video devices has\r\n     * been updated. Attempts to update the known available audio output\r\n     * devices.\r\n     *\r\n     * @private\r\n     * @returns {void}\r\n     */\r\n    _onDeviceListChanged() {\r\n        this._updateAudioOutputForAudioTracks(RTCUtils.getAudioOutputDevice());\r\n    }\r\n\r\n    /**\r\n     * Receives events when Last N had changed.\r\n     * @param {array} lastNEndpoints The new Last N endpoints.\r\n     * @private\r\n     */\r\n    _onLastNChanged(lastNEndpoints = []) {\r\n        const oldLastNEndpoints = this._lastNEndpoints || [];\r\n        let leavingLastNEndpoints = [];\r\n        let enteringLastNEndpoints = [];\r\n\r\n        this._lastNEndpoints = lastNEndpoints;\r\n\r\n        leavingLastNEndpoints = oldLastNEndpoints.filter(\r\n            id => !this.isInLastN(id));\r\n\r\n        enteringLastNEndpoints = lastNEndpoints.filter(\r\n            id => oldLastNEndpoints.indexOf(id) === -1);\r\n\r\n        this.conference.eventEmitter.emit(\r\n            JitsiConferenceEvents.LAST_N_ENDPOINTS_CHANGED,\r\n            leavingLastNEndpoints,\r\n            enteringLastNEndpoints);\r\n    }\r\n\r\n    /**\r\n     * Should be called when current media session ends and after the\r\n     * PeerConnection has been closed using PeerConnection.close() method.\r\n     */\r\n    onCallEnded() {\r\n        if (this._channel) {\r\n            // The BridgeChannel is not explicitly closed as the PeerConnection\r\n            // is closed on call ended which triggers datachannel onclose\r\n            // events. If using a WebSocket, the channel must be closed since\r\n            // it is not managed by the PeerConnection.\r\n            // The reference is cleared to disable any logic related to the\r\n            // channel.\r\n            if (this._channel && this._channel.mode === 'websocket') {\r\n                this._channel.close();\r\n            }\r\n\r\n            this._channel = null;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Sets the receiver video constraints that determine how bitrate is allocated to each of the video streams\r\n     * requested from the bridge. The constraints are cached and sent through the bridge channel once the channel\r\n     * is established.\r\n     * @param {*} constraints\r\n     */\r\n    setNewReceiverVideoConstraints(constraints) {\r\n        this._receiverVideoConstraints = constraints;\r\n\r\n        if (this._channel && this._channel.isOpen()) {\r\n            this._channel.sendNewReceiverVideoConstraintsMessage(constraints);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Sets the maximum video size the local participant should receive from\r\n     * remote participants. Will cache the value and send it through the channel\r\n     * once it is created.\r\n     *\r\n     * @param {number} maxFrameHeightPixels the maximum frame height, in pixels,\r\n     * this receiver is willing to receive.\r\n     * @returns {void}\r\n     */\r\n    setReceiverVideoConstraint(maxFrameHeight) {\r\n        this._maxFrameHeight = maxFrameHeight;\r\n\r\n        if (this._channel && this._channel.isOpen()) {\r\n            this._channel.sendReceiverVideoConstraintMessage(maxFrameHeight);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Sets the video type and availability for the local video source.\r\n     *\r\n     * @param {string} videoType 'camera' for camera, 'desktop' for screenshare and\r\n     * 'none' for when local video source is muted or removed from the peerconnection.\r\n     * @returns {void}\r\n     */\r\n    setVideoType(videoType) {\r\n        if (this._videoType !== videoType) {\r\n            this._videoType = videoType;\r\n\r\n            if (this._channel && this._channel.isOpen()) {\r\n                this._channel.sendVideoTypeMessage(videoType);\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Elects the participants with the given ids to be the selected\r\n     * participants in order to always receive video for this participant (even\r\n     * when last n is enabled). If there is no channel we store it and send it\r\n     * through the channel once it is created.\r\n     *\r\n     * @param {Array<string>} ids - The user ids.\r\n     * @throws NetworkError or InvalidStateError or Error if the operation\r\n     * fails.\r\n     * @returns {void}\r\n     */\r\n    selectEndpoints(ids) {\r\n        this._selectedEndpoints = ids;\r\n\r\n        if (this._channel && this._channel.isOpen()) {\r\n            this._channel.sendSelectedEndpointsMessage(ids);\r\n        }\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param eventType\r\n     * @param listener\r\n     */\r\n    static addListener(eventType, listener) {\r\n        RTCUtils.addListener(eventType, listener);\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param eventType\r\n     * @param listener\r\n     */\r\n    static removeListener(eventType, listener) {\r\n        RTCUtils.removeListener(eventType, listener);\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param options\r\n     */\r\n    static init(options = {}) {\r\n        this.options = options;\r\n\r\n        return RTCUtils.init(this.options);\r\n    }\r\n\r\n    /* eslint-disable max-params */\r\n\r\n    /**\r\n     * Creates new <tt>TraceablePeerConnection</tt>\r\n     * @param {SignalingLayer} signaling The signaling layer that will\r\n     *      provide information about the media or participants which is not\r\n     *      carried over SDP.\r\n     * @param {object} iceConfig An object describing the ICE config like\r\n     *      defined in the WebRTC specification.\r\n     * @param {boolean} isP2P Indicates whether or not the new TPC will be used\r\n     *      in a peer to peer type of session.\r\n     * @param {object} options The config options.\r\n     * @param {boolean} options.enableInsertableStreams - Set to true when the insertable streams constraints is to be\r\n     * enabled on the PeerConnection.\r\n     * @param {boolean} options.disableSimulcast If set to 'true' will disable\r\n     *      the simulcast.\r\n     * @param {boolean} options.disableRtx If set to 'true' will disable the\r\n     *      RTX.\r\n     * @param {boolean} options.disableH264 If set to 'true' H264 will be\r\n     *      disabled by removing it from the SDP.\r\n     * @param {boolean} options.preferH264 If set to 'true' H264 will be\r\n     *      preferred over other video codecs.\r\n     * @param {boolean} options.startSilent If set to 'true' no audio will be sent or received.\r\n     * @return {TraceablePeerConnection}\r\n     */\r\n    createPeerConnection(signaling, iceConfig, isP2P, options) {\r\n        const pcConstraints = JSON.parse(JSON.stringify(RTCUtils.pcConstraints));\r\n\r\n        if (typeof options.abtestSuspendVideo !== 'undefined') {\r\n            RTCUtils.setSuspendVideo(pcConstraints, options.abtestSuspendVideo);\r\n\r\n            Statistics.analytics.addPermanentProperties(\r\n                { abtestSuspendVideo: options.abtestSuspendVideo });\r\n        }\r\n\r\n        // FIXME: We should rename iceConfig to pcConfig.\r\n\r\n        if (options.enableInsertableStreams) {\r\n            logger.debug('E2EE - setting insertable streams constraints');\r\n            iceConfig.encodedInsertableStreams = true;\r\n            iceConfig.forceEncodedAudioInsertableStreams = true; // legacy, to be removed in M88.\r\n            iceConfig.forceEncodedVideoInsertableStreams = true; // legacy, to be removed in M88.\r\n        }\r\n\r\n        const supportsSdpSemantics = browser.isReactNative()\r\n            || (browser.isChromiumBased() && !options.usesUnifiedPlan);\r\n\r\n        if (supportsSdpSemantics) {\r\n            iceConfig.sdpSemantics = 'plan-b';\r\n        }\r\n\r\n        if (options.forceTurnRelay) {\r\n            iceConfig.iceTransportPolicy = 'relay';\r\n        }\r\n\r\n        // Set the RTCBundlePolicy to max-bundle so that only one set of ice candidates is generated.\r\n        // The default policy generates separate ice candidates for audio and video connections.\r\n        // This change is necessary for Unified plan to work properly on Chrome and Safari.\r\n        iceConfig.bundlePolicy = 'max-bundle';\r\n\r\n        peerConnectionIdCounter = safeCounterIncrement(peerConnectionIdCounter);\r\n\r\n        const newConnection\r\n            = new TraceablePeerConnection(\r\n                this,\r\n                peerConnectionIdCounter,\r\n                signaling,\r\n                iceConfig, pcConstraints,\r\n                isP2P, options);\r\n\r\n        this.peerConnections.set(newConnection.id, newConnection);\r\n\r\n        return newConnection;\r\n    }\r\n\r\n    /* eslint-enable max-params */\r\n\r\n    /**\r\n     * Removed given peer connection from this RTC module instance.\r\n     * @param {TraceablePeerConnection} traceablePeerConnection\r\n     * @return {boolean} <tt>true</tt> if the given peer connection was removed\r\n     * successfully or <tt>false</tt> if there was no peer connection mapped in\r\n     * this RTC instance.\r\n     */\r\n    _removePeerConnection(traceablePeerConnection) {\r\n        const id = traceablePeerConnection.id;\r\n\r\n        if (this.peerConnections.has(id)) {\r\n            // NOTE Remote tracks are not removed here.\r\n            this.peerConnections.delete(id);\r\n\r\n            return true;\r\n        }\r\n\r\n        return false;\r\n\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param track\r\n     */\r\n    addLocalTrack(track) {\r\n        if (!track) {\r\n            throw new Error('track must not be null nor undefined');\r\n        }\r\n\r\n        this.localTracks.push(track);\r\n\r\n        track.conference = this.conference;\r\n    }\r\n\r\n    /**\r\n     * Get local video track.\r\n     * @returns {JitsiLocalTrack|undefined}\r\n     */\r\n    getLocalVideoTrack() {\r\n        const localVideo = this.getLocalTracks(MediaType.VIDEO);\r\n\r\n\r\n        return localVideo.length ? localVideo[0] : undefined;\r\n    }\r\n\r\n    /**\r\n     * Get local audio track.\r\n     * @returns {JitsiLocalTrack|undefined}\r\n     */\r\n    getLocalAudioTrack() {\r\n        const localAudio = this.getLocalTracks(MediaType.AUDIO);\r\n\r\n\r\n        return localAudio.length ? localAudio[0] : undefined;\r\n    }\r\n\r\n    /**\r\n     * Returns the endpoint id for the local user.\r\n     * @returns {string}\r\n     */\r\n    getLocalEndpointId() {\r\n        return this.conference.myUserId();\r\n    }\r\n\r\n    /**\r\n     * Returns the local tracks of the given media type, or all local tracks if\r\n     * no specific type is given.\r\n     * @param {MediaType} [mediaType] Optional media type filter.\r\n     * (audio or video).\r\n     */\r\n    getLocalTracks(mediaType) {\r\n        let tracks = this.localTracks.slice();\r\n\r\n        if (mediaType !== undefined) {\r\n            tracks = tracks.filter(\r\n                track => track.getType() === mediaType);\r\n        }\r\n\r\n        return tracks;\r\n    }\r\n\r\n    /**\r\n     * Obtains all remote tracks currently known to this RTC module instance.\r\n     * @param {MediaType} [mediaType] The remote tracks will be filtered\r\n     *      by their media type if this argument is specified.\r\n     * @return {Array<JitsiRemoteTrack>}\r\n     */\r\n    getRemoteTracks(mediaType) {\r\n        let remoteTracks = [];\r\n\r\n        for (const tpc of this.peerConnections.values()) {\r\n            const pcRemoteTracks = tpc.getRemoteTracks(undefined, mediaType);\r\n\r\n            if (pcRemoteTracks) {\r\n                remoteTracks = remoteTracks.concat(pcRemoteTracks);\r\n            }\r\n        }\r\n\r\n        return remoteTracks;\r\n    }\r\n\r\n    /**\r\n     * Set mute for all local audio streams attached to the conference.\r\n     * @param value The mute value.\r\n     * @returns {Promise}\r\n     */\r\n    setAudioMute(value) {\r\n        const mutePromises = [];\r\n\r\n        this.getLocalTracks(MediaType.AUDIO).forEach(audioTrack => {\r\n            // this is a Promise\r\n            mutePromises.push(value ? audioTrack.mute() : audioTrack.unmute());\r\n        });\r\n\r\n        // We return a Promise from all Promises so we can wait for their\r\n        // execution.\r\n        return Promise.all(mutePromises);\r\n    }\r\n\r\n    /**\r\n    * Set mute for all local video streams attached to the conference.\r\n    * @param value The mute value.\r\n    * @returns {Promise}\r\n    */\r\n    setVideoMute(value) {\r\n        const mutePromises = [];\r\n\r\n        this.getLocalTracks(MediaType.VIDEO).concat(this.getLocalTracks(MediaType.PRESENTER))\r\n            .forEach(videoTrack => {\r\n                // this is a Promise\r\n                mutePromises.push(value ? videoTrack.mute() : videoTrack.unmute());\r\n            });\r\n\r\n        // We return a Promise from all Promises so we can wait for their\r\n        // execution.\r\n        return Promise.all(mutePromises);\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param track\r\n     */\r\n    removeLocalTrack(track) {\r\n        const pos = this.localTracks.indexOf(track);\r\n\r\n        if (pos === -1) {\r\n            return;\r\n        }\r\n\r\n        this.localTracks.splice(pos, 1);\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param elSelector\r\n     * @param stream\r\n     */\r\n    static attachMediaStream(elSelector, stream) {\r\n        return RTCUtils.attachMediaStream(elSelector, stream);\r\n    }\r\n\r\n    /**\r\n     * Returns the id of the given stream.\r\n     * @param {MediaStream} stream\r\n     */\r\n    static getStreamID(stream) {\r\n        return RTCUtils.getStreamID(stream);\r\n    }\r\n\r\n    /**\r\n     * Returns the id of the given track.\r\n     * @param {MediaStreamTrack} track\r\n     */\r\n    static getTrackID(track) {\r\n        return RTCUtils.getTrackID(track);\r\n    }\r\n\r\n    /**\r\n     * Returns true if retrieving the list of input devices is supported\r\n     * and false if not.\r\n     */\r\n    static isDeviceListAvailable() {\r\n        return RTCUtils.isDeviceListAvailable();\r\n    }\r\n\r\n    /**\r\n     * Returns true if changing the input (camera / microphone) or output\r\n     * (audio) device is supported and false if not.\r\n     * @param {string} [deviceType] Type of device to change. Default is\r\n     *      undefined or 'input', 'output' - for audio output device change.\r\n     * @returns {boolean} true if available, false otherwise.\r\n     */\r\n    static isDeviceChangeAvailable(deviceType) {\r\n        return RTCUtils.isDeviceChangeAvailable(deviceType);\r\n    }\r\n\r\n    /**\r\n     * Returns whether the current execution environment supports WebRTC (for\r\n     * use within this library).\r\n     *\r\n     * @returns {boolean} {@code true} if WebRTC is supported in the current\r\n     * execution environment (for use within this library); {@code false},\r\n     * otherwise.\r\n     */\r\n    static isWebRtcSupported() {\r\n        return browser.isSupported();\r\n    }\r\n\r\n    /**\r\n     * Returns currently used audio output device id, '' stands for default\r\n     * device\r\n     * @returns {string}\r\n     */\r\n    static getAudioOutputDevice() {\r\n        return RTCUtils.getAudioOutputDevice();\r\n    }\r\n\r\n    /**\r\n     * Returns list of available media devices if its obtained, otherwise an\r\n     * empty array is returned/\r\n     * @returns {array} list of available media devices.\r\n     */\r\n    static getCurrentlyAvailableMediaDevices() {\r\n        return RTCUtils.getCurrentlyAvailableMediaDevices();\r\n    }\r\n\r\n    /**\r\n     * Returns whether available devices have permissions granted\r\n     * @returns {Boolean}\r\n     */\r\n    static arePermissionsGrantedForAvailableDevices() {\r\n        return RTCUtils.arePermissionsGrantedForAvailableDevices();\r\n    }\r\n\r\n    /**\r\n     * Returns event data for device to be reported to stats.\r\n     * @returns {MediaDeviceInfo} device.\r\n     */\r\n    static getEventDataForActiveDevice(device) {\r\n        return RTCUtils.getEventDataForActiveDevice(device);\r\n    }\r\n\r\n    /**\r\n     * Sets current audio output device.\r\n     * @param {string} deviceId Id of 'audiooutput' device from\r\n     *      navigator.mediaDevices.enumerateDevices().\r\n     * @returns {Promise} resolves when audio output is changed, is rejected\r\n     *      otherwise\r\n     */\r\n    static setAudioOutputDevice(deviceId) {\r\n        return RTCUtils.setAudioOutputDevice(deviceId);\r\n    }\r\n\r\n    /**\r\n     * Returns <tt>true<tt/> if given WebRTC MediaStream is considered a valid\r\n     * \"user\" stream which means that it's not a \"receive only\" stream nor a\r\n     * \"mixed\" JVB stream.\r\n     *\r\n     * Clients that implement Unified Plan, such as Firefox use recvonly\r\n     * \"streams/channels/tracks\" for receiving remote stream/tracks, as opposed\r\n     * to Plan B where there are only 3 channels: audio, video and data.\r\n     *\r\n     * @param {MediaStream} stream The WebRTC MediaStream instance.\r\n     * @returns {boolean}\r\n     */\r\n    static isUserStream(stream) {\r\n        return RTC.isUserStreamById(RTCUtils.getStreamID(stream));\r\n    }\r\n\r\n    /**\r\n     * Returns <tt>true<tt/> if a WebRTC MediaStream identified by given stream\r\n     * ID is considered a valid \"user\" stream which means that it's not a\r\n     * \"receive only\" stream nor a \"mixed\" JVB stream.\r\n     *\r\n     * Clients that implement Unified Plan, such as Firefox use recvonly\r\n     * \"streams/channels/tracks\" for receiving remote stream/tracks, as opposed\r\n     * to Plan B where there are only 3 channels: audio, video and data.\r\n     *\r\n     * @param {string} streamId The id of WebRTC MediaStream.\r\n     * @returns {boolean}\r\n     */\r\n    static isUserStreamById(streamId) {\r\n        return streamId && streamId !== 'mixedmslabel'\r\n            && streamId !== 'default';\r\n    }\r\n\r\n    /**\r\n     * Allows to receive list of available cameras/microphones.\r\n     * @param {function} callback Would receive array of devices as an\r\n     *      argument.\r\n     */\r\n    static enumerateDevices(callback) {\r\n        RTCUtils.enumerateDevices(callback);\r\n    }\r\n\r\n    /**\r\n     * A method to handle stopping of the stream.\r\n     * One point to handle the differences in various implementations.\r\n     * @param {MediaStream} mediaStream MediaStream object to stop.\r\n     */\r\n    static stopMediaStream(mediaStream) {\r\n        RTCUtils.stopMediaStream(mediaStream);\r\n    }\r\n\r\n    /**\r\n     * Returns whether the desktop sharing is enabled or not.\r\n     * @returns {boolean}\r\n     */\r\n    static isDesktopSharingEnabled() {\r\n        return RTCUtils.isDesktopSharingEnabled();\r\n    }\r\n\r\n    /**\r\n     * Closes the currently opened bridge channel.\r\n     */\r\n    closeBridgeChannel() {\r\n        if (this._channel) {\r\n            this._channel.close();\r\n            this._channel = null;\r\n\r\n            this.removeListener(RTCEvents.LASTN_ENDPOINT_CHANGED, this._lastNChangeListener);\r\n        }\r\n    }\r\n\r\n    /* eslint-disable max-params */\r\n    /**\r\n     *\r\n     * @param {TraceablePeerConnection} tpc\r\n     * @param {number} ssrc\r\n     * @param {number} audioLevel\r\n     * @param {boolean} isLocal\r\n     */\r\n    setAudioLevel(tpc, ssrc, audioLevel, isLocal) {\r\n        const track = tpc.getTrackBySSRC(ssrc);\r\n\r\n        if (!track) {\r\n            return;\r\n        } else if (!track.isAudioTrack()) {\r\n            logger.warn(`Received audio level for non-audio track: ${ssrc}`);\r\n\r\n            return;\r\n        } else if (track.isLocal() !== isLocal) {\r\n            logger.error(\r\n                `${track} was expected to ${isLocal ? 'be' : 'not be'} local`);\r\n        }\r\n\r\n        track.setAudioLevel(audioLevel, tpc);\r\n    }\r\n\r\n    /**\r\n     * Sends message via the bridge channel.\r\n     * @param {string} to The id of the endpoint that should receive the\r\n     *      message. If \"\" the message will be sent to all participants.\r\n     * @param {object} payload The payload of the message.\r\n     * @throws NetworkError or InvalidStateError or Error if the operation\r\n     * fails or there is no data channel created.\r\n     */\r\n    sendChannelMessage(to, payload) {\r\n        if (this._channel) {\r\n            this._channel.sendMessage(to, payload);\r\n        } else {\r\n            throw new Error('Channel support is disabled!');\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Sends the local stats via the bridge channel.\r\n     * @param {Object} payload The payload of the message.\r\n     * @throws NetworkError/InvalidStateError/Error if the operation fails or if there is no data channel created.\r\n     */\r\n    sendEndpointStatsMessage(payload) {\r\n        if (this._channel && this._channel.isOpen()) {\r\n            this._channel.sendEndpointStatsMessage(payload);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Selects a new value for \"lastN\". The requested amount of videos are going\r\n     * to be delivered after the value is in effect. Set to -1 for unlimited or\r\n     * all available videos.\r\n     * @param {number} value the new value for lastN.\r\n     */\r\n    setLastN(value) {\r\n        if (this._lastN !== value) {\r\n            this._lastN = value;\r\n            if (this._channel && this._channel.isOpen()) {\r\n                this._channel.sendSetLastNMessage(value);\r\n            }\r\n            this.eventEmitter.emit(RTCEvents.LASTN_VALUE_CHANGED, value);\r\n        }\r\n    }\r\n\r\n    setPerceptibles(value){\r\n        if (this._channel && this._channel.isOpen()) {\r\n            this._channel.sendSetPercieveEventMessage(value);\r\n        }\r\n        this.eventEmitter.emit(RTCEvents.PERCEPTIBLES_CHANGED, value);\r\n    }\r\n\r\n    /**\r\n     * Indicates if the endpoint id is currently included in the last N.\r\n     * @param {string} id The endpoint id that we check for last N.\r\n     * @returns {boolean} true if the endpoint id is in the last N or if we\r\n     * don't have bridge channel support, otherwise we return false.\r\n     */\r\n    isInLastN(id) {\r\n        return !this._lastNEndpoints // lastNEndpoints not initialised yet.\r\n            || this._lastNEndpoints.indexOf(id) > -1;\r\n    }\r\n\r\n    /**\r\n     * Updates the target audio output device for all remote audio tracks.\r\n     *\r\n     * @param {string} deviceId - The device id of the audio ouput device to\r\n     * use for all remote tracks.\r\n     * @private\r\n     * @returns {void}\r\n     */\r\n    _updateAudioOutputForAudioTracks(deviceId) {\r\n        const remoteAudioTracks = this.getRemoteTracks(MediaType.AUDIO);\r\n\r\n        for (const track of remoteAudioTracks) {\r\n            track.setAudioOutput(deviceId);\r\n        }\r\n    }\r\n}\r\n","/* global module */\r\n/**\r\n * Enumeration of the video types\r\n * @type {{CAMERA: string, DESKTOP: string, NONE: string}}\r\n */\r\nconst VideoType = {\r\n    /**\r\n     * The camera video type.\r\n     */\r\n    CAMERA: 'camera',\r\n\r\n    /**\r\n     * The desktop video type.\r\n     */\r\n    DESKTOP: 'desktop',\r\n\r\n    /**\r\n     * No local video source.\r\n     */\r\n    NONE: 'none'\r\n};\r\n\r\nmodule.exports = VideoType;\r\n","/**\r\n * The errors for the JitsiTrack objects.\r\n */\r\n\r\n/**\r\n * An error which indicates that some of requested constraints in\r\n * getUserMedia call were not satisfied.\r\n */\r\nexport const CONSTRAINT_FAILED = 'gum.constraint_failed';\r\n\r\n/**\r\n * A generic error which indicates an error occurred while selecting\r\n * a DesktopCapturerSource from the electron app.\r\n */\r\nexport const ELECTRON_DESKTOP_PICKER_ERROR\r\n    = 'gum.electron_desktop_picker_error';\r\n\r\n/**\r\n * An error which indicates a custom desktop picker could not be detected\r\n * for the electron app.\r\n */\r\nexport const ELECTRON_DESKTOP_PICKER_NOT_FOUND\r\n    = 'gum.electron_desktop_picker_not_found';\r\n\r\n/**\r\n * Generic getUserMedia error.\r\n */\r\nexport const GENERAL = 'gum.general';\r\n\r\n/**\r\n * An error which indicates that requested device was not found.\r\n */\r\nexport const NOT_FOUND = 'gum.not_found';\r\n\r\n/**\r\n * An error which indicates that user denied permission to share requested\r\n * device.\r\n */\r\nexport const PERMISSION_DENIED = 'gum.permission_denied';\r\n\r\n/**\r\n * Generic error for screensharing failure.\r\n */\r\nexport const SCREENSHARING_GENERIC_ERROR\r\n    = 'gum.screensharing_generic_error';\r\n\r\n/**\r\n * An error which indicates that user canceled screen sharing window\r\n * selection dialog.\r\n */\r\nexport const SCREENSHARING_USER_CANCELED\r\n    = 'gum.screensharing_user_canceled';\r\n\r\n\r\n/**\r\n * Indicates that the timeout passed to the obtainAudioAndVideoPermissions has expired without GUM resolving.\r\n */\r\nexport const TIMEOUT = 'gum.timeout';\r\n\r\n/**\r\n * An error which indicates that track has been already disposed and cannot\r\n * be longer used.\r\n */\r\nexport const TRACK_IS_DISPOSED = 'track.track_is_disposed';\r\n\r\n/**\r\n * An error which indicates that track has no MediaStream associated.\r\n */\r\nexport const TRACK_NO_STREAM_FOUND = 'track.no_stream_found';\r\n\r\n/**\r\n * An error which indicates that requested video resolution is not supported\r\n * by a webcam.\r\n */\r\nexport const UNSUPPORTED_RESOLUTION = 'gum.unsupported_resolution';\r\n","import {Pose2DMap} from '@models/utils/coordinates'\r\nimport {MapObject} from './MapObject'\r\n\r\nexport type ContentType = 'img' | \"zoneimg\" | 'text' | 'pdf' | 'youtube' | 'iframe' | 'screen' | 'camera' |\r\n  'gdrive' | 'whiteboard' | ''\r\n\r\nexport interface SharedContentInfoData {\r\n  name: string                    //  name or title of the content.\r\n  ownerName: string               //  name of the initial owner\r\n  color:number[]                  //  color in the left var\r\n  textColor:number[]              //  textColor in the left var\r\n  type: ContentType               //  content type ('img', etc)\r\n  shareType:string                // share type\r\n}\r\nexport interface SharedContentId{\r\n  id: string                      //  unique ID (generated by participant id + number)\r\n}\r\nexport interface SharedContentInfo extends SharedContentInfoData, SharedContentId{\r\n}\r\nexport function isEqualSharedContentInfo(a:SharedContentInfo, b:SharedContentInfo){\r\n  return a.name === b.name && a.ownerName === b.ownerName\r\n    && a.color.toString() === b.color.toString() && a.textColor.toString() === b.textColor.toString()\r\n}\r\nexport function extractSharedContentInfo(c: SharedContentInfo){\r\n  const rv:SharedContentInfo = {id:c.id, name: c.name, ownerName: c.ownerName,\r\n    color:c.color, textColor: c.textColor, type: c.type, shareType: c.shareType}\r\n\r\n  return rv\r\n}\r\n\r\nexport interface SharedContentData extends SharedContentInfoData {\r\n  zorder: number                  //  unix timestamp when shared or moved to top.\r\n  url: string                     //  url or text to share\r\n  pose: Pose2DMap                 //  position and orientation\r\n  size: [number, number]          //  current size of the content\r\n  originalSize: [number, number]  //  original size of the content or [0, 0]\r\n  pinned: boolean                 //  pinned (not resizable or resizable)\r\n  noFrame?: boolean               //  no (invisible) frame\r\n  opacity?: number                //  opacity\r\n  proximity?: boolean             // proximity\r\n}\r\n\r\nexport interface ISharedContent extends MapObject, SharedContentData, SharedContentId {\r\n  zIndex?: number\r\n}\r\n\r\nexport const TIME_RESOLUTION_IN_MS = 100\r\nexport const TEN_YEAR = 1000 * 60 * 60 * 24 * 365 * 10 / TIME_RESOLUTION_IN_MS\r\n\r\n//  Does content use keyinput during editing or not.\r\nexport function doseContentEditingUseKeyinput(c: ISharedContent){\r\n  return c.type === 'text' || c.type === 'pdf'\r\n}\r\n//  can this type of content be a wall paper or not\r\nexport function canContentBeAWallpaper(c?: ISharedContent){\r\n  return c && (c.type !== 'camera' && c.type !== 'screen')\r\n}\r\n//  editable or not\r\nexport function isContentEditable(c?: ISharedContent) {\r\n  return c && (c.type === 'text' || c.type === 'iframe' || c.type === 'pdf' ||\r\n    c.type === 'whiteboard' || c.type === 'gdrive' || c.type === 'youtube')\r\n}\r\n//  wallpaper or not\r\nexport function isContentWallpaper(c?: ISharedContent) {\r\n  return c && c.zorder <= TEN_YEAR\r\n}\r\n\r\nexport const CONTENT_OUT_OF_RANGE_VALUE = 1024*1024\r\nexport function isContentOutOfRange(c?: ISharedContent) {\r\n  return !c || c.pose.position[0] === CONTENT_OUT_OF_RANGE_VALUE\r\n}\r\n\r\n\r\nexport interface WallpaperStore {\r\n  room: string\r\n  contents: SharedContentData[]\r\n}\r\n\r\nexport interface TextMessage {\r\n  message: string, //  text to display\r\n  name: string, //  The name of whom create this text\r\n  color?:number[]        //  background color\r\n  textColor?:number[]    //  textColor\r\n  pid: string,  //  The pid of whom create this text\r\n  time: number, //  Timestamp when this message created.\r\n}\r\nexport interface TextMessages {\r\n  messages: TextMessage[]\r\n  scroll: [number, number]\r\n}\r\n\r\nexport function compTextMessage(t1: TextMessage, t2: TextMessage) {\r\n  return t1.time - t2.time\r\n}\r\n","import {JitsiTrack} from 'lib-jitsi-meet'\r\nimport {MapObject} from './MapObject'\r\nimport {findReverseColorRGB, findTextColorRGB, getRandomColorRGB, rgb2Color} from './utils/color'\r\nimport {Mouse} from './utils/coordinates'\r\n\r\nexport const PARTICIPANT_SIZE = 60\r\n\r\nexport interface ParticipantBase extends MapObject{\r\n  physics: Physics\r\n  tracks: Tracks\r\n  mouse: Mouse\r\n  id: string\r\n  information: RemoteInformation|LocalInformation\r\n}\r\n\r\nexport interface RemoteParticipant extends ParticipantBase {\r\n  informationReceived: boolean\r\n}\r\n\r\nexport type SoundLocalizationBase = 'avatar' | 'user'\r\nexport interface LocalParticipant extends ParticipantBase {\r\n  soundLocalizationBase: SoundLocalizationBase\r\n  information: LocalInformation\r\n}\r\nexport type Participant = LocalParticipant | RemoteParticipant\r\n\r\nexport interface BaseInformation {\r\n  name: string\r\n  avatarSrc: string\r\n  color: number[]\r\n  textColor: number[]\r\n}\r\nexport interface RemoteInformation extends BaseInformation{\r\n}\r\nexport interface LocalInformation extends BaseInformation{\r\n  email: string\r\n  notifyCall: boolean\r\n  notifyTouch: boolean\r\n  notifyNear: boolean\r\n  notifyYarn: boolean\r\n}\r\nexport const defaultInformation:LocalInformation = {\r\n  name: 'Anonymous',\r\n  email: '',\r\n  avatarSrc: '',\r\n  color: [],\r\n  textColor: [],\r\n  notifyCall: true,\r\n  notifyTouch: false,\r\n  notifyNear: false,\r\n  notifyYarn: false,\r\n}\r\nexport const defaultRemoteInformation:RemoteInformation = {\r\n  name: '',\r\n  avatarSrc: '',\r\n  color: [],\r\n  textColor: [],\r\n}\r\nexport interface Tracks {\r\n  audio: JitsiTrack | undefined\r\n  avatar: JitsiTrack | undefined\r\n  audioStream: MediaStream | undefined\r\n  avatarStream: MediaStream | undefined\r\n}\r\n\r\nexport interface TrackStates{\r\n  micMuted: boolean,\r\n  speakerMuted: boolean,\r\n  headphone: boolean,\r\n}\r\nexport interface Physics {\r\n  located: boolean\r\n  onStage: boolean\r\n  awayFromKeyboard: boolean\r\n  inProximity: boolean,\r\n}\r\nexport const defaultPhysics: Physics = {\r\n  located: true,\r\n  onStage: false,\r\n  awayFromKeyboard: false,\r\n  inProximity: false,\r\n}\r\n\r\nexport function getColorOfParticipant(information: BaseInformation) {\r\n  let color = information.color\r\n  if (!color.length) {\r\n    if (information.name.length){\r\n      color = getRandomColorRGB(information.name)\r\n    }else{\r\n      color = [0xD0, 0xD0, 0xE0]\r\n    }\r\n  }\r\n  let textColor = information.textColor\r\n  if (!textColor.length) {\r\n    textColor = findTextColorRGB(color)\r\n  }\r\n  const reverseRGB = findReverseColorRGB(color)\r\n  const colors = [rgb2Color(color), rgb2Color(textColor), rgb2Color(reverseRGB)]\r\n\r\n  return colors\r\n}\r\n","import {MAP_SIZE} from '@components/Constants'\r\nimport {connection} from '@models/api'\r\nimport {ConnectionStates} from '@models/api/Constants'\r\nimport {t} from '@models/locales'\r\nimport {priorityCalculator} from '@models/middleware/trafficControl'\r\nimport { defaultInformation } from '@models/Participant'\r\nimport {urlParameters} from '@models/url'\r\nimport {addV2, diffSet, mulV2} from '@models/utils'\r\nimport {createJitisLocalTracksFromStream} from '@models/utils/jitsiTrack'\r\nimport map from '@stores/Map'\r\nimport participants from '@stores/participants/Participants'\r\nimport {action, autorun, computed, makeObservable, observable, when} from 'mobx'\r\n\r\nexport type ErrorType = '' | 'connection' | 'retry' | 'noMic' | 'micPermission' | 'channel' | 'entrance' | 'afk' | 'kicked'\r\n\r\nexport class ErrorInfo {\r\n  @computed get fatal() { return !this.type }\r\n  @observable type:ErrorType = 'entrance'\r\n  @observable types: Set<ErrorType> = new Set()\r\n  @observable supressedTypes:Set<ErrorType> = new Set()\r\n  reason? = ''\r\n  name? = ''\r\n  @action setType(type: ErrorType, name?:string, reason?:string){\r\n    this.type = type\r\n    this.types.add(type)\r\n    this.reason = reason\r\n    this.name = name\r\n  }\r\n  @computed get title() {\r\n    switch(this.type){\r\n      case 'connection': return t('etConnection')\r\n      case 'retry': return t('etRetry')\r\n      case 'noMic': return t('etNoMic')\r\n      case 'micPermission': return t('etMicPermission')\r\n      case 'channel': return t('etNoChannel')\r\n      case 'entrance': return ''\r\n      case 'afk': return t('afkTitle')\r\n      case 'kicked': return `Kicked by ${this.name}. ${this.reason}`\r\n    }\r\n\r\n    return this.type\r\n  }\r\n  @computed get message() {\r\n    switch(this.type){\r\n      case 'connection': return t('emConnection')\r\n      case 'retry': return t('emRetry')\r\n      case 'noMic': return t('emNoMic')\r\n      case 'micPermission': return t('emMicPermission')\r\n      case 'channel': return t('emNoChannel')\r\n      case 'entrance': return ''\r\n      case 'afk': return t('afkMessage')\r\n      case 'kicked': return ''\r\n    }\r\n\r\n    return `no message defined for ${this.type}`\r\n  }\r\n\r\n  show(){\r\n    if (this.type === ''){\r\n      const types = diffSet(this.types, this.supressedTypes)\r\n      if (types.size){\r\n        this.type = types.values().next().value\r\n      }\r\n    }\r\n\r\n    return this.type!=='' && !this.supressedTypes.has(this.type)\r\n  }\r\n\r\n  constructor() {\r\n    makeObservable(this)\r\n    if (urlParameters['testBot'] !== null) {\r\n      this.clear()\r\n    }\r\n    autorun(() => {\r\n      if (this.show()) {\r\n        map.keyInputUsers.add('errorDialog')\r\n      }else {\r\n        map.keyInputUsers.delete('errorDialog')\r\n      }\r\n    })\r\n    autorun(() => {\r\n      if (participants.local.awayFromKeyboard){\r\n        this.setType('afk')\r\n      }\r\n    })\r\n  }\r\n\r\n  //  media devices\r\n  private videoInputs:MediaDeviceInfo[] = []\r\n  private audioInputs:MediaDeviceInfo[] = []\r\n  private audioOutputs:MediaDeviceInfo[] = []\r\n  private enumerateDevices() {\r\n    navigator.mediaDevices.enumerateDevices().then((devices) => {\r\n      this.videoInputs = []\r\n      this.audioInputs = []\r\n      this.audioOutputs = []\r\n      devices.forEach((device) => {\r\n        if (device.kind === 'videoinput') { this.videoInputs.push(device) }\r\n        if (device.kind === 'audioinput') { this.audioInputs.push(device) }\r\n        if (device.kind === 'audiooutput') { this.audioOutputs.push(device) }\r\n      })\r\n    }).catch(() => { console.error('Device enumeration error') })\r\n  }\r\n  /// check errors after try to start the connection to the XMPP server.\r\n  @action connectionStart() {\r\n    //  even when reload, user interaction is needed to play sound.\r\n    //  const nav = window?.performance?.getEntriesByType('navigation')[0] as any\r\n    //  console.log(nav)\r\n    if (urlParameters.skipEntrance !== null/* || nav.type === 'reload'*/  ){\r\n      this.clear()\r\n      participants.local.sendInformation()\r\n    }\r\n    this.enumerateDevices()\r\n    if (urlParameters.testBot === null)  {\r\n      when(() => this.type === '', () => {\r\n        setTimeout(this.checkConnection.bind(this), 4 * 1000)\r\n      })\r\n    }else { //  testBot\r\n      setTimeout(this.startTestBot.bind(this), 3000)\r\n    }\r\n  }\r\n  @action clear(type?: ErrorType) {\r\n    if (this.type === 'afk'){\r\n      participants.local.awayFromKeyboard = false\r\n    }\r\n    if (type){\r\n      this.types.delete(type)\r\n      if (this.type === type) { this.type = '' }\r\n    }else{\r\n      this.types.clear()\r\n      this.type = ''\r\n    }\r\n  }\r\n  @action checkConnection() {\r\n    if (connection.state !== ConnectionStates.CONNECTED) {\r\n      this.setType('connection')\r\n      setTimeout(this.checkConnection.bind(this), 5 * 1000)\r\n    }else {\r\n      this.clear('connection')\r\n      this.checkMic()\r\n    }\r\n  }\r\n  @action checkMic() {\r\n    if (participants.localId && !participants.local.muteAudio && !connection.conference.getLocalMicTrack()) {\r\n      if (this.audioInputs.length) {\r\n        this.setType('micPermission')\r\n        //  this.message += 'You have: '\r\n        //  this.audioInputs.forEach((device) => { this.message += `[${device.deviceId} - ${device.label}]` })\r\n      }else {\r\n        this.clear('micPermission')\r\n        this.setType('noMic')\r\n      }\r\n      setTimeout(this.checkMic.bind(this),   5 * 1000)\r\n    }else {\r\n      if (participants.local.muteAudio){\r\n        setTimeout(this.checkMic.bind(this),   5 * 1000)\r\n      }\r\n      this.clear('noMic')\r\n      this.clear('micPermission')\r\n      this.checkRemote()\r\n    }\r\n  }\r\n  checkRemote() {\r\n    if (participants.remote.size > 0) {\r\n      /*\r\n      //console.log(stringify(connection.conference))\r\n      //console.log(stringify(d.chatRoom.xmpp.connection.jingle.sessions))\r\n      for(const sid in d.chatRoom.xmpp.connection.jingle.sessions){\r\n        const sess = d.chatRoom.xmpp.connection.jingle.sessions[sid]\r\n        const pc = sess.peerconnection.peerconnection as RTCPeerConnection\r\n        console.log(pc)\r\n        console.log('currentLocal:', pc.currentLocalDescription?.sdp)\r\n        console.log('currentRemote:', pc.currentRemoteDescription?.sdp)\r\n\r\n        //console.log(pc.remoteDescription?.sdp)\r\n      }\r\n      */\r\n\r\n      setTimeout(this.checkChannel.bind(this), 3 * 1000)\r\n    }else {\r\n      setTimeout(this.checkRemote.bind(this), 1 * 1000)\r\n    }\r\n  }\r\n  @action checkChannel() {\r\n    if (participants.remote.size > 0) {\r\n      if (!connection.conference._jitsiConference?.rtc._channel?.isOpen()) {\r\n        this.setType('channel')\r\n        setTimeout(this.checkChannel.bind(this), 5 * 1000)\r\n      }else {\r\n        this.clear('channel')\r\n      }\r\n    }else {\r\n      this.checkRemote()\r\n    }\r\n  }\r\n\r\n  //  testBot\r\n  canvas: HTMLCanvasElement|undefined = undefined\r\n  oscillator: OscillatorNode|undefined = undefined\r\n  startTestBot () {\r\n    let counter = 0\r\n    //  Create dummy audio\r\n    const ctxA = new AudioContext()\r\n    this.oscillator = ctxA.createOscillator()\r\n    this.oscillator.type = 'triangle' // sine, square, sawtooth, triangle\r\n    const destination = ctxA.createMediaStreamDestination()\r\n    this.oscillator.connect(destination)\r\n    this.oscillator.start()\r\n    //  Create dummy video\r\n    this.canvas = document.createElement('canvas')\r\n    const width = 240\r\n    const height = 240\r\n    this.canvas.style.width = `${width}px`\r\n    this.canvas.style.height = `${height}px`\r\n    const ctx = this.canvas.getContext('2d')\r\n    const center = [Math.random() * MAP_SIZE / 2, (Math.random() - 0.5) * MAP_SIZE]\r\n    const draw = () => {\r\n      if (!ctx || !ctxA) { return }\r\n      //  update audio frequency also\r\n      this.oscillator?.frequency.setValueAtTime(440 + counter % 440, ctxA.currentTime) // 440HzA4(4)\r\n      //  update camera image\r\n      const colors = ['green', 'blue']\r\n      const nearest = priorityCalculator.tracksToAccept[0].length ?\r\n        participants.remote.get(priorityCalculator.tracksToAccept[0][0].endpointId) : undefined\r\n      if (nearest && !nearest?.tracks.avatarOk) { colors[0] = 'yellow' }\r\n      if (nearest && nearest?.tracks.audio?.getTrack().muted) { colors[1] = 'red' }\r\n      //if (priorityCalculator.tracksToAccept[0][0]?.track.getTrack()?.muted) { colors[0] = 'yellow' }\r\n      //if (priorityCalculator.tracksToAccept[1][0]?.track.getTrack()?.muted) { colors[1] = 'red' }\r\n      ctx.fillStyle = colors[0]\r\n      ctx.beginPath()\r\n      ctx.ellipse(width * 0.63, height * 0.33, width * 0.1, height * 0.4, counter / 20, 0, Math.PI * 2)\r\n      ctx.fill()\r\n      ctx.fillStyle = colors[1]\r\n      ctx.beginPath()\r\n      ctx.ellipse(width * 0.63, height * 0.33, width * 0.1, height * 0.4, -counter / 20, 0, Math.PI * 2)\r\n      ctx.fill()\r\n      counter += 1\r\n    }\r\n    setInterval(draw, 1000 / 20)\r\n    const chars = '01234567890ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijlkmnopqrstuvwxyz'\r\n    const randChar = () =>  chars.substr(Math.floor(Math.random() * chars.length), 1)\r\n    participants.local.information = defaultInformation\r\n    participants.local.information.name = `testBot ${randChar()}${randChar()}${randChar()}`\r\n    participants.local.sendInformation()\r\n    participants.local.pose.position = center as [number, number]\r\n\r\n    const move = () => {\r\n      participants.local.pose.position = addV2(center, mulV2(100, [Math.cos(counter / 60), Math.sin(counter / 60)]))\r\n      //  Reload when not connected.\r\n      //  This does not work well: It causes unnecessary reload because WebSocket can often be reconnected.\r\n      /*\r\n      if (urlParameters.testBot !== null &&\r\n          connection.conference._jitsiConference?.room &&\r\n          !connection.conference._jitsiConference?.room.connected){\r\n        setTimeout(()=>{\r\n          if (!connection.conference._jitsiConference?.room.connected){\r\n            window.location.reload()  //  testBot will reload when channel is closed.\r\n          }\r\n        }, 20 * 1000)\r\n      }\r\n      */\r\n    }\r\n    const win = window as any\r\n    if (win.requestIdleCallback) {\r\n      const moveTask = () => {  //  onIdle, wait 50ms and run move()\r\n        setTimeout(() => {\r\n          move()\r\n          win.requestIdleCallback(moveTask)\r\n        },         50)\r\n      }\r\n      moveTask()\r\n    }else {\r\n      setInterval(move, 1000)\r\n    }\r\n\r\n    const vidoeStream = (this.canvas as any).captureStream(20) as MediaStream\r\n    const audioStream = destination.stream\r\n    const stream = new MediaStream()\r\n    stream.addTrack(audioStream.getAudioTracks()[0])\r\n    stream.addTrack(vidoeStream.getVideoTracks()[0])\r\n    createJitisLocalTracksFromStream(stream).then(\r\n      (tracks) => {\r\n        connection.conference.setLocalCameraTrack(tracks[0])\r\n        connection.conference.setLocalMicTrack(tracks[1])\r\n      },\r\n    )\r\n  }\r\n}\r\n\r\nconst errorInfo = new ErrorInfo()\r\ndeclare const d:any\r\nd.error = errorInfo\r\nexport default errorInfo\r\n","import JitsiMeetJS from 'lib-jitsi-meet'\r\nimport JitsiLocalTrack from 'lib-jitsi-meet/modules/RTC/JitsiLocalTrack'\r\n//import * as TPC from 'lib-jitsi-meet/modules/RTC/TPCUtils'\r\n\r\nexport function createJitisLocalTracksFromStream(stream: MediaStream): Promise < JitsiLocalTrack[] > {\r\n  const videoTrack: MediaStreamTrack = stream.getVideoTracks()[0]\r\n  const audioTrack: MediaStreamTrack = stream.getAudioTracks()[0]\r\n  const videoStream: MediaStream = new MediaStream([videoTrack])\r\n  let audioStream: MediaStream\r\n  let audioTrackInfo: JitsiMeetJS.TrackInfo | undefined = undefined\r\n\r\n  if (audioTrack) {\r\n    audioStream = new MediaStream([audioTrack])\r\n    audioTrackInfo = {\r\n      videoType: null,\r\n      mediaType: 'audio',\r\n      rtcId: 0,\r\n      stream: audioStream,\r\n      track: audioTrack,\r\n      effects: undefined,\r\n      resolution: audioTrack.getSettings().height,\r\n      deviceId: 'videofile_chrome',\r\n      facingMode: 'environment',\r\n    }\r\n  }\r\n\r\n  const videoTrackInfo: JitsiMeetJS.TrackInfo = {\r\n    videoType: 'camera',\r\n    mediaType: 'video',\r\n    rtcId: 1,\r\n    stream: videoStream,\r\n    track: videoTrack,\r\n    effects: undefined,\r\n    resolution: videoTrack.getSettings().height,\r\n    deviceId: 'videofile_chrome',\r\n    facingMode: 'environment',\r\n  }\r\n\r\n\r\n  return audioTrackInfo ?\r\n  Promise.resolve([\r\n    new JitsiLocalTrack(videoTrackInfo),\r\n    new JitsiLocalTrack(audioTrackInfo),\r\n  ]) :\r\n  Promise.resolve([new JitsiLocalTrack(videoTrackInfo)])\r\n}\r\n","/**\r\n * The media track was removed to the conference.\r\n */\r\nexport const LOCAL_TRACK_STOPPED = 'track.stopped';\r\n\r\n/**\r\n * Audio levels of a this track was changed.\r\n * The first argument is a number with audio level value in range [0, 1].\r\n * The second argument is a <tt>TraceablePeerConnection</tt> which is the peer\r\n * connection which measured the audio level (one audio track can be added\r\n * to multiple peer connection at the same time). This argument is optional for\r\n * local tracks for which we can measure audio level without the peer\r\n * connection (the value will be <tt>undefined</tt>).\r\n *\r\n * NOTE The second argument should be treated as library internal and can be\r\n * removed at any time.\r\n */\r\nexport const TRACK_AUDIO_LEVEL_CHANGED = 'track.audioLevelsChanged';\r\n\r\n/**\r\n * The audio output of the track was changed.\r\n */\r\nexport const TRACK_AUDIO_OUTPUT_CHANGED = 'track.audioOutputChanged';\r\n\r\n/**\r\n * A media track mute status was changed.\r\n */\r\nexport const TRACK_MUTE_CHANGED = 'track.trackMuteChanged';\r\n\r\n/**\r\n * The video type(\"camera\" or \"desktop\") of the track was changed.\r\n */\r\nexport const TRACK_VIDEOTYPE_CHANGED = 'track.videoTypeChanged';\r\n\r\n/**\r\n * Indicates that the track is not receiving any data even though we expect it\r\n * to receive data (i.e. the stream is not stopped).\r\n */\r\nexport const NO_DATA_FROM_SOURCE = 'track.no_data_from_source';\r\n\r\n/**\r\n * Indicates that the local audio track is not receiving any audio input from\r\n * the microphone that is currently selected.\r\n */\r\nexport const NO_AUDIO_INPUT = 'track.no_audio_input';\r\n","import {decodeGetParams} from './parameters'\r\n\r\nexport const urlParameters = decodeGetParams(window.location.href)\r\n","interface Params {\r\n  [key: string]: string | null\r\n  room: string | null               // conference room name\r\n  name: string | null               // user name\r\n  headphone: headphoneType | null   // stereo headphone output\r\n  speaker: headphoneType | null     // monaural speaker output\r\n  cameraOn: muteType | null       // Mute the camera at start\r\n  muteMic: muteType | null          // Mute the mic at start\r\n  testBot: string | null            // Tester bot mode\r\n  skipEntrance: string | null       // skip entrance\r\n}\r\n\r\nexport function decodeGetParams(url: string): Params {\r\n  const urlObj = new URL(decodeURI(url))\r\n  const props = ['room', 'name', 'headphone', 'speaker', 'cameraOn', 'muteMic', 'testBot', 'skipEntrance']\r\n\r\n  const res: Params = props.reduce(\r\n    (pre, prop) => {\r\n      pre[prop] = urlObj.searchParams.get(prop)\r\n\r\n      return pre\r\n    },\r\n    {} as Params,\r\n  )\r\n\r\n  //let _pathname = urlObj.pathname.substr(1).toLowerCase().split(\"/\");\r\n  //let _name = _pathname[_pathname.length-1]\r\n //urlObj.pathname = \"/\" + _name\r\n\r\n  res.room = urlObj.pathname.substr(1).toLowerCase().replace(/[./@]/, '_') + (res.room ? res.room.toLowerCase() : '')\r\n  return res\r\n}\r\n\r\ntype headphoneType = ''\r\ntype muteType = 'yes' | 'true' | 'no' | 'false'\r\n\r\n","// For legacy purposes, preserve the UMD of the public API of the Jitsi Meet\r\n// library (a.k.a. JitsiMeetJS).\r\nmodule.exports = require('./JitsiMeetJS').default;\r\n","export const MAP_SIZE = 5000\r\nexport const MAP_CENTER:[number, number] = [0, 0]\r\n","/**\r\n * The errors for the conference.\r\n */\r\n\r\n/**\r\n * Indicates that client must be authenticated to create the conference.\r\n */\r\nexport const AUTHENTICATION_REQUIRED = 'conference.authenticationRequired';\r\n\r\n/**\r\n * Indicates that chat error occurred.\r\n */\r\nexport const CHAT_ERROR = 'conference.chatError';\r\n\r\n/**\r\n * Indicates that conference has been destroyed.\r\n */\r\nexport const CONFERENCE_DESTROYED = 'conference.destroyed';\r\n\r\n/**\r\n * Indicates that max users limit has been reached.\r\n */\r\nexport const CONFERENCE_MAX_USERS = 'conference.max_users';\r\n\r\n/**\r\n * Indicates that a connection error occurred when trying to join a conference.\r\n */\r\nexport const CONNECTION_ERROR = 'conference.connectionError';\r\n\r\n/**\r\n * Indicates that the client has been forced to restart by jicofo when the\r\n * conference was migrated from one bridge to another.\r\n */\r\nexport const CONFERENCE_RESTARTED = 'conference.restarted';\r\n\r\n/**\r\n * Indicates that a connection error is due to not allowed,\r\n * occurred when trying to join a conference.\r\n */\r\nexport const NOT_ALLOWED_ERROR = 'conference.connectionError.notAllowed';\r\n\r\n/**\r\n * Indicates that a connection error is due to not allowed,\r\n * occurred when trying to join a conference, only approved members are allowed to join.\r\n */\r\nexport const MEMBERS_ONLY_ERROR = 'conference.connectionError.membersOnly';\r\n\r\n/**\r\n * Indicates that a connection error is due to denied access to the room,\r\n * occurred after joining a lobby room and access is denied by the room moderators.\r\n */\r\nexport const CONFERENCE_ACCESS_DENIED = 'conference.connectionError.accessDenied';\r\n\r\n/**\r\n * Indicates that focus error happened.\r\n */\r\nexport const FOCUS_DISCONNECTED = 'conference.focusDisconnected';\r\n\r\n/**\r\n * Indicates that focus left the conference.\r\n */\r\nexport const FOCUS_LEFT = 'conference.focusLeft';\r\n\r\n/**\r\n * Indicates that graceful shutdown happened.\r\n */\r\nexport const GRACEFUL_SHUTDOWN = 'conference.gracefulShutdown';\r\n\r\n/**\r\n * Indicates that the media connection has failed.\r\n */\r\nexport const ICE_FAILED = 'conference.iceFailed';\r\n\r\n/**\r\n * Indicates that the versions of the server side components are incompatible\r\n * with the client side.\r\n */\r\nexport const INCOMPATIBLE_SERVER_VERSIONS\r\n    = 'conference.incompatible_server_versions';\r\n\r\n/**\r\n * Indicates that offer/answer had failed.\r\n */\r\nexport const OFFER_ANSWER_FAILED = 'conference.offerAnswerFailed';\r\n\r\n/**\r\n * Indicates that password cannot be set for this conference.\r\n */\r\nexport const PASSWORD_NOT_SUPPORTED = 'conference.passwordNotSupported';\r\n\r\n/**\r\n * Indicates that a password is required in order to join the conference.\r\n */\r\nexport const PASSWORD_REQUIRED = 'conference.passwordRequired';\r\n\r\n/**\r\n * Indicates that reservation system returned error.\r\n */\r\nexport const RESERVATION_ERROR = 'conference.reservationError';\r\n\r\n/**\r\n * Indicates that there is no available videobridge.\r\n */\r\nexport const VIDEOBRIDGE_NOT_AVAILABLE = 'conference.videobridgeNotAvailable';\r\n","/* global $ */\r\n\r\nimport MediaDirection from '../../service/RTC/MediaDirection';\r\nimport browser from '../browser';\r\n\r\nimport SDPUtil from './SDPUtil';\r\n\r\n/**\r\n *\r\n * @param sdp\r\n */\r\nexport default function SDP(sdp) {\r\n    const media = sdp.split('\\r\\nm=');\r\n\r\n    for (let i = 1, length = media.length; i < length; i++) {\r\n        let mediaI = `m=${media[i]}`;\r\n\r\n        if (i !== length - 1) {\r\n            mediaI += '\\r\\n';\r\n        }\r\n        media[i] = mediaI;\r\n    }\r\n    const session = `${media.shift()}\\r\\n`;\r\n\r\n    this.media = media;\r\n    this.raw = session + media.join('');\r\n    this.session = session;\r\n}\r\n\r\n/**\r\n * A flag will make {@link transportToJingle} and {@link jingle2media} replace\r\n * ICE candidates IPs with invalid value of '1.1.1.1' which will cause ICE\r\n * failure. The flag is used in the automated testing.\r\n * @type {boolean}\r\n */\r\nSDP.prototype.failICE = false;\r\n\r\n/**\r\n * Whether or not to remove TCP ice candidates when translating from/to jingle.\r\n * @type {boolean}\r\n */\r\nSDP.prototype.removeTcpCandidates = false;\r\n\r\n/**\r\n * Whether or not to remove UDP ice candidates when translating from/to jingle.\r\n * @type {boolean}\r\n */\r\nSDP.prototype.removeUdpCandidates = false;\r\n\r\n/**\r\n * Returns map of MediaChannel mapped per channel idx.\r\n */\r\nSDP.prototype.getMediaSsrcMap = function() {\r\n    const mediaSSRCs = {};\r\n\r\n    for (let mediaindex = 0; mediaindex < this.media.length; mediaindex++) {\r\n        const mid\r\n            = SDPUtil.parseMID(\r\n                SDPUtil.findLine(this.media[mediaindex], 'a=mid:'));\r\n        const media = {\r\n            mediaindex,\r\n            mid,\r\n            ssrcs: {},\r\n            ssrcGroups: []\r\n        };\r\n\r\n        mediaSSRCs[mediaindex] = media;\r\n\r\n        SDPUtil.findLines(this.media[mediaindex], 'a=ssrc:').forEach(line => {\r\n            const linessrc = line.substring(7).split(' ')[0];\r\n\r\n            // allocate new ChannelSsrc\r\n\r\n            if (!media.ssrcs[linessrc]) {\r\n                media.ssrcs[linessrc] = {\r\n                    ssrc: linessrc,\r\n                    lines: []\r\n                };\r\n            }\r\n            media.ssrcs[linessrc].lines.push(line);\r\n        });\r\n        SDPUtil.findLines(this.media[mediaindex], 'a=ssrc-group:').forEach(line => {\r\n            const idx = line.indexOf(' ');\r\n            const semantics = line.substr(0, idx).substr(13);\r\n            const ssrcs = line.substr(14 + semantics.length).split(' ');\r\n\r\n            if (ssrcs.length) {\r\n                media.ssrcGroups.push({\r\n                    semantics,\r\n                    ssrcs\r\n                });\r\n            }\r\n        });\r\n    }\r\n\r\n    return mediaSSRCs;\r\n};\r\n\r\n/**\r\n * Returns <tt>true</tt> if this SDP contains given SSRC.\r\n * @param ssrc the ssrc to check.\r\n * @returns {boolean} <tt>true</tt> if this SDP contains given SSRC.\r\n */\r\nSDP.prototype.containsSSRC = function(ssrc) {\r\n    // FIXME this code is really strange - improve it if you can\r\n    const medias = this.getMediaSsrcMap();\r\n    let result = false;\r\n\r\n    Object.keys(medias).forEach(mediaindex => {\r\n        if (result) {\r\n            return;\r\n        }\r\n        if (medias[mediaindex].ssrcs[ssrc]) {\r\n            result = true;\r\n        }\r\n    });\r\n\r\n    return result;\r\n};\r\n\r\n// add content's to a jingle element\r\nSDP.prototype.toJingle = function(elem, thecreator) {\r\n    // https://xmpp.org/extensions/xep-0338.html\r\n    SDPUtil.findLines(this.session, 'a=group:').forEach(line => {\r\n        const parts = line.split(' ');\r\n        const semantics = parts.shift().substr(8);\r\n\r\n        elem.c('group', { xmlns: 'urn:xmpp:jingle:apps:grouping:0',\r\n            semantics });\r\n        for (let j = 0; j < parts.length; j++) {\r\n            elem.c('content', { name: parts[j] }).up();\r\n        }\r\n        elem.up();\r\n    });\r\n\r\n    for (let i = 0; i < this.media.length; i++) {\r\n        const mline = SDPUtil.parseMLine(this.media[i].split('\\r\\n')[0]);\r\n\r\n        if (!(mline.media === 'audio'\r\n              || mline.media === 'video'\r\n              || mline.media === 'application')) {\r\n            continue; // eslint-disable-line no-continue\r\n        }\r\n\r\n        let ssrc;\r\n        const assrcline = SDPUtil.findLine(this.media[i], 'a=ssrc:');\r\n\r\n        if (assrcline) {\r\n            ssrc = assrcline.substring(7).split(' ')[0]; // take the first\r\n        } else {\r\n            ssrc = false;\r\n        }\r\n\r\n        elem.c('content', { creator: thecreator,\r\n            name: mline.media });\r\n        const amidline = SDPUtil.findLine(this.media[i], 'a=mid:');\r\n\r\n        if (amidline) {\r\n            // prefer identifier from a=mid if present\r\n            const mid = SDPUtil.parseMID(amidline);\r\n\r\n            elem.attrs({ name: mid });\r\n        }\r\n\r\n        if (mline.media === 'audio' || mline.media === 'video') {\r\n            elem.c('description',\r\n                { xmlns: 'urn:xmpp:jingle:apps:rtp:1',\r\n                    media: mline.media });\r\n            if (ssrc) {\r\n                elem.attrs({ ssrc });\r\n            }\r\n            for (let j = 0; j < mline.fmt.length; j++) {\r\n                const rtpmap\r\n                    = SDPUtil.findLine(\r\n                        this.media[i],\r\n                        `a=rtpmap:${mline.fmt[j]}`);\r\n\r\n                elem.c('payload-type', SDPUtil.parseRTPMap(rtpmap));\r\n\r\n                // put any 'a=fmtp:' + mline.fmt[j] lines into <param name=foo\r\n                // value=bar/>\r\n                const afmtpline\r\n                    = SDPUtil.findLine(\r\n                        this.media[i],\r\n                        `a=fmtp:${mline.fmt[j]}`);\r\n\r\n                if (afmtpline) {\r\n                    const fmtpParameters = SDPUtil.parseFmtp(afmtpline);\r\n\r\n                    // eslint-disable-next-line max-depth\r\n                    for (let k = 0; k < fmtpParameters.length; k++) {\r\n                        elem.c('parameter', fmtpParameters[k]).up();\r\n                    }\r\n                }\r\n\r\n                // XEP-0293 -- map a=rtcp-fb\r\n                this.rtcpFbToJingle(i, elem, mline.fmt[j]);\r\n\r\n                elem.up();\r\n            }\r\n\r\n            if (ssrc) {\r\n                const ssrcMap = SDPUtil.parseSSRC(this.media[i]);\r\n\r\n                for (const [ availableSsrc, ssrcParameters ] of ssrcMap) {\r\n                    elem.c('source', {\r\n                        ssrc: availableSsrc,\r\n                        xmlns: 'urn:xmpp:jingle:apps:rtp:ssma:0'\r\n                    });\r\n\r\n                    ssrcParameters.forEach(ssrcSdpLine => {\r\n                        // get everything after first space\r\n                        const idx = ssrcSdpLine.indexOf(' ');\r\n                        const kv = ssrcSdpLine.substr(idx + 1);\r\n\r\n                        elem.c('parameter');\r\n                        if (kv.indexOf(':') === -1) {\r\n                            elem.attrs({ name: kv });\r\n                        } else {\r\n                            const name = kv.split(':', 2)[0];\r\n\r\n                            elem.attrs({ name });\r\n\r\n                            let v = kv.split(':', 2)[1];\r\n\r\n                            v = SDPUtil.filterSpecialChars(v);\r\n                            elem.attrs({ value: v });\r\n                        }\r\n                        elem.up();\r\n                    });\r\n\r\n                    elem.up();\r\n                }\r\n\r\n                // XEP-0339 handle ssrc-group attributes\r\n                const ssrcGroupLines\r\n                    = SDPUtil.findLines(this.media[i], 'a=ssrc-group:');\r\n\r\n                ssrcGroupLines.forEach(line => {\r\n                    const idx = line.indexOf(' ');\r\n                    const semantics = line.substr(0, idx).substr(13);\r\n                    const ssrcs = line.substr(14 + semantics.length).split(' ');\r\n\r\n                    if (ssrcs.length) {\r\n                        elem.c('ssrc-group', { semantics,\r\n                            xmlns: 'urn:xmpp:jingle:apps:rtp:ssma:0' });\r\n                        ssrcs.forEach(s => elem.c('source', { ssrc: s }).up());\r\n                        elem.up();\r\n                    }\r\n                });\r\n            }\r\n\r\n            const ridLines = SDPUtil.findLines(this.media[i], 'a=rid:');\r\n\r\n            if (ridLines.length && browser.usesRidsForSimulcast()) {\r\n                // Map a line which looks like \"a=rid:2 send\" to just\r\n                // the rid (\"2\")\r\n                const rids = ridLines\r\n                    .map(ridLine => ridLine.split(':')[1])\r\n                    .map(ridInfo => ridInfo.split(' ')[0]);\r\n\r\n                rids.forEach(rid => {\r\n                    elem.c('source', {\r\n                        rid,\r\n                        xmlns: 'urn:xmpp:jingle:apps:rtp:ssma:0'\r\n                    });\r\n                    elem.up();\r\n                });\r\n                const unifiedSimulcast\r\n                    = SDPUtil.findLine(this.media[i], 'a=simulcast:');\r\n\r\n                if (unifiedSimulcast) {\r\n                    elem.c('rid-group', {\r\n                        semantics: 'SIM',\r\n                        xmlns: 'urn:xmpp:jingle:apps:rtp:ssma:0'\r\n                    });\r\n                    rids.forEach(rid => {\r\n                        elem.c('source', { rid }).up();\r\n                    });\r\n                    elem.up();\r\n                }\r\n            }\r\n\r\n            if (SDPUtil.findLine(this.media[i], 'a=rtcp-mux')) {\r\n                elem.c('rtcp-mux').up();\r\n            }\r\n\r\n            // XEP-0293 -- map a=rtcp-fb:*\r\n            this.rtcpFbToJingle(i, elem, '*');\r\n\r\n            // XEP-0294\r\n            const extmapLines = SDPUtil.findLines(this.media[i], 'a=extmap:');\r\n\r\n            for (let j = 0; j < extmapLines.length; j++) {\r\n                const extmap = SDPUtil.parseExtmap(extmapLines[j]);\r\n\r\n                elem.c('rtp-hdrext', {\r\n                    xmlns: 'urn:xmpp:jingle:apps:rtp:rtp-hdrext:0',\r\n                    uri: extmap.uri,\r\n                    id: extmap.value\r\n                });\r\n\r\n                // eslint-disable-next-line max-depth\r\n                if (extmap.hasOwnProperty('direction')) {\r\n\r\n                    // eslint-disable-next-line max-depth\r\n                    switch (extmap.direction) {\r\n                    case MediaDirection.SENDONLY:\r\n                        elem.attrs({ senders: 'responder' });\r\n                        break;\r\n                    case MediaDirection.RECVONLY:\r\n                        elem.attrs({ senders: 'initiator' });\r\n                        break;\r\n                    case MediaDirection.SENDRECV:\r\n                        elem.attrs({ senders: 'both' });\r\n                        break;\r\n                    case MediaDirection.INACTIVE:\r\n                        elem.attrs({ senders: 'none' });\r\n                        break;\r\n                    }\r\n                }\r\n\r\n                // TODO: handle params\r\n                elem.up();\r\n            }\r\n            elem.up(); // end of description\r\n        }\r\n\r\n        // map ice-ufrag/pwd, dtls fingerprint, candidates\r\n        this.transportToJingle(i, elem);\r\n\r\n        const m = this.media[i];\r\n\r\n        if (SDPUtil.findLine(m, `a=${MediaDirection.SENDRECV}`, this.session)) {\r\n            elem.attrs({ senders: 'both' });\r\n        } else if (SDPUtil.findLine(m, `a=${MediaDirection.SENDONLY}`, this.session)) {\r\n            elem.attrs({ senders: 'initiator' });\r\n        } else if (SDPUtil.findLine(m, `a=${MediaDirection.RECVONLY}`, this.session)) {\r\n            elem.attrs({ senders: 'responder' });\r\n        } else if (SDPUtil.findLine(m, `a=${MediaDirection.INACTIVE}`, this.session)) {\r\n            elem.attrs({ senders: 'none' });\r\n        }\r\n\r\n        // Reject an m-line only when port is 0 and a=bundle-only is not present in the section.\r\n        // The port is automatically set to 0 when bundle-only is used.\r\n        if (mline.port === '0' && !SDPUtil.findLine(m, 'a=bundle-only', this.session)) {\r\n            // estos hack to reject an m-line\r\n            elem.attrs({ senders: 'rejected' });\r\n        }\r\n        elem.up(); // end of content\r\n    }\r\n    elem.up();\r\n\r\n    return elem;\r\n};\r\n\r\nSDP.prototype.transportToJingle = function(mediaindex, elem) {\r\n    elem.c('transport');\r\n\r\n    // XEP-0343 DTLS/SCTP\r\n    const sctpmap\r\n        = SDPUtil.findLine(this.media[mediaindex], 'a=sctpmap:', this.session);\r\n\r\n    if (sctpmap) {\r\n        const sctpAttrs = SDPUtil.parseSCTPMap(sctpmap);\r\n\r\n        elem.c('sctpmap', {\r\n            xmlns: 'urn:xmpp:jingle:transports:dtls-sctp:1',\r\n            number: sctpAttrs[0], /* SCTP port */\r\n            protocol: sctpAttrs[1] /* protocol */\r\n        });\r\n\r\n        // Optional stream count attribute\r\n        if (sctpAttrs.length > 2) {\r\n            elem.attrs({ streams: sctpAttrs[2] });\r\n        }\r\n        elem.up();\r\n    }\r\n\r\n    // XEP-0320\r\n    const fingerprints\r\n        = SDPUtil.findLines(\r\n            this.media[mediaindex],\r\n            'a=fingerprint:',\r\n            this.session);\r\n\r\n    fingerprints.forEach(line => {\r\n        const fingerprint = SDPUtil.parseFingerprint(line);\r\n\r\n        fingerprint.xmlns = 'urn:xmpp:jingle:apps:dtls:0';\r\n        elem.c('fingerprint').t(fingerprint.fingerprint);\r\n        delete fingerprint.fingerprint;\r\n\r\n        const setupLine\r\n            = SDPUtil.findLine(\r\n                this.media[mediaindex],\r\n                'a=setup:',\r\n                this.session);\r\n\r\n        if (setupLine) {\r\n            fingerprint.setup = setupLine.substr(8);\r\n        }\r\n        elem.attrs(fingerprint);\r\n        elem.up(); // end of fingerprint\r\n    });\r\n    const iceParameters = SDPUtil.iceparams(this.media[mediaindex], this.session);\r\n\r\n    if (iceParameters) {\r\n        iceParameters.xmlns = 'urn:xmpp:jingle:transports:ice-udp:1';\r\n        elem.attrs(iceParameters);\r\n\r\n        // XEP-0176\r\n        const candidateLines\r\n            = SDPUtil.findLines(\r\n                this.media[mediaindex],\r\n                'a=candidate:',\r\n                this.session);\r\n\r\n        candidateLines.forEach(line => { // add any a=candidate lines\r\n            const candidate = SDPUtil.candidateToJingle(line);\r\n\r\n            if (this.failICE) {\r\n                candidate.ip = '1.1.1.1';\r\n            }\r\n            const protocol\r\n                = candidate && typeof candidate.protocol === 'string'\r\n                    ? candidate.protocol.toLowerCase()\r\n                    : '';\r\n\r\n            if ((this.removeTcpCandidates\r\n                    && (protocol === 'tcp' || protocol === 'ssltcp'))\r\n                || (this.removeUdpCandidates && protocol === 'udp')) {\r\n                return;\r\n            }\r\n            elem.c('candidate', candidate).up();\r\n        });\r\n    }\r\n    elem.up(); // end of transport\r\n};\r\n\r\n// XEP-0293\r\nSDP.prototype.rtcpFbToJingle = function(mediaindex, elem, payloadtype) {\r\n    const lines\r\n        = SDPUtil.findLines(\r\n            this.media[mediaindex],\r\n            `a=rtcp-fb:${payloadtype}`);\r\n\r\n    lines.forEach(line => {\r\n        const feedback = SDPUtil.parseRTCPFB(line);\r\n\r\n        if (feedback.type === 'trr-int') {\r\n            elem.c('rtcp-fb-trr-int', {\r\n                xmlns: 'urn:xmpp:jingle:apps:rtp:rtcp-fb:0',\r\n                value: feedback.params[0]\r\n            });\r\n            elem.up();\r\n        } else {\r\n            elem.c('rtcp-fb', {\r\n                xmlns: 'urn:xmpp:jingle:apps:rtp:rtcp-fb:0',\r\n                type: feedback.type\r\n            });\r\n            if (feedback.params.length > 0) {\r\n                elem.attrs({ 'subtype': feedback.params[0] });\r\n            }\r\n            elem.up();\r\n        }\r\n    });\r\n};\r\n\r\nSDP.prototype.rtcpFbFromJingle = function(elem, payloadtype) { // XEP-0293\r\n    let sdp = '';\r\n    const feedbackElementTrrInt\r\n        = elem.find(\r\n            '>rtcp-fb-trr-int[xmlns=\"urn:xmpp:jingle:apps:rtp:rtcp-fb:0\"]');\r\n\r\n    if (feedbackElementTrrInt.length) {\r\n        sdp += 'a=rtcp-fb:* trr-int ';\r\n        if (feedbackElementTrrInt.attr('value')) {\r\n            sdp += feedbackElementTrrInt.attr('value');\r\n        } else {\r\n            sdp += '0';\r\n        }\r\n        sdp += '\\r\\n';\r\n    }\r\n\r\n    const feedbackElements = elem.find('>rtcp-fb[xmlns=\"urn:xmpp:jingle:apps:rtp:rtcp-fb:0\"]');\r\n\r\n    feedbackElements.each((_, fb) => {\r\n        sdp += `a=rtcp-fb:${payloadtype} ${fb.getAttribute('type')}`;\r\n        if (fb.hasAttribute('subtype')) {\r\n            sdp += ` ${fb.getAttribute('subtype')}`;\r\n        }\r\n        sdp += '\\r\\n';\r\n    });\r\n\r\n    return sdp;\r\n};\r\n\r\n// construct an SDP from a jingle stanza\r\nSDP.prototype.fromJingle = function(jingle) {\r\n    const sessionId = Date.now();\r\n\r\n    // Use a unique session id for every TPC.\r\n    this.raw = 'v=0\\r\\n'\r\n        + `o=- ${sessionId} 2 IN IP4 0.0.0.0\\r\\n`\r\n        + 's=-\\r\\n'\r\n        + 't=0 0\\r\\n';\r\n\r\n    // http://tools.ietf.org/html/draft-ietf-mmusic-sdp-bundle-negotiation-04\r\n    // #section-8\r\n    const groups\r\n        = $(jingle).find('>group[xmlns=\"urn:xmpp:jingle:apps:grouping:0\"]');\r\n\r\n    if (groups.length) {\r\n        groups.each((idx, group) => {\r\n            const contents\r\n                = $(group)\r\n                    .find('>content')\r\n                    .map((_, content) => content.getAttribute('name'))\r\n                    .get();\r\n\r\n            if (contents.length > 0) {\r\n                this.raw\r\n                    += `a=group:${\r\n                        group.getAttribute('semantics')\r\n                            || group.getAttribute('type')} ${\r\n                        contents.join(' ')}\\r\\n`;\r\n            }\r\n        });\r\n    }\r\n\r\n    this.session = this.raw;\r\n    jingle.find('>content').each((_, content) => {\r\n        const m = this.jingle2media($(content));\r\n\r\n        this.media.push(m);\r\n    });\r\n\r\n    // reconstruct msid-semantic -- apparently not necessary\r\n    /*\r\n     var msid = SDPUtil.parseSSRC(this.raw);\r\n     if (msid.hasOwnProperty('mslabel')) {\r\n     this.session += \"a=msid-semantic: WMS \" + msid.mslabel + \"\\r\\n\";\r\n     }\r\n     */\r\n\r\n    this.raw = this.session + this.media.join('');\r\n};\r\n\r\n// translate a jingle content element into an an SDP media part\r\nSDP.prototype.jingle2media = function(content) {\r\n    const desc = content.find('>description');\r\n    const transport = content.find('>transport[xmlns=\"urn:xmpp:jingle:transports:ice-udp:1\"]');\r\n    let sdp = '';\r\n    const sctp = transport.find(\r\n        '>sctpmap[xmlns=\"urn:xmpp:jingle:transports:dtls-sctp:1\"]');\r\n\r\n    const media = { media: desc.attr('media') };\r\n\r\n    media.port = '1';\r\n    if (content.attr('senders') === 'rejected') {\r\n        // estos hack to reject an m-line.\r\n        media.port = '0';\r\n    }\r\n    if (transport.find('>fingerprint[xmlns=\"urn:xmpp:jingle:apps:dtls:0\"]').length) {\r\n        media.proto = sctp.length ? 'DTLS/SCTP' : 'RTP/SAVPF';\r\n    } else {\r\n        media.proto = 'RTP/AVPF';\r\n    }\r\n    if (sctp.length) {\r\n        sdp += `m=application ${media.port} DTLS/SCTP ${\r\n            sctp.attr('number')}\\r\\n`;\r\n        sdp += `a=sctpmap:${sctp.attr('number')} ${sctp.attr('protocol')}`;\r\n\r\n        const streamCount = sctp.attr('streams');\r\n\r\n        if (streamCount) {\r\n            sdp += ` ${streamCount}\\r\\n`;\r\n        } else {\r\n            sdp += '\\r\\n';\r\n        }\r\n    } else {\r\n        media.fmt\r\n            = desc\r\n                .find('>payload-type')\r\n                .map((_, payloadType) => payloadType.getAttribute('id'))\r\n                .get();\r\n        sdp += `${SDPUtil.buildMLine(media)}\\r\\n`;\r\n    }\r\n\r\n    sdp += 'c=IN IP4 0.0.0.0\\r\\n';\r\n    if (!sctp.length) {\r\n        sdp += 'a=rtcp:1 IN IP4 0.0.0.0\\r\\n';\r\n    }\r\n\r\n    // XEP-0176 ICE parameters\r\n    if (transport.length) {\r\n        if (transport.attr('ufrag')) {\r\n            sdp += `${SDPUtil.buildICEUfrag(transport.attr('ufrag'))}\\r\\n`;\r\n        }\r\n        if (transport.attr('pwd')) {\r\n            sdp += `${SDPUtil.buildICEPwd(transport.attr('pwd'))}\\r\\n`;\r\n        }\r\n        transport.find('>fingerprint[xmlns=\"urn:xmpp:jingle:apps:dtls:0\"]').each((_, fingerprint) => {\r\n            sdp += `a=fingerprint:${fingerprint.getAttribute('hash')}`;\r\n            sdp += ` ${$(fingerprint).text()}`;\r\n            sdp += '\\r\\n';\r\n            if (fingerprint.hasAttribute('setup')) {\r\n                sdp += `a=setup:${fingerprint.getAttribute('setup')}\\r\\n`;\r\n            }\r\n        });\r\n    }\r\n\r\n    // XEP-0176 ICE candidates\r\n    transport.find('>candidate')\r\n        .each((_, candidate) => {\r\n            let protocol = candidate.getAttribute('protocol');\r\n\r\n            protocol\r\n                = typeof protocol === 'string' ? protocol.toLowerCase() : '';\r\n\r\n            if ((this.removeTcpCandidates\r\n                    && (protocol === 'tcp' || protocol === 'ssltcp'))\r\n                || (this.removeUdpCandidates && protocol === 'udp')) {\r\n                return;\r\n            } else if (this.failICE) {\r\n                candidate.setAttribute('ip', '1.1.1.1');\r\n            }\r\n\r\n            sdp += SDPUtil.candidateFromJingle(candidate);\r\n        });\r\n\r\n    switch (content.attr('senders')) {\r\n    case 'initiator':\r\n        sdp += `a=${MediaDirection.SENDONLY}\\r\\n`;\r\n        break;\r\n    case 'responder':\r\n        sdp += `a=${MediaDirection.RECVONLY}\\r\\n`;\r\n        break;\r\n    case 'none':\r\n        sdp += `a=${MediaDirection.INACTIVE}\\r\\n`;\r\n        break;\r\n    case 'both':\r\n        sdp += `a=${MediaDirection.SENDRECV}\\r\\n`;\r\n        break;\r\n    }\r\n    sdp += `a=mid:${content.attr('name')}\\r\\n`;\r\n\r\n    // <description><rtcp-mux/></description>\r\n    // see http://code.google.com/p/libjingle/issues/detail?id=309 -- no spec\r\n    // though\r\n    // and http://mail.jabber.org/pipermail/jingle/2011-December/001761.html\r\n    if (desc.find('>rtcp-mux').length) {\r\n        sdp += 'a=rtcp-mux\\r\\n';\r\n    }\r\n\r\n    desc.find('>payload-type').each((_, payloadType) => {\r\n        sdp += `${SDPUtil.buildRTPMap(payloadType)}\\r\\n`;\r\n        if ($(payloadType).find('>parameter').length) {\r\n            sdp += `a=fmtp:${payloadType.getAttribute('id')} `;\r\n            sdp\r\n                += $(payloadType)\r\n                    .find('>parameter')\r\n                    .map((__, parameter) => {\r\n                        const name = parameter.getAttribute('name');\r\n\r\n                        return (\r\n                            (name ? `${name}=` : '')\r\n                                + parameter.getAttribute('value'));\r\n                    })\r\n                    .get()\r\n                    .join('; ');\r\n            sdp += '\\r\\n';\r\n        }\r\n\r\n        // xep-0293\r\n        sdp += this.rtcpFbFromJingle($(payloadType), payloadType.getAttribute('id'));\r\n    });\r\n\r\n    // xep-0293\r\n    sdp += this.rtcpFbFromJingle(desc, '*');\r\n\r\n    // xep-0294\r\n    desc\r\n        .find('>rtp-hdrext[xmlns=\"urn:xmpp:jingle:apps:rtp:rtp-hdrext:0\"]')\r\n        .each((_, hdrExt) => {\r\n            sdp\r\n                += `a=extmap:${hdrExt.getAttribute('id')} ${\r\n                    hdrExt.getAttribute('uri')}\\r\\n`;\r\n        });\r\n\r\n    // XEP-0339 handle ssrc-group attributes\r\n    desc\r\n        .find('>ssrc-group[xmlns=\"urn:xmpp:jingle:apps:rtp:ssma:0\"]')\r\n        .each((_, ssrcGroup) => {\r\n            const semantics = ssrcGroup.getAttribute('semantics');\r\n            const ssrcs\r\n                = $(ssrcGroup)\r\n                    .find('>source')\r\n                    .map((__, source) => source.getAttribute('ssrc'))\r\n                    .get();\r\n\r\n            if (ssrcs.length) {\r\n                sdp += `a=ssrc-group:${semantics} ${ssrcs.join(' ')}\\r\\n`;\r\n            }\r\n        });\r\n\r\n    // XEP-0339 handle source attributes\r\n    desc\r\n        .find('>source[xmlns=\"urn:xmpp:jingle:apps:rtp:ssma:0\"]')\r\n        .each((_, source) => {\r\n            const ssrc = source.getAttribute('ssrc');\r\n\r\n            $(source)\r\n                .find('>parameter')\r\n                .each((__, parameter) => {\r\n                    const name = parameter.getAttribute('name');\r\n                    let value = parameter.getAttribute('value');\r\n\r\n                    value = SDPUtil.filterSpecialChars(value);\r\n                    sdp += `a=ssrc:${ssrc} ${name}`;\r\n                    if (value && value.length) {\r\n                        sdp += `:${value}`;\r\n                    }\r\n                    sdp += '\\r\\n';\r\n                });\r\n        });\r\n\r\n    return sdp;\r\n};\r\n","import * as JitsiTrackErrors from './JitsiTrackErrors';\r\n\r\nconst TRACK_ERROR_TO_MESSAGE_MAP = {};\r\n\r\nTRACK_ERROR_TO_MESSAGE_MAP[JitsiTrackErrors.UNSUPPORTED_RESOLUTION]\r\n    = 'Video resolution is not supported: ';\r\nTRACK_ERROR_TO_MESSAGE_MAP[JitsiTrackErrors.SCREENSHARING_USER_CANCELED]\r\n    = 'User canceled screen sharing prompt';\r\nTRACK_ERROR_TO_MESSAGE_MAP[JitsiTrackErrors.SCREENSHARING_GENERIC_ERROR]\r\n    = 'Unknown error from screensharing';\r\nTRACK_ERROR_TO_MESSAGE_MAP[JitsiTrackErrors.ELECTRON_DESKTOP_PICKER_ERROR]\r\n    = 'Unkown error from desktop picker';\r\nTRACK_ERROR_TO_MESSAGE_MAP[JitsiTrackErrors.ELECTRON_DESKTOP_PICKER_NOT_FOUND]\r\n    = 'Failed to detect desktop picker';\r\nTRACK_ERROR_TO_MESSAGE_MAP[JitsiTrackErrors.GENERAL]\r\n    = 'Generic getUserMedia error';\r\nTRACK_ERROR_TO_MESSAGE_MAP[JitsiTrackErrors.PERMISSION_DENIED]\r\n    = 'User denied permission to use device(s): ';\r\nTRACK_ERROR_TO_MESSAGE_MAP[JitsiTrackErrors.NOT_FOUND]\r\n    = 'Requested device(s) was/were not found: ';\r\nTRACK_ERROR_TO_MESSAGE_MAP[JitsiTrackErrors.CONSTRAINT_FAILED]\r\n    = 'Constraint could not be satisfied: ';\r\nTRACK_ERROR_TO_MESSAGE_MAP[JitsiTrackErrors.TIMEOUT]\r\n    = 'Could not start media source. Timeout occured!';\r\nTRACK_ERROR_TO_MESSAGE_MAP[JitsiTrackErrors.TRACK_IS_DISPOSED]\r\n    = 'Track has been already disposed';\r\nTRACK_ERROR_TO_MESSAGE_MAP[JitsiTrackErrors.TRACK_NO_STREAM_FOUND]\r\n    = 'Track does not have an associated Media Stream';\r\n\r\n// FIXME: Using prototype inheritance because otherwise instanceof is not\r\n// working properly (see https://github.com/babel/babel/issues/3083)\r\n\r\n/**\r\n *\r\n * Represents an error that occurred to a JitsiTrack. Can represent various\r\n * types of errors. For error descriptions (@see JitsiTrackErrors).\r\n *\r\n * @extends Error\r\n *\r\n *\r\n * @constructor\r\n * @param {Object|string} error - error object or error name\r\n * @param {Object|string} (options) - getUserMedia constraints object or\r\n * error message\r\n * @param {('audio'|'video'|'desktop'|'screen'|'audiooutput')[]} (devices) -\r\n * list of getUserMedia requested devices\r\n */\r\nfunction JitsiTrackError(error, options, devices) {\r\n    if (typeof error === 'object' && typeof error.name !== 'undefined') {\r\n        /**\r\n         * Additional information about original getUserMedia error\r\n         * and constraints.\r\n         * @type {{\r\n         *     error: Object,\r\n         *     constraints: Object,\r\n         *     devices: Array.<'audio'|'video'|'desktop'|'screen'>\r\n         * }}\r\n         */\r\n        this.gum = {\r\n            error,\r\n            constraints: options,\r\n            devices: devices && Array.isArray(devices)\r\n                ? devices.slice(0)\r\n                : undefined\r\n        };\r\n\r\n        switch (error.name) {\r\n        case 'NotAllowedError':\r\n        case 'PermissionDeniedError':\r\n        case 'SecurityError':\r\n            this.name = JitsiTrackErrors.PERMISSION_DENIED;\r\n            this.message\r\n                = TRACK_ERROR_TO_MESSAGE_MAP[this.name]\r\n                    + (this.gum.devices || []).join(', ');\r\n            break;\r\n        case 'DevicesNotFoundError':\r\n        case 'NotFoundError':\r\n            this.name = JitsiTrackErrors.NOT_FOUND;\r\n            this.message\r\n                = TRACK_ERROR_TO_MESSAGE_MAP[this.name]\r\n                    + (this.gum.devices || []).join(', ');\r\n            break;\r\n        case 'ConstraintNotSatisfiedError':\r\n        case 'OverconstrainedError': {\r\n            const constraintName = error.constraintName || error.constraint;\r\n\r\n            // we treat deviceId as unsupported resolution, as we want to\r\n            // retry and finally if everything fails to remove deviceId from\r\n            // mandatory constraints\r\n            if (options\r\n                    && options.video\r\n                    && (!devices || devices.indexOf('video') > -1)\r\n                    && (constraintName === 'minWidth'\r\n                        || constraintName === 'maxWidth'\r\n                        || constraintName === 'minHeight'\r\n                        || constraintName === 'maxHeight'\r\n                        || constraintName === 'width'\r\n                        || constraintName === 'height'\r\n                        || constraintName === 'deviceId')) {\r\n                this.name = JitsiTrackErrors.UNSUPPORTED_RESOLUTION;\r\n                this.message\r\n                    = TRACK_ERROR_TO_MESSAGE_MAP[this.name]\r\n                        + getResolutionFromFailedConstraint(\r\n                            constraintName,\r\n                            options);\r\n            } else {\r\n                this.name = JitsiTrackErrors.CONSTRAINT_FAILED;\r\n                this.message\r\n                    = TRACK_ERROR_TO_MESSAGE_MAP[this.name]\r\n                        + error.constraintName;\r\n            }\r\n            break;\r\n        }\r\n\r\n        default:\r\n            this.name = JitsiTrackErrors.GENERAL;\r\n            this.message\r\n                = error.message || TRACK_ERROR_TO_MESSAGE_MAP[this.name];\r\n            break;\r\n        }\r\n    } else if (typeof error === 'string') {\r\n        if (TRACK_ERROR_TO_MESSAGE_MAP[error]) {\r\n            this.name = error;\r\n            this.message = options || TRACK_ERROR_TO_MESSAGE_MAP[error];\r\n        } else {\r\n            // this is some generic error that do not fit any of our\r\n            // pre-defined errors, so don't give it any specific name, just\r\n            // store message\r\n            this.message = error;\r\n        }\r\n    } else {\r\n        throw new Error('Invalid arguments');\r\n    }\r\n\r\n    this.stack = error.stack || (new Error()).stack;\r\n}\r\n\r\nJitsiTrackError.prototype = Object.create(Error.prototype);\r\nJitsiTrackError.prototype.constructor = JitsiTrackError;\r\n\r\n/**\r\n * Gets failed resolution constraint from corresponding object.\r\n * @param {string} failedConstraintName\r\n * @param {Object} constraints\r\n * @returns {string|number}\r\n */\r\nfunction getResolutionFromFailedConstraint(failedConstraintName, constraints) {\r\n    if (constraints && constraints.video && constraints.video.mandatory) {\r\n        switch (failedConstraintName) {\r\n        case 'width':\r\n            return constraints.video.mandatory.minWidth;\r\n        case 'height':\r\n            return constraints.video.mandatory.minHeight;\r\n        default:\r\n            return constraints.video.mandatory[failedConstraintName] || '';\r\n        }\r\n    }\r\n\r\n    return '';\r\n}\r\n\r\nexport default JitsiTrackError;\r\n","/* global module */\r\n/**\r\n * Enumeration of the codec mime types\r\n * @type {{H264: string, OPUS: string, VP8: string, VP9: string}}\r\n */\r\nconst CodecMimeType = {\r\n    /**\r\n     * The h264 codec mime type.\r\n     */\r\n    H264: 'h264',\r\n\r\n    /**\r\n     * The opus codec mime type.\r\n     */\r\n    OPUS: 'opus',\r\n\r\n    /**\r\n     * The vp8 codec mime type.\r\n     */\r\n    VP8: 'vp8',\r\n\r\n    /**\r\n     * The vp9 codec mime type.\r\n     */\r\n    VP9: 'vp9'\r\n\r\n};\r\n\r\nmodule.exports = CodecMimeType;\r\n","import EventEmitter from 'events';\r\n\r\n/**\r\n * The class implements basic event operations - add/remove listener.\r\n * NOTE: The purpose of the class is to be extended in order to add\r\n * this functionality to other classes.\r\n */\r\nexport default class Listenable {\r\n    /**\r\n     * Creates new instance.\r\n     * @param {EventEmitter} eventEmitter\r\n     * @constructor\r\n     */\r\n    constructor(eventEmitter = new EventEmitter()) {\r\n        this.eventEmitter = eventEmitter;\r\n\r\n        // aliases for addListener/removeListener\r\n        this.addEventListener = this.on = this.addListener;\r\n        this.removeEventListener = this.off = this.removeListener;\r\n    }\r\n\r\n    /**\r\n     * Adds new listener.\r\n     * @param {String} eventName the name of the event\r\n     * @param {Function} listener the listener.\r\n     * @returns {Function} - The unsubscribe function.\r\n     */\r\n    addListener(eventName, listener) {\r\n        this.eventEmitter.addListener(eventName, listener);\r\n\r\n        return () => this.removeEventListener(eventName, listener);\r\n    }\r\n\r\n    /**\r\n     * Removes listener.\r\n     * @param {String} eventName the name of the event that triggers the\r\n     * listener\r\n     * @param {Function} listener the listener.\r\n     */\r\n    removeListener(eventName, listener) {\r\n        this.eventEmitter.removeListener(eventName, listener);\r\n    }\r\n}\r\n","/**\r\n * Event triggered by a audio detector indicating that its active state has changed from active to inactive or vice\r\n * versa.\r\n * @event\r\n * @type {boolean} - true when service has changed to active false otherwise.\r\n */\r\nexport const DETECTOR_STATE_CHANGE = 'detector_state_change';\r\n\r\n/** Event triggered by {@link NoAudioSignalDetector} when the local audio device associated with a JitsiConference\r\n * starts receiving audio levels with the value of 0 meaning no audio is being captured on that device, or when\r\n * it starts receiving audio levels !== 0 after being in a state of no audio.\r\n * @event\r\n * @type {boolean} - true when the current conference audio track has audio input false otherwise.\r\n */\r\nexport const AUDIO_INPUT_STATE_CHANGE = 'audio_input_state_changed';\r\n\r\n/** Event triggered by NoAudioSignalDetector when the local audio device associated with a JitsiConference goes silent\r\n * for a period of time, meaning that the device is either broken or hardware/software muted.\r\n * @event\r\n * @type {void}\r\n */\r\nexport const NO_AUDIO_INPUT = 'no_audio_input_detected';\r\n\r\n/**\r\n *  Event generated by {@link VADNoiseDetection} when the tracked device is considered noisy.\r\n *  @event\r\n *  @type {Object}\r\n */\r\nexport const VAD_NOISY_DEVICE = 'detection.vad_noise_device';\r\n\r\n/**\r\n * Event generated by VADReportingService when if finishes creating a VAD report for the monitored devices.\r\n * The generated objects are of type Array<Object>, one score for each monitored device.\r\n * @event VAD_REPORT_PUBLISHED\r\n * @type Array<Object> with the following structure:\r\n * @property {Date} timestamp - Timestamp at which the compute took place.\r\n * @property {number} avgVAD - Average VAD score over monitored period of time.\r\n * @property {string} deviceId - Associate local audio device ID.\r\n */\r\nexport const VAD_REPORT_PUBLISHED = 'vad-report-published';\r\n\r\n/**\r\n * Event generated by {@link TrackVADEmitter} when PCM sample VAD score is available.\r\n *\r\n * @event\r\n * @type {Object}\r\n * @property {Date}   timestamp - Exact time at which processed PCM sample was generated.\r\n * @property {number} score - VAD score on a scale from 0 to 1 (i.e. 0.7)\r\n * @property {Float32Array} pcmData - Raw PCM data with which the VAD score was calculated.\r\n * @property {string} deviceId - Device id of the associated track.\r\n */\r\nexport const VAD_SCORE_PUBLISHED = 'detection.vad_score_published';\r\n\r\n/**\r\n *  Event generated by {@link VADTalkMutedDetection} when a user is talking while the mic is muted.\r\n *\r\n *  @event\r\n *  @type {Object}\r\n */\r\nexport const VAD_TALK_WHILE_MUTED = 'detection.vad_talk_while_muted';\r\n","/* global $ */\r\n\r\nimport { getLogger } from 'jitsi-meet-logger';\r\nimport { $msg, Strophe } from 'strophe.js';\r\nimport 'strophejs-plugin-disco';\r\n\r\nimport * as JitsiConnectionErrors from '../../JitsiConnectionErrors';\r\nimport * as JitsiConnectionEvents from '../../JitsiConnectionEvents';\r\nimport XMPPEvents from '../../service/xmpp/XMPPEvents';\r\nimport browser from '../browser';\r\nimport { E2EEncryption } from '../e2ee/E2EEncryption';\r\nimport GlobalOnErrorHandler from '../util/GlobalOnErrorHandler';\r\nimport Listenable from '../util/Listenable';\r\nimport RandomUtil from '../util/RandomUtil';\r\n\r\nimport Caps, { parseDiscoInfo } from './Caps';\r\nimport XmppConnection from './XmppConnection';\r\nimport MucConnectionPlugin from './strophe.emuc';\r\nimport JingleConnectionPlugin from './strophe.jingle';\r\nimport initStropheLogger from './strophe.logger';\r\nimport RayoConnectionPlugin from './strophe.rayo';\r\nimport initStropheUtil from './strophe.util';\r\n\r\nconst logger = getLogger(__filename);\r\n\r\n/**\r\n* Regex to extract exact error message on jwt error.\r\n*/\r\nconst FAILURE_REGEX = /<failure.*><not-allowed\\/><text>(.*)<\\/text><\\/failure>/gi;\r\n\r\n/**\r\n * Creates XMPP connection.\r\n *\r\n * @param {Object} options\r\n * @param {string} [options.token] - JWT token used for authentication(JWT authentication module must be enabled in\r\n * Prosody).\r\n * @param {string} options.serviceUrl - The service URL for XMPP connection.\r\n * @param {string} options.shard - The shard where XMPP connection initially landed.\r\n * @param {string} options.enableWebsocketResume - True to enable stream resumption.\r\n * @param {number} [options.websocketKeepAlive] - See {@link XmppConnection} constructor.\r\n * @param {number} [options.websocketKeepAliveUrl] - See {@link XmppConnection} constructor.\r\n * @param {Object} [options.xmppPing] - See {@link XmppConnection} constructor.\r\n * @returns {XmppConnection}\r\n */\r\nfunction createConnection({\r\n    enableWebsocketResume,\r\n    serviceUrl = '/http-bind',\r\n    shard,\r\n    token,\r\n    websocketKeepAlive,\r\n    websocketKeepAliveUrl,\r\n    xmppPing }) {\r\n\r\n    // Append token as URL param\r\n    if (token) {\r\n        // eslint-disable-next-line no-param-reassign\r\n        serviceUrl += `${serviceUrl.indexOf('?') === -1 ? '?' : '&'}token=${token}`;\r\n    }\r\n\r\n    return new XmppConnection({\r\n        enableWebsocketResume,\r\n        serviceUrl,\r\n        websocketKeepAlive,\r\n        websocketKeepAliveUrl,\r\n        xmppPing,\r\n        shard\r\n    });\r\n}\r\n\r\n/**\r\n * Initializes Strophe plugins that need to work with Strophe.Connection directly rather than the lib-jitsi-meet's\r\n * {@link XmppConnection} wrapper.\r\n *\r\n * @returns {void}\r\n */\r\nfunction initStropheNativePlugins() {\r\n    initStropheUtil();\r\n    initStropheLogger();\r\n}\r\n\r\n// FIXME: remove once we have a default config template. -saghul\r\n/**\r\n * A list of ice servers to use by default for P2P.\r\n */\r\nexport const DEFAULT_STUN_SERVERS = [\r\n    { urls: 'stun:meet-jit-si-turnrelay.jitsi.net:443' }\r\n];\r\n\r\n/**\r\n * The name of the field used to recognize a chat message as carrying a JSON\r\n * payload from another endpoint.\r\n * If the json-message of a chat message contains a valid JSON object, and\r\n * the JSON has this key, then it is a valid json-message to be sent.\r\n */\r\nexport const JITSI_MEET_MUC_TYPE = 'type';\r\n\r\n/**\r\n * The feature used by jigasi participants.\r\n * @type {string}\r\n */\r\nexport const FEATURE_JIGASI = 'http://jitsi.org/protocol/jigasi';\r\n\r\n/**\r\n * The feature used by the lib to mark support for e2ee. We use the feature by putting it in the presence\r\n * to avoid additional signaling (disco-info).\r\n * @type {string}\r\n */\r\nexport const FEATURE_E2EE = 'https://jitsi.org/meet/e2ee';\r\n\r\n/**\r\n *\r\n */\r\nexport default class XMPP extends Listenable {\r\n    /**\r\n     * FIXME describe all options\r\n     * @param {Object} options\r\n     * @param {String} options.serviceUrl - URL passed to the XMPP client which will be used to establish XMPP\r\n     * connection with the server.\r\n     * @param {String} options.bosh - Deprecated, use {@code serviceUrl}.\r\n     * @param {boolean} options.enableWebsocketResume - Enables XEP-0198 stream management which will make the XMPP\r\n     * module try to resume the session in case the Websocket connection breaks.\r\n     * @param {number} [options.websocketKeepAlive] - The websocket keep alive interval. See {@link XmppConnection}\r\n     * constructor for more details.\r\n     * @param {number} [options.websocketKeepAliveUrl] - The websocket keep alive url. See {@link XmppConnection}\r\n     * constructor for more details.\r\n     * @param {Object} [options.xmppPing] - The xmpp ping settings.\r\n     * @param {Array<Object>} options.p2pStunServers see {@link JingleConnectionPlugin} for more details.\r\n     * @param token\r\n     */\r\n    constructor(options, token) {\r\n        super();\r\n        this.connection = null;\r\n        this.disconnectInProgress = false;\r\n        this.connectionTimes = {};\r\n        this.options = options;\r\n        this.token = token;\r\n        this.authenticatedUser = false;\r\n\r\n        initStropheNativePlugins();\r\n\r\n        const xmppPing = options.xmppPing || {};\r\n\r\n        // let's ping the main domain (in case a guest one is used for the connection)\r\n        xmppPing.domain = options.hosts.domain;\r\n\r\n        this.connection = createConnection({\r\n            enableWebsocketResume: options.enableWebsocketResume,\r\n\r\n            // FIXME remove deprecated bosh option at some point\r\n            serviceUrl: options.serviceUrl || options.bosh,\r\n            token,\r\n            websocketKeepAlive: options.websocketKeepAlive,\r\n            websocketKeepAliveUrl: options.websocketKeepAliveUrl,\r\n            xmppPing,\r\n            shard: options.deploymentInfo?.shard\r\n        });\r\n\r\n        // forwards the shard changed event\r\n        this.connection.on(XmppConnection.Events.CONN_SHARD_CHANGED, () => {\r\n            /* eslint-disable camelcase */\r\n            const details = {\r\n                shard_changed: true,\r\n                suspend_time: this.connection.ping.getPingSuspendTime(),\r\n                time_since_last_success: this.connection.getTimeSinceLastSuccess()\r\n            };\r\n            /* eslint-enable camelcase */\r\n\r\n            this.eventEmitter.emit(\r\n                JitsiConnectionEvents.CONNECTION_FAILED,\r\n                JitsiConnectionErrors.OTHER_ERROR,\r\n                undefined,\r\n                undefined,\r\n                details);\r\n        });\r\n\r\n        this._initStrophePlugins();\r\n\r\n        this.caps = new Caps(this.connection, this.options.clientNode);\r\n\r\n        // Initialize features advertised in disco-info\r\n        this.initFeaturesList();\r\n\r\n        // Setup a disconnect on unload as a way to facilitate API consumers. It\r\n        // sounds like they would want that. A problem for them though may be if\r\n        // they wanted to utilize the connected connection in an unload handler\r\n        // of their own. However, it should be fairly easy for them to do that\r\n        // by registering their unload handler before us.\r\n        $(window).on('beforeunload unload', ev => {\r\n            this.disconnect(ev).catch(() => {\r\n                // ignore errors in order to not brake the unload.\r\n            });\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Initializes the list of feature advertised through the disco-info\r\n     * mechanism.\r\n     */\r\n    initFeaturesList() {\r\n        // http://xmpp.org/extensions/xep-0167.html#support\r\n        // http://xmpp.org/extensions/xep-0176.html#support\r\n        this.caps.addFeature('urn:xmpp:jingle:1');\r\n        this.caps.addFeature('urn:xmpp:jingle:apps:rtp:1');\r\n        this.caps.addFeature('urn:xmpp:jingle:transports:ice-udp:1');\r\n        this.caps.addFeature('urn:xmpp:jingle:apps:dtls:0');\r\n        this.caps.addFeature('urn:xmpp:jingle:transports:dtls-sctp:1');\r\n        this.caps.addFeature('urn:xmpp:jingle:apps:rtp:audio');\r\n        this.caps.addFeature('urn:xmpp:jingle:apps:rtp:video');\r\n\r\n        // Disable RTX on Firefox 83 and older versions because of\r\n        // https://bugzilla.mozilla.org/show_bug.cgi?id=1668028\r\n        if (!(this.options.disableRtx || (browser.isFirefox() && browser.isVersionLessThan(84)))) {\r\n            this.caps.addFeature('urn:ietf:rfc:4588');\r\n        }\r\n        if (this.options.enableOpusRed === true && browser.supportsAudioRed()) {\r\n            this.caps.addFeature('http://jitsi.org/opus-red');\r\n        }\r\n\r\n        if (typeof this.options.enableRemb === 'undefined' || this.options.enableRemb) {\r\n            this.caps.addFeature('http://jitsi.org/remb');\r\n        }\r\n\r\n        // Disable TCC on Firefox because of a known issue where BWE is halved on every renegotiation.\r\n        if (!browser.isFirefox() && (typeof this.options.enableTcc === 'undefined' || this.options.enableTcc)) {\r\n            this.caps.addFeature('http://jitsi.org/tcc');\r\n        }\r\n\r\n        // this is dealt with by SDP O/A so we don't need to announce this\r\n        // XEP-0293\r\n        // this.caps.addFeature('urn:xmpp:jingle:apps:rtp:rtcp-fb:0');\r\n        // XEP-0294\r\n        // this.caps.addFeature('urn:xmpp:jingle:apps:rtp:rtp-hdrext:0');\r\n\r\n        this.caps.addFeature('urn:ietf:rfc:5761'); // rtcp-mux\r\n        this.caps.addFeature('urn:ietf:rfc:5888'); // a=group, e.g. bundle\r\n\r\n        // this.caps.addFeature('urn:ietf:rfc:5576'); // a=ssrc\r\n\r\n        // Enable Lipsync ?\r\n        if (browser.isChromiumBased() && this.options.enableLipSync === true) {\r\n            logger.info('Lip-sync enabled !');\r\n            this.caps.addFeature('http://jitsi.org/meet/lipsync');\r\n        }\r\n\r\n        if (this.connection.rayo) {\r\n            this.caps.addFeature('urn:xmpp:rayo:client:1');\r\n        }\r\n\r\n        if (E2EEncryption.isSupported(this.options)) {\r\n            this.caps.addFeature(FEATURE_E2EE, false, true);\r\n        }\r\n    }\r\n\r\n    /**\r\n     *\r\n     */\r\n    getConnection() {\r\n        return this.connection;\r\n    }\r\n\r\n    /**\r\n     * Receive connection status changes and handles them.\r\n     *\r\n     * @param {Object} credentials\r\n     * @param {string} credentials.jid - The user's XMPP ID passed to the\r\n     * connect method. For example, 'user@xmpp.com'.\r\n     * @param {string} credentials.password - The password passed to the connect\r\n     * method.\r\n     * @param {string} status - One of Strophe's connection status strings.\r\n     * @param {string} [msg] - The connection error message provided by Strophe.\r\n     */\r\n    connectionHandler(credentials = {}, status, msg) {\r\n        const now = window.performance.now();\r\n        const statusStr = Strophe.getStatusString(status).toLowerCase();\r\n\r\n        this.connectionTimes[statusStr] = now;\r\n        logger.log(\r\n            `(TIME) Strophe ${statusStr}${msg ? `[${msg}]` : ''}:\\t`,\r\n            now);\r\n\r\n        this.eventEmitter.emit(XMPPEvents.CONNECTION_STATUS_CHANGED, credentials, status, msg);\r\n        if (status === Strophe.Status.CONNECTED || status === Strophe.Status.ATTACHED) {\r\n            // once connected or attached we no longer need this handle, drop it if it exist\r\n            if (this._sysMessageHandler) {\r\n                this.connection._stropheConn.deleteHandler(this._sysMessageHandler);\r\n                this._sysMessageHandler = null;\r\n            }\r\n\r\n            this.sendDiscoInfo && this.connection.jingle.getStunAndTurnCredentials();\r\n\r\n            logger.info(`My Jabber ID: ${this.connection.jid}`);\r\n\r\n            // XmppConnection emits CONNECTED again on reconnect - a good opportunity to clear any \"last error\" flags\r\n            this._resetState();\r\n\r\n            this.sendDiscoInfo && this.caps.getFeaturesAndIdentities(this.options.hosts.domain)\r\n                .then(({ features, identities }) => {\r\n                    if (!features.has(Strophe.NS.PING)) {\r\n                        logger.error(`Ping NOT supported by ${\r\n                            this.options.hosts.domain} - please enable ping in your XMPP server config`);\r\n                    }\r\n\r\n                    this._processDiscoInfoIdentities(\r\n                        identities, undefined /* when querying we will query for features */);\r\n                })\r\n                .catch(error => {\r\n                    const errmsg = 'Feature discovery error';\r\n\r\n                    GlobalOnErrorHandler.callErrorHandler(\r\n                        new Error(`${errmsg}: ${error}`));\r\n                    logger.error(errmsg, error);\r\n                });\r\n\r\n            // make sure we don't query again\r\n            this.sendDiscoInfo = false;\r\n\r\n            if (credentials.password) {\r\n                this.authenticatedUser = true;\r\n            }\r\n            if (this.connection && this.connection.connected\r\n                && Strophe.getResourceFromJid(this.connection.jid)) {\r\n                // .connected is true while connecting?\r\n                // this.connection.send($pres());\r\n                this.eventEmitter.emit(\r\n                    JitsiConnectionEvents.CONNECTION_ESTABLISHED,\r\n                    Strophe.getResourceFromJid(this.connection.jid));\r\n            }\r\n        } else if (status === Strophe.Status.CONNFAIL) {\r\n            if (msg === 'x-strophe-bad-non-anon-jid') {\r\n                this.anonymousConnectionFailed = true;\r\n            } else {\r\n                this.connectionFailed = true;\r\n            }\r\n            this.lastErrorMsg = msg;\r\n            if (msg === 'giving-up') {\r\n                this.eventEmitter.emit(\r\n                    JitsiConnectionEvents.CONNECTION_FAILED,\r\n                    JitsiConnectionErrors.OTHER_ERROR, msg);\r\n            }\r\n        } else if (status === Strophe.Status.ERROR) {\r\n            this.lastErrorMsg = msg;\r\n        } else if (status === Strophe.Status.DISCONNECTED) {\r\n            // Stop ping interval\r\n            this.connection.ping.stopInterval();\r\n            const wasIntentionalDisconnect = Boolean(this.disconnectInProgress);\r\n            const errMsg = msg || this.lastErrorMsg;\r\n\r\n            if (this.anonymousConnectionFailed) {\r\n                // prompt user for username and password\r\n                this.eventEmitter.emit(\r\n                    JitsiConnectionEvents.CONNECTION_FAILED,\r\n                    JitsiConnectionErrors.PASSWORD_REQUIRED);\r\n            } else if (this.connectionFailed) {\r\n                this.eventEmitter.emit(\r\n                    JitsiConnectionEvents.CONNECTION_FAILED,\r\n                    JitsiConnectionErrors.OTHER_ERROR,\r\n                    errMsg,\r\n                    undefined, /* credentials */\r\n                    this._getConnectionFailedReasonDetails());\r\n            } else if (wasIntentionalDisconnect) {\r\n                this.eventEmitter.emit(\r\n                    JitsiConnectionEvents.CONNECTION_DISCONNECTED, errMsg);\r\n            } else {\r\n                // XXX if Strophe drops the connection while not being asked to,\r\n                // it means that most likely some serious error has occurred.\r\n                // One currently known case is when a BOSH request fails for\r\n                // more than 4 times. The connection is dropped without\r\n                // supplying a reason(error message/event) through the API.\r\n                logger.error('XMPP connection dropped!');\r\n\r\n                // XXX if the last request error is within 5xx range it means it\r\n                // was a server failure\r\n                const lastErrorStatus = Strophe.getLastErrorStatus();\r\n\r\n                if (lastErrorStatus >= 500 && lastErrorStatus < 600) {\r\n                    this.eventEmitter.emit(\r\n                        JitsiConnectionEvents.CONNECTION_FAILED,\r\n                        JitsiConnectionErrors.SERVER_ERROR,\r\n                        errMsg || 'server-error',\r\n                        /* credentials */ undefined,\r\n                        this._getConnectionFailedReasonDetails());\r\n                } else {\r\n                    this.eventEmitter.emit(\r\n                        JitsiConnectionEvents.CONNECTION_FAILED,\r\n                        JitsiConnectionErrors.CONNECTION_DROPPED_ERROR,\r\n                        errMsg || 'connection-dropped-error',\r\n                        /* credentials */ undefined,\r\n                        this._getConnectionFailedReasonDetails());\r\n                }\r\n            }\r\n        } else if (status === Strophe.Status.AUTHFAIL) {\r\n            const lastFailedRawMessage = this.getConnection().getLastFailedMessage();\r\n\r\n            // wrong password or username, prompt user\r\n            this.eventEmitter.emit(\r\n                JitsiConnectionEvents.CONNECTION_FAILED,\r\n                JitsiConnectionErrors.PASSWORD_REQUIRED,\r\n                msg || this._parseConnectionFailedMessage(lastFailedRawMessage),\r\n                credentials);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Process received identities.\r\n     * @param {Set<String>} identities The identities to process.\r\n     * @param {Set<String>} features The features to process, optional. If missing lobby component will be queried\r\n     * for more features.\r\n     * @private\r\n     */\r\n    _processDiscoInfoIdentities(identities, features) {\r\n        // check for speakerstats\r\n        identities.forEach(identity => {\r\n            if (identity.type === 'av_moderation') {\r\n                this.avModerationComponentAddress = identity.name;\r\n            }\r\n\r\n            if (identity.type === 'speakerstats') {\r\n                this.speakerStatsComponentAddress = identity.name;\r\n            }\r\n\r\n            if (identity.type === 'conference_duration') {\r\n                this.conferenceDurationComponentAddress = identity.name;\r\n            }\r\n\r\n            if (identity.type === 'lobbyrooms') {\r\n                this.lobbySupported = true;\r\n                const processLobbyFeatures = f => {\r\n                    f.forEach(fr => {\r\n                        if (fr.endsWith('#displayname_required')) {\r\n                            this.eventEmitter.emit(JitsiConnectionEvents.DISPLAY_NAME_REQUIRED);\r\n                        }\r\n                    });\r\n                };\r\n\r\n                if (features) {\r\n                    processLobbyFeatures(features);\r\n                } else {\r\n                    identity.name && this.caps.getFeaturesAndIdentities(identity.name, identity.type)\r\n                        .then(({ features: f }) => processLobbyFeatures(f))\r\n                        .catch(e => logger.warn('Error getting features from lobby.', e && e.message));\r\n                }\r\n            }\r\n        });\r\n\r\n        if (this.avModerationComponentAddress\r\n            || this.speakerStatsComponentAddress\r\n            || this.conferenceDurationComponentAddress) {\r\n            this.connection.addHandler(this._onPrivateMessage.bind(this), null, 'message', null, null);\r\n        }\r\n    }\r\n\r\n    /**\r\n    * Parses a raw failure xmpp xml message received on auth failed.\r\n    *\r\n    * @param {string} msg - The raw failure message from xmpp.\r\n    * @returns {string|null} - The parsed message from the raw xmpp message.\r\n    */\r\n    _parseConnectionFailedMessage(msg) {\r\n        if (!msg) {\r\n            return null;\r\n        }\r\n\r\n        const matches = FAILURE_REGEX.exec(msg);\r\n\r\n        return matches ? matches[1] : null;\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param jid\r\n     * @param password\r\n     */\r\n    _connect(jid, password) {\r\n        // connection.connect() starts the connection process.\r\n        //\r\n        // As the connection process proceeds, the user supplied callback will\r\n        // be triggered multiple times with status updates. The callback should\r\n        // take two arguments - the status code and the error condition.\r\n        //\r\n        // The status code will be one of the values in the Strophe.Status\r\n        // constants. The error condition will be one of the conditions defined\r\n        // in RFC 3920 or the condition strophe-parsererror.\r\n        //\r\n        // The Parameters wait, hold and route are optional and only relevant\r\n        // for BOSH connections. Please see XEP 124 for a more detailed\r\n        // explanation of the optional parameters.\r\n        //\r\n        // Connection status constants for use by the connection handler\r\n        // callback.\r\n        //\r\n        //  Status.ERROR - An error has occurred (websockets specific)\r\n        //  Status.CONNECTING - The connection is currently being made\r\n        //  Status.CONNFAIL - The connection attempt failed\r\n        //  Status.AUTHENTICATING - The connection is authenticating\r\n        //  Status.AUTHFAIL - The authentication attempt failed\r\n        //  Status.CONNECTED - The connection has succeeded\r\n        //  Status.DISCONNECTED - The connection has been terminated\r\n        //  Status.DISCONNECTING - The connection is currently being terminated\r\n        //  Status.ATTACHED - The connection has been attached\r\n\r\n        this._resetState();\r\n\r\n        // we want to send this only on the initial connect\r\n        this.sendDiscoInfo = true;\r\n\r\n        if (this.connection._stropheConn && this.connection._stropheConn._addSysHandler) {\r\n            this._sysMessageHandler = this.connection._stropheConn._addSysHandler(\r\n                this._onSystemMessage.bind(this),\r\n                null,\r\n                'message'\r\n            );\r\n        } else {\r\n            logger.warn('Cannot attach strophe system handler, jiconop cannot operate');\r\n        }\r\n\r\n        this.connection.connect(\r\n            jid,\r\n            password,\r\n            this.connectionHandler.bind(this, {\r\n                jid,\r\n                password\r\n            }));\r\n    }\r\n\r\n    /**\r\n     * Receives system messages during the connect/login process and checks for services or\r\n     * @param msg The received message.\r\n     * @returns {void}\r\n     * @private\r\n     */\r\n    _onSystemMessage(msg) {\r\n        // proceed only if the message has any of the expected information\r\n        if ($(msg).find('>services').length === 0 && $(msg).find('>query').length === 0) {\r\n            return;\r\n        }\r\n\r\n        this.sendDiscoInfo = false;\r\n\r\n        const foundIceServers = this.connection.jingle.onReceiveStunAndTurnCredentials(msg);\r\n\r\n        const { features, identities } = parseDiscoInfo(msg);\r\n\r\n        this._processDiscoInfoIdentities(identities, features);\r\n\r\n        // check for shard name in identities\r\n        identities.forEach(i => {\r\n            if (i.type === 'shard') {\r\n                this.options.deploymentInfo.shard = i.name;\r\n            }\r\n        });\r\n\r\n        if (foundIceServers || identities.size > 0 || features.size > 0) {\r\n            this.connection._stropheConn.deleteHandler(this._sysMessageHandler);\r\n            this._sysMessageHandler = null;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Attach to existing connection. Can be used for optimizations. For\r\n     * example: if the connection is created on the server we can attach to it\r\n     * and start using it.\r\n     *\r\n     * @param options {object} connecting options - rid, sid, jid and password.\r\n     */\r\n    attach(options) {\r\n        this._resetState();\r\n\r\n        // we want to send this only on the initial connect\r\n        this.sendDiscoInfo = true;\r\n\r\n        const now = this.connectionTimes.attaching = window.performance.now();\r\n\r\n        logger.log('(TIME) Strophe Attaching:\\t', now);\r\n        this.connection.attach(options.jid, options.sid,\r\n            parseInt(options.rid, 10) + 1,\r\n            this.connectionHandler.bind(this, {\r\n                jid: options.jid,\r\n                password: options.password\r\n            }));\r\n    }\r\n\r\n    /**\r\n     * Resets any state/flag before starting a new connection.\r\n     * @private\r\n     */\r\n    _resetState() {\r\n        this.anonymousConnectionFailed = false;\r\n        this.connectionFailed = false;\r\n        this.lastErrorMsg = undefined;\r\n        this.disconnectInProgress = undefined;\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param jid\r\n     * @param password\r\n     */\r\n    connect(jid, password) {\r\n        if (!jid) {\r\n            const { anonymousdomain, domain } = this.options.hosts;\r\n            let configDomain = anonymousdomain || domain;\r\n\r\n            // Force authenticated domain if room is appended with '?login=true'\r\n            // or if we're joining with the token\r\n\r\n            // FIXME Do not rely on window.location because (1) React Native\r\n            // does not have a window.location by default and (2) here we cannot\r\n            // know for sure that query/search has not be stripped from\r\n            // window.location by the time the following executes.\r\n            const { location } = window;\r\n\r\n            if (anonymousdomain) {\r\n                const search = location && location.search;\r\n\r\n                if ((search && search.indexOf('login=true') !== -1)\r\n                        || this.token) {\r\n                    configDomain = domain;\r\n                }\r\n            }\r\n\r\n            // eslint-disable-next-line no-param-reassign\r\n            jid = configDomain || (location && location.hostname);\r\n        }\r\n\r\n        return this._connect(jid, password);\r\n    }\r\n\r\n    /**\r\n     * Joins or creates a muc with the provided jid, created from the passed\r\n     * in room name and muc host and onCreateResource result.\r\n     *\r\n     * @param {string} roomName - The name of the muc to join.\r\n     * @param {Object} options - Configuration for how to join the muc.\r\n     * @param {Function} [onCreateResource] - Callback to invoke when a resource\r\n     * is to be added to the jid.\r\n     * @returns {Promise} Resolves with an instance of a strophe muc.\r\n     */\r\n    createRoom(roomName, options, onCreateResource) {\r\n        // There are cases (when using subdomain) where muc can hold an uppercase part\r\n        let roomjid = `${roomName}@${options.customDomain\r\n            ? options.customDomain : this.options.hosts.muc.toLowerCase()}/`;\r\n\r\n        const mucNickname = onCreateResource\r\n            ? onCreateResource(this.connection.jid, this.authenticatedUser)\r\n            : RandomUtil.randomHexString(8).toLowerCase();\r\n\r\n        logger.info(`JID ${this.connection.jid} using MUC nickname ${mucNickname}`);\r\n        roomjid += mucNickname;\r\n\r\n        return this.connection.emuc.createRoom(roomjid, null, options);\r\n    }\r\n\r\n    /**\r\n     * Returns the jid of the participant associated with the Strophe connection.\r\n     *\r\n     * @returns {string} The jid of the participant.\r\n     */\r\n    getJid() {\r\n        return this.connection.jid;\r\n    }\r\n\r\n    /**\r\n     * Returns the logs from strophe.jingle.\r\n     * @returns {Object}\r\n     */\r\n    getJingleLog() {\r\n        const jingle = this.connection.jingle;\r\n\r\n\r\n        return jingle ? jingle.getLog() : {};\r\n    }\r\n\r\n    /**\r\n     * Returns the logs from strophe.\r\n     */\r\n    getXmppLog() {\r\n        return (this.connection.logger || {}).log || null;\r\n    }\r\n\r\n    /**\r\n     *\r\n     */\r\n    dial(...args) {\r\n        this.connection.rayo.dial(...args);\r\n    }\r\n\r\n    /**\r\n     * Pings the server.\r\n     * @param timeout how many ms before a timeout should occur.\r\n     * @returns {Promise} resolved on ping success and reject on an error or\r\n     * a timeout.\r\n     */\r\n    ping(timeout) {\r\n        return new Promise((resolve, reject) => {\r\n            this.connection.ping.ping(this.connection.pingDomain, resolve, reject, timeout);\r\n        });\r\n    }\r\n\r\n    /**\r\n     *\r\n     */\r\n    getSessions() {\r\n        return this.connection.jingle.sessions;\r\n    }\r\n\r\n    /**\r\n     * Disconnects this from the XMPP server (if this is connected).\r\n     *\r\n     * @param {Object} ev - Optionally, the event which triggered the necessity to\r\n     * disconnect from the XMPP server (e.g. beforeunload, unload).\r\n     * @returns {Promise} - Resolves when the disconnect process is finished or rejects with an error.\r\n     */\r\n    disconnect(ev) {\r\n        if (this.disconnectInProgress) {\r\n            return this.disconnectInProgress;\r\n        } else if (!this.connection) {\r\n            return Promise.resolve();\r\n        }\r\n\r\n        this.disconnectInProgress = new Promise(resolve => {\r\n            const disconnectListener = (credentials, status) => {\r\n                if (status === Strophe.Status.DISCONNECTED) {\r\n                    resolve();\r\n                    this.eventEmitter.removeListener(XMPPEvents.CONNECTION_STATUS_CHANGED, disconnectListener);\r\n                }\r\n            };\r\n\r\n            this.eventEmitter.on(XMPPEvents.CONNECTION_STATUS_CHANGED, disconnectListener);\r\n        });\r\n\r\n        this._cleanupXmppConnection(ev);\r\n\r\n        return this.disconnectInProgress;\r\n    }\r\n\r\n    /**\r\n     * The method is supposed to gracefully close the XMPP connection and the main goal is to make sure that the current\r\n     * participant will be removed from the conference XMPP MUC, so that it doesn't leave a \"ghost\" participant behind.\r\n     *\r\n     * @param {Object} ev - Optionally, the event which triggered the necessity to disconnect from the XMPP server\r\n     * (e.g. beforeunload, unload).\r\n     * @private\r\n     * @returns {void}\r\n     */\r\n    _cleanupXmppConnection(ev) {\r\n        // XXX Strophe is asynchronously sending by default. Unfortunately, that means that there may not be enough time\r\n        // to send an unavailable presence or disconnect at all. Switching Strophe to synchronous sending is not much of\r\n        // an option because it may lead to a noticeable delay in navigating away from the current location. As\r\n        // a compromise, we will try to increase the chances of sending an unavailable presence and/or disconnecting\r\n        // within the short time span that we have upon unloading by invoking flush() on the connection. We flush() once\r\n        // before disconnect() in order to attempt to have its unavailable presence at the top of the send queue. We\r\n        // flush() once more after disconnect() in order to attempt to have its unavailable presence sent as soon as\r\n        // possible.\r\n        !this.connection.isUsingWebSocket && this.connection.flush();\r\n\r\n        if (!this.connection.isUsingWebSocket && ev !== null && typeof ev !== 'undefined') {\r\n            const evType = ev.type;\r\n\r\n            if (evType === 'beforeunload' || evType === 'unload') {\r\n                // XXX Whatever we said above, synchronous sending is the best (known) way to properly disconnect from\r\n                // the XMPP server. Consequently, it may be fine to have the source code and comment it in or out\r\n                // depending on whether we want to run with it for some time.\r\n                this.connection.options.sync = true;\r\n\r\n                // This is needed in some browsers where sync xhr sending is disabled by default on unload.\r\n                if (this.connection.sendUnavailableBeacon()) {\r\n\r\n                    return;\r\n                }\r\n            }\r\n        }\r\n\r\n        this.connection.disconnect();\r\n\r\n        if (this.connection.options.sync !== true) {\r\n            this.connection.flush();\r\n        }\r\n    }\r\n\r\n    /**\r\n     *\r\n     */\r\n    _initStrophePlugins() {\r\n        const iceConfig = {\r\n            jvb: { iceServers: [ ] },\r\n            p2p: { iceServers: [ ] }\r\n        };\r\n\r\n        const p2pStunServers = (this.options.p2p\r\n            && this.options.p2p.stunServers) || DEFAULT_STUN_SERVERS;\r\n\r\n        if (Array.isArray(p2pStunServers)) {\r\n            logger.info('P2P STUN servers: ', p2pStunServers);\r\n            iceConfig.p2p.iceServers = p2pStunServers;\r\n        }\r\n\r\n        if (this.options.p2p && this.options.p2p.iceTransportPolicy) {\r\n            logger.info('P2P ICE transport policy: ',\r\n                this.options.p2p.iceTransportPolicy);\r\n\r\n            iceConfig.p2p.iceTransportPolicy\r\n                = this.options.p2p.iceTransportPolicy;\r\n        }\r\n\r\n        this.connection.addConnectionPlugin('emuc', new MucConnectionPlugin(this));\r\n        this.connection.addConnectionPlugin('jingle', new JingleConnectionPlugin(this, this.eventEmitter, iceConfig));\r\n        this.connection.addConnectionPlugin('rayo', new RayoConnectionPlugin());\r\n    }\r\n\r\n    /**\r\n     * Returns details about connection failure. Shard change or is it after\r\n     * suspend.\r\n     * @returns {object} contains details about a connection failure.\r\n     * @private\r\n     */\r\n    _getConnectionFailedReasonDetails() {\r\n        const details = {};\r\n\r\n        // check for moving between shard if information is available\r\n        if (this.options.deploymentInfo\r\n            && this.options.deploymentInfo.shard\r\n            && this.connection.lastResponseHeaders) {\r\n\r\n            // split headers by line\r\n            const headersArr = this.connection.lastResponseHeaders\r\n                .trim().split(/[\\r\\n]+/);\r\n            const headers = {};\r\n\r\n            headersArr.forEach(line => {\r\n                const parts = line.split(': ');\r\n                const header = parts.shift();\r\n                const value = parts.join(': ');\r\n\r\n                headers[header] = value;\r\n            });\r\n\r\n            /* eslint-disable camelcase */\r\n            details.shard_changed\r\n                = this.options.deploymentInfo.shard\r\n                    !== headers['x-jitsi-shard'];\r\n            /* eslint-enable camelcase */\r\n        }\r\n\r\n        /* eslint-disable camelcase */\r\n        // check for possible suspend\r\n        details.suspend_time = this.connection.ping.getPingSuspendTime();\r\n        details.time_since_last_success = this.connection.getTimeSinceLastSuccess();\r\n        /* eslint-enable camelcase */\r\n\r\n        return details;\r\n    }\r\n\r\n    /**\r\n     * Notifies speaker stats component if available that we are the new\r\n     * dominant speaker in the conference.\r\n     * @param {String} roomJid - The room jid where the speaker event occurred.\r\n     */\r\n    sendDominantSpeakerEvent(roomJid) {\r\n        // no speaker stats component advertised\r\n        if (!this.speakerStatsComponentAddress || !roomJid) {\r\n            return;\r\n        }\r\n\r\n        const msg = $msg({ to: this.speakerStatsComponentAddress });\r\n\r\n        msg.c('speakerstats', {\r\n            xmlns: 'http://jitsi.org/jitmeet',\r\n            room: roomJid })\r\n            .up();\r\n\r\n        this.connection.send(msg);\r\n    }\r\n\r\n    /**\r\n     * Check if the given argument is a valid JSON ENDPOINT_MESSAGE string by\r\n     * parsing it and checking if it has a field called 'type'.\r\n     *\r\n     * @param {string} jsonString check if this string is a valid json string\r\n     * and contains the special structure.\r\n     * @returns {boolean, object} if given object is a valid JSON string, return\r\n     * the json object. Otherwise, returns false.\r\n     */\r\n    tryParseJSONAndVerify(jsonString) {\r\n        // ignore empty strings, like message errors\r\n        if (!jsonString) {\r\n            return false;\r\n        }\r\n\r\n        try {\r\n            const json = JSON.parse(jsonString);\r\n\r\n            // Handle non-exception-throwing cases:\r\n            // Neither JSON.parse(false) or JSON.parse(1234) throw errors,\r\n            // hence the type-checking,\r\n            // but... JSON.parse(null) returns null, and\r\n            // typeof null === \"object\",\r\n            // so we must check for that, too.\r\n            // Thankfully, null is falsey, so this suffices:\r\n            if (json && typeof json === 'object') {\r\n                const type = json[JITSI_MEET_MUC_TYPE];\r\n\r\n                if (typeof type !== 'undefined') {\r\n                    return json;\r\n                }\r\n\r\n                logger.debug('parsing valid json but does not have correct '\r\n                    + 'structure', 'topic: ', type);\r\n            }\r\n        } catch (e) {\r\n            logger.error(`Error parsing json ${jsonString}`, e);\r\n\r\n            return false;\r\n        }\r\n\r\n        return false;\r\n    }\r\n\r\n    /**\r\n     * A private message is received, message that is not addressed to the muc.\r\n     * We expect private message coming from plugins component if it is\r\n     * enabled and running.\r\n     *\r\n     * @param {string} msg - The message.\r\n     */\r\n    _onPrivateMessage(msg) {\r\n        const from = msg.getAttribute('from');\r\n\r\n        if (!(from === this.speakerStatsComponentAddress\r\n            || from === this.conferenceDurationComponentAddress\r\n            || from === this.avModerationComponentAddress)) {\r\n            return true;\r\n        }\r\n\r\n        const jsonMessage = $(msg).find('>json-message')\r\n            .text();\r\n        const parsedJson = this.tryParseJSONAndVerify(jsonMessage);\r\n\r\n        if (!parsedJson) {\r\n            return true;\r\n        }\r\n\r\n        if (parsedJson[JITSI_MEET_MUC_TYPE] === 'speakerstats' && parsedJson.users) {\r\n            this.eventEmitter.emit(XMPPEvents.SPEAKER_STATS_RECEIVED, parsedJson.users);\r\n        } else if (parsedJson[JITSI_MEET_MUC_TYPE] === 'conference_duration' && parsedJson.created_timestamp) {\r\n            this.eventEmitter.emit(XMPPEvents.CONFERENCE_TIMESTAMP_RECEIVED, parsedJson.created_timestamp);\r\n        } else if (parsedJson[JITSI_MEET_MUC_TYPE] === 'av_moderation') {\r\n            this.eventEmitter.emit(XMPPEvents.AV_MODERATION_RECEIVED, parsedJson);\r\n        }\r\n\r\n        return true;\r\n    }\r\n}\r\n","/**\r\n * Status that video SIP GW service is available.\r\n * @type {string}\r\n */\r\nexport const STATUS_AVAILABLE = 'available';\r\n\r\n/**\r\n * Status that video SIP GW service is not available.\r\n * @type {string}\r\n */\r\nexport const STATUS_UNDEFINED = 'undefined';\r\n\r\n/**\r\n * Status that video SIP GW service is available but there are no free nodes\r\n * at the moment to serve new requests.\r\n * @type {string}\r\n */\r\nexport const STATUS_BUSY = 'busy';\r\n\r\n/**\r\n * Video SIP GW session state, currently running.\r\n * @type {string}\r\n */\r\nexport const STATE_ON = 'on';\r\n\r\n/**\r\n * Video SIP GW session state, currently stopped and not running.\r\n * @type {string}\r\n */\r\nexport const STATE_OFF = 'off';\r\n\r\n/**\r\n * Video SIP GW session state, currently is starting.\r\n * @type {string}\r\n */\r\nexport const STATE_PENDING = 'pending';\r\n\r\n/**\r\n * Video SIP GW session state, has observed some issues and is retrying at the\r\n * moment.\r\n * @type {string}\r\n */\r\nexport const STATE_RETRYING = 'retrying';\r\n\r\n/**\r\n * Video SIP GW session state, tried to start but it failed.\r\n * @type {string}\r\n */\r\nexport const STATE_FAILED = 'failed';\r\n\r\n/**\r\n * Error on trying to create video SIP GW session in conference where\r\n * there is no room connection (hasn't joined or has left the room).\r\n * @type {string}\r\n */\r\nexport const ERROR_NO_CONNECTION = 'error_no_connection';\r\n\r\n/**\r\n * Error on trying to create video SIP GW session with address for which\r\n * there is an already created session.\r\n * @type {string}\r\n */\r\nexport const ERROR_SESSION_EXISTS = 'error_session_already_exists';\r\n","/**\r\n * The events for the connection.\r\n */\r\n\r\n/**\r\n * Indicates that the connection has been disconnected. The event provides\r\n * the following parameters to its listeners:\r\n *\r\n * @param msg {string} a message associated with the disconnect such as the\r\n * last (known) error message\r\n */\r\nexport const CONNECTION_DISCONNECTED = 'connection.connectionDisconnected';\r\n\r\n/**\r\n * Indicates that the connection has been established. The event provides\r\n * the following parameters to its listeners:\r\n *\r\n * @param id {string} the ID of the local endpoint/participant/peer (within\r\n * the context of the established connection)\r\n */\r\nexport const CONNECTION_ESTABLISHED = 'connection.connectionEstablished';\r\n\r\n/**\r\n * Indicates that the connection has been failed for some reason. The event\r\n * provides the following parameters to its listeners:\r\n *\r\n * @param errType {JitsiConnectionErrors} the type of error associated with\r\n * the failure\r\n * @param errReason {string} the error (message) associated with the failure\r\n * @param credentials {object} the credentials used to connect (if any)\r\n * @param errReasonDetails {object} an optional object with details about\r\n * the error, like shard moving, suspending. Used for analytics purposes.\r\n */\r\nexport const CONNECTION_FAILED = 'connection.connectionFailed';\r\n\r\n/**\r\n * Indicates that the performed action cannot be executed because the\r\n * connection is not in the correct state(connected, disconnected, etc.)\r\n */\r\nexport const WRONG_STATE = 'connection.wrongState';\r\n\r\n/**\r\n * Indicates that the display name is required over this connection and need to be supplied when\r\n * joining the room.\r\n * There are cases like lobby room where display name is required.\r\n */\r\nexport const DISPLAY_NAME_REQUIRED = 'connection.display_name_required';\r\n","/**\r\n * Notifies about audio level in RTP statistics by SSRC.\r\n *\r\n * @param ssrc - The synchronization source identifier (SSRC) of the\r\n * endpoint/participant whose audio level is being reported.\r\n * @param {number} audioLevel - The audio level of <tt>ssrc</tt> according to\r\n * RTP statistics.\r\n * @param {boolean} isLocal - <tt>true</tt> if <tt>ssrc</tt> identifies the\r\n * local endpoint/participant; otherwise, <tt>false</tt>.\r\n */\r\nexport const AUDIO_LEVEL = 'statistics.audioLevel';\r\n\r\n/**\r\n * An event fired just before the statistics module gets disposes and it's\r\n * the last chance to submit some logs that will end up in stats services like\r\n * CallStats (if enabled).\r\n */\r\nexport const BEFORE_DISPOSED = 'statistics.before_disposed';\r\n\r\n/**\r\n * An event carrying all statistics by ssrc.\r\n */\r\nexport const BYTE_SENT_STATS = 'statistics.byte_sent_stats';\r\n\r\n/**\r\n * An event carrying connection statistics.\r\n *\r\n * @param {object} connectionStats - The connection statistics carried by the\r\n * event such as <tt>bandwidth</tt>, <tt>bitrate</tt>, <tt>packetLoss</tt>,\r\n * <tt>resolution</tt>, and <tt>transport</tt>.\r\n */\r\nexport const CONNECTION_STATS = 'statistics.connectionstats';\r\n\r\n/**\r\n * An event carrying performance stats.\r\n */\r\nexport const LONG_TASKS_STATS = 'statistics.long_tasks_stats';\r\n","import {t} from '@models/locales'\r\nimport participants from '@stores/participants/Participants'\r\nimport {action, makeObservable, observable} from 'mobx'\r\nimport { LocalParticipant } from './participants/LocalParticipant'\r\nimport { RemoteParticipant } from './participants/RemoteParticipant'\r\n\r\nexport type ChatMessageType = 'text' | 'log' | 'called' | 'callTo' | 'private'\r\nexport interface ChatMessageToSend{\r\n  msg:string, //  message\r\n  ts:number,  //  timestamp\r\n  to:string   //  send to\r\n}\r\nexport class ChatMessage {\r\n  type:ChatMessageType = 'text'\r\n  text\r\n  pid\r\n  name\r\n  avatarUrl\r\n  timestamp\r\n  colors\r\n  constructor(text:string, pid: string, name:string, avatarUrl:string,\r\n    colors:string[], timestamp: number, type:ChatMessageType) {\r\n    this.text = text\r\n    this.pid = pid\r\n    this.name = name\r\n    this.avatarUrl = avatarUrl\r\n    this.colors = colors\r\n    this.timestamp = timestamp\r\n    this.type = type\r\n  }\r\n}\r\n\r\nexport class Chat {\r\n  @observable messages:ChatMessage[] = []\r\n  @observable sendTo = ''\r\n\r\n  constructor() {\r\n    makeObservable(this)\r\n  }\r\n  @action limitMessages(){\r\n    const MESSAGES_MAX = 1000\r\n    if (chat.messages.length > MESSAGES_MAX){ chat.messages.splice(0, chat.messages.length - MESSAGES_MAX) }\r\n  }\r\n  @action addMessage(msg:ChatMessage){\r\n    this.messages.push(msg)\r\n    this.limitMessages()\r\n  }\r\n  participantNameChanged(pid:string, oldName: string){\r\n    const participant = participants.find(pid)\r\n    if (participant){\r\n      const cm = new ChatMessage('', participant.id, participant.information.name,\r\n        participant.information.avatarSrc, participant.getColor(), Date.now(), 'log')\r\n      cm.text = t('cmNameChanged', {old: oldName, new: cm.name})\r\n      this.addMessage(cm)\r\n    }\r\n  }\r\n  participantJoined(pid: string){\r\n    const participant = participants.find(pid)\r\n    if (participant){\r\n      const cm = new ChatMessage('', participant.id, participant.information.name,\r\n        participant.information.avatarSrc, participant.getColor(), Date.now(), 'log')\r\n      cm.text = t('cmJoined', {name:cm.name})\r\n      this.addMessage(cm)\r\n    }\r\n  }\r\n  participantLeft(pid: string){\r\n    const participant = participants.find(pid)\r\n    if (participant){\r\n      const cm = new ChatMessage('', participant.id, participant.information.name,\r\n        participant.information.avatarSrc, participant.getColor(), Date.now(), 'log')\r\n      cm.text = t('cmLeft', {name:cm.name})\r\n      this.addMessage(cm)\r\n    }\r\n  }\r\n  calledBy(from: RemoteParticipant|LocalParticipant){\r\n    const cm = new ChatMessage('', from.id, from.information.name,\r\n    from.information.avatarSrc, from.getColor(), Date.now(), 'called')\r\n    cm.text = t('cmCallBy', {name:cm.name})\r\n    this.addMessage(cm)\r\n  }\r\n  callTo(to: RemoteParticipant|LocalParticipant){\r\n    const cm = new ChatMessage('', to.id, to.information.name,\r\n    to.information.avatarSrc, to.getColor(), Date.now(), 'callTo')\r\n    cm.text = t('cmCallTo', {name:cm.name})\r\n    this.addMessage(cm)\r\n  }\r\n}\r\n\r\nconst chat = new Chat()\r\nexport default chat\r\n","const ConnectionStates = {\r\n  DISCONNECTED: 'disconnected',\r\n  CONNECTING: 'connecting',\r\n  CONNECTED: 'connected',\r\n}\r\n\r\ntype ConnectionStatesType =\r\n  typeof ConnectionStates.DISCONNECTED |\r\n  typeof ConnectionStates.CONNECTING |\r\n  typeof ConnectionStates.CONNECTED\r\n\r\nexport { ConnectionStates }\r\nexport type { ConnectionStatesType }\r\n\r\nexport const contentTrackCarrierName = '_contentTrackCarrier'\r\nexport const roomInfoPeeperName = '_roomInfoPeeper'\r\n","export interface Pose2DMap {\r\n  position: [number, number]\r\n  orientation: number\r\n}\r\n\r\nexport interface Pose3DAudio {  // right hand cartesian coordinate system\r\n  position: [number, number, number],\r\n  orientation: [number, number, number],\r\n}\r\n\r\nexport function addV2(a:number[], b:number[]): [number, number] {\r\n  return [a[0] + b[0], a[1] + b[1]]\r\n}\r\nexport function subV2(a:number[], b:number[]): [number, number] {\r\n  return [a[0] - b[0], a[1] - b[1]]\r\n}\r\nexport function mulV<S extends number, T extends number[]>(s: S, v2: T): T {\r\n  return [v2[0] * s,  v2[1] * s] as T\r\n}\r\nexport function mulV2(a:number, v:number[]): [number, number] {\r\n  return [a * v[0], a * v[1]]\r\n}\r\nexport function mulV3(a:number, v:number[]): [number, number, number] {\r\n  return [a * v[0], a * v[1], a * v[2]]\r\n}\r\nexport function normV(v:number[]): number {\r\n  let sum = 0\r\n  v.forEach(e => sum += e * e)\r\n\r\n  return Math.sqrt(sum)\r\n}\r\n\r\nexport function degree2Radian(degree: number): number {\r\n  return degree * Math.PI / 180\r\n}\r\n\r\nexport function radian2Degree(radian: number): number {\r\n  return radian * 180 / Math.PI\r\n}\r\n\r\n// relative pose for coordinate: position orientation direction is from positive axis x to positive axis y\r\nexport function getRelativePose(\r\n  base: Pose2DMap,\r\n  relative: Pose2DMap,\r\n  ): Pose2DMap {\r\n  const radian = degree2Radian(base.orientation)\r\n  const s = Math.sin(radian)\r\n  const c = Math.cos(radian)\r\n\r\n  const translatedPosition = [relative.position[0] - base.position[0], relative.position[1] - base.position[1]]\r\n\r\n  const rotatedPosition: [number, number] = [\r\n    translatedPosition[1] * s + translatedPosition[0] * c,\r\n    translatedPosition[1] * c - translatedPosition[0] * s,\r\n  ]\r\n\r\n  const orientation = relative.orientation - base.orientation\r\n\r\n  return {\r\n    position: rotatedPosition,\r\n    orientation: orientation < 0 ? orientation + 360 : orientation,\r\n  }\r\n}\r\n\r\nexport function convertToAudioCoordinate(pose: Pose2DMap): Pose3DAudio {\r\n  const radian = degree2Radian(pose.orientation)\r\n\r\n  return {\r\n    position: [pose.position[0], 0, -pose.position[1]],\r\n    orientation: [Math.sin(radian), 0, Math.cos(radian)],\r\n  }\r\n}\r\n\r\nexport function rotateVector2DByDegree(\r\n  degree: number, vector: [number, number]): [number, number] {\r\n  const rad = degree * (Math.PI / 180)\r\n  const c = Math.cos(rad)\r\n  const s = Math.sin(rad)\r\n\r\n  return [\r\n    c * vector[0] - s * vector[1],\r\n    s * vector[0] + c * vector[1],\r\n  ]\r\n}\r\n\r\n\r\nexport function crossProduct(vec1: [number, number], vec2: [number, number]): number {\r\n  return vec1[0] * vec2[0] + vec1[1] * vec2[1]\r\n}\r\n\r\nexport function vectorLength(vec: [number, number]): number {\r\n  return Math.sqrt(vec.reduce((pre, val) => pre + val * val, 0))\r\n}\r\n\r\nexport function rotate90ClockWise(vec: [number, number]): [number, number] {\r\n  return [vec[1], -vec[0]]\r\n}\r\n\r\n\r\nexport function square(s: number) {\r\n  return s * s\r\n}\r\n\r\n//  rect: [top, right, bottom, left]\r\nexport function getRect(pose: Pose2DMap, size: [number, number]){\r\n  if (pose.orientation === 0){\r\n    return [pose.position[1], pose.position[0] + size[0], pose.position[1] + size[1], pose.position[0]]\r\n  }\r\n  const lt = rotateVector2DByDegree(pose.orientation, pose.position)\r\n  const vr = rotateVector2DByDegree(pose.orientation, [size[0], 0])\r\n  const vb = rotateVector2DByDegree(pose.orientation, [0, size[1]])\r\n  const xs = [lt[0], lt[0]+vr[0], lt[0]+vb[0], lt[0]+vr[0]+vb[0]]\r\n  const ys = [lt[1], lt[1]+vr[1], lt[1]+vb[1], lt[1]+vr[1]+vb[1]]\r\n  xs.sort((a,b) => a-b)\r\n  ys.sort((a,b) => a-b)\r\n\r\n  return [ys[0], xs[3], ys[3], xs[0]]\r\n}\r\n\r\nexport function isOverlapped(a:number[], b:number[]){\r\n  if (a[0] > b[2] || a[2] < b[0]) { return false }\r\n  if (a[3] > b[1] || a[1] < b[3]) { return false }\r\n\r\n  return true\r\n}\r\nexport function isOverlappedToCircle(rect:number[], circle:number[]){\r\n  if (isInRect(circle as [number, number], rect)){ return true }\r\n  const d2 = Math.min(square(rect[3] - circle[0]), square(rect[1] - circle[0]))\r\n    + Math.min(square(rect[0] - circle[1]), square(rect[2] - circle[1]))\r\n\r\n  return d2 < square(circle[2])\r\n}\r\n\r\nexport function isInRect(point: [number, number], rect:number[]){\r\n  return rect[3] <= point[0] && point[0] <= rect[1]\r\n    && rect[0] <= point[1] && point[1] <= rect[2]\r\n}\r\nexport function isInCircle(point: [number, number], circle:number[]){\r\n  const d2 = square(point[0] - circle[0]) + square(point[1] - circle[1])\r\n\r\n  return d2 <= square(circle[2])\r\n}\r\n\r\nexport interface Mouse{\r\n  position:[number, number]\r\n  show: boolean\r\n}\r\n\r\nfunction round(n:number){\r\n  return Math.round(n*100) / 100\r\n}\r\nexport function pose2Str(pose:Pose2DMap){\r\n  return `${round(pose.position[0])},${round(pose.position[1])},${round(pose.orientation)}`\r\n}\r\nexport function mouse2Str(mouse: Mouse){\r\n  return `${mouse.position[0]},${mouse.position[1]},${mouse.show?'t':''}`\r\n}\r\nexport function str2Pose(str:string){\r\n  const poseArray = str.split(',')\r\n  const pose:Pose2DMap = {position:[Number(poseArray[0]), Number(poseArray[1])] as [number, number],\r\n    orientation:Number(poseArray[2])}\r\n\r\n  return pose\r\n}\r\nexport function str2Mouse(str:string){\r\n  const mouseArray = str.split(',')\r\n  const mouse:Mouse = {position:[Number(mouseArray[0]),Number(mouseArray[1])], show: mouseArray[2] ? true : false}\r\n\r\n  return mouse\r\n}\r\n","import { jitsiLocalStorage } from '@jitsi/js-utils';\r\nimport { getLogger } from 'jitsi-meet-logger';\r\n\r\nconst logger = getLogger(__filename);\r\n\r\nimport UsernameGenerator from '../util/UsernameGenerator';\r\n\r\nlet _callStatsUserName;\r\n\r\nlet _machineId;\r\n\r\n/**\r\n *\r\n */\r\nexport default {\r\n\r\n    /**\r\n     * The storage used to store the settings.\r\n     */\r\n    _storage: jitsiLocalStorage,\r\n\r\n    /**\r\n     * Initializes the Settings class.\r\n     *\r\n     * @param {Storage|undefined} externalStorage - Object that implements the Storage interface. This object will be\r\n     * used for storing data instead of jitsiLocalStorage if specified.\r\n     */\r\n    init(externalStorage) {\r\n        this._storage = externalStorage || jitsiLocalStorage;\r\n    },\r\n\r\n    /**\r\n     * Returns fake username for callstats\r\n     * @returns {string} fake username for callstats\r\n     */\r\n    get callStatsUserName() {\r\n        if (!_callStatsUserName) {\r\n            _callStatsUserName = this._storage.getItem('callStatsUserName');\r\n            if (!_callStatsUserName) {\r\n                _callStatsUserName = generateCallStatsUserName();\r\n                this._storage.setItem('callStatsUserName', _callStatsUserName);\r\n            }\r\n        }\r\n\r\n        return _callStatsUserName;\r\n    },\r\n\r\n    /**\r\n     * Returns current machine id.\r\n     * @returns {string} machine id\r\n     */\r\n    get machineId() {\r\n        if (!_machineId) {\r\n            const amDid = this._storage.getItem('billingId');\r\n\r\n            _machineId = amDid || this._storage.getItem('jitsiMeetId');\r\n\r\n            if (amDid) {\r\n                this._storage.setItem('jitsiMeetId', amDid);\r\n            } else if (!_machineId) {\r\n                _machineId = generateJitsiMeetId();\r\n                this._storage.setItem('jitsiMeetId', _machineId);\r\n            }\r\n        }\r\n\r\n        return _machineId;\r\n    },\r\n\r\n    /**\r\n     * Returns current session id.\r\n     * @returns {string} current session id\r\n     */\r\n    get sessionId() {\r\n        // We may update sessionId in localStorage from another JitsiConference\r\n        // instance and that's why we should always re-read it.\r\n        return this._storage.getItem('sessionId');\r\n    },\r\n\r\n    /**\r\n     * Save current session id.\r\n     * @param {string} sessionId session id\r\n     */\r\n    set sessionId(sessionId) {\r\n        if (sessionId) {\r\n            this._storage.setItem('sessionId', sessionId);\r\n        } else {\r\n            this._storage.removeItem('sessionId');\r\n        }\r\n    }\r\n};\r\n\r\n/**\r\n * Generate fake username for callstats.\r\n * @returns {string} fake random username\r\n */\r\nfunction generateCallStatsUserName() {\r\n    const username = UsernameGenerator.generateUsername();\r\n\r\n    logger.log('generated callstats uid', username);\r\n\r\n    return username;\r\n}\r\n\r\n/**\r\n * Generate unique id.\r\n * @returns {string} random unique id\r\n */\r\nfunction generateJitsiMeetId() {\r\n    const jitsiMeetId = generateUniqueId();\r\n\r\n    logger.log('generated id', jitsiMeetId);\r\n\r\n    return jitsiMeetId;\r\n}\r\n\r\n/**\r\n *\r\n */\r\nfunction generateUniqueId() {\r\n    return _p8() + _p8() + _p8() + _p8();\r\n}\r\n\r\n/**\r\n *\r\n */\r\nfunction _p8() {\r\n    return `${Math.random().toString(16)}000000000`.substr(2, 8);\r\n}\r\n","import * as transform from 'sdp-transform';\r\n\r\n/**\r\n * Parses the primary SSRC of given SSRC group.\r\n * @param {object} group the SSRC group object as defined by the 'sdp-transform'\r\n * @return {Number} the primary SSRC number\r\n */\r\nexport function parsePrimarySSRC(group) {\r\n    return parseInt(group.ssrcs.split(' ')[0], 10);\r\n}\r\n\r\n/**\r\n * Parses the secondary SSRC of given SSRC group.\r\n * @param {object} group the SSRC group object as defined by the 'sdp-transform'\r\n * @return {Number} the secondary SSRC number\r\n */\r\nexport function parseSecondarySSRC(group) {\r\n    return parseInt(group.ssrcs.split(' ')[1], 10);\r\n}\r\n\r\n/**\r\n * Tells how many distinct SSRCs are contained in given media line.\r\n * @param {Object} mLine the media line object as defined by 'sdp-transform' lib\r\n * @return {number}\r\n */\r\nfunction _getSSRCCount(mLine) {\r\n    if (!mLine.ssrcs) {\r\n        return 0;\r\n    }\r\n\r\n    return mLine.ssrcs\r\n        .map(ssrcInfo => ssrcInfo.id)\r\n        .filter((ssrc, index, array) => array.indexOf(ssrc) === index)\r\n        .length;\r\n}\r\n\r\n/**\r\n * A wrapper around 'sdp-transform' media description object which provides\r\n * utility methods for common SDP/SSRC related operations.\r\n */\r\nclass MLineWrap {\r\n\r\n    /**\r\n     * Creates new <tt>MLineWrap</t>>\r\n     * @param {Object} mLine the media line object as defined by 'sdp-transform'\r\n     * lib.\r\n     */\r\n    constructor(mLine) {\r\n        if (!mLine) {\r\n            throw new Error('mLine is undefined');\r\n        }\r\n\r\n        this.mLine = mLine;\r\n    }\r\n\r\n    /**\r\n     * Getter for the mLine's \"ssrcs\" array. If the array was undefined an empty\r\n     * one will be preassigned.\r\n     *\r\n     * @return {Array<Object>} an array of 'sdp-transform' SSRC attributes\r\n     * objects.\r\n     */\r\n    get ssrcs() {\r\n        if (!this.mLine.ssrcs) {\r\n            this.mLine.ssrcs = [];\r\n        }\r\n\r\n        return this.mLine.ssrcs;\r\n    }\r\n\r\n    /**\r\n     * Setter for the mLine's \"ssrcs\" array.\r\n     *\r\n     * @param {Array<Object>} ssrcs an array of 'sdp-transform' SSRC attributes\r\n     * objects.\r\n     */\r\n    set ssrcs(ssrcs) {\r\n        this.mLine.ssrcs = ssrcs;\r\n    }\r\n\r\n    /**\r\n     * Returns the direction of the underlying media description.\r\n     * @return {string} the media direction name as defined in the SDP.\r\n     */\r\n    get direction() {\r\n        return this.mLine.direction;\r\n    }\r\n\r\n    /**\r\n     * Modifies the direction of the underlying media description.\r\n     * @param {string} direction the new direction to be set\r\n     */\r\n    set direction(direction) {\r\n        this.mLine.direction = direction;\r\n    }\r\n\r\n    /**\r\n     * Exposes the SSRC group array of the underlying media description object.\r\n     * @return {Array.<Object>}\r\n     */\r\n    get ssrcGroups() {\r\n        if (!this.mLine.ssrcGroups) {\r\n            this.mLine.ssrcGroups = [];\r\n        }\r\n\r\n        return this.mLine.ssrcGroups;\r\n    }\r\n\r\n    /**\r\n     * Modifies the SSRC groups array of the underlying media description\r\n     * object.\r\n     * @param {Array.<Object>} ssrcGroups\r\n     */\r\n    set ssrcGroups(ssrcGroups) {\r\n        this.mLine.ssrcGroups = ssrcGroups;\r\n    }\r\n\r\n    /**\r\n     * Obtains value from SSRC attribute.\r\n     * @param {number} ssrcNumber the SSRC number for which attribute is to be\r\n     * found\r\n     * @param {string} attrName the name of the SSRC attribute to be found.\r\n     * @return {string|undefined} the value of SSRC attribute or\r\n     * <tt>undefined</tt> if no such attribute exists.\r\n     */\r\n    getSSRCAttrValue(ssrcNumber, attrName) {\r\n        const attribute = this.ssrcs.find(\r\n            ssrcObj => ssrcObj.id === ssrcNumber\r\n            && ssrcObj.attribute === attrName);\r\n\r\n\r\n        return attribute && attribute.value;\r\n    }\r\n\r\n    /**\r\n     * Removes all attributes for given SSRC number.\r\n     * @param {number} ssrcNum the SSRC number for which all attributes will be\r\n     * removed.\r\n     */\r\n    removeSSRC(ssrcNum) {\r\n        if (!this.mLine.ssrcs || !this.mLine.ssrcs.length) {\r\n            return;\r\n        }\r\n\r\n        this.mLine.ssrcs\r\n            = this.mLine.ssrcs.filter(ssrcObj => ssrcObj.id !== ssrcNum);\r\n    }\r\n\r\n    /**\r\n     * Adds SSRC attribute\r\n     * @param {object} ssrcObj the SSRC attribute object as defined in\r\n     * the 'sdp-transform' lib.\r\n     */\r\n    addSSRCAttribute(ssrcObj) {\r\n        this.ssrcs.push(ssrcObj);\r\n    }\r\n\r\n    /**\r\n     * Finds a SSRC group matching both semantics and SSRCs in order.\r\n     * @param {string} semantics the name of the semantics\r\n     * @param {string} [ssrcs] group SSRCs as a string (like it's defined in\r\n     * SSRC group object of the 'sdp-transform' lib) e.g. \"1232546 342344 25434\"\r\n     * @return {object|undefined} the SSRC group object or <tt>undefined</tt> if\r\n     * not found.\r\n     */\r\n    findGroup(semantics, ssrcs) {\r\n        return this.ssrcGroups.find(\r\n            group =>\r\n                group.semantics === semantics\r\n                    && (!ssrcs || ssrcs === group.ssrcs));\r\n    }\r\n\r\n    /**\r\n     * Finds all groups matching given semantic's name.\r\n     * @param {string} semantics the name of the semantics\r\n     * @return {Array.<object>} an array of SSRC group objects as defined by\r\n     * the 'sdp-transform' lib.\r\n     */\r\n    findGroups(semantics) {\r\n        return this.ssrcGroups.filter(\r\n            group => group.semantics === semantics);\r\n    }\r\n\r\n    /**\r\n     * Finds all groups matching given semantic's name and group's primary SSRC.\r\n     * @param {string} semantics the name of the semantics\r\n     * @param {number} primarySSRC the primary SSRC number to be matched\r\n     * @return {Object} SSRC group object as defined by the 'sdp-transform' lib.\r\n     */\r\n    findGroupByPrimarySSRC(semantics, primarySSRC) {\r\n        return this.ssrcGroups.find(\r\n            group => group.semantics === semantics\r\n                && parsePrimarySSRC(group) === primarySSRC);\r\n    }\r\n\r\n    /**\r\n     * @param {string|null} msid the media stream id or <tt>null</tt> to match\r\n     * the first SSRC object with any 'msid' value.\r\n     * @return {Object|undefined} the SSRC object as defined by 'sdp-transform'\r\n     * lib.\r\n     */\r\n    findSSRCByMSID(msid) {\r\n        return this.ssrcs.find(\r\n            ssrcObj => ssrcObj.attribute === 'msid'\r\n                && (msid === null || ssrcObj.value === msid));\r\n    }\r\n\r\n    /**\r\n     * Gets the SSRC count for the underlying media description.\r\n     * @return {number}\r\n     */\r\n    getSSRCCount() {\r\n        return _getSSRCCount(this.mLine);\r\n    }\r\n\r\n    /**\r\n     * Checks whether the underlying media description contains any SSRC groups.\r\n     * @return {boolean} <tt>true</tt> if there are any SSRC groups or\r\n     * <tt>false</tt> otherwise.\r\n     */\r\n    containsAnySSRCGroups() {\r\n        return this.mLine.ssrcGroups !== undefined;\r\n    }\r\n\r\n    /**\r\n     * Finds the primary video SSRC.\r\n     * @returns {number|undefined} the primary video ssrc\r\n     * @throws Error if the underlying media description is not a video\r\n     */\r\n    getPrimaryVideoSsrc() {\r\n        const mediaType = this.mLine.type;\r\n\r\n        if (mediaType !== 'video') {\r\n            throw new Error(\r\n                `getPrimarySsrc doesn't work with '${mediaType}'`);\r\n        }\r\n\r\n        const numSsrcs = _getSSRCCount(this.mLine);\r\n\r\n        if (numSsrcs === 1) {\r\n            // Not using \"ssrcs\" getter on purpose here\r\n            return this.mLine.ssrcs[0].id;\r\n        }\r\n\r\n        // Look for a SIM, FID, or FEC-FR group\r\n        if (this.mLine.ssrcGroups) {\r\n            const simGroup = this.findGroup('SIM');\r\n\r\n            if (simGroup) {\r\n                return parsePrimarySSRC(simGroup);\r\n            }\r\n            const fidGroup = this.findGroup('FID');\r\n\r\n            if (fidGroup) {\r\n                return parsePrimarySSRC(fidGroup);\r\n            }\r\n            const fecGroup = this.findGroup('FEC-FR');\r\n\r\n            if (fecGroup) {\r\n                return parsePrimarySSRC(fecGroup);\r\n            }\r\n        }\r\n\r\n    }\r\n\r\n    /**\r\n     * Obtains RTX SSRC from the underlying video description (the\r\n     * secondary SSRC of the first \"FID\" group found)\r\n     * @param {number} primarySsrc the video ssrc for which to find the\r\n     * corresponding rtx ssrc\r\n     * @returns {number|undefined} the rtx ssrc (or undefined if there isn't\r\n     * one)\r\n     */\r\n    getRtxSSRC(primarySsrc) {\r\n        const fidGroup = this.findGroupByPrimarySSRC('FID', primarySsrc);\r\n\r\n\r\n        return fidGroup && parseSecondarySSRC(fidGroup);\r\n    }\r\n\r\n    /**\r\n     * Obtains all SSRCs contained in the underlying media description.\r\n     * @return {Array.<number>} an array with all SSRC as numbers.\r\n     */\r\n    getSSRCs() {\r\n        return this.ssrcs\r\n            .map(ssrcInfo => ssrcInfo.id)\r\n            .filter((ssrc, index, array) => array.indexOf(ssrc) === index);\r\n    }\r\n\r\n    /**\r\n     * Obtains primary video SSRCs.\r\n     * @return {Array.<number>} an array of all primary video SSRCs as numbers.\r\n     * @throws Error if the wrapped media description is not a video.\r\n     */\r\n    getPrimaryVideoSSRCs() {\r\n        const mediaType = this.mLine.type;\r\n\r\n        if (mediaType !== 'video') {\r\n            throw new Error(\r\n                `getPrimaryVideoSSRCs doesn't work with ${mediaType}`);\r\n        }\r\n\r\n        const videoSSRCs = this.getSSRCs();\r\n\r\n        for (const ssrcGroupInfo of this.ssrcGroups) {\r\n            // Right now, FID and FEC-FR groups are the only ones we parse to\r\n            // disqualify streams.  If/when others arise we'll\r\n            // need to add support for them here\r\n            if (ssrcGroupInfo.semantics === 'FID'\r\n                    || ssrcGroupInfo.semantics === 'FEC-FR') {\r\n                // secondary streams should be filtered out\r\n                const secondarySsrc = parseSecondarySSRC(ssrcGroupInfo);\r\n\r\n                videoSSRCs.splice(\r\n                    videoSSRCs.indexOf(secondarySsrc), 1);\r\n            }\r\n        }\r\n\r\n        return videoSSRCs;\r\n    }\r\n\r\n    /**\r\n     * Dumps all SSRC groups of this media description to JSON.\r\n     */\r\n    dumpSSRCGroups() {\r\n        return JSON.stringify(this.mLine.ssrcGroups);\r\n    }\r\n\r\n    /**\r\n     * Removes all SSRC groups which contain given SSRC number at any position.\r\n     * @param {number} ssrc the SSRC for which all matching groups are to be\r\n     * removed.\r\n     */\r\n    removeGroupsWithSSRC(ssrc) {\r\n        if (!this.mLine.ssrcGroups) {\r\n            return;\r\n        }\r\n\r\n        this.mLine.ssrcGroups = this.mLine.ssrcGroups\r\n            .filter(groupInfo => groupInfo.ssrcs.indexOf(`${ssrc}`) === -1);\r\n    }\r\n\r\n    /**\r\n     * Removes groups that match given semantics.\r\n     * @param {string} semantics e.g. \"SIM\" or \"FID\"\r\n     */\r\n    removeGroupsBySemantics(semantics) {\r\n        if (!this.mLine.ssrcGroups) {\r\n            return;\r\n        }\r\n\r\n        this.mLine.ssrcGroups\r\n            = this.mLine.ssrcGroups\r\n                .filter(groupInfo => groupInfo.semantics !== semantics);\r\n    }\r\n\r\n    /**\r\n     * Replaces SSRC (does not affect SSRC groups, but only attributes).\r\n     * @param {number} oldSSRC the old SSRC number\r\n     * @param {number} newSSRC the new SSRC number\r\n     */\r\n    replaceSSRC(oldSSRC, newSSRC) {\r\n        if (this.mLine.ssrcs) {\r\n            this.mLine.ssrcs.forEach(ssrcInfo => {\r\n                if (ssrcInfo.id === oldSSRC) {\r\n                    ssrcInfo.id = newSSRC;\r\n                }\r\n            });\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Adds given SSRC group to this media description.\r\n     * @param {object} group the SSRC group object as defined by\r\n     * the 'sdp-transform' lib.\r\n     */\r\n    addSSRCGroup(group) {\r\n        this.ssrcGroups.push(group);\r\n    }\r\n}\r\n\r\n/**\r\n * Utility class for SDP manipulation using the 'sdp-transform' library.\r\n *\r\n * Typical use usage scenario:\r\n *\r\n * const transformer = new SdpTransformWrap(rawSdp);\r\n * const videoMLine = transformer.selectMedia('video);\r\n * if (videoMLine) {\r\n *     videoMLiner.addSSRCAttribute({\r\n *         id: 2342343,\r\n *         attribute: \"cname\",\r\n *         value: \"someCname\"\r\n *     });\r\n *     rawSdp = transformer.toRawSdp();\r\n * }\r\n */\r\nexport class SdpTransformWrap {\r\n\r\n    /**\r\n     * Creates new instance and parses the raw SDP into objects using\r\n     * 'sdp-transform' lib.\r\n     * @param {string} rawSDP the SDP in raw text format.\r\n     */\r\n    constructor(rawSDP) {\r\n        this.parsedSDP = transform.parse(rawSDP);\r\n    }\r\n\r\n    /**\r\n     * Selects the first media SDP of given name.\r\n     * @param {string} mediaType the name of the media e.g. 'audio', 'video',\r\n     * 'data'.\r\n     * @return {MLineWrap|null} return {@link MLineWrap} instance for the media\r\n     * line or <tt>null</tt> if not found. The object returned references\r\n     * the underlying SDP state held by this <tt>SdpTransformWrap</tt> instance\r\n     * (it's not a copy).\r\n     */\r\n    selectMedia(mediaType) {\r\n        const selectedMLine\r\n            = this.parsedSDP.media.find(mLine => mLine.type === mediaType);\r\n\r\n        return selectedMLine ? new MLineWrap(selectedMLine) : null;\r\n    }\r\n\r\n    /**\r\n     * Converts the currently stored SDP state in this instance to raw text SDP\r\n     * format.\r\n     * @return {string}\r\n     */\r\n    toRawSDP() {\r\n        return transform.write(this.parsedSDP);\r\n    }\r\n}\r\n","\r\n/**\r\n * The method will increase the given number by 1. If the given counter is equal\r\n * or greater to {@link Number.MAX_SAFE_INTEGER} then it will be rolled back to\r\n * 1.\r\n * @param {number} number - An integer counter value to be incremented.\r\n * @return {number} the next counter value increased by 1 (see the description\r\n * above for exception).\r\n */\r\nexport function safeCounterIncrement(number) {\r\n    let nextValue = number;\r\n\r\n    if (number >= Number.MAX_SAFE_INTEGER) {\r\n        nextValue = 0;\r\n    }\r\n\r\n    return nextValue + 1;\r\n}\r\n\r\n/**\r\n * Calculates the average value of am Array of numbers.\r\n *\r\n * @param {Float32Array} valueArray - Array of numbers.\r\n * @returns {number} - Number array average.\r\n */\r\nexport function calculateAverage(valueArray) {\r\n    return valueArray.length > 0 ? valueArray.reduce((a, b) => a + b) / valueArray.length : 0;\r\n}\r\n\r\n/**\r\n * Calculates a unique hash for a given string similar to Java's\r\n * implementation of String.hashCode()\r\n *\r\n * @param {String} string - String whose hash has to be calculated.\r\n * @returns {number} - Unique hash code calculated.\r\n */\r\nexport function hashString(string) {\r\n    let hash = 0;\r\n\r\n    for (let i = 0; i < string.length; i++) {\r\n        hash += Math.pow(string.charCodeAt(i) * 31, string.length - i);\r\n\r\n        /* eslint-disable no-bitwise */\r\n        hash = hash & hash; // Convert to 32bit integer\r\n    }\r\n\r\n    return Math.abs(hash);\r\n}\r\n\r\n/**\r\n * Returns only the positive values from an array of numbers.\r\n *\r\n * @param {Float32Array} valueArray - Array of vad scores.\r\n * @returns {Array} - Array of positive numbers.\r\n */\r\nexport function filterPositiveValues(valueArray) {\r\n    return valueArray.filter(value => value >= 0);\r\n}\r\n\r\n/**\r\n * This class calculates a simple running average that continually changes\r\n * as more data points are collected and added.\r\n */\r\nexport class RunningAverage {\r\n    /**\r\n     * Creates an instance of the running average calculator.\r\n     */\r\n    constructor() {\r\n        this.average = 0;\r\n        this.n = 0;\r\n    }\r\n\r\n    /**\r\n     * Adds a new data point to the existing set of values and recomputes\r\n     * the running average.\r\n     * @param {number} value\r\n     * @returns {void}\r\n     */\r\n    addNext(value) {\r\n        if (typeof value !== 'number') {\r\n            return;\r\n        }\r\n        this.n += 1;\r\n        this.average = this.average + ((value - this.average) / this.n);\r\n    }\r\n\r\n    /**\r\n     * Obtains the average value for the current subset of values.\r\n     * @returns {number} - computed average.\r\n     */\r\n    getAverage() {\r\n        return this.average;\r\n    }\r\n}\r\n","/**\r\n * Indicates that the local connection statistics were updated.\r\n */\r\nexport const LOCAL_STATS_UPDATED = 'cq.local_stats_updated';\r\n\r\n/**\r\n * Indicates that the connection statistics for a particular remote participant\r\n * were updated.\r\n */\r\nexport const REMOTE_STATS_UPDATED = 'cq.remote_stats_updated';\r\n","export {default as participantsStore} from './Participants'\r\n","/**\r\n * The pending Jingle session state which means the session as defined in\r\n * XEP-0166(before 'session-invite/session-accept' took place).\r\n *\r\n * @type {string}\r\n */\r\nexport const PENDING = 'pending';\r\n\r\n/**\r\n * The active Jingle session state as defined in XEP-0166\r\n * (after 'session-invite'/'session-accept').\r\n *\r\n * @type {string}\r\n */\r\nexport const ACTIVE = 'active';\r\n\r\n/**\r\n * The ended Jingle session state as defined in XEP-0166\r\n * (after 'session-terminate').\r\n * @type {string}\r\n */\r\nexport const ENDED = 'ended';\r\n","/**\r\n * The know jingle actions that can be sent and should be acted upon by\r\n * {@code ProxyConnectionService} and {@code ProxyConnectionPC}.\r\n */\r\nexport const ACTIONS = {\r\n    ACCEPT: 'session-accept',\r\n    CONNECTION_ERROR: 'connection-error-encountered',\r\n    INITIATE: 'session-initiate',\r\n    TERMINATE: 'session-terminate',\r\n    TRANSPORT_INFO: 'transport-info',\r\n    UNAVAILABLE: 'unavailable'\r\n};\r\n","/* global callstats */\r\n\r\nimport browser from '../browser';\r\nimport GlobalOnErrorHandler from '../util/GlobalOnErrorHandler';\r\n\r\nconst logger = require('jitsi-meet-logger').getLogger(__filename);\r\n\r\n/**\r\n * We define enumeration of wrtcFuncNames as we need them before\r\n * callstats is initialized to queue events.\r\n * @const\r\n * @see http://www.callstats.io/api/#enumeration-of-wrtcfuncnames\r\n */\r\nconst wrtcFuncNames = {\r\n    createOffer: 'createOffer',\r\n    createAnswer: 'createAnswer',\r\n    setLocalDescription: 'setLocalDescription',\r\n    setRemoteDescription: 'setRemoteDescription',\r\n    addIceCandidate: 'addIceCandidate',\r\n    getUserMedia: 'getUserMedia',\r\n    iceConnectionFailure: 'iceConnectionFailure',\r\n    signalingError: 'signalingError',\r\n    applicationLog: 'applicationLog'\r\n};\r\n\r\n/**\r\n * We define enumeration of fabricEvent as we need them before\r\n * callstats is initialized to queue events.\r\n * @const\r\n * @see http://www.callstats.io/api/#enumeration-of-fabricevent\r\n */\r\nconst fabricEvent = {\r\n    fabricHold: 'fabricHold',\r\n    fabricResume: 'fabricResume',\r\n    audioMute: 'audioMute',\r\n    audioUnmute: 'audioUnmute',\r\n    videoPause: 'videoPause',\r\n    videoResume: 'videoResume',\r\n    fabricUsageEvent: 'fabricUsageEvent',\r\n    fabricStats: 'fabricStats',\r\n    fabricTerminated: 'fabricTerminated',\r\n    screenShareStart: 'screenShareStart',\r\n    screenShareStop: 'screenShareStop',\r\n    dominantSpeaker: 'dominantSpeaker',\r\n    activeDeviceList: 'activeDeviceList'\r\n};\r\n\r\n/**\r\n * The user id to report to callstats as destination.\r\n * @type {string}\r\n */\r\nconst DEFAULT_REMOTE_USER = 'jitsi';\r\n\r\n/**\r\n * Type of pending reports, can be event or an error.\r\n * @type {{ERROR: string, EVENT: string}}\r\n */\r\nconst reportType = {\r\n    ERROR: 'error',\r\n    EVENT: 'event',\r\n    MST_WITH_USERID: 'mstWithUserID'\r\n};\r\n\r\n/**\r\n * Set of currently existing {@link CallStats} instances.\r\n * @type {Set<CallStats>}\r\n */\r\nlet _fabrics;\r\n\r\n/**\r\n * An instance of this class is a wrapper for the CallStats API fabric. A fabric\r\n * reports one peer connection to the CallStats backend and is allocated with\r\n * {@link callstats.addNewFabric}. It has a bunch of instance methods for\r\n * reporting various events. A fabric is considered disposed when\r\n * {@link CallStats.sendTerminateEvent} is executed.\r\n *\r\n * Currently only one backend instance can be created ever and it's done using\r\n * {@link CallStats.initBackend}. At the time of this writing there is no way to\r\n * explicitly shutdown the backend, but it's supposed to close it's connection\r\n * automatically, after all fabrics have been terminated.\r\n */\r\nexport default class CallStats {\r\n    /**\r\n     * A callback passed to {@link callstats.addNewFabric}.\r\n     * @param {string} error 'success' means ok\r\n     * @param {string} msg some more details\r\n     * @private\r\n     */\r\n    static _addNewFabricCallback(error, msg) {\r\n        if (CallStats.backend && error !== 'success') {\r\n            logger.error(`Monitoring status: ${error} msg: ${msg}`);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Callback passed to {@link callstats.initialize} (backend initialization)\r\n     * @param {string} error 'success' means ok\r\n     * @param {String} msg\r\n     * @private\r\n     */\r\n    static _initCallback(error, msg) {\r\n        logger.log(`CallStats Status: err=${error} msg=${msg}`);\r\n\r\n        // there is no lib, nothing to report to\r\n        if (error !== 'success') {\r\n            return;\r\n        }\r\n\r\n        CallStats.backendInitialized = true;\r\n\r\n        // I hate that\r\n        let atLeastOneFabric = false;\r\n        let defaultInstance = null;\r\n\r\n        for (const callStatsInstance of CallStats.fabrics.values()) {\r\n            if (!callStatsInstance.hasFabric) {\r\n                logger.debug('addNewFabric - initCallback');\r\n                if (callStatsInstance._addNewFabric()) {\r\n                    atLeastOneFabric = true;\r\n                    if (!defaultInstance) {\r\n                        defaultInstance = callStatsInstance;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        if (!atLeastOneFabric) {\r\n            return;\r\n        }\r\n\r\n        CallStats._emptyReportQueue(defaultInstance);\r\n    }\r\n\r\n    /**\r\n     * Empties report queue.\r\n     *\r\n     * @param {CallStats} csInstance - The callstats instance.\r\n     * @private\r\n     */\r\n    static _emptyReportQueue(csInstance) {\r\n        // There is no conference ID nor a PeerConnection available when some of\r\n        // the events are scheduled on the reportsQueue, so those will be\r\n        // reported on the first initialized fabric.\r\n        const defaultConfID = csInstance.confID;\r\n        const defaultPC = csInstance.peerconnection;\r\n\r\n        // notify callstats about failures if there were any\r\n        for (const report of CallStats.reportsQueue) {\r\n            if (report.type === reportType.ERROR) {\r\n                const errorData = report.data;\r\n\r\n                CallStats._reportError(\r\n                    csInstance,\r\n                    errorData.type,\r\n                    errorData.error,\r\n                    errorData.pc || defaultPC);\r\n            } else if (report.type === reportType.EVENT) {\r\n                // if we have and event to report and we failed to add\r\n                // fabric this event will not be reported anyway, returning\r\n                // an error\r\n                const eventData = report.data;\r\n\r\n                CallStats.backend.sendFabricEvent(\r\n                    report.pc || defaultPC,\r\n                    eventData.event,\r\n                    defaultConfID,\r\n                    eventData.eventData);\r\n            } else if (report.type === reportType.MST_WITH_USERID) {\r\n                const data = report.data;\r\n\r\n                CallStats.backend.associateMstWithUserID(\r\n                    report.pc || defaultPC,\r\n                    data.callStatsId,\r\n                    defaultConfID,\r\n                    data.ssrc,\r\n                    data.usageLabel,\r\n                    data.containerId\r\n                );\r\n            }\r\n        }\r\n        CallStats.reportsQueue.length = 0;\r\n    }\r\n\r\n    /* eslint-disable max-params */\r\n    /**\r\n     * Reports an error to callstats.\r\n     *\r\n     * @param {CallStats} [cs]\r\n     * @param type the type of the error, which will be one of the wrtcFuncNames\r\n     * @param error the error\r\n     * @param pc the peerconnection\r\n     * @private\r\n     */\r\n    static _reportError(cs, type, error, pc) {\r\n        let _error = error;\r\n\r\n        if (!_error) {\r\n            logger.warn('No error is passed!');\r\n            _error = new Error('Unknown error');\r\n        }\r\n        if (CallStats.backendInitialized && cs) {\r\n            CallStats.backend.reportError(pc, cs.confID, type, _error);\r\n        } else {\r\n            CallStats.reportsQueue.push({\r\n                type: reportType.ERROR,\r\n                data: {\r\n                    error: _error,\r\n                    pc,\r\n                    type\r\n                }\r\n            });\r\n        }\r\n\r\n        // else just ignore it\r\n    }\r\n\r\n    /* eslint-enable max-params */\r\n\r\n    /**\r\n     * Reports an error to callstats.\r\n     *\r\n     * @param {CallStats} cs\r\n     * @param event the type of the event, which will be one of the fabricEvent\r\n     * @param eventData additional data to pass to event\r\n     * @private\r\n     */\r\n    static _reportEvent(cs, event, eventData) {\r\n        const pc = cs && cs.peerconnection;\r\n        const confID = cs && cs.confID;\r\n\r\n        if (CallStats.backendInitialized && cs) {\r\n            CallStats.backend.sendFabricEvent(pc, event, confID, eventData);\r\n        } else {\r\n            CallStats.reportsQueue.push({\r\n                confID,\r\n                pc,\r\n                type: reportType.EVENT,\r\n                data: { event,\r\n                    eventData }\r\n            });\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Wraps some of the CallStats API method and logs their calls with\r\n     * arguments on the debug logging level. Also wraps some of the backend\r\n     * methods execution into try catch blocks to not crash the app in case\r\n     * there is a problem with the backend itself.\r\n     * @param {callstats} theBackend\r\n     * @private\r\n     */\r\n    static _traceAndCatchBackendCalls(theBackend) {\r\n        const tryCatchMethods = [\r\n            'associateMstWithUserID',\r\n            'sendFabricEvent',\r\n            'sendUserFeedback'\r\n\r\n            // 'reportError', - this one needs special handling - see code below\r\n        ];\r\n\r\n        for (const methodName of tryCatchMethods) {\r\n            const originalMethod = theBackend[methodName];\r\n\r\n            theBackend[methodName] = function(...theArguments) {\r\n                try {\r\n                    return originalMethod.apply(theBackend, theArguments);\r\n                } catch (e) {\r\n                    GlobalOnErrorHandler.callErrorHandler(e);\r\n                }\r\n            };\r\n        }\r\n        const debugMethods = [\r\n            'associateMstWithUserID',\r\n            'sendFabricEvent',\r\n            'sendUserFeedback'\r\n\r\n            // 'reportError', - this one needs special handling - see code below\r\n        ];\r\n\r\n        for (const methodName of debugMethods) {\r\n            const originalMethod = theBackend[methodName];\r\n\r\n            theBackend[methodName] = function(...theArguments) {\r\n                logger.debug(methodName, theArguments);\r\n                originalMethod.apply(theBackend, theArguments);\r\n            };\r\n        }\r\n        const originalReportError = theBackend.reportError;\r\n\r\n        /* eslint-disable max-params */\r\n        theBackend.reportError = function(pc, cs, type, ...args) {\r\n            // Logs from the logger are submitted on the applicationLog event\r\n            // \"type\". Logging the arguments on the logger will create endless\r\n            // loop, because it will put all the logs to the logger queue again.\r\n            if (type === wrtcFuncNames.applicationLog) {\r\n                // NOTE otherArguments are not logged to the console on purpose\r\n                // to not log the whole log batch\r\n                // FIXME check the current logging level (currently not exposed\r\n                // by the logger implementation)\r\n                // NOTE it is not safe to log whole objects on react-native as\r\n                // those contain too many circular references and may crash\r\n                // the app.\r\n                if (!browser.isReactNative()) {\r\n                    console && console.debug('reportError', pc, cs, type);\r\n                }\r\n            } else {\r\n                logger.debug('reportError', pc, cs, type, ...args);\r\n            }\r\n            try {\r\n                originalReportError.call(theBackend, pc, cs, type, ...args);\r\n            } catch (exception) {\r\n                if (type === wrtcFuncNames.applicationLog) {\r\n                    console && console.error('reportError', exception);\r\n                } else {\r\n                    GlobalOnErrorHandler.callErrorHandler(exception);\r\n                }\r\n            }\r\n        };\r\n\r\n        /* eslint-enable max-params */\r\n    }\r\n\r\n    /**\r\n     * Returns the Set with the currently existing {@link CallStats} instances.\r\n     * Lazily initializes the Set to allow any Set polyfills to be applied.\r\n     * @type {Set<CallStats>}\r\n     */\r\n    static get fabrics() {\r\n        if (!_fabrics) {\r\n            _fabrics = new Set();\r\n        }\r\n\r\n        return _fabrics;\r\n    }\r\n\r\n    /**\r\n     * Initializes the CallStats backend. Should be called only if\r\n     * {@link CallStats.isBackendInitialized} returns <tt>false</tt>.\r\n     * @param {object} options\r\n     * @param {String} options.callStatsID CallStats credentials - ID\r\n     * @param {String} options.callStatsSecret CallStats credentials - secret\r\n     * @param {string} options.aliasName the <tt>aliasName</tt> part of\r\n     * the <tt>userID</tt> aka endpoint ID, see CallStats docs for more info.\r\n     * @param {string} options.userName the <tt>userName</tt> part of\r\n     * the <tt>userID</tt> aka display name, see CallStats docs for more info.\r\n     *\r\n     */\r\n    static initBackend(options) {\r\n        if (CallStats.backend) {\r\n            throw new Error('CallStats backend has been initialized already!');\r\n        }\r\n        try {\r\n            const CallStatsBackend = callstats;\r\n\r\n            CallStats.backend = new CallStatsBackend();\r\n            CallStats._traceAndCatchBackendCalls(CallStats.backend);\r\n            CallStats.userID = {\r\n                aliasName: options.aliasName,\r\n                userName: options.userName\r\n            };\r\n            CallStats.callStatsID = options.callStatsID;\r\n            CallStats.callStatsSecret = options.callStatsSecret;\r\n\r\n            let configParams;\r\n\r\n            if (options.applicationName) {\r\n                configParams = {\r\n                    applicationVersion:\r\n                        `${options.applicationName} (${\r\n                            browser.getName()})`\r\n                };\r\n            }\r\n\r\n            if (options.confID) {\r\n                // we first check is there a tenant in the confID\r\n                const match = options.confID.match(/.*\\/(.*)\\/.*/);\r\n\r\n                // if there is no tenant, we will just set '/'\r\n                configParams.siteID = options.siteID || (match && match[1]) || '/';\r\n            }\r\n\r\n            // userID is generated or given by the origin server\r\n            CallStats.backend.initialize(\r\n                CallStats.callStatsID,\r\n                CallStats.callStatsSecret,\r\n                CallStats.userID,\r\n                CallStats._initCallback,\r\n                undefined,\r\n                configParams);\r\n\r\n            const getWiFiStatsMethod = options.getWiFiStatsMethod;\r\n\r\n            if (getWiFiStatsMethod) {\r\n                CallStats.backend.attachWifiStatsHandler(getWiFiStatsMethod);\r\n\r\n                getWiFiStatsMethod().then(result => {\r\n                    if (result) {\r\n                        logger.info('Reported wifi addresses:'\r\n                            , JSON.parse(result).addresses);\r\n                    }\r\n                })\r\n                .catch(() => {});// eslint-disable-line no-empty-function\r\n            }\r\n\r\n            return true;\r\n        } catch (e) {\r\n            // The callstats.io API failed to initialize (e.g. because its\r\n            // download did not succeed in general or on time). Further attempts\r\n            // to utilize it cannot possibly succeed.\r\n            GlobalOnErrorHandler.callErrorHandler(e);\r\n            CallStats.backend = null;\r\n            logger.error(e);\r\n\r\n            return false;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Checks if the CallStats backend has been created. It does not mean that\r\n     * it has been initialized, but only that the API instance has been\r\n     * allocated successfully.\r\n     * @return {boolean} <tt>true</tt> if backend exists or <tt>false</tt>\r\n     * otherwise\r\n     */\r\n    static isBackendInitialized() {\r\n        return Boolean(CallStats.backend);\r\n    }\r\n\r\n    /**\r\n     * Notifies CallStats about active device.\r\n     * @param {{deviceList: {String:String}}} devicesData list of devices with\r\n     * their data\r\n     * @param {CallStats} cs callstats instance related to the event\r\n     */\r\n    static sendActiveDeviceListEvent(devicesData, cs) {\r\n        CallStats._reportEvent(cs, fabricEvent.activeDeviceList, devicesData);\r\n    }\r\n\r\n    /**\r\n     * Notifies CallStats that there is a log we want to report.\r\n     *\r\n     * @param {Error} e error to send or {String} message\r\n     * @param {CallStats} cs callstats instance related to the error (optional)\r\n     */\r\n    static sendApplicationLog(e, cs) {\r\n        try {\r\n            CallStats._reportError(\r\n                cs,\r\n                wrtcFuncNames.applicationLog,\r\n                e,\r\n                cs && cs.peerconnection);\r\n        } catch (error) {\r\n            // If sendApplicationLog fails it should not be printed to\r\n            // the logger, because it will try to push the logs again\r\n            // (through sendApplicationLog) and an endless loop is created.\r\n            if (console && (typeof console.error === 'function')) {\r\n                // FIXME send analytics event as well\r\n                console.error('sendApplicationLog failed', error);\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Sends the given feedback through CallStats.\r\n     *\r\n     * @param {string} conferenceID the conference ID for which the feedback\r\n     * will be reported.\r\n     * @param overall an integer between 1 and 5 indicating the\r\n     * user feedback\r\n     * @param comment detailed feedback from the user.\r\n     */\r\n    static sendFeedback(conferenceID, overall, comment) {\r\n        return new Promise((resolve, reject) => {\r\n            if (CallStats.backend) {\r\n                CallStats.backend.sendUserFeedback(\r\n                    conferenceID,\r\n                    {\r\n                        userID: CallStats.userID,\r\n                        overall,\r\n                        comment\r\n                    },\r\n                    (status, message) => {\r\n                        if (status === 'success') {\r\n                            resolve(message);\r\n                        } else {\r\n                            reject(message);\r\n                        }\r\n                    });\r\n            } else {\r\n                const reason = 'Failed to submit feedback to CallStats - no backend';\r\n\r\n                logger.error(reason);\r\n                reject(reason);\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Notifies CallStats that getUserMedia failed.\r\n     *\r\n     * @param {Error} e error to send\r\n     * @param {CallStats} cs callstats instance related to the error (optional)\r\n     */\r\n    static sendGetUserMediaFailed(e, cs) {\r\n        CallStats._reportError(cs, wrtcFuncNames.getUserMedia, e, null);\r\n    }\r\n\r\n    /**\r\n     * Notifies CallStats for mute events\r\n     * @param mute {boolean} true for muted and false for not muted\r\n     * @param type {String} \"audio\"/\"video\"\r\n     * @param {CallStats} cs callstats instance related to the event\r\n     */\r\n    static sendMuteEvent(mute, type, cs) {\r\n        let event;\r\n\r\n        if (type === 'video') {\r\n            event = mute ? fabricEvent.videoPause : fabricEvent.videoResume;\r\n        } else {\r\n            event = mute ? fabricEvent.audioMute : fabricEvent.audioUnmute;\r\n        }\r\n\r\n        CallStats._reportEvent(cs, event);\r\n    }\r\n\r\n    /**\r\n     * Creates new CallStats instance that handles all callstats API calls for\r\n     * given {@link TraceablePeerConnection}. Each instance is meant to handle\r\n     * one CallStats fabric added with 'addFabric' API method for the\r\n     * {@link TraceablePeerConnection} instance passed in the constructor.\r\n     * @param {TraceablePeerConnection} tpc\r\n     * @param {Object} options\r\n     * @param {string} options.confID the conference ID that wil be used to\r\n     * report the session.\r\n     * @param {string} [options.remoteUserID='jitsi'] the remote user ID to\r\n     * which given <tt>tpc</tt> is connected.\r\n     */\r\n    constructor(tpc, options) {\r\n        this.confID = options.confID;\r\n        this.tpc = tpc;\r\n        this.peerconnection = tpc.peerconnection;\r\n        this.remoteUserID = options.remoteUserID || DEFAULT_REMOTE_USER;\r\n        this.hasFabric = false;\r\n\r\n        CallStats.fabrics.add(this);\r\n\r\n        if (CallStats.backendInitialized) {\r\n            this._addNewFabric();\r\n\r\n            // if this is the first fabric let's try to empty the\r\n            // report queue. Reports all events that we recorded between\r\n            // backend initialization and receiving the first fabric\r\n            if (CallStats.fabrics.size === 1) {\r\n                CallStats._emptyReportQueue(this);\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Initializes CallStats fabric by calling \"addNewFabric\" for\r\n     * the peer connection associated with this instance.\r\n     * @return {boolean} true if the call was successful or false otherwise.\r\n     */\r\n    _addNewFabric() {\r\n        logger.info('addNewFabric', this.remoteUserID);\r\n        try {\r\n            const fabricAttributes = {\r\n                remoteEndpointType:\r\n                    this.tpc.isP2P\r\n                        ? CallStats.backend.endpointType.peer\r\n                        : CallStats.backend.endpointType.server\r\n            };\r\n            const ret\r\n                = CallStats.backend.addNewFabric(\r\n                    this.peerconnection,\r\n                    this.remoteUserID,\r\n                    CallStats.backend.fabricUsage.multiplex,\r\n                    this.confID,\r\n                    fabricAttributes,\r\n                    CallStats._addNewFabricCallback);\r\n\r\n            this.hasFabric = true;\r\n\r\n            const success = ret.status === 'success';\r\n\r\n            if (!success) {\r\n                logger.error('callstats fabric not initilized', ret.message);\r\n            }\r\n\r\n            return success;\r\n\r\n        } catch (error) {\r\n            GlobalOnErrorHandler.callErrorHandler(error);\r\n\r\n            return false;\r\n        }\r\n    }\r\n\r\n    /* eslint-disable max-params */\r\n\r\n    /**\r\n     * Lets CallStats module know where is given SSRC rendered by providing\r\n     * renderer tag ID.\r\n     * If the lib is not initialized yet queue the call for later, when it's\r\n     * ready.\r\n     * @param {number} ssrc the SSRC of the stream\r\n     * @param {boolean} isLocal indicates whether this the stream is local\r\n     * @param {string|null} streamEndpointId if the stream is not local the it\r\n     * needs to contain the stream owner's ID\r\n     * @param {string} usageLabel meaningful usage label of this stream like\r\n     *        'microphone', 'camera' or 'screen'.\r\n     * @param {string} containerId  the id of media 'audio' or 'video' tag which\r\n     *        renders the stream.\r\n     */\r\n    associateStreamWithVideoTag(\r\n            ssrc,\r\n            isLocal,\r\n            streamEndpointId,\r\n            usageLabel,\r\n            containerId) {\r\n        if (!CallStats.backend) {\r\n            return;\r\n        }\r\n\r\n        const callStatsId = isLocal ? CallStats.userID : streamEndpointId;\r\n\r\n        if (CallStats.backendInitialized) {\r\n            CallStats.backend.associateMstWithUserID(\r\n                this.peerconnection,\r\n                callStatsId,\r\n                this.confID,\r\n                ssrc,\r\n                usageLabel,\r\n                containerId);\r\n        } else {\r\n            CallStats.reportsQueue.push({\r\n                type: reportType.MST_WITH_USERID,\r\n                pc: this.peerconnection,\r\n                data: {\r\n                    callStatsId,\r\n                    containerId,\r\n                    ssrc,\r\n                    usageLabel\r\n                }\r\n            });\r\n        }\r\n    }\r\n\r\n    /* eslint-enable max-params */\r\n\r\n    /**\r\n     * Notifies CallStats that we are the new dominant speaker in the\r\n     * conference.\r\n     */\r\n    sendDominantSpeakerEvent() {\r\n        CallStats._reportEvent(this, fabricEvent.dominantSpeaker);\r\n    }\r\n\r\n    /**\r\n     * Notifies CallStats that the fabric for the underlying peerconnection was\r\n     * closed and no evens should be reported, after this call.\r\n     */\r\n    sendTerminateEvent() {\r\n        if (CallStats.backendInitialized) {\r\n            CallStats.backend.sendFabricEvent(\r\n                this.peerconnection,\r\n                CallStats.backend.fabricEvent.fabricTerminated,\r\n                this.confID);\r\n        }\r\n        CallStats.fabrics.delete(this);\r\n    }\r\n\r\n    /**\r\n     * Notifies CallStats for ice connection failed\r\n     */\r\n    sendIceConnectionFailedEvent() {\r\n        CallStats._reportError(\r\n            this,\r\n            wrtcFuncNames.iceConnectionFailure,\r\n            null,\r\n            this.peerconnection);\r\n    }\r\n\r\n    /**\r\n     * Notifies CallStats that peer connection failed to create offer.\r\n     *\r\n     * @param {Error} e error to send\r\n     */\r\n    sendCreateOfferFailed(e) {\r\n        CallStats._reportError(\r\n            this, wrtcFuncNames.createOffer, e, this.peerconnection);\r\n    }\r\n\r\n    /**\r\n     * Notifies CallStats that peer connection failed to create answer.\r\n     *\r\n     * @param {Error} e error to send\r\n     */\r\n    sendCreateAnswerFailed(e) {\r\n        CallStats._reportError(\r\n            this, wrtcFuncNames.createAnswer, e, this.peerconnection);\r\n    }\r\n\r\n    /**\r\n     * Sends either resume or hold event for the fabric associated with\r\n     * the underlying peerconnection.\r\n     * @param {boolean} isResume true to resume or false to hold\r\n     */\r\n    sendResumeOrHoldEvent(isResume) {\r\n        CallStats._reportEvent(\r\n            this,\r\n            isResume ? fabricEvent.fabricResume : fabricEvent.fabricHold);\r\n    }\r\n\r\n    /**\r\n     * Notifies CallStats for screen sharing events\r\n     * @param {boolean} start true for starting screen sharing and\r\n     * false for not stopping\r\n     * @param {string|null} ssrc - optional ssrc value, used only when\r\n     * starting screen sharing.\r\n     */\r\n    sendScreenSharingEvent(start, ssrc) {\r\n        let eventData;\r\n\r\n        if (ssrc) {\r\n            eventData = { ssrc };\r\n        }\r\n\r\n        CallStats._reportEvent(\r\n            this,\r\n            start ? fabricEvent.screenShareStart : fabricEvent.screenShareStop,\r\n            eventData);\r\n    }\r\n\r\n    /**\r\n     * Notifies CallStats that peer connection failed to set local description.\r\n     *\r\n     * @param {Error} e error to send\r\n     */\r\n    sendSetLocalDescFailed(e) {\r\n        CallStats._reportError(\r\n            this, wrtcFuncNames.setLocalDescription, e, this.peerconnection);\r\n    }\r\n\r\n    /**\r\n     * Notifies CallStats that peer connection failed to set remote description.\r\n     *\r\n     * @param {Error} e error to send\r\n     */\r\n    sendSetRemoteDescFailed(e) {\r\n        CallStats._reportError(\r\n            this, wrtcFuncNames.setRemoteDescription, e, this.peerconnection);\r\n    }\r\n\r\n    /**\r\n     * Notifies CallStats that peer connection failed to add ICE candidate.\r\n     *\r\n     * @param {Error} e error to send\r\n     */\r\n    sendAddIceCandidateFailed(e) {\r\n        CallStats._reportError(\r\n            this, wrtcFuncNames.addIceCandidate, e, this.peerconnection);\r\n    }\r\n}\r\n\r\n/**\r\n * The CallStats API backend instance\r\n * @type {callstats}\r\n */\r\nCallStats.backend = null;\r\n\r\n// some errors/events may happen before CallStats init\r\n// in this case we accumulate them in this array\r\n// and send them to callstats on init\r\nCallStats.reportsQueue = [];\r\n\r\n/**\r\n * Whether the library was successfully initialized(the backend) using its\r\n * initialize method.\r\n * @type {boolean}\r\n */\r\nCallStats.backendInitialized = false;\r\n\r\n/**\r\n * Part of the CallStats credentials - application ID\r\n * @type {string}\r\n */\r\nCallStats.callStatsID = null;\r\n\r\n/**\r\n * Part of the CallStats credentials - application secret\r\n * @type {string}\r\n */\r\nCallStats.callStatsSecret = null;\r\n\r\n/**\r\n * Local CallStats user ID structure. Can be set only once when\r\n * {@link backend} is initialized, so it's static for the time being.\r\n * See CallStats API for more info:\r\n * https://www.callstats.io/api/#userid\r\n * @type {object}\r\n */\r\nCallStats.userID = null;\r\n","import {MapObject as IMapObject} from '@models/MapObject'\r\nimport { PARTICIPANT_SIZE } from '@models/Participant'\r\nimport {\r\n  addV2, extractRotation, radian2Degree, rotateVector2D, subV2, transformPoint2D} from '@models/utils'\r\nimport {action, computed, makeObservable, observable} from 'mobx'\r\n\r\nconst HALF = 0.5\r\nexport class MapData {\r\n  constructor() {\r\n    makeObservable(this)\r\n    this.loadMatrixFromStorage()\r\n  }\r\n\r\n  @observable matrix: DOMMatrixReadOnly = new DOMMatrixReadOnly()\r\n  @observable committedMatrix: DOMMatrixReadOnly = new DOMMatrixReadOnly()\r\n  @observable screenSize: [number, number] = [0, 0]\r\n  @computed get offset(): [number, number] {\r\n    return [-(this.left + this.screenSize[0] * HALF), -(this.screenSize[1] * HALF)]\r\n  }\r\n  @computed get offsetFromElement(): [number, number] {\r\n    return [-(this.screenSize[0] * HALF), -(this.screenSize[1] * HALF)]\r\n  }\r\n  @computed get rotation(): number {\r\n    return radian2Degree(extractRotation(this.committedMatrix))\r\n  }\r\n  @observable left = 0\r\n  @observable mouse: [number, number] = [0, 0]\r\n  @observable mouseOnMap: [number, number] = [0, 0]\r\n  @action setMatrix(m: DOMMatrixReadOnly) {\r\n    this.matrix = m\r\n  }\r\n  @action setCommittedMatrix(m: DOMMatrixReadOnly) {\r\n    const mouse = this.toWindow(this.mouseOnMap)\r\n    this.committedMatrix = m\r\n    this.mouseOnMap = this.fromWindow(mouse)\r\n    this.saveMatrixToStorage(false)\r\n  }\r\n  @action setScreenSize(s:[number, number]) {\r\n    this.screenSize[0] = s[0]\r\n    this.screenSize[1] = s[1]\r\n  }\r\n  @action setLeft(l:number) {\r\n    this.left = l\r\n  }\r\n  @action setMouse(m:[number, number]) {\r\n    this.mouse = addV2(m, this.offset)\r\n    this.mouseOnMap = transformPoint2D(this.matrix.inverse(), this.mouse)\r\n  }\r\n  @action focusOn(obj: IMapObject) {\r\n    const im = this.matrix.inverse()\r\n    const diff = subV2(obj.pose.position, [im.e, im.f])\r\n    const trn = new DOMMatrix().translate(-diff[0], -diff[1])\r\n    const newMat = trn.preMultiplySelf(this.matrix)\r\n    this.setMatrix(newMat)\r\n    this.setCommittedMatrix(newMat)\r\n  }\r\n  toWindow(pos:[number, number]) {\r\n    return subV2(transformPoint2D(this.matrix, pos), this.offset)\r\n  }\r\n  fromWindow(pos:[number, number]) {\r\n    return transformPoint2D(this.matrix.inverse(), addV2(pos, this.offset))\r\n  }\r\n  toElement(pos:[number, number]) {\r\n    return subV2(transformPoint2D(this.matrix, pos), this.offsetFromElement)\r\n  }\r\n  rotateFromWindow(pos:[number, number]) {\r\n    return rotateVector2D(this.matrix.inverse(), pos)\r\n  }\r\n  rotateToWindow(pos:[number, number]) {\r\n    return rotateVector2D(this.matrix, pos)\r\n  }\r\n  visibleArea(){\r\n    const lt = this.fromWindow([0,0])\r\n    const rb = this.fromWindow(this.screenSize)\r\n    const margin = PARTICIPANT_SIZE\r\n//    console.log(`visibleArea ${lt}, ${rb}`)\r\n\r\n    return [lt[1] - margin, rb[0] + margin, rb[1] + margin, lt[0] - margin]\r\n  }\r\n  readonly keyInputUsers = new Set<string>()\r\n\r\n  saveMatrixToStorage(isLocalStorage: boolean) {\r\n    let storage = sessionStorage\r\n    if (isLocalStorage) { storage = localStorage }\r\n    const ar = [this.matrix.a, this.matrix.b, this.matrix.c, this.matrix.d, this.matrix.e, this.matrix.f]\r\n    storage.setItem('mapMatrix', JSON.stringify(ar))\r\n  }\r\n  @action loadMatrixFromStorage() {\r\n    let storage = localStorage\r\n    if (sessionStorage.getItem('mapMatrix')) {\r\n      storage = sessionStorage\r\n    }\r\n    const str = storage.getItem('mapMatrix')\r\n    if (str) {\r\n      const ar = JSON.parse(str)\r\n      const newMat = new DOMMatrix()\r\n      newMat.a = ar[0]\r\n      newMat.b = ar[1]\r\n      newMat.c = ar[2]\r\n      newMat.d = ar[3]\r\n      newMat.e = ar[4]\r\n      newMat.f = ar[5]\r\n      this.setMatrix(newMat)\r\n      this.setCommittedMatrix(newMat)\r\n    }\r\n  }\r\n}\r\n\r\nconst map = new MapData()\r\ndeclare const d:any\r\nd.map = map\r\nexport default map\r\n","/**\r\n * @const\r\n */\r\nconst ALPHANUM\r\n    = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';\r\n\r\n/**\r\n * Hexadecimal digits.\r\n * @const\r\n */\r\nconst HEX_DIGITS = '0123456789abcdef';\r\n\r\n/**\r\n * Generates random int within the range [min, max]\r\n * @param min the minimum value for the generated number\r\n * @param max the maximum value for the generated number\r\n * @returns random int number\r\n */\r\nfunction randomInt(min, max) {\r\n    return Math.floor(Math.random() * (max - min + 1)) + min;\r\n}\r\n\r\n/**\r\n * Get random element from array or string.\r\n * @param {Array|string} arr source\r\n * @returns array element or string character\r\n */\r\nfunction randomElement(arr) {\r\n    return arr[randomInt(0, arr.length - 1)];\r\n}\r\n\r\n/**\r\n * Generate random alphanumeric string.\r\n * @param {number} length expected string length\r\n * @returns {string} random string of specified length\r\n */\r\nfunction randomAlphanumStr(length) {\r\n    let result = '';\r\n\r\n    for (let i = 0; i < length; i += 1) {\r\n        result += randomElement(ALPHANUM);\r\n    }\r\n\r\n    return result;\r\n}\r\n\r\n/**\r\n * Exported interface.\r\n */\r\nconst RandomUtil = {\r\n    /**\r\n     * Returns a random hex digit.\r\n     * @returns {*}\r\n     */\r\n    randomHexDigit() {\r\n        return randomElement(HEX_DIGITS);\r\n    },\r\n\r\n    /**\r\n     * Returns a random string of hex digits with length 'len'.\r\n     * @param len the length.\r\n     */\r\n    randomHexString(len) {\r\n        let ret = '';\r\n\r\n        while (len--) { // eslint-disable-line no-param-reassign\r\n            ret += this.randomHexDigit();\r\n        }\r\n\r\n        return ret;\r\n    },\r\n    randomElement,\r\n    randomAlphanumStr,\r\n    randomInt\r\n};\r\n\r\nmodule.exports = RandomUtil;\r\n","import Listenable from '../util/Listenable';\r\n\r\n/**\r\n * Creates ConnectionPlugin class that extends the passed class.\r\n * @param {Class} base the definition of the class that will be extended by\r\n * ConnectionPlugin\r\n */\r\nfunction getConnectionPluginDefinition(base = class {}) {\r\n    /**\r\n     * Base class for strophe connection plugins.\r\n     */\r\n    return class extends base {\r\n        /**\r\n         *\r\n         */\r\n        constructor(...args) {\r\n            super(...args);\r\n            this.connection = null;\r\n        }\r\n\r\n        /**\r\n         *\r\n         * @param connection\r\n         */\r\n        init(connection) {\r\n            this.connection = connection;\r\n        }\r\n    };\r\n}\r\n\r\n/**\r\n * ConnectionPlugin class.\r\n */\r\nexport default getConnectionPluginDefinition();\r\n\r\n/**\r\n * ConnectionPlugin class that extends Listenable.\r\n */\r\nexport const ConnectionPluginListenable\r\n    = getConnectionPluginDefinition(Listenable);\r\n","import {PARTICIPANT_SIZE} from '@models/Participant'\r\nimport {ISharedContent} from '@models/ISharedContent'\r\nimport {diffMap} from '@models/utils'\r\nimport {participantsStore as participants} from '@stores/participants'\r\nimport {LocalParticipant} from '@stores/participants/LocalParticipant'\r\nimport {RemoteParticipant} from '@stores/participants/RemoteParticipant'\r\nimport contents from '@stores/sharedContents/SharedContents'\r\nimport {JitsiRemoteTrack, JitsiTrack} from 'lib-jitsi-meet'\r\nimport {autorun, IReactionDisposer, makeObservable, observable} from 'mobx'\r\nimport {RemoteTrackInfo, TrackInfo} from './priorityTypes'\r\n\r\nexport const PRIORITYLOG = false\r\nexport const priorityLog = PRIORITYLOG ? console.log : (a:any) => {}\r\nexport const priorityDebug = PRIORITYLOG ? console.debug : (a:any) => {}\r\n\r\nfunction extractParticipantTrackInfo(participant: RemoteParticipant, track: JitsiTrack): RemoteTrackInfo {\r\n  return {\r\n    endpointId: participant.id,\r\n    onStage : track.isAudioTrack() &&\r\n      (participant.physics.onStage || participants.yarnPhones.has(participant.id)),\r\n    pose: {\r\n      ...participant.pose,\r\n    },\r\n    size: [0, 0],\r\n    offset: 0,\r\n    priority : 0,\r\n    muted: track.isAudioTrack() ? participant.muteAudio : participant.muteVideo\r\n  }\r\n}\r\nfunction extractContentTrackInfo(content: ISharedContent, track:JitsiTrack): RemoteTrackInfo {\r\n  return {\r\n    endpointId: (track as JitsiRemoteTrack).getParticipantId(),\r\n    onStage : false,\r\n    pose: {\r\n      ...content.pose,\r\n    },\r\n    size: content.size,\r\n    offset: -PARTICIPANT_SIZE * 10,\r\n    priority : 0,\r\n    muted: false,\r\n  }\r\n}\r\nfunction extractMainTrackInfo(mainTrack:JitsiRemoteTrack): RemoteTrackInfo {\r\n  return {\r\n    endpointId: mainTrack.getParticipantId(),\r\n    onStage : true,\r\n    pose: {position:[0, 0], orientation: 0},\r\n    size: [0, 0],\r\n    offset: -PARTICIPANT_SIZE * 100,\r\n    priority : 0,\r\n    muted: false,\r\n  }\r\n}\r\n\r\nfunction extractPropsFromLocalParticipant(participant: LocalParticipant): TrackInfo {\r\n  return {\r\n    pose: {\r\n      ...participant.pose,\r\n    },\r\n    onStage: false,\r\n  }\r\n}\r\nexport class PriorityCalculator {\r\n  // props cache\r\n  private local: TrackInfo\r\n\r\n  // batch update\r\n  private updateAll = true      // true when local participant is changed\r\n  private readonly updateSet = new Set<string>() // store changed remote participant\r\n  private limits = [-1, -1]     // limits on maximum numbers of remote video and audio tracks.\r\n  private limitUpdated = false  // true when local participant.remoteVideoLimit orremoteAudioLimit changes\r\n\r\n  // priority cache\r\n  private readonly priorityMaps = [new Map<string, RemoteTrackInfo>(), new Map<string, RemoteTrackInfo>()]\r\n  private lastPriority: [string[], string[]] = [[], []] //  video endpoint ids, audio endpoint ids\r\n\r\n  // list of observable track info lists\r\n  @observable tracksToAccept:[RemoteTrackInfo[], RemoteTrackInfo[]] = [[], []]\r\n\r\n  private disposers: IReactionDisposer[] = []\r\n  private _enabled = false\r\n\r\n  constructor() {\r\n    this.local = extractPropsFromLocalParticipant(participants.local)\r\n    makeObservable(this)\r\n  }\r\n\r\n  clear(){\r\n    this.disable()\r\n    this.updateAll = true\r\n    this.updateSet.clear()\r\n    this.priorityMaps.forEach(m => m.clear())\r\n    this.lastPriority=[[],[]]\r\n    this.tracksToAccept = [[],[]]\r\n  }\r\n\r\n  setLimits(limits:number[]):void {\r\n    this.limits[0] = limits[0]\r\n    this.limits[1] = limits[1]\r\n    this.limitUpdated = true\r\n  }\r\n\r\n  onRemoteTrackAdded(track: JitsiRemoteTrack) {\r\n    this.updateSet.add(track.getParticipantId())\r\n  }\r\n\r\n  get enabled(): boolean {\r\n    return this._enabled\r\n  }\r\n\r\n  // start observing participants store\r\n  enable() {\r\n    this.updateAll = true\r\n\r\n    // track local change\r\n    const localChangeDisposer = autorun(() => {\r\n      const local = participants.local\r\n      this.local = extractPropsFromLocalParticipant(local)\r\n\r\n      this.updateAll = true\r\n    })\r\n\r\n    // track remote changes\r\n    let oldRemoteParticipants = new Map<string, RemoteParticipant>()\r\n    const remoteChangeDisposer = autorun(() => {\r\n      const newRemoteParticipants = new Map<string, RemoteParticipant>(participants.remote)\r\n      const added = diffMap(newRemoteParticipants, oldRemoteParticipants)\r\n      const removed = diffMap(oldRemoteParticipants, newRemoteParticipants)\r\n      removed.forEach(onRemoveParticipant)\r\n      added.forEach(onAddParticipant)\r\n      oldRemoteParticipants = newRemoteParticipants\r\n      //  priorityLog('prioirty remote chagned:', newRemoteParticipants)\r\n    })\r\n\r\n    let oldRemoteContents = new Map<string, Set<JitsiRemoteTrack>>()\r\n    const remoteContentsChangeDisposer = autorun(() => {\r\n      const newRemoteContents = new Map<string, Set<JitsiRemoteTrack>>(contents.tracks.remoteContents)\r\n      const added = diffMap(newRemoteContents, oldRemoteContents)\r\n      const removed = diffMap(oldRemoteContents, newRemoteContents)\r\n      removed.forEach(onRemoveContent)\r\n      added.forEach(onAddContent)\r\n      oldRemoteContents = newRemoteContents\r\n    })\r\n\r\n    const remoteDiposers = new Map<string, IReactionDisposer>()\r\n    const onRemoveParticipant = (rp: RemoteParticipant) => {\r\n      const disposer = remoteDiposers.get(rp.id)\r\n      if (disposer === undefined) {\r\n        throw new Error(`Cannot find disposer for remote participant with id: ${rp.id}`)\r\n      }\r\n      disposer()\r\n      this.priorityMaps.forEach(priorityMap => priorityMap.delete(rp.id))\r\n      remoteDiposers.delete(rp.id)\r\n      this.updateSet.add(rp.id)\r\n      priorityLog('onRemoveParticipant:', rp, this.priorityMaps[0])\r\n    }\r\n    const onRemoveContent = (tracks: Set<JitsiRemoteTrack>, id:string) => {\r\n      const disposer = remoteDiposers.get(id)\r\n      if (disposer === undefined) {\r\n        throw new Error(`Cannot find disposer for remote participant with id: ${id}`)\r\n      }\r\n      disposer()\r\n      this.priorityMaps.forEach(priorityMap => priorityMap.delete(id))\r\n      remoteDiposers.delete(id)\r\n      this.updateSet.add(id)\r\n      priorityLog('onRemoveContent:', id, this.priorityMaps[0])\r\n    }\r\n\r\n    const onAddParticipant = (rp: RemoteParticipant) => {\r\n      remoteDiposers.set(rp.id, autorun(() => {\r\n        if (rp.tracks.audio || rp.tracks.avatar) {\r\n          // eslint-disable-next-line @typescript-eslint/no-unused-vars\r\n          const important = rp.physics.onStage || participants.yarnPhones.has(rp.id)\r\n          // eslint-disable-next-line @typescript-eslint/no-unused-vars\r\n          const moved = rp.pose.position\r\n          this.updateSet.add(rp.id)\r\n        }\r\n      }))\r\n      priorityLog('onAddParticipant:', rp, this.priorityMaps[0])\r\n    }\r\n    const onAddContent = (tracks: Set<JitsiRemoteTrack>, id:string) => {\r\n      remoteDiposers.set(id, autorun(() => {\r\n        // tslint:disable-next-line: max-line-length\r\n        //  priorityLog(`prioirty ${id} chagned v=${(rp.tracks.avatar as JitsiRemoteTrack)?.getSSRC()} a=${(rp.tracks.audio as JitsiRemoteTrack)?.getSSRC()}`)\r\n        if (tracks.size) { //  update when number of the tracks changed\r\n          // eslint-disable-next-line @typescript-eslint/no-unused-vars\r\n          const content = contents.find(id) //  or content changed.\r\n          this.updateSet.add((tracks.values().next().value as JitsiRemoteTrack).getParticipantId())\r\n        }\r\n      }))\r\n      priorityLog('onAddContent:', id, this.priorityMaps[0])\r\n    }\r\n\r\n    this.disposers = [localChangeDisposer, remoteChangeDisposer, remoteContentsChangeDisposer]\r\n    this._enabled = true\r\n  }\r\n\r\n  // stop observing participants store\r\n  disable() {\r\n    this.disposers.forEach(disposer => disposer())\r\n\r\n    this._enabled = false\r\n  }\r\n\r\n  // returns same reference when no updates\r\n  update(): [string[], string[]] {\r\n    if (!this.haveUpdates) {\r\n      return this.lastPriority\r\n    }\r\n\r\n    const priority = this.calcPriority()\r\n\r\n    this.updateAll = false\r\n    this.updateSet.clear()\r\n    this.limitUpdated = false\r\n\r\n    return priority\r\n  }\r\n\r\n  private calcPriority() {\r\n    //  list participants\r\n    const recalculateList = Array.from(participants.remote.keys()).filter(\r\n      key => this.updateAll ? true : this.updateSet.has(key))\r\n    recalculateList.forEach((id) => {\r\n      const rp = participants.remote.get(id)\r\n      if (rp) {\r\n        [rp.tracks.avatar, rp.tracks.audio].forEach((track, idx) => {\r\n          if (track) {\r\n            const trackInfo = extractParticipantTrackInfo(rp, track)\r\n            trackInfo.priority = this.calcPriorityValue(this.local, trackInfo)\r\n            this.priorityMaps[idx].set(rp.id, trackInfo)\r\n          }\r\n        })\r\n      }\r\n    })\r\n\r\n    //  list contents\r\n    const contentTracks = Array.from(contents.tracks.remoteContents.values())\r\n    const carrierIds = contentTracks.map((tracks) => {\r\n      const next = tracks.values().next()\r\n\r\n      return next.done ? undefined : next.value.getParticipantId()\r\n    })\r\n    const recalculateCarrierList = carrierIds.filter(pid => pid && (this.updateAll ? true : this.updateSet.has(pid)))\r\n    recalculateCarrierList.forEach((pid) => {\r\n      const cid = contents.tracks.carrierMap.get(pid!)\r\n      const content = cid ? contents.find(cid) : undefined\r\n      if (content) {\r\n        const tracks = Array.from(contents.tracks.remoteContents.get(content.id)!)\r\n        const videoAudio = [tracks.find(track => track.isVideoTrack()), tracks.find(track => track.isAudioTrack())]\r\n        videoAudio.forEach((track, idx) => {\r\n          if (track) {\r\n            const trackInfo = extractContentTrackInfo(content, track)\r\n            trackInfo.priority = this.calcPriorityValue(this.local, trackInfo)\r\n            this.priorityMaps[idx].set(content.id, trackInfo)\r\n          }\r\n        })\r\n      }\r\n    })\r\n\r\n    //  update prioritizedTrackLists\r\n    const prioritizedTrackInfoLists =\r\n      this.priorityMaps.map(priorityMap =>\r\n        Array.from(priorityMap.values()).sort(\r\n          (a, b) => a.priority - b.priority)) as [RemoteTrackInfo[], RemoteTrackInfo[]]\r\n    //  add main tracks\r\n    const mainTracks = contents.tracks.remoteMainTrack()\r\n    if (mainTracks) {\r\n      prioritizedTrackInfoLists.forEach((list, idx) => {\r\n        const mainTrack = mainTracks[idx]\r\n        if (mainTrack) {\r\n          const mainInfo = extractMainTrackInfo(mainTrack)\r\n          list.unshift(mainInfo)\r\n        }\r\n      })\r\n    }\r\n    const newLists:[RemoteTrackInfo[], RemoteTrackInfo[]] = [[], []]\r\n    //  video\r\n    newLists[0] = prioritizedTrackInfoLists[0].filter(info => !info.muted)\r\n    newLists[0].splice(this.limits[0])\r\n    //  audio : list all\r\n    newLists[1] = prioritizedTrackInfoLists[1]\r\n    const nMuted = prioritizedTrackInfoLists[1].filter(info => info.muted).length\r\n    newLists[1].splice(Math.min(this.limits[0] + nMuted, newLists[1].length))\r\n\r\n    //  done\r\n    this.tracksToAccept = newLists\r\n\r\n    //  end point ids must be sent to JVB.\r\n    const prioritizedEidLists = this.tracksToAccept.map(infos => infos.map(info => info.endpointId))\r\n    this.lastPriority = prioritizedEidLists as [string[], string[]]\r\n\r\n    return this.lastPriority\r\n  }\r\n\r\n  // lower value means higher priority\r\n  private calcPriorityValue(local: TrackInfo, remote: RemoteTrackInfo): number {\r\n    if (remote.onStage) { return 0 }\r\n    const delta = remote.size.map((sz, idx) => {\r\n      let diff = remote.pose.position[idx] - local.pose.position[idx]\r\n      if (diff < 0) {\r\n        diff += sz\r\n        if (diff > 0) { diff = 0 }\r\n      }\r\n\r\n      return diff\r\n    })\r\n    const distance = Math.sqrt(delta[0] * delta[0] + delta[1] * delta[1]) + remote.offset\r\n\r\n    return distance\r\n    //  const position = [local.pose.position, remote.pose.position]\r\n    //  const distance = Math.pow(position[0][0] - position[1][0], 2) + Math.pow(position[0][1] - position[1][1], 2)\r\n  }\r\n\r\n  private get haveUpdates(): boolean {\r\n    return this.updateAll || this.updateSet.size !== 0 || this.limitUpdated\r\n  }\r\n}\r\n","import {connection} from '@models/api'\r\nimport {PriorityCalculator, priorityLog} from '@models/trafficControl/PriorityCalculator'\r\nimport {connectionInfo} from '@stores/index'\r\nimport {participantsStore} from '@stores/participants'\r\nimport JitsiMeetJS from 'lib-jitsi-meet'\r\nimport _ from 'lodash'\r\nimport {autorun} from 'mobx'\r\ndeclare const d:any                  //  from index.html\r\n\r\nexport const priorityCalculator = new PriorityCalculator()\r\nd.priorityCalculator = priorityCalculator\r\n\r\nconst recalculateInterval = 1000\r\nlet intervalHandle: number | undefined = undefined\r\n\r\n\r\nautorun(() => {\r\n  const state = connectionInfo.state\r\n\r\n  if (state === 'connected') {\r\n    priorityCalculator.enable()\r\n    intervalHandle = window.setInterval(\r\n      memoedUpdater,\r\n      recalculateInterval,\r\n    )\r\n  } else if (state === 'disconnected') {\r\n    priorityCalculator.disable()\r\n    if (intervalHandle !== undefined) {\r\n      clearInterval(intervalHandle)\r\n    }\r\n  }\r\n})\r\nautorun(() => {\r\n  const local = participantsStore.local\r\n  priorityCalculator.setLimits([local.remoteVideoLimit, local.remoteAudioLimit])\r\n})\r\n// let interval:NodeJS.Timeout|undefined = undefined\r\nconst memoedUpdater = (() => {\r\n  let memo: any = undefined\r\n\r\n  return () => {\r\n    const res = priorityCalculator.update()\r\n    if (!_.isEqual(res, memo)) {\r\n      // Send res to Jitsi bridge\r\n      const videoConstraints:JitsiMeetJS.VideoConstraints = {\r\n        onStageEndpoints: res[0]\r\n      }\r\n      connection.conference.setReceiverConstraints(videoConstraints)\r\n      connection.conference.setPerceptibles(res)\r\n      priorityLog('setPerceptibles:', res)\r\n      //console.log(`setPerceptibles:${JSON.stringify(res)}`)\r\n      memo = _.cloneDeep(res)\r\n    }\r\n  }\r\n})()\r\n","export function assert(input: any): asserts input {\r\n  if (!input) {\r\n    throw new Error('Not a truthy value')\r\n  }\r\n}\r\n\r\nexport function strcmp(a:string, b:string) {\r\n  if (a < b) { return -1 }\r\n  if (a > b) { return 1 }\r\n\r\n  return 0\r\n}\r\n\r\nexport const isChromium = /Chrome/.test(navigator.userAgent)\r\nexport const isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor)\r\n\r\nexport function shallowEqualsForMap<T1, T2>(map1:Map<T1, T2>, map2:Map<T1, T2>) {\r\n  let testVal\r\n  if (map1.size !== map2.size) {\r\n    return false\r\n  }\r\n  for (const [key, val] of map1) {\r\n    testVal = map2.get(key)\r\n    if (testVal !== val || (testVal === undefined && !map2.has(key))) {\r\n      return false\r\n    }\r\n  }\r\n\r\n  return true\r\n}\r\n\r\n/// a - b for two maps\r\nexport function diffMap<K, V1, V2>(a:Map<K, V1>, b:Map<K, V2>) {\r\n  const diff = new Map<K, V1>(a)\r\n  for (const elem of b) {\r\n    diff.delete(elem[0])\r\n  }\r\n\r\n  return diff\r\n}\r\n\r\n/// a - b for two sets\r\nexport function diffSet<K>(a:Set<K>, b:Set<K>) {\r\n  const diff = new Set<K>(a)\r\n  for (const elem of b) {\r\n    diff.delete(elem)\r\n  }\r\n\r\n  return diff\r\n}\r\n\r\nexport function intersectionMap<K, V1, V2>(a:Map<K, V1>, b:Map<K, V2>) {\r\n  const com = new Map<K, V1>()\r\n  a.forEach((v, k) => {\r\n    if (b.has(k)) {\r\n      com.set(k, v)\r\n    }\r\n  })\r\n\r\n  return com\r\n}\r\n\r\nexport function extract<T>(properties: Record<keyof T, true>) {\r\n  return function<TActual extends T>(value: TActual) {\r\n    const result = {} as T\r\n    for (const property of Object.keys(properties) as (keyof T)[]) {\r\n      result[property] = value[property]\r\n    }\r\n\r\n    return result\r\n  }\r\n}\r\n\r\nexport function isSmartphone() {\r\n  if (navigator.userAgent.match(/iPhone|Android.+Mobile/)) {\r\n    return true\r\n  }\r\n\r\n  return false\r\n}\r\n\r\nexport function isPortrait() {\r\n  if (window.parent.screen.width < window.parent.screen.height) {\r\n    return true\r\n  }\r\n\r\n  return false\r\n}\r\n\r\nexport function isSelfUrl(url: URL){\r\n  return (url.host === window.location.host && url.pathname === window.location.pathname)\r\n}\r\n\r\nexport function checkImageUrl(url: string){\r\n  const img = new Image()\r\n  img.src = url\r\n  const promise = new Promise<string>((resolutionFunc, rejectionFunc) => {\r\n    img.onload = () => { resolutionFunc(url) }\r\n    img.onerror = () => { rejectionFunc('') }\r\n  })\r\n\r\n  return promise\r\n}\r\n","/**\r\n * The errors for the connection.\r\n */\r\n\r\n/**\r\n * Indicates that the connection was dropped with an error which was most likely\r\n * caused by some networking issues. The dropped term in this context means that\r\n * the connection was closed unexpectedly (not on user's request).\r\n *\r\n * One example is 'item-not-found' error thrown by Prosody when the BOSH session\r\n * times out after 60 seconds of inactivity. On the other hand 'item-not-found'\r\n * could also happen when BOSH request is sent to the server with the session-id\r\n * that is not know to the server. But this should not happen in lib-jitsi-meet\r\n * case as long as the service is configured correctly (there is no bug).\r\n */\r\nexport const CONNECTION_DROPPED_ERROR = 'connection.droppedError';\r\n\r\n/**\r\n * Not specified errors.\r\n */\r\nexport const OTHER_ERROR = 'connection.otherError';\r\n\r\n/**\r\n * Indicates that a password is required in order to join the conference.\r\n */\r\nexport const PASSWORD_REQUIRED = 'connection.passwordRequired';\r\n\r\n/**\r\n * Indicates that the connection was dropped, because of too many 5xx HTTP\r\n * errors on BOSH requests.\r\n */\r\nexport const SERVER_ERROR = 'connection.serverError';\r\n","export function getRandomColorRGB(v:string):[number, number, number] {\r\n  let sum = 0\r\n  for (let i = 0; i !== v.length; i += 1) {\r\n    sum = v.charCodeAt(i) + sum * 13\r\n  }\r\n  const num = sum % 0x1000\r\n  const r = Math.floor(num / 0x100) % 0x10\r\n  const g = Math.floor(num / 0x10) % 0x10\r\n  const b = Math.floor(num) % 0x10\r\n\r\n  return [r * 17, g * 17, b * 17]\r\n}\r\n\r\nexport function findTextColorRGB(rgb: number[]):number[] {\r\n  const textColor = isDarkColor(rgb) ? [255, 255, 8*17] : [0,0,8*17]\r\n\r\n  return textColor\r\n}\r\nexport function isDarkColor(rgb: number[]){\r\n  return rgb[0] + rgb[1] + rgb[2] * 0.2 < 20 * 17\r\n}\r\n\r\nexport function findReverseColorRGB(rgb: number[]):number[] {\r\n  return [255-rgb[0], 255-rgb[1], 255-rgb[2]]\r\n}\r\n\r\nexport function rgb2Color(rgb: number[]):string{\r\n  const [r, g, b] = [Math.floor(rgb[0]), Math.floor(rgb[1]), Math.floor(rgb[2])]\r\n  const color = `#${`0${r.toString(16)}`.slice(-2)}${`0${g.toString(16)}`.slice(-2)}${`0${b.toString(16)}`.slice(-2)}`\r\n\r\n  return color\r\n}\r\n\r\nexport function rgb2Colors(rgb: number[]):[string, string, string]{\r\n  const [r, g, b] = [rgb[0] / 17, rgb[1] / 17, rgb[2] / 17]\r\n  const textColor = isDarkColor(rgb) ? '#FF8' : '#008'\r\n  const color = `#${r.toString(16)}${g.toString(16)}${b.toString(16)}`\r\n  const reverseColor = `#${(15 - r).toString(16)}${(15 - g).toString(16)}${(15 - b).toString(16)}`\r\n\r\n  return [color, textColor, reverseColor]\r\n}\r\n\r\nexport function getRandomColor(v:string):[string, string, string] {\r\n  const rgb = getRandomColorRGB(v)\r\n\r\n  return rgb2Colors(rgb)\r\n}\r\n\r\nexport function rgba(rgb:number[], alpha: number) {\r\n  return `rgba(${rgb[0]},${rgb[1]},${rgb[2]},${alpha})`\r\n}\r\n","import { getLogger } from 'jitsi-meet-logger';\r\nimport { $pres, Strophe } from 'strophe.js';\r\nimport 'strophejs-plugin-stream-management';\r\n\r\nimport Listenable from '../util/Listenable';\r\n\r\nimport ResumeTask from './ResumeTask';\r\nimport LastSuccessTracker from './StropheLastSuccess';\r\nimport PingConnectionPlugin from './strophe.ping';\r\n\r\nconst logger = getLogger(__filename);\r\n\r\n/**\r\n * The lib-jitsi-meet layer for {@link Strophe.Connection}.\r\n */\r\nexport default class XmppConnection extends Listenable {\r\n    /**\r\n     * The list of {@link XmppConnection} events.\r\n     *\r\n     * @returns {Object}\r\n     */\r\n    static get Events() {\r\n        return {\r\n            CONN_STATUS_CHANGED: 'CONN_STATUS_CHANGED',\r\n            CONN_SHARD_CHANGED: 'CONN_SHARD_CHANGED'\r\n        };\r\n    }\r\n\r\n    /**\r\n     * The list of Xmpp connection statuses.\r\n     *\r\n     * @returns {Strophe.Status}\r\n     */\r\n    static get Status() {\r\n        return Strophe.Status;\r\n    }\r\n\r\n    /**\r\n     * Initializes new connection instance.\r\n     *\r\n     * @param {Object} options\r\n     * @param {String} options.serviceUrl - The BOSH or WebSocket service URL.\r\n     * @param {String} options.shard - The BOSH or WebSocket is connecting to this shard.\r\n     * Useful for detecting when shard changes.\r\n     * @param {String} [options.enableWebsocketResume=true] - True/false to control the stream resumption functionality.\r\n     * It will enable automatically by default if supported by the XMPP server.\r\n     * @param {Number} [options.websocketKeepAlive=60000] - The websocket keep alive interval.\r\n     * It's the interval + a up to a minute of jitter. Pass -1 to disable.\r\n     * The keep alive is HTTP GET request to {@link options.serviceUrl} or to {@link options.websocketKeepAliveUrl}.\r\n     * @param {Number} [options.websocketKeepAliveUrl] - The websocket keep alive url to use if any,\r\n     * if missing the serviceUrl url will be used.\r\n     * @param {Object} [options.xmppPing] - The xmpp ping settings.\r\n     */\r\n    constructor({ enableWebsocketResume, websocketKeepAlive, websocketKeepAliveUrl, serviceUrl, shard, xmppPing }) {\r\n        super();\r\n        this._options = {\r\n            enableWebsocketResume: typeof enableWebsocketResume === 'undefined' ? true : enableWebsocketResume,\r\n            pingOptions: xmppPing,\r\n            shard,\r\n            websocketKeepAlive: typeof websocketKeepAlive === 'undefined' ? 60 * 1000 : Number(websocketKeepAlive),\r\n            websocketKeepAliveUrl\r\n        };\r\n\r\n        this._stropheConn = new Strophe.Connection(serviceUrl);\r\n        this._usesWebsocket = serviceUrl.startsWith('ws:') || serviceUrl.startsWith('wss:');\r\n\r\n        // The default maxRetries is 5, which is too long.\r\n        this._stropheConn.maxRetries = 3;\r\n\r\n        this._rawInputTracker = new LastSuccessTracker();\r\n        this._rawInputTracker.startTracking(this, this._stropheConn);\r\n\r\n        this._resumeTask = new ResumeTask(this._stropheConn);\r\n\r\n        /**\r\n         * @typedef DeferredSendIQ Object\r\n         * @property {Element} iq - The IQ to send.\r\n         * @property {function} resolve - The resolve method of the deferred Promise.\r\n         * @property {function} reject - The reject method of the deferred Promise.\r\n         * @property {number} timeout - The ID of the timeout task that needs to be cleared, before sending the IQ.\r\n         */\r\n        /**\r\n         * Deferred IQs to be sent upon reconnect.\r\n         * @type {Array<DeferredSendIQ>}\r\n         * @private\r\n         */\r\n        this._deferredIQs = [];\r\n\r\n        // Ping plugin is mandatory for the Websocket mode to work correctly. It's used to detect when the connection\r\n        // is broken (WebSocket/TCP connection not closed gracefully).\r\n        this.addConnectionPlugin(\r\n            'ping',\r\n            new PingConnectionPlugin({\r\n                getTimeSinceLastServerResponse: () => this.getTimeSinceLastSuccess(),\r\n                onPingThresholdExceeded: () => this._onPingErrorThresholdExceeded(),\r\n                pingOptions: xmppPing\r\n            }));\r\n\r\n        // tracks whether this is the initial connection or a reconnect\r\n        this._oneSuccessfulConnect = false;\r\n    }\r\n\r\n    /**\r\n     * A getter for the connected state.\r\n     *\r\n     * @returns {boolean}\r\n     */\r\n    get connected() {\r\n        const websocket = this._stropheConn && this._stropheConn._proto && this._stropheConn._proto.socket;\r\n\r\n        return (this._status === Strophe.Status.CONNECTED || this._status === Strophe.Status.ATTACHED)\r\n            && (!this.isUsingWebSocket || (websocket && websocket.readyState === WebSocket.OPEN));\r\n    }\r\n\r\n    /**\r\n     * Retrieves the feature discovery plugin instance.\r\n     *\r\n     * @returns {Strophe.Connection.disco}\r\n     */\r\n    get disco() {\r\n        return this._stropheConn.disco;\r\n    }\r\n\r\n    /**\r\n     * A getter for the disconnecting state.\r\n     *\r\n     * @returns {boolean}\r\n     */\r\n    get disconnecting() {\r\n        return this._stropheConn.disconnecting === true;\r\n    }\r\n\r\n    /**\r\n     * A getter for the domain.\r\n     *\r\n     * @returns {string|null}\r\n     */\r\n    get domain() {\r\n        return this._stropheConn.domain;\r\n    }\r\n\r\n    /**\r\n     * Tells if Websocket is used as the transport for the current XMPP connection. Returns true for Websocket or false\r\n     * for BOSH.\r\n     * @returns {boolean}\r\n     */\r\n    get isUsingWebSocket() {\r\n        return this._usesWebsocket;\r\n    }\r\n\r\n    /**\r\n     * A getter for the JID.\r\n     *\r\n     * @returns {string|null}\r\n     */\r\n    get jid() {\r\n        return this._stropheConn.jid;\r\n    }\r\n\r\n    /**\r\n     * Returns headers for the last BOSH response received.\r\n     *\r\n     * @returns {string}\r\n     */\r\n    get lastResponseHeaders() {\r\n        return this._stropheConn._proto && this._stropheConn._proto.lastResponseHeaders;\r\n    }\r\n\r\n    /**\r\n     * A getter for the logger plugin instance.\r\n     *\r\n     * @returns {*}\r\n     */\r\n    get logger() {\r\n        return this._stropheConn.logger;\r\n    }\r\n\r\n    /**\r\n     * A getter for the connection options.\r\n     *\r\n     * @returns {*}\r\n     */\r\n    get options() {\r\n        return this._stropheConn.options;\r\n    }\r\n\r\n    /**\r\n     * A getter for the domain to be used for ping.\r\n     */\r\n    get pingDomain() {\r\n        return this._options.pingOptions?.domain || this.domain;\r\n    }\r\n\r\n    /**\r\n     * A getter for the service URL.\r\n     *\r\n     * @returns {string}\r\n     */\r\n    get service() {\r\n        return this._stropheConn.service;\r\n    }\r\n\r\n    /**\r\n     * Returns the current connection status.\r\n     *\r\n     * @returns {Strophe.Status}\r\n     */\r\n    get status() {\r\n        return this._status;\r\n    }\r\n\r\n    /**\r\n     * Adds a connection plugin to this instance.\r\n     *\r\n     * @param {string} name - The name of the plugin or rather a key under which it will be stored on this connection\r\n     * instance.\r\n     * @param {ConnectionPluginListenable} plugin - The plugin to add.\r\n     */\r\n    addConnectionPlugin(name, plugin) {\r\n        this[name] = plugin;\r\n        plugin.init(this);\r\n    }\r\n\r\n    /**\r\n     * See {@link Strophe.Connection.addHandler}\r\n     *\r\n     * @returns {void}\r\n     */\r\n    addHandler(...args) {\r\n        this._stropheConn.addHandler(...args);\r\n    }\r\n\r\n    /* eslint-disable max-params */\r\n    /**\r\n     * Wraps {@link Strophe.Connection.attach} method in order to intercept the connection status updates.\r\n     * See {@link Strophe.Connection.attach} for the params description.\r\n     *\r\n     * @returns {void}\r\n     */\r\n    attach(jid, sid, rid, callback, ...args) {\r\n        this._stropheConn.attach(jid, sid, rid, this._stropheConnectionCb.bind(this, callback), ...args);\r\n    }\r\n\r\n    /**\r\n     * Wraps Strophe.Connection.connect method in order to intercept the connection status updates.\r\n     * See {@link Strophe.Connection.connect} for the params description.\r\n     *\r\n     * @returns {void}\r\n     */\r\n    connect(jid, pass, callback, ...args) {\r\n        this._stropheConn.connect(jid, pass, this._stropheConnectionCb.bind(this, callback), ...args);\r\n    }\r\n\r\n    /* eslint-enable max-params */\r\n\r\n    /**\r\n     * Handles {@link Strophe.Status} updates for the current connection.\r\n     *\r\n     * @param {function} targetCallback - The callback passed by the {@link XmppConnection} consumer to one of\r\n     * the connect methods.\r\n     * @param {Strophe.Status} status - The new connection status.\r\n     * @param {*} args - The rest of the arguments passed by Strophe.\r\n     * @private\r\n     */\r\n    _stropheConnectionCb(targetCallback, status, ...args) {\r\n        this._status = status;\r\n\r\n        let blockCallback = false;\r\n\r\n        if (status === Strophe.Status.CONNECTED || status === Strophe.Status.ATTACHED) {\r\n            this._maybeEnableStreamResume();\r\n\r\n            // after connecting - immediately check whether shard changed,\r\n            // we need this only when using websockets as bosh checks headers from every response\r\n            if (this._usesWebsocket && this._oneSuccessfulConnect) {\r\n                this._keepAliveAndCheckShard();\r\n            }\r\n            this._oneSuccessfulConnect = true;\r\n\r\n            this._maybeStartWSKeepAlive();\r\n            this._processDeferredIQs();\r\n            this._resumeTask.cancel();\r\n            this.ping.startInterval(this._options.pingOptions?.domain || this.domain);\r\n        } else if (status === Strophe.Status.DISCONNECTED) {\r\n            this.ping.stopInterval();\r\n\r\n            // FIXME add RECONNECTING state instead of blocking the DISCONNECTED update\r\n            blockCallback = this._tryResumingConnection();\r\n            if (!blockCallback) {\r\n                clearTimeout(this._wsKeepAlive);\r\n            }\r\n        }\r\n\r\n        if (!blockCallback) {\r\n            targetCallback(status, ...args);\r\n            this.eventEmitter.emit(XmppConnection.Events.CONN_STATUS_CHANGED, status);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Clears the list of IQs and rejects deferred Promises with an error.\r\n     *\r\n     * @private\r\n     */\r\n    _clearDeferredIQs() {\r\n        for (const deferred of this._deferredIQs) {\r\n            deferred.reject(new Error('disconnect'));\r\n        }\r\n        this._deferredIQs = [];\r\n    }\r\n\r\n    /**\r\n     * The method is meant to be used for testing. It's a shortcut for closing the WebSocket.\r\n     *\r\n     * @returns {void}\r\n     */\r\n    closeWebsocket() {\r\n        if (this._stropheConn && this._stropheConn._proto) {\r\n            this._stropheConn._proto._closeSocket();\r\n            this._stropheConn._proto._onClose(null);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * See {@link Strophe.Connection.disconnect}.\r\n     *\r\n     * @returns {void}\r\n     */\r\n    disconnect(...args) {\r\n        this._resumeTask.cancel();\r\n        clearTimeout(this._wsKeepAlive);\r\n        this._clearDeferredIQs();\r\n        this._stropheConn.disconnect(...args);\r\n    }\r\n\r\n    /**\r\n     * See {@link Strophe.Connection.flush}.\r\n     *\r\n     * @returns {void}\r\n     */\r\n    flush(...args) {\r\n        this._stropheConn.flush(...args);\r\n    }\r\n\r\n    /**\r\n     * See {@link LastRequestTracker.getTimeSinceLastSuccess}.\r\n     *\r\n     * @returns {number|null}\r\n     */\r\n    getTimeSinceLastSuccess() {\r\n        return this._rawInputTracker.getTimeSinceLastSuccess();\r\n    }\r\n\r\n    /**\r\n     * See {@link LastRequestTracker.getLastFailedMessage}.\r\n     *\r\n     * @returns {string|null}\r\n     */\r\n    getLastFailedMessage() {\r\n        return this._rawInputTracker.getLastFailedMessage();\r\n    }\r\n\r\n    /**\r\n     * Requests a resume token from the server if enabled and all requirements are met.\r\n     *\r\n     * @private\r\n     */\r\n    _maybeEnableStreamResume() {\r\n        if (!this._options.enableWebsocketResume) {\r\n\r\n            return;\r\n        }\r\n\r\n        const { streamManagement } = this._stropheConn;\r\n\r\n        if (!this.isUsingWebSocket) {\r\n            logger.warn('Stream resume enabled, but WebSockets are not enabled');\r\n        } else if (!streamManagement) {\r\n            logger.warn('Stream resume enabled, but Strophe streamManagement plugin is not installed');\r\n        } else if (!streamManagement.isSupported()) {\r\n            logger.warn('Stream resume enabled, but XEP-0198 is not supported by the server');\r\n        } else if (!streamManagement.getResumeToken()) {\r\n            logger.info('Enabling XEP-0198 stream management');\r\n            streamManagement.enable(/* resume */ true);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Starts the Websocket keep alive if enabled.\r\n     *\r\n     * @private\r\n     * @returns {void}\r\n     */\r\n    _maybeStartWSKeepAlive() {\r\n        const { websocketKeepAlive } = this._options;\r\n\r\n        if (this._usesWebsocket && websocketKeepAlive > 0) {\r\n            this._wsKeepAlive || logger.info(`WebSocket keep alive interval: ${websocketKeepAlive}ms`);\r\n            clearTimeout(this._wsKeepAlive);\r\n\r\n            const intervalWithJitter = /* base */ websocketKeepAlive + /* jitter */ (Math.random() * 60 * 1000);\r\n\r\n            logger.debug(`Scheduling next WebSocket keep-alive in ${intervalWithJitter}ms`);\r\n\r\n            this._wsKeepAlive = setTimeout(\r\n                () => this._keepAliveAndCheckShard()\r\n                    .then(() => this._maybeStartWSKeepAlive()),\r\n                intervalWithJitter);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Do a http GET to the shard and if shard change will throw an event.\r\n     *\r\n     * @private\r\n     * @returns {Promise}\r\n     */\r\n    _keepAliveAndCheckShard() {\r\n        const { shard, websocketKeepAliveUrl } = this._options;\r\n        const url = websocketKeepAliveUrl ? websocketKeepAliveUrl\r\n            : this.service.replace('wss://', 'https://').replace('ws://', 'http://');\r\n\r\n        return fetch(url)\r\n            .then(response => {\r\n\r\n                // skips header checking if there is no info in options\r\n                if (!shard) {\r\n                    return;\r\n                }\r\n\r\n                const responseShard = response.headers.get('x-jitsi-shard');\r\n\r\n                if (responseShard !== shard) {\r\n                    logger.error(\r\n                        `Detected that shard changed from ${shard} to ${responseShard}`);\r\n                    this.eventEmitter.emit(XmppConnection.Events.CONN_SHARD_CHANGED);\r\n                }\r\n            })\r\n            .catch(error => {\r\n                logger.error(`Websocket Keep alive failed for url: ${url}`, { error });\r\n            });\r\n    }\r\n\r\n    /**\r\n     * Goes over the list of {@link DeferredSendIQ} tasks and sends them.\r\n     *\r\n     * @private\r\n     * @returns {void}\r\n     */\r\n    _processDeferredIQs() {\r\n        for (const deferred of this._deferredIQs) {\r\n            if (deferred.iq) {\r\n                clearTimeout(deferred.timeout);\r\n\r\n                const timeLeft = Date.now() - deferred.start;\r\n\r\n                this.sendIQ(\r\n                    deferred.iq,\r\n                    result => deferred.resolve(result),\r\n                    error => deferred.reject(error),\r\n                    timeLeft);\r\n            }\r\n        }\r\n\r\n        this._deferredIQs = [];\r\n    }\r\n\r\n    /**\r\n     * Send a stanza. This function is called to push data onto the send queue to go out over the wire.\r\n     *\r\n     * @param {Element|Strophe.Builder} stanza - The stanza to send.\r\n     * @returns {void}\r\n     */\r\n    send(stanza) {\r\n        if (!this.connected) {\r\n            throw new Error('Not connected');\r\n        }\r\n        this._stropheConn.send(stanza);\r\n    }\r\n\r\n    /**\r\n     * Helper function to send IQ stanzas.\r\n     *\r\n     * @param {Element} elem - The stanza to send.\r\n     * @param {Function} callback - The callback function for a successful request.\r\n     * @param {Function} errback - The callback function for a failed or timed out request.  On timeout, the stanza will\r\n     * be null.\r\n     * @param {number} timeout - The time specified in milliseconds for a timeout to occur.\r\n     * @returns {number} - The id used to send the IQ.\r\n     */\r\n    sendIQ(elem, callback, errback, timeout) {\r\n        if (!this.connected) {\r\n            errback('Not connected');\r\n\r\n            return;\r\n        }\r\n\r\n        return this._stropheConn.sendIQ(elem, callback, errback, timeout);\r\n    }\r\n\r\n    /**\r\n     * Sends an IQ immediately if connected or puts it on the send queue otherwise(in contrary to other send methods\r\n     * which would fail immediately if disconnected).\r\n     *\r\n     * @param {Element} iq - The IQ to send.\r\n     * @param {number} timeout - How long to wait for the response. The time when the connection is reconnecting is\r\n     * included, which means that the IQ may never be sent and still fail with a timeout.\r\n     */\r\n    sendIQ2(iq, { timeout }) {\r\n        return new Promise((resolve, reject) => {\r\n            if (this.connected) {\r\n                this.sendIQ(\r\n                    iq,\r\n                    result => resolve(result),\r\n                    error => reject(error),\r\n                    timeout);\r\n            } else {\r\n                const deferred = {\r\n                    iq,\r\n                    resolve,\r\n                    reject,\r\n                    start: Date.now(),\r\n                    timeout: setTimeout(() => {\r\n                        // clears the IQ on timeout and invalidates the deferred task\r\n                        deferred.iq = undefined;\r\n\r\n                        // Strophe calls with undefined on timeout\r\n                        reject(undefined);\r\n                    }, timeout)\r\n                };\r\n\r\n                this._deferredIQs.push(deferred);\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Called by the ping plugin when ping fails too many times.\r\n     *\r\n     * @returns {void}\r\n     */\r\n    _onPingErrorThresholdExceeded() {\r\n        if (this.isUsingWebSocket) {\r\n            logger.warn('Ping error threshold exceeded - killing the WebSocket');\r\n            this.closeWebsocket();\r\n        }\r\n    }\r\n\r\n    /**\r\n     *  Helper function to send presence stanzas. The main benefit is for sending presence stanzas for which you expect\r\n     *  a responding presence stanza with the same id (for example when leaving a chat room).\r\n     *\r\n     * @param {Element} elem - The stanza to send.\r\n     * @param {Function} callback - The callback function for a successful request.\r\n     * @param {Function} errback - The callback function for a failed or timed out request. On timeout, the stanza will\r\n     * be null.\r\n     * @param {number} timeout - The time specified in milliseconds for a timeout to occur.\r\n     * @returns {number} - The id used to send the presence.\r\n     */\r\n    sendPresence(elem, callback, errback, timeout) {\r\n        if (!this.connected) {\r\n            errback('Not connected');\r\n\r\n            return;\r\n        }\r\n        this._stropheConn.sendPresence(elem, callback, errback, timeout);\r\n    }\r\n\r\n    /**\r\n     * The method gracefully closes the BOSH connection by using 'navigator.sendBeacon'.\r\n     *\r\n     * @returns {boolean} - true if the beacon was sent.\r\n     */\r\n    sendUnavailableBeacon() {\r\n        if (!navigator.sendBeacon || this._stropheConn.disconnecting || !this._stropheConn.connected) {\r\n            return false;\r\n        }\r\n\r\n        this._stropheConn._changeConnectStatus(Strophe.Status.DISCONNECTING);\r\n        this._stropheConn.disconnecting = true;\r\n\r\n        const body = this._stropheConn._proto._buildBody()\r\n            .attrs({\r\n                type: 'terminate'\r\n            });\r\n        const pres = $pres({\r\n            xmlns: Strophe.NS.CLIENT,\r\n            type: 'unavailable'\r\n        });\r\n\r\n        body.cnode(pres.tree());\r\n\r\n        const res = navigator.sendBeacon(\r\n            this.service.indexOf('https://') === -1 ? `https:${this.service}` : this.service,\r\n            Strophe.serialize(body.tree()));\r\n\r\n        logger.info(`Successfully send unavailable beacon ${res}`);\r\n\r\n        this._stropheConn._proto._abortAllRequests();\r\n        this._stropheConn._doDisconnect();\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Tries to use stream management plugin to resume dropped XMPP connection. The streamManagement plugin clears\r\n     * the resume token if any connection error occurs which would put it in unrecoverable state, so as long as\r\n     * the token is present it means the connection can be resumed.\r\n     *\r\n     * @private\r\n     * @returns {boolean}\r\n     */\r\n    _tryResumingConnection() {\r\n        const { streamManagement } = this._stropheConn;\r\n        const resumeToken = streamManagement && streamManagement.getResumeToken();\r\n\r\n        if (resumeToken) {\r\n            this._resumeTask.schedule();\r\n\r\n            return true;\r\n        }\r\n\r\n        return false;\r\n    }\r\n}\r\n","/**\r\n * Event triggered when participant's muted status changes.\r\n * @param {string} endpointId the track owner's identifier (MUC nickname)\r\n * @param {MediaType} mediaType \"audio\" or \"video\"\r\n * @param {boolean} isMuted the new muted state\r\n */\r\nexport const PEER_MUTED_CHANGED = 'signaling.peerMuted';\r\n\r\n/**\r\n * Event triggered when participant's video type changes.\r\n * @param {string} endpointId the video owner's ID (MUC nickname)\r\n * @param {VideoType} videoType the new value\r\n */\r\nexport const PEER_VIDEO_TYPE_CHANGED = 'signaling.peerVideoType';\r\n","export const CALLSTATS_SCRIPT_URL = 'https://api.callstats.io/static/callstats-ws.min.js';\r\n\r\n/**\r\n * The number of remote speakers for which the audio levels will be calculated using\r\n * RTCRtpReceiver#getSynchronizationSources. Limit the number of endpoints to save cpu on the client as this API call\r\n * is known to take longer to execute when there are many audio receivers.\r\n */\r\nexport const SPEAKERS_AUDIO_LEVELS = 5;\r\n","export function getNotificationPermission(){\r\n  if (Notification.permission !== 'granted' && Notification.permission !== 'denied') {\r\n    Notification.requestPermission()\r\n  }\r\n}\r\nexport function notification(title: string, options?: NotificationOptions){\r\n  if (Notification.permission === \"granted\") {\r\n    // tslint:disable-next-line: no-unused-expression\r\n    new Notification(title, options)\r\n  }\r\n}\r\n","\r\n/**\r\n * Promise-like object which can be passed around for resolving it later. It\r\n * implements the \"thenable\" interface, so it can be used wherever a Promise\r\n * could be used.\r\n *\r\n * In addition a \"reject on timeout\" functionality is provided.\r\n */\r\nexport default class Deferred {\r\n    /**\r\n     * Instantiates a Deferred object.\r\n     */\r\n    constructor() {\r\n        this.promise = new Promise((resolve, reject) => {\r\n            this.resolve = (...args) => {\r\n                this.clearRejectTimeout();\r\n                resolve(...args);\r\n            };\r\n            this.reject = (...args) => {\r\n                this.clearRejectTimeout();\r\n                reject(...args);\r\n            };\r\n        });\r\n        this.then = this.promise.then.bind(this.promise);\r\n        this.catch = this.promise.catch.bind(this.promise);\r\n    }\r\n\r\n    /**\r\n     * Clears the reject timeout.\r\n     */\r\n    clearRejectTimeout() {\r\n        clearTimeout(this._timeout);\r\n    }\r\n\r\n    /**\r\n     * Rejects the promise after the given timeout.\r\n     */\r\n    setRejectTimeout(ms) {\r\n        this._timeout = setTimeout(() => {\r\n            this.reject(new Error('timeout'));\r\n        }, ms);\r\n    }\r\n}\r\n","\r\nimport JitsiTrackError from '../../JitsiTrackError';\r\nimport * as JitsiTrackErrors from '../../JitsiTrackErrors';\r\nimport browser from '../browser';\r\n\r\nconst logger = require('jitsi-meet-logger').getLogger(__filename);\r\n\r\n/**\r\n * The default frame rate for Screen Sharing.\r\n */\r\nexport const SS_DEFAULT_FRAME_RATE = 5;\r\n\r\n/**\r\n * Handles obtaining a stream from a screen capture on different browsers.\r\n */\r\nconst ScreenObtainer = {\r\n    /**\r\n     * If not <tt>null</tt> it means that the initialization process is still in\r\n     * progress. It is used to make desktop stream request wait and continue\r\n     * after it's done.\r\n     * {@type Promise|null}\r\n     */\r\n\r\n    obtainStream: null,\r\n\r\n    /**\r\n     * Initializes the function used to obtain a screen capture\r\n     * (this.obtainStream).\r\n     *\r\n     * @param {object} options\r\n     */\r\n    init(options = {}) {\r\n        this.options = options;\r\n        this.obtainStream = this._createObtainStreamMethod();\r\n\r\n        if (!this.obtainStream) {\r\n            logger.info('Desktop sharing disabled');\r\n        }\r\n    },\r\n\r\n    /**\r\n     * Returns a method which will be used to obtain the screen sharing stream\r\n     * (based on the browser type).\r\n     *\r\n     * @returns {Function}\r\n     * @private\r\n     */\r\n    _createObtainStreamMethod() {\r\n        if (browser.isNWJS()) {\r\n            return (onSuccess, onFailure) => {\r\n                window.JitsiMeetNW.obtainDesktopStream(\r\n                    onSuccess,\r\n                    (error, constraints) => {\r\n                        let jitsiError;\r\n\r\n                        // FIXME:\r\n                        // This is very very dirty fix for recognising that the\r\n                        // user have clicked the cancel button from the Desktop\r\n                        // sharing pick window. The proper solution would be to\r\n                        // detect this in the NWJS application by checking the\r\n                        // streamId === \"\". Even better solution would be to\r\n                        // stop calling GUM from the NWJS app and just pass the\r\n                        // streamId to lib-jitsi-meet. This way the desktop\r\n                        // sharing implementation for NWJS and chrome extension\r\n                        // will be the same and lib-jitsi-meet will be able to\r\n                        // control the constraints, check the streamId, etc.\r\n                        //\r\n                        // I cannot find documentation about \"InvalidStateError\"\r\n                        // but this is what we are receiving from GUM when the\r\n                        // streamId for the desktop sharing is \"\".\r\n\r\n                        if (error && error.name === 'InvalidStateError') {\r\n                            jitsiError = new JitsiTrackError(\r\n                                JitsiTrackErrors.SCREENSHARING_USER_CANCELED\r\n                            );\r\n                        } else {\r\n                            jitsiError = new JitsiTrackError(\r\n                                error, constraints, [ 'desktop' ]);\r\n                        }\r\n                        (typeof onFailure === 'function')\r\n                            && onFailure(jitsiError);\r\n                    });\r\n            };\r\n        } else if (browser.isElectron()) {\r\n            return this.obtainScreenOnElectron;\r\n        } else if (browser.isReactNative() && browser.supportsGetDisplayMedia()) {\r\n            return this.obtainScreenFromGetDisplayMediaRN;\r\n        } else if (browser.supportsGetDisplayMedia()) {\r\n            return this.obtainScreenFromGetDisplayMedia;\r\n        }\r\n        logger.log('Screen sharing not supported on ', browser.getName());\r\n\r\n        return null;\r\n    },\r\n\r\n    /**\r\n     * Gets the appropriate constraints for audio sharing.\r\n     *\r\n     * @returns {Object|boolean}\r\n     */\r\n    _getAudioConstraints() {\r\n        const { audioQuality } = this.options;\r\n        const audio = audioQuality?.stereo ? {\r\n            autoGainControl: false,\r\n            channelCount: 2,\r\n            echoCancellation: false,\r\n            noiseSuppression: false\r\n        } : true;\r\n\r\n        return audio;\r\n    },\r\n\r\n    /**\r\n     * Checks whether obtaining a screen capture is supported in the current\r\n     * environment.\r\n     * @returns {boolean}\r\n     */\r\n    isSupported() {\r\n        return this.obtainStream !== null;\r\n    },\r\n\r\n    /**\r\n     * Obtains a screen capture stream on Electron.\r\n     *\r\n     * @param onSuccess - Success callback.\r\n     * @param onFailure - Failure callback.\r\n     */\r\n    obtainScreenOnElectron(onSuccess, onFailure) {\r\n        if (window.JitsiMeetScreenObtainer && window.JitsiMeetScreenObtainer.openDesktopPicker) {\r\n            const { desktopSharingFrameRate, desktopSharingSources } = this.options;\r\n\r\n            window.JitsiMeetScreenObtainer.openDesktopPicker(\r\n                {\r\n                    desktopSharingSources: desktopSharingSources || [ 'screen', 'window' ]\r\n                },\r\n                (streamId, streamType, screenShareAudio = false) => {\r\n                    if (streamId) {\r\n                        let audioConstraints = false;\r\n\r\n                        if (screenShareAudio) {\r\n                            audioConstraints = {};\r\n                            const optionalConstraints = this._getAudioConstraints();\r\n\r\n                            if (typeof optionalConstraints !== 'boolean') {\r\n                                audioConstraints = {\r\n                                    optional: optionalConstraints\r\n                                };\r\n                            }\r\n\r\n                            // Audio screen sharing for electron only works for screen type devices.\r\n                            // i.e. when the user shares the whole desktop.\r\n                            // Note. The documentation specifies that chromeMediaSourceId should not be present\r\n                            // which, in the case a users has multiple monitors, leads to them being shared all\r\n                            // at once. However we tested with chromeMediaSourceId present and it seems to be\r\n                            // working properly.\r\n                            if (streamType === 'screen') {\r\n                                audioConstraints.mandatory = {\r\n                                    chromeMediaSource: 'desktop'\r\n                                };\r\n                            }\r\n                        }\r\n\r\n                        const constraints = {\r\n                            audio: audioConstraints,\r\n                            video: {\r\n                                mandatory: {\r\n                                    chromeMediaSource: 'desktop',\r\n                                    chromeMediaSourceId: streamId,\r\n                                    minFrameRate: desktopSharingFrameRate?.min ?? SS_DEFAULT_FRAME_RATE,\r\n                                    maxFrameRate: desktopSharingFrameRate?.max ?? SS_DEFAULT_FRAME_RATE,\r\n                                    maxWidth: window.screen.width,\r\n                                    maxHeight: window.screen.height\r\n                                }\r\n                            }\r\n                        };\r\n\r\n                        // We have to use the old API on Electron to get a desktop stream.\r\n                        navigator.mediaDevices.getUserMedia(constraints)\r\n                            .then(stream => onSuccess({\r\n                                stream,\r\n                                sourceId: streamId,\r\n                                sourceType: streamType\r\n                            }), onFailure);\r\n                    } else {\r\n                        // As noted in Chrome Desktop Capture API:\r\n                        // If user didn't select any source (i.e. canceled the prompt)\r\n                        // then the callback is called with an empty streamId.\r\n                        onFailure(new JitsiTrackError(JitsiTrackErrors.SCREENSHARING_USER_CANCELED));\r\n                    }\r\n                },\r\n                err => onFailure(new JitsiTrackError(\r\n                    JitsiTrackErrors.ELECTRON_DESKTOP_PICKER_ERROR,\r\n                    err\r\n                ))\r\n            );\r\n        } else {\r\n            onFailure(new JitsiTrackError(JitsiTrackErrors.ELECTRON_DESKTOP_PICKER_NOT_FOUND));\r\n        }\r\n    },\r\n\r\n    /**\r\n     * Obtains a screen capture stream using getDisplayMedia.\r\n     *\r\n     * @param callback - The success callback.\r\n     * @param errorCallback - The error callback.\r\n     */\r\n    obtainScreenFromGetDisplayMedia(callback, errorCallback) {\r\n        let getDisplayMedia;\r\n\r\n        if (navigator.getDisplayMedia) {\r\n            getDisplayMedia = navigator.getDisplayMedia.bind(navigator);\r\n        } else {\r\n            // eslint-disable-next-line max-len\r\n            getDisplayMedia = navigator.mediaDevices.getDisplayMedia.bind(navigator.mediaDevices);\r\n        }\r\n\r\n        const { desktopSharingFrameRate } = this.options;\r\n        const video = typeof desktopSharingFrameRate === 'object' ? { frameRate: desktopSharingFrameRate } : true;\r\n        const audio = this._getAudioConstraints();\r\n\r\n        // At the time of this writing 'min' constraint for fps is not supported by getDisplayMedia.\r\n        video.frameRate && delete video.frameRate.min;\r\n\r\n        const constraints = {\r\n            video,\r\n            audio,\r\n            cursor: 'always'\r\n        };\r\n\r\n        logger.info('Using getDisplayMedia for screen sharing', constraints);\r\n\r\n        getDisplayMedia(constraints)\r\n            .then(stream => {\r\n                callback({\r\n                    stream,\r\n                    sourceId: stream.id\r\n                });\r\n            })\r\n            .catch(error => {\r\n                const errorDetails = {\r\n                    errorName: error && error.name,\r\n                    errorMsg: error && error.message,\r\n                    errorStack: error && error.stack\r\n                };\r\n\r\n                logger.error('getDisplayMedia error', constraints, errorDetails);\r\n\r\n                if (errorDetails.errorMsg && errorDetails.errorMsg.indexOf('denied by system') !== -1) {\r\n                    // On Chrome this is the only thing different between error returned when user cancels\r\n                    // and when no permission was given on the OS level.\r\n                    errorCallback(new JitsiTrackError(JitsiTrackErrors.PERMISSION_DENIED));\r\n\r\n                    return;\r\n                }\r\n\r\n                errorCallback(new JitsiTrackError(JitsiTrackErrors.SCREENSHARING_USER_CANCELED));\r\n            });\r\n    },\r\n\r\n    /**\r\n     * Obtains a screen capture stream using getDisplayMedia.\r\n     *\r\n     * @param callback - The success callback.\r\n     * @param errorCallback - The error callback.\r\n     */\r\n    obtainScreenFromGetDisplayMediaRN(callback, errorCallback) {\r\n        logger.info('Using getDisplayMedia for screen sharing');\r\n\r\n        navigator.mediaDevices.getDisplayMedia({ video: true })\r\n            .then(stream => {\r\n                callback({\r\n                    stream,\r\n                    sourceId: stream.id });\r\n            })\r\n            .catch(() => {\r\n                errorCallback(new JitsiTrackError(JitsiTrackErrors\r\n                    .SCREENSHARING_USER_CANCELED));\r\n            });\r\n    }\r\n};\r\n\r\nexport default ScreenObtainer;\r\n","/**\r\n * The possible camera facing modes. For now support only 'user' and\r\n * 'environment' because 'left' and 'right' are not used anywhere in our\r\n * projects at the time of this writing. For more information please refer to\r\n * https://w3c.github.io/mediacapture-main/getusermedia.html\r\n * #def-constraint-facingMode.\r\n *\r\n * @enum {string}\r\n */\r\nconst CameraFacingMode = {\r\n    /**\r\n     * The mode which specifies the environment-facing camera.\r\n     */\r\n    ENVIRONMENT: 'environment',\r\n\r\n    /**\r\n     * The mode which specifies the user-facing camera.\r\n     */\r\n    USER: 'user'\r\n};\r\n\r\nmodule.exports = CameraFacingMode;\r\n","/**\r\n * The events for the media devices.\r\n */\r\n\r\n/**\r\n * Indicates that the list of available media devices has been changed. The\r\n * event provides the following parameters to its listeners:\r\n *\r\n * @param {MediaDeviceInfo[]} devices - array of MediaDeviceInfo or\r\n *  MediaDeviceInfo-like objects that are currently connected.\r\n *  @see https://developer.mozilla.org/en-US/docs/Web/API/MediaDeviceInfo\r\n */\r\nexport const DEVICE_LIST_CHANGED = 'mediaDevices.devicechange';\r\n\r\n/**\r\n * Event emitted when the user granted/blocked a permission for the camera / mic.\r\n * Used to keep track of the granted permissions on browsers which don't\r\n * support the Permissions API.\r\n */\r\nexport const PERMISSIONS_CHANGED = 'rtc.permissions_changed';\r\n\r\n/**\r\n * Indicates that the environment is currently showing permission prompt to\r\n * access camera and/or microphone. The event provides the following\r\n * parameters to its listeners:\r\n *\r\n * @param {'chrome'|'opera'|'firefox'|'safari'|'nwjs'\r\n *  |'react-native'|'android'} environmentType - type of browser or\r\n *  other execution environment.\r\n */\r\nexport const PERMISSION_PROMPT_IS_SHOWN\r\n    = 'mediaDevices.permissionPromptIsShown';\r\n\r\nexport const SLOW_GET_USER_MEDIA = 'mediaDevices.slowGetUserMedia';\r\n","import {priorityCalculator} from '@models/middleware/trafficControl'\r\nimport { urlParameters } from '@models/url'\r\nimport {ConnectionInfo} from '@stores/ConnectionInfo'\r\nimport errorInfo from '@stores/ErrorInfo'\r\nimport participants from '@stores/participants/Participants'\r\nimport contents from '@stores/sharedContents/SharedContents'\r\nimport {EventEmitter} from 'events'\r\n//import {stringify} from 'flatted'\r\nimport jquery from 'jquery'\r\nimport JitsiMeetJS from 'lib-jitsi-meet'\r\nimport {Store} from '../../stores/utils'\r\nimport {Conference} from './Conference'\r\nimport {ConnectionStates, ConnectionStatesType} from './Constants'\r\n\r\n//  import * as TPC from 'lib-jitsi-meet/modules/RTC/TPCUtils'\r\n// import a global variant $ for lib-jitsi-meet\r\n\r\n\r\n// config.js\r\ndeclare const config:any                  //  from ../../config.js included from index.html\r\n\r\n//  Log level and module log options\r\nexport const JITSILOGLEVEL = 'warn'  // log level for lib-jitsi-meet {debug|log|warn|error}\r\nexport const TRACKLOG = false        // show add, remove... of tracks\r\nexport const CONNECTIONLOG = false\r\n//  if (TPC.setTPCLogger !== undefined) {\r\n  //  TPC.setTPCLogger(TRACKLOG ? console.log : (a:any) => {})\r\n//  }\r\nexport const trackLog = TRACKLOG ? console.log : (a:any) => {}\r\nexport const connLog = CONNECTIONLOG ? console.log : (a:any) => {}\r\nexport const connDebug = CONNECTIONLOG ? console.debug : (a:any) => {}\r\n\r\ndeclare const global: any\r\nglobal.$ = jquery\r\nglobal.jQuery = jquery\r\n\r\nexport const initOptions: JitsiMeetJS.IJitsiMeetJSOptions = {\r\n  useIPv6: false,\r\n  disableSimulcast: true,\r\n  enableWindowOnErrorHandler: true,\r\n  enableAnalyticsLogging: false,\r\n  disableThiredPartyRequests: false,\r\n  disableAudioLevels: false,\r\n\r\n  // The ID of the jidesha extension for Chrome.\r\n  desktopSharingChromeExtId: 'mbocklcggfhnbahlnepmldehdhpjfcjp',\r\n\r\n  // Whether desktop sharing should be disabled on Chrome.\r\n  desktopSharingChromeDisabled: false,\r\n\r\n  // The media sources to use when using screen sharing with the Chrome\r\n  // extension.\r\n  desktopSharingChromeSources: ['screen', 'window'],\r\n\r\n  // Required version of Chrome extension\r\n  desktopSharingChromeMinExtVersion: '0.1',\r\n\r\n  // Whether desktop sharing should be disabled on Firefox.\r\n  desktopSharingFirefoxDisabled: false,\r\n\r\n  desktopSharingFrameRate: {min: 0.3, max: 30}  //  override by config.js\r\n}\r\n\r\n\r\n export class Connection extends EventEmitter {\r\n  private _jitsiConnection?: JitsiMeetJS.JitsiConnection\r\n  private _store: Store<ConnectionInfo> | undefined\r\n  public conference = new Conference()\r\n  public version = '0.0.1'\r\n  public state = ConnectionStates.DISCONNECTED\r\n\r\n  public set Store(store: Store<ConnectionInfo>) {\r\n    this._store = store\r\n  }\r\n\r\n  public init(): Promise<string> {\r\n    Object.assign(initOptions, config.rtc.screenOptions)\r\n\r\n    return new Promise<string>((resolve, reject) => {\r\n      JitsiMeetJS.init(initOptions)\r\n      JitsiMeetJS.setLogLevel(JITSILOGLEVEL)\r\n\r\n      this._jitsiConnection = new JitsiMeetJS.JitsiConnection(null, undefined, config)\r\n      this._jitsiConnection.addEventListener(JitsiMeetJS.events.connection.CONNECTION_ESTABLISHED, () => {\r\n        this.onStateChanged(ConnectionStates.CONNECTED)\r\n        resolve(JitsiMeetJS.events.connection.CONNECTION_ESTABLISHED)\r\n      })\r\n      this._jitsiConnection.addEventListener(JitsiMeetJS.events.connection.CONNECTION_FAILED, () => {\r\n        this.onStateChanged(ConnectionStates.DISCONNECTED)\r\n        reject(JitsiMeetJS.events.connection.CONNECTION_FAILED)\r\n      })\r\n      this._jitsiConnection.addEventListener(JitsiMeetJS.events.connection.CONNECTION_DISCONNECTED, () => {\r\n        this.onStateChanged(ConnectionStates.DISCONNECTED)\r\n      })\r\n      this._jitsiConnection.connect()\r\n      this.onStateChanged(ConnectionStates.CONNECTING)\r\n    })\r\n  }\r\n\r\n  public joinConference(conferenceName: string) {\r\n    if (this._jitsiConnection) {\r\n      this.conference.init(conferenceName, () => {\r\n        return this._jitsiConnection?.initJitsiConference(conferenceName.toLowerCase(), config)\r\n      })\r\n\r\n      return\r\n    }\r\n    throw new Error('No connection has been established.')\r\n  }\r\n  public leaveConference(){\r\n    return this.conference.uninit()\r\n  }\r\n\r\n  public disconnect(): Promise < any > {\r\n    if (this._jitsiConnection) {\r\n      connLog('Disconnection order has been sent.')\r\n\r\n      return this._jitsiConnection?.disconnect()\r\n    }\r\n\r\n    return Promise.reject('No connection has been established.')\r\n  }\r\n  reconnect(){\r\n    errorInfo.setType('retry')\r\n\r\n    /*  // if not reload, this block is needed\r\n    const localCamera = this.conference.getLocalCameraTrack()\r\n    const micMute = participants.local.muteAudio\r\n    const cameraMute = participants.local.muteVideo\r\n    //  */\r\n\r\n    participants.leaveAll()\r\n    contents.clearAllRemotes()\r\n    priorityCalculator.clear()\r\n\r\n    //  Try to connect again.\r\n    this.leaveConference().then(()=>{\r\n      console.log('Disconnected but succeed in leaving... strange ... try to join again.')\r\n    }).catch(()=>{\r\n      console.log('Disconnected and failed to leave... try to join again')\r\n      this.conference.bmRelaySocket?.close()\r\n    }).finally(()=>{\r\n      if (urlParameters.testBot !== null){\r\n        window.location.reload()\r\n      }\r\n      ///*  // reload or\r\n\r\n      //  Ask reload to user or auto reload ?\r\n      //  window.location.reload()\r\n\r\n      /*/ // init again\r\n      this.init().then(()=>{\r\n        this.joinConference(this.conference.name)\r\n        function restoreLocalTracks(){\r\n          if (!localCamera || localCamera.disposed){\r\n            participants.local.muteAudio = micMute\r\n            participants.local.muteVideo = cameraMute\r\n          }else{\r\n            setTimeout(restoreLocalTracks, 100)\r\n          }\r\n        }\r\n        restoreLocalTracks()\r\n        function restoreContentTracks(){\r\n          if (participants.localId){\r\n            contents.tracks.restoreLocalCarriers()\r\n          }else{\r\n            setTimeout(restoreContentTracks, 100)\r\n          }\r\n        }\r\n        restoreContentTracks()\r\n\r\n        errorInfo.clear()\r\n      })\r\n    //  */\r\n    })\r\n  }\r\n\r\n  private onStateChanged(state: ConnectionStatesType) {\r\n    //  console.log(`ConnctionStateChanged: ${this.state} => ${state}`)\r\n    if (this.state !== state && state === ConnectionStates.DISCONNECTED){\r\n      setTimeout(()=>{\r\n        this._jitsiConnection!.disconnect().finally(()=>{\r\n          setTimeout(this.reconnect.bind(this), 1000)\r\n        })\r\n      }, 1000)\r\n    }\r\n    this.state = state\r\n    if (this._store) {\r\n      this._store.changeState(this.state)\r\n    }\r\n  }\r\n}\r\n","// import a global variant $ for lib-jitsi-meet\r\nimport {default as ConnectionInfoStore} from '@stores/ConnectionInfo'\r\nimport {Connection} from './Connection'\r\nexport const connection = new Connection()\r\nconnection.Store = ConnectionInfoStore\r\n\r\ndeclare const d:any                  //  from index.html\r\nd.connection = connection\r\n","const currentExecutingScript = require('current-executing-script');\r\n\r\n/* eslint-disable max-params */\r\n\r\n/**\r\n * Implements utility functions which facilitate the dealing with scripts such\r\n * as the download and execution of a JavaScript file.\r\n */\r\nconst ScriptUtil = {\r\n    /**\r\n     * Loads a script from a specific source.\r\n     *\r\n     * @param src the source from the which the script is to be (down)loaded\r\n     * @param async true to asynchronously load the script or false to\r\n     * synchronously load the script\r\n     * @param prepend true to schedule the loading of the script as soon as\r\n     * possible or false to schedule the loading of the script at the end of the\r\n     * scripts known at the time\r\n     * @param relativeURL whether we need load the library from url relative\r\n     * to the url that lib-jitsi-meet was loaded. Useful when sourcing the\r\n     * library from different location than the app that is using it\r\n     * @param loadCallback on load callback function\r\n     * @param errorCallback callback to be called on error loading the script\r\n     */\r\n    loadScript(\r\n            src,\r\n            async,\r\n            prepend,\r\n            relativeURL,\r\n            loadCallback,\r\n            errorCallback) {\r\n        const d = document;\r\n        const tagName = 'script';\r\n        const script = d.createElement(tagName);\r\n        const referenceNode = d.getElementsByTagName(tagName)[0];\r\n\r\n        script.async = async;\r\n\r\n        if (relativeURL) {\r\n            // finds the src url of the current loaded script\r\n            // and use it as base of the src supplied argument\r\n            const scriptEl = currentExecutingScript();\r\n\r\n            if (scriptEl) {\r\n                const scriptSrc = scriptEl.src;\r\n                const baseScriptSrc\r\n                    = scriptSrc.substring(0, scriptSrc.lastIndexOf('/') + 1);\r\n\r\n                if (scriptSrc && baseScriptSrc) {\r\n                    // eslint-disable-next-line no-param-reassign\r\n                    src = baseScriptSrc + src;\r\n                }\r\n            }\r\n        }\r\n\r\n        if (loadCallback) {\r\n            script.onload = loadCallback;\r\n        }\r\n        if (errorCallback) {\r\n            script.onerror = errorCallback;\r\n        }\r\n\r\n        script.src = src;\r\n        if (prepend) {\r\n            referenceNode.parentNode.insertBefore(script, referenceNode);\r\n        } else {\r\n            referenceNode.parentNode.appendChild(script);\r\n        }\r\n    }\r\n};\r\n\r\n/* eslint-enable max-params */\r\n\r\nmodule.exports = ScriptUtil;\r\n","/* global __filename */\r\nimport { getLogger } from 'jitsi-meet-logger';\r\n\r\nimport * as JitsiConferenceEvents from '../../JitsiConferenceEvents';\r\nimport * as JitsiTrackEvents from '../../JitsiTrackEvents';\r\nimport * as MediaType from '../../service/RTC/MediaType';\r\nimport RTCEvents from '../../service/RTC/RTCEvents';\r\nimport { createParticipantConnectionStatusEvent } from '../../service/statistics/AnalyticsEvents';\r\nimport browser from '../browser';\r\nimport Statistics from '../statistics/statistics';\r\n\r\nconst logger = getLogger(__filename);\r\n\r\n/**\r\n * Default value of 500 milliseconds for\r\n * {@link ParticipantConnectionStatus.outOfLastNTimeout}.\r\n *\r\n * @type {number}\r\n */\r\nconst DEFAULT_NOT_IN_LAST_N_TIMEOUT = 500;\r\n\r\n/**\r\n * Default value of 2000 milliseconds for\r\n * {@link ParticipantConnectionStatus.rtcMuteTimeout}.\r\n *\r\n * @type {number}\r\n */\r\nconst DEFAULT_RTC_MUTE_TIMEOUT = 10000;\r\n\r\n/**\r\n * The time to wait a track to be restored. Track which was out of lastN\r\n * should be inactive and when entering lastN it becomes restoring and when\r\n * data is received from bridge it will become active, but if no data is\r\n * received for some time we set status of that participant connection to\r\n * interrupted.\r\n * @type {number}\r\n */\r\nconst DEFAULT_RESTORING_TIMEOUT = 10000;\r\n\r\n/**\r\n * Participant connection statuses.\r\n *\r\n * @type {{\r\n *      ACTIVE: string,\r\n *      INACTIVE: string,\r\n *      INTERRUPTED: string,\r\n *      RESTORING: string\r\n * }}\r\n */\r\nexport const ParticipantConnectionStatus = {\r\n    /**\r\n     * Status indicating that connection is currently active.\r\n     */\r\n    ACTIVE: 'active',\r\n\r\n    /**\r\n     * Status indicating that connection is currently inactive.\r\n     * Inactive means the connection was stopped on purpose from the bridge,\r\n     * like exiting lastN or adaptivity decided to drop video because of not\r\n     * enough bandwidth.\r\n     */\r\n    INACTIVE: 'inactive',\r\n\r\n    /**\r\n     * Status indicating that connection is currently interrupted.\r\n     */\r\n    INTERRUPTED: 'interrupted',\r\n\r\n    /**\r\n     * Status indicating that connection is currently restoring.\r\n     */\r\n    RESTORING: 'restoring'\r\n};\r\n\r\n/**\r\n * Class is responsible for emitting\r\n * JitsiConferenceEvents.PARTICIPANT_CONN_STATUS_CHANGED events.\r\n */\r\nexport default class ParticipantConnectionStatusHandler {\r\n    /* eslint-disable max-params*/\r\n    /**\r\n     * Calculates the new {@link ParticipantConnectionStatus} based on\r\n     * the values given for some specific remote user. It is assumed that\r\n     * the conference is currently in the JVB mode (in contrary to the P2P mode)\r\n     * @param {boolean} isConnectionActiveByJvb true if the JVB did not get any\r\n     * data from the user for the last 15 seconds.\r\n     * @param {boolean} isInLastN indicates whether the user is in the last N\r\n     * set. When set to false it means that JVB is not sending any video for\r\n     * the user.\r\n     * @param {boolean} isRestoringTimedout if true it means that the user has\r\n     * been outside of last N too long to be considered\r\n     * {@link ParticipantConnectionStatus.RESTORING}.\r\n     * @param {boolean} isVideoMuted true if the user is video muted and we\r\n     * should not expect to receive any video.\r\n     * @param {boolean} isVideoTrackFrozen if the current browser support video\r\n     * frozen detection then it will be set to true when the video track is\r\n     * frozen. If the current browser does not support frozen detection the it's\r\n     * always false.\r\n     * @return {ParticipantConnectionStatus} the new connection status for\r\n     * the user for whom the values above were provided.\r\n     * @private\r\n     */\r\n    static _getNewStateForJvbMode(\r\n            isConnectionActiveByJvb,\r\n            isInLastN,\r\n            isRestoringTimedout,\r\n            isVideoMuted,\r\n            isVideoTrackFrozen) {\r\n        if (!isConnectionActiveByJvb) {\r\n            // when there is a connection problem signaled from jvb\r\n            // it means no media was flowing for at least 15secs, so both audio\r\n            // and video are most likely interrupted\r\n            return ParticipantConnectionStatus.INTERRUPTED;\r\n        } else if (isVideoMuted) {\r\n            // If the connection is active according to JVB and the user is\r\n            // video muted there is no way for the connection to be inactive,\r\n            // because the detection logic below only makes sense for video.\r\n            return ParticipantConnectionStatus.ACTIVE;\r\n        }\r\n\r\n        // Logic when isVideoTrackFrozen is supported\r\n        if (browser.supportsVideoMuteOnConnInterrupted()) {\r\n            if (!isVideoTrackFrozen) {\r\n                // If the video is playing we're good\r\n                return ParticipantConnectionStatus.ACTIVE;\r\n            } else if (isInLastN) {\r\n                return isRestoringTimedout\r\n                    ? ParticipantConnectionStatus.INTERRUPTED\r\n                    : ParticipantConnectionStatus.RESTORING;\r\n            }\r\n\r\n            return ParticipantConnectionStatus.INACTIVE;\r\n        }\r\n\r\n        // Because this browser is incapable of detecting frozen video we must\r\n        // rely on the lastN value\r\n        return isInLastN\r\n            ? ParticipantConnectionStatus.ACTIVE\r\n            : ParticipantConnectionStatus.INACTIVE;\r\n    }\r\n\r\n    /* eslint-enable max-params*/\r\n\r\n    /**\r\n     * In P2P mode we don't care about any values coming from the JVB and\r\n     * the connection status can be only active or interrupted.\r\n     * @param {boolean} isVideoMuted the user if video muted\r\n     * @param {boolean} isVideoTrackFrozen true if the video track for\r\n     * the remote user is currently frozen. If the current browser does not\r\n     * support video frozen detection then it's always false.\r\n     * @return {ParticipantConnectionStatus}\r\n     * @private\r\n     */\r\n    static _getNewStateForP2PMode(isVideoMuted, isVideoTrackFrozen) {\r\n        if (!browser.supportsVideoMuteOnConnInterrupted()) {\r\n            // There's no way to detect problems in P2P when there's no video\r\n            // track frozen detection...\r\n            return ParticipantConnectionStatus.ACTIVE;\r\n        }\r\n\r\n        return isVideoMuted || !isVideoTrackFrozen\r\n            ? ParticipantConnectionStatus.ACTIVE\r\n            : ParticipantConnectionStatus.INTERRUPTED;\r\n    }\r\n\r\n    /**\r\n     * Creates new instance of <tt>ParticipantConnectionStatus</tt>.\r\n     *\r\n     * @constructor\r\n     * @param {RTC} rtc the RTC service instance\r\n     * @param {JitsiConference} conference parent conference instance\r\n     * @param {Object} options\r\n     * @param {number} [options.rtcMuteTimeout=2000] custom value for\r\n     * {@link ParticipantConnectionStatus.rtcMuteTimeout}.\r\n     * @param {number} [options.outOfLastNTimeout=500] custom value for\r\n     * {@link ParticipantConnectionStatus.outOfLastNTimeout}.\r\n     */\r\n    constructor(rtc, conference, options) {\r\n        this.rtc = rtc;\r\n        this.conference = conference;\r\n\r\n        /**\r\n         * A map of the \"endpoint ID\"(which corresponds to the resource part\r\n         * of MUC JID(nickname)) to the timeout callback IDs scheduled using\r\n         * window.setTimeout.\r\n         * @type {Object.<string, number>}\r\n         */\r\n        this.trackTimers = {};\r\n\r\n        /**\r\n         * This map holds the endpoint connection status received from the JVB\r\n         * (as it might be different than the one stored in JitsiParticipant).\r\n         * Required for getting back in sync when remote video track is removed.\r\n         * @type {Object.<string, boolean>}\r\n         */\r\n        this.connStatusFromJvb = { };\r\n\r\n        /**\r\n         * If video track frozen detection through RTC mute event is supported,\r\n         * we wait some time until video track is considered frozen. But because\r\n         * when the user falls out of last N it is expected for the video to\r\n         * freeze this timeout must be significantly reduced in \"out of last N\"\r\n         * case.\r\n         *\r\n         * Basically this value is used instead of {@link rtcMuteTimeout} when\r\n         * user is not in last N.\r\n         * @type {number}\r\n         */\r\n        this.outOfLastNTimeout\r\n            = typeof options.outOfLastNTimeout === 'number'\r\n                ? options.outOfLastNTimeout : DEFAULT_NOT_IN_LAST_N_TIMEOUT;\r\n\r\n        /**\r\n         * How long we're going to wait after the RTC video track muted event\r\n         * for the corresponding signalling mute event, before the connection\r\n         * interrupted is fired. The default value is\r\n         * {@link DEFAULT_RTC_MUTE_TIMEOUT}.\r\n         *\r\n         * @type {number} amount of time in milliseconds\r\n         */\r\n        this.rtcMuteTimeout\r\n            = typeof options.rtcMuteTimeout === 'number'\r\n                ? options.rtcMuteTimeout : DEFAULT_RTC_MUTE_TIMEOUT;\r\n\r\n        /**\r\n         * This map holds a timestamp indicating  when participant's video track\r\n         * was RTC muted (it is assumed that each participant can have only 1\r\n         * video track at a time). The purpose of storing the timestamp is to\r\n         * avoid the transition to disconnected status in case of legitimate\r\n         * video mute operation where the signalling video muted event can\r\n         * arrive shortly after RTC muted event.\r\n         *\r\n         * The key is participant's ID which is the same as endpoint id in\r\n         * the Colibri conference allocated on the JVB.\r\n         *\r\n         * The value is a timestamp measured in milliseconds obtained with\r\n         * <tt>Date.now()</tt>.\r\n         *\r\n         * FIXME merge this logic with NO_DATA_FROM_SOURCE event\r\n         *       implemented in JitsiLocalTrack by extending the event to\r\n         *       the remote track and allowing to set different timeout for\r\n         *       local and remote tracks.\r\n         *\r\n         * @type {Object.<string, number>}\r\n         */\r\n        this.rtcMutedTimestamp = { };\r\n        logger.info(`RtcMuteTimeout set to: ${this.rtcMuteTimeout}`);\r\n\r\n        /**\r\n         * This map holds the timestamps indicating when participant's video\r\n         * entered lastN set. Participants entering lastN will have connection\r\n         * status restoring and when we start receiving video will become\r\n         * active, but if video is not received for certain time\r\n         * {@link DEFAULT_RESTORING_TIMEOUT} that participant connection status\r\n         * will become interrupted.\r\n         *\r\n         * @type {Map<string, number>}\r\n         */\r\n        this.enteredLastNTimestamp = new Map();\r\n\r\n        /**\r\n         * A map of the \"endpoint ID\"(which corresponds to the resource part\r\n         * of MUC JID(nickname)) to the restoring timeout callback IDs\r\n         * scheduled using window.setTimeout.\r\n         *\r\n         * @type {Map<string, number>}\r\n         */\r\n        this.restoringTimers = new Map();\r\n\r\n        /**\r\n         * A map that holds the current connection status (along with all the internal events that happen\r\n         * while in that state).\r\n         *\r\n         * The goal is to send this information to the analytics backend for post-mortem analysis.\r\n         */\r\n        this.connectionStatusMap = new Map();\r\n    }\r\n\r\n    /**\r\n     * Gets the video frozen timeout for given user.\r\n     * @param {string} id endpoint/participant ID\r\n     * @return {number} how long are we going to wait since RTC video muted\r\n     * even, before a video track is considered frozen.\r\n     * @private\r\n     */\r\n    _getVideoFrozenTimeout(id) {\r\n        return this.rtc.isInLastN(id)\r\n            ? this.rtcMuteTimeout : this.outOfLastNTimeout;\r\n    }\r\n\r\n    /**\r\n     * Initializes <tt>ParticipantConnectionStatus</tt> and bind required event\r\n     * listeners.\r\n     */\r\n    init() {\r\n\r\n        this._onEndpointConnStatusChanged\r\n            = this.onEndpointConnStatusChanged.bind(this);\r\n\r\n        this.rtc.addListener(\r\n            RTCEvents.ENDPOINT_CONN_STATUS_CHANGED,\r\n            this._onEndpointConnStatusChanged);\r\n\r\n        // Handles P2P status changes\r\n        this._onP2PStatus = this.refreshConnectionStatusForAll.bind(this);\r\n        this.conference.on(JitsiConferenceEvents.P2P_STATUS, this._onP2PStatus);\r\n\r\n        // Used to send analytics events for the participant that left the call.\r\n        this._onUserLeft = this.onUserLeft.bind(this);\r\n        this.conference.on(JitsiConferenceEvents.USER_LEFT, this._onUserLeft);\r\n\r\n        // On some browsers MediaStreamTrack trigger \"onmute\"/\"onunmute\"\r\n        // events for video type tracks when they stop receiving data which is\r\n        // often a sign that remote user is having connectivity issues\r\n        if (browser.supportsVideoMuteOnConnInterrupted()) {\r\n\r\n            this._onTrackRtcMuted = this.onTrackRtcMuted.bind(this);\r\n            this.rtc.addListener(\r\n                RTCEvents.REMOTE_TRACK_MUTE, this._onTrackRtcMuted);\r\n\r\n            this._onTrackRtcUnmuted = this.onTrackRtcUnmuted.bind(this);\r\n            this.rtc.addListener(\r\n                RTCEvents.REMOTE_TRACK_UNMUTE, this._onTrackRtcUnmuted);\r\n\r\n            // Track added/removed listeners are used to bind \"mute\"/\"unmute\"\r\n            // event handlers\r\n            this._onRemoteTrackAdded = this.onRemoteTrackAdded.bind(this);\r\n            this.conference.on(\r\n                JitsiConferenceEvents.TRACK_ADDED,\r\n                this._onRemoteTrackAdded);\r\n\r\n            this._onRemoteTrackRemoved = this.onRemoteTrackRemoved.bind(this);\r\n            this.conference.on(\r\n                JitsiConferenceEvents.TRACK_REMOVED,\r\n                this._onRemoteTrackRemoved);\r\n\r\n            // Listened which will be bound to JitsiRemoteTrack to listen for\r\n            // signalling mute/unmute events.\r\n            this._onSignallingMuteChanged\r\n                = this.onSignallingMuteChanged.bind(this);\r\n\r\n            // Used to send an analytics event when the video type changes.\r\n            this._onTrackVideoTypeChanged\r\n                = this.onTrackVideoTypeChanged.bind(this);\r\n        }\r\n\r\n        this._onLastNChanged = this._onLastNChanged.bind(this);\r\n        this.conference.on(\r\n            JitsiConferenceEvents.LAST_N_ENDPOINTS_CHANGED,\r\n            this._onLastNChanged);\r\n\r\n        this._onLastNValueChanged\r\n            = this.refreshConnectionStatusForAll.bind(this);\r\n        this.rtc.on(\r\n            RTCEvents.LASTN_VALUE_CHANGED, this._onLastNValueChanged);\r\n    }\r\n\r\n    /**\r\n     * Removes all event listeners and disposes of all resources held by this\r\n     * instance.\r\n     */\r\n    dispose() {\r\n\r\n        this.rtc.removeListener(\r\n            RTCEvents.ENDPOINT_CONN_STATUS_CHANGED,\r\n            this._onEndpointConnStatusChanged);\r\n\r\n        if (browser.supportsVideoMuteOnConnInterrupted()) {\r\n            this.rtc.removeListener(\r\n                RTCEvents.REMOTE_TRACK_MUTE,\r\n                this._onTrackRtcMuted);\r\n            this.rtc.removeListener(\r\n                RTCEvents.REMOTE_TRACK_UNMUTE,\r\n                this._onTrackRtcUnmuted);\r\n\r\n            this.conference.off(\r\n                JitsiConferenceEvents.TRACK_ADDED,\r\n                this._onRemoteTrackAdded);\r\n            this.conference.off(\r\n                JitsiConferenceEvents.TRACK_REMOVED,\r\n                this._onRemoteTrackRemoved);\r\n        }\r\n\r\n        this.conference.off(\r\n            JitsiConferenceEvents.LAST_N_ENDPOINTS_CHANGED,\r\n            this._onLastNChanged);\r\n\r\n        this.rtc.removeListener(\r\n            RTCEvents.LASTN_VALUE_CHANGED, this._onLastNValueChanged);\r\n\r\n        this.conference.off(\r\n            JitsiConferenceEvents.P2P_STATUS, this._onP2PStatus);\r\n\r\n        this.conference.off(\r\n            JitsiConferenceEvents.USER_LEFT, this._onUserLeft);\r\n\r\n        const participantIds = Object.keys(this.trackTimers);\r\n\r\n        for (const participantId of participantIds) {\r\n            this.clearTimeout(participantId);\r\n            this.clearRtcMutedTimestamp(participantId);\r\n        }\r\n\r\n        for (const id in this.connectionStatusMap) {\r\n            if (this.connectionStatusMap.hasOwnProperty(id)) {\r\n                this.onUserLeft(id);\r\n            }\r\n        }\r\n\r\n        // Clear RTC connection status cache\r\n        this.connStatusFromJvb = {};\r\n    }\r\n\r\n    /**\r\n     * Handles RTCEvents.ENDPOINT_CONN_STATUS_CHANGED triggered when we receive\r\n     * notification over the data channel from the bridge about endpoint's\r\n     * connection status update.\r\n     * @param {string} endpointId - The endpoint ID(MUC nickname/resource JID).\r\n     * @param {boolean} isActive - true if the connection is OK or false otherwise.\r\n     */\r\n    onEndpointConnStatusChanged(endpointId, isActive) {\r\n\r\n        logger.debug(\r\n            `Detector RTCEvents.ENDPOINT_CONN_STATUS_CHANGED(${Date.now()}): ${\r\n                endpointId}: ${isActive}`);\r\n\r\n        // Filter out events for the local JID for now\r\n        if (endpointId !== this.conference.myUserId()) {\r\n            // Store the status received over the data channels\r\n            this.connStatusFromJvb[endpointId] = isActive;\r\n            this.figureOutConnectionStatus(endpointId);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Changes connection status.\r\n     * @param {JitsiParticipant} participant\r\n     * @param newStatus\r\n     */\r\n    _changeConnectionStatus(participant, newStatus) {\r\n        if (participant.getConnectionStatus() !== newStatus) {\r\n\r\n            const endpointId = participant.getId();\r\n\r\n            participant._setConnectionStatus(newStatus);\r\n\r\n            logger.debug(\r\n                `Emit endpoint conn status(${Date.now()}) ${endpointId}: ${\r\n                    newStatus}`);\r\n\r\n            // Log the event on CallStats\r\n            Statistics.sendLog(\r\n                JSON.stringify({\r\n                    id: 'peer.conn.status',\r\n                    participant: endpointId,\r\n                    status: newStatus\r\n                }));\r\n\r\n\r\n            this.conference.eventEmitter.emit(\r\n                JitsiConferenceEvents.PARTICIPANT_CONN_STATUS_CHANGED,\r\n                endpointId, newStatus);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Reset the postponed \"connection interrupted\" event which was previously\r\n     * scheduled as a timeout on RTC 'onmute' event.\r\n     *\r\n     * @param {string} participantId - The participant for which the \"connection\r\n     * interrupted\" timeout was scheduled.\r\n     */\r\n    clearTimeout(participantId) {\r\n        if (this.trackTimers[participantId]) {\r\n            window.clearTimeout(this.trackTimers[participantId]);\r\n            this.trackTimers[participantId] = null;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Clears the timestamp of the RTC muted event for participant's video track\r\n     * @param {string} participantId the id of the conference participant which\r\n     * is the same as the Colibri endpoint ID of the video channel allocated for\r\n     * the user on the videobridge.\r\n     */\r\n    clearRtcMutedTimestamp(participantId) {\r\n        this.rtcMutedTimestamp[participantId] = null;\r\n    }\r\n\r\n    /**\r\n     * Bind signalling mute event listeners for video {JitsiRemoteTrack} when\r\n     * a new one is added to the conference.\r\n     *\r\n     * @param {JitsiTrack} remoteTrack - The {JitsiTrack} which is being added to\r\n     * the conference.\r\n     */\r\n    onRemoteTrackAdded(remoteTrack) {\r\n        if (!remoteTrack.isLocal()\r\n                && remoteTrack.getType() === MediaType.VIDEO) {\r\n\r\n            logger.debug(\r\n                `Detector on remote track added for: ${\r\n                    remoteTrack.getParticipantId()}`);\r\n\r\n            remoteTrack.on(\r\n                JitsiTrackEvents.TRACK_MUTE_CHANGED,\r\n                this._onSignallingMuteChanged);\r\n            remoteTrack.on(\r\n                JitsiTrackEvents.TRACK_VIDEOTYPE_CHANGED,\r\n                videoType => this._onTrackVideoTypeChanged(remoteTrack, videoType));\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Removes all event listeners bound to the remote video track and clears\r\n     * any related timeouts.\r\n     *\r\n     * @param {JitsiRemoteTrack} remoteTrack - The remote track which is being\r\n     * removed from the conference.\r\n     */\r\n    onRemoteTrackRemoved(remoteTrack) {\r\n        if (!remoteTrack.isLocal()\r\n                && remoteTrack.getType() === MediaType.VIDEO) {\r\n\r\n            const endpointId = remoteTrack.getParticipantId();\r\n\r\n            logger.debug(`Detector on remote track removed: ${endpointId}`);\r\n\r\n            remoteTrack.off(\r\n                JitsiTrackEvents.TRACK_MUTE_CHANGED,\r\n                this._onSignallingMuteChanged);\r\n\r\n            this.clearTimeout(endpointId);\r\n            this.clearRtcMutedTimestamp(endpointId);\r\n\r\n            this.figureOutConnectionStatus(endpointId);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Checks if given participant's video is considered frozen.\r\n     * @param {JitsiParticipant} participant - The participant.\r\n     * @return {boolean} <tt>true</tt> if the video has frozen for given\r\n     * participant or <tt>false</tt> when it's either not considered frozen\r\n     * (yet) or if freeze detection is not supported by the current browser.\r\n     *\r\n     * FIXME merge this logic with NO_DATA_FROM_SOURCE event\r\n     *       implemented in JitsiLocalTrack by extending the event to\r\n     *       the remote track and allowing to set different timeout for\r\n     *       local and remote tracks.\r\n     *\r\n     */\r\n    isVideoTrackFrozen(participant) {\r\n        if (!browser.supportsVideoMuteOnConnInterrupted()) {\r\n            return false;\r\n        }\r\n\r\n        const id = participant.getId();\r\n        const hasAnyVideoRTCMuted = participant.hasAnyVideoTrackWebRTCMuted();\r\n        const rtcMutedTimestamp = this.rtcMutedTimestamp[id];\r\n        const timeout = this._getVideoFrozenTimeout(id);\r\n\r\n        return hasAnyVideoRTCMuted\r\n            && typeof rtcMutedTimestamp === 'number'\r\n            && (Date.now() - rtcMutedTimestamp) >= timeout;\r\n    }\r\n\r\n    /**\r\n     * Goes over every participant and updates connectivity status.\r\n     * Should be called when a parameter which affects all of the participants\r\n     * is changed (P2P for example).\r\n     */\r\n    refreshConnectionStatusForAll() {\r\n        const participants = this.conference.getParticipants();\r\n\r\n        for (const participant of participants) {\r\n            this.figureOutConnectionStatus(participant.getId());\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Figures out (and updates) the current connectivity status for\r\n     * the participant identified by the given id.\r\n     *\r\n     * @param {string} id - The participant's id (MUC nickname or Colibri endpoint ID).\r\n     */\r\n    figureOutConnectionStatus(id) {\r\n        const participant = this.conference.getParticipantById(id);\r\n\r\n        if (!participant) {\r\n            // Probably the participant is no longer in the conference\r\n            // (at the time of writing this code, participant is\r\n            // detached from the conference and TRACK_REMOVED events are\r\n            // fired),\r\n            // so we don't care, but let's print a log message for debugging purposes.\r\n            logger.debug(`figure out conn status - no participant for: ${id}`);\r\n\r\n            return;\r\n        }\r\n\r\n        const inP2PMode = this.conference.isP2PActive();\r\n        const isRestoringTimedOut = this._isRestoringTimedout(id);\r\n        const audioOnlyMode = this.conference.getLastN() === 0;\r\n\r\n        // NOTE Overriding videoMuted to true for audioOnlyMode should disable\r\n        // any detection based on video playback or the last N.\r\n        const isVideoMuted = participant.isVideoMuted() || audioOnlyMode;\r\n        const isVideoTrackFrozen = this.isVideoTrackFrozen(participant);\r\n        const isInLastN = this.rtc.isInLastN(id);\r\n        let isConnActiveByJvb = this.connStatusFromJvb[id];\r\n\r\n        if (typeof isConnActiveByJvb !== 'boolean') {\r\n            // If no status was received from the JVB it means that it's active\r\n            // (the bridge does not send notification unless there is a problem)\r\n            isConnActiveByJvb = true;\r\n        }\r\n\r\n        const newState\r\n            = inP2PMode\r\n                ? ParticipantConnectionStatusHandler._getNewStateForP2PMode(\r\n                    isVideoMuted,\r\n                    isVideoTrackFrozen)\r\n                : ParticipantConnectionStatusHandler._getNewStateForJvbMode(\r\n                    isConnActiveByJvb,\r\n                    isInLastN,\r\n                    isRestoringTimedOut,\r\n                    isVideoMuted,\r\n                    isVideoTrackFrozen);\r\n\r\n        // if the new state is not restoring clear timers and timestamps\r\n        // that we use to track the restoring state\r\n        if (newState !== ParticipantConnectionStatus.RESTORING) {\r\n            this._clearRestoringTimer(id);\r\n        }\r\n\r\n        logger.debug(\r\n            `Figure out conn status for ${id}, is video muted: ${\r\n                isVideoMuted} is active(jvb): ${\r\n                isConnActiveByJvb} video track frozen: ${\r\n                isVideoTrackFrozen} p2p mode: ${\r\n                inP2PMode} is in last N: ${\r\n                isInLastN} currentStatus => newStatus: ${\r\n                participant.getConnectionStatus()} => ${newState}`);\r\n\r\n        const oldConnectionStatus = this.connectionStatusMap[id] || {};\r\n\r\n        // Send an analytics event (guard on either the p2p flag or the connection status has changed\r\n        // since the last time this code block run).\r\n        if (!('p2p' in oldConnectionStatus)\r\n            || !('connectionStatus' in oldConnectionStatus)\r\n            || oldConnectionStatus.p2p !== inP2PMode\r\n            || oldConnectionStatus.connectionStatus !== newState) {\r\n\r\n            const nowMs = Date.now();\r\n\r\n            this.maybeSendParticipantConnectionStatusEvent(id, nowMs);\r\n\r\n            this.connectionStatusMap[id] = {\r\n                ...oldConnectionStatus,\r\n                connectionStatus: newState,\r\n                p2p: inP2PMode,\r\n                startedMs: nowMs\r\n            };\r\n\r\n            // sometimes (always?) we're late to hook the TRACK_VIDEOTYPE_CHANGED event and the\r\n            // video type is not in oldConnectionStatus.\r\n            if (!('videoType' in this.connectionStatusMap[id])) {\r\n                const videoTracks = participant.getTracksByMediaType(MediaType.VIDEO);\r\n\r\n                if (Array.isArray(videoTracks) && videoTracks.length !== 0) {\r\n                    this.connectionStatusMap[id].videoType = videoTracks[0].videoType;\r\n                }\r\n            }\r\n        }\r\n        this._changeConnectionStatus(participant, newState);\r\n    }\r\n\r\n    /**\r\n     * Computes the duration of the current connection status for the participant with the specified id (i.e. 15 seconds\r\n     * in the INTERRUPTED state) and sends a participant connection status event.\r\n     * @param {string} id - The jid of the participant.\r\n     * @param {Number} nowMs - The current time (in millis).\r\n     * @returns {void}\r\n     */\r\n    maybeSendParticipantConnectionStatusEvent(id, nowMs) {\r\n        const participantConnectionStatus = this.connectionStatusMap[id];\r\n\r\n        if (participantConnectionStatus\r\n            && 'startedMs' in participantConnectionStatus\r\n            && 'videoType' in participantConnectionStatus\r\n            && 'connectionStatus' in participantConnectionStatus\r\n            && 'p2p' in participantConnectionStatus) {\r\n            participantConnectionStatus.value = nowMs - participantConnectionStatus.startedMs;\r\n            Statistics.sendAnalytics(\r\n                createParticipantConnectionStatusEvent(participantConnectionStatus));\r\n        }\r\n    }\r\n\r\n    /**\r\n     * On change in Last N set check all leaving and entering participants to\r\n     * change their corresponding statuses.\r\n     *\r\n     * @param {Array<string>} leavingLastN - The array of ids leaving lastN.\r\n     * @param {Array<string>} enteringLastN - The array of ids entering lastN.\r\n     * @private\r\n     */\r\n    _onLastNChanged(leavingLastN = [], enteringLastN = []) {\r\n        const now = Date.now();\r\n\r\n        logger.debug(\r\n            'leaving/entering lastN', leavingLastN, enteringLastN, now);\r\n\r\n        for (const id of leavingLastN) {\r\n            this.enteredLastNTimestamp.delete(id);\r\n            this._clearRestoringTimer(id);\r\n            this.figureOutConnectionStatus(id);\r\n        }\r\n        for (const id of enteringLastN) {\r\n            // store the timestamp this id is entering lastN\r\n            this.enteredLastNTimestamp.set(id, now);\r\n            this.figureOutConnectionStatus(id);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Clears the restoring timer for participant's video track and the\r\n     * timestamp for entering lastN.\r\n     *\r\n     * @param {string} participantId - The id of the conference participant which\r\n     * is the same as the Colibri endpoint ID of the video channel allocated for\r\n     * the user on the videobridge.\r\n     */\r\n    _clearRestoringTimer(participantId) {\r\n        const rTimer = this.restoringTimers.get(participantId);\r\n\r\n        if (rTimer) {\r\n            clearTimeout(rTimer);\r\n            this.restoringTimers.delete(participantId);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Checks whether a track had stayed enough in restoring state, compares\r\n     * current time and the time the track entered in lastN. If it hasn't\r\n     * timedout and there is no timer added, add new timer in order to give it\r\n     * more time to become active or mark it as interrupted on next check.\r\n     *\r\n     * @param {string} participantId - The id of the conference participant which\r\n     * is the same as the Colibri endpoint ID of the video channel allocated for\r\n     * the user on the videobridge.\r\n     * @returns {boolean} <tt>true</tt> if the track was in restoring state\r\n     * more than the timeout ({@link DEFAULT_RESTORING_TIMEOUT}.) in order to\r\n     * set its status to interrupted.\r\n     * @private\r\n     */\r\n    _isRestoringTimedout(participantId) {\r\n        const enteredLastNTimestamp\r\n            = this.enteredLastNTimestamp.get(participantId);\r\n\r\n        if (enteredLastNTimestamp\r\n            && (Date.now() - enteredLastNTimestamp)\r\n                >= DEFAULT_RESTORING_TIMEOUT) {\r\n            return true;\r\n        }\r\n\r\n        // still haven't reached timeout, if there is no timer scheduled,\r\n        // schedule one so we can track the restoring state and change it after\r\n        // reaching the timeout\r\n        const rTimer = this.restoringTimers.get(participantId);\r\n\r\n        if (!rTimer) {\r\n            this.restoringTimers.set(participantId, setTimeout(\r\n                () => this.figureOutConnectionStatus(participantId),\r\n                DEFAULT_RESTORING_TIMEOUT));\r\n        }\r\n\r\n        return false;\r\n    }\r\n\r\n    /**\r\n     * Sends a last/final participant connection status event for the participant that left the conference.\r\n     * @param {string} id - The id of the participant that left the conference.\r\n     * @returns {void}\r\n     */\r\n    onUserLeft(id) {\r\n        this.maybeSendParticipantConnectionStatusEvent(id, Date.now());\r\n        delete this.connectionStatusMap[id];\r\n    }\r\n\r\n    /**\r\n     * Handles RTC 'onmute' event for the video track.\r\n     *\r\n     * @param {JitsiRemoteTrack} track - The video track for which 'onmute' event\r\n     * will be processed.\r\n     */\r\n    onTrackRtcMuted(track) {\r\n        const participantId = track.getParticipantId();\r\n        const participant = this.conference.getParticipantById(participantId);\r\n\r\n        logger.debug(`Detector track RTC muted: ${participantId}`, Date.now());\r\n        if (!participant) {\r\n            logger.error(`No participant for id: ${participantId}`);\r\n\r\n            return;\r\n        }\r\n        this.rtcMutedTimestamp[participantId] = Date.now();\r\n        if (!participant.isVideoMuted()) {\r\n            // If the user is not muted according to the signalling we'll give\r\n            // it some time, before the connection interrupted event is\r\n            // triggered.\r\n            this.clearTimeout(participantId);\r\n\r\n            // The timeout is reduced when user is not in the last N\r\n            const timeout = this._getVideoFrozenTimeout(participantId);\r\n\r\n            this.trackTimers[participantId] = window.setTimeout(() => {\r\n                logger.debug(\r\n                    `Set RTC mute timeout for: ${participantId}\\\r\n                     of ${timeout} ms`);\r\n                this.clearTimeout(participantId);\r\n                this.figureOutConnectionStatus(participantId);\r\n            }, timeout);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Handles RTC 'onunmute' event for the video track.\r\n     *\r\n     * @param {JitsiRemoteTrack} track - The video track for which 'onunmute'\r\n     * event will be processed.\r\n     */\r\n    onTrackRtcUnmuted(track) {\r\n        const participantId = track.getParticipantId();\r\n\r\n        logger.debug(\r\n            `Detector track RTC unmuted: ${participantId}`, Date.now());\r\n\r\n        this.clearTimeout(participantId);\r\n        this.clearRtcMutedTimestamp(participantId);\r\n\r\n        this.figureOutConnectionStatus(participantId);\r\n    }\r\n\r\n    /**\r\n     * Here the signalling \"mute\"/\"unmute\" events are processed.\r\n     *\r\n     * @param {JitsiRemoteTrack} track - The remote video track for which\r\n     * the signalling mute/unmute event will be processed.\r\n     */\r\n    onSignallingMuteChanged(track) {\r\n        const participantId = track.getParticipantId();\r\n\r\n        logger.debug(\r\n            `Detector on track signalling mute changed: ${participantId}`,\r\n            track.isMuted());\r\n\r\n        this.figureOutConnectionStatus(participantId);\r\n    }\r\n\r\n    /**\r\n     * Sends a participant connection status event as a result of the video type\r\n     * changing.\r\n     * @param {JitsiRemoteTrack} track - The track.\r\n     * @param {VideoType} type - The video type.\r\n     * @returns {void}\r\n     */\r\n    onTrackVideoTypeChanged(track, type) {\r\n        const id = track.getParticipantId();\r\n        const nowMs = Date.now();\r\n\r\n        this.maybeSendParticipantConnectionStatusEvent(id, nowMs);\r\n\r\n        this.connectionStatusMap[id] = {\r\n            ...this.connectionStatusMap[id] || {},\r\n            videoType: type,\r\n            startedMs: nowMs\r\n        };\r\n    }\r\n}\r\n","import { getLogger } from 'jitsi-meet-logger';\r\n\r\nimport Listenable from '../util/Listenable';\r\n\r\nexport const NETWORK_INFO_EVENT = 'NETWORK_INFO_CHANGED';\r\n\r\nconst logger = getLogger(__filename);\r\n\r\n/**\r\n * Module provides information about the current status of the internet\r\n * connection. Lib-jitsi-meet doesn't have any logic for detecting internet\r\n * online/offline, but rather it relies on the information supplied by the app\r\n * that uses it. By default the online state is assumed and the lib acts as if\r\n * it was connected. See {@link JitsiMeetJS.setNetworkInfo}.\r\n */\r\nexport class NetworkInfo extends Listenable {\r\n    /**\r\n     * Creates new {@link NetworkInfo} instance.\r\n     */\r\n    constructor() {\r\n        super();\r\n        this._current = {\r\n            isOnline: true\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Updates the network info state.\r\n     * @param {boolean} isOnline - {@code true} if internet is online or {@code false} otherwise.\r\n     */\r\n    updateNetworkInfo({ isOnline }) {\r\n        logger.debug('updateNetworkInfo', { isOnline });\r\n        this._current = {\r\n            isOnline: isOnline === true\r\n        };\r\n        this.eventEmitter.emit(NETWORK_INFO_EVENT, this._current);\r\n    }\r\n\r\n    /**\r\n     * Returns the online/offline internet status. By default the value is {@code true} and changes only if\r\n     * the lib's user wires the state through {@link JitsiMeetJS.setNetworkInfo} like the jitsi-meet does. Because of\r\n     * that any logic should still assume that the internet may be offline and should handle the failure gracefully.\r\n     * It's only a good hint in the other way around: to pause internet operations until it comes back online.\r\n     * @returns {boolean}\r\n     */\r\n    isOnline() {\r\n        return this._current.isOnline === true;\r\n    }\r\n}\r\n\r\nconst networkInfo = new NetworkInfo();\r\n\r\nexport default networkInfo;\r\n","/* global __filename, Promise */\r\n\r\nimport { getLogger } from 'jitsi-meet-logger';\r\n\r\nimport JitsiTrackError from '../../JitsiTrackError';\r\nimport {\r\n    TRACK_IS_DISPOSED,\r\n    TRACK_NO_STREAM_FOUND\r\n} from '../../JitsiTrackErrors';\r\nimport {\r\n    LOCAL_TRACK_STOPPED,\r\n    NO_DATA_FROM_SOURCE,\r\n    TRACK_MUTE_CHANGED\r\n} from '../../JitsiTrackEvents';\r\nimport CameraFacingMode from '../../service/RTC/CameraFacingMode';\r\nimport * as MediaType from '../../service/RTC/MediaType';\r\nimport RTCEvents from '../../service/RTC/RTCEvents';\r\nimport VideoType from '../../service/RTC/VideoType';\r\nimport {\r\n    NO_BYTES_SENT,\r\n    TRACK_UNMUTED,\r\n    createNoDataFromSourceEvent\r\n} from '../../service/statistics/AnalyticsEvents';\r\nimport browser from '../browser';\r\nimport Statistics from '../statistics/statistics';\r\n\r\nimport JitsiTrack from './JitsiTrack';\r\nimport RTCUtils from './RTCUtils';\r\n\r\nconst logger = getLogger(__filename);\r\n\r\n/**\r\n * Represents a single media track(either audio or video).\r\n * One <tt>JitsiLocalTrack</tt> corresponds to one WebRTC MediaStreamTrack.\r\n */\r\nexport default class JitsiLocalTrack extends JitsiTrack {\r\n    /**\r\n     * Constructs new JitsiLocalTrack instance.\r\n     *\r\n     * @constructor\r\n     * @param {Object} trackInfo\r\n     * @param {number} trackInfo.rtcId the ID assigned by the RTC module\r\n     * @param trackInfo.stream WebRTC MediaStream, parent of the track\r\n     * @param trackInfo.track underlying WebRTC MediaStreamTrack for new\r\n     * JitsiRemoteTrack\r\n     * @param trackInfo.mediaType the MediaType of the JitsiRemoteTrack\r\n     * @param trackInfo.videoType the VideoType of the JitsiRemoteTrack\r\n     * @param trackInfo.effects the effects array contains the effect instance to use\r\n     * @param trackInfo.resolution the video resolution if it's a video track\r\n     * @param trackInfo.deviceId the ID of the local device for this track\r\n     * @param trackInfo.facingMode the camera facing mode used in getUserMedia\r\n     * call\r\n     * @param {sourceId} trackInfo.sourceId - The id of the desktop sharing\r\n     * source. NOTE: defined for desktop sharing tracks only.\r\n     */\r\n    constructor({\r\n        deviceId,\r\n        facingMode,\r\n        mediaType,\r\n        resolution,\r\n        rtcId,\r\n        sourceId,\r\n        sourceType,\r\n        stream,\r\n        track,\r\n        videoType,\r\n        effects = []\r\n    }) {\r\n        super(\r\n            /* conference */ null,\r\n            stream,\r\n            track,\r\n            /* streamInactiveHandler */ () => this.emit(LOCAL_TRACK_STOPPED),\r\n            mediaType,\r\n            videoType);\r\n\r\n        this._setEffectInProgress = false;\r\n        const effect = effects.find(e => e.isEnabled(this));\r\n\r\n        if (effect) {\r\n            this._startStreamEffect(effect);\r\n        }\r\n\r\n        /**\r\n         * The ID assigned by the RTC module on instance creation.\r\n         *\r\n         * @type {number}\r\n         */\r\n        this.rtcId = rtcId;\r\n        this.sourceId = sourceId;\r\n        this.sourceType = sourceType;\r\n\r\n        // Get the resolution from the track itself because it cannot be\r\n        // certain which resolution webrtc has fallen back to using.\r\n        this.resolution = track.getSettings().height;\r\n        this.maxEnabledResolution = resolution;\r\n\r\n        // Cache the constraints of the track in case of any this track\r\n        // model needs to call getUserMedia again, such as when unmuting.\r\n        this._constraints = track.getConstraints();\r\n\r\n        // Safari returns an empty constraints object, construct the constraints using getSettings.\r\n        if (!Object.keys(this._constraints).length && videoType === VideoType.CAMERA) {\r\n            this._constraints = {\r\n                height: track.getSettings().height,\r\n                width: track.getSettings().width\r\n            };\r\n        }\r\n\r\n        this.deviceId = deviceId;\r\n\r\n        /**\r\n         * The <tt>Promise</tt> which represents the progress of a previously\r\n         * queued/scheduled {@link _setMuted} (from the point of view of\r\n         * {@link _queueSetMuted}).\r\n         *\r\n         * @private\r\n         * @type {Promise}\r\n         */\r\n        this._prevSetMuted = Promise.resolve();\r\n\r\n        /**\r\n         * The facing mode of the camera from which this JitsiLocalTrack\r\n         * instance was obtained.\r\n         *\r\n         * @private\r\n         * @type {CameraFacingMode|undefined}\r\n         */\r\n        this._facingMode = facingMode;\r\n\r\n        // Currently there is no way to know the MediaStreamTrack ended due to\r\n        // to device disconnect in Firefox through e.g. \"readyState\" property.\r\n        // Instead we will compare current track's label with device labels from\r\n        // enumerateDevices() list.\r\n        this._trackEnded = false;\r\n\r\n        /**\r\n         * Indicates whether data has been sent or not.\r\n         */\r\n        this._hasSentData = false;\r\n\r\n        /**\r\n         * Used only for detection of audio problems. We want to check only once\r\n         * whether the track is sending data ot not. This flag is set to false\r\n         * after the check.\r\n         */\r\n        this._testDataSent = true;\r\n\r\n        // Currently there is no way to determine with what device track was\r\n        // created (until getConstraints() support), however we can associate\r\n        // tracks with real devices obtained from enumerateDevices() call as\r\n        // soon as it's called.\r\n        // NOTE: this.deviceId corresponds to the device id specified in GUM constraints and this._realDeviceId seems to\r\n        // correspond to the id of a matching device from the available device list.\r\n        this._realDeviceId = this.deviceId === '' ? undefined : this.deviceId;\r\n\r\n        this._trackMutedTS = 0;\r\n\r\n        this._onDeviceListWillChange = devices => {\r\n            const oldRealDeviceId = this._realDeviceId;\r\n\r\n            this._setRealDeviceIdFromDeviceList(devices);\r\n\r\n            if (\r\n                // Mark track as ended for those browsers that do not support\r\n                // \"readyState\" property. We do not touch tracks created with\r\n                // default device ID \"\".\r\n                (typeof this.getTrack().readyState === 'undefined'\r\n                    && typeof this._realDeviceId !== 'undefined'\r\n                    && !devices.find(d => d.deviceId === this._realDeviceId))\r\n\r\n                // If there was an associated realDeviceID and after the device change the realDeviceId is undefined\r\n                // then the associated device has been disconnected and the _trackEnded flag needs to be set. In\r\n                // addition on some Chrome versions the readyState property is set after the device change event is\r\n                // triggered which causes issues in jitsi-meet with the selection of a new device because we don't\r\n                // detect that the old one was removed.\r\n                || (typeof oldRealDeviceId !== 'undefined' && typeof this._realDeviceId === 'undefined')\r\n            ) {\r\n                this._trackEnded = true;\r\n            }\r\n        };\r\n\r\n        // Subscribe each created local audio track to\r\n        // RTCEvents.AUDIO_OUTPUT_DEVICE_CHANGED event. This is different from\r\n        // handling this event for remote tracks (which are handled in RTC.js),\r\n        // because there might be local tracks not attached to a conference.\r\n        if (this.isAudioTrack() && RTCUtils.isDeviceChangeAvailable('output')) {\r\n            this._onAudioOutputDeviceChanged = this.setAudioOutput.bind(this);\r\n            RTCUtils.addListener(\r\n                RTCEvents.AUDIO_OUTPUT_DEVICE_CHANGED,\r\n                this._onAudioOutputDeviceChanged);\r\n        }\r\n\r\n        RTCUtils.addListener(RTCEvents.DEVICE_LIST_WILL_CHANGE, this._onDeviceListWillChange);\r\n\r\n        this._initNoDataFromSourceHandlers();\r\n    }\r\n\r\n    /**\r\n     * Returns if associated MediaStreamTrack is in the 'ended' state\r\n     *\r\n     * @returns {boolean}\r\n     */\r\n    isEnded() {\r\n        if (this.isVideoTrack() && this.isMuted()) {\r\n            // If a video track is muted the readyState will be ended, that's why we need to rely only on the\r\n            // _trackEnded flag.\r\n            return this._trackEnded;\r\n        }\r\n\r\n        return this.getTrack().readyState === 'ended' || this._trackEnded;\r\n    }\r\n\r\n    /**\r\n     * Sets handlers to the MediaStreamTrack object that will detect camera\r\n     * issues.\r\n     */\r\n    _initNoDataFromSourceHandlers() {\r\n        if (!this._isNoDataFromSourceEventsEnabled()) {\r\n            return;\r\n        }\r\n\r\n        this._setHandler('track_mute', () => {\r\n            this._trackMutedTS = window.performance.now();\r\n            this._fireNoDataFromSourceEvent();\r\n        });\r\n\r\n        this._setHandler('track_unmute', () => {\r\n            this._fireNoDataFromSourceEvent();\r\n            Statistics.sendAnalyticsAndLog(\r\n                TRACK_UNMUTED,\r\n                {\r\n                    'media_type': this.getType(),\r\n                    'track_type': 'local',\r\n                    value: window.performance.now() - this._trackMutedTS\r\n                });\r\n        });\r\n\r\n        if (this.isVideoTrack() && this.videoType === VideoType.CAMERA) {\r\n            this._setHandler('track_ended', () => {\r\n                if (!this.isReceivingData()) {\r\n                    this._fireNoDataFromSourceEvent();\r\n                }\r\n            });\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Returns true if no data from source events are enabled for this JitsiLocalTrack and false otherwise.\r\n     *\r\n     * @returns {boolean} - True if no data from source events are enabled for this JitsiLocalTrack and false otherwise.\r\n     */\r\n    _isNoDataFromSourceEventsEnabled() {\r\n        // Disable the events for screen sharing.\r\n        return !this.isVideoTrack() || this.videoType !== VideoType.DESKTOP;\r\n    }\r\n\r\n    /**\r\n     * Fires NO_DATA_FROM_SOURCE event and logs it to analytics and callstats.\r\n     */\r\n    _fireNoDataFromSourceEvent() {\r\n        const value = !this.isReceivingData();\r\n\r\n        this.emit(NO_DATA_FROM_SOURCE, value);\r\n\r\n        // FIXME: Should we report all of those events\r\n        Statistics.sendAnalytics(createNoDataFromSourceEvent(this.getType(), value));\r\n        Statistics.sendLog(JSON.stringify({\r\n            name: NO_DATA_FROM_SOURCE,\r\n            log: value\r\n        }));\r\n    }\r\n\r\n    /**\r\n     * Sets real device ID by comparing track information with device\r\n     * information. This is temporary solution until getConstraints() method\r\n     * will be implemented in browsers.\r\n     *\r\n     * @param {MediaDeviceInfo[]} devices - list of devices obtained from\r\n     * enumerateDevices() call\r\n     */\r\n    _setRealDeviceIdFromDeviceList(devices) {\r\n        const track = this.getTrack();\r\n        const kind = `${track.kind}input`;\r\n        let device = devices.find(d => d.kind === kind && d.label === track.label);\r\n\r\n        if (!device && this._realDeviceId === 'default') { // the default device has been changed.\r\n            // If the default device was 'A' and the default device is changed to 'B' the label for the track will\r\n            // remain 'Default - A' but the label for the device in the device list will be updated to 'A'. That's\r\n            // why in order to match it we need to remove the 'Default - ' part.\r\n            const label = (track.label || '').replace('Default - ', '');\r\n\r\n            device = devices.find(d => d.kind === kind && d.label === label);\r\n        }\r\n\r\n        if (device) {\r\n            this._realDeviceId = device.deviceId;\r\n        } else {\r\n            this._realDeviceId = undefined;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Sets the stream property of JitsiLocalTrack object and sets all stored\r\n     * handlers to it.\r\n     *\r\n     * @param {MediaStream} stream the new stream.\r\n     * @protected\r\n     */\r\n    _setStream(stream) {\r\n        super._setStream(stream);\r\n\r\n        if (stream) {\r\n            // Store the MSID for video mute/unmute purposes.\r\n            this.storedMSID = this.getMSID();\r\n            logger.debug(`Setting new MSID: ${this.storedMSID} on ${this}`);\r\n        } else {\r\n            logger.debug(`Setting 'null' stream on ${this}`);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Starts the effect process and returns the modified stream.\r\n     *\r\n     * @private\r\n     * @param {*} effect - Represents effect instance\r\n     * @returns {void}\r\n     */\r\n    _startStreamEffect(effect) {\r\n        this._streamEffect = effect;\r\n        this._originalStream = this.stream;\r\n        this._setStream(this._streamEffect.startEffect(this._originalStream));\r\n        this.track = this.stream.getTracks()[0];\r\n    }\r\n\r\n    /**\r\n     * Stops the effect process and returns the original stream.\r\n     *\r\n     * @private\r\n     * @returns {void}\r\n     */\r\n    _stopStreamEffect() {\r\n        if (this._streamEffect) {\r\n            this._streamEffect.stopEffect();\r\n            this._setStream(this._originalStream);\r\n            this._originalStream = null;\r\n            this.track = this.stream ? this.stream.getTracks()[0] : null;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Stops the currently used effect (if there is one) and starts the passed effect (if there is one).\r\n     *\r\n     * @param {Object|undefined} effect - The new effect to be set.\r\n     */\r\n    _switchStreamEffect(effect) {\r\n        if (this._streamEffect) {\r\n            this._stopStreamEffect();\r\n            this._streamEffect = undefined;\r\n        }\r\n        if (effect) {\r\n            this._startStreamEffect(effect);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Sets the effect and switches between the modified stream and original one.\r\n     *\r\n     * @param {Object} effect - Represents the effect instance to be used.\r\n     * @returns {Promise}\r\n     */\r\n    setEffect(effect) {\r\n        if (typeof this._streamEffect === 'undefined' && typeof effect === 'undefined') {\r\n            return Promise.resolve();\r\n        }\r\n\r\n        if (typeof effect !== 'undefined' && !effect.isEnabled(this)) {\r\n            return Promise.reject(new Error('Incompatible effect instance!'));\r\n        }\r\n\r\n        if (this._setEffectInProgress === true) {\r\n            return Promise.reject(new Error('setEffect already in progress!'));\r\n        }\r\n\r\n        // In case we have an audio track that is being enhanced with an effect, we still want it to be applied,\r\n        // even if the track is muted. Where as for video the actual track doesn't exists if it's muted.\r\n        if (this.isMuted() && !this.isAudioTrack()) {\r\n            this._streamEffect = effect;\r\n\r\n            return Promise.resolve();\r\n        }\r\n\r\n        const conference = this.conference;\r\n\r\n        if (!conference) {\r\n            this._switchStreamEffect(effect);\r\n            if (this.isVideoTrack()) {\r\n                this.containers.forEach(cont => RTCUtils.attachMediaStream(cont, this.stream));\r\n            }\r\n\r\n            return Promise.resolve();\r\n        }\r\n\r\n        this._setEffectInProgress = true;\r\n\r\n        // TODO: Create new JingleSessionPC method for replacing a stream in JitsiLocalTrack without offer answer.\r\n        return conference.removeTrack(this)\r\n            .then(() => {\r\n                this._switchStreamEffect(effect);\r\n                if (this.isVideoTrack()) {\r\n                    this.containers.forEach(cont => RTCUtils.attachMediaStream(cont, this.stream));\r\n                }\r\n\r\n                return conference.addTrack(this);\r\n            })\r\n            .then(() => {\r\n                this._setEffectInProgress = false;\r\n            })\r\n            .catch(error => {\r\n                // Any error will be not recovarable and will trigger CONFERENCE_FAILED event. But let's try to cleanup\r\n                // everyhting related to the effect functionality.\r\n                this._setEffectInProgress = false;\r\n                this._switchStreamEffect();\r\n                logger.error('Failed to switch to the new stream!', error);\r\n                throw error;\r\n            });\r\n    }\r\n\r\n    /**\r\n     * Asynchronously mutes this track.\r\n     *\r\n     * @returns {Promise}\r\n     */\r\n    mute() {\r\n        return this._queueSetMuted(true);\r\n    }\r\n\r\n    /**\r\n     * Asynchronously unmutes this track.\r\n     *\r\n     * @returns {Promise}\r\n     */\r\n    unmute() {\r\n        return this._queueSetMuted(false);\r\n    }\r\n\r\n    /**\r\n     * Initializes a new Promise to execute {@link #_setMuted}. May be called\r\n     * multiple times in a row and the invocations of {@link #_setMuted} and,\r\n     * consequently, {@link #mute} and/or {@link #unmute} will be resolved in a\r\n     * serialized fashion.\r\n     *\r\n     * @param {boolean} muted - The value to invoke <tt>_setMuted</tt> with.\r\n     * @returns {Promise}\r\n     */\r\n    _queueSetMuted(muted) {\r\n        const setMuted = this._setMuted.bind(this, muted);\r\n\r\n        this._prevSetMuted = this._prevSetMuted.then(setMuted, setMuted);\r\n\r\n        return this._prevSetMuted;\r\n    }\r\n\r\n    /**\r\n     * Mutes / unmutes this track.\r\n     *\r\n     * @param {boolean} muted - If <tt>true</tt>, this track will be muted;\r\n     * otherwise, this track will be unmuted.\r\n     * @private\r\n     * @returns {Promise}\r\n     */\r\n    _setMuted(muted) {\r\n        if (this.isMuted() === muted) {\r\n            return Promise.resolve();\r\n        }\r\n\r\n        if (this.disposed) {\r\n            return Promise.reject(new JitsiTrackError(TRACK_IS_DISPOSED));\r\n        }\r\n\r\n        let promise = Promise.resolve();\r\n\r\n        // A function that will print info about muted status transition\r\n        const logMuteInfo = () => logger.info(`Mute ${this}: ${muted}`);\r\n\r\n        if (this.isAudioTrack()\r\n                || this.videoType === VideoType.DESKTOP\r\n                || !browser.doesVideoMuteByStreamRemove()) {\r\n            logMuteInfo();\r\n\r\n            // If we have a stream effect that implements its own mute functionality, prioritize it before\r\n            // normal mute e.g. the stream effect that implements system audio sharing has a custom\r\n            // mute state in which if the user mutes, system audio still has to go through.\r\n            if (this._streamEffect && this._streamEffect.setMuted) {\r\n                this._streamEffect.setMuted(muted);\r\n            } else if (this.track) {\r\n                this.track.enabled = !muted;\r\n            }\r\n        } else if (muted) {\r\n            promise = new Promise((resolve, reject) => {\r\n                logMuteInfo();\r\n                this._removeStreamFromConferenceAsMute(\r\n                    () => {\r\n                        if (this._streamEffect) {\r\n                            this._stopStreamEffect();\r\n                        }\r\n\r\n                        // FIXME: Maybe here we should set the SRC for the\r\n                        // containers to something\r\n                        // We don't want any events to be fired on this stream\r\n                        this._unregisterHandlers();\r\n                        this.stopStream();\r\n                        this._setStream(null);\r\n                        resolve();\r\n                    },\r\n                    reject);\r\n            });\r\n        } else {\r\n            logMuteInfo();\r\n\r\n            // This path is only for camera.\r\n            const streamOptions = {\r\n                cameraDeviceId: this.getDeviceId(),\r\n                devices: [ MediaType.VIDEO ],\r\n                effects: this._streamEffect ? [ this._streamEffect ] : [],\r\n                facingMode: this.getCameraFacingMode()\r\n            };\r\n\r\n            promise\r\n                = RTCUtils.obtainAudioAndVideoPermissions(Object.assign(\r\n                    {},\r\n                    streamOptions,\r\n                    { constraints: { video: this._constraints } }));\r\n\r\n            promise = promise.then(streamsInfo => {\r\n                // The track kind for presenter track is video as well.\r\n                const mediaType = this.getType() === MediaType.PRESENTER ? MediaType.VIDEO : this.getType();\r\n                const streamInfo = streamsInfo.find(info => info.track.kind === mediaType);\r\n\r\n                if (streamInfo) {\r\n                    this._setStream(streamInfo.stream);\r\n                    this.track = streamInfo.track;\r\n\r\n                    // This is not good when video type changes after\r\n                    // unmute, but let's not crash here\r\n                    if (this.videoType !== streamInfo.videoType) {\r\n                        logger.warn(\r\n                            `${this}: video type has changed after unmute!`,\r\n                            this.videoType, streamInfo.videoType);\r\n                        this.videoType = streamInfo.videoType;\r\n                    }\r\n                } else {\r\n                    throw new JitsiTrackError(TRACK_NO_STREAM_FOUND);\r\n                }\r\n\r\n                if (this._streamEffect) {\r\n                    this._startStreamEffect(this._streamEffect);\r\n                }\r\n\r\n                this.containers.map(\r\n                    cont => RTCUtils.attachMediaStream(cont, this.stream));\r\n\r\n                return this._addStreamToConferenceAsUnmute();\r\n            });\r\n        }\r\n\r\n        return promise\r\n            .then(() => this._sendMuteStatus(muted))\r\n            .then(() => this.emit(TRACK_MUTE_CHANGED, this));\r\n    }\r\n\r\n    /**\r\n     * Adds stream to conference and marks it as \"unmute\" operation.\r\n     *\r\n     * @private\r\n     * @returns {Promise}\r\n     */\r\n    _addStreamToConferenceAsUnmute() {\r\n        if (!this.conference) {\r\n            return Promise.resolve();\r\n        }\r\n\r\n        // FIXME it would be good to not included conference as part of this\r\n        // process. Only TraceablePeerConnections to which the track is attached\r\n        // should care about this action. The TPCs to which the track is not\r\n        // attached can sync up when track is re-attached.\r\n        // A problem with that is that the \"modify sources\" queue is part of\r\n        // the JingleSessionPC and it would be excluded from the process. One\r\n        // solution would be to extract class between TPC and JingleSessionPC\r\n        // which would contain the queue and would notify the signaling layer\r\n        // when local SSRCs are changed. This would help to separate XMPP from\r\n        // the RTC module.\r\n        return new Promise((resolve, reject) => {\r\n            this.conference._addLocalTrackAsUnmute(this)\r\n                .then(resolve, error => reject(new Error(error)));\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Removes stream from conference and marks it as \"mute\" operation.\r\n     *\r\n     * @param {Function} successCallback will be called on success\r\n     * @param {Function} errorCallback will be called on error\r\n     * @private\r\n     */\r\n    _removeStreamFromConferenceAsMute(successCallback, errorCallback) {\r\n        if (!this.conference) {\r\n            successCallback();\r\n\r\n            return;\r\n        }\r\n        this.conference._removeLocalTrackAsMute(this).then(\r\n            successCallback,\r\n            error => errorCallback(new Error(error)));\r\n    }\r\n\r\n    /**\r\n     * Sends mute status for a track to conference if any.\r\n     *\r\n     * @param {boolean} mute - If track is muted.\r\n     * @private\r\n     * @returns {Promise}\r\n     */\r\n    _sendMuteStatus(mute) {\r\n        if (!this.conference || !this.conference.room) {\r\n            return Promise.resolve();\r\n        }\r\n\r\n        return new Promise(resolve => {\r\n            this.conference.room[\r\n                this.isAudioTrack()\r\n                    ? 'setAudioMute'\r\n                    : 'setVideoMute'](mute, resolve);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * @inheritdoc\r\n     *\r\n     * Stops sending the media track. And removes it from the HTML.\r\n     * NOTE: Works for local tracks only.\r\n     *\r\n     * @extends JitsiTrack#dispose\r\n     * @returns {Promise}\r\n     */\r\n    dispose() {\r\n        let promise = Promise.resolve();\r\n\r\n        // Remove the effect instead of stopping it so that the original stream is restored\r\n        // on both the local track and on the peerconnection.\r\n        if (this._streamEffect) {\r\n            promise = this.setEffect();\r\n        }\r\n\r\n        if (this.conference) {\r\n            promise = promise.then(() => this.conference.removeTrack(this));\r\n        }\r\n\r\n        if (this.stream) {\r\n            this.stopStream();\r\n            this.detach();\r\n        }\r\n\r\n        RTCUtils.removeListener(RTCEvents.DEVICE_LIST_WILL_CHANGE, this._onDeviceListWillChange);\r\n\r\n        if (this._onAudioOutputDeviceChanged) {\r\n            RTCUtils.removeListener(RTCEvents.AUDIO_OUTPUT_DEVICE_CHANGED,\r\n                this._onAudioOutputDeviceChanged);\r\n        }\r\n\r\n        return promise.then(() => super.dispose());\r\n    }\r\n\r\n    /**\r\n     * Returns <tt>true</tt> - if the stream is muted and <tt>false</tt>\r\n     * otherwise.\r\n     *\r\n     * @returns {boolean} <tt>true</tt> - if the stream is muted and\r\n     * <tt>false</tt> otherwise.\r\n     */\r\n    isMuted() {\r\n        // this.stream will be null when we mute local video on Chrome\r\n        if (!this.stream) {\r\n            return true;\r\n        }\r\n        if (this.isVideoTrack() && !this.isActive()) {\r\n            return true;\r\n        }\r\n\r\n        // If currently used stream effect has its own muted state, use that.\r\n        if (this._streamEffect && this._streamEffect.isMuted) {\r\n            return this._streamEffect.isMuted();\r\n        }\r\n\r\n        return !this.track || !this.track.enabled;\r\n    }\r\n\r\n    /**\r\n     * Sets the JitsiConference object associated with the track. This is temp\r\n     * solution.\r\n     *\r\n     * @param conference the JitsiConference object\r\n     */\r\n    _setConference(conference) {\r\n        this.conference = conference;\r\n\r\n        // We want to keep up with postponed events which should have been fired\r\n        // on \"attach\" call, but for local track we not always have the\r\n        // conference before attaching. However this may result in duplicated\r\n        // events if they have been triggered on \"attach\" already.\r\n        for (let i = 0; i < this.containers.length; i++) {\r\n            this._maybeFireTrackAttached(this.containers[i]);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Returns <tt>true</tt>.\r\n     *\r\n     * @returns {boolean} <tt>true</tt>\r\n     */\r\n    isLocal() {\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Returns device id associated with track.\r\n     *\r\n     * @returns {string}\r\n     */\r\n    getDeviceId() {\r\n        return this._realDeviceId || this.deviceId;\r\n    }\r\n\r\n    /**\r\n     * Returns the participant id which owns the track.\r\n     *\r\n     * @returns {string} the id of the participants. It corresponds to the\r\n     * Colibri endpoint id/MUC nickname in case of Jitsi-meet.\r\n     */\r\n    getParticipantId() {\r\n        return this.conference && this.conference.myUserId();\r\n    }\r\n\r\n    /**\r\n     * Handles bytes sent statistics.\r\n     *\r\n     * @param {TraceablePeerConnection} tpc the source of the \"bytes sent\" stat\r\n     * @param {number} bytesSent the new value\r\n     * NOTE: used only for audio tracks to detect audio issues.\r\n     */\r\n    _onByteSentStatsReceived(tpc, bytesSent) {\r\n        if (bytesSent > 0) {\r\n            this._hasSentData = true;\r\n        }\r\n        const iceConnectionState = tpc.getConnectionState();\r\n\r\n        if (this._testDataSent && iceConnectionState === 'connected') {\r\n            setTimeout(() => {\r\n                if (!this._hasSentData) {\r\n                    logger.warn(`${this} 'bytes sent' <= 0: \\\r\n                        ${bytesSent}`);\r\n\r\n                    Statistics.analytics.sendEvent(NO_BYTES_SENT, { 'media_type': this.getType() });\r\n                }\r\n            }, 3000);\r\n            this._testDataSent = false;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Returns facing mode for video track from camera. For other cases (e.g.\r\n     * audio track or 'desktop' video track) returns undefined.\r\n     *\r\n     * @returns {CameraFacingMode|undefined}\r\n     */\r\n    getCameraFacingMode() {\r\n        if (this.isVideoTrack() && this.videoType === VideoType.CAMERA) {\r\n            // MediaStreamTrack#getSettings() is not implemented in many\r\n            // browsers, so we need feature checking here. Progress on the\r\n            // respective browser's implementation can be tracked at\r\n            // https://bugs.chromium.org/p/webrtc/issues/detail?id=2481 for\r\n            // Chromium and https://bugzilla.mozilla.org/show_bug.cgi?id=1213517\r\n            // for Firefox. Even if a browser implements getSettings() already,\r\n            // it might still not return anything for 'facingMode'.\r\n            const trackSettings = this.track.getSettings?.();\r\n\r\n            if (trackSettings && 'facingMode' in trackSettings) {\r\n                return trackSettings.facingMode;\r\n            }\r\n\r\n            if (typeof this._facingMode !== 'undefined') {\r\n                return this._facingMode;\r\n            }\r\n\r\n            // In most cases we are showing a webcam. So if we've gotten here,\r\n            // it should be relatively safe to assume that we are probably\r\n            // showing the user-facing camera.\r\n            return CameraFacingMode.USER;\r\n        }\r\n\r\n        return undefined;\r\n    }\r\n\r\n    /**\r\n     * Stops the associated MediaStream.\r\n     */\r\n    stopStream() {\r\n        /**\r\n         * Indicates that we are executing {@link #stopStream} i.e.\r\n         * {@link RTCUtils#stopMediaStream} for the <tt>MediaStream</tt>\r\n         * associated with this <tt>JitsiTrack</tt> instance.\r\n         *\r\n         * @private\r\n         * @type {boolean}\r\n         */\r\n        this._stopStreamInProgress = true;\r\n\r\n        try {\r\n            RTCUtils.stopMediaStream(this.stream);\r\n        } finally {\r\n            this._stopStreamInProgress = false;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Switches the camera facing mode if the WebRTC implementation supports the\r\n     * custom MediaStreamTrack._switchCamera method. Currently, the method in\r\n     * question is implemented in react-native-webrtc only. When such a WebRTC\r\n     * implementation is executing, the method is the preferred way to switch\r\n     * between the front/user-facing and the back/environment-facing cameras\r\n     * because it will likely be (as is the case of react-native-webrtc)\r\n     * noticeably faster that creating a new MediaStreamTrack via a new\r\n     * getUserMedia call with the switched facingMode constraint value.\r\n     * Moreover, the approach with a new getUserMedia call may not even work:\r\n     * WebRTC on Android and iOS is either very slow to open the camera a second\r\n     * time or plainly freezes attempting to do that.\r\n     */\r\n    _switchCamera() {\r\n        if (this.isVideoTrack()\r\n                && this.videoType === VideoType.CAMERA\r\n                && typeof this.track._switchCamera === 'function') {\r\n            this.track._switchCamera();\r\n\r\n            this._facingMode\r\n                = this._facingMode === CameraFacingMode.ENVIRONMENT\r\n                    ? CameraFacingMode.USER\r\n                    : CameraFacingMode.ENVIRONMENT;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Checks whether the attached MediaStream is receiving data from source or\r\n     * not. If the stream property is null(because of mute or another reason)\r\n     * this method will return false.\r\n     * NOTE: This method doesn't indicate problem with the streams directly.\r\n     * For example in case of video mute the method will return false or if the\r\n     * user has disposed the track.\r\n     *\r\n     * @returns {boolean} true if the stream is receiving data and false\r\n     * this otherwise.\r\n     */\r\n    isReceivingData() {\r\n        if (this.isVideoTrack()\r\n            && (this.isMuted() || this._stopStreamInProgress || this.videoType === VideoType.DESKTOP)) {\r\n            return true;\r\n        }\r\n\r\n        if (!this.stream) {\r\n            return false;\r\n        }\r\n\r\n        // In older version of the spec there is no muted property and\r\n        // readyState can have value muted. In the latest versions\r\n        // readyState can have values \"live\" and \"ended\" and there is\r\n        // muted boolean property. If the stream is muted that means that\r\n        // we aren't receiving any data from the source. We want to notify\r\n        // the users for error if the stream is muted or ended on it's\r\n        // creation.\r\n\r\n        // For video blur enabled use the original video stream\r\n        const stream = this._effectEnabled ? this._originalStream : this.stream;\r\n\r\n        return stream.getTracks().some(track =>\r\n            (!('readyState' in track) || track.readyState === 'live')\r\n                && (!('muted' in track) || track.muted !== true));\r\n    }\r\n\r\n    /**\r\n     * Creates a text representation of this local track instance.\r\n     *\r\n     * @return {string}\r\n     */\r\n    toString() {\r\n        return `LocalTrack[${this.rtcId},${this.getType()}]`;\r\n    }\r\n}\r\n","/**\r\n * A collection of utility functions for taking in XML and parsing it to return\r\n * certain values.\r\n */\r\nexport default {\r\n    /**\r\n     * Parses the presence update of the focus and returns an object with the\r\n     * statuses related to recording.\r\n     *\r\n     * @param {Node} presence - An XMPP presence update.\r\n     * @returns {Object} The current presence values related to recording.\r\n     */\r\n    getFocusRecordingUpdate(presence) {\r\n        const jibriStatus = presence\r\n            && presence.getElementsByTagName('jibri-recording-status')[0];\r\n\r\n        if (!jibriStatus) {\r\n            return;\r\n        }\r\n\r\n        return {\r\n            error: jibriStatus.getAttribute('failure_reason'),\r\n            initiator: jibriStatus.getAttribute('initiator'),\r\n            recordingMode: jibriStatus.getAttribute('recording_mode'),\r\n            sessionID: jibriStatus.getAttribute('session_id'),\r\n            status: jibriStatus.getAttribute('status')\r\n        };\r\n    },\r\n\r\n    /**\r\n     * Parses the presence update from a hidden domain participant and returns\r\n     * an object with the statuses related to recording.\r\n     *\r\n     * @param {Node} presence - An XMPP presence update.\r\n     * @returns {Object} The current presence values related to recording.\r\n     */\r\n    getHiddenDomainUpdate(presence) {\r\n        const liveStreamViewURLContainer\r\n            = presence.getElementsByTagName('live-stream-view-url')[0];\r\n        const liveStreamViewURL = liveStreamViewURLContainer\r\n            && liveStreamViewURLContainer.textContent;\r\n        const modeContainer\r\n            = presence.getElementsByTagName('mode')[0];\r\n        const mode = modeContainer\r\n            && modeContainer.textContent\r\n            && modeContainer.textContent.toLowerCase();\r\n        const sessionIDContainer\r\n            = presence.getElementsByTagName('session_id')[0];\r\n        const sessionID\r\n            = sessionIDContainer && sessionIDContainer.textContent;\r\n\r\n        return {\r\n            liveStreamViewURL,\r\n            mode,\r\n            sessionID\r\n        };\r\n    },\r\n\r\n    /**\r\n     * Returns the recording session ID from a successful IQ.\r\n     *\r\n     * @param {Node} response - The response from the IQ.\r\n     * @returns {string} The session ID of the recording session.\r\n     */\r\n    getSessionIdFromIq(response) {\r\n        const jibri = response && response.getElementsByTagName('jibri')[0];\r\n\r\n        return jibri && jibri.getAttribute('session_id');\r\n    },\r\n\r\n    /**\r\n     * Returns the recording session ID from a presence, if it exists.\r\n     *\r\n     * @param {Node} presence - An XMPP presence update.\r\n     * @returns {string|undefined} The session ID of the recording session.\r\n     */\r\n    getSessionId(presence) {\r\n        const sessionIdContainer\r\n            = presence.getElementsByTagName('session_id')[0];\r\n        const sessionId = sessionIdContainer && sessionIdContainer.textContent;\r\n\r\n        return sessionId;\r\n    },\r\n\r\n    /**\r\n     * Returns whether or not a presence is from the focus.\r\n     *\r\n     * @param {Node} presence - An XMPP presence update.\r\n     * @returns {boolean} True if the presence is from the focus.\r\n     */\r\n    isFromFocus(presence) {\r\n        return presence.getAttribute('from').includes('focus');\r\n    }\r\n};\r\n","/* global __filename, Olm */\r\n\r\nimport base64js from 'base64-js';\r\nimport { getLogger } from 'jitsi-meet-logger';\r\nimport isEqual from 'lodash.isequal';\r\nimport { v4 as uuidv4 } from 'uuid';\r\n\r\nimport * as JitsiConferenceEvents from '../../JitsiConferenceEvents';\r\nimport Deferred from '../util/Deferred';\r\nimport Listenable from '../util/Listenable';\r\nimport { FEATURE_E2EE, JITSI_MEET_MUC_TYPE } from '../xmpp/xmpp';\r\n\r\nconst logger = getLogger(__filename);\r\n\r\nconst REQ_TIMEOUT = 5 * 1000;\r\nconst OLM_MESSAGE_TYPE = 'olm';\r\nconst OLM_MESSAGE_TYPES = {\r\n    ERROR: 'error',\r\n    KEY_INFO: 'key-info',\r\n    KEY_INFO_ACK: 'key-info-ack',\r\n    SESSION_ACK: 'session-ack',\r\n    SESSION_INIT: 'session-init'\r\n};\r\n\r\nconst kOlmData = Symbol('OlmData');\r\n\r\nconst OlmAdapterEvents = {\r\n    OLM_ID_KEY_READY: 'olm.id_key_ready',\r\n    PARTICIPANT_E2EE_CHANNEL_READY: 'olm.participant_e2ee_channel_ready',\r\n    PARTICIPANT_KEY_UPDATED: 'olm.partitipant_key_updated'\r\n};\r\n\r\n/**\r\n * This class implements an End-to-End Encrypted communication channel between every two peers\r\n * in the conference. This channel uses libolm to achieve E2EE.\r\n *\r\n * The created channel is then used to exchange the secret key that each participant will use\r\n * to encrypt the actual media (see {@link E2EEContext}).\r\n *\r\n * A simple JSON message based protocol is implemented, which follows a request - response model:\r\n * - session-init: Initiates an olm session establishment procedure. This message will be sent\r\n *                 by the participant who just joined, to everyone else.\r\n * - session-ack: Completes the olm session etablishment. This messsage may contain ancilliary\r\n *                encrypted data, more specifically the sender's current key.\r\n * - key-info: Includes the sender's most up to date key information.\r\n * - key-info-ack: Acknowledges the reception of a key-info request. In addition, it may contain\r\n *                 the sender's key information, if available.\r\n * - error: Indicates a request processing error has occurred.\r\n *\r\n * These requessts and responses are transport independent. Currently they are sent using XMPP\r\n * MUC private messages.\r\n */\r\nexport class OlmAdapter extends Listenable {\r\n    /**\r\n     * Creates an adapter instance for the given conference.\r\n     */\r\n    constructor(conference) {\r\n        super();\r\n\r\n        this._conf = conference;\r\n        this._init = new Deferred();\r\n        this._key = undefined;\r\n        this._keyIndex = -1;\r\n        this._reqs = new Map();\r\n        this._sessionInitialization = undefined;\r\n\r\n        if (OlmAdapter.isSupported()) {\r\n            this._bootstrapOlm();\r\n\r\n            this._conf.on(JitsiConferenceEvents.ENDPOINT_MESSAGE_RECEIVED, this._onEndpointMessageReceived.bind(this));\r\n            this._conf.on(JitsiConferenceEvents.CONFERENCE_LEFT, this._onConferenceLeft.bind(this));\r\n            this._conf.on(JitsiConferenceEvents.USER_LEFT, this._onParticipantLeft.bind(this));\r\n            this._conf.on(JitsiConferenceEvents.PARTICIPANT_PROPERTY_CHANGED,\r\n                this._onParticipantPropertyChanged.bind(this));\r\n        } else {\r\n            this._init.reject(new Error('Olm not supported'));\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Starts new olm sessions with every other participant that has the participantId \"smaller\" the localParticipantId.\r\n     */\r\n    async initSessions() {\r\n        if (this._sessionInitialization) {\r\n            throw new Error('OlmAdapter initSessions called multiple times');\r\n        } else {\r\n            this._sessionInitialization = new Deferred();\r\n\r\n            await this._init;\r\n\r\n            const promises = [];\r\n            const localParticipantId = this._conf.myUserId();\r\n\r\n            for (const participant of this._conf.getParticipants()) {\r\n                const participantFeatures = await participant.getFeatures();\r\n\r\n                if (participantFeatures.has(FEATURE_E2EE) && localParticipantId < participant.getId()) {\r\n                    promises.push(this._sendSessionInit(participant));\r\n                }\r\n            }\r\n\r\n            await Promise.allSettled(promises);\r\n\r\n            // TODO: retry failed ones.\r\n\r\n            this._sessionInitialization.resolve();\r\n            this._sessionInitialization = undefined;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Indicates if olm is supported on the current platform.\r\n     *\r\n     * @returns {boolean}\r\n     */\r\n    static isSupported() {\r\n        return typeof window.Olm !== 'undefined';\r\n    }\r\n\r\n    /**\r\n     * Updates the current participant key and distributes it to all participants in the conference\r\n     * by sending a key-info message.\r\n     *\r\n     * @param {Uint8Array|boolean} key - The new key.\r\n     * @retrns {Promise<Number>}\r\n     */\r\n    async updateKey(key) {\r\n        // Store it locally for new sessions.\r\n        this._key = key;\r\n        this._keyIndex++;\r\n\r\n        // Broadcast it.\r\n        const promises = [];\r\n\r\n        for (const participant of this._conf.getParticipants()) {\r\n            const pId = participant.getId();\r\n            const olmData = this._getParticipantOlmData(participant);\r\n\r\n            // TODO: skip those who don't support E2EE.\r\n            if (!olmData.session) {\r\n                logger.warn(`Tried to send key to participant ${pId} but we have no session`);\r\n\r\n                // eslint-disable-next-line no-continue\r\n                continue;\r\n            }\r\n\r\n            const uuid = uuidv4();\r\n            const data = {\r\n                [JITSI_MEET_MUC_TYPE]: OLM_MESSAGE_TYPE,\r\n                olm: {\r\n                    type: OLM_MESSAGE_TYPES.KEY_INFO,\r\n                    data: {\r\n                        ciphertext: this._encryptKeyInfo(olmData.session),\r\n                        uuid\r\n                    }\r\n                }\r\n            };\r\n            const d = new Deferred();\r\n\r\n            d.setRejectTimeout(REQ_TIMEOUT);\r\n            d.catch(() => {\r\n                this._reqs.delete(uuid);\r\n            });\r\n            this._reqs.set(uuid, d);\r\n            promises.push(d);\r\n\r\n            this._sendMessage(data, pId);\r\n        }\r\n\r\n        await Promise.allSettled(promises);\r\n\r\n        // TODO: retry failed ones?\r\n\r\n        return this._keyIndex;\r\n    }\r\n\r\n    /**\r\n     * Updates the current participant key.\r\n     * @param {Uint8Array|boolean} key - The new key.\r\n     * @returns {number}\r\n    */\r\n    updateCurrentKey(key) {\r\n        this._key = key;\r\n\r\n        return this._keyIndex;\r\n    }\r\n\r\n    /**\r\n     * Frees the olmData session for the given participant.\r\n     *\r\n     */\r\n    clearParticipantSession(participant) {\r\n        const olmData = this._getParticipantOlmData(participant);\r\n\r\n        if (olmData.session) {\r\n            olmData.session.free();\r\n            olmData.session = undefined;\r\n        }\r\n    }\r\n\r\n\r\n    /**\r\n     * Frees the olmData sessions for all participants.\r\n     *\r\n     */\r\n    clearAllParticipantsSessions() {\r\n        for (const participant of this._conf.getParticipants()) {\r\n            this.clearParticipantSession(participant);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Internal helper to bootstrap the olm library.\r\n     *\r\n     * @returns {Promise<void>}\r\n     * @private\r\n     */\r\n    async _bootstrapOlm() {\r\n        logger.debug('Initializing Olm...');\r\n\r\n        try {\r\n            await Olm.init();\r\n\r\n            this._olmAccount = new Olm.Account();\r\n            this._olmAccount.create();\r\n\r\n            const idKeys = JSON.parse(this._olmAccount.identity_keys());\r\n\r\n            this._idKey = idKeys.curve25519;\r\n\r\n            logger.debug(`Olm ${Olm.get_library_version().join('.')} initialized`);\r\n            this._init.resolve();\r\n            this.eventEmitter.emit(OlmAdapterEvents.OLM_ID_KEY_READY, this._idKey);\r\n        } catch (e) {\r\n            logger.error('Failed to initialize Olm', e);\r\n            this._init.reject(e);\r\n        }\r\n\r\n    }\r\n\r\n    /**\r\n     * Internal helper for encrypting the current key information for a given participant.\r\n     *\r\n     * @param {Olm.Session} session - Participant's session.\r\n     * @returns {string} - The encrypted text with the key information.\r\n     * @private\r\n     */\r\n    _encryptKeyInfo(session) {\r\n        const keyInfo = {};\r\n\r\n        if (this._key !== undefined) {\r\n            keyInfo.key = this._key ? base64js.fromByteArray(this._key) : false;\r\n            keyInfo.keyIndex = this._keyIndex;\r\n        }\r\n\r\n        return session.encrypt(JSON.stringify(keyInfo));\r\n    }\r\n\r\n    /**\r\n     * Internal helper for getting the olm related data associated with a participant.\r\n     *\r\n     * @param {JitsiParticipant} participant - Participant whose data wants to be extracted.\r\n     * @returns {Object}\r\n     * @private\r\n     */\r\n    _getParticipantOlmData(participant) {\r\n        participant[kOlmData] = participant[kOlmData] || {};\r\n\r\n        return participant[kOlmData];\r\n    }\r\n\r\n    /**\r\n     * Handles leaving the conference, cleaning up olm sessions.\r\n     *\r\n     * @private\r\n     */\r\n    async _onConferenceLeft() {\r\n        logger.debug('Conference left');\r\n\r\n        await this._init;\r\n\r\n        for (const participant of this._conf.getParticipants()) {\r\n            this._onParticipantLeft(participant.getId(), participant);\r\n        }\r\n\r\n        if (this._olmAccount) {\r\n            this._olmAccount.free();\r\n            this._olmAccount = undefined;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Main message handler. Handles 1-to-1 messages received from other participants\r\n     * and send the appropriate replies.\r\n     *\r\n     * @private\r\n     */\r\n    async _onEndpointMessageReceived(participant, payload) {\r\n        if (payload[JITSI_MEET_MUC_TYPE] !== OLM_MESSAGE_TYPE) {\r\n            return;\r\n        }\r\n\r\n        if (!payload.olm) {\r\n            logger.warn('Incorrectly formatted message');\r\n\r\n            return;\r\n        }\r\n\r\n        await this._init;\r\n\r\n        const msg = payload.olm;\r\n        const pId = participant.getId();\r\n        const olmData = this._getParticipantOlmData(participant);\r\n\r\n        switch (msg.type) {\r\n        case OLM_MESSAGE_TYPES.SESSION_INIT: {\r\n            if (olmData.session) {\r\n                logger.warn(`Participant ${pId} already has a session`);\r\n\r\n                this._sendError(participant, 'Session already established');\r\n            } else {\r\n                // Create a session for communicating with this participant.\r\n\r\n                const session = new Olm.Session();\r\n\r\n                session.create_outbound(this._olmAccount, msg.data.idKey, msg.data.otKey);\r\n                olmData.session = session;\r\n\r\n                // Send ACK\r\n                const ack = {\r\n                    [JITSI_MEET_MUC_TYPE]: OLM_MESSAGE_TYPE,\r\n                    olm: {\r\n                        type: OLM_MESSAGE_TYPES.SESSION_ACK,\r\n                        data: {\r\n                            ciphertext: this._encryptKeyInfo(session),\r\n                            uuid: msg.data.uuid\r\n                        }\r\n                    }\r\n                };\r\n\r\n                this._sendMessage(ack, pId);\r\n                this.eventEmitter.emit(OlmAdapterEvents.PARTICIPANT_E2EE_CHANNEL_READY, pId);\r\n            }\r\n            break;\r\n        }\r\n        case OLM_MESSAGE_TYPES.SESSION_ACK: {\r\n            if (olmData.session) {\r\n                logger.warn(`Participant ${pId} already has a session`);\r\n\r\n                this._sendError(participant, 'No session found');\r\n            } else if (msg.data.uuid === olmData.pendingSessionUuid) {\r\n                const { ciphertext } = msg.data;\r\n                const d = this._reqs.get(msg.data.uuid);\r\n                const session = new Olm.Session();\r\n\r\n                session.create_inbound(this._olmAccount, ciphertext.body);\r\n\r\n                // Remove OT keys that have been used to setup this session.\r\n                this._olmAccount.remove_one_time_keys(session);\r\n\r\n                // Decrypt first message.\r\n                const data = session.decrypt(ciphertext.type, ciphertext.body);\r\n\r\n                olmData.session = session;\r\n                olmData.pendingSessionUuid = undefined;\r\n\r\n                this.eventEmitter.emit(OlmAdapterEvents.PARTICIPANT_E2EE_CHANNEL_READY, pId);\r\n\r\n                this._reqs.delete(msg.data.uuid);\r\n                d.resolve();\r\n\r\n                const json = safeJsonParse(data);\r\n\r\n                if (json.key) {\r\n                    const key = base64js.toByteArray(json.key);\r\n                    const keyIndex = json.keyIndex;\r\n\r\n                    olmData.lastKey = key;\r\n                    this.eventEmitter.emit(OlmAdapterEvents.PARTICIPANT_KEY_UPDATED, pId, key, keyIndex);\r\n                }\r\n            } else {\r\n                logger.warn('Received ACK with the wrong UUID');\r\n\r\n                this._sendError(participant, 'Invalid UUID');\r\n            }\r\n            break;\r\n        }\r\n        case OLM_MESSAGE_TYPES.ERROR: {\r\n            logger.error(msg.data.error);\r\n\r\n            break;\r\n        }\r\n        case OLM_MESSAGE_TYPES.KEY_INFO: {\r\n            if (olmData.session) {\r\n                const { ciphertext } = msg.data;\r\n                const data = olmData.session.decrypt(ciphertext.type, ciphertext.body);\r\n                const json = safeJsonParse(data);\r\n\r\n                if (json.key !== undefined && json.keyIndex !== undefined) {\r\n                    const key = json.key ? base64js.toByteArray(json.key) : false;\r\n                    const keyIndex = json.keyIndex;\r\n\r\n                    if (!isEqual(olmData.lastKey, key)) {\r\n                        olmData.lastKey = key;\r\n                        this.eventEmitter.emit(OlmAdapterEvents.PARTICIPANT_KEY_UPDATED, pId, key, keyIndex);\r\n                    }\r\n\r\n                    // Send ACK.\r\n                    const ack = {\r\n                        [JITSI_MEET_MUC_TYPE]: OLM_MESSAGE_TYPE,\r\n                        olm: {\r\n                            type: OLM_MESSAGE_TYPES.KEY_INFO_ACK,\r\n                            data: {\r\n                                ciphertext: this._encryptKeyInfo(olmData.session),\r\n                                uuid: msg.data.uuid\r\n                            }\r\n                        }\r\n                    };\r\n\r\n                    this._sendMessage(ack, pId);\r\n                }\r\n            } else {\r\n                logger.debug(`Received key info message from ${pId} but we have no session for them!`);\r\n\r\n                this._sendError(participant, 'No session found while processing key-info');\r\n            }\r\n            break;\r\n        }\r\n        case OLM_MESSAGE_TYPES.KEY_INFO_ACK: {\r\n            if (olmData.session) {\r\n                const { ciphertext } = msg.data;\r\n                const data = olmData.session.decrypt(ciphertext.type, ciphertext.body);\r\n                const json = safeJsonParse(data);\r\n\r\n                if (json.key !== undefined && json.keyIndex !== undefined) {\r\n                    const key = json.key ? base64js.toByteArray(json.key) : false;\r\n                    const keyIndex = json.keyIndex;\r\n\r\n                    if (!isEqual(olmData.lastKey, key)) {\r\n                        olmData.lastKey = key;\r\n                        this.eventEmitter.emit(OlmAdapterEvents.PARTICIPANT_KEY_UPDATED, pId, key, keyIndex);\r\n                    }\r\n                }\r\n\r\n                const d = this._reqs.get(msg.data.uuid);\r\n\r\n                this._reqs.delete(msg.data.uuid);\r\n                d.resolve();\r\n            } else {\r\n                logger.debug(`Received key info ack message from ${pId} but we have no session for them!`);\r\n\r\n                this._sendError(participant, 'No session found while processing key-info-ack');\r\n            }\r\n            break;\r\n        }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Handles a participant leaving. When a participant leaves their olm session is destroyed.\r\n     *\r\n     * @private\r\n     */\r\n    _onParticipantLeft(id, participant) {\r\n        logger.debug(`Participant ${id} left`);\r\n\r\n        this.clearParticipantSession(participant);\r\n    }\r\n\r\n    /**\r\n    * Handles an update in a participant's presence property.\r\n    *\r\n    * @param {JitsiParticipant} participant - The participant.\r\n    * @param {string} name - The name of the property that changed.\r\n    * @param {*} oldValue - The property's previous value.\r\n    * @param {*} newValue - The property's new value.\r\n    * @private\r\n    */\r\n    async _onParticipantPropertyChanged(participant, name, oldValue, newValue) {\r\n        switch (name) {\r\n        case 'e2ee.enabled':\r\n            if (newValue && this._conf.isE2EEEnabled()) {\r\n                const localParticipantId = this._conf.myUserId();\r\n                const participantId = participant.getId();\r\n                const participantFeatures = await participant.getFeatures();\r\n\r\n                if (participantFeatures.has(FEATURE_E2EE) && localParticipantId < participantId) {\r\n                    if (this._sessionInitialization) {\r\n                        await this._sessionInitialization;\r\n                    }\r\n                    await this._sendSessionInit(participant);\r\n\r\n                    const olmData = this._getParticipantOlmData(participant);\r\n                    const uuid = uuidv4();\r\n                    const data = {\r\n                        [JITSI_MEET_MUC_TYPE]: OLM_MESSAGE_TYPE,\r\n                        olm: {\r\n                            type: OLM_MESSAGE_TYPES.KEY_INFO,\r\n                            data: {\r\n                                ciphertext: this._encryptKeyInfo(olmData.session),\r\n                                uuid\r\n                            }\r\n                        }\r\n                    };\r\n\r\n                    this._sendMessage(data, participantId);\r\n                }\r\n            }\r\n            break;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Builds and sends an error message to the target participant.\r\n     *\r\n     * @param {JitsiParticipant} participant - The target participant.\r\n     * @param {string} error - The error message.\r\n     * @returns {void}\r\n     */\r\n    _sendError(participant, error) {\r\n        const pId = participant.getId();\r\n        const err = {\r\n            [JITSI_MEET_MUC_TYPE]: OLM_MESSAGE_TYPE,\r\n            olm: {\r\n                type: OLM_MESSAGE_TYPES.ERROR,\r\n                data: {\r\n                    error\r\n                }\r\n            }\r\n        };\r\n\r\n        this._sendMessage(err, pId);\r\n    }\r\n\r\n    /**\r\n     * Internal helper to send the given object to the given participant ID.\r\n     * This function merely exists so the transport can be easily swapped.\r\n     * Currently messages are transmitted via XMPP MUC private messages.\r\n     *\r\n     * @param {object} data - The data that will be sent to the target participant.\r\n     * @param {string} participantId - ID of the target participant.\r\n     */\r\n    _sendMessage(data, participantId) {\r\n        this._conf.sendMessage(data, participantId);\r\n    }\r\n\r\n    /**\r\n     * Builds and sends the session-init request to the target participant.\r\n     *\r\n     * @param {JitsiParticipant} participant - Participant to whom we'll send the request.\r\n     * @returns {Promise} - The promise will be resolved when the session-ack is received.\r\n     * @private\r\n     */\r\n    _sendSessionInit(participant) {\r\n        const pId = participant.getId();\r\n        const olmData = this._getParticipantOlmData(participant);\r\n\r\n        if (olmData.session) {\r\n            logger.warn(`Tried to send session-init to ${pId} but we already have a session`);\r\n\r\n            return Promise.reject();\r\n        }\r\n\r\n        if (olmData.pendingSessionUuid !== undefined) {\r\n            logger.warn(`Tried to send session-init to ${pId} but we already have a pending session`);\r\n\r\n            return Promise.reject();\r\n        }\r\n\r\n        // Generate a One Time Key.\r\n        this._olmAccount.generate_one_time_keys(1);\r\n\r\n        const otKeys = JSON.parse(this._olmAccount.one_time_keys());\r\n        const otKey = Object.values(otKeys.curve25519)[0];\r\n\r\n        if (!otKey) {\r\n            return Promise.reject(new Error('No one-time-keys generated'));\r\n        }\r\n\r\n        // Mark the OT keys (one really) as published so they are not reused.\r\n        this._olmAccount.mark_keys_as_published();\r\n\r\n        const uuid = uuidv4();\r\n        const init = {\r\n            [JITSI_MEET_MUC_TYPE]: OLM_MESSAGE_TYPE,\r\n            olm: {\r\n                type: OLM_MESSAGE_TYPES.SESSION_INIT,\r\n                data: {\r\n                    idKey: this._idKey,\r\n                    otKey,\r\n                    uuid\r\n                }\r\n            }\r\n        };\r\n\r\n        const d = new Deferred();\r\n\r\n        d.setRejectTimeout(REQ_TIMEOUT);\r\n        d.catch(() => {\r\n            this._reqs.delete(uuid);\r\n            olmData.pendingSessionUuid = undefined;\r\n        });\r\n        this._reqs.set(uuid, d);\r\n\r\n        this._sendMessage(init, pId);\r\n\r\n        // Store the UUID for matching with the ACK.\r\n        olmData.pendingSessionUuid = uuid;\r\n\r\n        return d;\r\n    }\r\n}\r\n\r\nOlmAdapter.events = OlmAdapterEvents;\r\n\r\n/**\r\n * Helper to ensure JSON parsing always returns an object.\r\n *\r\n * @param {string} data - The data that needs to be parsed.\r\n * @returns {object} - Parsed data or empty object in case of failure.\r\n */\r\nfunction safeJsonParse(data) {\r\n    try {\r\n        return JSON.parse(data);\r\n    } catch (e) {\r\n        return {};\r\n    }\r\n}\r\n","export interface GayazoReturnType{\r\n  url: string,\r\n  size: [number, number],\r\n}\r\nexport function uploadToGyazo(imageData: Blob):Promise<string> {\r\n  const promise = new Promise<string>((resolutionFunc, rejectionFunc) => {\r\n    const formData = new FormData()\r\n    formData.append('access_token', 'e9889a51fca19f2712ec046016b7ec0808953103e32cd327b91f11bfddaa8533')\r\n    formData.append('imagedata', imageData)\r\n    fetch('https://upload.gyazo.com/api/upload', {method: 'POST', body: formData})\r\n    .then(response => response.json())\r\n    .then((responseJson) => {\r\n      // console.log(\"URL = \" + responseJson.url)\r\n      //  To do, add URL and ask user position to place the image\r\n      resolutionFunc(responseJson.url)\r\n    })\r\n    .catch((error) => {\r\n      console.error(error)\r\n      rejectionFunc('')\r\n    })\r\n  })\r\n\r\n  return promise\r\n}\r\n\r\nexport function getImageSize(url: string) {\r\n  const promise = new Promise<[number, number]>((resolutionFunc, rejectionFunc) => {\r\n    const img = new Image()\r\n    img.src = url\r\n    img.onload = () => {\r\n      const size:[number, number] = [img.width, img.height]\r\n      resolutionFunc(size)\r\n    }\r\n    img.onerror = () => { rejectionFunc([0, 0]) }\r\n  })\r\n\r\n  return promise\r\n}\r\n","/* global __filename */\r\n\r\nimport { getLogger } from 'jitsi-meet-logger';\r\nimport debounce from 'lodash.debounce';\r\n\r\nimport * as JitsiConferenceEvents from '../../JitsiConferenceEvents';\r\nimport RTCEvents from '../../service/RTC/RTCEvents';\r\nimport browser from '../browser';\r\nimport Deferred from '../util/Deferred';\r\n\r\nimport E2EEContext from './E2EEContext';\r\nimport { OlmAdapter } from './OlmAdapter';\r\nimport { importKey, ratchet } from './crypto-utils';\r\n\r\nconst logger = getLogger(__filename);\r\n\r\n// Period which we'll wait before updating / rotating our keys when a participant\r\n// joins or leaves.\r\nconst DEBOUNCE_PERIOD = 5000;\r\n\r\n/**\r\n * This module integrates {@link E2EEContext} with {@link JitsiConference} in order to enable E2E encryption.\r\n */\r\nexport class E2EEncryption {\r\n    /**\r\n     * A constructor.\r\n     * @param {JitsiConference} conference - The conference instance for which E2E encryption is to be enabled.\r\n     */\r\n    constructor(conference) {\r\n        this.conference = conference;\r\n\r\n        this._conferenceJoined = false;\r\n        this._enabled = false;\r\n        this._key = undefined;\r\n        this._enabling = undefined;\r\n\r\n        this._e2eeCtx = new E2EEContext();\r\n        this._olmAdapter = new OlmAdapter(conference);\r\n\r\n        // Debounce key rotation / ratcheting to avoid a storm of messages.\r\n        this._ratchetKey = debounce(this._ratchetKeyImpl, DEBOUNCE_PERIOD);\r\n        this._rotateKey = debounce(this._rotateKeyImpl, DEBOUNCE_PERIOD);\r\n\r\n        // Participant join / leave operations. Used for key advancement / rotation.\r\n        //\r\n\r\n        this.conference.on(\r\n            JitsiConferenceEvents.CONFERENCE_JOINED,\r\n            () => {\r\n                this._conferenceJoined = true;\r\n            });\r\n        this.conference.on(\r\n            JitsiConferenceEvents.PARTICIPANT_PROPERTY_CHANGED,\r\n            this._onParticipantPropertyChanged.bind(this));\r\n        this.conference.on(\r\n            JitsiConferenceEvents.USER_JOINED,\r\n            this._onParticipantJoined.bind(this));\r\n        this.conference.on(\r\n            JitsiConferenceEvents.USER_LEFT,\r\n            this._onParticipantLeft.bind(this));\r\n\r\n        // Conference media events in order to attach the encryptor / decryptor.\r\n        // FIXME add events to TraceablePeerConnection which will allow to see when there's new receiver or sender\r\n        // added instead of shenanigans around conference track events and track muted.\r\n        //\r\n\r\n        this.conference.on(\r\n            JitsiConferenceEvents._MEDIA_SESSION_STARTED,\r\n            this._onMediaSessionStarted.bind(this));\r\n        this.conference.on(\r\n            JitsiConferenceEvents.TRACK_ADDED,\r\n            track => track.isLocal() && this._onLocalTrackAdded(track));\r\n        this.conference.rtc.on(\r\n            RTCEvents.REMOTE_TRACK_ADDED,\r\n            (track, tpc) => this._setupReceiverE2EEForTrack(tpc, track));\r\n        this.conference.on(\r\n            JitsiConferenceEvents.TRACK_MUTE_CHANGED,\r\n            this._trackMuteChanged.bind(this));\r\n\r\n        // Olm signalling events.\r\n        this._olmAdapter.on(\r\n            OlmAdapter.events.OLM_ID_KEY_READY,\r\n            this._onOlmIdKeyReady.bind(this));\r\n        this._olmAdapter.on(\r\n            OlmAdapter.events.PARTICIPANT_E2EE_CHANNEL_READY,\r\n            this._onParticipantE2EEChannelReady.bind(this));\r\n        this._olmAdapter.on(\r\n            OlmAdapter.events.PARTICIPANT_KEY_UPDATED,\r\n            this._onParticipantKeyUpdated.bind(this));\r\n    }\r\n\r\n    /**\r\n     * Indicates if E2EE is supported in the current platform.\r\n     *\r\n     * @param {object} config - Global configuration.\r\n     * @returns {boolean}\r\n     */\r\n    static isSupported(config) {\r\n        return browser.supportsInsertableStreams()\r\n            && OlmAdapter.isSupported()\r\n            && !(config.testing && config.testing.disableE2EE);\r\n    }\r\n\r\n    /**\r\n     * Indicates whether E2EE is currently enabled or not.\r\n     *\r\n     * @returns {boolean}\r\n     */\r\n    isEnabled() {\r\n        return this._enabled;\r\n    }\r\n\r\n    /**\r\n     * Enables / disables End-To-End encryption.\r\n     *\r\n     * @param {boolean} enabled - whether E2EE should be enabled or not.\r\n     * @returns {void}\r\n     */\r\n    async setEnabled(enabled) {\r\n        if (enabled === this._enabled) {\r\n            return;\r\n        }\r\n\r\n        this._enabling && await this._enabling;\r\n\r\n        this._enabling = new Deferred();\r\n\r\n        this._enabled = enabled;\r\n\r\n        if (enabled) {\r\n            await this._olmAdapter.initSessions();\r\n        } else {\r\n            for (const participant of this.conference.getParticipants()) {\r\n                this._e2eeCtx.cleanup(participant.getId());\r\n            }\r\n            this._olmAdapter.clearAllParticipantsSessions();\r\n        }\r\n\r\n        this.conference.setLocalParticipantProperty('e2ee.enabled', enabled);\r\n\r\n        this.conference._restartMediaSessions();\r\n\r\n        // Generate a random key in case we are enabling.\r\n        this._key = enabled ? this._generateKey() : false;\r\n\r\n        // Send it to others using the E2EE olm channel.\r\n        const index = await this._olmAdapter.updateKey(this._key);\r\n\r\n        // Set our key so we begin encrypting.\r\n        this._e2eeCtx.setKey(this.conference.myUserId(), this._key, index);\r\n\r\n        this._enabling.resolve();\r\n    }\r\n\r\n    /**\r\n     * Generates a new 256 bit random key.\r\n     *\r\n     * @returns {Uint8Array}\r\n     * @private\r\n     */\r\n    _generateKey() {\r\n        return window.crypto.getRandomValues(new Uint8Array(32));\r\n    }\r\n\r\n    /**\r\n     * Setup E2EE on the new track that has been added to the conference, apply it on all the open peerconnections.\r\n     * @param {JitsiLocalTrack} track - the new track that's being added to the conference.\r\n     * @private\r\n     */\r\n    _onLocalTrackAdded(track) {\r\n        for (const session of this.conference._getMediaSessions()) {\r\n            this._setupSenderE2EEForTrack(session, track);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Setups E2E encryption for the new session.\r\n     * @param {JingleSessionPC} session - the new media session.\r\n     * @private\r\n     */\r\n    _onMediaSessionStarted(session) {\r\n        const localTracks = this.conference.getLocalTracks();\r\n\r\n        for (const track of localTracks) {\r\n            this._setupSenderE2EEForTrack(session, track);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Publushes our own Olmn id key in presence.\r\n     * @private\r\n     */\r\n    _onOlmIdKeyReady(idKey) {\r\n        logger.debug(`Olm id key ready: ${idKey}`);\r\n\r\n        // Publish it in presence.\r\n        this.conference.setLocalParticipantProperty('e2ee.idKey', idKey);\r\n    }\r\n\r\n    /**\r\n     * Advances (using ratcheting) the current key when a new participant joins the conference.\r\n     * @private\r\n     */\r\n    _onParticipantJoined() {\r\n        if (this._conferenceJoined && this._enabled) {\r\n            this._ratchetKey();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Rotates the current key when a participant leaves the conference.\r\n     * @private\r\n     */\r\n    _onParticipantLeft(id) {\r\n        this._e2eeCtx.cleanup(id);\r\n\r\n        if (this._enabled) {\r\n            this._rotateKey();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Event posted when the E2EE signalling channel has been established with the given participant.\r\n     * @private\r\n     */\r\n    _onParticipantE2EEChannelReady(id) {\r\n        logger.debug(`E2EE channel with participant ${id} is ready`);\r\n    }\r\n\r\n    /**\r\n     * Handles an update in a participant's key.\r\n     *\r\n     * @param {string} id - The participant ID.\r\n     * @param {Uint8Array | boolean} key - The new key for the participant.\r\n     * @param {Number} index - The new key's index.\r\n     * @private\r\n     */\r\n    _onParticipantKeyUpdated(id, key, index) {\r\n        logger.debug(`Participant ${id} updated their key`);\r\n\r\n        this._e2eeCtx.setKey(id, key, index);\r\n    }\r\n\r\n    /**\r\n     * Handles an update in a participant's presence property.\r\n     *\r\n     * @param {JitsiParticipant} participant - The participant.\r\n     * @param {string} name - The name of the property that changed.\r\n     * @param {*} oldValue - The property's previous value.\r\n     * @param {*} newValue - The property's new value.\r\n     * @private\r\n     */\r\n    async _onParticipantPropertyChanged(participant, name, oldValue, newValue) {\r\n        switch (name) {\r\n        case 'e2ee.idKey':\r\n            logger.debug(`Participant ${participant.getId()} updated their id key: ${newValue}`);\r\n            break;\r\n        case 'e2ee.enabled':\r\n            if (!newValue && this._enabled) {\r\n                this._olmAdapter.clearParticipantSession(participant);\r\n\r\n                this._rotateKey();\r\n            }\r\n            break;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Advances the current key by using ratcheting.\r\n     *\r\n     * @private\r\n     */\r\n    async _ratchetKeyImpl() {\r\n        logger.debug('Ratchetting key');\r\n\r\n        const material = await importKey(this._key);\r\n        const newKey = await ratchet(material);\r\n\r\n        this._key = new Uint8Array(newKey);\r\n\r\n        const index = this._olmAdapter.updateCurrentKey(this._key);\r\n\r\n        this._e2eeCtx.setKey(this.conference.myUserId(), this._key, index);\r\n    }\r\n\r\n    /**\r\n     * Rotates the local key. Rotating the key implies creating a new one, then distributing it\r\n     * to all participants and once they all received it, start using it.\r\n     *\r\n     * @private\r\n     */\r\n    async _rotateKeyImpl() {\r\n        logger.debug('Rotating key');\r\n\r\n        this._key = this._generateKey();\r\n        const index = await this._olmAdapter.updateKey(this._key);\r\n\r\n        this._e2eeCtx.setKey(this.conference.myUserId(), this._key, index);\r\n    }\r\n\r\n    /**\r\n     * Setup E2EE for the receiving side.\r\n     *\r\n     * @private\r\n     */\r\n    _setupReceiverE2EEForTrack(tpc, track) {\r\n        if (!this._enabled) {\r\n            return;\r\n        }\r\n\r\n        const receiver = tpc.findReceiverForTrack(track.track);\r\n\r\n        if (receiver) {\r\n            this._e2eeCtx.handleReceiver(receiver, track.getType(), track.getParticipantId());\r\n        } else {\r\n            logger.warn(`Could not handle E2EE for ${track}: receiver not found in: ${tpc}`);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Setup E2EE for the sending side.\r\n     *\r\n     * @param {JingleSessionPC} session - the session which sends the media produced by the track.\r\n     * @param {JitsiLocalTrack} track - the local track for which e2e encoder will be configured.\r\n     * @private\r\n     */\r\n    _setupSenderE2EEForTrack(session, track) {\r\n        if (!this._enabled) {\r\n            return;\r\n        }\r\n\r\n        const pc = session.peerconnection;\r\n        const sender = pc && pc.findSenderForTrack(track.track);\r\n\r\n        if (sender) {\r\n            this._e2eeCtx.handleSender(sender, track.getType(), track.getParticipantId());\r\n        } else {\r\n            logger.warn(`Could not handle E2EE for ${track}: sender not found in ${pc}`);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Setup E2EE on the sender that is created for the unmuted local video track.\r\n     * @param {JitsiLocalTrack} track - the track for which muted status has changed.\r\n     * @private\r\n     */\r\n    _trackMuteChanged(track) {\r\n        if (browser.doesVideoMuteByStreamRemove() && track.isLocal() && track.isVideoTrack() && !track.isMuted()) {\r\n            for (const session of this.conference._getMediaSessions()) {\r\n                this._setupSenderE2EEForTrack(session, track);\r\n            }\r\n        }\r\n    }\r\n}\r\n","/* global __filename, $ */\r\n\r\nimport { getLogger } from 'jitsi-meet-logger';\r\nimport { $iq, Strophe } from 'strophe.js';\r\n\r\nimport * as CodecMimeType from '../../service/RTC/CodecMimeType';\r\nimport MediaDirection from '../../service/RTC/MediaDirection';\r\nimport {\r\n    ICE_DURATION,\r\n    ICE_STATE_CHANGED\r\n} from '../../service/statistics/AnalyticsEvents';\r\nimport XMPPEvents from '../../service/xmpp/XMPPEvents';\r\nimport { SS_DEFAULT_FRAME_RATE } from '../RTC/ScreenObtainer';\r\nimport SDP from '../sdp/SDP';\r\nimport SDPDiffer from '../sdp/SDPDiffer';\r\nimport SDPUtil from '../sdp/SDPUtil';\r\nimport Statistics from '../statistics/statistics';\r\nimport AsyncQueue from '../util/AsyncQueue';\r\nimport GlobalOnErrorHandler from '../util/GlobalOnErrorHandler';\r\nimport { integerHash } from '../util/StringUtils';\r\n\r\nimport browser from './../browser';\r\nimport JingleSession from './JingleSession';\r\nimport * as JingleSessionState from './JingleSessionState';\r\nimport MediaSessionEvents from './MediaSessionEvents';\r\nimport SignalingLayerImpl from './SignalingLayerImpl';\r\nimport XmppConnection from './XmppConnection';\r\n\r\nconst logger = getLogger(__filename);\r\n\r\n/**\r\n * Constant tells how long we're going to wait for IQ response, before timeout\r\n * error is  triggered.\r\n * @type {number}\r\n */\r\nconst IQ_TIMEOUT = 10000;\r\n\r\n/*\r\n * The default number of samples (per stat) to keep when webrtc stats gathering\r\n * is enabled in TraceablePeerConnection.\r\n */\r\nconst DEFAULT_MAX_STATS = 300;\r\n\r\n/**\r\n * The time duration for which the client keeps gathering ICE candidates to be sent out in a single IQ.\r\n * @type {number} timeout in ms.\r\n */\r\nconst ICE_CAND_GATHERING_TIMEOUT = 150;\r\n\r\n/**\r\n * @typedef {Object} JingleSessionPCOptions\r\n * @property {Object} abTesting - A/B testing related options (ask George).\r\n * @property {boolean} abTesting.enableSuspendVideoTest - enables the suspend\r\n * video test ?(ask George).\r\n * @property {boolean} disableH264 - Described in the config.js[1].\r\n * @property {boolean} disableRtx - Described in the config.js[1].\r\n * @property {boolean} disableSimulcast - Described in the config.js[1].\r\n * @property {boolean} enableInsertableStreams - Set to true when the insertable streams constraints is to be enabled\r\n * on the PeerConnection.\r\n * @property {boolean} enableLayerSuspension - Described in the config.js[1].\r\n * @property {boolean} failICE - it's an option used in the tests. Set to\r\n * <tt>true</tt> to block any real candidates and make the ICE fail.\r\n * @property {boolean} gatherStats - Described in the config.js[1].\r\n * @property {object} p2p - Peer to peer related options (FIXME those could be\r\n * fetched from config.p2p on the upper level).\r\n * @property {boolean} preferH264 - Described in the config.js[1].\r\n * @property {Object} testing - Testing and/or experimental options.\r\n * @property {boolean} webrtcIceUdpDisable - Described in the config.js[1].\r\n * @property {boolean} webrtcIceTcpDisable - Described in the config.js[1].\r\n *\r\n * [1]: https://github.com/jitsi/jitsi-meet/blob/master/config.js\r\n */\r\n/**\r\n *\r\n */\r\nexport default class JingleSessionPC extends JingleSession {\r\n    /**\r\n     * Parses 'senders' attribute of the video content.\r\n     * @param {jQuery} jingleContents\r\n     * @return {string|null} one of the values of content \"senders\" attribute\r\n     * defined by Jingle. If there is no \"senders\" attribute or if the value is\r\n     * invalid then <tt>null</tt> will be returned.\r\n     * @private\r\n     */\r\n    static parseVideoSenders(jingleContents) {\r\n        const videoContents = jingleContents.find('>content[name=\"video\"]');\r\n\r\n        if (videoContents.length) {\r\n            const senders = videoContents[0].getAttribute('senders');\r\n\r\n            if (senders === 'both'\r\n                || senders === 'initiator'\r\n                || senders === 'responder'\r\n                || senders === 'none') {\r\n                return senders;\r\n            }\r\n        }\r\n\r\n        return null;\r\n    }\r\n\r\n    /**\r\n     * Parses the video max frame height value out of the 'content-modify' IQ.\r\n     *\r\n     * @param {jQuery} jingleContents - A jQuery selector pointing to the '>jingle' element.\r\n     * @returns {Number|null}\r\n     */\r\n    static parseMaxFrameHeight(jingleContents) {\r\n        const maxFrameHeightSel = jingleContents.find('>content[name=\"video\"]>max-frame-height');\r\n\r\n        return maxFrameHeightSel.length ? Number(maxFrameHeightSel.text()) : null;\r\n    }\r\n\r\n    /* eslint-disable max-params */\r\n\r\n    /**\r\n     * Creates new <tt>JingleSessionPC</tt>\r\n     * @param {string} sid the Jingle Session ID - random string which identifies the session\r\n     * @param {string} localJid our JID\r\n     * @param {string} remoteJid remote peer JID\r\n     * @param {XmppConnection} connection - The XMPP connection instance.\r\n     * @param mediaConstraints the media constraints object passed to createOffer/Answer, as defined\r\n     * by the WebRTC standard\r\n     * @param iceConfig the ICE servers config object as defined by the WebRTC standard.\r\n     * @param {boolean} isP2P indicates whether this instance is meant to be used in a direct, peer to\r\n     * peer connection or <tt>false</tt> if it's a JVB connection.\r\n     * @param {boolean} isInitiator indicates if it will be the side which initiates the session.\r\n     * @constructor\r\n     *\r\n     * @implements {SignalingLayer}\r\n     */\r\n    constructor(\r\n            sid,\r\n            localJid,\r\n            remoteJid,\r\n            connection,\r\n            mediaConstraints,\r\n            iceConfig,\r\n            isP2P,\r\n            isInitiator) {\r\n        super(\r\n            sid,\r\n            localJid,\r\n            remoteJid, connection, mediaConstraints, iceConfig, isInitiator);\r\n\r\n        /**\r\n         * The bridge session's identifier. One Jingle session can during\r\n         * it's lifetime participate in multiple bridge sessions managed by\r\n         * Jicofo. A new bridge session is started whenever Jicofo sends\r\n         * 'session-initiate' or 'transport-replace'.\r\n         *\r\n         * @type {?string}\r\n         * @private\r\n         */\r\n        this._bridgeSessionId = null;\r\n\r\n        /**\r\n         * The oldest SDP passed to {@link notifyMySSRCUpdate} while the XMPP connection was offline that will be\r\n         * used to update Jicofo once the XMPP connection goes back online.\r\n         * @type {SDP|undefined}\r\n         * @private\r\n         */\r\n        this._cachedOldLocalSdp = undefined;\r\n\r\n        /**\r\n         * The latest SDP passed to {@link notifyMySSRCUpdate} while the XMPP connection was offline that will be\r\n         * used to update Jicofo once the XMPP connection goes back online.\r\n         * @type {SDP|undefined}\r\n         * @private\r\n         */\r\n        this._cachedNewLocalSdp = undefined;\r\n\r\n        /**\r\n         * Stores result of {@link window.performance.now()} at the time when\r\n         * ICE enters 'checking' state.\r\n         * @type {number|null} null if no value has been stored yet\r\n         * @private\r\n         */\r\n        this._iceCheckingStartedTimestamp = null;\r\n\r\n        /**\r\n         * Stores result of {@link window.performance.now()} at the time when\r\n         * first ICE candidate is spawned by the peerconnection to mark when\r\n         * ICE gathering started. That's, because ICE gathering state changed\r\n         * events are not supported by most of the browsers, so we try something\r\n         * that will work everywhere. It may not be as accurate, but given that\r\n         * 'host' candidate usually comes first, the delay should be minimal.\r\n         * @type {number|null} null if no value has been stored yet\r\n         * @private\r\n         */\r\n        this._gatheringStartedTimestamp = null;\r\n\r\n        /**\r\n         * Local preference for the receive video max frame height.\r\n         *\r\n         * @type {Number|undefined}\r\n         */\r\n        this.localRecvMaxFrameHeight = undefined;\r\n\r\n        /**\r\n         * Indicates whether or not this session is willing to send/receive\r\n         * video media. When set to <tt>false</tt> the underlying peer\r\n         * connection will disable local video transfer and the remote peer will\r\n         * be will be asked to stop sending video via 'content-modify' IQ\r\n         * (the senders attribute of video contents will be adjusted\r\n         * accordingly). Note that this notification is sent only in P2P\r\n         * session, because Jicofo does not support it yet. Obviously when\r\n         * the value is changed from <tt>false</tt> to <tt>true</tt> another\r\n         * notification will be sent to resume video transfer on the remote\r\n         * side.\r\n         * @type {boolean}\r\n         * @private\r\n         */\r\n        this._localVideoActive = true;\r\n\r\n        /**\r\n         * Indicates whether or not the remote peer has video transfer active.\r\n         * When set to <tt>true</tt> it means that remote peer is neither\r\n         * sending nor willing to receive video. In such case we'll ask\r\n         * our peerconnection to stop sending video by calling\r\n         * {@link TraceablePeerConnection.setVideoTransferActive} with\r\n         * <tt>false</tt>.\r\n         * @type {boolean}\r\n         * @private\r\n         */\r\n        this._remoteVideoActive = true;\r\n\r\n        /**\r\n         * Marks that ICE gathering duration has been reported already. That\r\n         * prevents reporting it again, after eventual 'transport-replace' (JVB\r\n         * conference migration/ICE restart).\r\n         * @type {boolean}\r\n         * @private\r\n         */\r\n        this._gatheringReported = false;\r\n\r\n        this.lasticecandidate = false;\r\n        this.closed = false;\r\n\r\n        /**\r\n         * Indicates whether or not this <tt>JingleSessionPC</tt> is used in\r\n         * a peer to peer type of session.\r\n         * @type {boolean} <tt>true</tt> if it's a peer to peer\r\n         * session or <tt>false</tt> if it's a JVB session\r\n         */\r\n        this.isP2P = isP2P;\r\n\r\n        /**\r\n         * Remote preference for the receive video max frame height.\r\n         *\r\n         * @type {Number|undefined}\r\n         */\r\n        this.remoteRecvMaxFrameHeight = undefined;\r\n\r\n        /**\r\n         * The signaling layer implementation.\r\n         * @type {SignalingLayerImpl}\r\n         */\r\n        this.signalingLayer = new SignalingLayerImpl();\r\n\r\n        /**\r\n         * The queue used to serialize operations done on the peerconnection.\r\n         *\r\n         * @type {AsyncQueue}\r\n         */\r\n        this.modificationQueue = new AsyncQueue();\r\n\r\n        /**\r\n         * Flag used to guarantee that the connection established event is\r\n         * triggered just once.\r\n         * @type {boolean}\r\n         */\r\n        this.wasConnected = false;\r\n\r\n        /**\r\n         * Keeps track of how long (in ms) it took from ICE start to ICE\r\n         * connect.\r\n         *\r\n         * @type {number}\r\n         */\r\n        this.establishmentDuration = undefined;\r\n\r\n        this._xmppListeners = [];\r\n        this._xmppListeners.push(\r\n            connection.addEventListener(\r\n                XmppConnection.Events.CONN_STATUS_CHANGED,\r\n                this.onXmppStatusChanged.bind(this))\r\n        );\r\n\r\n        this._removeSenderVideoConstraintsChangeListener = undefined;\r\n    }\r\n\r\n    /* eslint-enable max-params */\r\n\r\n    /**\r\n     * Checks whether or not this session instance is still operational.\r\n     * @private\r\n     * @returns {boolean} {@code true} if operation or {@code false} otherwise.\r\n     */\r\n    _assertNotEnded() {\r\n        return this.state !== JingleSessionState.ENDED;\r\n    }\r\n\r\n    /**\r\n     * @inheritDoc\r\n     * @param {JingleSessionPCOptions} options  - a set of config options.\r\n     */\r\n    doInitialize(options) {\r\n        this.failICE = Boolean(options.failICE);\r\n        this.lasticecandidate = false;\r\n        this.options = options;\r\n\r\n        /**\r\n         * {@code true} if reconnect is in progress.\r\n         * @type {boolean}\r\n         */\r\n        this.isReconnect = false;\r\n\r\n        /**\r\n         * Set to {@code true} if the connection was ever stable\r\n         * @type {boolean}\r\n         */\r\n        this.wasstable = false;\r\n        this.webrtcIceUdpDisable = Boolean(options.webrtcIceUdpDisable);\r\n        this.webrtcIceTcpDisable = Boolean(options.webrtcIceTcpDisable);\r\n\r\n        const pcOptions = { disableRtx: options.disableRtx };\r\n\r\n        if (options.gatherStats) {\r\n            pcOptions.maxstats = DEFAULT_MAX_STATS;\r\n        }\r\n        pcOptions.capScreenshareBitrate = false;\r\n        pcOptions.enableInsertableStreams = options.enableInsertableStreams;\r\n        pcOptions.videoQuality = options.videoQuality;\r\n        pcOptions.forceTurnRelay = options.forceTurnRelay;\r\n        pcOptions.audioQuality = options.audioQuality;\r\n        pcOptions.usesUnifiedPlan = this.usesUnifiedPlan\r\n            = browser.supportsUnifiedPlan()\r\n                && (browser.isFirefox()\r\n                    || browser.isWebKitBased()\r\n                    || (!this.isP2P && browser.isChromiumBased() && options.enableUnifiedOnChrome));\r\n\r\n        if (this.isP2P) {\r\n            // simulcast needs to be disabled for P2P (121) calls\r\n            pcOptions.disableSimulcast = true;\r\n            const abtestSuspendVideo = this._abtestSuspendVideoEnabled(options);\r\n\r\n            if (typeof abtestSuspendVideo !== 'undefined') {\r\n                pcOptions.abtestSuspendVideo = abtestSuspendVideo;\r\n            }\r\n        } else {\r\n            // H264 does not support simulcast, so it needs to be disabled.\r\n            pcOptions.disableSimulcast\r\n                = options.disableSimulcast\r\n                    || (options.preferH264 && !options.disableH264)\r\n                    || (options.videoQuality && options.videoQuality.preferredCodec === CodecMimeType.H264);\r\n\r\n            // Disable simulcast for low fps screenshare and enable it for high fps screenshare.\r\n            // testing.capScreenshareBitrate config.js setting has now been deprecated.\r\n            pcOptions.capScreenshareBitrate = pcOptions.disableSimulcast\r\n                || !(typeof options.desktopSharingFrameRate?.max === 'number'\r\n                    && options.desktopSharingFrameRate?.max > SS_DEFAULT_FRAME_RATE);\r\n\r\n            // add the capScreenshareBitrate to the permanent properties so that it's included with every event that we\r\n            // send to the analytics backend.\r\n            Statistics.analytics.addPermanentProperties({ capScreenshareBitrate: pcOptions.capScreenshareBitrate });\r\n        }\r\n\r\n        if (options.startSilent) {\r\n            pcOptions.startSilent = true;\r\n        }\r\n\r\n        this.peerconnection\r\n            = this.rtc.createPeerConnection(\r\n                    this.signalingLayer,\r\n                    this.iceConfig,\r\n                    this.isP2P,\r\n                    pcOptions);\r\n\r\n        this.peerconnection.onicecandidate = ev => {\r\n            if (!ev) {\r\n                // There was an incomplete check for ev before which left\r\n                // the last line of the function unprotected from a potential\r\n                // throw of an exception. Consequently, it may be argued that\r\n                // the check is unnecessary. Anyway, I'm leaving it and making\r\n                // the check complete.\r\n                return;\r\n            }\r\n\r\n            // XXX this is broken, candidate is not parsed.\r\n            const candidate = ev.candidate;\r\n            const now = window.performance.now();\r\n\r\n            if (candidate) {\r\n                if (this._gatheringStartedTimestamp === null) {\r\n                    this._gatheringStartedTimestamp = now;\r\n                }\r\n\r\n                // Discard candidates of disabled protocols.\r\n                let protocol = candidate.protocol;\r\n\r\n                if (typeof protocol === 'string') {\r\n                    protocol = protocol.toLowerCase();\r\n                    if (protocol === 'tcp' || protocol === 'ssltcp') {\r\n                        if (this.webrtcIceTcpDisable) {\r\n                            return;\r\n                        }\r\n                    } else if (protocol === 'udp') {\r\n                        if (this.webrtcIceUdpDisable) {\r\n                            return;\r\n                        }\r\n                    }\r\n                }\r\n            } else if (!this._gatheringReported) {\r\n                // End of gathering\r\n                Statistics.sendAnalytics(\r\n                    ICE_DURATION,\r\n                    {\r\n                        phase: 'gathering',\r\n                        value: now - this._gatheringStartedTimestamp,\r\n                        p2p: this.isP2P,\r\n                        initiator: this.isInitiator\r\n                    });\r\n                this._gatheringReported = true;\r\n            }\r\n            this.sendIceCandidate(candidate);\r\n        };\r\n\r\n        // Note there is a change in the spec about closed:\r\n        // This value moved into the RTCPeerConnectionState enum in\r\n        // the May 13, 2016 draft of the specification, as it reflects the state\r\n        // of the RTCPeerConnection, not the signaling connection. You now\r\n        // detect a closed connection by checking for connectionState to be\r\n        // \"closed\" instead.\r\n        // I suppose at some point this will be moved to onconnectionstatechange\r\n        this.peerconnection.onsignalingstatechange = () => {\r\n            if (this.peerconnection.signalingState === 'stable') {\r\n                this.wasstable = true;\r\n            } else if (this.peerconnection.signalingState === 'closed'\r\n                || this.peerconnection.connectionState === 'closed') {\r\n                this.room.eventEmitter.emit(XMPPEvents.SUSPEND_DETECTED, this);\r\n            }\r\n        };\r\n\r\n        /**\r\n         * The oniceconnectionstatechange event handler contains the code to\r\n         * execute when the iceconnectionstatechange event, of type Event,\r\n         * is received by this RTCPeerConnection. Such an event is sent when\r\n         * the value of RTCPeerConnection.iceConnectionState changes.\r\n         */\r\n        this.peerconnection.oniceconnectionstatechange = () => {\r\n            const now = window.performance.now();\r\n            let isStable = false;\r\n\r\n            if (!this.isP2P) {\r\n                this.room.connectionTimes[\r\n                    `ice.state.${this.peerconnection.iceConnectionState}`]\r\n                    = now;\r\n            }\r\n            logger.log(`(TIME) ICE ${this.peerconnection.iceConnectionState} ${this.isP2P ? 'P2P' : 'JVB'}:\\t`, now);\r\n\r\n            Statistics.sendAnalytics(\r\n                ICE_STATE_CHANGED,\r\n                {\r\n                    p2p: this.isP2P,\r\n                    state: this.peerconnection.iceConnectionState,\r\n                    'signaling_state': this.peerconnection.signalingState,\r\n                    reconnect: this.isReconnect,\r\n                    value: now\r\n                });\r\n\r\n            this.room.eventEmitter.emit(\r\n                XMPPEvents.ICE_CONNECTION_STATE_CHANGED,\r\n                this,\r\n                this.peerconnection.iceConnectionState);\r\n            switch (this.peerconnection.iceConnectionState) {\r\n            case 'checking':\r\n                this._iceCheckingStartedTimestamp = now;\r\n                break;\r\n            case 'connected':\r\n                // Informs interested parties that the connection has been restored. This includes the case when\r\n                // media connection to the bridge has been restored after an ICE failure by using session-terminate.\r\n                if (this.peerconnection.signalingState === 'stable') {\r\n                    isStable = true;\r\n                    const usesTerminateForRestart = !this.options.enableIceRestart\r\n                        && this.room.supportsRestartByTerminate();\r\n\r\n                    if (this.isReconnect || usesTerminateForRestart) {\r\n                        this.room.eventEmitter.emit(\r\n                            XMPPEvents.CONNECTION_RESTORED, this);\r\n                    }\r\n                }\r\n\r\n                // Add a workaround for an issue on chrome in Unified plan when the local endpoint is the offerer.\r\n                // The 'signalingstatechange' event for 'stable' is handled after the 'iceconnectionstatechange' event\r\n                // for 'completed' is handled by the client. This prevents the client from firing a\r\n                // CONNECTION_ESTABLISHED event for the p2p session. As a result, the offerer continues to stay on the\r\n                // jvb connection while the remote peer switches to the p2p connection breaking the media flow between\r\n                // the endpoints.\r\n                // TODO - file a chromium bug and add the information here.\r\n                if (!this.wasConnected\r\n                    && (this.wasstable\r\n                        || isStable\r\n                        || (this.usesUnifiedPlan && this.isInitiator && browser.isChromiumBased()))) {\r\n\r\n                    Statistics.sendAnalytics(\r\n                        ICE_DURATION,\r\n                        {\r\n                            phase: 'checking',\r\n                            value: now - this._iceCheckingStartedTimestamp,\r\n                            p2p: this.isP2P,\r\n                            initiator: this.isInitiator\r\n                        });\r\n\r\n                    // Switch between ICE gathering and ICE checking whichever\r\n                    // started first (scenarios are different for initiator\r\n                    // vs responder)\r\n                    const iceStarted\r\n                        = Math.min(\r\n                            this._iceCheckingStartedTimestamp,\r\n                            this._gatheringStartedTimestamp);\r\n\r\n                    this.establishmentDuration = now - iceStarted;\r\n\r\n                    Statistics.sendAnalytics(\r\n                        ICE_DURATION,\r\n                        {\r\n                            phase: 'establishment',\r\n                            value: this.establishmentDuration,\r\n                            p2p: this.isP2P,\r\n                            initiator: this.isInitiator\r\n                        });\r\n\r\n                    this.wasConnected = true;\r\n                    this.room.eventEmitter.emit(\r\n                        XMPPEvents.CONNECTION_ESTABLISHED, this);\r\n                }\r\n                this.isReconnect = false;\r\n                break;\r\n            case 'disconnected':\r\n                this.isReconnect = true;\r\n\r\n                // Informs interested parties that the connection has been\r\n                // interrupted.\r\n                if (this.wasstable) {\r\n                    this.room.eventEmitter.emit(\r\n                        XMPPEvents.CONNECTION_INTERRUPTED, this);\r\n                }\r\n                break;\r\n            case 'failed':\r\n                this.room.eventEmitter.emit(\r\n                    XMPPEvents.CONNECTION_ICE_FAILED, this);\r\n                break;\r\n            }\r\n        };\r\n\r\n        /**\r\n         * The negotiationneeded event is fired whenever we shake the media on the\r\n         * RTCPeerConnection object.\r\n         */\r\n        this.peerconnection.onnegotiationneeded = () => {\r\n            const state = this.peerconnection.signalingState;\r\n            const remoteDescription = this.peerconnection.remoteDescription;\r\n\r\n            if (this.usesUnifiedPlan && state === 'stable'\r\n                && remoteDescription && typeof remoteDescription.sdp === 'string') {\r\n                logger.debug(`${this} onnegotiationneeded fired on ${this.peerconnection} in state: ${state}`);\r\n                const workFunction = finishedCallback => {\r\n                    const oldSdp = new SDP(this.peerconnection.localDescription.sdp);\r\n\r\n                    this._renegotiate()\r\n                        .then(() => {\r\n                            const newSdp = new SDP(this.peerconnection.localDescription.sdp);\r\n\r\n                            this.notifyMySSRCUpdate(oldSdp, newSdp);\r\n                            finishedCallback();\r\n                        },\r\n                        finishedCallback /* will be called with en error */);\r\n                };\r\n\r\n                this.modificationQueue.push(\r\n                    workFunction,\r\n                    error => {\r\n                        if (error) {\r\n                            logger.error(`${this} onnegotiationneeded error`, error);\r\n                        } else {\r\n                            logger.debug(`${this} onnegotiationneeded executed - OK`);\r\n                        }\r\n                    });\r\n            }\r\n        };\r\n\r\n        // The signaling layer will bind it's listeners at this point\r\n        this.signalingLayer.setChatRoom(this.room);\r\n    }\r\n\r\n    /**\r\n     * Remote preference for receive video max frame height.\r\n     *\r\n     * @returns {Number|undefined}\r\n     */\r\n    getRemoteRecvMaxFrameHeight() {\r\n        if (this.isP2P) {\r\n            return this.remoteRecvMaxFrameHeight;\r\n        }\r\n\r\n        return undefined;\r\n    }\r\n\r\n    /**\r\n     * Sends given candidate in Jingle 'transport-info' message.\r\n     * @param {RTCIceCandidate} candidate the WebRTC ICE candidate instance\r\n     * @private\r\n     */\r\n    sendIceCandidate(candidate) {\r\n        const localSDP = new SDP(this.peerconnection.localDescription.sdp);\r\n\r\n        if (candidate && candidate.candidate.length && !this.lasticecandidate) {\r\n            const ice = SDPUtil.iceparams(localSDP.media[candidate.sdpMLineIndex], localSDP.session);\r\n            const jcand = SDPUtil.candidateToJingle(candidate.candidate);\r\n\r\n            if (!(ice && jcand)) {\r\n                const errorMesssage = 'failed to get ice && jcand';\r\n\r\n                GlobalOnErrorHandler.callErrorHandler(new Error(errorMesssage));\r\n                logger.error(errorMesssage);\r\n\r\n                return;\r\n            }\r\n            ice.xmlns = 'urn:xmpp:jingle:transports:ice-udp:1';\r\n\r\n            if (this.usedrip) {\r\n                if (this.dripContainer.length === 0) {\r\n                    setTimeout(() => {\r\n                        if (this.dripContainer.length === 0) {\r\n                            return;\r\n                        }\r\n                        this.sendIceCandidates(this.dripContainer);\r\n                        this.dripContainer = [];\r\n                    }, ICE_CAND_GATHERING_TIMEOUT);\r\n                }\r\n                this.dripContainer.push(candidate);\r\n            } else {\r\n                this.sendIceCandidates([ candidate ]);\r\n            }\r\n        } else {\r\n            logger.log(`${this} sendIceCandidate: last candidate`);\r\n\r\n            // FIXME: remember to re-think in ICE-restart\r\n            this.lasticecandidate = true;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Sends given candidates in Jingle 'transport-info' message.\r\n     * @param {Array<RTCIceCandidate>} candidates an array of the WebRTC ICE\r\n     * candidate instances\r\n     * @private\r\n     */\r\n    sendIceCandidates(candidates) {\r\n        if (!this._assertNotEnded('sendIceCandidates')) {\r\n\r\n            return;\r\n        }\r\n\r\n        logger.log(`${this} sendIceCandidates ${JSON.stringify(candidates)}`);\r\n        const cand = $iq({ to: this.remoteJid,\r\n            type: 'set' })\r\n            .c('jingle', { xmlns: 'urn:xmpp:jingle:1',\r\n                action: 'transport-info',\r\n                initiator: this.initiatorJid,\r\n                sid: this.sid });\r\n\r\n        const localSDP = new SDP(this.peerconnection.localDescription.sdp);\r\n\r\n        for (let mid = 0; mid < localSDP.media.length; mid++) {\r\n            const cands = candidates.filter(el => el.sdpMLineIndex === mid);\r\n            const mline\r\n                = SDPUtil.parseMLine(localSDP.media[mid].split('\\r\\n')[0]);\r\n\r\n            if (cands.length > 0) {\r\n                const ice\r\n                    = SDPUtil.iceparams(localSDP.media[mid], localSDP.session);\r\n\r\n                ice.xmlns = 'urn:xmpp:jingle:transports:ice-udp:1';\r\n                cand.c('content', {\r\n                    creator: this.initiatorJid === this.localJid\r\n                        ? 'initiator' : 'responder',\r\n                    name: cands[0].sdpMid ? cands[0].sdpMid : mline.media\r\n                }).c('transport', ice);\r\n                for (let i = 0; i < cands.length; i++) {\r\n                    const candidate\r\n                        = SDPUtil.candidateToJingle(cands[i].candidate);\r\n\r\n                    // Mangle ICE candidate if 'failICE' test option is enabled\r\n\r\n                    if (this.failICE) {\r\n                        candidate.ip = '1.1.1.1';\r\n                    }\r\n                    cand.c('candidate', candidate).up();\r\n                }\r\n\r\n                // add fingerprint\r\n                const fingerprintLine\r\n                    = SDPUtil.findLine(\r\n                        localSDP.media[mid],\r\n                        'a=fingerprint:', localSDP.session);\r\n\r\n                if (fingerprintLine) {\r\n                    const tmp = SDPUtil.parseFingerprint(fingerprintLine);\r\n\r\n                    tmp.required = true;\r\n                    cand.c(\r\n                        'fingerprint',\r\n                        { xmlns: 'urn:xmpp:jingle:apps:dtls:0' })\r\n                        .t(tmp.fingerprint);\r\n                    delete tmp.fingerprint;\r\n                    cand.attrs(tmp);\r\n                    cand.up();\r\n                }\r\n                cand.up(); // transport\r\n                cand.up(); // content\r\n            }\r\n        }\r\n\r\n        // might merge last-candidate notification into this, but it is called\r\n        // a lot later. See webrtc issue #2340\r\n        // logger.log('was this the last candidate', this.lasticecandidate);\r\n        this.connection.sendIQ(\r\n            cand, null, this.newJingleErrorHandler(cand), IQ_TIMEOUT);\r\n    }\r\n\r\n    /**\r\n     * Sends Jingle 'session-info' message which includes custom Jitsi Meet\r\n     * 'ice-state' element with the text value 'failed' to let Jicofo know\r\n     * that the ICE connection has entered the failed state. It can then\r\n     * choose to re-create JVB channels and send 'transport-replace' to\r\n     * retry the connection.\r\n     */\r\n    sendIceFailedNotification() {\r\n        const sessionInfo\r\n            = $iq({\r\n                to: this.remoteJid,\r\n                type: 'set' })\r\n            .c('jingle', { xmlns: 'urn:xmpp:jingle:1',\r\n                action: 'session-info',\r\n                initiator: this.initiatorJid,\r\n                sid: this.sid })\r\n            .c('ice-state', { xmlns: 'http://jitsi.org/protocol/focus' })\r\n            .t('failed')\r\n            .up();\r\n\r\n        this._bridgeSessionId\r\n            && sessionInfo.c(\r\n                'bridge-session', {\r\n                    xmlns: 'http://jitsi.org/protocol/focus',\r\n                    id: this._bridgeSessionId\r\n                });\r\n\r\n        this.connection.sendIQ2(\r\n            sessionInfo, {\r\n                /*\r\n                 * This message will be often sent when there are connectivity\r\n                 * issues, so make it slightly longer than Prosody's default BOSH\r\n                 * inactivity timeout of 60 seconds.\r\n                 */\r\n                timeout: 65\r\n            })\r\n            .catch(this.newJingleErrorHandler(sessionInfo));\r\n    }\r\n\r\n    /**\r\n     * {@inheritDoc}\r\n     */\r\n    addIceCandidates(elem) {\r\n        if (this.peerconnection.signalingState === 'closed') {\r\n            logger.warn(`${this} Ignored add ICE candidate when in closed state`);\r\n\r\n            return;\r\n        }\r\n\r\n        const iceCandidates = [];\r\n\r\n        elem.find('>content>transport>candidate')\r\n            .each((idx, candidate) => {\r\n                let line = SDPUtil.candidateFromJingle(candidate);\r\n\r\n                line = line.replace('\\r\\n', '').replace('a=', '');\r\n\r\n                // FIXME this code does not care to handle\r\n                // non-bundle transport\r\n                const rtcCandidate = new RTCIceCandidate({\r\n                    sdpMLineIndex: 0,\r\n\r\n                    // FF comes up with more complex names like audio-23423,\r\n                    // Given that it works on both Chrome and FF without\r\n                    // providing it, let's leave it like this for the time\r\n                    // being...\r\n                    // sdpMid: 'audio',\r\n                    sdpMid: '',\r\n                    candidate: line\r\n                });\r\n\r\n                iceCandidates.push(rtcCandidate);\r\n            });\r\n\r\n        if (!iceCandidates.length) {\r\n            logger.error(`${this} No ICE candidates to add ?`, elem[0] && elem[0].outerHTML);\r\n\r\n            return;\r\n        }\r\n\r\n        // We want to have this task queued, so that we know it is executed,\r\n        // after the initial sRD/sLD offer/answer cycle was done (based on\r\n        // the assumption that candidates are spawned after the offer/answer\r\n        // and XMPP preserves order).\r\n        const workFunction = finishedCallback => {\r\n            for (const iceCandidate of iceCandidates) {\r\n                this.peerconnection.addIceCandidate(iceCandidate)\r\n                    .then(\r\n                        () => logger.debug(`${this} addIceCandidate ok!`),\r\n                        err => logger.error(`${this} addIceCandidate failed!`, err));\r\n            }\r\n\r\n            finishedCallback();\r\n            logger.debug(`${this} ICE candidates task finished`);\r\n        };\r\n\r\n        logger.debug(`${this} Queued add (${iceCandidates.length}) ICE candidates task`);\r\n        this.modificationQueue.push(workFunction);\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param contents\r\n     */\r\n    readSsrcInfo(contents) {\r\n        const ssrcs\r\n            = $(contents).find(\r\n                '>description>'\r\n                    + 'source[xmlns=\"urn:xmpp:jingle:apps:rtp:ssma:0\"]');\r\n\r\n        ssrcs.each((i, ssrcElement) => {\r\n            const ssrc = Number(ssrcElement.getAttribute('ssrc'));\r\n\r\n            if (this.isP2P) {\r\n                // In P2P all SSRCs are owner by the remote peer\r\n                this.signalingLayer.setSSRCOwner(\r\n                    ssrc, Strophe.getResourceFromJid(this.remoteJid));\r\n            } else {\r\n                $(ssrcElement)\r\n                    .find('>ssrc-info[xmlns=\"http://jitsi.org/jitmeet\"]')\r\n                    .each((i3, ssrcInfoElement) => {\r\n                        const owner = ssrcInfoElement.getAttribute('owner');\r\n\r\n                        if (owner && owner.length) {\r\n                            if (isNaN(ssrc) || ssrc < 0) {\r\n                                logger.warn(`${this} Invalid SSRC ${ssrc} value received for ${owner}`);\r\n                            } else {\r\n                                this.signalingLayer.setSSRCOwner(\r\n                                    ssrc,\r\n                                    Strophe.getResourceFromJid(owner));\r\n                            }\r\n                        }\r\n                    });\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Makes the underlying TraceablePeerConnection generate new SSRC for\r\n     * the recvonly video stream.\r\n     * @deprecated\r\n     */\r\n    generateRecvonlySsrc() {\r\n        if (this.peerconnection) {\r\n            this.peerconnection.generateRecvonlySsrc();\r\n        } else {\r\n            logger.error(`${this} Unable to generate recvonly SSRC - no peerconnection`);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Returns the video codec configured as the preferred codec on the peerconnection.\r\n     */\r\n    getConfiguredVideoCodec() {\r\n        return this.peerconnection.getConfiguredVideoCodec();\r\n    }\r\n\r\n    /* eslint-disable max-params */\r\n    /**\r\n     * Accepts incoming Jingle 'session-initiate' and should send\r\n     * 'session-accept' in result.\r\n     * @param jingleOffer jQuery selector pointing to the jingle element of\r\n     * the offer IQ\r\n     * @param success callback called when we accept incoming session\r\n     * successfully and receive RESULT packet to 'session-accept' sent.\r\n     * @param failure function(error) called if for any reason we fail to accept\r\n     * the incoming offer. 'error' argument can be used to log some details\r\n     * about the error.\r\n     * @param {Array<JitsiLocalTrack>} [localTracks] the optional list of\r\n     * the local tracks that will be added, before the offer/answer cycle\r\n     * executes. We allow the localTracks to optionally be passed in so that\r\n     * the addition of the local tracks and the processing of the initial offer\r\n     * can all be done atomically. We want to make sure that any other\r\n     * operations which originate in the XMPP Jingle messages related with\r\n     * this session to be executed with an assumption that the initial\r\n     * offer/answer cycle has been executed already.\r\n     */\r\n    acceptOffer(jingleOffer, success, failure, localTracks) {\r\n        this.setOfferAnswerCycle(\r\n            jingleOffer,\r\n            () => {\r\n                // FIXME we may not care about RESULT packet for session-accept\r\n                // then we should either call 'success' here immediately or\r\n                // modify sendSessionAccept method to do that\r\n                this.sendSessionAccept(success, failure);\r\n            },\r\n            failure,\r\n            localTracks);\r\n    }\r\n\r\n    /* eslint-enable max-params */\r\n\r\n    /**\r\n     * Creates an offer and sends Jingle 'session-initiate' to the remote peer.\r\n     * @param {Array<JitsiLocalTrack>} localTracks the local tracks that will be\r\n     * added, before the offer/answer cycle executes (for the local track\r\n     * addition to be an atomic operation together with the offer/answer).\r\n     */\r\n    invite(localTracks = []) {\r\n        if (!this.isInitiator) {\r\n            throw new Error('Trying to invite from the responder session');\r\n        }\r\n        const workFunction = finishedCallback => {\r\n            const addTracks = [];\r\n\r\n            for (const localTrack of localTracks) {\r\n                addTracks.push(this.peerconnection.addTrack(localTrack, this.isInitiator));\r\n            }\r\n\r\n            Promise.all(addTracks)\r\n                .then(() => this.peerconnection.createOffer(this.mediaConstraints))\r\n                .then(offerSdp => this.peerconnection.setLocalDescription(offerSdp))\r\n                .then(() => {\r\n                    // NOTE that the offer is obtained from the localDescription getter as it needs to go though\r\n                    // the transformation chain.\r\n                    this.sendSessionInitiate(this.peerconnection.localDescription.sdp);\r\n                })\r\n                .then(() => finishedCallback(), error => finishedCallback(error));\r\n        };\r\n\r\n        logger.debug(`${this} Queued invite task`);\r\n        this.modificationQueue.push(\r\n            workFunction,\r\n            error => {\r\n                if (error) {\r\n                    logger.error(`${this} invite error`, error);\r\n                } else {\r\n                    logger.debug(`${this} invite executed - OK`);\r\n                }\r\n            });\r\n    }\r\n\r\n    /**\r\n     * Sends 'session-initiate' to the remote peer.\r\n     *\r\n     * NOTE this method is synchronous and we're not waiting for the RESULT\r\n     * response which would delay the startup process.\r\n     *\r\n     * @param {string} offerSdp  - The local session description which will be\r\n     * used to generate an offer.\r\n     * @private\r\n     */\r\n    sendSessionInitiate(offerSdp) {\r\n        let init = $iq({\r\n            to: this.remoteJid,\r\n            type: 'set'\r\n        }).c('jingle', {\r\n            xmlns: 'urn:xmpp:jingle:1',\r\n            action: 'session-initiate',\r\n            initiator: this.initiatorJid,\r\n            sid: this.sid\r\n        });\r\n\r\n        new SDP(offerSdp).toJingle(\r\n            init,\r\n            this.isInitiator ? 'initiator' : 'responder');\r\n        init = init.tree();\r\n        logger.info(`${this} Session-initiate: `, init);\r\n        this.connection.sendIQ(init,\r\n            () => {\r\n                logger.info(`${this} Got RESULT for \"session-initiate\"`);\r\n            },\r\n            error => {\r\n                logger.error(`${this} \"session-initiate\" error`, error);\r\n            },\r\n            IQ_TIMEOUT);\r\n    }\r\n\r\n    /**\r\n     * Sets the answer received from the remote peer.\r\n     * @param jingleAnswer\r\n     */\r\n    setAnswer(jingleAnswer) {\r\n        if (!this.isInitiator) {\r\n            throw new Error('Trying to set an answer on the responder session');\r\n        }\r\n        this.setOfferAnswerCycle(\r\n            jingleAnswer,\r\n            () => {\r\n                logger.info(`${this} setAnswer - succeeded`);\r\n            },\r\n            error => {\r\n                logger.error(`${this} setAnswer failed: `, error);\r\n            });\r\n    }\r\n\r\n    /* eslint-disable max-params */\r\n    /**\r\n     * This is a setRemoteDescription/setLocalDescription cycle which starts at\r\n     * converting Strophe Jingle IQ into remote offer SDP. Once converted\r\n     * setRemoteDescription, createAnswer and setLocalDescription calls follow.\r\n     * @param jingleOfferAnswerIq jQuery selector pointing to the jingle element\r\n     *        of the offer (or answer) IQ\r\n     * @param success callback called when sRD/sLD cycle finishes successfully.\r\n     * @param failure callback called with an error object as an argument if we\r\n     *        fail at any point during setRD, createAnswer, setLD.\r\n     * @param {Array<JitsiLocalTrack>} [localTracks] the optional list of\r\n     * the local tracks that will be added, before the offer/answer cycle\r\n     * executes (for the local track addition to be an atomic operation together\r\n     * with the offer/answer).\r\n     */\r\n    setOfferAnswerCycle(jingleOfferAnswerIq, success, failure, localTracks = []) {\r\n        const workFunction = finishedCallback => {\r\n            const addTracks = [];\r\n\r\n            for (const track of localTracks) {\r\n                addTracks.push(this.peerconnection.addTrack(track, this.isInitiator));\r\n            }\r\n\r\n            const newRemoteSdp\r\n                = this._processNewJingleOfferIq(jingleOfferAnswerIq);\r\n            const oldLocalSdp\r\n                = this.peerconnection.localDescription.sdp;\r\n\r\n            const bridgeSession\r\n                = $(jingleOfferAnswerIq)\r\n                    .find('>bridge-session['\r\n                        + 'xmlns=\"http://jitsi.org/protocol/focus\"]');\r\n            const bridgeSessionId = bridgeSession.attr('id');\r\n\r\n            if (bridgeSessionId !== this._bridgeSessionId) {\r\n                this._bridgeSessionId = bridgeSessionId;\r\n            }\r\n\r\n            Promise.all(addTracks)\r\n                .then(() => this._renegotiate(newRemoteSdp.raw))\r\n                .then(() => {\r\n                    if (this.state === JingleSessionState.PENDING) {\r\n                        this.state = JingleSessionState.ACTIVE;\r\n\r\n                        // #1 Sync up video transfer active/inactive only after\r\n                        // the initial O/A cycle. We want to adjust the video\r\n                        // media direction only in the local SDP and the Jingle\r\n                        // contents direction included in the initial\r\n                        // offer/answer is mapped to the remote SDP. Jingle\r\n                        // 'content-modify' IQ is processed in a way that it\r\n                        // will only modify local SDP when remote peer is no\r\n                        // longer interested in receiving video content.\r\n                        // Changing media direction in the remote SDP will mess\r\n                        // up our SDP translation chain (simulcast, video mute,\r\n                        // RTX etc.)\r\n                        //\r\n                        // #2 Sends the max frame height if it was set, before the session-initiate/accept\r\n                        if (this.isP2P\r\n                            && (!this._localVideoActive || this.localRecvMaxFrameHeight)) {\r\n                            this.sendContentModify();\r\n                        }\r\n                    }\r\n\r\n                    // Old local SDP will be available when we're setting answer\r\n                    // for the first time, but not when offer and it's fine\r\n                    // since we're generating an answer now it will contain all\r\n                    // our SSRCs\r\n                    if (oldLocalSdp) {\r\n                        const newLocalSdp\r\n                            = new SDP(this.peerconnection.localDescription.sdp);\r\n\r\n                        this.notifyMySSRCUpdate(\r\n                            new SDP(oldLocalSdp), newLocalSdp);\r\n                    }\r\n                })\r\n                .then(() => finishedCallback(), error => finishedCallback(error));\r\n        };\r\n\r\n        logger.debug(`${this} Queued setOfferAnswerCycle task`);\r\n        this.modificationQueue.push(\r\n            workFunction,\r\n            error => {\r\n                if (error) {\r\n                    logger.error(`${this} setOfferAnswerCycle task failed: ${error}`);\r\n                    failure(error);\r\n                } else {\r\n                    logger.debug(`${this} setOfferAnswerCycle task done`);\r\n                    success();\r\n                }\r\n            });\r\n    }\r\n\r\n    /**\r\n     * Updates the codecs on the peerconnection and initiates a renegotiation for the\r\n     * new codec config to take effect.\r\n     *\r\n     * @param {CodecMimeType} preferred the preferred codec.\r\n     * @param {CodecMimeType} disabled the codec that needs to be disabled.\r\n     */\r\n    setVideoCodecs(preferred = null, disabled = null) {\r\n        const current = this.peerconnection.getConfiguredVideoCodec();\r\n\r\n        if (this._assertNotEnded() && preferred !== current) {\r\n            logger.info(`${this} Switching video codec from ${current} to ${preferred}`);\r\n            this.peerconnection.setVideoCodecs(preferred, disabled);\r\n\r\n            // Initiate a renegotiate for the codec setting to take effect.\r\n            const workFunction = finishedCallback => {\r\n                this._renegotiate().then(\r\n                    () => {\r\n                        logger.debug(`${this} setVideoCodecs task is done`);\r\n\r\n                        return finishedCallback();\r\n                    }, error => {\r\n                        logger.error(`${this} setVideoCodecs task failed: ${error}`);\r\n\r\n                        return finishedCallback(error);\r\n                    });\r\n            };\r\n\r\n            logger.debug(`${this} Queued setVideoCodecs task`);\r\n\r\n            // Queue and execute\r\n            this.modificationQueue.push(workFunction);\r\n        }\r\n    }\r\n\r\n    /* eslint-enable max-params */\r\n\r\n    /**\r\n     * Although it states \"replace transport\" it does accept full Jingle offer\r\n     * which should contain new ICE transport details.\r\n     * @param jingleOfferElem an element Jingle IQ that contains new offer and\r\n     *        transport info.\r\n     * @param success callback called when we succeed to accept new offer.\r\n     * @param failure function(error) called when we fail to accept new offer.\r\n     */\r\n    replaceTransport(jingleOfferElem, success, failure) {\r\n        if (this.options.enableForcedReload) {\r\n            const sdp = new SDP(this.peerconnection.localDescription.sdp);\r\n\r\n            this.sendTransportAccept(sdp, success, failure);\r\n            this.room.eventEmitter.emit(XMPPEvents.CONNECTION_RESTARTED, this);\r\n\r\n            return;\r\n        }\r\n        this.room.eventEmitter.emit(XMPPEvents.ICE_RESTARTING, this);\r\n\r\n        // We need to first reject the 'data' section to have the SCTP stack\r\n        // cleaned up to signal the known data channel is now invalid. After\r\n        // that the original offer is set to have the SCTP connection\r\n        // established with the new bridge.\r\n        const originalOffer = jingleOfferElem.clone();\r\n\r\n        jingleOfferElem\r\n            .find('>content[name=\\'data\\']')\r\n            .attr('senders', 'rejected');\r\n\r\n        // Remove all remote sources in order to reset the client's state\r\n        // for the remote MediaStreams. When a conference is moved to\r\n        // another bridge it will start streaming with a sequence number\r\n        // that is not in sync with the most recently seen by the client.\r\n        // The symptoms include frozen or black video and lots of \"failed to\r\n        // unprotect SRTP packets\" in Chrome logs.\r\n        jingleOfferElem\r\n            .find('>content>description>source')\r\n            .remove();\r\n        jingleOfferElem\r\n            .find('>content>description>ssrc-group')\r\n            .remove();\r\n\r\n        // On the JVB it's not a real ICE restart and all layers are re-initialized from scratch as Jicofo does\r\n        // the restart by re-allocating new channels. Chrome (or WebRTC stack) needs to have the DTLS transport layer\r\n        // reset to start a new handshake with fresh DTLS transport on the bridge. Make it think that the DTLS\r\n        // fingerprint has changed by setting an all zeros key.\r\n        const newFingerprint = jingleOfferElem.find('>content>transport>fingerprint');\r\n\r\n        newFingerprint.attr('hash', 'sha-1');\r\n        newFingerprint.text('00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00');\r\n\r\n        // First set an offer with a rejected 'data' section\r\n        this.setOfferAnswerCycle(\r\n            jingleOfferElem,\r\n            () => {\r\n                // Now set the original offer(with the 'data' section)\r\n                this.setOfferAnswerCycle(\r\n                    originalOffer,\r\n                    () => {\r\n                        const localSDP\r\n                            = new SDP(this.peerconnection.localDescription.sdp);\r\n\r\n                        this.sendTransportAccept(localSDP, success, failure);\r\n\r\n                        this.room.eventEmitter.emit(\r\n                            XMPPEvents.ICE_RESTART_SUCCESS,\r\n                            this,\r\n                            originalOffer);\r\n                    },\r\n                    failure);\r\n            },\r\n            failure\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Sends Jingle 'session-accept' message.\r\n     * @param {function()} success callback called when we receive 'RESULT'\r\n     *        packet for the 'session-accept'\r\n     * @param {function(error)} failure called when we receive an error response\r\n     *        or when the request has timed out.\r\n     * @private\r\n     */\r\n    sendSessionAccept(success, failure) {\r\n        // NOTE: since we're just reading from it, we don't need to be within\r\n        //  the modification queue to access the local description\r\n        const localSDP = new SDP(this.peerconnection.localDescription.sdp);\r\n        let accept = $iq({ to: this.remoteJid,\r\n            type: 'set' })\r\n            .c('jingle', { xmlns: 'urn:xmpp:jingle:1',\r\n                action: 'session-accept',\r\n                initiator: this.initiatorJid,\r\n                responder: this.responderJid,\r\n                sid: this.sid });\r\n\r\n        if (this.webrtcIceTcpDisable) {\r\n            localSDP.removeTcpCandidates = true;\r\n        }\r\n        if (this.webrtcIceUdpDisable) {\r\n            localSDP.removeUdpCandidates = true;\r\n        }\r\n        if (this.failICE) {\r\n            localSDP.failICE = true;\r\n        }\r\n        localSDP.toJingle(\r\n            accept,\r\n            this.initiatorJid === this.localJid ? 'initiator' : 'responder');\r\n\r\n        // Calling tree() to print something useful\r\n        accept = accept.tree();\r\n        logger.info(`${this} Sending session-accept`, accept);\r\n        this.connection.sendIQ(accept,\r\n            success,\r\n            this.newJingleErrorHandler(accept, error => {\r\n                failure(error);\r\n\r\n                // 'session-accept' is a critical timeout and we'll\r\n                // have to restart\r\n                this.room.eventEmitter.emit(\r\n                    XMPPEvents.SESSION_ACCEPT_TIMEOUT, this);\r\n            }),\r\n            IQ_TIMEOUT);\r\n\r\n        // XXX Videobridge needs WebRTC's answer (ICE ufrag and pwd, DTLS\r\n        // fingerprint and setup) ASAP in order to start the connection\r\n        // establishment.\r\n        //\r\n        // FIXME Flushing the connection at this point triggers an issue with\r\n        // BOSH request handling in Prosody on slow connections.\r\n        //\r\n        // The problem is that this request will be quite large and it may take\r\n        // time before it reaches Prosody. In the meantime Strophe may decide\r\n        // to send the next one. And it was observed that a small request with\r\n        // 'transport-info' usually follows this one. It does reach Prosody\r\n        // before the previous one was completely received. 'rid' on the server\r\n        // is increased and Prosody ignores the request with 'session-accept'.\r\n        // It will never reach Jicofo and everything in the request table is\r\n        // lost. Removing the flush does not guarantee it will never happen, but\r\n        // makes it much less likely('transport-info' is bundled with\r\n        // 'session-accept' and any immediate requests).\r\n        //\r\n        // this.connection.flush();\r\n    }\r\n\r\n    /**\r\n     * Will send 'content-modify' IQ in order to ask the remote peer to\r\n     * either stop or resume sending video media or to adjust sender's video constraints.\r\n     * @private\r\n     */\r\n    sendContentModify() {\r\n        const maxFrameHeight = this.localRecvMaxFrameHeight;\r\n        const senders = this._localVideoActive ? 'both' : 'none';\r\n\r\n        let sessionModify\r\n            = $iq({\r\n                to: this.remoteJid,\r\n                type: 'set'\r\n            })\r\n                .c('jingle', {\r\n                    xmlns: 'urn:xmpp:jingle:1',\r\n                    action: 'content-modify',\r\n                    initiator: this.initiatorJid,\r\n                    sid: this.sid\r\n                })\r\n                .c('content', {\r\n                    name: 'video',\r\n                    senders\r\n                });\r\n\r\n        if (typeof maxFrameHeight !== 'undefined') {\r\n            sessionModify = sessionModify\r\n                .c('max-frame-height', { xmlns: 'http://jitsi.org/jitmeet/video' })\r\n                .t(maxFrameHeight);\r\n        }\r\n\r\n        logger.info(`${this} sending content-modify, video senders: ${senders}, max frame height: ${maxFrameHeight}`);\r\n\r\n        this.connection.sendIQ(\r\n            sessionModify,\r\n            null,\r\n            this.newJingleErrorHandler(sessionModify),\r\n            IQ_TIMEOUT);\r\n    }\r\n\r\n    /**\r\n     * Adjust the preference for max video frame height that the local party is willing to receive. Signals\r\n     * the remote party.\r\n     *\r\n     * @param {Number} maxFrameHeight - the new value to set.\r\n     */\r\n    setReceiverVideoConstraint(maxFrameHeight) {\r\n        logger.info(`${this} setReceiverVideoConstraint - max frame height: ${maxFrameHeight}`);\r\n\r\n        this.localRecvMaxFrameHeight = maxFrameHeight;\r\n\r\n        if (this.isP2P) {\r\n            // Tell the remote peer about our receive constraint. If Jingle session is not yet active the state will\r\n            // be synced after offer/answer.\r\n            if (this.state === JingleSessionState.ACTIVE) {\r\n                this.sendContentModify();\r\n            }\r\n        } else {\r\n            this.rtc.setReceiverVideoConstraint(maxFrameHeight);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Sends Jingle 'transport-accept' message which is a response to\r\n     * 'transport-replace'.\r\n     * @param localSDP the 'SDP' object with local session description\r\n     * @param success callback called when we receive 'RESULT' packet for\r\n     *        'transport-replace'\r\n     * @param failure function(error) called when we receive an error response\r\n     *        or when the request has timed out.\r\n     * @private\r\n     */\r\n    sendTransportAccept(localSDP, success, failure) {\r\n        let transportAccept = $iq({ to: this.remoteJid,\r\n            type: 'set' })\r\n            .c('jingle', {\r\n                xmlns: 'urn:xmpp:jingle:1',\r\n                action: 'transport-accept',\r\n                initiator: this.initiatorJid,\r\n                sid: this.sid\r\n            });\r\n\r\n        localSDP.media.forEach((medialines, idx) => {\r\n            const mline = SDPUtil.parseMLine(medialines.split('\\r\\n')[0]);\r\n\r\n            transportAccept.c('content',\r\n                {\r\n                    creator:\r\n                        this.initiatorJid === this.localJid\r\n                            ? 'initiator'\r\n                            : 'responder',\r\n                    name: mline.media\r\n                }\r\n            );\r\n            localSDP.transportToJingle(idx, transportAccept);\r\n            transportAccept.up();\r\n        });\r\n\r\n        // Calling tree() to print something useful to the logger\r\n        transportAccept = transportAccept.tree();\r\n        logger.info(`${this} Sending transport-accept: `, transportAccept);\r\n\r\n        this.connection.sendIQ(transportAccept,\r\n            success,\r\n            this.newJingleErrorHandler(transportAccept, failure),\r\n            IQ_TIMEOUT);\r\n    }\r\n\r\n    /**\r\n     * Sends Jingle 'transport-reject' message which is a response to\r\n     * 'transport-replace'.\r\n     * @param success callback called when we receive 'RESULT' packet for\r\n     *        'transport-replace'\r\n     * @param failure function(error) called when we receive an error response\r\n     *        or when the request has timed out.\r\n     *\r\n     * FIXME method should be marked as private, but there's some spaghetti that\r\n     *       needs to be fixed prior doing that\r\n     */\r\n    sendTransportReject(success, failure) {\r\n        // Send 'transport-reject', so that the focus will\r\n        // know that we've failed\r\n        let transportReject = $iq({ to: this.remoteJid,\r\n            type: 'set' })\r\n            .c('jingle', {\r\n                xmlns: 'urn:xmpp:jingle:1',\r\n                action: 'transport-reject',\r\n                initiator: this.initiatorJid,\r\n                sid: this.sid\r\n            });\r\n\r\n        transportReject = transportReject.tree();\r\n        logger.info(`${this} Sending 'transport-reject'`, transportReject);\r\n\r\n        this.connection.sendIQ(transportReject,\r\n            success,\r\n            this.newJingleErrorHandler(transportReject, failure),\r\n            IQ_TIMEOUT);\r\n    }\r\n\r\n    /**\r\n     * Sets the maximum bitrates on the local video track. Bitrate values from\r\n     * videoQuality settings in config.js will be used for configuring the sender.\r\n     * @returns {Promise<void>} promise that will be resolved when the operation is\r\n     * successful and rejected otherwise.\r\n     */\r\n    setSenderMaxBitrates() {\r\n        if (this._assertNotEnded()) {\r\n            return this.peerconnection.setMaxBitRate();\r\n        }\r\n\r\n        return Promise.resolve();\r\n    }\r\n\r\n    /**\r\n     * Sets the resolution constraint on the local camera track.\r\n     * @param {number} maxFrameHeight - The user preferred max frame height.\r\n     * @returns {Promise} promise that will be resolved when the operation is\r\n     * successful and rejected otherwise.\r\n     */\r\n    setSenderVideoConstraint(maxFrameHeight) {\r\n        if (this._assertNotEnded()) {\r\n            logger.info(`${this} setSenderVideoConstraint: ${maxFrameHeight}`);\r\n\r\n            // RN doesn't support RTCRtpSenders yet, aggresive layer suspension on RN is implemented\r\n            // by changing the media direction in the SDP. This is applicable to jvb sessions only.\r\n            if (!this.isP2P && browser.isReactNative() && typeof maxFrameHeight !== 'undefined') {\r\n                const videoActive = maxFrameHeight > 0;\r\n\r\n                return this.setMediaTransferActive(true, videoActive);\r\n            }\r\n\r\n            return this.peerconnection.setSenderVideoConstraint(maxFrameHeight);\r\n        }\r\n\r\n        return Promise.resolve();\r\n    }\r\n\r\n    /**\r\n     * Sets the degradation preference on the video sender. This setting determines if\r\n     * resolution or framerate will be preferred when bandwidth or cpu is constrained.\r\n     * @returns {Promise<void>} promise that will be resolved when the operation is\r\n     * successful and rejected otherwise.\r\n     */\r\n    setSenderVideoDegradationPreference() {\r\n        if (this._assertNotEnded()) {\r\n            return this.peerconnection.setSenderVideoDegradationPreference();\r\n        }\r\n\r\n        return Promise.resolve();\r\n    }\r\n\r\n    /**\r\n     * @inheritDoc\r\n     */\r\n    terminate(success, failure, options) {\r\n        if (this.state === JingleSessionState.ENDED) {\r\n            return;\r\n        }\r\n\r\n        if (!options || Boolean(options.sendSessionTerminate)) {\r\n            let sessionTerminate\r\n                = $iq({\r\n                    to: this.remoteJid,\r\n                    type: 'set'\r\n                })\r\n                    .c('jingle', {\r\n                        xmlns: 'urn:xmpp:jingle:1',\r\n                        action: 'session-terminate',\r\n                        initiator: this.initiatorJid,\r\n                        sid: this.sid\r\n                    })\r\n                    .c('reason')\r\n                    .c((options && options.reason) || 'success')\r\n                    .up();\r\n\r\n            if (options && options.reasonDescription) {\r\n                sessionTerminate\r\n                    .c('text')\r\n                    .t(options.reasonDescription)\r\n                    .up()\r\n                    .up();\r\n            } else {\r\n                sessionTerminate.up();\r\n            }\r\n\r\n            this._bridgeSessionId\r\n                && sessionTerminate.c(\r\n                    'bridge-session', {\r\n                        xmlns: 'http://jitsi.org/protocol/focus',\r\n                        id: this._bridgeSessionId,\r\n                        restart: options && options.requestRestart === true\r\n                    }).up();\r\n\r\n            // Calling tree() to print something useful\r\n            sessionTerminate = sessionTerminate.tree();\r\n            logger.info(`${this} Sending session-terminate`, sessionTerminate);\r\n            this.connection.sendIQ(\r\n                sessionTerminate,\r\n                success,\r\n                this.newJingleErrorHandler(sessionTerminate, failure),\r\n                IQ_TIMEOUT);\r\n        } else {\r\n            logger.info(`${this} Skipped sending session-terminate`);\r\n        }\r\n\r\n        // this should result in 'onTerminated' being called by strope.jingle.js\r\n        this.connection.jingle.terminate(this.sid);\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param reasonCondition\r\n     * @param reasonText\r\n     */\r\n    onTerminated(reasonCondition, reasonText) {\r\n        // Do something with reason and reasonCondition when we start to care\r\n        // this.reasonCondition = reasonCondition;\r\n        // this.reasonText = reasonText;\r\n        logger.info(`${this} Session terminated`, reasonCondition, reasonText);\r\n\r\n        this._xmppListeners.forEach(removeListener => removeListener());\r\n        this._xmppListeners = [];\r\n\r\n        if (this._removeSenderVideoConstraintsChangeListener) {\r\n            this._removeSenderVideoConstraintsChangeListener();\r\n        }\r\n\r\n        this.close();\r\n    }\r\n\r\n    /**\r\n     * Handles XMPP connection state changes.\r\n     *\r\n     * @param {XmppConnection.Status} status - The new status.\r\n     */\r\n    onXmppStatusChanged(status) {\r\n        if (status === XmppConnection.Status.CONNECTED && this._cachedOldLocalSdp) {\r\n            logger.info(`${this} Sending SSRC update on reconnect`);\r\n            this.notifyMySSRCUpdate(\r\n                this._cachedOldLocalSdp,\r\n                this._cachedNewLocalSdp);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Parse the information from the xml sourceAddElem and translate it\r\n     *  into sdp lines\r\n     * @param {jquery xml element} sourceAddElem the source-add\r\n     *  element from jingle\r\n     * @param {SDP object} currentRemoteSdp the current remote\r\n     *  sdp (as of this new source-add)\r\n     * @returns {list} a list of SDP line strings that should\r\n     *  be added to the remote SDP\r\n     */\r\n    _parseSsrcInfoFromSourceAdd(sourceAddElem, currentRemoteSdp) {\r\n        const addSsrcInfo = [];\r\n\r\n        $(sourceAddElem).each((i1, content) => {\r\n            const name = $(content).attr('name');\r\n            let lines = '';\r\n\r\n            $(content)\r\n                .find('ssrc-group[xmlns=\"urn:xmpp:jingle:apps:rtp:ssma:0\"]')\r\n                .each(function() {\r\n                    // eslint-disable-next-line no-invalid-this\r\n                    const semantics = this.getAttribute('semantics');\r\n                    const ssrcs\r\n                        = $(this) // eslint-disable-line no-invalid-this\r\n                            .find('>source')\r\n                            .map(function() {\r\n                                // eslint-disable-next-line no-invalid-this\r\n                                return this.getAttribute('ssrc');\r\n                            })\r\n                            .get();\r\n\r\n                    if (ssrcs.length) {\r\n                        lines\r\n                            += `a=ssrc-group:${semantics} ${\r\n                                ssrcs.join(' ')}\\r\\n`;\r\n                    }\r\n                });\r\n\r\n            // handles both >source and >description>source\r\n            const tmp\r\n                = $(content).find(\r\n                    'source[xmlns=\"urn:xmpp:jingle:apps:rtp:ssma:0\"]');\r\n\r\n            /* eslint-disable no-invalid-this */\r\n            tmp.each(function() {\r\n                const ssrc = $(this).attr('ssrc');\r\n\r\n                if (currentRemoteSdp.containsSSRC(ssrc)) {\r\n                    logger.warn(`${this} Source-add request for existing SSRC: ${ssrc}`);\r\n\r\n                    return;\r\n                }\r\n\r\n                // eslint-disable-next-line newline-per-chained-call\r\n                $(this).find('>parameter').each(function() {\r\n                    lines += `a=ssrc:${ssrc} ${$(this).attr('name')}`;\r\n                    if ($(this).attr('value') && $(this).attr('value').length) {\r\n                        lines += `:${$(this).attr('value')}`;\r\n                    }\r\n                    lines += '\\r\\n';\r\n                });\r\n            });\r\n\r\n            /* eslint-enable no-invalid-this */\r\n            currentRemoteSdp.media.forEach((media, i2) => {\r\n                if (!SDPUtil.findLine(media, `a=mid:${name}`)) {\r\n                    return;\r\n                }\r\n                if (!addSsrcInfo[i2]) {\r\n                    addSsrcInfo[i2] = '';\r\n                }\r\n                addSsrcInfo[i2] += lines;\r\n            });\r\n        });\r\n\r\n        return addSsrcInfo;\r\n    }\r\n\r\n    /**\r\n     * Handles a Jingle source-add message for this Jingle session.\r\n     * @param elem An array of Jingle \"content\" elements.\r\n     */\r\n    addRemoteStream(elem) {\r\n        this._addOrRemoveRemoteStream(true /* add */, elem);\r\n    }\r\n\r\n    /**\r\n     * Handles a Jingle source-remove message for this Jingle session.\r\n     * @param elem An array of Jingle \"content\" elements.\r\n     */\r\n    removeRemoteStream(elem) {\r\n        this._addOrRemoveRemoteStream(false /* remove */, elem);\r\n    }\r\n\r\n    /**\r\n     * Handles the deletion of the remote tracks and SSRCs associated with a remote endpoint.\r\n     *\r\n     * @param {string} id Endpoint id of the participant that has left the call.\r\n     * @returns {Promise<JitsiRemoteTrack>} Promise that resolves with the tracks that are removed or error if the\r\n     * operation fails.\r\n     */\r\n    removeRemoteStreamsOnLeave(id) {\r\n        let remoteTracks = [];\r\n\r\n        const workFunction = finishCallback => {\r\n            const removeSsrcInfo = this.peerconnection.getRemoteSourceInfoByParticipant(id);\r\n\r\n            if (removeSsrcInfo.length) {\r\n                const oldLocalSdp = new SDP(this.peerconnection.localDescription.sdp);\r\n                const newRemoteSdp = this._processRemoteRemoveSource(removeSsrcInfo);\r\n\r\n                remoteTracks = this.peerconnection.removeRemoteTracks(id);\r\n                this._renegotiate(newRemoteSdp.raw)\r\n                    .then(() => {\r\n                        const newLocalSDP = new SDP(this.peerconnection.localDescription.sdp);\r\n\r\n                        this.notifyMySSRCUpdate(oldLocalSdp, newLocalSDP);\r\n                        finishCallback();\r\n                    })\r\n                    .catch(err => finishCallback(err));\r\n            } else {\r\n                finishCallback();\r\n            }\r\n        };\r\n\r\n        return new Promise((resolve, reject) => {\r\n            logger.debug(`${this} Queued removeRemoteStreamsOnLeave task for participant ${id}`);\r\n\r\n            this.modificationQueue.push(\r\n                workFunction,\r\n                error => {\r\n                    if (error) {\r\n                        logger.error(`${this} removeRemoteStreamsOnLeave error:`, error);\r\n                        reject(error);\r\n                    } else {\r\n                        logger.info(`${this} removeRemoteStreamsOnLeave done!`);\r\n                        resolve(remoteTracks);\r\n                    }\r\n                });\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Handles either Jingle 'source-add' or 'source-remove' message for this\r\n     * Jingle session.\r\n     * @param {boolean} isAdd <tt>true</tt> for 'source-add' or <tt>false</tt>\r\n     * otherwise.\r\n     * @param {Array<Element>} elem an array of Jingle \"content\" elements.\r\n     * @private\r\n     */\r\n    _addOrRemoveRemoteStream(isAdd, elem) {\r\n        const logPrefix = isAdd ? 'addRemoteStream' : 'removeRemoteStream';\r\n\r\n        if (isAdd) {\r\n            this.readSsrcInfo(elem);\r\n        }\r\n\r\n        const workFunction = finishedCallback => {\r\n            if (!this.peerconnection.localDescription\r\n                || !this.peerconnection.localDescription.sdp) {\r\n                const errMsg = `${logPrefix} - localDescription not ready yet`;\r\n\r\n                logger.error(errMsg);\r\n                finishedCallback(errMsg);\r\n\r\n                return;\r\n            }\r\n\r\n            logger.log(`${this} Processing ${logPrefix}`);\r\n\r\n            const oldLocalSdp = new SDP(this.peerconnection.localDescription.sdp);\r\n            const sdp = new SDP(this.peerconnection.remoteDescription.sdp);\r\n            const addOrRemoveSsrcInfo\r\n                = isAdd\r\n                    ? this._parseSsrcInfoFromSourceAdd(elem, sdp)\r\n                    : this._parseSsrcInfoFromSourceRemove(elem, sdp);\r\n            const newRemoteSdp\r\n                = isAdd\r\n                    ? this._processRemoteAddSource(addOrRemoveSsrcInfo)\r\n                    : this._processRemoteRemoveSource(addOrRemoveSsrcInfo);\r\n\r\n            this._renegotiate(newRemoteSdp.raw)\r\n                .then(() => {\r\n                    const newLocalSdp\r\n                        = new SDP(this.peerconnection.localDescription.sdp);\r\n\r\n                    logger.log(`${this} ${logPrefix} - OK`);\r\n                    this.notifyMySSRCUpdate(oldLocalSdp, newLocalSdp);\r\n                    finishedCallback();\r\n                }, error => {\r\n                    logger.error(`${this} ${logPrefix} failed:`, error);\r\n                    finishedCallback(error);\r\n                });\r\n        };\r\n\r\n        logger.debug(`${this} Queued ${logPrefix} task`);\r\n\r\n        // Queue and execute\r\n        this.modificationQueue.push(workFunction);\r\n    }\r\n\r\n    /**\r\n     * Takes in a jingle offer iq, returns the new sdp offer\r\n     * @param {jquery xml element} offerIq the incoming offer\r\n     * @returns {SDP object} the jingle offer translated to SDP\r\n     */\r\n    _processNewJingleOfferIq(offerIq) {\r\n        const remoteSdp = new SDP('');\r\n\r\n        if (this.webrtcIceTcpDisable) {\r\n            remoteSdp.removeTcpCandidates = true;\r\n        }\r\n        if (this.webrtcIceUdpDisable) {\r\n            remoteSdp.removeUdpCandidates = true;\r\n        }\r\n        if (this.failICE) {\r\n            remoteSdp.failICE = true;\r\n        }\r\n\r\n        remoteSdp.fromJingle(offerIq);\r\n        this.readSsrcInfo($(offerIq).find('>content'));\r\n\r\n        return remoteSdp;\r\n    }\r\n\r\n    /**\r\n     * Remove the given ssrc lines from the current remote sdp\r\n     * @param {list} removeSsrcInfo a list of SDP line strings that\r\n     *  should be removed from the remote SDP\r\n     * @returns type {SDP Object} the new remote SDP (after removing the lines\r\n     *  in removeSsrcInfo\r\n     */\r\n    _processRemoteRemoveSource(removeSsrcInfo) {\r\n        const remoteSdp = this.usesUnifiedPlan\r\n            ? new SDP(this.peerconnection.peerconnection.remoteDescription.sdp)\r\n            : new SDP(this.peerconnection.remoteDescription.sdp);\r\n\r\n        removeSsrcInfo.forEach((lines, idx) => {\r\n            // eslint-disable-next-line no-param-reassign\r\n            lines = lines.split('\\r\\n');\r\n            lines.pop(); // remove empty last element;\r\n            if (this.usesUnifiedPlan) {\r\n                lines.forEach(line => {\r\n                    const mid = remoteSdp.media.findIndex(mLine => mLine.includes(line));\r\n\r\n                    if (mid > -1) {\r\n                        remoteSdp.media[mid] = remoteSdp.media[mid].replace(`${line}\\r\\n`, '');\r\n\r\n                        // The current direction of the transceiver for p2p will depend on whether a local sources is\r\n                        // added or not. It will be 'sendrecv' if the local source is present, 'sendonly' otherwise.\r\n                        if (this.isP2P) {\r\n                            const mediaType = SDPUtil.parseMLine(remoteSdp.media[mid].split('\\r\\n')[0])?.media;\r\n                            const desiredDirection = this.peerconnection.getDesiredMediaDirection(mediaType, false);\r\n\r\n                            [ MediaDirection.SENDRECV, MediaDirection.SENDONLY ].forEach(direction => {\r\n                                remoteSdp.media[mid] = remoteSdp.media[mid]\r\n                                    .replace(`a=${direction}`, `a=${desiredDirection}`);\r\n                            });\r\n\r\n                        // Jvb connections will have direction set to 'sendonly' when the remote ssrc is present.\r\n                        } else {\r\n                            // Change the direction to \"inactive\" always for jvb connection.\r\n                            remoteSdp.media[mid] = remoteSdp.media[mid]\r\n                                .replace(`a=${MediaDirection.SENDONLY}`, `a=${MediaDirection.INACTIVE}`);\r\n                        }\r\n                    }\r\n                });\r\n            } else {\r\n                lines.forEach(line => {\r\n                    remoteSdp.media[idx]\r\n                        = remoteSdp.media[idx].replace(`${line}\\r\\n`, '');\r\n                });\r\n            }\r\n        });\r\n        remoteSdp.raw = remoteSdp.session + remoteSdp.media.join('');\r\n\r\n        return remoteSdp;\r\n    }\r\n\r\n    /**\r\n     * Add the given ssrc lines to the current remote sdp\r\n     * @param {list} addSsrcInfo a list of SDP line strings that\r\n     *  should be added to the remote SDP\r\n     * @returns type {SDP Object} the new remote SDP (after removing the lines\r\n     *  in removeSsrcInfo\r\n     */\r\n    _processRemoteAddSource(addSsrcInfo) {\r\n        const remoteSdp = new SDP(this.peerconnection.remoteDescription.sdp);\r\n\r\n        addSsrcInfo.forEach((lines, idx) => {\r\n            remoteSdp.media[idx] += lines;\r\n\r\n            // Make sure to change the direction to 'sendrecv' only for p2p connections. For jvb connections, a new\r\n            // m-line is added for the new remote sources.\r\n            if (this.isP2P && this.usesUnifiedPlan) {\r\n                const mediaType = SDPUtil.parseMLine(remoteSdp.media[idx].split('\\r\\n')[0])?.media;\r\n                const desiredDirection = this.peerconnection.getDesiredMediaDirection(mediaType, true);\r\n\r\n                [ MediaDirection.RECVONLY, MediaDirection.INACTIVE ].forEach(direction => {\r\n                    remoteSdp.media[idx] = remoteSdp.media[idx]\r\n                        .replace(`a=${direction}`, `a=${desiredDirection}`);\r\n                });\r\n            }\r\n        });\r\n        remoteSdp.raw = remoteSdp.session + remoteSdp.media.join('');\r\n\r\n        return remoteSdp;\r\n    }\r\n\r\n    /**\r\n     * Do a new o/a flow using the existing remote description\r\n     * @param {string} [optionalRemoteSdp] optional, raw remote sdp\r\n     *  to use.  If not provided, the remote sdp from the\r\n     *  peerconnection will be used\r\n     * @returns {Promise} promise which resolves when the\r\n     *  o/a flow is complete with no arguments or\r\n     *  rejects with an error {string}\r\n     */\r\n    _renegotiate(optionalRemoteSdp) {\r\n        if (this.peerconnection.signalingState === 'closed') {\r\n            const error = new Error('Attempted to renegotiate in state closed');\r\n\r\n            this.room.eventEmitter.emit(XMPPEvents.RENEGOTIATION_FAILED, error, this);\r\n\r\n            return Promise.reject(error);\r\n        }\r\n\r\n        const remoteSdp\r\n            = optionalRemoteSdp || this.peerconnection.remoteDescription.sdp;\r\n\r\n        if (!remoteSdp) {\r\n            const error = new Error(`Can not renegotiate without remote description, current state: ${this.state}`);\r\n\r\n            this.room.eventEmitter.emit(XMPPEvents.RENEGOTIATION_FAILED, error, this);\r\n\r\n            return Promise.reject(error);\r\n        }\r\n\r\n        const remoteDescription = new RTCSessionDescription({\r\n            type: this.isInitiator ? 'answer' : 'offer',\r\n            sdp: remoteSdp\r\n        });\r\n\r\n        if (this.isInitiator) {\r\n            return this._initiatorRenegotiate(remoteDescription);\r\n        }\r\n\r\n        return this._responderRenegotiate(remoteDescription);\r\n    }\r\n\r\n    /**\r\n     * Renegotiate cycle implementation for the responder case.\r\n     * @param {object} remoteDescription the SDP object as defined by the WebRTC\r\n     * which will be used as remote description in the cycle.\r\n     * @private\r\n     */\r\n    _responderRenegotiate(remoteDescription) {\r\n        logger.debug(`${this} Renegotiate: setting remote description`);\r\n\r\n        return this.peerconnection.setRemoteDescription(remoteDescription)\r\n            .then(() => {\r\n                logger.debug(`${this} Renegotiate: creating answer`);\r\n\r\n                return this.peerconnection.createAnswer(this.mediaConstraints)\r\n                    .then(answer => {\r\n                        logger.debug(`${this} Renegotiate: setting local description`);\r\n\r\n                        return this.peerconnection.setLocalDescription(answer);\r\n                    });\r\n            });\r\n    }\r\n\r\n    /**\r\n     * Renegotiate cycle implementation for the initiator's case.\r\n     * @param {object} remoteDescription the SDP object as defined by the WebRTC\r\n     * which will be used as remote description in the cycle.\r\n     * @private\r\n     */\r\n    _initiatorRenegotiate(remoteDescription) {\r\n        logger.debug(`${this} Renegotiate: creating offer`);\r\n\r\n        return this.peerconnection.createOffer(this.mediaConstraints)\r\n            .then(offer => {\r\n                logger.debug(`${this} Renegotiate: setting local description`);\r\n\r\n                return this.peerconnection.setLocalDescription(offer)\r\n                    .then(() => {\r\n                        logger.debug(`${this} Renegotiate: setting remote description`);\r\n\r\n                        // eslint-disable-next-line max-len\r\n                        return this.peerconnection.setRemoteDescription(remoteDescription);\r\n                    });\r\n            });\r\n    }\r\n\r\n    /**\r\n     * Replaces <tt>oldTrack</tt> with <tt>newTrack</tt> and performs a single\r\n     * offer/answer cycle after both operations are done. Either\r\n     * <tt>oldTrack</tt> or <tt>newTrack</tt> can be null; replacing a valid\r\n     * <tt>oldTrack</tt> with a null <tt>newTrack</tt> effectively just removes\r\n     * <tt>oldTrack</tt>\r\n     * @param {JitsiLocalTrack|null} oldTrack the current track in use to be\r\n     * replaced\r\n     * @param {JitsiLocalTrack|null} newTrack the new track to use\r\n     * @returns {Promise} which resolves once the replacement is complete\r\n     *  with no arguments or rejects with an error {string}\r\n     */\r\n    replaceTrack(oldTrack, newTrack) {\r\n        const workFunction = finishedCallback => {\r\n            logger.debug(`${this} replaceTrack worker started. oldTrack = ${oldTrack}, newTrack = ${newTrack}`);\r\n\r\n            const oldLocalSdp = this.peerconnection.localDescription.sdp;\r\n\r\n            if (!this.usesUnifiedPlan) {\r\n                // NOTE the code below assumes that no more than 1 video track\r\n                // can be added to the peer connection.\r\n                // Transition from camera to desktop share\r\n                // or transition from one camera source to another.\r\n                if (this.peerconnection.options.capScreenshareBitrate\r\n                    && oldTrack && newTrack && newTrack.isVideoTrack()) {\r\n                    // Clearing current primary SSRC will make\r\n                    // the SdpConsistency generate a new one which will result\r\n                    // with:\r\n                    // 1. source-remove for the old video stream.\r\n                    // 2. source-add for the new video stream.\r\n                    this.peerconnection.clearRecvonlySsrc();\r\n                }\r\n\r\n                // Transition from no video to video (unmute).\r\n                if (!oldTrack && newTrack && newTrack.isVideoTrack()) {\r\n                    // Clearing current primary SSRC will make\r\n                    // the SdpConsistency generate a new one which will result\r\n                    // with:\r\n                    // 1. source-remove for the recvonly\r\n                    // 2. source-add for the new video stream\r\n                    this.peerconnection.clearRecvonlySsrc();\r\n\r\n                // Transition from video to no video\r\n                } else if (oldTrack && oldTrack.isVideoTrack() && !newTrack) {\r\n                    // Clearing current primary SSRC and generating the recvonly\r\n                    // will result in:\r\n                    // 1. source-remove for the old video stream\r\n                    // 2. source-add for the recvonly stream\r\n                    this.peerconnection.clearRecvonlySsrc();\r\n                    this.peerconnection.generateRecvonlySsrc();\r\n                }\r\n            }\r\n\r\n            this.peerconnection.replaceTrack(oldTrack, newTrack)\r\n                .then(shouldRenegotiate => {\r\n                    let promise = Promise.resolve();\r\n\r\n                    logger.debug(`${this} TPC.replaceTrack finished. shouldRenegotiate = ${\r\n                        shouldRenegotiate}, JingleSessionState = ${this.state}`);\r\n\r\n                    if (shouldRenegotiate\r\n                        && (oldTrack || newTrack)\r\n                        && this.state === JingleSessionState.ACTIVE) {\r\n                        promise = this._renegotiate().then(() => {\r\n                            const newLocalSDP = new SDP(this.peerconnection.localDescription.sdp);\r\n\r\n                            this.notifyMySSRCUpdate(new SDP(oldLocalSdp), newLocalSDP);\r\n                        });\r\n                    }\r\n\r\n                    return promise.then(() => {\r\n                        if (newTrack && newTrack.isVideoTrack()) {\r\n                            logger.debug(`${this} replaceTrack worker: configuring video stream`);\r\n\r\n                            // FIXME set all sender parameters in one go?\r\n                            // Set the degradation preference on the new video sender.\r\n                            return this.peerconnection.setSenderVideoDegradationPreference()\r\n                                .then(() => this.peerconnection.setSenderVideoConstraint())\r\n                                .then(() => this.peerconnection.setMaxBitRate());\r\n                        }\r\n                    });\r\n                })\r\n                .then(() => finishedCallback(), error => finishedCallback(error));\r\n        };\r\n\r\n        return new Promise((resolve, reject) => {\r\n            logger.debug(`${this} Queued replaceTrack task. Old track = ${oldTrack}, new track = ${newTrack}`);\r\n\r\n            this.modificationQueue.push(\r\n                workFunction,\r\n                error => {\r\n                    if (error) {\r\n                        logger.error(`${this} Replace track error:`, error);\r\n                        reject(error);\r\n                    } else {\r\n                        logger.info(`${this}  Replace track done!`);\r\n                        resolve();\r\n                    }\r\n                });\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Parse the information from the xml sourceRemoveElem and translate it\r\n     *  into sdp lines\r\n     * @param {jquery xml element} sourceRemoveElem the source-remove\r\n     *  element from jingle\r\n     * @param {SDP object} currentRemoteSdp the current remote\r\n     *  sdp (as of this new source-remove)\r\n     * @returns {list} a list of SDP line strings that should\r\n     *  be removed from the remote SDP\r\n     */\r\n    _parseSsrcInfoFromSourceRemove(sourceRemoveElem, currentRemoteSdp) {\r\n        const removeSsrcInfo = [];\r\n\r\n        $(sourceRemoveElem).each((i1, content) => {\r\n            const name = $(content).attr('name');\r\n            let lines = '';\r\n\r\n            $(content)\r\n                .find('ssrc-group[xmlns=\"urn:xmpp:jingle:apps:rtp:ssma:0\"]')\r\n                .each(function() {\r\n                    /* eslint-disable no-invalid-this */\r\n                    const semantics = this.getAttribute('semantics');\r\n                    const ssrcs\r\n                        = $(this)\r\n                            .find('>source')\r\n                            .map(function() {\r\n                                return this.getAttribute('ssrc');\r\n                            })\r\n                            .get();\r\n\r\n                    if (ssrcs.length) {\r\n                        lines\r\n                            += `a=ssrc-group:${semantics} ${\r\n                                ssrcs.join(' ')}\\r\\n`;\r\n                    }\r\n\r\n                    /* eslint-enable no-invalid-this */\r\n                });\r\n            const ssrcs = [];\r\n\r\n            // handles both >source and >description>source versions\r\n            const tmp\r\n                = $(content).find(\r\n                    'source[xmlns=\"urn:xmpp:jingle:apps:rtp:ssma:0\"]');\r\n\r\n            tmp.each(function() {\r\n                // eslint-disable-next-line no-invalid-this\r\n                const ssrc = $(this).attr('ssrc');\r\n\r\n                ssrcs.push(ssrc);\r\n            });\r\n            currentRemoteSdp.media.forEach((media, i2) => {\r\n                if (!SDPUtil.findLine(media, `a=mid:${name}`)) {\r\n                    return;\r\n                }\r\n                if (!removeSsrcInfo[i2]) {\r\n                    removeSsrcInfo[i2] = '';\r\n                }\r\n                ssrcs.forEach(ssrc => {\r\n                    const ssrcLines\r\n                        = SDPUtil.findLines(media, `a=ssrc:${ssrc}`);\r\n\r\n                    if (ssrcLines.length) {\r\n                        removeSsrcInfo[i2] += `${ssrcLines.join('\\r\\n')}\\r\\n`;\r\n                    }\r\n                });\r\n                removeSsrcInfo[i2] += lines;\r\n            });\r\n        });\r\n\r\n        return removeSsrcInfo;\r\n    }\r\n\r\n    /**\r\n     * Will print an error if there is any difference, between the SSRCs given\r\n     * in the <tt>oldSDP</tt> and the ones currently described in\r\n     * the peerconnection's local description.\r\n     * @param {string} operationName the operation's name which will be printed\r\n     * in the error message.\r\n     * @param {SDP} oldSDP the old local SDP which will be compared with\r\n     * the current one.\r\n     * @return {boolean} <tt>true</tt> if there was any change or <tt>false</tt>\r\n     * otherwise.\r\n     * @private\r\n     */\r\n    _verifyNoSSRCChanged(operationName, oldSDP) {\r\n        const currentLocalSDP\r\n            = new SDP(this.peerconnection.localDescription.sdp);\r\n        let sdpDiff = new SDPDiffer(oldSDP, currentLocalSDP);\r\n        const addedMedia = sdpDiff.getNewMedia();\r\n\r\n        if (Object.keys(addedMedia).length) {\r\n            logger.error(`${this} - some SSRC were added on ${operationName}`, addedMedia);\r\n\r\n            return false;\r\n        }\r\n\r\n        sdpDiff = new SDPDiffer(currentLocalSDP, oldSDP);\r\n        const removedMedia = sdpDiff.getNewMedia();\r\n\r\n        if (Object.keys(removedMedia).length) {\r\n            logger.error(`${this} - some SSRCs were removed on ${operationName}`, removedMedia);\r\n\r\n            return false;\r\n        }\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Adds local track back to this session, as part of the unmute operation.\r\n     * @param {JitsiLocalTrack} track\r\n     * @return {Promise} a promise that will resolve once the local track is\r\n     * added back to this session and renegotiation succeeds. Will be rejected\r\n     * with a <tt>string</tt> that provides some error details in case something\r\n     * goes wrong.\r\n     */\r\n    addTrackAsUnmute(track) {\r\n        return this._addRemoveTrackAsMuteUnmute(\r\n            false /* add as unmute */, track)\r\n            .then(() => {\r\n                // Apply the video constraints, max bitrates and degradation preference on\r\n                // the video sender if needed.\r\n                if (track.isVideoTrack() && browser.doesVideoMuteByStreamRemove()) {\r\n                    return this.setSenderMaxBitrates()\r\n                        .then(() => this.setSenderVideoDegradationPreference())\r\n                        .then(() => this.setSenderVideoConstraint());\r\n                }\r\n            });\r\n    }\r\n\r\n    /**\r\n     * Remove local track as part of the mute operation.\r\n     * @param {JitsiLocalTrack} track the local track to be removed\r\n     * @return {Promise} a promise which will be resolved once the local track\r\n     * is removed from this session and the renegotiation is performed.\r\n     * The promise will be rejected with a <tt>string</tt> that the describes\r\n     * the error if anything goes wrong.\r\n     */\r\n    removeTrackAsMute(track) {\r\n        return this._addRemoveTrackAsMuteUnmute(\r\n            true /* remove as mute */, track);\r\n    }\r\n\r\n    /**\r\n     * See {@link addTrackAsUnmute} and {@link removeTrackAsMute}.\r\n     * @param {boolean} isMute <tt>true</tt> for \"remove as mute\" or\r\n     * <tt>false</tt> for \"add as unmute\".\r\n     * @param {JitsiLocalTrack} track the track that will be added/removed\r\n     * @private\r\n     */\r\n    _addRemoveTrackAsMuteUnmute(isMute, track) {\r\n        if (!track) {\r\n            return Promise.reject('invalid \"track\" argument value');\r\n        }\r\n        const operationName = isMute ? 'removeTrackMute' : 'addTrackUnmute';\r\n        const workFunction = finishedCallback => {\r\n            const tpc = this.peerconnection;\r\n\r\n            if (!tpc) {\r\n                finishedCallback(\r\n                    `Error:  tried ${operationName} track with no active peer`\r\n                        + 'connection');\r\n\r\n                return;\r\n            }\r\n            const oldLocalSDP = tpc.localDescription.sdp;\r\n            const operationPromise\r\n                = isMute\r\n                    ? tpc.removeTrackMute(track)\r\n                    : tpc.addTrackUnmute(track);\r\n\r\n            operationPromise\r\n                .then(shouldRenegotiate => {\r\n                    if (shouldRenegotiate && oldLocalSDP && tpc.remoteDescription.sdp) {\r\n                        this._renegotiate()\r\n                            .then(() => {\r\n                                // The results are ignored, as this check failure is not\r\n                                // enough to fail the whole operation. It will log\r\n                                // an error inside.\r\n                                this._verifyNoSSRCChanged(\r\n                                    operationName, new SDP(oldLocalSDP));\r\n                                finishedCallback();\r\n                            });\r\n                    } else {\r\n                        finishedCallback();\r\n                    }\r\n                },\r\n                finishedCallback /* will be called with an error */);\r\n        };\r\n\r\n        logger.debug(`${this} Queued ${operationName} task`);\r\n\r\n        return new Promise((resolve, reject) => {\r\n            this.modificationQueue.push(\r\n                workFunction,\r\n                error => {\r\n                    if (error) {\r\n                        logger.error(`${this} ${operationName} failed`);\r\n                        reject(error);\r\n                    } else {\r\n                        logger.debug(`${this} ${operationName} done`);\r\n                        resolve();\r\n                    }\r\n                });\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Resumes or suspends media transfer over the underlying peer connection.\r\n     * @param {boolean} audioActive <tt>true</tt> to enable audio media\r\n     * transfer or <tt>false</tt> to suspend audio media transmission.\r\n     * @param {boolean} videoActive <tt>true</tt> to enable video media\r\n     * transfer or <tt>false</tt> to suspend video media transmission.\r\n     * @return {Promise} a <tt>Promise</tt> which will resolve once\r\n     * the operation is done. It will be rejected with an error description as\r\n     * a string in case anything goes wrong.\r\n     */\r\n    setMediaTransferActive(audioActive, videoActive) {\r\n        if (!this.peerconnection) {\r\n            return Promise.reject(\r\n                'Can not modify transfer active state,'\r\n                    + ' before \"initialize\" is called');\r\n        }\r\n\r\n        const logAudioStr = audioActive ? 'audio active' : 'audio inactive';\r\n        const logVideoStr = videoActive ? 'video active' : 'video inactive';\r\n\r\n        logger.info(`${this} Queued make ${logVideoStr}, ${logAudioStr} task`);\r\n\r\n        const workFunction = finishedCallback => {\r\n            const isSessionActive = this.state === JingleSessionState.ACTIVE;\r\n\r\n            // Because the value is modified on the queue it's impossible to\r\n            // check it's final value reliably prior to submitting the task.\r\n            // The rule here is that the last submitted state counts.\r\n            // Check the values here to avoid unnecessary renegotiation cycle.\r\n            const audioActiveChanged\r\n                = this.peerconnection.setAudioTransferActive(audioActive);\r\n\r\n            if (this._localVideoActive !== videoActive) {\r\n                this._localVideoActive = videoActive;\r\n\r\n                // Do only for P2P - Jicofo will reply with 'bad-request'\r\n                // We don't want to send 'content-modify', before the initial\r\n                // O/A (state === JingleSessionState.ACTIVE), because that will\r\n                // mess up video media direction in the remote SDP.\r\n                // 'content-modify' when processed only affects the media\r\n                // direction in the local SDP. We're doing that, because setting\r\n                // 'inactive' on video media in remote SDP will mess up our SDP\r\n                // translation chain (simulcast, RTX, video mute etc.).\r\n                if (this.isP2P && isSessionActive) {\r\n                    this.sendContentModify();\r\n                }\r\n            }\r\n\r\n            const pcVideoActiveChanged\r\n                = this.peerconnection.setVideoTransferActive(\r\n                    this._localVideoActive && this._remoteVideoActive);\r\n\r\n            // Will do the sRD/sLD cycle to update SDPs and adjust the media\r\n            // direction\r\n            if (isSessionActive\r\n                    && (audioActiveChanged || pcVideoActiveChanged)) {\r\n                this._renegotiate()\r\n                    .then(\r\n                        finishedCallback,\r\n                        finishedCallback /* will be called with an error */);\r\n            } else {\r\n                finishedCallback();\r\n            }\r\n        };\r\n\r\n        return new Promise((resolve, reject) => {\r\n            this.modificationQueue.push(\r\n                workFunction,\r\n                error => {\r\n                    if (error) {\r\n                        logger.error(`${this} Make ${logVideoStr}, ${logAudioStr} task failed!`);\r\n                        reject(error);\r\n                    } else {\r\n                        logger.debug(`${this} Make ${logVideoStr}, ${logAudioStr} task done!`);\r\n                        resolve();\r\n                    }\r\n                });\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Will put and execute on the queue a session modify task. Currently it\r\n     * only checks the senders attribute of the video content in order to figure\r\n     * out if the remote peer has video in the inactive state (stored locally\r\n     * in {@link _remoteVideoActive} - see field description for more info).\r\n     * @param {jQuery} jingleContents jQuery selector pointing to the jingle\r\n     * element of the session modify IQ.\r\n     * @see {@link _remoteVideoActive}\r\n     * @see {@link _localVideoActive}\r\n     */\r\n    modifyContents(jingleContents) {\r\n        const newVideoSenders\r\n            = JingleSessionPC.parseVideoSenders(jingleContents);\r\n        const newMaxFrameHeight\r\n            = JingleSessionPC.parseMaxFrameHeight(jingleContents);\r\n\r\n        // frame height is optional in our content-modify protocol\r\n        if (newMaxFrameHeight) {\r\n            logger.info(`${this} received remote max frame height: ${newMaxFrameHeight}`);\r\n            this.remoteRecvMaxFrameHeight = newMaxFrameHeight;\r\n            this.eventEmitter.emit(\r\n                MediaSessionEvents.REMOTE_VIDEO_CONSTRAINTS_CHANGED, this);\r\n        }\r\n\r\n        if (newVideoSenders === null) {\r\n            logger.error(\r\n                `${this} - failed to parse video \"senders\" attribute in`\r\n                    + '\"content-modify\" action');\r\n\r\n            return;\r\n        }\r\n\r\n        const workFunction = finishedCallback => {\r\n            if (this._assertNotEnded('content-modify')\r\n                    && this._modifyRemoteVideoActive(newVideoSenders)) {\r\n                // Will do the sRD/sLD cycle to update SDPs and adjust\r\n                // the media direction\r\n                this._renegotiate()\r\n                    .then(finishedCallback, finishedCallback /* (error) */);\r\n            } else {\r\n                finishedCallback();\r\n            }\r\n        };\r\n\r\n        logger.debug(`${this} queued \"content-modify\" task(video senders=\"${newVideoSenders}\")`);\r\n\r\n        this.modificationQueue.push(\r\n            workFunction,\r\n            error => {\r\n                if (error) {\r\n                    logger.error(`${this} \"content-modify\" failed`, error);\r\n                } else {\r\n                    logger.debug(`${this} \"content-modify\" task(video senders=\"${newVideoSenders}\") done`);\r\n                }\r\n            });\r\n    }\r\n\r\n    /**\r\n     * Processes new value of remote video \"senders\" Jingle attribute and tries\r\n     * to apply it for {@link _remoteVideoActive}.\r\n     * @param {string} remoteVideoSenders the value of \"senders\" attribute of\r\n     * Jingle video content element advertised by remote peer.\r\n     * @return {boolean} <tt>true</tt> if the change affected state of\r\n     * the underlying peerconnection and renegotiation is required for\r\n     * the changes to take effect.\r\n     * @private\r\n     */\r\n    _modifyRemoteVideoActive(remoteVideoSenders) {\r\n        const isRemoteVideoActive\r\n            = remoteVideoSenders === 'both'\r\n                || (remoteVideoSenders === 'initiator' && this.isInitiator)\r\n                || (remoteVideoSenders === 'responder' && !this.isInitiator);\r\n\r\n        if (isRemoteVideoActive !== this._remoteVideoActive) {\r\n            logger.debug(`${this} new remote video active: ${isRemoteVideoActive}`);\r\n            this._remoteVideoActive = isRemoteVideoActive;\r\n        }\r\n\r\n        return this.peerconnection.setVideoTransferActive(\r\n            this._localVideoActive && this._remoteVideoActive);\r\n    }\r\n\r\n    /**\r\n     * Figures out added/removed ssrcs and send update IQs.\r\n     * @param oldSDP SDP object for old description.\r\n     * @param newSDP SDP object for new description.\r\n     */\r\n    notifyMySSRCUpdate(oldSDP, newSDP) {\r\n\r\n        if (this.state !== JingleSessionState.ACTIVE) {\r\n            logger.warn(`${this} Skipping SSRC update in '${this.state} ' state.`);\r\n\r\n            return;\r\n        }\r\n\r\n        if (!this.connection.connected) {\r\n            // The goal is to compare the oldest SDP with the latest one upon reconnect\r\n            if (!this._cachedOldLocalSdp) {\r\n                this._cachedOldLocalSdp = oldSDP;\r\n            }\r\n            this._cachedNewLocalSdp = newSDP;\r\n            logger.warn(`${this} Not sending SSRC update while the signaling is disconnected`);\r\n\r\n            return;\r\n        }\r\n\r\n        this._cachedOldLocalSdp = undefined;\r\n        this._cachedNewLocalSdp = undefined;\r\n\r\n        // send source-remove IQ.\r\n        let sdpDiffer = new SDPDiffer(newSDP, oldSDP);\r\n        const remove = $iq({ to: this.remoteJid,\r\n            type: 'set' })\r\n            .c('jingle', {\r\n                xmlns: 'urn:xmpp:jingle:1',\r\n                action: 'source-remove',\r\n                initiator: this.initiatorJid,\r\n                sid: this.sid\r\n            }\r\n            );\r\n        const removedAnySSRCs = sdpDiffer.toJingle(remove);\r\n\r\n        if (removedAnySSRCs) {\r\n            logger.info(`${this} Sending source-remove`, remove.tree());\r\n            this.connection.sendIQ(\r\n                remove, null,\r\n                this.newJingleErrorHandler(remove), IQ_TIMEOUT);\r\n        }\r\n\r\n        // send source-add IQ.\r\n        sdpDiffer = new SDPDiffer(oldSDP, newSDP);\r\n        const add = $iq({ to: this.remoteJid,\r\n            type: 'set' })\r\n            .c('jingle', {\r\n                xmlns: 'urn:xmpp:jingle:1',\r\n                action: 'source-add',\r\n                initiator: this.initiatorJid,\r\n                sid: this.sid\r\n            }\r\n            );\r\n\r\n        const containsNewSSRCs = sdpDiffer.toJingle(add);\r\n\r\n        if (containsNewSSRCs) {\r\n            logger.info(`${this} Sending source-add`, add.tree());\r\n            this.connection.sendIQ(\r\n                add, null, this.newJingleErrorHandler(add), IQ_TIMEOUT);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Method returns function(errorResponse) which is a callback to be passed\r\n     * to Strophe connection.sendIQ method. An 'error' structure is created that\r\n     * is passed as 1st argument to given <tt>failureCb</tt>. The format of this\r\n     * structure is as follows:\r\n     * {\r\n     *  code: {XMPP error response code}\r\n     *  reason: {the name of XMPP error reason element or 'timeout' if the\r\n      *          request has timed out within <tt>IQ_TIMEOUT</tt> milliseconds}\r\n     *  source: {request.tree() that provides original request}\r\n     *  session: {this JingleSessionPC.toString()}\r\n     * }\r\n     * @param request Strophe IQ instance which is the request to be dumped into\r\n     *        the error structure\r\n     * @param failureCb function(error) called when error response was returned\r\n     *        or when a timeout has occurred.\r\n     * @returns {function(this:JingleSessionPC)}\r\n     */\r\n    newJingleErrorHandler(request, failureCb) {\r\n        return errResponse => {\r\n\r\n            const error = {};\r\n\r\n            // Get XMPP error code and condition(reason)\r\n            const errorElSel = $(errResponse).find('error');\r\n\r\n            if (errorElSel.length) {\r\n                error.code = errorElSel.attr('code');\r\n                const errorReasonSel = $(errResponse).find('error :first');\r\n\r\n                if (errorReasonSel.length) {\r\n                    error.reason = errorReasonSel[0].tagName;\r\n                }\r\n\r\n                const errorMsgSel = errorElSel.find('>text');\r\n\r\n                if (errorMsgSel.length) {\r\n                    error.msg = errorMsgSel.text();\r\n                }\r\n            }\r\n\r\n            if (!errResponse) {\r\n                error.reason = 'timeout';\r\n            }\r\n\r\n            error.session = this.toString();\r\n\r\n            if (failureCb) {\r\n                failureCb(error);\r\n            } else if (this.state === JingleSessionState.ENDED\r\n                        && error.reason === 'item-not-found') {\r\n                // When remote peer decides to terminate the session, but it\r\n                // still have few messages on the queue for processing,\r\n                // it will first send us 'session-terminate' (we enter ENDED)\r\n                // and then follow with 'item-not-found' for the queued requests\r\n                // We don't want to have that logged on error level.\r\n                logger.debug(`${this} Jingle error: ${JSON.stringify(error)}`);\r\n            } else {\r\n                GlobalOnErrorHandler.callErrorHandler(\r\n                    new Error(\r\n                        `Jingle error: ${JSON.stringify(error)}`));\r\n            }\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Returns the ice connection state for the peer connection.\r\n     * @returns the ice connection state for the peer connection.\r\n     */\r\n    getIceConnectionState() {\r\n        return this.peerconnection.getConnectionState();\r\n    }\r\n\r\n    /**\r\n     * Closes the peerconnection.\r\n     */\r\n    close() {\r\n        this.state = JingleSessionState.ENDED;\r\n        this.establishmentDuration = undefined;\r\n\r\n        if (this.peerconnection) {\r\n            this.peerconnection.onicecandidate = null;\r\n            this.peerconnection.oniceconnectionstatechange = null;\r\n            this.peerconnection.onnegotiationneeded = null;\r\n            this.peerconnection.onsignalingstatechange = null;\r\n        }\r\n\r\n        logger.debug(`${this} Clearing modificationQueue`);\r\n\r\n        // Remove any pending tasks from the queue\r\n        this.modificationQueue.clear();\r\n\r\n        logger.debug(`${this} Queued PC close task`);\r\n        this.modificationQueue.push(finishCallback => {\r\n            // The signaling layer will remove it's listeners\r\n            this.signalingLayer.setChatRoom(null);\r\n\r\n            // do not try to close if already closed.\r\n            this.peerconnection && this.peerconnection.close();\r\n            finishCallback();\r\n            logger.debug(`${this} PC close task done!`);\r\n        });\r\n\r\n        logger.debug(`${this} Shutdown modificationQueue!`);\r\n\r\n        // No more tasks can go in after the close task\r\n        this.modificationQueue.shutdown();\r\n    }\r\n\r\n    /**\r\n     * Converts to string with minor summary.\r\n     * @return {string}\r\n     */\r\n    toString() {\r\n        return `JingleSessionPC[session=${this.isP2P ? 'P2P' : 'JVB'},initiator=${this.isInitiator},sid=${this.sid}]`;\r\n    }\r\n\r\n    /**\r\n     * If the A/B test for suspend video is disabled according to the room's\r\n     * configuration, returns undefined. Otherwise returns a boolean which\r\n     * indicates whether the suspend video option should be enabled or disabled.\r\n     * @param {JingleSessionPCOptions} options - The config options.\r\n     */\r\n    _abtestSuspendVideoEnabled({ abTesting }) {\r\n        if (!abTesting || !abTesting.enableSuspendVideoTest) {\r\n            return;\r\n        }\r\n\r\n        // We want the two participants in a P2P call to agree on the value of\r\n        // the \"suspend\" option. We use the JID of the initiator, because it is\r\n        // both randomly selected and agreed upon by both participants.\r\n        const jid = this._getInitiatorJid();\r\n\r\n        return integerHash(jid) % 2 === 0;\r\n    }\r\n}\r\n","import SDPUtil from './SDPUtil';\r\n\r\n// this could be useful in Array.prototype.\r\n/**\r\n *\r\n * @param array1\r\n * @param array2\r\n */\r\nfunction arrayEquals(array1, array2) {\r\n    // if the other array is a falsy value, return\r\n    if (!array2) {\r\n        return false;\r\n    }\r\n\r\n    // compare lengths - can save a lot of time\r\n    if (array1.length !== array2.length) {\r\n        return false;\r\n    }\r\n\r\n    for (let i = 0, l = array1.length; i < l; i++) {\r\n        // Check if we have nested arrays\r\n        if (array1[i] instanceof Array && array2[i] instanceof Array) {\r\n            // recurse into the nested arrays\r\n            if (!array1[i].equals(array2[i])) {\r\n                return false;\r\n            }\r\n        } else if (array1[i] !== array2[i]) {\r\n            // Warning - two different object instances will never be\r\n            // equal: {x:20} != {x:20}\r\n            return false;\r\n        }\r\n    }\r\n\r\n    return true;\r\n}\r\n\r\n/**\r\n *\r\n * @param mySDP\r\n * @param otherSDP\r\n */\r\nexport default function SDPDiffer(mySDP, otherSDP) {\r\n    this.mySDP = mySDP;\r\n    this.otherSDP = otherSDP;\r\n    if (!mySDP) {\r\n        throw new Error('\"mySDP\" is undefined!');\r\n    } else if (!otherSDP) {\r\n        throw new Error('\"otherSDP\" is undefined!');\r\n    }\r\n}\r\n\r\n/**\r\n * Returns map of MediaChannel that contains media contained in\r\n * 'mySDP', but not contained in 'otherSdp'. Mapped by channel idx.\r\n */\r\nSDPDiffer.prototype.getNewMedia = function() {\r\n\r\n    const myMedias = this.mySDP.getMediaSsrcMap();\r\n    const othersMedias = this.otherSDP.getMediaSsrcMap();\r\n    const newMedia = {};\r\n\r\n    Object.keys(othersMedias).forEach(othersMediaIdx => {\r\n        const myMedia = myMedias[othersMediaIdx];\r\n        const othersMedia = othersMedias[othersMediaIdx];\r\n\r\n        if (!myMedia && othersMedia) {\r\n            // Add whole channel\r\n            newMedia[othersMediaIdx] = othersMedia;\r\n\r\n            return;\r\n        }\r\n\r\n        // Look for new ssrcs across the channel\r\n        Object.keys(othersMedia.ssrcs).forEach(ssrc => {\r\n            if (Object.keys(myMedia.ssrcs).indexOf(ssrc) === -1) {\r\n                // Allocate channel if we've found ssrc that doesn't exist in\r\n                // our channel\r\n                if (!newMedia[othersMediaIdx]) {\r\n                    newMedia[othersMediaIdx] = {\r\n                        mediaindex: othersMedia.mediaindex,\r\n                        mid: othersMedia.mid,\r\n                        ssrcs: {},\r\n                        ssrcGroups: []\r\n                    };\r\n                }\r\n                newMedia[othersMediaIdx].ssrcs[ssrc] = othersMedia.ssrcs[ssrc];\r\n            } else if (othersMedia.ssrcs[ssrc].lines\r\n                        && myMedia.ssrcs[ssrc].lines) {\r\n                // we want to detect just changes in adding/removing msid\r\n                const myContainMsid = myMedia.ssrcs[ssrc].lines.find(\r\n                    line => line.indexOf('msid') !== -1) !== undefined;\r\n                const newContainMsid = othersMedia.ssrcs[ssrc].lines.find(\r\n                    line => line.indexOf('msid') !== -1) !== undefined;\r\n\r\n                if (myContainMsid !== newContainMsid) {\r\n                    if (!newMedia[othersMediaIdx]) {\r\n                        newMedia[othersMediaIdx] = {\r\n                            mediaindex: othersMedia.mediaindex,\r\n                            mid: othersMedia.mid,\r\n                            ssrcs: {},\r\n                            ssrcGroups: []\r\n                        };\r\n                    }\r\n                    newMedia[othersMediaIdx].ssrcs[ssrc]\r\n                        = othersMedia.ssrcs[ssrc];\r\n                }\r\n            }\r\n        });\r\n\r\n        // Look for new ssrc groups across the channels\r\n        othersMedia.ssrcGroups.forEach(otherSsrcGroup => {\r\n\r\n            // try to match the other ssrc-group with an ssrc-group of ours\r\n            let matched = false;\r\n\r\n            for (let i = 0; i < myMedia.ssrcGroups.length; i++) {\r\n                const mySsrcGroup = myMedia.ssrcGroups[i];\r\n\r\n                if (otherSsrcGroup.semantics === mySsrcGroup.semantics\r\n                    && arrayEquals(otherSsrcGroup.ssrcs, mySsrcGroup.ssrcs)) {\r\n\r\n                    matched = true;\r\n                    break;\r\n                }\r\n            }\r\n\r\n            if (!matched) {\r\n                // Allocate channel if we've found an ssrc-group that doesn't\r\n                // exist in our channel\r\n\r\n                if (!newMedia[othersMediaIdx]) {\r\n                    newMedia[othersMediaIdx] = {\r\n                        mediaindex: othersMedia.mediaindex,\r\n                        mid: othersMedia.mid,\r\n                        ssrcs: {},\r\n                        ssrcGroups: []\r\n                    };\r\n                }\r\n                newMedia[othersMediaIdx].ssrcGroups.push(otherSsrcGroup);\r\n            }\r\n        });\r\n    });\r\n\r\n    return newMedia;\r\n};\r\n\r\n/**\r\n * TODO: document!\r\n */\r\nSDPDiffer.prototype.toJingle = function(modify) {\r\n    const sdpMediaSsrcs = this.getNewMedia();\r\n\r\n    let modified = false;\r\n\r\n    Object.keys(sdpMediaSsrcs).forEach(mediaindex => {\r\n        modified = true;\r\n        const media = sdpMediaSsrcs[mediaindex];\r\n\r\n        modify.c('content', { name: media.mid });\r\n\r\n        modify.c('description',\r\n            { xmlns: 'urn:xmpp:jingle:apps:rtp:1',\r\n                media: media.mid });\r\n\r\n        // FIXME: not completely sure this operates on blocks and / or handles\r\n        // different ssrcs correctly\r\n        // generate sources from lines\r\n        Object.keys(media.ssrcs).forEach(ssrcNum => {\r\n            const mediaSsrc = media.ssrcs[ssrcNum];\r\n\r\n            modify.c('source', { xmlns: 'urn:xmpp:jingle:apps:rtp:ssma:0' });\r\n            modify.attrs({ ssrc: mediaSsrc.ssrc });\r\n\r\n            // iterate over ssrc lines\r\n            mediaSsrc.lines.forEach(line => {\r\n                const idx = line.indexOf(' ');\r\n                const kv = line.substr(idx + 1);\r\n\r\n                modify.c('parameter');\r\n                if (kv.indexOf(':') === -1) {\r\n                    modify.attrs({ name: kv });\r\n                } else {\r\n                    const nv = kv.split(':', 2);\r\n                    const name = nv[0];\r\n                    const value = SDPUtil.filterSpecialChars(nv[1]);\r\n\r\n                    modify.attrs({ name });\r\n                    modify.attrs({ value });\r\n                }\r\n                modify.up(); // end of parameter\r\n            });\r\n            modify.up(); // end of source\r\n        });\r\n\r\n        // generate source groups from lines\r\n        media.ssrcGroups.forEach(ssrcGroup => {\r\n            if (ssrcGroup.ssrcs.length) {\r\n\r\n                modify.c('ssrc-group', {\r\n                    semantics: ssrcGroup.semantics,\r\n                    xmlns: 'urn:xmpp:jingle:apps:rtp:ssma:0'\r\n                });\r\n\r\n                ssrcGroup.ssrcs.forEach(ssrc => {\r\n                    modify.c('source', { ssrc })\r\n                        .up(); // end of source\r\n                });\r\n                modify.up(); // end of ssrc-group\r\n            }\r\n        });\r\n\r\n        modify.up(); // end of description\r\n        modify.up(); // end of content\r\n    });\r\n\r\n    return modified;\r\n};\r\n","import { getLogger } from 'jitsi-meet-logger';\r\nimport transform from 'sdp-transform';\r\n\r\nimport MediaDirection from '../../service/RTC/MediaDirection';\r\nimport * as MediaType from '../../service/RTC/MediaType';\r\nimport browser from '../browser';\r\n\r\nconst logger = getLogger(__filename);\r\nconst SIM_LAYER_1_RID = '1';\r\n//const SIM_LAYER_2_RID = '2';\r\n//const SIM_LAYER_3_RID = '3';\r\n\r\nexport const SIM_LAYER_RIDS = [ SIM_LAYER_1_RID];    //, SIM_LAYER_2_RID, SIM_LAYER_3_RID ];\r\n\r\n/**\r\n * Handles track related operations on TraceablePeerConnection when browser is\r\n * running in unified plan mode.\r\n */\r\nexport class TPCUtils {\r\n    /**\r\n     * Creates a new instance for a given TraceablePeerConnection\r\n     *\r\n     * @param peerconnection - the tpc instance for which we have utility functions.\r\n     * @param videoBitrates - the bitrates to be configured on the video senders for\r\n     * different resolutions both in unicast and simulcast mode.\r\n     */\r\n    constructor(peerconnection, videoBitrates) {\r\n        this.pc = peerconnection;\r\n        this.videoBitrates = videoBitrates.VP8 || videoBitrates;\r\n\r\n        /**\r\n         * The startup configuration for the stream encodings that are applicable to\r\n         * the video stream when a new sender is created on the peerconnection. The initial\r\n         * config takes into account the differences in browser's simulcast implementation.\r\n         *\r\n         * Encoding parameters:\r\n         * active - determine the on/off state of a particular encoding.\r\n         * maxBitrate - max. bitrate value to be applied to that particular encoding\r\n         *  based on the encoding's resolution and config.js videoQuality settings if applicable.\r\n         * rid - Rtp Stream ID that is configured for a particular simulcast stream.\r\n         * scaleResolutionDownBy - the factor by which the encoding is scaled down from the\r\n         *  original resolution of the captured video.\r\n         */\r\n        this.localStreamEncodingsConfig = [\r\n            {\r\n                active: true,\r\n                maxBitrate: browser.isFirefox() ? this.videoBitrates.high : this.videoBitrates.low,\r\n                rid: SIM_LAYER_1_RID,\r\n                scaleResolutionDownBy: browser.isFirefox() ? 1.0 : 4.0\r\n            },\r\n/*            {\r\n                active: true,\r\n                maxBitrate: this.videoBitrates.standard,\r\n                rid: SIM_LAYER_2_RID,\r\n                scaleResolutionDownBy: 2.0\r\n            },\r\n            {\r\n                active: true,\r\n                maxBitrate: browser.isFirefox() ? this.videoBitrates.low : this.videoBitrates.high,\r\n                rid: SIM_LAYER_3_RID,\r\n                scaleResolutionDownBy: browser.isFirefox() ? 4.0 : 1.0\r\n            }*/\r\n        ];\r\n    }\r\n\r\n    /**\r\n     * Returns the transceiver associated with a given RTCRtpSender/RTCRtpReceiver.\r\n     *\r\n     * @param {string} mediaType - type of track associated with the transceiver 'audio' or 'video'.\r\n     * @param {JitsiLocalTrack} localTrack - local track to be used for lookup.\r\n     * @returns {RTCRtpTransceiver}\r\n     */\r\n    _findTransceiver(mediaType, localTrack = null) {\r\n        let transceiver = null;\r\n\r\n        // Check if the local track has been removed from the peerconnection already.\r\n        const trackRemoved = !localTrack\r\n            || (localTrack\r\n                && browser.doesVideoMuteByStreamRemove()\r\n                && localTrack.isVideoTrack()\r\n                && localTrack.isMuted());\r\n\r\n        if (trackRemoved) {\r\n            transceiver = this.pc.peerconnection.getTransceivers()\r\n                .find(t => t.receiver?.track?.kind === mediaType);\r\n        } else if (localTrack) {\r\n            transceiver = this.pc.peerconnection.getTransceivers()\r\n                .find(t => t.sender?.track?.id === localTrack.getTrackId());\r\n        }\r\n\r\n        return transceiver;\r\n    }\r\n\r\n    /**\r\n     * Obtains stream encodings that need to be configured on the given track based\r\n     * on the track media type and the simulcast setting.\r\n     * @param {JitsiLocalTrack} localTrack\r\n     */\r\n    _getStreamEncodings(localTrack) {\r\n        if (this.pc.isSimulcastOn() && localTrack.isVideoTrack()) {\r\n            return this.localStreamEncodingsConfig;\r\n        }\r\n\r\n        return localTrack.isVideoTrack()\r\n            ? [ {\r\n                active: true,\r\n                maxBitrate: this.videoBitrates.high\r\n            } ]\r\n            : [ { active: true } ];\r\n    }\r\n\r\n    /**\r\n     * Ensures that the ssrcs associated with a FID ssrc-group appear in the correct order, i.e.,\r\n     * the primary ssrc first and the secondary rtx ssrc later. This is important for unified\r\n     * plan since we have only one FID group per media description.\r\n     * @param {Object} description the webRTC session description instance for the remote\r\n     * description.\r\n     * @private\r\n     */\r\n    ensureCorrectOrderOfSsrcs(description) {\r\n        const parsedSdp = transform.parse(description.sdp);\r\n\r\n        parsedSdp.media.forEach(mLine => {\r\n            if (mLine.type === MediaType.AUDIO) {\r\n                return;\r\n            }\r\n            if (!mLine.ssrcGroups || !mLine.ssrcGroups.length) {\r\n                return;\r\n            }\r\n            let reorderedSsrcs = [];\r\n\r\n            mLine.ssrcGroups[0].ssrcs.split(' ').forEach(ssrc => {\r\n                const sources = mLine.ssrcs.filter(source => source.id.toString() === ssrc);\r\n\r\n                reorderedSsrcs = reorderedSsrcs.concat(sources);\r\n            });\r\n            mLine.ssrcs = reorderedSsrcs;\r\n        });\r\n\r\n        return new RTCSessionDescription({\r\n            type: description.type,\r\n            sdp: transform.write(parsedSdp)\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Takes in a *unified plan* offer and inserts the appropriate\r\n     * parameters for adding simulcast receive support.\r\n     * @param {Object} desc - A session description object\r\n     * @param {String} desc.type - the type (offer/answer)\r\n     * @param {String} desc.sdp - the sdp content\r\n     *\r\n     * @return {Object} A session description (same format as above) object\r\n     * with its sdp field modified to advertise simulcast receive support\r\n     */\r\n    insertUnifiedPlanSimulcastReceive(desc) {\r\n        // a=simulcast line is not needed on browsers where we SDP munging is used for enabling on simulcast.\r\n        // Remove this check when the client switches to RID/MID based simulcast on all browsers.\r\n        if (browser.usesSdpMungingForSimulcast()) {\r\n            return desc;\r\n        }\r\n        const sdp = transform.parse(desc.sdp);\r\n        const idx = sdp.media.findIndex(mline => mline.type === MediaType.VIDEO);\r\n\r\n        if (sdp.media[idx].rids && (sdp.media[idx].simulcast_03 || sdp.media[idx].simulcast)) {\r\n            // Make sure we don't have the simulcast recv line on video descriptions other than\r\n            // the first video description.\r\n            sdp.media.forEach((mline, i) => {\r\n                if (mline.type === MediaType.VIDEO && i !== idx) {\r\n                    sdp.media[i].rids = undefined;\r\n                    sdp.media[i].simulcast = undefined;\r\n\r\n                    // eslint-disable-next-line camelcase\r\n                    sdp.media[i].simulcast_03 = undefined;\r\n                }\r\n            });\r\n\r\n            return new RTCSessionDescription({\r\n                type: desc.type,\r\n                sdp: transform.write(sdp)\r\n            });\r\n        }\r\n\r\n        // In order of highest to lowest spatial quality\r\n        sdp.media[idx].rids = [\r\n            {\r\n                id: SIM_LAYER_1_RID,\r\n                direction: 'recv'\r\n            },\r\n            {\r\n                id: SIM_LAYER_2_RID,\r\n                direction: 'recv'\r\n            },\r\n            {\r\n                id: SIM_LAYER_3_RID,\r\n                direction: 'recv'\r\n            }\r\n        ];\r\n\r\n        // Firefox 72 has stopped parsing the legacy rid= parameters in simulcast attributes.\r\n        // eslint-disable-next-line max-len\r\n        // https://www.fxsitecompat.dev/en-CA/docs/2019/pt-and-rid-in-webrtc-simulcast-attributes-are-no-longer-supported/\r\n        const simulcastLine = browser.isFirefox() && browser.isVersionGreaterThan(71)\r\n            ? `recv ${SIM_LAYER_RIDS.join(';')}`\r\n            : `recv rid=${SIM_LAYER_RIDS.join(';')}`;\r\n\r\n        // eslint-disable-next-line camelcase\r\n        sdp.media[idx].simulcast_03 = {\r\n            value: simulcastLine\r\n        };\r\n\r\n        return new RTCSessionDescription({\r\n            type: desc.type,\r\n            sdp: transform.write(sdp)\r\n        });\r\n    }\r\n\r\n    /**\r\n    * Adds {@link JitsiLocalTrack} to the WebRTC peerconnection for the first time.\r\n    * @param {JitsiLocalTrack} track - track to be added to the peerconnection.\r\n    * @param {boolean} isInitiator - boolean that indicates if the endpoint is offerer in a p2p connection.\r\n    * @returns {void}\r\n    */\r\n    addTrack(localTrack, isInitiator) {\r\n        const track = localTrack.getTrack();\r\n\r\n        if (isInitiator) {\r\n            // Use pc.addTransceiver() for the initiator case when local tracks are getting added\r\n            // to the peerconnection before a session-initiate is sent over to the peer.\r\n            const transceiverInit = {\r\n                direction: MediaDirection.SENDRECV,\r\n                streams: [ localTrack.getOriginalStream() ],\r\n                sendEncodings: []\r\n            };\r\n\r\n            if (!browser.isFirefox()) {\r\n                transceiverInit.sendEncodings = this._getStreamEncodings(localTrack);\r\n            }\r\n            this.pc.peerconnection.addTransceiver(track, transceiverInit);\r\n        } else {\r\n            // Use pc.addTrack() for responder case so that we can re-use the m-lines that were created\r\n            // when setRemoteDescription was called. pc.addTrack() automatically  attaches to any existing\r\n            // unused \"recv-only\" transceiver.\r\n            this.pc.peerconnection.addTrack(track);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Adds a track on the RTCRtpSender as part of the unmute operation.\r\n     * @param {JitsiLocalTrack} localTrack - track to be unmuted.\r\n     * @returns {Promise<void>} - resolved when done.\r\n     */\r\n    addTrackUnmute(localTrack) {\r\n        const mediaType = localTrack.getType();\r\n        const track = localTrack.getTrack();\r\n        const transceiver = this._findTransceiver(mediaType);\r\n\r\n        if (!transceiver) {\r\n            return Promise.reject(new Error(`RTCRtpTransceiver for ${mediaType} not found`));\r\n        }\r\n        logger.debug(`${this.pc} Adding ${localTrack}`);\r\n\r\n        return transceiver.sender.replaceTrack(track);\r\n    }\r\n\r\n    /**\r\n     * Obtains the current local video track's height constraints based on the\r\n     * initial stream encodings configuration on the sender and the resolution\r\n     * of the current local track added to the peerconnection.\r\n     * @param {MediaStreamTrack} localTrack local video track\r\n     * @returns {Array[number]} an array containing the resolution heights of\r\n     * simulcast streams configured on the video sender.\r\n     */\r\n    getLocalStreamHeightConstraints(localTrack) {\r\n        // React-native hasn't implemented MediaStreamTrack getSettings yet.\r\n        if (browser.isReactNative()) {\r\n            return null;\r\n        }\r\n\r\n        const localVideoHeightConstraints = [];\r\n\r\n        // Firefox doesn't return the height of the desktop track, assume a min. height of 720.\r\n        const { height = 720 } = localTrack.getSettings();\r\n\r\n        for (const encoding of this.localStreamEncodingsConfig) {\r\n            localVideoHeightConstraints.push(height / encoding.scaleResolutionDownBy);\r\n        }\r\n\r\n        return localVideoHeightConstraints;\r\n    }\r\n\r\n    /**\r\n     * Removes the track from the RTCRtpSender as part of the mute operation.\r\n     * @param {JitsiLocalTrack} localTrack - track to be removed.\r\n     * @returns {Promise<void>} - resolved when done.\r\n     */\r\n    removeTrackMute(localTrack) {\r\n        const mediaType = localTrack.getType();\r\n        const transceiver = this._findTransceiver(mediaType, localTrack);\r\n\r\n        if (!transceiver) {\r\n            return Promise.reject(new Error(`RTCRtpTransceiver for ${mediaType} not found`));\r\n        }\r\n\r\n        logger.debug(`${this.pc} Removing ${localTrack}`);\r\n\r\n        return transceiver.sender.replaceTrack(null);\r\n    }\r\n\r\n    /**\r\n     * Replaces the existing track on a RTCRtpSender with the given track.\r\n     * @param {JitsiLocalTrack} oldTrack - existing track on the sender that needs to be removed.\r\n     * @param {JitsiLocalTrack} newTrack - new track that needs to be added to the sender.\r\n     * @returns {Promise<void>} - resolved when done.\r\n     */\r\n    replaceTrack(oldTrack, newTrack) {\r\n        if (oldTrack && newTrack) {\r\n            const mediaType = newTrack.getType();\r\n            const stream = newTrack.getOriginalStream();\r\n\r\n            // Ignore cases when the track is replaced while the device is in a muted state,like\r\n            // replacing camera when video muted or replacing mic when audio muted. These JitsiLocalTracks\r\n            // do not have a mediastream attached. Replace track will be called again when the device is\r\n            // unmuted and the track will be replaced on the peerconnection then.\r\n            if (!stream) {\r\n                this.pc.localTracks.delete(oldTrack.rtcId);\r\n                this.pc.localTracks.set(newTrack.rtcId, newTrack);\r\n\r\n                return Promise.resolve();\r\n            }\r\n\r\n            const transceiver = this._findTransceiver(mediaType, oldTrack);\r\n            const track = newTrack.getTrack();\r\n\r\n            if (!transceiver) {\r\n                return Promise.reject(new Error('replace track failed'));\r\n            }\r\n            logger.debug(`${this.pc} Replacing ${oldTrack} with ${newTrack}`);\r\n\r\n            return transceiver.sender.replaceTrack(track)\r\n                .then(() => {\r\n                    const ssrc = this.pc.localSSRCs.get(oldTrack.rtcId);\r\n\r\n                    this.pc.localTracks.delete(oldTrack.rtcId);\r\n                    this.pc.localSSRCs.delete(oldTrack.rtcId);\r\n                    this.pc._addedStreams = this.pc._addedStreams.filter(s => s !== stream);\r\n                    this.pc.localTracks.set(newTrack.rtcId, newTrack);\r\n\r\n                    this.pc._addedStreams.push(stream);\r\n                    this.pc.localSSRCs.set(newTrack.rtcId, ssrc);\r\n                });\r\n        } else if (oldTrack && !newTrack) {\r\n            return this.removeTrackMute(oldTrack)\r\n                .then(() => {\r\n                    const mediaType = oldTrack.getType();\r\n                    const transceiver = this._findTransceiver(mediaType);\r\n\r\n                    // Change the direction on the transceiver to 'recvonly' so that a 'removetrack'\r\n                    // is fired on the associated media stream on the remote peer.\r\n                    if (transceiver) {\r\n                        transceiver.direction = MediaDirection.RECVONLY;\r\n                    }\r\n\r\n                    // Remove the old track from the list of local tracks.\r\n                    this.pc.localTracks.delete(oldTrack.rtcId);\r\n                    this.pc.localSSRCs.delete(oldTrack.rtcId);\r\n                });\r\n        } else if (newTrack && !oldTrack) {\r\n            return this.addTrackUnmute(newTrack)\r\n                .then(() => {\r\n                    const mediaType = newTrack.getType();\r\n                    const transceiver = this._findTransceiver(mediaType, newTrack);\r\n\r\n                    // Change the direction on the transceiver back to 'sendrecv' so that a 'track'\r\n                    // event is fired on the remote peer.\r\n                    if (transceiver) {\r\n                        transceiver.direction = MediaDirection.SENDRECV;\r\n                    }\r\n\r\n                    // Avoid configuring the encodings on Chromium/Safari until simulcast is configured\r\n                    // for the newly added track using SDP munging which happens during the renegotiation.\r\n                    const promise = browser.usesSdpMungingForSimulcast()\r\n                        ? Promise.resolve()\r\n                        : this.setEncodings(newTrack);\r\n\r\n                    return promise\r\n                        .then(() => {\r\n                            // Add the new track to the list of local tracks.\r\n                            this.pc.localTracks.set(newTrack.rtcId, newTrack);\r\n                        });\r\n                });\r\n        }\r\n\r\n        logger.info(`${this.pc} TPCUtils.replaceTrack called with no new track and no old track`);\r\n\r\n        return Promise.resolve();\r\n    }\r\n\r\n    /**\r\n    * Enables/disables audio transmission on the peer connection. When\r\n    * disabled the audio transceiver direction will be set to 'inactive'\r\n    * which means that no data will be sent nor accepted, but\r\n    * the connection should be kept alive.\r\n    * @param {boolean} active - true to enable audio media transmission or\r\n    * false to disable.\r\n    * @returns {void}\r\n    */\r\n    setAudioTransferActive(active) {\r\n        this.setMediaTransferActive(MediaType.AUDIO, active);\r\n    }\r\n\r\n    /**\r\n     * Set the simulcast stream encoding properties on the RTCRtpSender.\r\n     * @param {JitsiLocalTrack} track - the current track in use for which\r\n     * the encodings are to be set.\r\n     * @returns {Promise<void>} - resolved when done.\r\n     */\r\n    setEncodings(track) {\r\n        const mediaType = track.getType();\r\n        const transceiver = this._findTransceiver(mediaType, track);\r\n        const parameters = transceiver?.sender?.getParameters();\r\n\r\n        // Resolve if the encodings are not available yet. This happens immediately after the track is added to the\r\n        // peerconnection on chrome in unified-plan. It is ok to ignore and not report the error here since the\r\n        // action that triggers 'addTrack' (like unmute) will also configure the encodings and set bitrates after that.\r\n        if (!parameters?.encodings?.length) {\r\n            return Promise.resolve();\r\n        }\r\n        parameters.encodings = this._getStreamEncodings(track);\r\n\r\n        return transceiver.sender.setParameters(parameters);\r\n    }\r\n\r\n    /**\r\n     * Enables/disables media transmission on the peerconnection by changing the direction\r\n     * on the transceiver for the specified media type.\r\n     * @param {String} mediaType - 'audio' or 'video'\r\n     * @param {boolean} active - true to enable media transmission or false\r\n     * to disable.\r\n     * @returns {void}\r\n     */\r\n    setMediaTransferActive(mediaType, active) {\r\n        const transceivers = this.pc.peerconnection.getTransceivers()\r\n            .filter(t => t.receiver && t.receiver.track && t.receiver.track.kind === mediaType);\r\n        const localTracks = this.pc.getLocalTracks(mediaType);\r\n\r\n        logger.info(`${this.pc} ${active ? 'Enabling' : 'Suspending'} ${mediaType} media transfer.`);\r\n        transceivers.forEach((transceiver, idx) => {\r\n            if (active) {\r\n                // The first transceiver is for the local track and only this one can be set to 'sendrecv'\r\n                if (idx === 0 && localTracks.length) {\r\n                    transceiver.direction = MediaDirection.SENDRECV;\r\n                } else {\r\n                    transceiver.direction = MediaDirection.RECVONLY;\r\n                }\r\n            } else {\r\n                transceiver.direction = MediaDirection.INACTIVE;\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n    * Enables/disables video media transmission on the peer connection. When\r\n    * disabled the SDP video media direction in the local SDP will be adjusted to\r\n    * 'inactive' which means that no data will be sent nor accepted, but\r\n    * the connection should be kept alive.\r\n    * @param {boolean} active - true to enable video media transmission or\r\n    * false to disable.\r\n    * @returns {void}\r\n    */\r\n    setVideoTransferActive(active) {\r\n        this.setMediaTransferActive(MediaType.VIDEO, active);\r\n    }\r\n\r\n    /**\r\n     * Ensures that the resolution of the stream encodings are consistent with the values\r\n     * that were configured on the RTCRtpSender when the source was added to the peerconnection.\r\n     * This should prevent us from overriding the default values if the browser returns\r\n     * erroneous values when RTCRtpSender.getParameters is used for getting the encodings info.\r\n     * @param {Object} parameters - the RTCRtpEncodingParameters obtained from the browser.\r\n     * @returns {void}\r\n     */\r\n    updateEncodingsResolution(parameters) {\r\n        if (!(browser.isWebKitBased() && parameters.encodings && Array.isArray(parameters.encodings))) {\r\n            return;\r\n        }\r\n        const allEqualEncodings\r\n            = encodings => encodings.every(encoding => typeof encoding.scaleResolutionDownBy !== 'undefined'\r\n                && encoding.scaleResolutionDownBy === encodings[0].scaleResolutionDownBy);\r\n\r\n        // Implement the workaround only when all the encodings report the same resolution.\r\n        if (allEqualEncodings(parameters.encodings)) {\r\n            parameters.encodings.forEach((encoding, idx) => {\r\n                encoding.scaleResolutionDownBy = this.localStreamEncodingsConfig[idx].scaleResolutionDownBy;\r\n            });\r\n        }\r\n    }\r\n}\r\n","import {ConnectionStates, ConnectionStatesType} from '@models/api'\r\nimport {action, makeObservable, observable} from 'mobx'\r\nimport {Store} from './utils'\r\n\r\nexport interface IConnectionInfo {\r\n  apiVersion: string,\r\n  state: ConnectionStatesType,\r\n}\r\n\r\nexport class ConnectionInfo implements Store<IConnectionInfo> {\r\n  apiVersion: string\r\n  @observable\r\n  state: ConnectionStatesType\r\n\r\n  constructor() {\r\n    makeObservable(this)\r\n    this.apiVersion = 'INVALID'\r\n    this.state = ConnectionStates.DISCONNECTED\r\n  }\r\n\r\n  @action\r\n    changeState(newState: ConnectionStatesType) {\r\n    this.state = newState\r\n  }\r\n}\r\n\r\nexport default new ConnectionInfo()\r\n","// config.js\r\ndeclare const config:any             //  from ../../config.js included from index.html\r\nexport const CORS_PROXY_URL = config.corsProxyUrl || 'https://binaural.me/cors_proxy/'\r\n\r\nexport function getProxiedUrl(url:string){\r\n  const heads = ['http://', 'https://']\r\n  let rv = url\r\n  heads.forEach((head) => {\r\n    if (url.substring(0, head.length) === head){\r\n      rv = url.substring(head.length)\r\n    }\r\n  })\r\n  rv = `${CORS_PROXY_URL}${rv}`\r\n\r\n  return rv\r\n}\r\n","/**\r\n * Provides statistics for the local stream.\r\n */\r\n\r\n/**\r\n * Size of the webaudio analyzer buffer.\r\n * @type {number}\r\n */\r\nconst WEBAUDIO_ANALYZER_FFT_SIZE = 2048;\r\n\r\n/**\r\n * Value of the webaudio analyzer smoothing time parameter.\r\n * @type {number}\r\n */\r\nconst WEBAUDIO_ANALYZER_SMOOTING_TIME = 0.8;\r\n\r\nwindow.AudioContext = window.AudioContext || window.webkitAudioContext;\r\n\r\nlet context = null;\r\n\r\nif (window.AudioContext) {\r\n    context = new AudioContext();\r\n\r\n    // XXX Not all browsers define a suspend method on AudioContext. As the\r\n    // invocation is at the (ES6 module) global execution level, it breaks the\r\n    // loading of the lib-jitsi-meet library in such browsers and, consequently,\r\n    // the loading of the very Web app that uses the lib-jitsi-meet library. For\r\n    // example, Google Chrome 40 on Android does not define the method but we\r\n    // still want to be able to load the lib-jitsi-meet library there and\r\n    // display a page which notifies the user that the Web app is not supported\r\n    // there.\r\n    context.suspend && context.suspend();\r\n}\r\n\r\n/**\r\n * Converts time domain data array to audio level.\r\n * @param samples the time domain data array.\r\n * @returns {number} the audio level\r\n */\r\nfunction timeDomainDataToAudioLevel(samples) {\r\n\r\n    let maxVolume = 0;\r\n\r\n    const length = samples.length;\r\n\r\n    for (let i = 0; i < length; i++) {\r\n        if (maxVolume < samples[i]) {\r\n            maxVolume = samples[i];\r\n        }\r\n    }\r\n\r\n    return parseFloat(((maxVolume - 127) / 128).toFixed(3));\r\n}\r\n\r\n/**\r\n * Animates audio level change\r\n * @param newLevel the new audio level\r\n * @param lastLevel the last audio level\r\n * @returns {Number} the audio level to be set\r\n */\r\nfunction animateLevel(newLevel, lastLevel) {\r\n    let value = 0;\r\n    const diff = lastLevel - newLevel;\r\n\r\n    if (diff > 0.2) {\r\n        value = lastLevel - 0.2;\r\n    } else if (diff < -0.4) {\r\n        value = lastLevel + 0.4;\r\n    } else {\r\n        value = newLevel;\r\n    }\r\n\r\n    return parseFloat(value.toFixed(3));\r\n}\r\n\r\n\r\n/**\r\n * <tt>LocalStatsCollector</tt> calculates statistics for the local stream.\r\n *\r\n * @param stream the local stream\r\n * @param interval stats refresh interval given in ms.\r\n * @param callback function that receives the audio levels.\r\n * @constructor\r\n */\r\nexport default function LocalStatsCollector(stream, interval, callback) {\r\n    this.stream = stream;\r\n    this.intervalId = null;\r\n    this.intervalMilis = interval;\r\n    this.audioLevel = 0;\r\n    this.callback = callback;\r\n}\r\n\r\n/**\r\n * Starts the collecting the statistics.\r\n */\r\nLocalStatsCollector.prototype.start = function() {\r\n    if (!LocalStatsCollector.isLocalStatsSupported()) {\r\n        return;\r\n    }\r\n    context.resume();\r\n    const analyser = context.createAnalyser();\r\n\r\n    analyser.smoothingTimeConstant = WEBAUDIO_ANALYZER_SMOOTING_TIME;\r\n    analyser.fftSize = WEBAUDIO_ANALYZER_FFT_SIZE;\r\n\r\n    const source = context.createMediaStreamSource(this.stream);\r\n\r\n    source.connect(analyser);\r\n\r\n    this.intervalId = setInterval(\r\n        () => {\r\n            const array = new Uint8Array(analyser.frequencyBinCount);\r\n\r\n            analyser.getByteTimeDomainData(array);\r\n            const audioLevel = timeDomainDataToAudioLevel(array);\r\n\r\n            // Set the audio levels always as NoAudioSignalDetection now\r\n            // uses audio levels from LocalStatsCollector and waits for\r\n            // atleast 4 secs for a no audio signal before displaying the\r\n            // notification on the UI.\r\n            this.audioLevel = animateLevel(audioLevel, this.audioLevel);\r\n            this.callback(this.audioLevel);\r\n        },\r\n        this.intervalMilis\r\n    );\r\n};\r\n\r\n/**\r\n * Stops collecting the statistics.\r\n */\r\nLocalStatsCollector.prototype.stop = function() {\r\n    if (this.intervalId) {\r\n        clearInterval(this.intervalId);\r\n        this.intervalId = null;\r\n    }\r\n};\r\n\r\n/**\r\n * Checks if the environment has the necessary conditions to support\r\n * collecting stats from local streams.\r\n *\r\n * @returns {boolean}\r\n */\r\nLocalStatsCollector.isLocalStatsSupported = function() {\r\n    return Boolean(context);\r\n};\r\n","/**\r\n * The transciption is on.\r\n *\r\n * @type {String}\r\n */\r\nexport const ON = 'on';\r\n\r\n/**\r\n * The transciption is off.\r\n *\r\n * @type {String}\r\n */\r\nexport const OFF = 'off';\r\n","export default {\r\n    /**\r\n     * Event triggered when the remote party signals it's receive video max frame height.\r\n     */\r\n    REMOTE_VIDEO_CONSTRAINTS_CHANGED: 'media_session.REMOTE_VIDEO_CONSTRAINTS_CHANGED'\r\n};\r\n","/* global __filename, module */\r\nimport EventEmitter from 'events';\r\nimport { getLogger } from 'jitsi-meet-logger';\r\n\r\nimport * as JitsiTrackEvents from '../../JitsiTrackEvents';\r\nimport * as MediaType from '../../service/RTC/MediaType';\r\nimport browser from '../browser';\r\n\r\nimport RTCUtils from './RTCUtils';\r\n\r\nconst logger = getLogger(__filename);\r\n\r\n/**\r\n * Maps our handler types to MediaStreamTrack properties.\r\n */\r\nconst trackHandler2Prop = {\r\n    'track_mute': 'onmute', // Not supported on FF\r\n    'track_unmute': 'onunmute',\r\n    'track_ended': 'onended'\r\n};\r\n\r\n/**\r\n * Represents a single media track (either audio or video).\r\n */\r\nexport default class JitsiTrack extends EventEmitter {\r\n    /* eslint-disable max-params */\r\n    /**\r\n     * Represents a single media track (either audio or video).\r\n     * @constructor\r\n     * @param conference the rtc instance\r\n     * @param stream the WebRTC MediaStream instance\r\n     * @param track the WebRTC MediaStreamTrack instance, must be part of\r\n     * the given <tt>stream</tt>.\r\n     * @param streamInactiveHandler the function that will handle\r\n     *        onended/oninactive events of the stream.\r\n     * @param trackMediaType the media type of the JitsiTrack\r\n     * @param videoType the VideoType for this track if any\r\n     */\r\n    constructor(\r\n            conference,\r\n            stream,\r\n            track,\r\n            streamInactiveHandler,\r\n            trackMediaType,\r\n            videoType) {\r\n        super();\r\n\r\n        // aliases for addListener/removeListener\r\n        this.addEventListener = this.addListener;\r\n        this.removeEventListener = this.off = this.removeListener;\r\n\r\n        /**\r\n         * Array with the HTML elements that are displaying the streams.\r\n         * @type {Array}\r\n         */\r\n        this.containers = [];\r\n        this.conference = conference;\r\n        this.audioLevel = -1;\r\n        this.type = trackMediaType;\r\n        this.track = track;\r\n        this.videoType = videoType;\r\n        this.handlers = new Map();\r\n\r\n        /**\r\n         * Indicates whether this JitsiTrack has been disposed. If true, this\r\n         * JitsiTrack is to be considered unusable and operations involving it\r\n         * are to fail (e.g. {@link JitsiConference#addTrack(JitsiTrack)},\r\n         * {@link JitsiConference#removeTrack(JitsiTrack)}).\r\n         * @type {boolean}\r\n         */\r\n        this.disposed = false;\r\n\r\n        /**\r\n         * The inactive handler which will be triggered when the underlying\r\n         * <tt>MediaStream</tt> ends.\r\n         *\r\n         * @private\r\n         * @type {Function}\r\n         */\r\n        this._streamInactiveHandler = streamInactiveHandler;\r\n\r\n        this._setStream(stream);\r\n    }\r\n\r\n    /* eslint-enable max-params */\r\n\r\n    /**\r\n     * Adds onended/oninactive handler to a MediaStream or a MediaStreamTrack.\r\n     * Firefox doesn't fire a inactive event on the MediaStream, instead it fires\r\n     * a onended event on the MediaStreamTrack.\r\n     * @param {Function} handler the handler\r\n     */\r\n    _addMediaStreamInactiveHandler(handler) {\r\n        if (browser.isFirefox()) {\r\n            this.track.onended = handler;\r\n        } else {\r\n            this.stream.oninactive = handler;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Sets handler to the WebRTC MediaStream or MediaStreamTrack object\r\n     * depending on the passed type.\r\n     * @param {string} type the type of the handler that is going to be set\r\n     * @param {Function} handler the handler.\r\n     */\r\n    _setHandler(type, handler) {\r\n        if (!trackHandler2Prop.hasOwnProperty(type)) {\r\n            logger.error(`Invalid handler type ${type}`);\r\n\r\n            return;\r\n        }\r\n        if (handler) {\r\n            this.handlers.set(type, handler);\r\n        } else {\r\n            this.handlers.delete(type);\r\n        }\r\n\r\n        if (this.stream) {\r\n            for (const track of this.stream.getTracks()) {\r\n                track[trackHandler2Prop[type]] = handler;\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Unregisters all event handlers bound to the underlying media stream/track\r\n     * @private\r\n     */\r\n    _unregisterHandlers() {\r\n        if (!this.stream) {\r\n            logger.warn(\r\n                `${this}: unable to unregister handlers - no stream object`);\r\n\r\n            return;\r\n        }\r\n\r\n        for (const type of this.handlers.keys()) {\r\n            // FIXME Why only video tracks?\r\n            for (const videoTrack of this.stream.getVideoTracks()) {\r\n                videoTrack[trackHandler2Prop[type]] = undefined;\r\n            }\r\n        }\r\n        if (this._streamInactiveHandler) {\r\n            this._addMediaStreamInactiveHandler(undefined);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Sets the stream property of JitsiTrack object and sets all stored\r\n     * handlers to it.\r\n     *\r\n     * @param {MediaStream} stream the new stream.\r\n     * @protected\r\n     */\r\n    _setStream(stream) {\r\n        if (this.stream === stream) {\r\n            return;\r\n        }\r\n\r\n        this.stream = stream;\r\n\r\n        // TODO Practically, that's like the opposite of _unregisterHandlers\r\n        // i.e. may be abstracted into a function/method called\r\n        // _registerHandlers for clarity and easing the maintenance of the two\r\n        // pieces of source code.\r\n        if (this.stream) {\r\n            for (const type of this.handlers.keys()) {\r\n                this._setHandler(type, this.handlers.get(type));\r\n            }\r\n            if (this._streamInactiveHandler) {\r\n                this._addMediaStreamInactiveHandler(this._streamInactiveHandler);\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Returns the type (audio or video) of this track.\r\n     */\r\n    getType() {\r\n        return this.type;\r\n    }\r\n\r\n    /**\r\n     * Check if this is an audio track.\r\n     */\r\n    isAudioTrack() {\r\n        return this.getType() === MediaType.AUDIO;\r\n    }\r\n\r\n    /**\r\n     * Checks whether the underlying WebRTC <tt>MediaStreamTrack</tt> is muted\r\n     * according to it's 'muted' field status.\r\n     * @return {boolean} <tt>true</tt> if the underlying\r\n     * <tt>MediaStreamTrack</tt> is muted or <tt>false</tt> otherwise.\r\n     */\r\n    isWebRTCTrackMuted() {\r\n        return this.track && this.track.muted;\r\n    }\r\n\r\n    /**\r\n     * Check if this is a video track.\r\n     */\r\n    isVideoTrack() {\r\n        return this.getType() === MediaType.VIDEO;\r\n    }\r\n\r\n    /**\r\n     * Checks whether this is a local track.\r\n     * @abstract\r\n     * @return {boolean} 'true' if it's a local track or 'false' otherwise.\r\n     */\r\n    isLocal() {\r\n        throw new Error('Not implemented by subclass');\r\n    }\r\n\r\n    /**\r\n     * Check whether this is a local audio track.\r\n     *\r\n     * @return {boolean} -  true if track represents a local audio track, false otherwise.\r\n     */\r\n    isLocalAudioTrack() {\r\n        return this.isAudioTrack() && this.isLocal();\r\n    }\r\n\r\n    /**\r\n     * Returns the WebRTC MediaStream instance.\r\n     */\r\n    getOriginalStream() {\r\n        return this.stream;\r\n    }\r\n\r\n    /**\r\n     * Returns the ID of the underlying WebRTC Media Stream(if any)\r\n     * @returns {String|null}\r\n     */\r\n    getStreamId() {\r\n        return this.stream ? this.stream.id : null;\r\n    }\r\n\r\n    /**\r\n     * Return the underlying WebRTC MediaStreamTrack\r\n     * @returns {MediaStreamTrack}\r\n     */\r\n    getTrack() {\r\n        return this.track;\r\n    }\r\n\r\n    /**\r\n     * Return the underlying WebRTC MediaStreamTrack label\r\n     * @returns {string}\r\n     */\r\n    getTrackLabel() {\r\n        return this.track.label;\r\n    }\r\n\r\n    /**\r\n     * Returns the ID of the underlying WebRTC MediaStreamTrack(if any)\r\n     * @returns {String|null}\r\n     */\r\n    getTrackId() {\r\n        return this.track ? this.track.id : null;\r\n    }\r\n\r\n    /**\r\n     * Return meaningful usage label for this track depending on it's media and\r\n     * eventual video type.\r\n     * @returns {string}\r\n     */\r\n    getUsageLabel() {\r\n        if (this.isAudioTrack()) {\r\n            return 'mic';\r\n        }\r\n\r\n        return this.videoType ? this.videoType : 'default';\r\n    }\r\n\r\n    /**\r\n     * Eventually will trigger RTCEvents.TRACK_ATTACHED event.\r\n     * @param container the video/audio container to which this stream is\r\n     *        attached and for which event will be fired.\r\n     * @private\r\n     */\r\n    _maybeFireTrackAttached(container) {\r\n        if (this.conference && container) {\r\n            this.conference._onTrackAttach(this, container);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Attaches the MediaStream of this track to an HTML container.\r\n     * Adds the container to the list of containers that are displaying the\r\n     * track.\r\n     *\r\n     * @param container the HTML container which can be 'video' or 'audio'\r\n     * element.\r\n     *\r\n     * @returns {void}\r\n     */\r\n    attach(container) {\r\n        if (this.stream) {\r\n            this._onTrackAttach(container);\r\n            RTCUtils.attachMediaStream(container, this.stream);\r\n        }\r\n        this.containers.push(container);\r\n        this._maybeFireTrackAttached(container);\r\n        this._attachTTFMTracker(container);\r\n    }\r\n\r\n    /**\r\n     * Removes this JitsiTrack from the passed HTML container.\r\n     *\r\n     * @param container the HTML container to detach from this JitsiTrack. If\r\n     * <tt>null</tt> or <tt>undefined</tt>, all containers are removed. A\r\n     * container can be a 'video', 'audio' or 'object' HTML element instance to\r\n     * which this JitsiTrack is currently attached.\r\n     */\r\n    detach(container) {\r\n        for (let cs = this.containers, i = cs.length - 1; i >= 0; --i) {\r\n            const c = cs[i];\r\n\r\n            if (!container) {\r\n                this._onTrackDetach(c);\r\n                RTCUtils.attachMediaStream(c, null);\r\n            }\r\n            if (!container || c === container) {\r\n                cs.splice(i, 1);\r\n            }\r\n        }\r\n\r\n        if (container) {\r\n            this._onTrackDetach(container);\r\n            RTCUtils.attachMediaStream(container, null);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Called when the track has been attached to a new container.\r\n     *\r\n     * @param {HTMLElement} container the HTML container which can be 'video' or\r\n     * 'audio' element.\r\n     * @private\r\n     */\r\n    _onTrackAttach(container) { // eslint-disable-line no-unused-vars\r\n        // Should be defined by the classes that are extending JitsiTrack\r\n    }\r\n\r\n    /**\r\n     * Called when the track has been detached from a container.\r\n     *\r\n     * @param {HTMLElement} container the HTML container which can be 'video' or\r\n     * 'audio' element.\r\n     * @private\r\n     */\r\n    _onTrackDetach(container) { // eslint-disable-line no-unused-vars\r\n        // Should be defined by the classes that are extending JitsiTrack\r\n    }\r\n\r\n    /**\r\n     * Attach time to first media tracker only if there is conference and only\r\n     * for the first element.\r\n     *\r\n     * @param {HTMLElement} container the HTML container which can be 'video' or\r\n     * 'audio' element.\r\n     * @private\r\n     */\r\n    _attachTTFMTracker(container) { // eslint-disable-line no-unused-vars\r\n        // Should be defined by the classes that are extending JitsiTrack\r\n    }\r\n\r\n    /**\r\n     * Removes attached event listeners.\r\n     *\r\n     * @returns {Promise}\r\n     */\r\n    dispose() {\r\n        this.removeAllListeners();\r\n\r\n        this.disposed = true;\r\n\r\n        return Promise.resolve();\r\n    }\r\n\r\n    /**\r\n     * Returns true if this is a video track and the source of the video is a\r\n     * screen capture as opposed to a camera.\r\n     */\r\n    isScreenSharing() {\r\n        // FIXME: Should be fixed or removed.\r\n    }\r\n\r\n    /**\r\n     * Returns id of the track.\r\n     * @returns {string|null} id of the track or null if this is fake track.\r\n     */\r\n    getId() {\r\n        if (this.stream) {\r\n            return RTCUtils.getStreamID(this.stream);\r\n        }\r\n\r\n        return null;\r\n    }\r\n\r\n    /**\r\n     * Checks whether the MediaStream is active/not ended.\r\n     * When there is no check for active we don't have information and so\r\n     * will return that stream is active (in case of FF).\r\n     * @returns {boolean} whether MediaStream is active.\r\n     */\r\n    isActive() {\r\n        if (typeof this.stream.active !== 'undefined') {\r\n            return this.stream.active;\r\n        }\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Sets the audio level for the stream\r\n     * @param {number} audioLevel value between 0 and 1\r\n     * @param {TraceablePeerConnection} [tpc] the peerconnection instance which\r\n     * is source for the audio level. It can be <tt>undefined</tt> for\r\n     * a local track if the audio level was measured outside of the\r\n     * peerconnection (see /modules/statistics/LocalStatsCollector.js).\r\n     */\r\n    setAudioLevel(audioLevel, tpc) {\r\n        let newAudioLevel = audioLevel;\r\n\r\n        // When using getSynchornizationSources on the audio receiver to gather audio levels for\r\n        // remote tracks, browser reports last known audio levels even when the remote user is\r\n        // audio muted, we need to reset the value to zero here so that the audio levels are cleared.\r\n        // Remote tracks have the tpc info present while local tracks do not.\r\n        if (browser.supportsReceiverStats() && typeof tpc !== 'undefined' && this.isMuted()) {\r\n            newAudioLevel = 0;\r\n        }\r\n\r\n        if (this.audioLevel !== newAudioLevel) {\r\n            this.audioLevel = newAudioLevel;\r\n            this.emit(\r\n                JitsiTrackEvents.TRACK_AUDIO_LEVEL_CHANGED,\r\n                newAudioLevel,\r\n                tpc);\r\n\r\n        // LocalStatsCollector reports a value of 0.008 for muted mics\r\n        // and a value of 0 when there is no audio input.\r\n        } else if (this.audioLevel === 0\r\n            && newAudioLevel === 0\r\n            && this.isLocal()\r\n            && !this.isWebRTCTrackMuted()) {\r\n            this.emit(\r\n                JitsiTrackEvents.NO_AUDIO_INPUT,\r\n                newAudioLevel);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Returns the msid of the stream attached to the JitsiTrack object or null\r\n     * if no stream is attached.\r\n     */\r\n    getMSID() {\r\n        const streamId = this.getStreamId();\r\n        const trackId = this.getTrackId();\r\n\r\n        return streamId && trackId ? `${streamId} ${trackId}` : null;\r\n    }\r\n\r\n    /**\r\n     * Sets new audio output device for track's DOM elements. Video tracks are\r\n     * ignored.\r\n     * @param {string} audioOutputDeviceId - id of 'audiooutput' device from\r\n     *      navigator.mediaDevices.enumerateDevices(), '' for default device\r\n     * @emits JitsiTrackEvents.TRACK_AUDIO_OUTPUT_CHANGED\r\n     * @returns {Promise}\r\n     */\r\n    setAudioOutput(audioOutputDeviceId) {\r\n        if (!RTCUtils.isDeviceChangeAvailable('output')) {\r\n            return Promise.reject(\r\n                new Error('Audio output device change is not supported'));\r\n        }\r\n\r\n        // All audio communication is done through audio tracks, so ignore\r\n        // changing audio output for video tracks at all.\r\n        if (this.isVideoTrack()) {\r\n            return Promise.resolve();\r\n        }\r\n\r\n        return (\r\n            Promise.all(\r\n                this.containers.map(\r\n                    element =>\r\n                        element.setSinkId(audioOutputDeviceId)\r\n                            .catch(error => {\r\n                                logger.warn(\r\n                                    'Failed to change audio output device on'\r\n                                        + ' element. Default or previously set'\r\n                                        + ' audio output device will be used.',\r\n                                    element,\r\n                                    error);\r\n                                throw error;\r\n                            }))\r\n            )\r\n                .then(() => {\r\n                    this.emit(\r\n                        JitsiTrackEvents.TRACK_AUDIO_OUTPUT_CHANGED,\r\n                        audioOutputDeviceId);\r\n                }));\r\n    }\r\n}\r\n","const Resolutions = {\r\n    '2160': {\r\n        width: 3840,\r\n        height: 2160\r\n    },\r\n    '4k': {\r\n        width: 3840,\r\n        height: 2160\r\n    },\r\n    '1080': {\r\n        width: 1920,\r\n        height: 1080\r\n    },\r\n    'fullhd': {\r\n        width: 1920,\r\n        height: 1080\r\n    },\r\n    '720': {\r\n        width: 1280,\r\n        height: 720\r\n    },\r\n    'hd': {\r\n        width: 1280,\r\n        height: 720\r\n    },\r\n    '540': {\r\n        width: 960,\r\n        height: 540\r\n    },\r\n    'qhd': {\r\n        width: 960,\r\n        height: 540\r\n    },\r\n    '480': {\r\n        width: 640,\r\n        height: 480\r\n    },\r\n    'vga': {\r\n        width: 640,\r\n        height: 480\r\n    },\r\n    '360': {\r\n        width: 640,\r\n        height: 360\r\n    },\r\n    '240': {\r\n        width: 320,\r\n        height: 240\r\n    },\r\n    '180': {\r\n        width: 320,\r\n        height: 180\r\n    }\r\n};\r\n\r\nmodule.exports = Resolutions;\r\n","import EventEmitter from 'events';\r\n\r\nimport RTC from '../RTC/RTC';\r\nimport { createAudioContext } from '../webaudio/WebAudioUtils';\r\n\r\nimport { VAD_SCORE_PUBLISHED } from './DetectionEvents';\r\n\r\n/**\r\n * Connects an audio JitsiLocalTrack to a vadProcessor using WebAudio ScriptProcessorNode.\r\n * Once an object is created audio from the local track flows through the ScriptProcessorNode as raw PCM.\r\n * The PCM is processed by the injected vad module and a voice activity detection score is obtained, the\r\n * score is published to consumers via an EventEmitter.\r\n * After work is done with this service the destroy method needs to be called for a proper cleanup.\r\n *\r\n * @fires VAD_SCORE_PUBLISHED\r\n */\r\nexport default class TrackVADEmitter extends EventEmitter {\r\n    /**\r\n     * Constructor.\r\n     *\r\n     * @param {number} procNodeSampleRate - Sample rate of the ScriptProcessorNode. Possible values  256, 512, 1024,\r\n     *  2048, 4096, 8192, 16384. Passing other values will default to closes neighbor.\r\n     * @param {Object} vadProcessor - VAD processor that allows us to calculate VAD score for PCM samples.\r\n     * @param {JitsiLocalTrack} jitsiLocalTrack - JitsiLocalTrack corresponding to micDeviceId.\r\n     */\r\n    constructor(procNodeSampleRate, vadProcessor, jitsiLocalTrack) {\r\n        super();\r\n\r\n        /**\r\n         * Sample rate of the ScriptProcessorNode.\r\n         */\r\n        this._procNodeSampleRate = procNodeSampleRate;\r\n\r\n        /**\r\n         * VAD Processor that allows us to calculate VAD score for PCM samples\r\n         */\r\n        this._vadProcessor = vadProcessor;\r\n\r\n        /**\r\n         * The JitsiLocalTrack instance.\r\n         */\r\n        this._localTrack = jitsiLocalTrack;\r\n\r\n        /**\r\n         * Buffer to hold residue PCM resulting after a ScriptProcessorNode callback\r\n         */\r\n        this._bufferResidue = new Float32Array([]);\r\n\r\n        /**\r\n         * The AudioContext instance with the preferred sample frequency.\r\n         */\r\n        this._audioContext = createAudioContext({ sampleRate: vadProcessor.getRequiredPCMFrequency() });\r\n\r\n        /**\r\n         * PCM Sample size expected by the VAD Processor instance. We cache it here as this value is used extensively,\r\n         * saves a couple of function calls.\r\n         */\r\n        this._vadSampleSize = vadProcessor.getSampleLength();\r\n\r\n        /**\r\n         * Event listener function that will be called by the ScriptProcessNode with raw PCM data, depending on the set\r\n         * sample rate.\r\n         */\r\n        this._onAudioProcess = this._onAudioProcess.bind(this);\r\n\r\n        this._initializeAudioContext();\r\n    }\r\n\r\n    /**\r\n     * Factory method that sets up all the necessary components for the creation of the TrackVADEmitter.\r\n     *\r\n     * @param {string} micDeviceId - Target microphone device id.\r\n     * @param {number} procNodeSampleRate - Sample rate of the proc node.\r\n     * @param {Object} vadProcessor -Module that calculates the voice activity score for a certain audio PCM sample.\r\n     * The processor needs to implement the following functions:\r\n     * - <tt>getSampleLength()</tt> - Returns the sample size accepted by getSampleLength.\r\n     * - <tt>getRequiredPCMFrequency()</tt> - Returns the PCM frequency at which the processor operates.\r\n     * - <tt>calculateAudioFrameVAD(pcmSample)</tt> - Process a 32 float pcm sample of getSampleLength size.\r\n     * @returns {Promise<TrackVADEmitter>} - Promise resolving in a new instance of TrackVADEmitter.\r\n     */\r\n    static create(micDeviceId, procNodeSampleRate, vadProcessor) {\r\n        return RTC.obtainAudioAndVideoPermissions({\r\n            devices: [ 'audio' ],\r\n            micDeviceId\r\n        }).then(localTrack => {\r\n            // We only expect one audio track when specifying a device id.\r\n            if (!localTrack[0]) {\r\n                throw new Error(`Failed to create jitsi local track for device id: ${micDeviceId}`);\r\n            }\r\n\r\n            return new TrackVADEmitter(procNodeSampleRate, vadProcessor, localTrack[0]);\r\n\r\n            // We have no exception handling at this point as there is nothing to clean up, the vadProcessor\r\n            // life cycle is handled by whoever created this instance.\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Sets up the audio graph in the AudioContext.\r\n     *\r\n     * @returns {void}\r\n     */\r\n    _initializeAudioContext() {\r\n        this._audioSource = this._audioContext.createMediaStreamSource(this._localTrack.stream);\r\n\r\n        // TODO AudioProcessingNode is deprecated in the web audio specifications and the recommended replacement\r\n        // is audio worklet, however at the point of implementation AudioProcessingNode was still de de facto way\r\n        // of achieving this functionality and supported in all major browsers as opposed to audio worklet which\r\n        // was only available in Chrome. This todo is just a reminder that we should replace AudioProcessingNode\r\n        // with audio worklet when it's mature enough and has more browser support.\r\n        // We don't need stereo for determining the VAD score so we create a single channel processing node.\r\n        this._audioProcessingNode = this._audioContext.createScriptProcessor(this._procNodeSampleRate, 1, 1);\r\n    }\r\n\r\n    /**\r\n     * ScriptProcessorNode callback, the input parameters contains the PCM audio that is then sent to rnnoise.\r\n     * Rnnoise only accepts PCM samples of 480 bytes whereas the webaudio processor node can't sample at a multiple\r\n     * of 480 thus after each _onAudioProcess callback there will remain and PCM buffer residue equal\r\n     * to _procNodeSampleRate / 480 which will be added to the next sample buffer and so on.\\\r\n     *\r\n     *\r\n     * @param {AudioProcessingEvent} audioEvent - Audio event.\r\n     * @returns {void}\r\n     * @fires VAD_SCORE_PUBLISHED\r\n     */\r\n    _onAudioProcess(audioEvent) {\r\n        // Prepend the residue PCM buffer from the previous process callback.\r\n        const inData = audioEvent.inputBuffer.getChannelData(0);\r\n        const completeInData = [ ...this._bufferResidue, ...inData ];\r\n        const sampleTimestamp = Date.now();\r\n\r\n        let i = 0;\r\n\r\n        for (; i + this._vadSampleSize < completeInData.length; i += this._vadSampleSize) {\r\n            const pcmSample = completeInData.slice(i, i + this._vadSampleSize);\r\n\r\n            // The VAD processor might change the values inside the array so we make a copy.\r\n            const vadScore = this._vadProcessor.calculateAudioFrameVAD(pcmSample.slice());\r\n\r\n            this.emit(VAD_SCORE_PUBLISHED, {\r\n                timestamp: sampleTimestamp,\r\n                score: vadScore,\r\n                pcmData: pcmSample,\r\n                deviceId: this._localTrack.getDeviceId()\r\n            });\r\n        }\r\n\r\n        this._bufferResidue = completeInData.slice(i, completeInData.length);\r\n    }\r\n\r\n    /**\r\n     * Connects the nodes in the AudioContext to start the flow of audio data.\r\n     *\r\n     * @returns {void}\r\n     */\r\n    _connectAudioGraph() {\r\n        this._audioProcessingNode.onaudioprocess = this._onAudioProcess;\r\n        this._audioSource.connect(this._audioProcessingNode);\r\n        this._audioProcessingNode.connect(this._audioContext.destination);\r\n    }\r\n\r\n    /**\r\n     * Disconnects the nodes in the AudioContext.\r\n     *\r\n     * @returns {void}\r\n     */\r\n    _disconnectAudioGraph() {\r\n        // Even thought we disconnect the processing node it seems that some callbacks remain queued,\r\n        // resulting in calls with and uninitialized context.\r\n        // eslint-disable-next-line no-empty-function\r\n        this._audioProcessingNode.onaudioprocess = () => {};\r\n        this._audioProcessingNode.disconnect();\r\n        this._audioSource.disconnect();\r\n    }\r\n\r\n    /**\r\n     * Cleanup potentially acquired resources.\r\n     *\r\n     * @returns {void}\r\n     */\r\n    _cleanupResources() {\r\n        this._disconnectAudioGraph();\r\n        this._localTrack.stopStream();\r\n    }\r\n\r\n    /**\r\n     * Get the associated track device ID.\r\n     *\r\n     * @returns {string}\r\n     */\r\n    getDeviceId() {\r\n        return this._localTrack.getDeviceId();\r\n    }\r\n\r\n\r\n    /**\r\n     * Get the associated track label.\r\n     *\r\n     * @returns {string}\r\n     */\r\n    getTrackLabel() {\r\n        return this._localTrack.getDeviceLabel();\r\n    }\r\n\r\n    /**\r\n     * Start the emitter by connecting the audio graph.\r\n     *\r\n     * @returns {void}\r\n     */\r\n    start() {\r\n        this._connectAudioGraph();\r\n    }\r\n\r\n    /**\r\n     * Stops the emitter by disconnecting the audio graph.\r\n     *\r\n     * @returns {void}\r\n     */\r\n    stop() {\r\n        this._disconnectAudioGraph();\r\n        this._bufferResidue = [];\r\n    }\r\n\r\n    /**\r\n     * Destroy TrackVADEmitter instance (release resources and stop callbacks).\r\n     *\r\n     * @returns {void}\r\n     */\r\n    destroy() {\r\n        if (this._destroyed) {\r\n            return;\r\n        }\r\n\r\n        this._cleanupResources();\r\n        this._destroyed = true;\r\n    }\r\n}\r\n","/**\r\n * Adapter that creates AudioContext objects depending on the browser.\r\n *\r\n * @returns {AudioContext} - Return a new AudioContext or undefined if the browser does not support it.\r\n */\r\nexport function createAudioContext(options) {\r\n    const AudioContextImpl = window.AudioContext || window.webkitAudioContext;\r\n\r\n    if (!AudioContextImpl) {\r\n        return undefined;\r\n    }\r\n\r\n    return new AudioContextImpl(options);\r\n}\r\n","/**\r\n * Indicates that the end-to-end round-trip-time for a participant has changed.\r\n */\r\nexport const E2E_RTT_CHANGED = 'e2eping.e2e_rtt_changed';\r\n","import {MAP_CENTER} from '@components/Constants'\r\nimport {MapObject as IMapObject} from '@models/MapObject'\r\nimport {Pose2DMap} from '@models/utils'\r\nimport _ from 'lodash'\r\nimport { makeObservable, observable} from 'mobx'\r\nimport {shallowObservable, Store} from './utils'\r\n\r\nexport const defaultValue: IMapObject = {\r\n  pose: {\r\n    position: [MAP_CENTER[0], MAP_CENTER[1]],\r\n    orientation: 0,\r\n  },\r\n}\r\n\r\nexport class MapObject implements Store<IMapObject> {\r\n  @observable pose: (Pose2DMap)\r\n\r\n  constructor() {\r\n    this.pose = _.cloneDeep(defaultValue.pose)\r\n    makeObservable(this)\r\n  }\r\n\r\n  static fromPlain(obj: IMapObject) {\r\n    const store = new MapObject()\r\n    store.pose = shallowObservable(_.cloneDeep(obj.pose))\r\n  }\r\n}\r\n","import {IObservable, observable} from 'mobx'\r\n\r\nexport function shallowObservable<T extends Object>(obj: T) {\r\n  return observable(obj, undefined, {deep: false})\r\n}\r\n\r\nexport type Store<T> = {\r\n  [K in keyof T]: T[K] | (T[K] & IObservable)\r\n}\r\n","/**\r\n * A model for keeping track of each user's total\r\n * time as a dominant speaker. The model also\r\n * keeps track of the user's last known name\r\n * in case the user has left the meeting,\r\n * which is also tracked.\r\n */\r\nclass SpeakerStats {\r\n    /**\r\n     * Initializes a new SpeakerStats instance.\r\n     *\r\n     * @constructor\r\n     * @param {string} userId - The id of the user being tracked.\r\n     * @param {string} displayName - The name of the user being tracked.\r\n     * @param {boolean} isLocalStats - True if the stats model tracks\r\n     * the local user.\r\n     * @returns {void}\r\n     */\r\n    constructor(userId, displayName, isLocalStats) {\r\n        this._userId = userId;\r\n        this.setDisplayName(displayName);\r\n        this._isLocalStats = isLocalStats || false;\r\n        this.setDominantSpeaker(false);\r\n        this.totalDominantSpeakerTime = 0;\r\n        this._dominantSpeakerStart = 0;\r\n        this._hasLeft = false;\r\n    }\r\n\r\n    /**\r\n     * Get the user id being tracked.\r\n     *\r\n     * @returns {string} The user id.\r\n     */\r\n    getUserId() {\r\n        return this._userId;\r\n    }\r\n\r\n    /**\r\n     * Get the name of the user being tracked.\r\n     *\r\n     * @returns {string} The user name.\r\n     */\r\n    getDisplayName() {\r\n        return this.displayName;\r\n    }\r\n\r\n    /**\r\n     * Updates the last known name of the user being tracked.\r\n     *\r\n     * @param {string} - The user name.\r\n     * @returns {void}\r\n     */\r\n    setDisplayName(newName) {\r\n        this.displayName = newName;\r\n    }\r\n\r\n    /**\r\n     * Returns true if the stats are tracking the local user.\r\n     *\r\n     * @returns {boolean}\r\n     */\r\n    isLocalStats() {\r\n        return this._isLocalStats;\r\n    }\r\n\r\n    /**\r\n     * Returns true if the tracked user is currently a dominant speaker.\r\n     *\r\n     * @returns {boolean}\r\n     */\r\n    isDominantSpeaker() {\r\n        return this._dominantSpeakerStart > 0;\r\n    }\r\n\r\n    /**\r\n     * Returns true if the tracked user is currently a dominant speaker.\r\n     *\r\n     * @param {boolean} - If true, the user will being accumulating time\r\n     * as dominant speaker. If false, the user will not accumulate time\r\n     * and will record any time accumulated since starting as dominant speaker.\r\n     * @returns {void}\r\n     */\r\n    setDominantSpeaker(isNowDominantSpeaker) {\r\n        if (!this.isDominantSpeaker() && isNowDominantSpeaker) {\r\n            this._dominantSpeakerStart = Date.now();\r\n        } else if (this.isDominantSpeaker() && !isNowDominantSpeaker) {\r\n            const now = Date.now();\r\n            const timeElapsed = now - this._dominantSpeakerStart;\r\n\r\n            this.totalDominantSpeakerTime += timeElapsed;\r\n            this._dominantSpeakerStart = 0;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Get how long the tracked user has been dominant speaker.\r\n     *\r\n     * @returns {number} - The speaker time in milliseconds.\r\n     */\r\n    getTotalDominantSpeakerTime() {\r\n        let total = this.totalDominantSpeakerTime;\r\n\r\n        if (this.isDominantSpeaker()) {\r\n            total += Date.now() - this._dominantSpeakerStart;\r\n        }\r\n\r\n        return total;\r\n    }\r\n\r\n    /**\r\n     * Get whether or not the user is still in the meeting.\r\n     *\r\n     * @returns {boolean} True if the user is no longer in the meeting.\r\n     */\r\n    hasLeft() {\r\n        return this._hasLeft;\r\n    }\r\n\r\n    /**\r\n     * Set the user as having left the meeting.\r\n     *\r\n     * @returns {void}\r\n     */\r\n    markAsHasLeft() {\r\n        this._hasLeft = true;\r\n        this.setDominantSpeaker(false);\r\n    }\r\n}\r\n\r\nmodule.exports = SpeakerStats;\r\n","import EventEmitter from 'events';\r\n\r\nimport * as JitsiMediaDevicesEvents from './JitsiMediaDevicesEvents';\r\nimport RTC from './modules/RTC/RTC';\r\nimport browser from './modules/browser';\r\nimport Statistics from './modules/statistics/statistics';\r\nimport * as MediaType from './service/RTC/MediaType';\r\nimport RTCEvents from './service/RTC/RTCEvents';\r\n\r\nconst AUDIO_PERMISSION_NAME = 'microphone';\r\nconst PERMISSION_GRANTED_STATUS = 'granted';\r\nconst VIDEO_PERMISSION_NAME = 'camera';\r\n\r\n/**\r\n * Media devices utilities for Jitsi.\r\n */\r\nclass JitsiMediaDevices {\r\n    /**\r\n     * Initializes a {@code JitsiMediaDevices} object. There will be a single\r\n     * instance of this class.\r\n     */\r\n    constructor() {\r\n        this._eventEmitter = new EventEmitter();\r\n        this._permissions = {};\r\n\r\n        RTC.addListener(\r\n            RTCEvents.DEVICE_LIST_CHANGED,\r\n            devices =>\r\n                this._eventEmitter.emit(\r\n                    JitsiMediaDevicesEvents.DEVICE_LIST_CHANGED,\r\n                    devices));\r\n        RTC.addListener(\r\n            RTCEvents.DEVICE_LIST_AVAILABLE,\r\n            devices =>\r\n                this._logOutputDevice(\r\n                    this.getAudioOutputDevice(),\r\n                    devices));\r\n\r\n        // We would still want to update the permissions cache in case the permissions API is not supported.\r\n        RTC.addListener(\r\n            RTCEvents.PERMISSIONS_CHANGED,\r\n            permissions => this._handlePermissionsChange(permissions));\r\n\r\n        // Test if the W3C Permissions API is implemented and the 'camera' and 'microphone' permissions are\r\n        // implemented. If supported add onchange listeners.\r\n        this._permissionsApiSupported = new Promise(resolve => {\r\n            if (!navigator.permissions) {\r\n                resolve(false);\r\n\r\n                return;\r\n            }\r\n\r\n            const self = this;\r\n\r\n            const promises = [];\r\n\r\n            promises.push(navigator.permissions.query({ name: VIDEO_PERMISSION_NAME })\r\n                .then(status => {\r\n                    this._handlePermissionsChange({\r\n                        [MediaType.VIDEO]: this._parsePermissionState(status)\r\n                    });\r\n                    status.onchange = function() {\r\n                        try {\r\n                            self._handlePermissionsChange({\r\n                                [MediaType.VIDEO]: self._parsePermissionState(this)\r\n                            });\r\n                        } catch (error) {\r\n                            // Nothing to do.\r\n                        }\r\n                    };\r\n\r\n                    return true;\r\n                })\r\n                .catch(() => false));\r\n\r\n            promises.push(navigator.permissions.query({ name: AUDIO_PERMISSION_NAME })\r\n                .then(status => {\r\n                    this._handlePermissionsChange({\r\n                        [MediaType.AUDIO]: this._parsePermissionState(status)\r\n                    });\r\n                    status.onchange = function() {\r\n                        try {\r\n                            self._handlePermissionsChange({\r\n                                [MediaType.AUDIO]: self._parsePermissionState(this)\r\n                            });\r\n                        } catch (error) {\r\n                            // Nothing to do.\r\n                        }\r\n                    };\r\n\r\n                    return true;\r\n                })\r\n                .catch(() => false));\r\n\r\n            Promise.all(promises).then(results => resolve(results.every(supported => supported)));\r\n\r\n        });\r\n    }\r\n\r\n\r\n    /**\r\n     * Parses a PermissionState object and returns true for granted and false otherwise.\r\n     *\r\n     * @param {PermissionState} permissionStatus - The PermissionState object retrieved from the Permissions API.\r\n     * @returns {boolean} - True for granted and false for denied.\r\n     * @throws {TypeError}\r\n     */\r\n    _parsePermissionState(permissionStatus = {}) {\r\n        // The status attribute is deprecated, and state\r\n        // should be used instead, but check both for now\r\n        // for backwards compatibility.\r\n        const status = permissionStatus.state || permissionStatus.status;\r\n\r\n        if (typeof status !== 'string') {\r\n            throw new TypeError();\r\n        }\r\n\r\n        return status === PERMISSION_GRANTED_STATUS;\r\n    }\r\n\r\n    /**\r\n     * Updates the local granted/denied permissions cache. A permissions might be\r\n     * granted, denied, or undefined. This is represented by having its media\r\n     * type key set to {@code true} or {@code false} respectively.\r\n     *\r\n     * @param {Object} permissions - Object with the permissions.\r\n     */\r\n    _handlePermissionsChange(permissions) {\r\n        const hasPermissionsChanged\r\n            = [ MediaType.AUDIO, MediaType.VIDEO ]\r\n                .some(type => type in permissions && permissions[type] !== this._permissions[type]);\r\n\r\n        if (hasPermissionsChanged) {\r\n            this._permissions = {\r\n                ...this._permissions,\r\n                ...permissions\r\n            };\r\n            this._eventEmitter.emit(JitsiMediaDevicesEvents.PERMISSIONS_CHANGED, this._permissions);\r\n\r\n            if (this._permissions[MediaType.AUDIO] || this._permissions[MediaType.VIDEO]) {\r\n                // Triggering device list update when the permissiions are granted in order to update\r\n                // the labels the devices.\r\n                // eslint-disable-next-line no-empty-function\r\n                this.enumerateDevices(() => {});\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Gathers data and sends it to statistics.\r\n     * @param deviceID the device id to log\r\n     * @param devices list of devices\r\n     */\r\n    _logOutputDevice(deviceID, devices) {\r\n        const device\r\n            = devices.find(\r\n                d => d.kind === 'audiooutput' && d.deviceId === deviceID);\r\n\r\n        if (device) {\r\n            Statistics.sendActiveDeviceListEvent(\r\n                RTC.getEventDataForActiveDevice(device));\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Executes callback with list of media devices connected.\r\n     * @param {function} callback\r\n     */\r\n    enumerateDevices(callback) {\r\n        RTC.enumerateDevices(callback);\r\n    }\r\n\r\n    /**\r\n     * Checks if its possible to enumerate available cameras/micropones.\r\n     * @returns {Promise<boolean>} a Promise which will be resolved only once\r\n     * the WebRTC stack is ready, either with true if the device listing is\r\n     * available available or with false otherwise.\r\n     */\r\n    isDeviceListAvailable() {\r\n        return RTC.isDeviceListAvailable();\r\n    }\r\n\r\n    /**\r\n     * Returns true if changing the input (camera / microphone) or output\r\n     * (audio) device is supported and false if not.\r\n     * @param {string} [deviceType] - type of device to change. Default is\r\n     *      undefined or 'input', 'output' - for audio output device change.\r\n     * @returns {boolean} true if available, false otherwise.\r\n     */\r\n    isDeviceChangeAvailable(deviceType) {\r\n        return RTC.isDeviceChangeAvailable(deviceType);\r\n    }\r\n\r\n    /**\r\n     * Checks if the permission for the given device was granted.\r\n     *\r\n     * @param {'audio'|'video'} [type] - type of devices to check,\r\n     *      undefined stands for both 'audio' and 'video' together\r\n     * @returns {Promise<boolean>}\r\n     */\r\n    isDevicePermissionGranted(type) {\r\n        return new Promise(resolve => {\r\n            // Shortcut: first check if we already know the permission was\r\n            // granted.\r\n            if (type in this._permissions) {\r\n                resolve(this._permissions[type]);\r\n\r\n                return;\r\n            }\r\n\r\n            // Check using the Permissions API.\r\n            this._permissionsApiSupported.then(supported => {\r\n                if (!supported) {\r\n                    resolve(false);\r\n\r\n                    return;\r\n                }\r\n\r\n                const promises = [];\r\n\r\n                switch (type) {\r\n                case MediaType.VIDEO:\r\n                    promises.push(\r\n                        navigator.permissions.query({\r\n                            name: VIDEO_PERMISSION_NAME\r\n                        }));\r\n                    break;\r\n                case MediaType.AUDIO:\r\n                    promises.push(\r\n                        navigator.permissions.query({\r\n                            name: AUDIO_PERMISSION_NAME\r\n                        }));\r\n                    break;\r\n                default:\r\n                    promises.push(\r\n                        navigator.permissions.query({\r\n                            name: VIDEO_PERMISSION_NAME\r\n                        }));\r\n                    promises.push(\r\n                        navigator.permissions.query({\r\n                            name: AUDIO_PERMISSION_NAME\r\n                        }));\r\n                }\r\n\r\n                Promise.all(promises).then(\r\n                    results => resolve(results.every(permissionStatus => {\r\n                        try {\r\n                            return this._parsePermissionState(permissionStatus);\r\n                        } catch {\r\n                            return false;\r\n                        }\r\n                    })),\r\n                    () => resolve(false)\r\n                );\r\n            });\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Returns true if it is possible to be simultaneously capturing audio\r\n     * from more than one device.\r\n     *\r\n     * @returns {boolean}\r\n     */\r\n    isMultipleAudioInputSupported() {\r\n        return !browser.isFirefox();\r\n    }\r\n\r\n    /**\r\n     * Returns currently used audio output device id, 'default' stands\r\n     * for default device\r\n     * @returns {string}\r\n     */\r\n    getAudioOutputDevice() {\r\n        return RTC.getAudioOutputDevice();\r\n    }\r\n\r\n    /**\r\n     * Sets current audio output device.\r\n     * @param {string} deviceId - id of 'audiooutput' device from\r\n     *      navigator.mediaDevices.enumerateDevices(), 'default' is for\r\n     *      default device\r\n     * @returns {Promise} - resolves when audio output is changed, is rejected\r\n     *      otherwise\r\n     */\r\n    setAudioOutputDevice(deviceId) {\r\n        const availableDevices = RTC.getCurrentlyAvailableMediaDevices();\r\n\r\n        if (availableDevices.length > 0) {\r\n            // if we have devices info report device to stats\r\n            // normally this will not happen on startup as this method is called\r\n            // too early. This will happen only on user selection of new device\r\n            this._logOutputDevice(\r\n                deviceId, RTC.getCurrentlyAvailableMediaDevices());\r\n        }\r\n\r\n        return RTC.setAudioOutputDevice(deviceId);\r\n    }\r\n\r\n    /**\r\n     * Adds an event handler.\r\n     * @param {string} event - event name\r\n     * @param {function} handler - event handler\r\n     */\r\n    addEventListener(event, handler) {\r\n        this._eventEmitter.addListener(event, handler);\r\n    }\r\n\r\n    /**\r\n     * Removes event handler.\r\n     * @param {string} event - event name\r\n     * @param {function} handler - event handler\r\n     */\r\n    removeEventListener(event, handler) {\r\n        this._eventEmitter.removeListener(event, handler);\r\n    }\r\n\r\n    /**\r\n     * Emits an event.\r\n     * @param {string} event - event name\r\n     */\r\n    emitEvent(event, ...args) {\r\n        this._eventEmitter.emit(event, ...args);\r\n    }\r\n}\r\n\r\nexport default new JitsiMediaDevices();\r\n","const AuthenticationEvents = {\r\n    /**\r\n     * Event callback arguments:\r\n     * function(authenticationEnabled, userIdentity)\r\n     * authenticationEnabled - indicates whether authentication has been enabled\r\n     *                         in this session\r\n     * userIdentity - if user has been logged in then it contains user name. If\r\n     *                contains 'null' or 'undefined' then user is not logged in.\r\n     */\r\n    IDENTITY_UPDATED: 'authentication.identity_updated'\r\n};\r\n\r\nmodule.exports = AuthenticationEvents;\r\n","import connectionInfo from './ConnectionInfo'\r\nimport participants from './participants/Participants'\r\nexport {connectionInfo, participants}\r\n","/**\r\n * Derives a set of keys from the master key.\r\n * @param {CryptoKey} material - master key to derive from\r\n *\r\n * See https://tools.ietf.org/html/draft-omara-sframe-00#section-4.3.1\r\n */\r\nexport async function deriveKeys(material) {\r\n    const info = new ArrayBuffer();\r\n    const textEncoder = new TextEncoder();\r\n\r\n    // https://developer.mozilla.org/en-US/docs/Web/API/SubtleCrypto/deriveKey#HKDF\r\n    // https://developer.mozilla.org/en-US/docs/Web/API/HkdfParams\r\n    const encryptionKey = await crypto.subtle.deriveKey({\r\n        name: 'HKDF',\r\n        salt: textEncoder.encode('JFrameEncryptionKey'),\r\n        hash: 'SHA-256',\r\n        info\r\n    }, material, {\r\n        name: 'AES-GCM',\r\n        length: 128\r\n    }, false, [ 'encrypt', 'decrypt' ]);\r\n\r\n    return {\r\n        material,\r\n        encryptionKey\r\n    };\r\n}\r\n\r\n/**\r\n * Ratchets a key. See\r\n * https://tools.ietf.org/html/draft-omara-sframe-00#section-4.3.5.1\r\n * @param {CryptoKey} material - base key material\r\n * @returns {ArrayBuffer} - ratcheted key material\r\n */\r\nexport async function ratchet(material) {\r\n    const textEncoder = new TextEncoder();\r\n\r\n    // https://developer.mozilla.org/en-US/docs/Web/API/SubtleCrypto/deriveBits\r\n    return crypto.subtle.deriveBits({\r\n        name: 'HKDF',\r\n        salt: textEncoder.encode('JFrameRatchetKey'),\r\n        hash: 'SHA-256',\r\n        info: new ArrayBuffer()\r\n    }, material, 256);\r\n}\r\n\r\n/**\r\n * Converts a raw key into a WebCrypto key object with default options\r\n * suitable for our usage.\r\n * @param {ArrayBuffer} keyBytes - raw key\r\n * @param {Array} keyUsages - key usages, see importKey documentation\r\n * @returns {CryptoKey} - the WebCrypto key.\r\n */\r\nexport async function importKey(keyBytes) {\r\n    // https://developer.mozilla.org/en-US/docs/Web/API/SubtleCrypto/importKey\r\n    return crypto.subtle.importKey('raw', keyBytes, 'HKDF', false, [ 'deriveBits', 'deriveKey' ]);\r\n}\r\n","/* global $ */\r\n\r\nimport { b64_sha1, Strophe } from 'strophe.js'; // eslint-disable-line camelcase\r\n\r\nimport XMPPEvents from '../../service/xmpp/XMPPEvents';\r\nimport Listenable from '../util/Listenable';\r\n\r\n/**\r\n * The property\r\n */\r\nconst IDENTITY_PROPERTIES = [ 'category', 'type', 'lang', 'name' ];\r\nconst IDENTITY_PROPERTIES_FOR_COMPARE = [ 'category', 'type', 'lang' ];\r\nconst HASH = 'sha-1';\r\n\r\n/**\r\n *\r\n * @param a\r\n * @param b\r\n */\r\nfunction compareIdentities(a, b) {\r\n    let res = 0;\r\n\r\n    IDENTITY_PROPERTIES_FOR_COMPARE.some(key =>\r\n        (res = ((a[key] > b[key]) && 1) || ((a[key] < b[key]) && -1)) !== 0\r\n    );\r\n\r\n    return res;\r\n}\r\n\r\n/**\r\n * Produces a sha-1 from provided identity and features values.\r\n *\r\n * @param {Array<Object>} identities - The identity objects.\r\n * @param {Array<string>} features - The features.\r\n * @returns {string}\r\n */\r\nfunction generateSha(identities, features) {\r\n    const sortedIdentities = identities.sort(compareIdentities).reduce(\r\n        (accumulatedValue, identity) => `${\r\n            IDENTITY_PROPERTIES.reduce(\r\n                (tmp, key, idx) =>\r\n                    tmp\r\n                        + (idx === 0 ? '' : '/')\r\n                        + (identity[key] ? identity[key] : ''),\r\n                '')\r\n        }<`, '');\r\n    const sortedFeatures = features.sort().reduce(\r\n        (tmp, feature) => `${tmp + feature}<`, '');\r\n\r\n    return b64_sha1(sortedIdentities + sortedFeatures);\r\n}\r\n\r\n/**\r\n * Parses the disco-info node and returns the sets of features and identities.\r\n * @param {String} node The node with results to parse.\r\n * @returns {{features: Set<any>, identities: Set<any>}}\r\n */\r\nexport function parseDiscoInfo(node) {\r\n    const features = new Set();\r\n    const identities = new Set();\r\n\r\n    $(node).find('>query>feature')\r\n        .each((_, el) => features.add(el.getAttribute('var')));\r\n    $(node).find('>query>identity')\r\n        .each((_, el) => identities.add({\r\n            type: el.getAttribute('type'),\r\n            name: el.getAttribute('name'),\r\n            category: el.getAttribute('category')\r\n        }));\r\n\r\n    return {\r\n        features,\r\n        identities\r\n    };\r\n}\r\n\r\n/**\r\n * Implements xep-0115 ( http://xmpp.org/extensions/xep-0115.html )\r\n */\r\nexport default class Caps extends Listenable {\r\n    /**\r\n     * Constructs new Caps instance.\r\n     * @param {Strophe.Connection} connection the strophe connection object\r\n     * @param {String} node the value of the node attribute of the \"c\" xml node\r\n     * that will be sent to the other participants\r\n     */\r\n    constructor(connection = {}, node = 'http://jitsi.org/jitsimeet') {\r\n        super();\r\n        this.node = node;\r\n        this.disco = connection.disco;\r\n        if (!this.disco) {\r\n            throw new Error(\r\n                'Missing strophe-plugins '\r\n                + '(disco plugin is required)!');\r\n        }\r\n\r\n        this.version = '';\r\n        this.rooms = new Set();\r\n\r\n        // We keep track of features added outside the library and we publish them\r\n        // in the presence of the participant for simplicity, avoiding the disco info request-response.\r\n        this.externalFeatures = new Set();\r\n\r\n        const emuc = connection.emuc;\r\n\r\n        emuc.addListener(XMPPEvents.EMUC_ROOM_ADDED,\r\n            room => this._addChatRoom(room));\r\n        emuc.addListener(XMPPEvents.EMUC_ROOM_REMOVED,\r\n            room => this._removeChatRoom(room));\r\n        Object.keys(emuc.rooms).forEach(jid => {\r\n            this._addChatRoom(emuc.rooms[jid]);\r\n        });\r\n\r\n        Strophe.addNamespace('CAPS', 'http://jabber.org/protocol/caps');\r\n        this.disco.addFeature(Strophe.NS.CAPS);\r\n    }\r\n\r\n    /**\r\n     * Adds new feature to the list of supported features for the local\r\n     * participant\r\n     * @param {String} feature the name of the feature.\r\n     * @param {boolean} submit if true - new presence with updated \"c\" node\r\n     * will be sent.\r\n     * @param {boolean} external whether this feature was added externally to the library.\r\n     * We put features used directly by the clients (is jibri, remote-control enabled etc.) in the presence\r\n     * to avoid additional disco-info queries by those clients.\r\n     */\r\n    addFeature(feature, submit = false, external = false) {\r\n        this.disco.addFeature(feature);\r\n        this._generateVersion();\r\n\r\n        if (external && !this.externalFeatures.has(feature)) {\r\n            this.externalFeatures.add(feature);\r\n            this.rooms.forEach(room => this._updateRoomWithExternalFeatures(room));\r\n        }\r\n\r\n        if (submit) {\r\n            this.submit();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Removes a feature from the list of supported features for the local\r\n     * participant\r\n     * @param {String} feature the name of the feature.\r\n     * @param {boolean} submit if true - new presence with updated \"c\" node\r\n     * will be sent.\r\n     * @param {boolean} external whether this feature was added externally to the library.\r\n     */\r\n    removeFeature(feature, submit = false, external = false) {\r\n        this.disco.removeFeature(feature);\r\n        this._generateVersion();\r\n\r\n        if (external && this.externalFeatures.has(feature)) {\r\n            this.externalFeatures.delete(feature);\r\n            this.rooms.forEach(room => this._updateRoomWithExternalFeatures(room));\r\n        }\r\n\r\n        if (submit) {\r\n            this.submit();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Sends new presence stanza for every room from the list of rooms.\r\n     */\r\n    submit() {\r\n        this.rooms.forEach(room => room.sendPresence());\r\n    }\r\n\r\n    /**\r\n     * Updates the presences in the room based on the current values in externalFeatures.\r\n     * @param {ChatRoom} room the room to update.\r\n     * @private\r\n     */\r\n    _updateRoomWithExternalFeatures(room) {\r\n        if (this.externalFeatures.size === 0) {\r\n            room.removeFromPresence('features');\r\n        } else {\r\n            const children = [];\r\n\r\n            this.externalFeatures.forEach(f => {\r\n                children.push({\r\n                    'tagName': 'feature',\r\n                    attributes: { 'var': f }\r\n                });\r\n            });\r\n\r\n            room.addOrReplaceInPresence('features', { children });\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Returns a set with the features for a host.\r\n     * @param {String} jid the jid of the host\r\n     * @param {int} timeout the timeout in ms for reply from the host.\r\n     * @returns {Promise<Set<String>, Error>}\r\n     */\r\n    getFeaturesAndIdentities(jid, node, timeout = 5000) {\r\n        return this._getDiscoInfo(jid, node, timeout);\r\n    }\r\n\r\n    /**\r\n     * Returns a set with the features and identities for a host.\r\n     * @param {String} jid the jid of the host\r\n     * @param {String|null} node the node to query\r\n     * @param {int} timeout the timeout in ms for reply from the host.\r\n     * @returns {Promise<Object>}\r\n     * @private\r\n     */\r\n    _getDiscoInfo(jid, node, timeout) {\r\n        return new Promise((resolve, reject) =>\r\n            this.disco.info(jid, node, response => {\r\n                resolve(parseDiscoInfo(response));\r\n            }, reject, timeout)\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Adds ChatRoom instance to the list of rooms. Adds listeners to the room\r\n     * and adds \"c\" element to the presences of the room.\r\n     * @param {ChatRoom} room the room.\r\n     */\r\n    _addChatRoom(room) {\r\n        this.rooms.add(room);\r\n        this._fixChatRoomPresenceMap(room);\r\n\r\n        this._updateRoomWithExternalFeatures(room);\r\n    }\r\n\r\n    /**\r\n     * Removes ChatRoom instance from the list of rooms. Removes listeners\r\n     * added from the Caps class.\r\n     * @param {ChatRoom} room the room.\r\n     */\r\n    _removeChatRoom(room) {\r\n        this.rooms.delete(room);\r\n    }\r\n\r\n    /**\r\n     * Creates/updates the \"c\" xml node into the presence of the passed room.\r\n     * @param {ChatRoom} room the room.\r\n     */\r\n    _fixChatRoomPresenceMap(room) {\r\n        room.addOrReplaceInPresence('c', {\r\n            attributes: {\r\n                xmlns: Strophe.NS.CAPS,\r\n                hash: HASH,\r\n                node: this.node,\r\n                ver: this.version\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Handles this.version changes.\r\n     */\r\n    _notifyVersionChanged() {\r\n        // update the version for all rooms\r\n        this.rooms.forEach(room => this._fixChatRoomPresenceMap(room));\r\n    }\r\n\r\n    /**\r\n     * Generates the value for the \"ver\" attribute.\r\n     */\r\n    _generateVersion() {\r\n        this.version\r\n            = generateSha(this.disco._identities, this.disco._features);\r\n\r\n        this._notifyVersionChanged();\r\n    }\r\n}\r\n","import { EventEmitter } from 'events';\r\nimport { getLogger } from 'jitsi-meet-logger';\r\n\r\nimport * as JitsiConferenceEvents from '../../JitsiConferenceEvents';\r\n\r\nimport { VAD_SCORE_PUBLISHED, DETECTOR_STATE_CHANGE } from './DetectionEvents';\r\nimport TrackVADEmitter from './TrackVADEmitter';\r\n\r\nconst logger = getLogger(__filename);\r\n\r\n/**\r\n * Sample rate of TrackVADEmitter, it defines how many audio samples are processed at a time.\r\n * @type {number}\r\n */\r\nconst VAD_EMITTER_SAMPLE_RATE = 4096;\r\n\r\n/**\r\n * Connects a TrackVADEmitter to the target conference local audio track and manages various services that use\r\n * the data to produce audio analytics (VADTalkMutedDetection and VADNoiseDetection).\r\n */\r\nexport default class VADAudioAnalyser extends EventEmitter {\r\n    /**\r\n     * Creates <tt>VADAudioAnalyser</tt>\r\n     * @param {JitsiConference} conference - JitsiConference instance that created us.\r\n     * @param {Object} createVADProcessor - Function that creates a Voice activity detection processor. The processor\r\n     * needs to implement the following functions:\r\n     * - <tt>getSampleLength()</tt> - Returns the sample size accepted by getSampleLength.\r\n     * - <tt>getRequiredPCMFrequency()</tt> - Returns the PCM frequency at which the processor operates.\r\n     * - <tt>calculateAudioFrameVAD(pcmSample)</tt> - Process a 32 float pcm sample of getSampleLength size.\r\n     * @constructor\r\n     */\r\n    constructor(conference, createVADProcessor) {\r\n        super();\r\n\r\n        /**\r\n         * Member function that instantiates a VAD processor.\r\n         */\r\n        this._createVADProcessor = createVADProcessor;\r\n\r\n        /**\r\n         * Current {@link TrackVADEmitter}. VAD Emitter uses a {@link JitsiLocalTrack} and VAD processor to generate\r\n         * period voice probability scores.\r\n         */\r\n        this._vadEmitter = null;\r\n\r\n        /**\r\n         * Current state of the _vadEmitter\r\n         */\r\n        this._isVADEmitterRunning = false;\r\n\r\n        /**\r\n         * Array of currently attached VAD processing services.\r\n         */\r\n        this._detectionServices = [];\r\n\r\n        /**\r\n         * Promise used to chain create and destroy operations associated with TRACK_ADDED and TRACK_REMOVED events\r\n         * coming from the conference.\r\n         * Because we have an async created component (VAD Processor) we need to make sure that it's initialized before\r\n         * we destroy it ( when changing the device for instance), or when we use it from an external point of entry\r\n         * i.e. (TRACK_MUTE_CHANGED event callback).\r\n         */\r\n        this._vadInitTracker = Promise.resolve();\r\n\r\n        /**\r\n         * Listens for {@link TrackVADEmitter} events and processes them.\r\n         */\r\n        this._processVADScore = this._processVADScore.bind(this);\r\n\r\n        conference.on(JitsiConferenceEvents.TRACK_ADDED, this._trackAdded.bind(this));\r\n        conference.on(JitsiConferenceEvents.TRACK_REMOVED, this._trackRemoved.bind(this));\r\n        conference.on(JitsiConferenceEvents.TRACK_MUTE_CHANGED, this._trackMuteChanged.bind(this));\r\n    }\r\n\r\n    /**\r\n     * Attach a VAD detector service to the analyser and handle it's state changes.\r\n     *\r\n     * @param {Object} vadTMDetector\r\n     */\r\n    addVADDetectionService(vadService) {\r\n        this._detectionServices.push(vadService);\r\n        vadService.on(DETECTOR_STATE_CHANGE, () => {\r\n            // When the state of a detector changes check if there are any active detectors attached so that\r\n            // the _vadEmitter doesn't run needlessly.\r\n            const activeDetector = this._detectionServices.filter(detector => detector.isActive() === true);\r\n\r\n            // If there are no active detectors running and the vadEmitter is running then stop the emitter as it is\r\n            // uses a considerable amount of CPU. Otherwise start the service if it's stopped and there is a detector\r\n            // that needs it.\r\n            if (!activeDetector.length && this._isVADEmitterRunning) {\r\n                this._stopVADEmitter();\r\n            } else if (!this._isVADEmitterRunning) {\r\n                this._startVADEmitter();\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Start the {@link TrackVADEmitter} and attach the event listener.\r\n     * @returns {void}\r\n     */\r\n    _startVADEmitter() {\r\n        this._vadEmitter.on(VAD_SCORE_PUBLISHED, this._processVADScore);\r\n        this._vadEmitter.start();\r\n        this._isVADEmitterRunning = true;\r\n    }\r\n\r\n    /**\r\n     * Stop the {@link TrackVADEmitter} and detach the event listener.\r\n     * @returns {void}\r\n     */\r\n    _stopVADEmitter() {\r\n        this._vadEmitter.removeListener(VAD_SCORE_PUBLISHED, this._processVADScore);\r\n        this._vadEmitter.stop();\r\n        this._isVADEmitterRunning = false;\r\n    }\r\n\r\n    /**\r\n     * Listens for {@link TrackVADEmitter} events and directs them to attached services as needed.\r\n     *\r\n     * @param {Object} vadScore -VAD score emitted by {@link TrackVADEmitter}\r\n     * @param {Date}   vadScore.timestamp - Exact time at which processed PCM sample was generated.\r\n     * @param {number} vadScore.score - VAD score on a scale from 0 to 1 (i.e. 0.7)\r\n     * @param {Float32Array} pcmData - Raw PCM data with which the VAD score was calculated.\r\n     * @param {string} vadScore.deviceId - Device id of the associated track.\r\n     * @listens VAD_SCORE_PUBLISHED\r\n     */\r\n    _processVADScore(vadScore) {\r\n        for (const detector of this._detectionServices) {\r\n            detector.processVADScore(vadScore);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Change the isMuted state of all attached detection services.\r\n     *\r\n     * @param {boolean} isMuted\r\n     */\r\n    _changeDetectorsMuteState(isMuted) {\r\n        for (const detector of this._detectionServices) {\r\n            detector.changeMuteState(isMuted);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Notifies the detector that a track was added to the associated {@link JitsiConference}.\r\n     * Only take into account local audio tracks.\r\n     * @param {JitsiTrack} track - The added track.\r\n     * @returns {void}\r\n     * @listens TRACK_ADDED\r\n     */\r\n    _trackAdded(track) {\r\n        if (track.isLocalAudioTrack()) {\r\n            // Keep a track promise so we take into account successive TRACK_ADD events being generated so that we\r\n            // destroy/create the processing context in the proper order.\r\n            this._vadInitTracker = this._vadInitTracker.then(() => this._createVADProcessor())\r\n                .then(vadProcessor =>\r\n                    TrackVADEmitter.create(track.getDeviceId(), VAD_EMITTER_SAMPLE_RATE, vadProcessor)\r\n                )\r\n                .then(vadEmitter => {\r\n                    logger.debug('Created VAD emitter for track: ', track.getTrackLabel());\r\n\r\n                    this._vadEmitter = vadEmitter;\r\n\r\n                    // Iterate through the detection services and set their appropriate mute state, depending on\r\n                    // service this will trigger a DETECTOR_STATE_CHANGE which in turn might start the _vadEmitter.\r\n                    this._changeDetectorsMuteState(track.isMuted());\r\n                })\r\n                .catch(error => {\r\n                    logger.warn('Failed to start VADAudioAnalyser', error);\r\n                });\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Notifies the detector that the mute state of a {@link JitsiConference} track has changed. Only takes into account\r\n     * local audio tracks.\r\n     * @param {JitsiTrack} track - The track whose mute state has changed.\r\n     * @returns {void}\r\n     * @listens TRACK_MUTE_CHANGED\r\n     */\r\n    _trackMuteChanged(track) {\r\n        if (track.isLocalAudioTrack()) {\r\n            // On a mute toggle reset the state.\r\n            this._vadInitTracker = this._vadInitTracker.then(() => {\r\n                // Set mute status for the attached detection services.\r\n                this._changeDetectorsMuteState(track.isMuted());\r\n            });\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Notifies the detector that a track associated with the {@link JitsiConference} was removed. Only takes into\r\n     * account local audio tracks. Cleans up resources associated with the track and resets the processing context.\r\n     *\r\n     * @param {JitsiTrack} track - The removed track.\r\n     * @returns {void}\r\n     * @listens TRACK_REMOVED\r\n     */\r\n    _trackRemoved(track) {\r\n        if (track.isLocalAudioTrack()) {\r\n            // Use the promise to make sure operations are in sequence.\r\n            this._vadInitTracker = this._vadInitTracker.then(() => {\r\n                logger.debug('Removing track from VAD detection - ', track.getTrackLabel());\r\n\r\n                // Track was removed, clean up and set appropriate states.\r\n                if (this._vadEmitter) {\r\n                    this._stopVADEmitter();\r\n                    this._vadEmitter.destroy();\r\n                    this._vadEmitter = null;\r\n                }\r\n\r\n                // Reset state of detectors when active track is removed.\r\n                for (const detector of this._detectionServices) {\r\n                    detector.reset();\r\n                }\r\n            });\r\n        }\r\n    }\r\n\r\n\r\n}\r\n","import { $iq } from 'strophe.js';\r\n\r\nimport recordingXMLUtils from './recordingXMLUtils';\r\n\r\n/**\r\n * Represents a recording session.\r\n */\r\nexport default class JibriSession {\r\n    /**\r\n     * Initializes a new JibriSession instance.\r\n     *\r\n     * @constructor\r\n     */\r\n    constructor(options = {}) {\r\n        this._connection = options.connection;\r\n        this._mode = options.mode;\r\n\r\n        this._setSessionID(options.sessionID);\r\n        this.setStatus(options.status);\r\n    }\r\n\r\n    /**\r\n     * Returns the error related to the session instance, if any.\r\n     *\r\n     * @returns {string|undefined}\r\n     */\r\n    getError() {\r\n        return this._error;\r\n    }\r\n\r\n    /**\r\n     * Returns the session ID of the session instance.\r\n     *\r\n     * @returns {string|undefined}\r\n     */\r\n    getID() {\r\n        return this._sessionID;\r\n    }\r\n\r\n    /**\r\n     * Returns the initiator of the session instance.\r\n     *\r\n     * @returns {JitsiParticipant|undefined} The participant that started the session.\r\n     */\r\n    getInitiator() {\r\n        return this._initiator;\r\n    }\r\n\r\n    /**\r\n     * Returns the streaming URL of the session.\r\n     *\r\n     * @returns {string|undefined}\r\n     */\r\n    getLiveStreamViewURL() {\r\n        return this._liveStreamViewURL;\r\n    }\r\n\r\n    /**\r\n     * Returns the current status of the session.\r\n     *\r\n     * @returns {string|undefined}\r\n     */\r\n    getStatus() {\r\n        return this._status;\r\n    }\r\n\r\n    /**\r\n     * Returns the jid of the participant that stopped the session.\r\n     *\r\n     * @returns {JitsiParticipant|undefined} The participant that stopped the session.\r\n     */\r\n    getTerminator() {\r\n        return this._terminator;\r\n    }\r\n\r\n    /**\r\n     * Returns the current recording mode of the session, such as \"file\".\r\n     *\r\n     * @returns {string}\r\n     */\r\n    getMode() {\r\n        return this._mode;\r\n    }\r\n\r\n    /**\r\n     * Sets the last known error message related to the session.\r\n     *\r\n     * @param {string} error - The error string explaining why the session\r\n     * entered an error state.\r\n     * @returns {void}\r\n     */\r\n    setError(error) {\r\n        this._error = error;\r\n    }\r\n\r\n    /**\r\n     * Sets the last live stream URL for the session instance. Usually this is\r\n     * a YouTube URL and usually this is only set for \"stream\" sessions.\r\n     *\r\n     * @param {string} url - The live stream URL associated with the session.\r\n     * @returns {void}\r\n     */\r\n    setLiveStreamViewURL(url) {\r\n        this._liveStreamViewURL = url;\r\n    }\r\n\r\n    /**\r\n     * Sets the last known status for this recording session.\r\n     *\r\n     * @param {string} status - The new status to set.\r\n     * @returns {void}\r\n     */\r\n    setStatus(status) {\r\n        this._status = status;\r\n    }\r\n\r\n    /**\r\n     * Sets the creator's jid of the session.\r\n     * @param {JitsiParticipant} participant - The creator of the session.\r\n     */\r\n    setInitiator(participant) {\r\n        this._initiator = participant;\r\n    }\r\n\r\n    /**\r\n     * Sets the jid of the participant that stopped the session.\r\n     * @param {JitsiParticipant} participant  - The participant's jid,\r\n     * that stopped the session.\r\n     */\r\n    setTerminator(participant) {\r\n        this._terminator = participant;\r\n    }\r\n\r\n    /**\r\n     * Sends a message to start the actual recording.\r\n     *\r\n     * @param {Object} options - Additional arguments for starting the\r\n     * recording.\r\n     * @param {string} [options.appData] - Data specific to the app/service that\r\n     * the result file will be uploaded.\r\n     * @param {string} [options.broadcastId] - The broadcast ID of an\r\n     * associated YouTube stream, used for knowing the URL from which the stream\r\n     * can be viewed.\r\n     * @param {string} options.focusMucJid - The JID of the focus participant\r\n     * that controls recording.\r\n     * @param {streamId} options.streamId - Necessary for live streaming, this\r\n     * is the stream key needed to start a live streaming session with the\r\n     * streaming service provider.\r\n     * @returns Promise\r\n     */\r\n    start({ appData, broadcastId, focusMucJid, streamId }) {\r\n        return new Promise((resolve, reject) => {\r\n            this._connection.sendIQ(\r\n                this._createIQ({\r\n                    action: 'start',\r\n                    appData,\r\n                    focusMucJid,\r\n                    broadcastId,\r\n                    streamId\r\n                }),\r\n                result => {\r\n                    // All users will eventually receive the 'pending' status\r\n                    // from the backend, but for the user initiating the session\r\n                    // it's better to give some instant feedback that recording\r\n                    // is starting so fire 'pending' here manually.\r\n                    this.setStatus('pending');\r\n                    this._setSessionID(\r\n                        recordingXMLUtils.getSessionIdFromIq(result));\r\n\r\n                    resolve();\r\n                },\r\n                error => {\r\n                    this._setErrorFromIq(error);\r\n\r\n                    reject(error);\r\n                });\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Sends a message to actually stop the recording session.\r\n     *\r\n     * @param {Object} options - Additional arguments for stopping the\r\n     * recording.\r\n     * @param {Object} options.focusMucJid - The JID of the focus participant\r\n     * that controls recording.\r\n     * @returns Promise\r\n     */\r\n    stop({ focusMucJid }) {\r\n        return new Promise((resolve, reject) => {\r\n            this._connection.sendIQ(\r\n                this._createIQ({\r\n                    action: 'stop',\r\n                    focusMucJid\r\n                }),\r\n                resolve,\r\n                reject);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Generates the message to change the status of the recording session.\r\n     *\r\n     * @param {string} status - The new status to which the recording session\r\n     * should transition.\r\n     * @param {string} [options.appData] - Data specific to the app/service that\r\n     * the result file will be uploaded.\r\n     * @param {string} [options.broadcastId] - The broadcast ID of an\r\n     * associated YouTube stream, used for knowing the URL from which the stream\r\n     * can be viewed.\r\n     * @param {string} options.focusMucJid - The JID of the focus participant\r\n     * that controls recording.\r\n     * @param {streamId} options.streamId - Necessary for live streaming, this\r\n     * is the stream key needed to start a live streaming session with the\r\n     * streaming service provider.\r\n     * @returns Object - The XMPP IQ message.\r\n     */\r\n    _createIQ({ action, appData, broadcastId, focusMucJid, streamId }) {\r\n        return $iq({\r\n            to: focusMucJid,\r\n            type: 'set'\r\n        })\r\n        .c('jibri', {\r\n            'xmlns': 'http://jitsi.org/protocol/jibri',\r\n            'action': action,\r\n            'app_data': appData,\r\n            'recording_mode': this._mode,\r\n            'streamid': streamId,\r\n            'you_tube_broadcast_id': broadcastId\r\n        })\r\n        .up();\r\n    }\r\n\r\n    /**\r\n     * Handles the error from an iq and stores the error.\r\n     *\r\n     * @param {Node} errorIq - The error response from an Iq.\r\n     * @private\r\n     * @returns {void}\r\n     */\r\n    _setErrorFromIq(errorIq) {\r\n        const error = errorIq.getElementsByTagName('error')[0];\r\n\r\n        this.setError(error.children[0].tagName);\r\n    }\r\n\r\n    /**\r\n     * Sets the known session ID for this recording session.\r\n     *\r\n     * @param {string} sessionID\r\n     * @private\r\n     * @returns {void}\r\n     */\r\n    _setSessionID(sessionID) {\r\n        this._sessionID = sessionID;\r\n    }\r\n}\r\n","/* global MediaRecorder, MediaStream */\r\n\r\nconst RecordingResult = require('./recordingResult');\r\n\r\n/**\r\n * Possible audio formats MIME types\r\n */\r\nconst AUDIO_WEBM = 'audio/webm'; // Supported in chrome\r\nconst AUDIO_OGG = 'audio/ogg'; // Supported in firefox\r\n\r\n/**\r\n * A TrackRecorder object holds all the information needed for recording a\r\n * single JitsiTrack (either remote or local)\r\n * @param track The JitsiTrack the object is going to hold\r\n */\r\nconst TrackRecorder = function(track) {\r\n    // The JitsiTrack holding the stream\r\n    this.track = track;\r\n\r\n    // The MediaRecorder recording the stream\r\n    this.recorder = null;\r\n\r\n    // The array of data chunks recorded from the stream\r\n    // acts as a buffer until the data is stored on disk\r\n    this.data = null;\r\n\r\n    // the name of the person of the JitsiTrack. This can be undefined and/or\r\n    // not unique\r\n    this.name = null;\r\n\r\n    // the time of the start of the recording\r\n    this.startTime = null;\r\n};\r\n\r\n/**\r\n * Starts the recording of a JitsiTrack in a TrackRecorder object.\r\n * This will also define the timestamp and try to update the name\r\n * @param trackRecorder the TrackRecorder to start\r\n */\r\nfunction startRecorder(trackRecorder) {\r\n    if (trackRecorder.recorder === undefined) {\r\n        throw new Error('Passed an object to startRecorder which is not a '\r\n            + 'TrackRecorder object');\r\n    }\r\n    trackRecorder.recorder.start();\r\n    trackRecorder.startTime = new Date();\r\n}\r\n\r\n/**\r\n * Stops the recording of a JitsiTrack in a TrackRecorder object.\r\n * This will also try to update the name\r\n * @param trackRecorder the TrackRecorder to stop\r\n */\r\nfunction stopRecorder(trackRecorder) {\r\n    if (trackRecorder.recorder === undefined) {\r\n        throw new Error('Passed an object to stopRecorder which is not a '\r\n            + 'TrackRecorder object');\r\n    }\r\n    trackRecorder.recorder.stop();\r\n}\r\n\r\n/**\r\n * Determines which kind of audio recording the browser supports\r\n * chrome supports \"audio/webm\" and firefox supports \"audio/ogg\"\r\n */\r\nfunction determineCorrectFileType() {\r\n    if (MediaRecorder.isTypeSupported(AUDIO_WEBM)) {\r\n        return AUDIO_WEBM;\r\n    } else if (MediaRecorder.isTypeSupported(AUDIO_OGG)) {\r\n        return AUDIO_OGG;\r\n    }\r\n    throw new Error(\r\n        'unable to create a MediaRecorder with the right mimetype!');\r\n}\r\n\r\n/**\r\n * main exported object of the file, holding all\r\n * relevant functions and variables for the outside world\r\n * @param jitsiConference the jitsiConference which this object\r\n * is going to record\r\n */\r\nfunction AudioRecorder(jitsiConference) {\r\n    // array of TrackRecorders, where each trackRecorder\r\n    // holds the JitsiTrack, MediaRecorder and recorder data\r\n    this.recorders = [];\r\n\r\n    // get which file type is supported by the current browser\r\n    this.fileType = determineCorrectFileType();\r\n\r\n    // boolean flag for active recording\r\n    this.isRecording = false;\r\n\r\n    // the jitsiconference the object is recording\r\n    this.jitsiConference = jitsiConference;\r\n}\r\n\r\n/**\r\n * Add the exported module so that it can be accessed by other files\r\n */\r\nAudioRecorder.determineCorrectFileType = determineCorrectFileType;\r\n\r\n/**\r\n * Adds a new TrackRecorder object to the array.\r\n *\r\n * @param track the track potentially holding an audio stream\r\n */\r\nAudioRecorder.prototype.addTrack = function(track) {\r\n    if (track.isAudioTrack()) {\r\n        // create the track recorder\r\n        const trackRecorder = this.instantiateTrackRecorder(track);\r\n\r\n        // push it to the local array of all recorders\r\n\r\n        this.recorders.push(trackRecorder);\r\n\r\n        // update the name of the trackRecorders\r\n        this.updateNames();\r\n\r\n        // If we're already recording, immediately start recording this new\r\n        // track.\r\n        if (this.isRecording) {\r\n            startRecorder(trackRecorder);\r\n        }\r\n    }\r\n};\r\n\r\n/**\r\n * Creates a TrackRecorder object. Also creates the MediaRecorder and\r\n * data array for the trackRecorder.\r\n * @param track the JitsiTrack holding the audio MediaStream(s)\r\n */\r\nAudioRecorder.prototype.instantiateTrackRecorder = function(track) {\r\n    const trackRecorder = new TrackRecorder(track);\r\n\r\n    // Create a new stream which only holds the audio track\r\n    const originalStream = trackRecorder.track.getOriginalStream();\r\n    const stream = new MediaStream();\r\n\r\n    originalStream.getAudioTracks().forEach(t => stream.addTrack(t));\r\n\r\n    // Create the MediaRecorder\r\n    trackRecorder.recorder = new MediaRecorder(stream,\r\n        { mimeType: this.fileType });\r\n\r\n    // array for holding the recorder data. Resets it when\r\n    // audio already has been recorder once\r\n    trackRecorder.data = [];\r\n\r\n    // function handling a dataEvent, e.g the stream gets new data\r\n    trackRecorder.recorder.ondataavailable = function(dataEvent) {\r\n        if (dataEvent.data.size > 0) {\r\n            trackRecorder.data.push(dataEvent.data);\r\n        }\r\n    };\r\n\r\n    return trackRecorder;\r\n};\r\n\r\n/**\r\n * Notifies the module that a specific track has stopped, e.g participant left\r\n * the conference.\r\n * if the recording has not started yet, the TrackRecorder will be removed from\r\n * the array. If the recording has started, the recorder will stop recording\r\n * but not removed from the array so that the recorded stream can still be\r\n * accessed\r\n *\r\n * @param {JitsiTrack} track the JitsiTrack to remove from the recording session\r\n */\r\nAudioRecorder.prototype.removeTrack = function(track) {\r\n    if (track.isVideoTrack()) {\r\n        return;\r\n    }\r\n\r\n    const array = this.recorders;\r\n    let i;\r\n\r\n    for (i = 0; i < array.length; i++) {\r\n        if (array[i].track.getParticipantId() === track.getParticipantId()) {\r\n            const recorderToRemove = array[i];\r\n\r\n            if (this.isRecording) {\r\n                stopRecorder(recorderToRemove);\r\n            } else {\r\n                // remove the TrackRecorder from the array\r\n                array.splice(i, 1);\r\n            }\r\n        }\r\n    }\r\n\r\n    // make sure the names are up to date\r\n    this.updateNames();\r\n};\r\n\r\n/**\r\n * Tries to update the name value of all TrackRecorder in the array.\r\n * If it hasn't changed,it will keep the exiting name. If it changes to a\r\n * undefined value, the old value will also be kept.\r\n */\r\nAudioRecorder.prototype.updateNames = function() {\r\n    const conference = this.jitsiConference;\r\n\r\n    this.recorders.forEach(trackRecorder => {\r\n        if (trackRecorder.track.isLocal()) {\r\n            trackRecorder.name = 'the transcriber';\r\n        } else {\r\n            const id = trackRecorder.track.getParticipantId();\r\n            const participant = conference.getParticipantById(id);\r\n            const newName = participant.getDisplayName();\r\n\r\n            if (newName !== 'undefined') {\r\n                trackRecorder.name = newName;\r\n            }\r\n        }\r\n    });\r\n};\r\n\r\n/**\r\n * Starts the audio recording of every local and remote track\r\n */\r\nAudioRecorder.prototype.start = function() {\r\n    if (this.isRecording) {\r\n        throw new Error('audiorecorder is already recording');\r\n    }\r\n\r\n    // set boolean isRecording flag to true so if new participants join the\r\n    // conference, that track can instantly start recording as well\r\n    this.isRecording = true;\r\n\r\n    // start all the mediaRecorders\r\n    this.recorders.forEach(trackRecorder => startRecorder(trackRecorder));\r\n\r\n    // log that recording has started\r\n    console.log(\r\n        `Started the recording of the audio. There are currently ${\r\n            this.recorders.length} recorders active.`);\r\n};\r\n\r\n/**\r\n * Stops the audio recording of every local and remote track\r\n */\r\nAudioRecorder.prototype.stop = function() {\r\n    // set the boolean flag to false\r\n    this.isRecording = false;\r\n\r\n    // stop all recorders\r\n    this.recorders.forEach(trackRecorder => stopRecorder(trackRecorder));\r\n    console.log('stopped recording');\r\n};\r\n\r\n/**\r\n * link hacking to download all recorded audio streams\r\n */\r\nAudioRecorder.prototype.download = function() {\r\n    this.recorders.forEach(trackRecorder => {\r\n        const blob = new Blob(trackRecorder.data, { type: this.fileType });\r\n        const url = URL.createObjectURL(blob);\r\n        const a = document.createElement('a');\r\n\r\n        document.body.appendChild(a);\r\n        a.style = 'display: none';\r\n        a.href = url;\r\n        a.download = `test.${this.fileType.split('/')[1]}`;\r\n        a.click();\r\n        window.URL.revokeObjectURL(url);\r\n    });\r\n};\r\n\r\n/**\r\n * returns the audio files of all recorders as an array of objects,\r\n * which include the name of the owner of the track and the starting time stamp\r\n * @returns {Array} an array of RecordingResult objects\r\n */\r\nAudioRecorder.prototype.getRecordingResults = function() {\r\n    if (this.isRecording) {\r\n        throw new Error(\r\n            'cannot get blobs because the AudioRecorder is still recording!');\r\n    }\r\n\r\n    // make sure the names are up to date before sending them off\r\n    this.updateNames();\r\n\r\n    const array = [];\r\n\r\n    this.recorders.forEach(\r\n        recorder =>\r\n            array.push(\r\n                new RecordingResult(\r\n                    new Blob(recorder.data, { type: this.fileType }),\r\n                    recorder.name,\r\n                    recorder.startTime)));\r\n\r\n    return array;\r\n};\r\n\r\n/**\r\n * Gets the mime type of the recorder audio\r\n * @returns {String} the mime type of the recorder audio\r\n */\r\nAudioRecorder.prototype.getFileType = function() {\r\n    return this.fileType;\r\n};\r\n\r\n/**\r\n * export the main object AudioRecorder\r\n */\r\nmodule.exports = AudioRecorder;\r\n","import JitsiConference from './JitsiConference';\r\nimport * as JitsiConnectionEvents from './JitsiConnectionEvents';\r\nimport Statistics from './modules/statistics/statistics';\r\nimport XMPP from './modules/xmpp/xmpp';\r\nimport {\r\n    CONNECTION_DISCONNECTED as ANALYTICS_CONNECTION_DISCONNECTED,\r\n    createConnectionFailedEvent\r\n} from './service/statistics/AnalyticsEvents';\r\n\r\n/**\r\n * Creates a new connection object for the Jitsi Meet server side video\r\n * conferencing service. Provides access to the JitsiConference interface.\r\n * @param appID identification for the provider of Jitsi Meet video conferencing\r\n * services.\r\n * @param token the JWT token used to authenticate with the server(optional)\r\n * @param options Object with properties / settings related to connection with\r\n * the server.\r\n * @constructor\r\n */\r\nexport default function JitsiConnection(appID, token, options) {\r\n    this.appID = appID;\r\n    this.token = token;\r\n    this.options = options;\r\n    this.xmpp = new XMPP(options, token);\r\n\r\n    /* eslint-disable max-params */\r\n    this.addEventListener(JitsiConnectionEvents.CONNECTION_FAILED,\r\n        (errType, msg, credentials, details) => {\r\n            Statistics.sendAnalyticsAndLog(\r\n                createConnectionFailedEvent(errType, msg, details));\r\n        });\r\n    /* eslint-enable max-params */\r\n\r\n    this.addEventListener(JitsiConnectionEvents.CONNECTION_DISCONNECTED,\r\n        msg => {\r\n            // we can see disconnects from normal tab closing of the browser\r\n            // and then there are no msgs, but we want to log only disconnects\r\n            // when there is real error\r\n            // XXX Do we need the difference in handling between the log and\r\n            // analytics event here?\r\n            if (msg) {\r\n                Statistics.sendAnalytics(\r\n                    ANALYTICS_CONNECTION_DISCONNECTED,\r\n                    { message: msg });\r\n            }\r\n            Statistics.sendLog(\r\n                JSON.stringify(\r\n                    {\r\n                        id: ANALYTICS_CONNECTION_DISCONNECTED,\r\n                        msg\r\n                    }));\r\n        });\r\n}\r\n\r\n/**\r\n * Connect the client with the server.\r\n * @param options {object} connecting options\r\n * (for example authentications parameters).\r\n */\r\nJitsiConnection.prototype.connect = function(options = {}) {\r\n    this.xmpp.connect(options.id, options.password);\r\n};\r\n\r\n/**\r\n * Attach to existing connection. Can be used for optimizations. For example:\r\n * if the connection is created on the server we can attach to it and start\r\n * using it.\r\n *\r\n * @param options {object} connecting options - rid, sid and jid.\r\n */\r\nJitsiConnection.prototype.attach = function(options) {\r\n    this.xmpp.attach(options);\r\n};\r\n\r\n/**\r\n * Disconnect the client from the server.\r\n * @returns {Promise} - Resolves when the disconnect process is finished or rejects with an error.\r\n */\r\nJitsiConnection.prototype.disconnect = function(...args) {\r\n    // XXX Forward any arguments passed to JitsiConnection.disconnect to\r\n    // XMPP.disconnect. For example, the caller of JitsiConnection.disconnect\r\n    // may optionally pass the event which triggered the disconnect in order to\r\n    // provide the implementation with finer-grained context.\r\n    return this.xmpp.disconnect(...args);\r\n};\r\n\r\n/**\r\n * Returns the jid of the participant associated with the XMPP connection.\r\n *\r\n * @returns {string} The jid of the participant.\r\n */\r\nJitsiConnection.prototype.getJid = function() {\r\n    return this.xmpp.getJid();\r\n};\r\n\r\n/**\r\n * This method allows renewal of the tokens if they are expiring.\r\n * @param token the new token.\r\n */\r\nJitsiConnection.prototype.setToken = function(token) {\r\n    this.token = token;\r\n};\r\n\r\n/**\r\n * Creates and joins new conference.\r\n * @param name the name of the conference; if null - a generated name will be\r\n * provided from the api\r\n * @param options Object with properties / settings related to the conference\r\n * that will be created.\r\n * @returns {JitsiConference} returns the new conference object.\r\n */\r\nJitsiConnection.prototype.initJitsiConference = function(name, options) {\r\n    return new JitsiConference({\r\n        name,\r\n        config: options,\r\n        connection: this\r\n    });\r\n};\r\n\r\n/**\r\n * Subscribes the passed listener to the event.\r\n * @param event {JitsiConnectionEvents} the connection event.\r\n * @param listener {Function} the function that will receive the event\r\n */\r\nJitsiConnection.prototype.addEventListener = function(event, listener) {\r\n    this.xmpp.addListener(event, listener);\r\n};\r\n\r\n/**\r\n * Unsubscribes the passed handler.\r\n * @param event {JitsiConnectionEvents} the connection event.\r\n * @param listener {Function} the function that will receive the event\r\n */\r\nJitsiConnection.prototype.removeEventListener = function(event, listener) {\r\n    this.xmpp.removeListener(event, listener);\r\n};\r\n\r\n/**\r\n * Returns measured connectionTimes.\r\n */\r\nJitsiConnection.prototype.getConnectionTimes = function() {\r\n    return this.xmpp.connectionTimes;\r\n};\r\n\r\n/**\r\n * Adds new feature to the list of supported features for the local\r\n * participant.\r\n * @param {String} feature the name of the feature.\r\n * @param {boolean} submit if true - the new list of features will be\r\n * immediately submitted to the others.\r\n */\r\nJitsiConnection.prototype.addFeature = function(feature, submit = false) {\r\n    this.xmpp.caps.addFeature(feature, submit, true);\r\n};\r\n\r\n/**\r\n * Removes a feature from the list of supported features for the local\r\n * participant\r\n * @param {String} feature the name of the feature.\r\n * @param {boolean} submit if true - the new list of features will be\r\n * immediately submitted to the others.\r\n */\r\nJitsiConnection.prototype.removeFeature = function(feature, submit = false) {\r\n    this.xmpp.caps.removeFeature(feature, submit, true);\r\n};\r\n\r\n/**\r\n * Get object with internal logs.\r\n */\r\nJitsiConnection.prototype.getLogs = function() {\r\n    const data = this.xmpp.getJingleLog();\r\n\r\n    const metadata = {};\r\n\r\n    metadata.time = new Date();\r\n    metadata.url = window.location.href;\r\n    metadata.ua = navigator.userAgent;\r\n\r\n    const log = this.xmpp.getXmppLog();\r\n\r\n    if (log) {\r\n        metadata.xmpp = log;\r\n    }\r\n\r\n    data.metadata = metadata;\r\n\r\n    return data;\r\n};\r\n","/* global __filename, $, Promise */\r\n\r\nimport EventEmitter from 'events';\r\nimport { getLogger } from 'jitsi-meet-logger';\r\nimport isEqual from 'lodash.isequal';\r\nimport { Strophe } from 'strophe.js';\r\n\r\nimport * as JitsiConferenceErrors from './JitsiConferenceErrors';\r\nimport JitsiConferenceEventManager from './JitsiConferenceEventManager';\r\nimport * as JitsiConferenceEvents from './JitsiConferenceEvents';\r\nimport JitsiParticipant from './JitsiParticipant';\r\nimport JitsiTrackError from './JitsiTrackError';\r\nimport * as JitsiTrackErrors from './JitsiTrackErrors';\r\nimport * as JitsiTrackEvents from './JitsiTrackEvents';\r\nimport authenticateAndUpgradeRole from './authenticateAndUpgradeRole';\r\nimport { CodecSelection } from './modules/RTC/CodecSelection';\r\nimport RTC from './modules/RTC/RTC';\r\nimport browser from './modules/browser';\r\nimport ConnectionQuality from './modules/connectivity/ConnectionQuality';\r\nimport IceFailedHandling\r\n    from './modules/connectivity/IceFailedHandling';\r\nimport ParticipantConnectionStatusHandler\r\n    from './modules/connectivity/ParticipantConnectionStatus';\r\nimport * as DetectionEvents from './modules/detection/DetectionEvents';\r\nimport NoAudioSignalDetection from './modules/detection/NoAudioSignalDetection';\r\nimport P2PDominantSpeakerDetection from './modules/detection/P2PDominantSpeakerDetection';\r\nimport VADAudioAnalyser from './modules/detection/VADAudioAnalyser';\r\nimport VADNoiseDetection from './modules/detection/VADNoiseDetection';\r\nimport VADTalkMutedDetection from './modules/detection/VADTalkMutedDetection';\r\nimport { E2EEncryption } from './modules/e2ee/E2EEncryption';\r\nimport E2ePing from './modules/e2eping/e2eping';\r\nimport Jvb121EventGenerator from './modules/event/Jvb121EventGenerator';\r\nimport { ReceiveVideoController } from './modules/qualitycontrol/ReceiveVideoController';\r\nimport { SendVideoController } from './modules/qualitycontrol/SendVideoController';\r\nimport RecordingManager from './modules/recording/RecordingManager';\r\nimport Settings from './modules/settings/Settings';\r\nimport AudioOutputProblemDetector from './modules/statistics/AudioOutputProblemDetector';\r\nimport AvgRTPStatsReporter from './modules/statistics/AvgRTPStatsReporter';\r\nimport SpeakerStatsCollector from './modules/statistics/SpeakerStatsCollector';\r\nimport Statistics from './modules/statistics/statistics';\r\nimport Transcriber from './modules/transcription/transcriber';\r\nimport GlobalOnErrorHandler from './modules/util/GlobalOnErrorHandler';\r\nimport RandomUtil from './modules/util/RandomUtil';\r\nimport ComponentsVersions from './modules/version/ComponentsVersions';\r\nimport VideoSIPGW from './modules/videosipgw/VideoSIPGW';\r\nimport * as VideoSIPGWConstants from './modules/videosipgw/VideoSIPGWConstants';\r\nimport {\r\n    FEATURE_E2EE,\r\n    FEATURE_JIGASI,\r\n    JITSI_MEET_MUC_TYPE\r\n} from './modules/xmpp/xmpp';\r\nimport CodecMimeType from './service/RTC/CodecMimeType';\r\nimport * as MediaType from './service/RTC/MediaType';\r\nimport VideoType from './service/RTC/VideoType';\r\nimport {\r\n    ACTION_JINGLE_RESTART,\r\n    ACTION_JINGLE_SI_RECEIVED,\r\n    ACTION_JINGLE_SI_TIMEOUT,\r\n    ACTION_JINGLE_TERMINATE,\r\n    ACTION_P2P_DECLINED,\r\n    ACTION_P2P_ESTABLISHED,\r\n    ACTION_P2P_FAILED,\r\n    ACTION_P2P_SWITCH_TO_JVB,\r\n    ICE_ESTABLISHMENT_DURATION_DIFF,\r\n    createConferenceEvent,\r\n    createJingleEvent,\r\n    createP2PEvent\r\n} from './service/statistics/AnalyticsEvents';\r\nimport * as XMPPEvents from './service/xmpp/XMPPEvents';\r\n\r\nconst logger = getLogger(__filename);\r\n\r\n/**\r\n * How long since Jicofo is supposed to send a session-initiate, before\r\n * {@link ACTION_JINGLE_SI_TIMEOUT} analytics event is sent (in ms).\r\n * @type {number}\r\n */\r\nconst JINGLE_SI_TIMEOUT = 5000;\r\n\r\n/**\r\n * Creates a JitsiConference object with the given name and properties.\r\n * Note: this constructor is not a part of the public API (objects should be\r\n * created using JitsiConnection.createConference).\r\n * @param options.config properties / settings related to the conference that\r\n * will be created.\r\n * @param options.name the name of the conference\r\n * @param options.connection the JitsiConnection object for this\r\n * JitsiConference.\r\n * @param {number} [options.config.avgRtpStatsN=15] how many samples are to be\r\n * collected by {@link AvgRTPStatsReporter}, before arithmetic mean is\r\n * calculated and submitted to the analytics module.\r\n * @param {boolean} [options.config.enableIceRestart=false] - enables the ICE\r\n * restart logic.\r\n * @param {boolean} [options.config.p2p.enabled] when set to <tt>true</tt>\r\n * the peer to peer mode will be enabled. It means that when there are only 2\r\n * participants in the conference an attempt to make direct connection will be\r\n * made. If the connection succeeds the conference will stop sending data\r\n * through the JVB connection and will use the direct one instead.\r\n * @param {number} [options.config.p2p.backToP2PDelay=5] a delay given in\r\n * seconds, before the conference switches back to P2P, after the 3rd\r\n * participant has left the room.\r\n * @param {number} [options.config.channelLastN=-1] The requested amount of\r\n * videos are going to be delivered after the value is in effect. Set to -1 for\r\n * unlimited or all available videos.\r\n * @param {number} [options.config.forceJVB121Ratio]\r\n * \"Math.random() < forceJVB121Ratio\" will determine whether a 2 people\r\n * conference should be moved to the JVB instead of P2P. The decision is made on\r\n * the responder side, after ICE succeeds on the P2P connection.\r\n * @constructor\r\n *\r\n * FIXME Make all methods which are called from lib-internal classes\r\n *       to non-public (use _). To name a few:\r\n *       {@link JitsiConference.onLocalRoleChanged}\r\n *       {@link JitsiConference.onUserRoleChanged}\r\n *       {@link JitsiConference.onMemberLeft}\r\n *       and so on...\r\n */\r\nexport default function JitsiConference(options) {\r\n    if (!options.name || options.name.toLowerCase() !== options.name) {\r\n        const errmsg\r\n            = 'Invalid conference name (no conference name passed or it '\r\n                + 'contains invalid characters like capital letters)!';\r\n\r\n        logger.error(errmsg);\r\n        throw new Error(errmsg);\r\n    }\r\n    this.eventEmitter = new EventEmitter();\r\n    this.options = options;\r\n    this.eventManager = new JitsiConferenceEventManager(this);\r\n    this.participants = {};\r\n    this._init(options);\r\n    this.componentsVersions = new ComponentsVersions(this);\r\n\r\n    /**\r\n     * Jingle session instance for the JVB connection.\r\n     * @type {JingleSessionPC}\r\n     */\r\n    this.jvbJingleSession = null;\r\n    this.lastDominantSpeaker = null;\r\n    this.dtmfManager = null;\r\n    this.somebodySupportsDTMF = false;\r\n    this.authEnabled = false;\r\n    this.startAudioMuted = false;\r\n    this.startVideoMuted = false;\r\n    this.startMutedPolicy = {\r\n        audio: false,\r\n        video: false\r\n    };\r\n    this.isMutedByFocus = false;\r\n\r\n    // when muted by focus we receive the jid of the initiator of the mute\r\n    this.mutedByFocusActor = null;\r\n\r\n    this.isVideoMutedByFocus = false;\r\n\r\n    // when video muted by focus we receive the jid of the initiator of the mute\r\n    this.mutedVideoByFocusActor = null;\r\n\r\n    // Flag indicates if the 'onCallEnded' method was ever called on this\r\n    // instance. Used to log extra analytics event for debugging purpose.\r\n    // We need to know if the potential issue happened before or after\r\n    // the restart.\r\n    this.wasStopped = false;\r\n\r\n    // Conference properties, maintained by jicofo.\r\n    this.properties = {};\r\n\r\n    /**\r\n     * The object which monitors local and remote connection statistics (e.g.\r\n     * sending bitrate) and calculates a number which represents the connection\r\n     * quality.\r\n     */\r\n    this.connectionQuality\r\n        = new ConnectionQuality(this, this.eventEmitter, options);\r\n\r\n    /**\r\n     * Reports average RTP statistics to the analytics module.\r\n     * @type {AvgRTPStatsReporter}\r\n     */\r\n    this.avgRtpStatsReporter\r\n        = new AvgRTPStatsReporter(this, options.config.avgRtpStatsN || 15);\r\n\r\n    /**\r\n     * Detects issues with the audio of remote participants.\r\n     * @type {AudioOutputProblemDetector}\r\n     */\r\n    this._audioOutputProblemDetector = new AudioOutputProblemDetector(this);\r\n\r\n    /**\r\n     * Indicates whether the connection is interrupted or not.\r\n     */\r\n    this.isJvbConnectionInterrupted = false;\r\n\r\n    /**\r\n     * The object which tracks active speaker times\r\n     */\r\n    this.speakerStatsCollector = new SpeakerStatsCollector(this);\r\n\r\n    /* P2P related fields below: */\r\n\r\n    /**\r\n     * Stores reference to deferred start P2P task. It's created when 3rd\r\n     * participant leaves the room in order to avoid ping pong effect (it\r\n     * could be just a page reload).\r\n     * @type {number|null}\r\n     */\r\n    this.deferredStartP2PTask = null;\r\n\r\n    const delay\r\n        = parseInt(options.config.p2p && options.config.p2p.backToP2PDelay, 10);\r\n\r\n    /**\r\n     * A delay given in seconds, before the conference switches back to P2P\r\n     * after the 3rd participant has left.\r\n     * @type {number}\r\n     */\r\n    this.backToP2PDelay = isNaN(delay) ? 5 : delay;\r\n    logger.info(`backToP2PDelay: ${this.backToP2PDelay}`);\r\n\r\n    /**\r\n     * If set to <tt>true</tt> it means the P2P ICE is no longer connected.\r\n     * When <tt>false</tt> it means that P2P ICE (media) connection is up\r\n     * and running.\r\n     * @type {boolean}\r\n     */\r\n    this.isP2PConnectionInterrupted = false;\r\n\r\n    /**\r\n     * Flag set to <tt>true</tt> when P2P session has been established\r\n     * (ICE has been connected) and this conference is currently in the peer to\r\n     * peer mode (P2P connection is the active one).\r\n     * @type {boolean}\r\n     */\r\n    this.p2p = false;\r\n\r\n    /**\r\n     * A JingleSession for the direct peer to peer connection.\r\n     * @type {JingleSessionPC}\r\n     */\r\n    this.p2pJingleSession = null;\r\n\r\n    this.videoSIPGWHandler = new VideoSIPGW(this.room);\r\n    this.recordingManager = new RecordingManager(this.room);\r\n\r\n    /**\r\n     * If the conference.joined event has been sent this will store the timestamp when it happened.\r\n     *\r\n     * @type {undefined|number}\r\n     * @private\r\n     */\r\n    this._conferenceJoinAnalyticsEventSent = undefined;\r\n\r\n    /**\r\n     * End-to-End Encryption. Make it available if supported.\r\n     */\r\n    if (this.isE2EESupported()) {\r\n        logger.info('End-to-End Encryprtion is supported');\r\n\r\n        this._e2eEncryption = new E2EEncryption(this);\r\n    }\r\n}\r\n\r\n// FIXME convert JitsiConference to ES6 - ASAP !\r\nJitsiConference.prototype.constructor = JitsiConference;\r\n\r\n/**\r\n * Create a resource for the a jid. We use the room nickname (the resource part\r\n * of the occupant JID, see XEP-0045) as the endpoint ID in colibri. We require\r\n * endpoint IDs to be 8 hex digits because in some cases they get serialized\r\n * into a 32bit field.\r\n *\r\n * @param {string} jid - The id set onto the XMPP connection.\r\n * @param {boolean} isAuthenticatedUser - Whether or not the user has connected\r\n * to the XMPP service with a password.\r\n * @returns {string}\r\n * @static\r\n */\r\nJitsiConference.resourceCreator = function(jid, isAuthenticatedUser) {\r\n    let mucNickname;\r\n\r\n    if (isAuthenticatedUser) {\r\n        // For authenticated users generate a random ID.\r\n        mucNickname = RandomUtil.randomHexString(8).toLowerCase();\r\n    } else {\r\n        // We try to use the first part of the node (which for anonymous users\r\n        // on prosody is a UUID) to match the previous behavior (and maybe make\r\n        // debugging easier).\r\n        mucNickname = Strophe.getNodeFromJid(jid).substr(0, 8)\r\n            .toLowerCase();\r\n\r\n        // But if this doesn't have the required format we just generate a new\r\n        // random nickname.\r\n        const re = /[0-9a-f]{8}/g;\r\n\r\n        if (!re.test(mucNickname)) {\r\n            mucNickname = RandomUtil.randomHexString(8).toLowerCase();\r\n        }\r\n    }\r\n\r\n    return mucNickname;\r\n};\r\n\r\n/**\r\n * Initializes the conference object properties\r\n * @param options {object}\r\n * @param options.connection {JitsiConnection} overrides this.connection\r\n */\r\nJitsiConference.prototype._init = function(options = {}) {\r\n    // Override connection and xmpp properties (Useful if the connection\r\n    // reloaded)\r\n    if (options.connection) {\r\n        this.connection = options.connection;\r\n        this.xmpp = this.connection.xmpp;\r\n\r\n        // Setup XMPP events only if we have new connection object.\r\n        this.eventManager.setupXMPPListeners();\r\n    }\r\n\r\n    const { config } = this.options;\r\n\r\n    // Get the codec preference settings from config.js.\r\n    // 'preferH264' and 'disableH264' settings have been deprecated for a while,\r\n    // 'preferredCodec' and 'disabledCodec' will have precedence over them.\r\n    const codecSettings = {\r\n        disabledCodec: config.videoQuality\r\n            ? config.videoQuality.disabledCodec\r\n            : config.p2p && config.p2p.disableH264 && CodecMimeType.H264,\r\n        enforcePreferredCodec: config.videoQuality && config.videoQuality.enforcePreferredCodec,\r\n        jvbCodec: (config.videoQuality && config.videoQuality.preferredCodec)\r\n            || (config.preferH264 && CodecMimeType.H264),\r\n        p2pCodec: config.p2p\r\n            ? config.p2p.preferredCodec || (config.p2p.preferH264 && CodecMimeType.H264)\r\n            : CodecMimeType.VP8\r\n    };\r\n\r\n    this.codecSelection = new CodecSelection(this, codecSettings);\r\n    this._statsCurrentId = config.statisticsId ? config.statisticsId : Settings.callStatsUserName;\r\n    this.room = this.xmpp.createRoom(\r\n        this.options.name, {\r\n            ...config,\r\n            statsId: this._statsCurrentId\r\n        },\r\n        JitsiConference.resourceCreator\r\n    );\r\n\r\n    // Connection interrupted/restored listeners\r\n    this._onIceConnectionInterrupted\r\n        = this._onIceConnectionInterrupted.bind(this);\r\n    this.room.addListener(\r\n        XMPPEvents.CONNECTION_INTERRUPTED, this._onIceConnectionInterrupted);\r\n\r\n    this._onIceConnectionRestored = this._onIceConnectionRestored.bind(this);\r\n    this.room.addListener(\r\n        XMPPEvents.CONNECTION_RESTORED, this._onIceConnectionRestored);\r\n\r\n    this._onIceConnectionEstablished\r\n        = this._onIceConnectionEstablished.bind(this);\r\n    this.room.addListener(\r\n        XMPPEvents.CONNECTION_ESTABLISHED, this._onIceConnectionEstablished);\r\n\r\n    this._updateProperties = this._updateProperties.bind(this);\r\n    this.room.addListener(XMPPEvents.CONFERENCE_PROPERTIES_CHANGED,\r\n        this._updateProperties);\r\n\r\n    this._sendConferenceJoinAnalyticsEvent = this._sendConferenceJoinAnalyticsEvent.bind(this);\r\n    this.room.addListener(XMPPEvents.MEETING_ID_SET, this._sendConferenceJoinAnalyticsEvent);\r\n\r\n    this.e2eping = new E2ePing(\r\n        this,\r\n        config,\r\n        (message, to) => {\r\n            try {\r\n                this.sendMessage(\r\n                    message, to, true /* sendThroughVideobridge */);\r\n            } catch (error) {\r\n                logger.warn(`Failed to send E2E ping request or response to ${to}.`, error && error.msg);\r\n            }\r\n        });\r\n\r\n    if (!this.rtc) {\r\n        this.rtc = new RTC(this, options);\r\n        this.eventManager.setupRTCListeners();\r\n    }\r\n\r\n    this.receiveVideoController = new ReceiveVideoController(this, this.rtc);\r\n    this.sendVideoController = new SendVideoController(this, this.rtc);\r\n\r\n    this.participantConnectionStatus\r\n        = new ParticipantConnectionStatusHandler(\r\n            this.rtc,\r\n            this,\r\n            {\r\n                // Both these options are not public API, leaving it here only\r\n                // as an entry point through config for tuning up purposes.\r\n                // Default values should be adjusted as soon as optimal values\r\n                // are discovered.\r\n                rtcMuteTimeout: config._peerConnStatusRtcMuteTimeout,\r\n                outOfLastNTimeout: config._peerConnStatusOutOfLastNTimeout\r\n            });\r\n    this.participantConnectionStatus.init();\r\n\r\n    // Add the ability to enable callStats only on a percentage of users based on config.js settings.\r\n    let enableCallStats = true;\r\n\r\n    if (config.testing && config.testing.callStatsThreshold) {\r\n        enableCallStats = (Math.random() * 100) <= config.testing.callStatsThreshold;\r\n    }\r\n\r\n    if (!this.statistics) {\r\n        this.statistics = new Statistics(this.xmpp, {\r\n            aliasName: this._statsCurrentId,\r\n            userName: config.statisticsDisplayName ? config.statisticsDisplayName : this.myUserId(),\r\n            confID: config.confID || `${this.connection.options.hosts.domain}/${this.options.name}`,\r\n            siteID: config.siteID,\r\n            customScriptUrl: config.callStatsCustomScriptUrl,\r\n            callStatsID: config.callStatsID,\r\n            callStatsSecret: config.callStatsSecret,\r\n            callStatsApplicationLogsDisabled: config.callStatsApplicationLogsDisabled,\r\n            enableCallStats,\r\n            roomName: this.options.name,\r\n            applicationName: config.applicationName,\r\n            getWiFiStatsMethod: config.getWiFiStatsMethod\r\n        });\r\n        Statistics.analytics.addPermanentProperties({\r\n            'callstats_name': this._statsCurrentId\r\n        });\r\n\r\n        // Start performance observer for monitoring long tasks\r\n        if (config.longTasksStatsInterval) {\r\n            this.statistics.attachLongTasksStats(this);\r\n        }\r\n    }\r\n\r\n    this.eventManager.setupChatRoomListeners();\r\n\r\n    // Always add listeners because on reload we are executing leave and the\r\n    // listeners are removed from statistics module.\r\n    this.eventManager.setupStatisticsListeners();\r\n\r\n    // Disable VAD processing on Safari since it causes audio input to\r\n    // fail on some of the mobile devices.\r\n    if (config.enableTalkWhileMuted && browser.supportsVADDetection()) {\r\n        // If VAD processor factory method is provided uses VAD based detection, otherwise fallback to audio level\r\n        // based detection.\r\n        if (config.createVADProcessor) {\r\n            logger.info('Using VAD detection for generating talk while muted events');\r\n\r\n            if (!this._audioAnalyser) {\r\n                this._audioAnalyser = new VADAudioAnalyser(this, config.createVADProcessor);\r\n            }\r\n\r\n            const vadTalkMutedDetection = new VADTalkMutedDetection();\r\n\r\n            vadTalkMutedDetection.on(DetectionEvents.VAD_TALK_WHILE_MUTED, () =>\r\n                this.eventEmitter.emit(JitsiConferenceEvents.TALK_WHILE_MUTED));\r\n\r\n            this._audioAnalyser.addVADDetectionService(vadTalkMutedDetection);\r\n        } else {\r\n            logger.warn('No VAD Processor was provided. Talk while muted detection service was not initialized!');\r\n        }\r\n    }\r\n\r\n    // Disable noisy mic detection on safari since it causes the audio input to\r\n    // fail on Safari on iPadOS.\r\n    if (config.enableNoisyMicDetection && browser.supportsVADDetection()) {\r\n        if (config.createVADProcessor) {\r\n            if (!this._audioAnalyser) {\r\n                this._audioAnalyser = new VADAudioAnalyser(this, config.createVADProcessor);\r\n            }\r\n\r\n            const vadNoiseDetection = new VADNoiseDetection();\r\n\r\n            vadNoiseDetection.on(DetectionEvents.VAD_NOISY_DEVICE, () =>\r\n                this.eventEmitter.emit(JitsiConferenceEvents.NOISY_MIC));\r\n\r\n            this._audioAnalyser.addVADDetectionService(vadNoiseDetection);\r\n        } else {\r\n            logger.warn('No VAD Processor was provided. Noisy microphone detection service was not initialized!');\r\n        }\r\n    }\r\n\r\n    // Generates events based on no audio input detector.\r\n    if (config.enableNoAudioDetection) {\r\n        this._noAudioSignalDetection = new NoAudioSignalDetection(this);\r\n        this._noAudioSignalDetection.on(DetectionEvents.NO_AUDIO_INPUT, () => {\r\n            this.eventEmitter.emit(JitsiConferenceEvents.NO_AUDIO_INPUT);\r\n        });\r\n        this._noAudioSignalDetection.on(DetectionEvents.AUDIO_INPUT_STATE_CHANGE, hasAudioSignal => {\r\n            this.eventEmitter.emit(JitsiConferenceEvents.AUDIO_INPUT_STATE_CHANGE, hasAudioSignal);\r\n        });\r\n    }\r\n\r\n\r\n    if ('channelLastN' in config) {\r\n        this.setLastN(config.channelLastN);\r\n    }\r\n\r\n    /**\r\n     * Emits {@link JitsiConferenceEvents.JVB121_STATUS}.\r\n     * @type {Jvb121EventGenerator}\r\n     */\r\n    this.jvb121Status = new Jvb121EventGenerator(this);\r\n\r\n    // creates dominant speaker detection that works only in p2p mode\r\n    this.p2pDominantSpeakerDetection = new P2PDominantSpeakerDetection(this);\r\n\r\n    if (config && config.deploymentInfo && config.deploymentInfo.userRegion) {\r\n        this.setLocalParticipantProperty(\r\n            'region', config.deploymentInfo.userRegion);\r\n    }\r\n\r\n    // Publish the codec type to presence.\r\n    this.setLocalParticipantProperty('codecType', this.codecSelection.getPreferredCodec());\r\n};\r\n\r\n/**\r\n * Joins the conference.\r\n * @param password {string} the password\r\n */\r\nJitsiConference.prototype.join = function(password) {\r\n    if (this.room) {\r\n        this.room.join(password).then(() => this._maybeSetSITimeout());\r\n    }\r\n};\r\n\r\n/**\r\n * Authenticates and upgrades the role of the local participant/user.\r\n *\r\n * @returns {Object} A <tt>thenable</tt> which (1) settles when the process of\r\n * authenticating and upgrading the role of the local participant/user finishes\r\n * and (2) has a <tt>cancel</tt> method that allows the caller to interrupt the\r\n * process.\r\n */\r\nJitsiConference.prototype.authenticateAndUpgradeRole = function(options) {\r\n    return authenticateAndUpgradeRole.call(this, {\r\n        ...options,\r\n        onCreateResource: JitsiConference.resourceCreator\r\n    });\r\n};\r\n\r\n/**\r\n * Check if joined to the conference.\r\n */\r\nJitsiConference.prototype.isJoined = function() {\r\n    return this.room && this.room.joined;\r\n};\r\n\r\n/**\r\n * Tells whether or not the P2P mode is enabled in the configuration.\r\n * @return {boolean}\r\n */\r\nJitsiConference.prototype.isP2PEnabled = function() {\r\n    return Boolean(this.options.config.p2p && this.options.config.p2p.enabled)\r\n\r\n        // FIXME: remove once we have a default config template. -saghul\r\n        || typeof this.options.config.p2p === 'undefined';\r\n};\r\n\r\n/**\r\n * When in P2P test mode, the conference will not automatically switch to P2P\r\n * when there 2 participants.\r\n * @return {boolean}\r\n */\r\nJitsiConference.prototype.isP2PTestModeEnabled = function() {\r\n    return Boolean(this.options.config.testing\r\n        && this.options.config.testing.p2pTestMode);\r\n};\r\n\r\n/**\r\n * Leaves the conference.\r\n * @returns {Promise}\r\n */\r\nJitsiConference.prototype.leave = function() {\r\n    if (this.participantConnectionStatus) {\r\n        this.participantConnectionStatus.dispose();\r\n        this.participantConnectionStatus = null;\r\n    }\r\n    if (this.avgRtpStatsReporter) {\r\n        this.avgRtpStatsReporter.dispose();\r\n        this.avgRtpStatsReporter = null;\r\n    }\r\n\r\n    if (this._audioOutputProblemDetector) {\r\n        this._audioOutputProblemDetector.dispose();\r\n        this._audioOutputProblemDetector = null;\r\n    }\r\n\r\n    if (this.e2eping) {\r\n        this.e2eping.stop();\r\n        this.e2eping = null;\r\n    }\r\n\r\n    this.getLocalTracks().forEach(track => this.onLocalTrackRemoved(track));\r\n\r\n    this.rtc.closeBridgeChannel();\r\n\r\n    this._sendConferenceLeftAnalyticsEvent();\r\n\r\n    if (this.statistics) {\r\n        this.statistics.dispose();\r\n    }\r\n\r\n    this._delayedIceFailed && this._delayedIceFailed.cancel();\r\n\r\n    // Close both JVb and P2P JingleSessions\r\n    if (this.jvbJingleSession) {\r\n        this.jvbJingleSession.close();\r\n        this.jvbJingleSession = null;\r\n    }\r\n    if (this.p2pJingleSession) {\r\n        this.p2pJingleSession.close();\r\n        this.p2pJingleSession = null;\r\n    }\r\n\r\n    // leave the conference\r\n    if (this.room) {\r\n        const room = this.room;\r\n\r\n        // Unregister connection state listeners\r\n        room.removeListener(\r\n            XMPPEvents.CONNECTION_INTERRUPTED,\r\n            this._onIceConnectionInterrupted);\r\n        room.removeListener(\r\n            XMPPEvents.CONNECTION_RESTORED,\r\n            this._onIceConnectionRestored);\r\n        room.removeListener(\r\n            XMPPEvents.CONNECTION_ESTABLISHED,\r\n            this._onIceConnectionEstablished);\r\n\r\n        room.removeListener(\r\n            XMPPEvents.CONFERENCE_PROPERTIES_CHANGED,\r\n            this._updateProperties);\r\n\r\n        room.removeListener(XMPPEvents.MEETING_ID_SET, this._sendConferenceJoinAnalyticsEvent);\r\n\r\n        this.eventManager.removeXMPPListeners();\r\n\r\n        this.room = null;\r\n\r\n        return room.leave()\r\n            .then(() => {\r\n                if (this.rtc) {\r\n                    this.rtc.destroy();\r\n                }\r\n            })\r\n            .catch(error => {\r\n                // remove all participants because currently the conference\r\n                // won't be usable anyway. This is done on success automatically\r\n                // by the ChatRoom instance.\r\n                this.getParticipants().forEach(\r\n                    participant => this.onMemberLeft(participant.getJid()));\r\n\r\n                throw error;\r\n            });\r\n    }\r\n\r\n    // If this.room == null we are calling second time leave().\r\n    return Promise.reject(\r\n        new Error('The conference is has been already left'));\r\n};\r\n\r\n/**\r\n * Returns the currently active media session if any.\r\n *\r\n * @returns {JingleSessionPC|undefined}\r\n * @private\r\n */\r\nJitsiConference.prototype._getActiveMediaSession = function() {\r\n    return this.isP2PActive() ? this.p2pJingleSession : this.jvbJingleSession;\r\n};\r\n\r\n/**\r\n * Returns an array containing all media sessions existing in this conference.\r\n *\r\n * @returns {Array<JingleSessionPC>}\r\n * @private\r\n */\r\nJitsiConference.prototype._getMediaSessions = function() {\r\n    const sessions = [];\r\n\r\n    this.jvbJingleSession && sessions.push(this.jvbJingleSession);\r\n    this.p2pJingleSession && sessions.push(this.p2pJingleSession);\r\n\r\n    return sessions;\r\n};\r\n\r\n/**\r\n * Returns name of this conference.\r\n */\r\nJitsiConference.prototype.getName = function() {\r\n    return this.options.name;\r\n};\r\n\r\n/**\r\n * Returns the {@link JitsiConnection} used by this this conference.\r\n */\r\nJitsiConference.prototype.getConnection = function() {\r\n    return this.connection;\r\n};\r\n\r\n/**\r\n * Check if authentication is enabled for this conference.\r\n */\r\nJitsiConference.prototype.isAuthEnabled = function() {\r\n    return this.authEnabled;\r\n};\r\n\r\n/**\r\n * Check if user is logged in.\r\n */\r\nJitsiConference.prototype.isLoggedIn = function() {\r\n    return Boolean(this.authIdentity);\r\n};\r\n\r\n/**\r\n * Get authorized login.\r\n */\r\nJitsiConference.prototype.getAuthLogin = function() {\r\n    return this.authIdentity;\r\n};\r\n\r\n/**\r\n * Check if external authentication is enabled for this conference.\r\n */\r\nJitsiConference.prototype.isExternalAuthEnabled = function() {\r\n    return this.room && this.room.moderator.isExternalAuthEnabled();\r\n};\r\n\r\n/**\r\n * Get url for external authentication.\r\n * @param {boolean} [urlForPopup] if true then return url for login popup,\r\n *                                else url of login page.\r\n * @returns {Promise}\r\n */\r\nJitsiConference.prototype.getExternalAuthUrl = function(urlForPopup) {\r\n    return new Promise((resolve, reject) => {\r\n        if (!this.isExternalAuthEnabled()) {\r\n            reject();\r\n\r\n            return;\r\n        }\r\n        if (urlForPopup) {\r\n            this.room.moderator.getPopupLoginUrl(resolve, reject);\r\n        } else {\r\n            this.room.moderator.getLoginUrl(resolve, reject);\r\n        }\r\n    });\r\n};\r\n\r\n/**\r\n * Returns the local tracks of the given media type, or all local tracks if no\r\n * specific type is given.\r\n * @param {MediaType} [mediaType] Optional media type (audio or video).\r\n */\r\nJitsiConference.prototype.getLocalTracks = function(mediaType) {\r\n    let tracks = [];\r\n\r\n    if (this.rtc) {\r\n        tracks = this.rtc.getLocalTracks(mediaType);\r\n    }\r\n\r\n    return tracks;\r\n};\r\n\r\n/**\r\n * Obtains local audio track.\r\n * @return {JitsiLocalTrack|null}\r\n */\r\nJitsiConference.prototype.getLocalAudioTrack = function() {\r\n    return this.rtc ? this.rtc.getLocalAudioTrack() : null;\r\n};\r\n\r\n/**\r\n * Obtains local video track.\r\n * @return {JitsiLocalTrack|null}\r\n */\r\nJitsiConference.prototype.getLocalVideoTrack = function() {\r\n    return this.rtc ? this.rtc.getLocalVideoTrack() : null;\r\n};\r\n\r\n/**\r\n * Obtains the performance statistics.\r\n * @returns {Object|null}\r\n */\r\nJitsiConference.prototype.getPerformanceStats = function() {\r\n    return {\r\n        longTasksStats: this.statistics.getLongTasksStats()\r\n    };\r\n};\r\n\r\n/**\r\n * Attaches a handler for events(For example - \"participant joined\".) in the\r\n * conference. All possible event are defined in JitsiConferenceEvents.\r\n * @param eventId the event ID.\r\n * @param handler handler for the event.\r\n *\r\n * Note: consider adding eventing functionality by extending an EventEmitter\r\n * impl, instead of rolling ourselves\r\n */\r\nJitsiConference.prototype.on = function(eventId, handler) {\r\n    if (this.eventEmitter) {\r\n        this.eventEmitter.on(eventId, handler);\r\n    }\r\n};\r\n\r\n/**\r\n * Removes event listener\r\n * @param eventId the event ID.\r\n * @param [handler] optional, the specific handler to unbind\r\n *\r\n * Note: consider adding eventing functionality by extending an EventEmitter\r\n * impl, instead of rolling ourselves\r\n */\r\nJitsiConference.prototype.off = function(eventId, handler) {\r\n    if (this.eventEmitter) {\r\n        this.eventEmitter.removeListener(eventId, handler);\r\n    }\r\n};\r\n\r\n// Common aliases for event emitter\r\nJitsiConference.prototype.addEventListener = JitsiConference.prototype.on;\r\nJitsiConference.prototype.removeEventListener = JitsiConference.prototype.off;\r\n\r\n/**\r\n * Receives notifications from other participants about commands / custom events\r\n * (sent by sendCommand or sendCommandOnce methods).\r\n * @param command {String} the name of the command\r\n * @param handler {Function} handler for the command\r\n */\r\nJitsiConference.prototype.addCommandListener = function(command, handler) {\r\n    if (this.room) {\r\n        this.room.addPresenceListener(command, handler);\r\n    }\r\n};\r\n\r\n/**\r\n  * Removes command  listener\r\n  * @param command {String} the name of the command\r\n  * @param handler {Function} handler to remove for the command\r\n  */\r\nJitsiConference.prototype.removeCommandListener = function(command, handler) {\r\n    if (this.room) {\r\n        this.room.removePresenceListener(command, handler);\r\n    }\r\n};\r\n\r\n/**\r\n * Sends text message to the other participants in the conference\r\n * @param message the text message.\r\n * @param elementName the element name to encapsulate the message.\r\n * @deprecated Use 'sendMessage' instead. TODO: this should be private.\r\n */\r\nJitsiConference.prototype.sendTextMessage = function(\r\n        message, elementName = 'body') {\r\n    if (this.room) {\r\n        this.room.sendMessage(message, elementName);\r\n    }\r\n};\r\n\r\n/**\r\n * Send private text message to another participant of the conference\r\n * @param id the id of the participant to send a private message.\r\n * @param message the text message.\r\n * @param elementName the element name to encapsulate the message.\r\n * @deprecated Use 'sendMessage' instead. TODO: this should be private.\r\n */\r\nJitsiConference.prototype.sendPrivateTextMessage = function(\r\n        id, message, elementName = 'body') {\r\n    if (this.room) {\r\n        this.room.sendPrivateMessage(id, message, elementName);\r\n    }\r\n};\r\n\r\n/**\r\n * Send presence command.\r\n * @param name {String} the name of the command.\r\n * @param values {Object} with keys and values that will be sent.\r\n **/\r\nJitsiConference.prototype.sendCommand = function(name, values) {\r\n    if (this.room) {\r\n        this.room.addOrReplaceInPresence(name, values) && this.room.sendPresence();\r\n    } else {\r\n        logger.warn('Not sending a command, room not initialized.');\r\n    }\r\n\r\n};\r\n\r\n/**\r\n * Send presence command one time.\r\n * @param name {String} the name of the command.\r\n * @param values {Object} with keys and values that will be sent.\r\n **/\r\nJitsiConference.prototype.sendCommandOnce = function(name, values) {\r\n    this.sendCommand(name, values);\r\n    this.removeCommand(name);\r\n};\r\n\r\n/**\r\n * Removes presence command.\r\n * @param name {String} the name of the command.\r\n **/\r\nJitsiConference.prototype.removeCommand = function(name) {\r\n    if (this.room) {\r\n        this.room.removeFromPresence(name);\r\n    }\r\n};\r\n\r\n/**\r\n * Sets the display name for this conference.\r\n * @param name the display name to set\r\n */\r\nJitsiConference.prototype.setDisplayName = function(name) {\r\n    if (this.room) {\r\n        this.room.addOrReplaceInPresence('nick', {\r\n            attributes: { xmlns: 'http://jabber.org/protocol/nick' },\r\n            value: name\r\n        }) && this.room.sendPresence();\r\n    }\r\n};\r\n\r\n/**\r\n * Set new subject for this conference. (available only for moderator)\r\n * @param {string} subject new subject\r\n */\r\nJitsiConference.prototype.setSubject = function(subject) {\r\n    if (this.room && this.isModerator()) {\r\n        this.room.setSubject(subject);\r\n    } else {\r\n        logger.warn(`Failed to set subject, ${this.room ? '' : 'not in a room, '}${\r\n            this.isModerator() ? '' : 'participant is not a moderator'}`);\r\n    }\r\n};\r\n\r\n/**\r\n * Get a transcriber object for all current participants in this conference\r\n * @return {Transcriber} the transcriber object\r\n */\r\nJitsiConference.prototype.getTranscriber = function() {\r\n    if (this.transcriber === undefined) {\r\n        this.transcriber = new Transcriber();\r\n\r\n        // add all existing local audio tracks to the transcriber\r\n        const localAudioTracks = this.getLocalTracks(MediaType.AUDIO);\r\n\r\n        for (const localAudio of localAudioTracks) {\r\n            this.transcriber.addTrack(localAudio);\r\n        }\r\n\r\n        // and all remote audio tracks\r\n        const remoteAudioTracks = this.rtc.getRemoteTracks(MediaType.AUDIO);\r\n\r\n        for (const remoteTrack of remoteAudioTracks) {\r\n            this.transcriber.addTrack(remoteTrack);\r\n        }\r\n    }\r\n\r\n    return this.transcriber;\r\n};\r\n\r\n/**\r\n * Returns the transcription status.\r\n *\r\n * @returns {String} \"on\" or \"off\".\r\n */\r\nJitsiConference.prototype.getTranscriptionStatus = function() {\r\n    return this.room.transcriptionStatus;\r\n};\r\n\r\n/**\r\n * Adds JitsiLocalTrack object to the conference.\r\n * @param {JitsiLocalTrack} track the JitsiLocalTrack object.\r\n * @returns {Promise<JitsiLocalTrack>}\r\n * @throws {Error} if the specified track is a video track and there is already\r\n * another video track in the conference.\r\n */\r\nJitsiConference.prototype.addTrack = function(track) {\r\n    const mediaType = track.getType();\r\n    const localTracks = this.rtc.getLocalTracks(mediaType);\r\n\r\n    // Ensure there's exactly 1 local track of each media type in the conference.\r\n    if (localTracks.length > 0) {\r\n        // Don't be excessively harsh and severe if the API client happens to attempt to add the same local track twice.\r\n        if (track === localTracks[0]) {\r\n            return Promise.resolve(track);\r\n        }\r\n\r\n        return Promise.reject(new Error(`Cannot add second ${mediaType} track to the conference`));\r\n    }\r\n\r\n    return this.replaceTrack(null, track);\r\n};\r\n\r\n/**\r\n * Fires TRACK_AUDIO_LEVEL_CHANGED change conference event (for local tracks).\r\n * @param {number} audioLevel the audio level\r\n * @param {TraceablePeerConnection} [tpc]\r\n */\r\nJitsiConference.prototype._fireAudioLevelChangeEvent = function(\r\n        audioLevel,\r\n        tpc) {\r\n    const activeTpc = this.getActivePeerConnection();\r\n\r\n    // There will be no TraceablePeerConnection if audio levels do not come from\r\n    // a peerconnection. LocalStatsCollector.js measures audio levels using Web\r\n    // Audio Analyser API and emits local audio levels events through\r\n    // JitsiTrack.setAudioLevel, but does not provide TPC instance which is\r\n    // optional.\r\n    if (!tpc || activeTpc === tpc) {\r\n        this.eventEmitter.emit(\r\n            JitsiConferenceEvents.TRACK_AUDIO_LEVEL_CHANGED,\r\n            this.myUserId(), audioLevel);\r\n    }\r\n};\r\n\r\n/**\r\n * Fires TRACK_MUTE_CHANGED change conference event.\r\n * @param track the JitsiTrack object related to the event.\r\n */\r\nJitsiConference.prototype._fireMuteChangeEvent = function(track) {\r\n    // check if track was muted by focus and now is unmuted by user\r\n    if (this.isMutedByFocus && track.isAudioTrack() && !track.isMuted()) {\r\n        this.isMutedByFocus = false;\r\n\r\n        // unmute local user on server\r\n        this.room.muteParticipant(this.room.myroomjid, false, MediaType.AUDIO);\r\n    } else if (this.isVideoMutedByFocus && track.isVideoTrack() && !track.isMuted()) {\r\n        this.isVideoMutedByFocus = false;\r\n\r\n        // unmute local user on server\r\n        this.room.muteParticipant(this.room.myroomjid, false, MediaType.VIDEO);\r\n    }\r\n\r\n    let actorParticipant;\r\n\r\n    if (this.mutedByFocusActor && track.isAudioTrack()) {\r\n        const actorId = Strophe.getResourceFromJid(this.mutedByFocusActor);\r\n\r\n        actorParticipant = this.participants[actorId];\r\n    } else if (this.mutedVideoByFocusActor && track.isVideoTrack()) {\r\n        const actorId = Strophe.getResourceFromJid(this.mutedVideoByFocusActor);\r\n\r\n        actorParticipant = this.participants[actorId];\r\n    }\r\n\r\n    this.eventEmitter.emit(JitsiConferenceEvents.TRACK_MUTE_CHANGED, track, actorParticipant);\r\n};\r\n\r\n/**\r\n * Returns the list of local tracks that need to be added to the peerconnection on join.\r\n * This takes the startAudioMuted/startVideoMuted flags into consideration since we do not\r\n * want to add the tracks if the user joins the call audio/video muted. The tracks will be\r\n * added when the user unmutes for the first time.\r\n * @returns {Array<JitsiLocalTrack>} - list of local tracks that are unmuted.\r\n */\r\nJitsiConference.prototype._getInitialLocalTracks = function() {\r\n    return this.getLocalTracks()\r\n        .filter(track => (track.getType() === MediaType.AUDIO && !this.isStartAudioMuted())\r\n        || (track.getType() === MediaType.VIDEO && !this.isStartVideoMuted()));\r\n};\r\n\r\n/**\r\n * Clear JitsiLocalTrack properties and listeners.\r\n * @param track the JitsiLocalTrack object.\r\n */\r\nJitsiConference.prototype.onLocalTrackRemoved = function(track) {\r\n    track._setConference(null);\r\n    this.rtc.removeLocalTrack(track);\r\n    track.removeEventListener(JitsiTrackEvents.TRACK_MUTE_CHANGED,\r\n        track.muteHandler);\r\n    track.removeEventListener(JitsiTrackEvents.TRACK_AUDIO_LEVEL_CHANGED,\r\n        track.audioLevelHandler);\r\n\r\n    // send event for stopping screen sharing\r\n    // FIXME: we assume we have only one screen sharing track\r\n    // if we change this we need to fix this check\r\n    if (track.isVideoTrack() && track.videoType === VideoType.DESKTOP) {\r\n        this.statistics.sendScreenSharingEvent(false);\r\n    }\r\n\r\n    this.eventEmitter.emit(JitsiConferenceEvents.TRACK_REMOVED, track);\r\n};\r\n\r\n/**\r\n * Removes JitsiLocalTrack from the conference and performs\r\n * a new offer/answer cycle.\r\n * @param {JitsiLocalTrack} track\r\n * @returns {Promise}\r\n */\r\nJitsiConference.prototype.removeTrack = function(track) {\r\n    return this.replaceTrack(track, null);\r\n};\r\n\r\n/**\r\n * Replaces oldTrack with newTrack and performs a single offer/answer\r\n *  cycle after both operations are done.  Either oldTrack or newTrack\r\n *  can be null; replacing a valid 'oldTrack' with a null 'newTrack'\r\n *  effectively just removes 'oldTrack'\r\n * @param {JitsiLocalTrack} oldTrack the current stream in use to be replaced\r\n * @param {JitsiLocalTrack} newTrack the new stream to use\r\n * @returns {Promise} resolves when the replacement is finished\r\n */\r\nJitsiConference.prototype.replaceTrack = function(oldTrack, newTrack) {\r\n    // First do the removal of the oldTrack at the JitsiConference level\r\n    if (oldTrack) {\r\n        if (oldTrack.disposed) {\r\n            return Promise.reject(\r\n                new JitsiTrackError(JitsiTrackErrors.TRACK_IS_DISPOSED));\r\n        }\r\n    }\r\n    if (newTrack) {\r\n        if (newTrack.disposed) {\r\n            return Promise.reject(\r\n                new JitsiTrackError(JitsiTrackErrors.TRACK_IS_DISPOSED));\r\n        }\r\n    }\r\n\r\n    // Now replace the stream at the lower levels\r\n    return this._doReplaceTrack(oldTrack, newTrack)\r\n        .then(() => {\r\n            if (oldTrack) {\r\n                this.onLocalTrackRemoved(oldTrack);\r\n            }\r\n\r\n            // Send 'VideoTypeMessage' on the bridge channel for the new track.\r\n            if (newTrack) {\r\n                // Now handle the addition of the newTrack at the JitsiConference level\r\n                this._setupNewTrack(newTrack);\r\n                newTrack.isVideoTrack() && this.rtc.setVideoType(newTrack.videoType);\r\n            } else {\r\n                oldTrack && oldTrack.isVideoTrack() && this.rtc.setVideoType(VideoType.NONE);\r\n            }\r\n\r\n            if (this.isMutedByFocus || this.isVideoMutedByFocus) {\r\n                this._fireMuteChangeEvent(newTrack);\r\n            }\r\n\r\n            return Promise.resolve();\r\n        })\r\n        .catch(error => Promise.reject(new Error(error)));\r\n};\r\n\r\n/**\r\n * Replaces the tracks at the lower level by going through the Jingle session\r\n * and WebRTC peer connection. The method will resolve immediately if there is\r\n * currently no JingleSession started.\r\n * @param {JitsiLocalTrack|null} oldTrack the track to be removed during\r\n * the process or <tt>null</t> if the method should act as \"add track\"\r\n * @param {JitsiLocalTrack|null} newTrack the new track to be added or\r\n * <tt>null</tt> if the method should act as \"remove track\"\r\n * @return {Promise} resolved when the process is done or rejected with a string\r\n * which describes the error.\r\n * @private\r\n */\r\nJitsiConference.prototype._doReplaceTrack = function(oldTrack, newTrack) {\r\n    const replaceTrackPromises = [];\r\n\r\n    if (this.jvbJingleSession) {\r\n        replaceTrackPromises.push(\r\n            this.jvbJingleSession.replaceTrack(oldTrack, newTrack));\r\n    } else {\r\n        logger.info('_doReplaceTrack - no JVB JingleSession');\r\n    }\r\n\r\n    if (this.p2pJingleSession) {\r\n        replaceTrackPromises.push(\r\n            this.p2pJingleSession.replaceTrack(oldTrack, newTrack));\r\n    } else {\r\n        logger.info('_doReplaceTrack - no P2P JingleSession');\r\n    }\r\n\r\n    return Promise.all(replaceTrackPromises);\r\n};\r\n\r\n/**\r\n * Operations related to creating a new track\r\n * @param {JitsiLocalTrack} newTrack the new track being created\r\n */\r\nJitsiConference.prototype._setupNewTrack = function(newTrack) {\r\n    if (newTrack.isAudioTrack() || (newTrack.isVideoTrack()\r\n            && newTrack.videoType !== VideoType.DESKTOP)) {\r\n        // Report active device to statistics\r\n        const devices = RTC.getCurrentlyAvailableMediaDevices();\r\n        const device\r\n            = devices.find(\r\n                d =>\r\n                    d.kind === `${newTrack.getTrack().kind}input`\r\n                        && d.label === newTrack.getTrack().label);\r\n\r\n        if (device) {\r\n            Statistics.sendActiveDeviceListEvent(\r\n                RTC.getEventDataForActiveDevice(device));\r\n        }\r\n    }\r\n    if (newTrack.isVideoTrack()) {\r\n        const videoTypeTagName = 'videoType';\r\n\r\n        // if video type is camera and there is no videoType in presence, we skip adding it, as this is the default one\r\n        if (newTrack.videoType !== VideoType.CAMERA || this.room.getFromPresence(videoTypeTagName)) {\r\n            this.sendCommand(videoTypeTagName, { value: newTrack.videoType });\r\n        }\r\n    }\r\n    this.rtc.addLocalTrack(newTrack);\r\n\r\n    // ensure that we're sharing proper \"is muted\" state\r\n    if (newTrack.isAudioTrack()) {\r\n        this.room.setAudioMute(newTrack.isMuted());\r\n    } else {\r\n        this.room.setVideoMute(newTrack.isMuted());\r\n    }\r\n\r\n    newTrack.muteHandler = this._fireMuteChangeEvent.bind(this, newTrack);\r\n    newTrack.audioLevelHandler = this._fireAudioLevelChangeEvent.bind(this);\r\n    newTrack.addEventListener(\r\n        JitsiTrackEvents.TRACK_MUTE_CHANGED,\r\n        newTrack.muteHandler);\r\n    newTrack.addEventListener(\r\n        JitsiTrackEvents.TRACK_AUDIO_LEVEL_CHANGED,\r\n        newTrack.audioLevelHandler);\r\n\r\n    newTrack._setConference(this);\r\n\r\n    this.eventEmitter.emit(JitsiConferenceEvents.TRACK_ADDED, newTrack);\r\n};\r\n\r\n/**\r\n * Method called by the {@link JitsiLocalTrack} (a video one) in order to add\r\n * back the underlying WebRTC MediaStream to the PeerConnection (which has\r\n * removed on video mute).\r\n * @param {JitsiLocalTrack} track the local track that will be added as part of\r\n * the unmute operation.\r\n * @return {Promise} resolved when the process is done or rejected with a string\r\n * which describes the error.\r\n */\r\nJitsiConference.prototype._addLocalTrackAsUnmute = function(track) {\r\n    const addAsUnmutePromises = [];\r\n\r\n    if (this.jvbJingleSession) {\r\n        addAsUnmutePromises.push(this.jvbJingleSession.addTrackAsUnmute(track));\r\n    } else {\r\n        logger.debug('Add local MediaStream as unmute - no JVB Jingle session started yet');\r\n    }\r\n\r\n    if (this.p2pJingleSession) {\r\n        addAsUnmutePromises.push(this.p2pJingleSession.addTrackAsUnmute(track));\r\n    } else {\r\n        logger.debug('Add local MediaStream as unmute - no P2P Jingle session started yet');\r\n    }\r\n\r\n    return Promise.allSettled(addAsUnmutePromises)\r\n        .then(() => {\r\n            // Signal the video type to the bridge.\r\n            track.isVideoTrack() && this.rtc.setVideoType(track.videoType);\r\n        });\r\n};\r\n\r\n/**\r\n * Method called by the {@link JitsiLocalTrack} (a video one) in order to remove\r\n * the underlying WebRTC MediaStream from the PeerConnection. The purpose of\r\n * that is to stop sending any data and turn off the HW camera device.\r\n * @param {JitsiLocalTrack} track the local track that will be removed.\r\n * @return {Promise}\r\n */\r\nJitsiConference.prototype._removeLocalTrackAsMute = function(track) {\r\n    const removeAsMutePromises = [];\r\n\r\n    if (this.jvbJingleSession) {\r\n        removeAsMutePromises.push(this.jvbJingleSession.removeTrackAsMute(track));\r\n    } else {\r\n        logger.debug('Remove local MediaStream - no JVB JingleSession started yet');\r\n    }\r\n    if (this.p2pJingleSession) {\r\n        removeAsMutePromises.push(this.p2pJingleSession.removeTrackAsMute(track));\r\n    } else {\r\n        logger.debug('Remove local MediaStream - no P2P JingleSession started yet');\r\n    }\r\n\r\n    return Promise.allSettled(removeAsMutePromises)\r\n        .then(() => {\r\n            // Signal the video type to the bridge.\r\n            track.isVideoTrack() && this.rtc.setVideoType(VideoType.NONE);\r\n        });\r\n};\r\n\r\n/**\r\n * Get role of the local user.\r\n * @returns {string} user role: 'moderator' or 'none'\r\n */\r\nJitsiConference.prototype.getRole = function() {\r\n    return this.room.role;\r\n};\r\n\r\n/**\r\n * Returns whether or not the current conference has been joined as a hidden\r\n * user.\r\n *\r\n * @returns {boolean|null} True if hidden, false otherwise. Will return null if\r\n * no connection is active.\r\n */\r\nJitsiConference.prototype.isHidden = function() {\r\n    if (!this.connection) {\r\n        return null;\r\n    }\r\n\r\n    return Strophe.getDomainFromJid(this.connection.getJid())\r\n        === this.options.config.hiddenDomain;\r\n};\r\n\r\n/**\r\n * Check if local user is moderator.\r\n * @returns {boolean|null} true if local user is moderator, false otherwise. If\r\n * we're no longer in the conference room then <tt>null</tt> is returned.\r\n */\r\nJitsiConference.prototype.isModerator = function() {\r\n    return this.room ? this.room.isModerator() : null;\r\n};\r\n\r\n/**\r\n * Set password for the room.\r\n * @param {string} password new password for the room.\r\n * @returns {Promise}\r\n */\r\nJitsiConference.prototype.lock = function(password) {\r\n    if (!this.isModerator()) {\r\n        return Promise.reject(new Error('You are not moderator.'));\r\n    }\r\n\r\n    return new Promise((resolve, reject) => {\r\n        this.room.lockRoom(\r\n            password || '',\r\n            () => resolve(),\r\n            err => reject(err),\r\n            () => reject(JitsiConferenceErrors.PASSWORD_NOT_SUPPORTED));\r\n    });\r\n};\r\n\r\n/**\r\n * Remove password from the room.\r\n * @returns {Promise}\r\n */\r\nJitsiConference.prototype.unlock = function() {\r\n    return this.lock();\r\n};\r\n\r\n/**\r\n * Elects the participant with the given id to be the selected participant in\r\n * order to receive higher video quality (if simulcast is enabled).\r\n * Or cache it if channel is not created and send it once channel is available.\r\n * @param participantId the identifier of the participant\r\n * @throws NetworkError or InvalidStateError or Error if the operation fails.\r\n * @returns {void}\r\n */\r\nJitsiConference.prototype.selectParticipant = function(participantId) {\r\n    this.selectParticipants([ participantId ]);\r\n};\r\n\r\n/*\r\n * Elects participants with given ids to be the selected participants in order\r\n * to receive higher video quality (if simulcast is enabled). The argument\r\n * should be an array of participant id strings or an empty array; an error will\r\n * be thrown if a non-array is passed in. The error is thrown as a layer of\r\n * protection against passing an invalid argument, as the error will happen in\r\n * the bridge and may not be visible in the client.\r\n *\r\n * @param {Array<strings>} participantIds - An array of identifiers for\r\n * participants.\r\n * @returns {void}\r\n */\r\nJitsiConference.prototype.selectParticipants = function(participantIds) {\r\n    if (!Array.isArray(participantIds)) {\r\n        throw new Error('Invalid argument; participantIds must be an array.');\r\n    }\r\n\r\n    this.receiveVideoController.selectEndpoints(participantIds);\r\n};\r\n\r\n/**\r\n * Obtains the current value for \"lastN\". See {@link setLastN} for more info.\r\n * @returns {number}\r\n */\r\nJitsiConference.prototype.getLastN = function() {\r\n    return this.receiveVideoController.getLastN();\r\n};\r\n\r\n/**\r\n * Selects a new value for \"lastN\". The requested amount of videos are going\r\n * to be delivered after the value is in effect. Set to -1 for unlimited or\r\n * all available videos.\r\n * @param lastN the new number of videos the user would like to receive.\r\n * @throws Error or RangeError if the given value is not a number or is smaller\r\n * than -1.\r\n */\r\nJitsiConference.prototype.setLastN = function(lastN) {\r\n    if (!Number.isInteger(lastN) && !Number.parseInt(lastN, 10)) {\r\n        throw new Error(`Invalid value for lastN: ${lastN}`);\r\n    }\r\n    const n = Number(lastN);\r\n\r\n    if (n < -1) {\r\n        throw new RangeError('lastN cannot be smaller than -1');\r\n    }\r\n    this.receiveVideoController.setLastN(n);\r\n\r\n    // If the P2P session is not fully established yet, we wait until it gets\r\n    // established.\r\n    if (this.p2pJingleSession) {\r\n        const isVideoActive = n !== 0;\r\n\r\n        this.p2pJingleSession\r\n            .setMediaTransferActive(true, isVideoActive)\r\n            .catch(error => {\r\n                logger.error(\r\n                    `Failed to adjust video transfer status (${isVideoActive})`,\r\n                    error);\r\n            });\r\n    }\r\n};\r\n\r\n\r\nJitsiConference.prototype.setPerceptibles = function(perceptibles) {\r\n    this.rtc.setPerceptibles(perceptibles);\r\n};\r\n\r\n/**\r\n * Checks if the participant given by participantId is currently included in\r\n * the last N.\r\n * @param {string} participantId the identifier of the participant we would\r\n * like to check.\r\n * @return {boolean} true if the participant with id is in the last N set or\r\n * if there's no last N set, false otherwise.\r\n * @deprecated this method should never be used to figure out the UI, but\r\n * {@link ParticipantConnectionStatus} should be used instead.\r\n */\r\nJitsiConference.prototype.isInLastN = function(participantId) {\r\n    return this.rtc.isInLastN(participantId);\r\n};\r\n\r\n/**\r\n * @return Array<JitsiParticipant> an array of all participants in this\r\n * conference.\r\n */\r\nJitsiConference.prototype.getParticipants = function() {\r\n    return Object.values(this.participants);\r\n};\r\n\r\n/**\r\n * Returns the number of participants in the conference, including the local\r\n * participant.\r\n * @param countHidden {boolean} Whether or not to include hidden participants\r\n * in the count. Default: false.\r\n **/\r\nJitsiConference.prototype.getParticipantCount\r\n    = function(countHidden = false) {\r\n\r\n        let participants = this.getParticipants();\r\n\r\n        if (!countHidden) {\r\n            participants = participants.filter(p => !p.isHidden());\r\n        }\r\n\r\n        // Add one for the local participant.\r\n        return participants.length + 1;\r\n    };\r\n\r\n/**\r\n * @returns {JitsiParticipant} the participant in this conference with the\r\n * specified id (or undefined if there isn't one).\r\n * @param id the id of the participant.\r\n */\r\nJitsiConference.prototype.getParticipantById = function(id) {\r\n    return this.participants[id];\r\n};\r\n\r\n/**\r\n * Grant owner rights to the participant.\r\n * @param {string} id id of the participant to grant owner rights to.\r\n */\r\nJitsiConference.prototype.grantOwner = function(id) {\r\n    const participant = this.getParticipantById(id);\r\n\r\n    if (!participant) {\r\n        return;\r\n    }\r\n    this.room.setAffiliation(participant.getJid(), 'owner');\r\n};\r\n\r\n/**\r\n * Revoke owner rights to the participant or local Participant as\r\n * the user might want to refuse to be a moderator.\r\n * @param {string} id id of the participant to revoke owner rights to.\r\n */\r\nJitsiConference.prototype.revokeOwner = function(id) {\r\n    const participant = this.getParticipantById(id);\r\n    const isMyself = this.myUserId() === id;\r\n    const role = this.isMembersOnly() ? 'member' : 'none';\r\n\r\n    if (isMyself) {\r\n        this.room.setAffiliation(this.room.myroomjid, role);\r\n    } else if (participant) {\r\n        this.room.setAffiliation(participant.getJid(), role);\r\n    }\r\n};\r\n\r\n\r\n/**\r\n * Kick participant from this conference.\r\n * @param {string} id id of the participant to kick\r\n * @param {string} reason reason of the participant to kick\r\n */\r\nJitsiConference.prototype.kickParticipant = function(id, reason) {\r\n    const participant = this.getParticipantById(id);\r\n\r\n    if (!participant) {\r\n        return;\r\n    }\r\n    this.room.kick(participant.getJid(), reason);\r\n};\r\n\r\n/**\r\n * Maybe clears the timeout which emits {@link ACTION_JINGLE_SI_TIMEOUT}\r\n * analytics event.\r\n * @private\r\n */\r\nJitsiConference.prototype._maybeClearSITimeout = function() {\r\n    if (this._sessionInitiateTimeout\r\n            && (this.jvbJingleSession || this.getParticipantCount() < 2)) {\r\n        window.clearTimeout(this._sessionInitiateTimeout);\r\n        this._sessionInitiateTimeout = null;\r\n    }\r\n};\r\n\r\n/**\r\n * Sets a timeout which will emit {@link ACTION_JINGLE_SI_TIMEOUT} analytics\r\n * event.\r\n * @private\r\n */\r\nJitsiConference.prototype._maybeSetSITimeout = function() {\r\n    // Jicofo is supposed to invite if there are at least 2 participants\r\n    if (!this.jvbJingleSession\r\n            && this.getParticipantCount() >= 2\r\n            && !this._sessionInitiateTimeout) {\r\n        this._sessionInitiateTimeout = window.setTimeout(() => {\r\n            this._sessionInitiateTimeout = null;\r\n            Statistics.sendAnalytics(createJingleEvent(\r\n                ACTION_JINGLE_SI_TIMEOUT,\r\n                {\r\n                    p2p: false,\r\n                    value: JINGLE_SI_TIMEOUT\r\n                }));\r\n        }, JINGLE_SI_TIMEOUT);\r\n    }\r\n};\r\n\r\n/**\r\n * Mutes a participant.\r\n * @param {string} id The id of the participant to mute.\r\n */\r\nJitsiConference.prototype.muteParticipant = function(id, mediaType) {\r\n    const muteMediaType = mediaType ? mediaType : MediaType.AUDIO;\r\n\r\n    if (muteMediaType !== MediaType.AUDIO && muteMediaType !== MediaType.VIDEO) {\r\n        logger.error(`Unsupported media type: ${muteMediaType}`);\r\n\r\n        return;\r\n    }\r\n\r\n    const participant = this.getParticipantById(id);\r\n\r\n    if (!participant) {\r\n        return;\r\n    }\r\n    this.room.muteParticipant(participant.getJid(), true, muteMediaType);\r\n};\r\n\r\n/* eslint-disable max-params */\r\n\r\n/**\r\n * Notifies this JitsiConference that a new member has joined its chat room.\r\n *\r\n * FIXME This should NOT be exposed!\r\n *\r\n * @param jid the jid of the participant in the MUC\r\n * @param nick the display name of the participant\r\n * @param role the role of the participant in the MUC\r\n * @param isHidden indicates if this is a hidden participant (system\r\n * participant for example a recorder).\r\n * @param statsID the participant statsID (optional)\r\n * @param status the initial status if any\r\n * @param identity the member identity, if any\r\n * @param botType the member botType, if any\r\n * @param fullJid the member full jid, if any\r\n * @param features the member botType, if any\r\n */\r\nJitsiConference.prototype.onMemberJoined = function(\r\n        jid, nick, role, isHidden, statsID, status, identity, botType, fullJid, features) {\r\n    const id = Strophe.getResourceFromJid(jid);\r\n\r\n    if (id === 'focus' || this.myUserId() === id) {\r\n        return;\r\n    }\r\n\r\n    const participant\r\n        = new JitsiParticipant(jid, this, nick, isHidden, statsID, status, identity);\r\n\r\n    participant.setRole(role);\r\n    participant.setBotType(botType);\r\n    participant.setFeatures(features);\r\n\r\n    this.participants[id] = participant;\r\n    this.eventEmitter.emit(\r\n        JitsiConferenceEvents.USER_JOINED,\r\n        id,\r\n        participant);\r\n\r\n    this._updateFeatures(participant);\r\n\r\n    // maybeStart only if we had finished joining as then we will have information for the number of participants\r\n    if (this.isJoined()) {\r\n        this._maybeStartOrStopP2P();\r\n    }\r\n\r\n    this._maybeSetSITimeout();\r\n};\r\n\r\n/* eslint-enable max-params */\r\n\r\n/**\r\n * Get notified when we joined the room.\r\n *\r\n * FIXME This should NOT be exposed!\r\n *\r\n * @private\r\n */\r\nJitsiConference.prototype._onMucJoined = function() {\r\n    this._maybeStartOrStopP2P();\r\n};\r\n\r\n/**\r\n * Updates features for a participant.\r\n * @param {JitsiParticipant} participant - The participant to query for features.\r\n * @returns {void}\r\n * @private\r\n */\r\nJitsiConference.prototype._updateFeatures = function(participant) {\r\n    participant.getFeatures()\r\n        .then(features => {\r\n            participant._supportsDTMF = features.has('urn:xmpp:jingle:dtmf:0');\r\n            this.updateDTMFSupport();\r\n\r\n            if (features.has(FEATURE_JIGASI)) {\r\n                participant.setProperty('features_jigasi', true);\r\n            }\r\n\r\n            if (features.has(FEATURE_E2EE)) {\r\n                participant.setProperty('features_e2ee', true);\r\n            }\r\n        })\r\n        .catch(() => false);\r\n};\r\n\r\n/**\r\n * Get notified when member bot type had changed.\r\n * @param jid the member jid\r\n * @param botType the new botType value\r\n * @private\r\n */\r\nJitsiConference.prototype._onMemberBotTypeChanged = function(jid, botType) {\r\n\r\n    // find the participant and mark it as non bot, as the real one will join\r\n    // in a moment\r\n    const peers = this.getParticipants();\r\n    const botParticipant = peers.find(p => p.getJid() === jid);\r\n\r\n    if (botParticipant) {\r\n        botParticipant.setBotType(botType);\r\n        const id = Strophe.getResourceFromJid(jid);\r\n\r\n        this.eventEmitter.emit(\r\n            JitsiConferenceEvents.BOT_TYPE_CHANGED,\r\n            id,\r\n            botType);\r\n    }\r\n\r\n    // if botType changed to undefined, botType was removed, in case of\r\n    // poltergeist mode this is the moment when the poltergeist had exited and\r\n    // the real participant had already replaced it.\r\n    // In this case we can check and try p2p\r\n    if (!botParticipant.getBotType()) {\r\n        this._maybeStartOrStopP2P();\r\n    }\r\n};\r\n\r\nJitsiConference.prototype.onMemberLeft = function(jid) {\r\n    const id = Strophe.getResourceFromJid(jid);\r\n\r\n    if (id === 'focus' || this.myUserId() === id) {\r\n        return;\r\n    }\r\n\r\n    const participant = this.participants[id];\r\n\r\n    delete this.participants[id];\r\n\r\n    // Remove the ssrcs from the remote description.\r\n    const mediaSessions = this._getMediaSessions();\r\n    const removePromises = [];\r\n\r\n    for (const session of mediaSessions) {\r\n        removePromises.push(session.removeRemoteStreamsOnLeave(id));\r\n    }\r\n\r\n    Promise.allSettled(removePromises)\r\n        .then(results => {\r\n            let removedTracks = [];\r\n\r\n            results.map(result => result.value).forEach(value => {\r\n                if (value) {\r\n                    removedTracks = removedTracks.concat(value);\r\n                }\r\n            });\r\n\r\n            removedTracks.forEach(track => {\r\n                this.eventEmitter.emit(JitsiConferenceEvents.TRACK_REMOVED, track);\r\n            });\r\n\r\n            // There can be no participant in case the member that left is focus.\r\n            if (participant) {\r\n                this.eventEmitter.emit(JitsiConferenceEvents.USER_LEFT, id, participant);\r\n            }\r\n\r\n            this._maybeStartOrStopP2P(true /* triggered by user left event */);\r\n            this._maybeClearSITimeout();\r\n        });\r\n};\r\n\r\n/**\r\n * Designates an event indicating that we were kicked from the XMPP MUC.\r\n * @param {boolean} isSelfPresence - whether it is for local participant\r\n * or another participant.\r\n * @param {string} actorId - the id of the participant who was initiator\r\n * of the kick.\r\n * @param {string?} kickedParticipantId - when it is not a kick for local participant,\r\n * this is the id of the participant which was kicked.\r\n * @param {string} reason - reason of the participant to kick\r\n */\r\nJitsiConference.prototype.onMemberKicked = function(isSelfPresence, actorId, kickedParticipantId, reason) {\r\n    // This check which be true when we kick someone else. With the introduction of lobby\r\n    // the ChatRoom KICKED event is now also emitted for ourselves (the kicker) so we want to\r\n    // avoid emitting an event where `undefined` kicked someone.\r\n    if (actorId === this.myUserId()) {\r\n        return;\r\n    }\r\n\r\n    const actorParticipant = this.participants[actorId];\r\n\r\n    if (isSelfPresence) {\r\n        this.eventEmitter.emit(\r\n            JitsiConferenceEvents.KICKED, actorParticipant, reason);\r\n\r\n        this.leave();\r\n\r\n        return;\r\n    }\r\n\r\n    const kickedParticipant = this.participants[kickedParticipantId];\r\n\r\n    this.eventEmitter.emit(\r\n        JitsiConferenceEvents.PARTICIPANT_KICKED, actorParticipant, kickedParticipant, reason);\r\n};\r\n\r\n/**\r\n * Method called on local MUC role change.\r\n * @param {string} role the name of new user's role as defined by XMPP MUC.\r\n */\r\nJitsiConference.prototype.onLocalRoleChanged = function(role) {\r\n    // Emit role changed for local  JID\r\n    this.eventEmitter.emit(\r\n        JitsiConferenceEvents.USER_ROLE_CHANGED, this.myUserId(), role);\r\n};\r\n\r\nJitsiConference.prototype.onUserRoleChanged = function(jid, role) {\r\n    const id = Strophe.getResourceFromJid(jid);\r\n    const participant = this.getParticipantById(id);\r\n\r\n    if (!participant) {\r\n        return;\r\n    }\r\n    participant.setRole(role);\r\n    this.eventEmitter.emit(JitsiConferenceEvents.USER_ROLE_CHANGED, id, role);\r\n};\r\n\r\nJitsiConference.prototype.onDisplayNameChanged = function(jid, displayName) {\r\n    const id = Strophe.getResourceFromJid(jid);\r\n    const participant = this.getParticipantById(id);\r\n\r\n    if (!participant) {\r\n        return;\r\n    }\r\n\r\n    if (participant._displayName === displayName) {\r\n        return;\r\n    }\r\n\r\n    participant._displayName = displayName;\r\n    this.eventEmitter.emit(\r\n        JitsiConferenceEvents.DISPLAY_NAME_CHANGED,\r\n        id,\r\n        displayName);\r\n};\r\n\r\n/**\r\n * Notifies this JitsiConference that a JitsiRemoteTrack was added into\r\n * the conference.\r\n *\r\n * @param {JitsiRemoteTrack} track the JitsiRemoteTrack which was added to this\r\n * JitsiConference\r\n */\r\nJitsiConference.prototype.onRemoteTrackAdded = function(track) {\r\n    if (track.isP2P && !this.isP2PActive()) {\r\n        logger.info(\r\n            'Trying to add remote P2P track, when not in P2P - IGNORED');\r\n\r\n        return;\r\n    } else if (!track.isP2P && this.isP2PActive()) {\r\n        logger.info(\r\n            'Trying to add remote JVB track, when in P2P - IGNORED');\r\n\r\n        return;\r\n    }\r\n\r\n    const id = track.getParticipantId();\r\n    const participant = this.getParticipantById(id);\r\n\r\n    if (!participant) {\r\n        logger.error(`No participant found for id: ${id}`);\r\n\r\n        return;\r\n    }\r\n\r\n    // Add track to JitsiParticipant.\r\n    participant._tracks.push(track);\r\n\r\n    if (this.transcriber) {\r\n        this.transcriber.addTrack(track);\r\n    }\r\n\r\n    const emitter = this.eventEmitter;\r\n\r\n    track.addEventListener(\r\n        JitsiTrackEvents.TRACK_MUTE_CHANGED,\r\n        () => emitter.emit(JitsiConferenceEvents.TRACK_MUTE_CHANGED, track));\r\n    track.addEventListener(\r\n        JitsiTrackEvents.TRACK_AUDIO_LEVEL_CHANGED,\r\n        (audioLevel, tpc) => {\r\n            const activeTPC = this.getActivePeerConnection();\r\n\r\n            if (activeTPC === tpc) {\r\n                emitter.emit(\r\n                    JitsiConferenceEvents.TRACK_AUDIO_LEVEL_CHANGED,\r\n                    id,\r\n                    audioLevel);\r\n            }\r\n        }\r\n    );\r\n\r\n    emitter.emit(JitsiConferenceEvents.TRACK_ADDED, track);\r\n};\r\n\r\n/**\r\n * Callback called by the Jingle plugin when 'session-answer' is received.\r\n * @param {JingleSessionPC} session the Jingle session for which an answer was\r\n * received.\r\n * @param {jQuery} answer a jQuery selector pointing to 'jingle' IQ element\r\n */\r\n// eslint-disable-next-line no-unused-vars\r\nJitsiConference.prototype.onCallAccepted = function(session, answer) {\r\n    if (this.p2pJingleSession === session) {\r\n        logger.info('P2P setAnswer');\r\n\r\n        this.p2pJingleSession.setAnswer(answer);\r\n        this.eventEmitter.emit(JitsiConferenceEvents._MEDIA_SESSION_STARTED, this.p2pJingleSession);\r\n    }\r\n};\r\n\r\n/**\r\n * Callback called by the Jingle plugin when 'transport-info' is received.\r\n * @param {JingleSessionPC} session the Jingle session for which the IQ was\r\n * received\r\n * @param {jQuery} transportInfo a jQuery selector pointing to 'jingle' IQ\r\n * element\r\n */\r\n// eslint-disable-next-line no-unused-vars\r\nJitsiConference.prototype.onTransportInfo = function(session, transportInfo) {\r\n    if (this.p2pJingleSession === session) {\r\n        logger.info('P2P addIceCandidates');\r\n        this.p2pJingleSession.addIceCandidates(transportInfo);\r\n    }\r\n};\r\n\r\n/**\r\n * Notifies this JitsiConference that a JitsiRemoteTrack was removed from\r\n * the conference.\r\n *\r\n * @param {JitsiRemoteTrack} removedTrack\r\n */\r\nJitsiConference.prototype.onRemoteTrackRemoved = function(removedTrack) {\r\n    this.getParticipants().forEach(participant => {\r\n        const tracks = participant.getTracks();\r\n\r\n        for (let i = 0; i < tracks.length; i++) {\r\n            if (tracks[i] === removedTrack) {\r\n                // Since the tracks have been compared and are\r\n                // considered equal the result of splice can be ignored.\r\n                participant._tracks.splice(i, 1);\r\n\r\n                this.eventEmitter.emit(\r\n                    JitsiConferenceEvents.TRACK_REMOVED, removedTrack);\r\n\r\n                if (this.transcriber) {\r\n                    this.transcriber.removeTrack(removedTrack);\r\n                }\r\n\r\n                break;\r\n            }\r\n        }\r\n    }, this);\r\n};\r\n\r\n/**\r\n * Handles an incoming call event for the P2P jingle session.\r\n */\r\nJitsiConference.prototype._onIncomingCallP2P = function(\r\n        jingleSession,\r\n        jingleOffer) {\r\n\r\n    let rejectReason;\r\n\r\n    if ((!this.isP2PEnabled() && !this.isP2PTestModeEnabled()) || browser.isFirefox() || browser.isWebKitBased()) {\r\n        rejectReason = {\r\n            reason: 'decline',\r\n            reasonDescription: 'P2P disabled',\r\n            errorMsg: 'P2P mode disabled in the configuration'\r\n        };\r\n    } else if (this.p2pJingleSession) {\r\n        // Reject incoming P2P call (already in progress)\r\n        rejectReason = {\r\n            reason: 'busy',\r\n            reasonDescription: 'P2P already in progress',\r\n            errorMsg: 'Duplicated P2P \"session-initiate\"'\r\n        };\r\n    } else if (!this._shouldBeInP2PMode()) {\r\n        rejectReason = {\r\n            reason: 'decline',\r\n            reasonDescription: 'P2P requirements not met',\r\n            errorMsg: 'Received P2P \"session-initiate\" when should not be in P2P mode'\r\n        };\r\n        Statistics.sendAnalytics(createJingleEvent(ACTION_P2P_DECLINED));\r\n    }\r\n\r\n    if (rejectReason) {\r\n        this._rejectIncomingCall(jingleSession, rejectReason);\r\n    } else {\r\n        this._acceptP2PIncomingCall(jingleSession, jingleOffer);\r\n    }\r\n};\r\n\r\n/**\r\n * Handles an incoming call event.\r\n */\r\nJitsiConference.prototype.onIncomingCall = function(\r\n        jingleSession,\r\n        jingleOffer,\r\n        now) {\r\n    // Handle incoming P2P call\r\n    if (jingleSession.isP2P) {\r\n        this._onIncomingCallP2P(jingleSession, jingleOffer);\r\n    } else {\r\n        if (!this.room.isFocus(jingleSession.remoteJid)) {\r\n            const description = 'Rejecting session-initiate from non-focus.';\r\n\r\n            this._rejectIncomingCall(\r\n                jingleSession, {\r\n                    reason: 'security-error',\r\n                    reasonDescription: description,\r\n                    errorMsg: description\r\n                });\r\n\r\n            return;\r\n        }\r\n        this._acceptJvbIncomingCall(jingleSession, jingleOffer, now);\r\n    }\r\n};\r\n\r\n/**\r\n * Accepts an incoming call event for the JVB jingle session.\r\n */\r\nJitsiConference.prototype._acceptJvbIncomingCall = function(\r\n        jingleSession,\r\n        jingleOffer,\r\n        now) {\r\n\r\n    // Accept incoming call\r\n    this.jvbJingleSession = jingleSession;\r\n    this.room.connectionTimes['session.initiate'] = now;\r\n    this._sendConferenceJoinAnalyticsEvent();\r\n\r\n    if (this.wasStopped) {\r\n        Statistics.sendAnalyticsAndLog(\r\n            createJingleEvent(ACTION_JINGLE_RESTART, { p2p: false }));\r\n    }\r\n\r\n    const serverRegion\r\n        = $(jingleOffer)\r\n            .find('>bridge-session[xmlns=\"http://jitsi.org/protocol/focus\"]')\r\n            .attr('region');\r\n\r\n    this.eventEmitter.emit(\r\n        JitsiConferenceEvents.SERVER_REGION_CHANGED,\r\n        serverRegion);\r\n\r\n    this._maybeClearSITimeout();\r\n    Statistics.sendAnalytics(createJingleEvent(\r\n        ACTION_JINGLE_SI_RECEIVED,\r\n        {\r\n            p2p: false,\r\n            value: now\r\n        }));\r\n\r\n    try {\r\n        jingleSession.initialize(this.room, this.rtc, {\r\n            ...this.options.config,\r\n            enableInsertableStreams: this.isE2EEEnabled()\r\n        });\r\n    } catch (error) {\r\n        GlobalOnErrorHandler.callErrorHandler(error);\r\n        logger.error(error);\r\n\r\n        return;\r\n    }\r\n\r\n    // Open a channel with the videobridge.\r\n    this._setBridgeChannel(jingleOffer, jingleSession.peerconnection);\r\n\r\n    const localTracks = this._getInitialLocalTracks();\r\n\r\n    try {\r\n        jingleSession.acceptOffer(\r\n            jingleOffer,\r\n            () => {\r\n                // If for any reason invite for the JVB session arrived after\r\n                // the P2P has been established already the media transfer needs\r\n                // to be turned off here.\r\n                if (this.isP2PActive() && this.jvbJingleSession) {\r\n                    this._suspendMediaTransferForJvbConnection();\r\n                }\r\n\r\n                this.eventEmitter.emit(\r\n                    JitsiConferenceEvents._MEDIA_SESSION_STARTED,\r\n                    jingleSession);\r\n                if (!this.isP2PActive()) {\r\n                    this.eventEmitter.emit(\r\n                        JitsiConferenceEvents._MEDIA_SESSION_ACTIVE_CHANGED,\r\n                        jingleSession);\r\n                }\r\n            },\r\n            error => {\r\n                GlobalOnErrorHandler.callErrorHandler(error);\r\n                logger.error(\r\n                    'Failed to accept incoming Jingle session', error);\r\n            },\r\n            localTracks\r\n        );\r\n\r\n        // Start callstats as soon as peerconnection is initialized,\r\n        // do not wait for XMPPEvents.PEERCONNECTION_READY, as it may never\r\n        // happen in case if user doesn't have or denied permission to\r\n        // both camera and microphone.\r\n        logger.info('Starting CallStats for JVB connection...');\r\n        this.statistics.startCallStats(\r\n            this.jvbJingleSession.peerconnection,\r\n            'jitsi' /* Remote user ID for JVB is 'jitsi' */);\r\n        this.statistics.startRemoteStats(this.jvbJingleSession.peerconnection);\r\n    } catch (e) {\r\n        GlobalOnErrorHandler.callErrorHandler(e);\r\n        logger.error(e);\r\n    }\r\n};\r\n\r\n/**\r\n * Sets the BridgeChannel.\r\n *\r\n * @param {jQuery} offerIq a jQuery selector pointing to the jingle element of\r\n * the offer IQ which may carry the WebSocket URL for the 'websocket'\r\n * BridgeChannel mode.\r\n * @param {TraceablePeerConnection} pc the peer connection which will be used\r\n * to listen for new WebRTC Data Channels (in the 'datachannel' mode).\r\n */\r\nJitsiConference.prototype._setBridgeChannel = function(offerIq, pc) {\r\n    let wsUrl = null;\r\n    const webSocket\r\n        = $(offerIq)\r\n            .find('>content>transport>web-socket')\r\n            .first();\r\n\r\n    if (webSocket.length === 1) {\r\n        wsUrl = webSocket[0].getAttribute('url');\r\n    }\r\n\r\n    if (wsUrl) {\r\n        // If the offer contains a websocket use it.\r\n        this.rtc.initializeBridgeChannel(null, wsUrl);\r\n    } else {\r\n        // Otherwise, fall back to an attempt to use SCTP.\r\n        this.rtc.initializeBridgeChannel(pc, null);\r\n    }\r\n};\r\n\r\n/**\r\n * Rejects incoming Jingle call.\r\n * @param {JingleSessionPC} jingleSession the session instance to be rejected.\r\n * @param {object} [options]\r\n * @param {string} options.reason the name of the reason element as defined\r\n * by Jingle\r\n * @param {string} options.reasonDescription the reason description which will\r\n * be included in Jingle 'session-terminate' message.\r\n * @param {string} options.errorMsg an error message to be logged on global\r\n * error handler\r\n * @private\r\n */\r\nJitsiConference.prototype._rejectIncomingCall = function(\r\n        jingleSession,\r\n        options) {\r\n    if (options && options.errorMsg) {\r\n        GlobalOnErrorHandler.callErrorHandler(new Error(options.errorMsg));\r\n    }\r\n\r\n    // Terminate the jingle session with a reason\r\n    jingleSession.terminate(\r\n        null /* success callback => we don't care */,\r\n        error => {\r\n            logger.warn(\r\n                'An error occurred while trying to terminate'\r\n                    + ' invalid Jingle session', error);\r\n        }, {\r\n            reason: options && options.reason,\r\n            reasonDescription: options && options.reasonDescription,\r\n            sendSessionTerminate: true\r\n        });\r\n};\r\n\r\n/**\r\n * Handles the call ended event.\r\n * XXX is this due to the remote side terminating the Jingle session?\r\n *\r\n * @param {JingleSessionPC} jingleSession the jingle session which has been\r\n * terminated.\r\n * @param {String} reasonCondition the Jingle reason condition.\r\n * @param {String|null} reasonText human readable reason text which may provide\r\n * more details about why the call has been terminated.\r\n */\r\nJitsiConference.prototype.onCallEnded = function(\r\n        jingleSession,\r\n        reasonCondition,\r\n        reasonText) {\r\n    logger.info(\r\n        `Call ended: ${reasonCondition} - ${reasonText} P2P ?${\r\n            jingleSession.isP2P}`);\r\n    if (jingleSession === this.jvbJingleSession) {\r\n        this.wasStopped = true;\r\n\r\n        Statistics.sendAnalytics(\r\n            createJingleEvent(ACTION_JINGLE_TERMINATE, { p2p: false }));\r\n\r\n        // Stop the stats\r\n        if (this.statistics) {\r\n            this.statistics.stopRemoteStats(\r\n                this.jvbJingleSession.peerconnection);\r\n            logger.info('Stopping JVB CallStats');\r\n            this.statistics.stopCallStats(\r\n                this.jvbJingleSession.peerconnection);\r\n        }\r\n\r\n        // Current JVB JingleSession is no longer valid, so set it to null\r\n        this.jvbJingleSession = null;\r\n\r\n        // Let the RTC service do any cleanups\r\n        this.rtc.onCallEnded();\r\n    } else if (jingleSession === this.p2pJingleSession) {\r\n        // It's the responder who decides to enforce JVB mode, so that both\r\n        // initiator and responder are aware if it was intentional.\r\n        if (reasonCondition === 'decline' && reasonText === 'force JVB121') {\r\n            logger.info('In forced JVB 121 mode...');\r\n            Statistics.analytics.addPermanentProperties({ forceJvb121: true });\r\n        } else if (reasonCondition === 'connectivity-error'\r\n            && reasonText === 'ICE FAILED') {\r\n            // It can happen that the other peer detects ICE failed and\r\n            // terminates the session, before we get the event on our side.\r\n            // But we are able to parse the reason and mark it here.\r\n            Statistics.analytics.addPermanentProperties({ p2pFailed: true });\r\n        }\r\n        this._stopP2PSession();\r\n    } else {\r\n        logger.error(\r\n            'Received onCallEnded for invalid session',\r\n            jingleSession.sid,\r\n            jingleSession.remoteJid,\r\n            reasonCondition,\r\n            reasonText);\r\n    }\r\n};\r\n\r\n/**\r\n * Handles the suspend detected event. Leaves the room and fires suspended.\r\n * @param {JingleSessionPC} jingleSession\r\n */\r\nJitsiConference.prototype.onSuspendDetected = function(jingleSession) {\r\n    if (!jingleSession.isP2P) {\r\n        this.leave();\r\n        this.eventEmitter.emit(JitsiConferenceEvents.SUSPEND_DETECTED);\r\n    }\r\n};\r\n\r\nJitsiConference.prototype.updateDTMFSupport = function() {\r\n    let somebodySupportsDTMF = false;\r\n    const participants = this.getParticipants();\r\n\r\n    // check if at least 1 participant supports DTMF\r\n    for (let i = 0; i < participants.length; i += 1) {\r\n        if (participants[i].supportsDTMF()) {\r\n            somebodySupportsDTMF = true;\r\n            break;\r\n        }\r\n    }\r\n    if (somebodySupportsDTMF !== this.somebodySupportsDTMF) {\r\n        this.somebodySupportsDTMF = somebodySupportsDTMF;\r\n        this.eventEmitter.emit(\r\n            JitsiConferenceEvents.DTMF_SUPPORT_CHANGED,\r\n            somebodySupportsDTMF);\r\n    }\r\n};\r\n\r\n/**\r\n * Allows to check if there is at least one user in the conference\r\n * that supports DTMF.\r\n * @returns {boolean} true if somebody supports DTMF, false otherwise\r\n */\r\nJitsiConference.prototype.isDTMFSupported = function() {\r\n    return this.somebodySupportsDTMF;\r\n};\r\n\r\n/**\r\n * Returns the local user's ID\r\n * @return {string} local user's ID\r\n */\r\nJitsiConference.prototype.myUserId = function() {\r\n    return (\r\n        this.room && this.room.myroomjid\r\n            ? Strophe.getResourceFromJid(this.room.myroomjid)\r\n            : null);\r\n};\r\n\r\nJitsiConference.prototype.sendTones = function(tones, duration, pause) {\r\n    const peerConnection = this.getActivePeerConnection();\r\n\r\n    if (peerConnection) {\r\n        peerConnection.sendTones(tones, duration, pause);\r\n    } else {\r\n        logger.warn('cannot sendTones: no peer connection');\r\n    }\r\n};\r\n\r\n/**\r\n * Starts recording the current conference.\r\n *\r\n * @param {Object} options - Configuration for the recording. See\r\n * {@link Chatroom#startRecording} for more info.\r\n * @returns {Promise} See {@link Chatroom#startRecording} for more info.\r\n */\r\nJitsiConference.prototype.startRecording = function(options) {\r\n    if (this.room) {\r\n        return this.recordingManager.startRecording(options);\r\n    }\r\n\r\n    return Promise.reject(new Error('The conference is not created yet!'));\r\n};\r\n\r\n/**\r\n * Stop a recording session.\r\n *\r\n * @param {string} sessionID - The ID of the recording session that\r\n * should be stopped.\r\n * @returns {Promise} See {@link Chatroom#stopRecording} for more info.\r\n */\r\nJitsiConference.prototype.stopRecording = function(sessionID) {\r\n    if (this.room) {\r\n        return this.recordingManager.stopRecording(sessionID);\r\n    }\r\n\r\n    return Promise.reject(new Error('The conference is not created yet!'));\r\n};\r\n\r\n/**\r\n * Returns true if the SIP calls are supported and false otherwise\r\n */\r\nJitsiConference.prototype.isSIPCallingSupported = function() {\r\n    if (this.room) {\r\n        return this.room.isSIPCallingSupported();\r\n    }\r\n\r\n    return false;\r\n};\r\n\r\n/**\r\n * Dials a number.\r\n * @param number the number\r\n */\r\nJitsiConference.prototype.dial = function(number) {\r\n    if (this.room) {\r\n        return this.room.dial(number);\r\n    }\r\n\r\n    return new Promise((resolve, reject) => {\r\n        reject(new Error('The conference is not created yet!'));\r\n    });\r\n};\r\n\r\n/**\r\n * Hangup an existing call\r\n */\r\nJitsiConference.prototype.hangup = function() {\r\n    if (this.room) {\r\n        return this.room.hangup();\r\n    }\r\n\r\n    return new Promise((resolve, reject) => {\r\n        reject(new Error('The conference is not created yet!'));\r\n    });\r\n};\r\n\r\n/**\r\n * Starts the transcription service.\r\n */\r\nJitsiConference.prototype.startTranscriber = function() {\r\n    return this.dial('jitsi_meet_transcribe');\r\n};\r\n\r\n\r\n/**\r\n * Stops the transcription service.\r\n */\r\nJitsiConference.prototype.stopTranscriber = JitsiConference.prototype.hangup;\r\n\r\n/**\r\n * Returns the phone number for joining the conference.\r\n */\r\nJitsiConference.prototype.getPhoneNumber = function() {\r\n    if (this.room) {\r\n        return this.room.getPhoneNumber();\r\n    }\r\n\r\n    return null;\r\n};\r\n\r\n/**\r\n * Returns the pin for joining the conference with phone.\r\n */\r\nJitsiConference.prototype.getPhonePin = function() {\r\n    if (this.room) {\r\n        return this.room.getPhonePin();\r\n    }\r\n\r\n    return null;\r\n};\r\n\r\n/**\r\n * Returns the meeting unique ID if any.\r\n *\r\n * @returns {string|undefined}\r\n */\r\nJitsiConference.prototype.getMeetingUniqueId = function() {\r\n    if (this.room) {\r\n        return this.room.getMeetingId();\r\n    }\r\n};\r\n\r\n/**\r\n * Will return P2P or JVB <tt>TraceablePeerConnection</tt> depending on\r\n * which connection is currently active.\r\n *\r\n * @return {TraceablePeerConnection|null} null if there isn't any active\r\n * <tt>TraceablePeerConnection</tt> currently available.\r\n * @public (FIXME how to make package local ?)\r\n */\r\nJitsiConference.prototype.getActivePeerConnection = function() {\r\n    const session = this.isP2PActive() ? this.p2pJingleSession : this.jvbJingleSession;\r\n\r\n    return session ? session.peerconnection : null;\r\n};\r\n\r\n/**\r\n * Returns the connection state for the current room. Its ice connection state\r\n * for its session.\r\n * NOTE that \"completed\" ICE state which can appear on the P2P connection will\r\n * be converted to \"connected\".\r\n * @return {string|null} ICE state name or <tt>null</tt> if there is no active\r\n * peer connection at this time.\r\n */\r\nJitsiConference.prototype.getConnectionState = function() {\r\n    const peerConnection = this.getActivePeerConnection();\r\n\r\n    return peerConnection ? peerConnection.getConnectionState() : null;\r\n};\r\n\r\n/**\r\n * Make all new participants mute their audio/video on join.\r\n * @param policy {Object} object with 2 boolean properties for video and audio:\r\n * @param {boolean} audio if audio should be muted.\r\n * @param {boolean} video if video should be muted.\r\n */\r\nJitsiConference.prototype.setStartMutedPolicy = function(policy) {\r\n    if (!this.isModerator()) {\r\n        logger.warn(`Failed to set start muted policy, ${this.room ? '' : 'not in a room, '}${\r\n            this.isModerator() ? '' : 'participant is not a moderator'}`);\r\n\r\n        return;\r\n    }\r\n    this.startMutedPolicy = policy;\r\n    this.room.addOrReplaceInPresence('startmuted', {\r\n        attributes: {\r\n            audio: policy.audio,\r\n            video: policy.video,\r\n            xmlns: 'http://jitsi.org/jitmeet/start-muted'\r\n        }\r\n    }) && this.room.sendPresence();\r\n};\r\n\r\n/**\r\n * Returns current start muted policy\r\n * @returns {Object} with 2 properties - audio and video.\r\n */\r\nJitsiConference.prototype.getStartMutedPolicy = function() {\r\n    return this.startMutedPolicy;\r\n};\r\n\r\n/**\r\n * Check if audio is muted on join.\r\n */\r\nJitsiConference.prototype.isStartAudioMuted = function() {\r\n    return this.startAudioMuted;\r\n};\r\n\r\n/**\r\n * Check if video is muted on join.\r\n */\r\nJitsiConference.prototype.isStartVideoMuted = function() {\r\n    return this.startVideoMuted;\r\n};\r\n\r\n/**\r\n * Returns measured connectionTimes.\r\n */\r\nJitsiConference.prototype.getConnectionTimes = function() {\r\n    return this.room.connectionTimes;\r\n};\r\n\r\n/**\r\n * Sets a property for the local participant.\r\n */\r\nJitsiConference.prototype.setLocalParticipantProperty = function(name, value) {\r\n    this.sendCommand(`jitsi_participant_${name}`, { value });\r\n};\r\n\r\n/**\r\n *  Removes a property for the local participant and sends the updated presence.\r\n */\r\nJitsiConference.prototype.removeLocalParticipantProperty = function(name) {\r\n    this.removeCommand(`jitsi_participant_${name}`);\r\n    this.room.sendPresence();\r\n};\r\n\r\n/**\r\n * Gets a local participant property.\r\n *\r\n * @return value of the local participant property if the tagName exists in the\r\n * list of properties, otherwise returns undefined.\r\n */\r\nJitsiConference.prototype.getLocalParticipantProperty = function(name) {\r\n    const property = this.room.presMap.nodes.find(prop =>\r\n        prop.tagName === `jitsi_participant_${name}`\r\n    );\r\n\r\n    return property ? property.value : undefined;\r\n};\r\n\r\n/**\r\n * Sends the given feedback through CallStats if enabled.\r\n *\r\n * @param overallFeedback an integer between 1 and 5 indicating the\r\n * user feedback\r\n * @param detailedFeedback detailed feedback from the user. Not yet used\r\n * @returns {Promise} Resolves if feedback is submitted successfully.\r\n */\r\nJitsiConference.prototype.sendFeedback = function(\r\n        overallFeedback,\r\n        detailedFeedback) {\r\n    return this.statistics.sendFeedback(overallFeedback, detailedFeedback);\r\n};\r\n\r\n/**\r\n * Returns true if the callstats integration is enabled, otherwise returns\r\n * false.\r\n *\r\n * @returns true if the callstats integration is enabled, otherwise returns\r\n * false.\r\n */\r\nJitsiConference.prototype.isCallstatsEnabled = function() {\r\n    return this.statistics.isCallstatsEnabled();\r\n};\r\n\r\n/**\r\n * Finds the SSRC of a given track\r\n *\r\n * @param track\r\n * @returns {number|undefined} the SSRC of the specificed track, otherwise undefined.\r\n */\r\nJitsiConference.prototype.getSsrcByTrack = function(track) {\r\n    return track.isLocal() ? this.getActivePeerConnection()?.getLocalSSRC(track) : track.getSSRC();\r\n};\r\n\r\n/**\r\n * Handles track attached to container (Calls associateStreamWithVideoTag method\r\n * from statistics module)\r\n * @param {JitsiLocalTrack|JitsiRemoteTrack} track the track\r\n * @param container the container\r\n */\r\nJitsiConference.prototype._onTrackAttach = function(track, container) {\r\n    const isLocal = track.isLocal();\r\n    let ssrc = null;\r\n    const isP2P = track.isP2P;\r\n    const remoteUserId = isP2P ? track.getParticipantId() : 'jitsi';\r\n    const peerConnection\r\n        = isP2P\r\n            ? this.p2pJingleSession && this.p2pJingleSession.peerconnection\r\n            : this.jvbJingleSession && this.jvbJingleSession.peerconnection;\r\n\r\n    if (isLocal) {\r\n        // Local tracks have SSRC stored on per peer connection basis.\r\n        if (peerConnection) {\r\n            ssrc = peerConnection.getLocalSSRC(track);\r\n        }\r\n    } else {\r\n        ssrc = track.getSSRC();\r\n    }\r\n    if (!container.id || !ssrc || !peerConnection) {\r\n        return;\r\n    }\r\n\r\n    this.statistics.associateStreamWithVideoTag(\r\n        peerConnection,\r\n        ssrc,\r\n        isLocal,\r\n        remoteUserId,\r\n        track.getUsageLabel(),\r\n        container.id);\r\n};\r\n\r\n/**\r\n * Logs an \"application log\" message.\r\n * @param message {string} The message to log. Note that while this can be a\r\n * generic string, the convention used by lib-jitsi-meet and jitsi-meet is to\r\n * log valid JSON strings, with an \"id\" field used for distinguishing between\r\n * message types. E.g.: {id: \"recorder_status\", status: \"off\"}\r\n */\r\nJitsiConference.prototype.sendApplicationLog = function(message) {\r\n    Statistics.sendLog(message);\r\n};\r\n\r\n/**\r\n * Checks if the user identified by given <tt>mucJid</tt> is the conference\r\n * focus.\r\n * @param mucJid the full MUC address of the user to be checked.\r\n * @returns {boolean|null} <tt>true</tt> if MUC user is the conference focus,\r\n * <tt>false</tt> when is not. <tt>null</tt> if we're not in the MUC anymore and\r\n * are unable to figure out the status or if given <tt>mucJid</tt> is invalid.\r\n */\r\nJitsiConference.prototype._isFocus = function(mucJid) {\r\n    return this.room ? this.room.isFocus(mucJid) : null;\r\n};\r\n\r\n/**\r\n * Fires CONFERENCE_FAILED event with INCOMPATIBLE_SERVER_VERSIONS parameter\r\n */\r\nJitsiConference.prototype._fireIncompatibleVersionsEvent = function() {\r\n    this.eventEmitter.emit(JitsiConferenceEvents.CONFERENCE_FAILED,\r\n        JitsiConferenceErrors.INCOMPATIBLE_SERVER_VERSIONS);\r\n};\r\n\r\n/**\r\n * Sends a message via the data channel.\r\n * @param to {string} the id of the endpoint that should receive the message.\r\n * If \"\" the message will be sent to all participants.\r\n * @param payload {object} the payload of the message.\r\n * @throws NetworkError or InvalidStateError or Error if the operation fails.\r\n * @deprecated Use 'sendMessage' instead. TODO: this should be private.\r\n */\r\nJitsiConference.prototype.sendEndpointMessage = function(to, payload) {\r\n    this.rtc.sendChannelMessage(to, payload);\r\n};\r\n\r\n/**\r\n * Sends local stats via the bridge channel which then forwards to other endpoints selectively.\r\n * @param {Object} payload The payload of the message.\r\n * @throws NetworkError/InvalidStateError/Error if the operation fails or if there is no data channel created.\r\n */\r\nJitsiConference.prototype.sendEndpointStatsMessage = function(payload) {\r\n    this.rtc.sendEndpointStatsMessage(payload);\r\n};\r\n\r\n/**\r\n * Sends a broadcast message via the data channel.\r\n * @param payload {object} the payload of the message.\r\n * @throws NetworkError or InvalidStateError or Error if the operation fails.\r\n * @deprecated Use 'sendMessage' instead. TODO: this should be private.\r\n */\r\nJitsiConference.prototype.broadcastEndpointMessage = function(payload) {\r\n    this.sendEndpointMessage('', payload);\r\n};\r\n\r\n/**\r\n * Sends a message to a given endpoint (if 'to' is a non-empty string), or\r\n * broadcasts it to all endpoints in the conference.\r\n * @param {string} to The ID of the endpoint/participant which is to receive\r\n * the message, or '' to broadcast the message to all endpoints in the\r\n * conference.\r\n * @param {string|object} message the message to send. If this is of type\r\n * 'string' it will be sent as a chat message. If it is of type 'object', it\r\n * will be encapsulated in a format recognized by jitsi-meet and converted to\r\n * JSON before being sent.\r\n * @param {boolean} sendThroughVideobridge Whether to send the message through\r\n * jitsi-videobridge (via the COLIBRI data channel or web socket), or through\r\n * the XMPP MUC. Currently only objects can be sent through jitsi-videobridge.\r\n */\r\nJitsiConference.prototype.sendMessage = function(\r\n        message,\r\n        to = '',\r\n        sendThroughVideobridge = false) {\r\n    const messageType = typeof message;\r\n\r\n    // Through videobridge we support only objects. Through XMPP we support\r\n    // objects (encapsulated in a specific JSON format) and strings (i.e.\r\n    // regular chat messages).\r\n    if (messageType !== 'object'\r\n            && (sendThroughVideobridge || messageType !== 'string')) {\r\n        logger.error(`Can not send a message of type ${messageType}`);\r\n\r\n        return;\r\n    }\r\n\r\n    if (sendThroughVideobridge) {\r\n        this.sendEndpointMessage(to, message);\r\n    } else {\r\n        let messageToSend = message;\r\n\r\n        // Name of packet extension of message stanza to send the required\r\n        // message in.\r\n        let elementName = 'body';\r\n\r\n        if (messageType === 'object') {\r\n            elementName = 'json-message';\r\n\r\n            // Mark as valid JSON message if not already\r\n            if (!messageToSend.hasOwnProperty(JITSI_MEET_MUC_TYPE)) {\r\n                messageToSend[JITSI_MEET_MUC_TYPE] = '';\r\n            }\r\n\r\n            try {\r\n                messageToSend = JSON.stringify(messageToSend);\r\n            } catch (e) {\r\n                logger.error('Can not send a message, stringify failed: ', e);\r\n\r\n                return;\r\n            }\r\n        }\r\n\r\n        if (to) {\r\n            this.sendPrivateTextMessage(to, messageToSend, elementName);\r\n        } else {\r\n            // Broadcast\r\n            this.sendTextMessage(messageToSend, elementName);\r\n        }\r\n    }\r\n\r\n};\r\n\r\nJitsiConference.prototype.isConnectionInterrupted = function() {\r\n    return this.isP2PActive()\r\n        ? this.isP2PConnectionInterrupted : this.isJvbConnectionInterrupted;\r\n};\r\n\r\n/**\r\n * Handles {@link XMPPEvents.CONNECTION_RESTARTED} event. This happens when the bridge goes down\r\n * and Jicofo moves conferences away to a different bridge.\r\n * @param {JingleSessionPC} session\r\n * @private\r\n */\r\nJitsiConference.prototype._onConferenceRestarted = function(session) {\r\n    if (!session.isP2P && this.options.config.enableForcedReload) {\r\n        this.restartInProgress = true;\r\n        this.eventEmitter.emit(JitsiConferenceEvents.CONFERENCE_FAILED, JitsiConferenceErrors.CONFERENCE_RESTARTED);\r\n    }\r\n};\r\n\r\n/**\r\n * Handles {@link XMPPEvents.CONNECTION_INTERRUPTED}\r\n * @param {JingleSessionPC} session\r\n * @private\r\n */\r\nJitsiConference.prototype._onIceConnectionInterrupted = function(session) {\r\n    if (session.isP2P) {\r\n        this.isP2PConnectionInterrupted = true;\r\n    } else {\r\n        this.isJvbConnectionInterrupted = true;\r\n    }\r\n    if (session.isP2P === this.isP2PActive()) {\r\n        this.eventEmitter.emit(JitsiConferenceEvents.CONNECTION_INTERRUPTED);\r\n    }\r\n};\r\n\r\n/**\r\n * Handles {@link XMPPEvents.CONNECTION_ICE_FAILED}\r\n * @param {JingleSessionPC} session\r\n * @private\r\n */\r\nJitsiConference.prototype._onIceConnectionFailed = function(session) {\r\n    // We do nothing for the JVB connection, because it's up to the Jicofo to\r\n    // eventually come up with the new offer (at least for the time being).\r\n    if (session.isP2P) {\r\n        // Add p2pFailed property to analytics to distinguish, between \"good\"\r\n        // and \"bad\" connection\r\n        Statistics.analytics.addPermanentProperties({ p2pFailed: true });\r\n\r\n        if (this.p2pJingleSession) {\r\n            Statistics.sendAnalyticsAndLog(\r\n                createP2PEvent(\r\n                    ACTION_P2P_FAILED,\r\n                    {\r\n                        initiator: this.p2pJingleSession.isInitiator\r\n                    }));\r\n\r\n        }\r\n        this._stopP2PSession('connectivity-error', 'ICE FAILED');\r\n    } else if (session && this.jvbJingleSession === session) {\r\n        this._delayedIceFailed = new IceFailedHandling(this);\r\n        this._delayedIceFailed.start(session);\r\n    }\r\n};\r\n\r\n/**\r\n * Handles {@link XMPPEvents.CONNECTION_RESTORED}\r\n * @param {JingleSessionPC} session\r\n * @private\r\n */\r\nJitsiConference.prototype._onIceConnectionRestored = function(session) {\r\n    if (session.isP2P) {\r\n        this.isP2PConnectionInterrupted = false;\r\n    } else {\r\n        this.isJvbConnectionInterrupted = false;\r\n        this._delayedIceFailed && this._delayedIceFailed.cancel();\r\n    }\r\n\r\n    if (session.isP2P === this.isP2PActive()) {\r\n        this.eventEmitter.emit(JitsiConferenceEvents.CONNECTION_RESTORED);\r\n    }\r\n};\r\n\r\n/**\r\n * Accept incoming P2P Jingle call.\r\n * @param {JingleSessionPC} jingleSession the session instance\r\n * @param {jQuery} jingleOffer a jQuery selector pointing to 'jingle' IQ element\r\n * @private\r\n */\r\nJitsiConference.prototype._acceptP2PIncomingCall = function(\r\n        jingleSession,\r\n        jingleOffer) {\r\n    this.isP2PConnectionInterrupted = false;\r\n\r\n    // Accept the offer\r\n    this.p2pJingleSession = jingleSession;\r\n    this._sendConferenceJoinAnalyticsEvent();\r\n\r\n    this.p2pJingleSession.initialize(\r\n        this.room,\r\n        this.rtc, {\r\n            ...this.options.config,\r\n            enableInsertableStreams: this.isE2EEEnabled()\r\n        });\r\n\r\n    logger.info('Starting CallStats for P2P connection...');\r\n\r\n    let remoteID = Strophe.getResourceFromJid(this.p2pJingleSession.remoteJid);\r\n\r\n    const participant = this.participants[remoteID];\r\n\r\n    if (participant) {\r\n        remoteID = participant.getStatsID() || remoteID;\r\n    }\r\n\r\n    this.statistics.startCallStats(\r\n        this.p2pJingleSession.peerconnection,\r\n        remoteID);\r\n\r\n    const localTracks = this.getLocalTracks();\r\n\r\n    this.p2pJingleSession.acceptOffer(\r\n        jingleOffer,\r\n        () => {\r\n            logger.debug('Got RESULT for P2P \"session-accept\"');\r\n\r\n            this.eventEmitter.emit(\r\n                JitsiConferenceEvents._MEDIA_SESSION_STARTED,\r\n                this.p2pJingleSession);\r\n        },\r\n        error => {\r\n            logger.error(\r\n                'Failed to accept incoming P2P Jingle session', error);\r\n        },\r\n        localTracks);\r\n};\r\n\r\n/**\r\n * Adds remote tracks to the conference associated with the JVB session.\r\n * @private\r\n */\r\nJitsiConference.prototype._addRemoteJVBTracks = function() {\r\n    this._addRemoteTracks(\r\n        'JVB', this.jvbJingleSession.peerconnection.getRemoteTracks());\r\n};\r\n\r\n/**\r\n * Adds remote tracks to the conference associated with the P2P session.\r\n * @private\r\n */\r\nJitsiConference.prototype._addRemoteP2PTracks = function() {\r\n    this._addRemoteTracks(\r\n        'P2P', this.p2pJingleSession.peerconnection.getRemoteTracks());\r\n};\r\n\r\n/**\r\n * Generates fake \"remote track added\" events for given Jingle session.\r\n * @param {string} logName the session's nickname which will appear in log\r\n * messages.\r\n * @param {Array<JitsiRemoteTrack>} remoteTracks the tracks that will be added\r\n * @private\r\n */\r\nJitsiConference.prototype._addRemoteTracks = function(logName, remoteTracks) {\r\n    for (const track of remoteTracks) {\r\n        logger.info(`Adding remote ${logName} track: ${track}`);\r\n        this.onRemoteTrackAdded(track);\r\n    }\r\n};\r\n\r\n/**\r\n * Called when {@link XMPPEvents.CONNECTION_ESTABLISHED} event is\r\n * triggered for a {@link JingleSessionPC}. Switches the conference to use\r\n * the P2P connection if the event comes from the P2P session.\r\n * @param {JingleSessionPC} jingleSession the session instance.\r\n * @private\r\n */\r\nJitsiConference.prototype._onIceConnectionEstablished = function(\r\n        jingleSession) {\r\n    if (this.p2pJingleSession !== null) {\r\n        // store the establishment time of the p2p session as a field of the\r\n        // JitsiConference because the p2pJingleSession might get disposed (thus\r\n        // the value is lost).\r\n        this.p2pEstablishmentDuration\r\n            = this.p2pJingleSession.establishmentDuration;\r\n    }\r\n\r\n    if (this.jvbJingleSession !== null) {\r\n        this.jvbEstablishmentDuration\r\n            = this.jvbJingleSession.establishmentDuration;\r\n    }\r\n\r\n    let done = false;\r\n    const forceJVB121Ratio = this.options.config.forceJVB121Ratio;\r\n\r\n    // We don't care about the JVB case, there's nothing to be done\r\n    if (!jingleSession.isP2P) {\r\n        done = true;\r\n    } else if (this.p2pJingleSession !== jingleSession) {\r\n        logger.error('CONNECTION_ESTABLISHED - wrong P2P session instance ?!');\r\n\r\n        done = true;\r\n    } else if (!jingleSession.isInitiator\r\n        && typeof forceJVB121Ratio === 'number'\r\n        && Math.random() < forceJVB121Ratio) {\r\n        logger.info(`Forcing JVB 121 mode (ratio=${forceJVB121Ratio})...`);\r\n        Statistics.analytics.addPermanentProperties({ forceJvb121: true });\r\n        this._stopP2PSession('decline', 'force JVB121');\r\n\r\n        done = true;\r\n    }\r\n\r\n    if (!isNaN(this.p2pEstablishmentDuration)\r\n        && !isNaN(this.jvbEstablishmentDuration)) {\r\n        const establishmentDurationDiff\r\n            = this.p2pEstablishmentDuration - this.jvbEstablishmentDuration;\r\n\r\n        Statistics.sendAnalytics(\r\n            ICE_ESTABLISHMENT_DURATION_DIFF,\r\n            { value: establishmentDurationDiff });\r\n    }\r\n\r\n    if (jingleSession.isP2P === this.isP2PActive()) {\r\n        this.eventEmitter.emit(JitsiConferenceEvents.CONNECTION_ESTABLISHED);\r\n    }\r\n\r\n    if (done) {\r\n\r\n        return;\r\n    }\r\n\r\n    // Update P2P status and emit events\r\n    this._setP2PStatus(true);\r\n\r\n    // Remove remote tracks\r\n    if (this.jvbJingleSession) {\r\n        this._removeRemoteJVBTracks();\r\n    } else {\r\n        logger.info('Not removing remote JVB tracks - no session yet');\r\n    }\r\n\r\n    this._addRemoteP2PTracks();\r\n\r\n    // Stop media transfer over the JVB connection\r\n    if (this.jvbJingleSession) {\r\n        this._suspendMediaTransferForJvbConnection();\r\n    }\r\n\r\n    logger.info('Starting remote stats with p2p connection');\r\n    this.statistics.startRemoteStats(this.p2pJingleSession.peerconnection);\r\n\r\n    Statistics.sendAnalyticsAndLog(\r\n        createP2PEvent(\r\n            ACTION_P2P_ESTABLISHED,\r\n            {\r\n                initiator: this.p2pJingleSession.isInitiator\r\n            }));\r\n\r\n};\r\n\r\n/**\r\n * Called when the chat room reads a new list of properties from jicofo's\r\n * presence. The properties may have changed, but they don't have to.\r\n *\r\n * @param {Object} properties - The properties keyed by the property name\r\n * ('key').\r\n * @private\r\n */\r\nJitsiConference.prototype._updateProperties = function(properties = {}) {\r\n    const changed = !isEqual(properties, this.properties);\r\n\r\n    this.properties = properties;\r\n    if (changed) {\r\n        this.eventEmitter.emit(\r\n            JitsiConferenceEvents.PROPERTIES_CHANGED,\r\n            this.properties);\r\n\r\n        // Some of the properties need to be added to analytics events.\r\n        const analyticsKeys = [\r\n\r\n            // The number of jitsi-videobridge instances currently used for the\r\n            // conference.\r\n            'bridge-count',\r\n\r\n            // The conference creation time (set by jicofo).\r\n            'created-ms'\r\n        ];\r\n\r\n        analyticsKeys.forEach(key => {\r\n            if (properties[key] !== undefined) {\r\n                Statistics.analytics.addPermanentProperties({\r\n                    [key.replace('-', '_')]: properties[key]\r\n                });\r\n            }\r\n        });\r\n    }\r\n};\r\n\r\n/**\r\n * Gets a conference property with a given key.\r\n *\r\n * @param {string} key - The key.\r\n * @returns {*} The value\r\n */\r\nJitsiConference.prototype.getProperty = function(key) {\r\n    return this.properties[key];\r\n};\r\n\r\n/**\r\n * Clears the deferred start P2P task if it has been scheduled.\r\n * @private\r\n */\r\nJitsiConference.prototype._maybeClearDeferredStartP2P = function() {\r\n    if (this.deferredStartP2PTask) {\r\n        logger.info('Cleared deferred start P2P task');\r\n        clearTimeout(this.deferredStartP2PTask);\r\n        this.deferredStartP2PTask = null;\r\n    }\r\n};\r\n\r\n/**\r\n * Removes from the conference remote tracks associated with the JVB\r\n * connection.\r\n * @private\r\n */\r\nJitsiConference.prototype._removeRemoteJVBTracks = function() {\r\n    this._removeRemoteTracks(\r\n        'JVB', this.jvbJingleSession.peerconnection.getRemoteTracks());\r\n};\r\n\r\n/**\r\n * Removes from the conference remote tracks associated with the P2P\r\n * connection.\r\n * @private\r\n */\r\nJitsiConference.prototype._removeRemoteP2PTracks = function() {\r\n    this._removeRemoteTracks(\r\n        'P2P', this.p2pJingleSession.peerconnection.getRemoteTracks());\r\n};\r\n\r\n/**\r\n * Generates fake \"remote track removed\" events for given Jingle session.\r\n * @param {string} sessionNickname the session's nickname which will appear in\r\n * log messages.\r\n * @param {Array<JitsiRemoteTrack>} remoteTracks the tracks that will be removed\r\n * @private\r\n */\r\nJitsiConference.prototype._removeRemoteTracks = function(\r\n        sessionNickname,\r\n        remoteTracks) {\r\n    for (const track of remoteTracks) {\r\n        logger.info(`Removing remote ${sessionNickname} track: ${track}`);\r\n        this.onRemoteTrackRemoved(track);\r\n    }\r\n};\r\n\r\n/**\r\n * Resumes media transfer over the JVB connection.\r\n * @private\r\n */\r\nJitsiConference.prototype._resumeMediaTransferForJvbConnection = function() {\r\n    logger.info('Resuming media transfer over the JVB connection...');\r\n    this.jvbJingleSession.setMediaTransferActive(true, true).then(\r\n        () => {\r\n            logger.info('Resumed media transfer over the JVB connection!');\r\n        },\r\n        error => {\r\n            logger.error(\r\n                'Failed to resume media transfer over the JVB connection:',\r\n                error);\r\n        });\r\n};\r\n\r\n/**\r\n * Sets new P2P status and updates some events/states hijacked from\r\n * the <tt>JitsiConference</tt>.\r\n * @param {boolean} newStatus the new P2P status value, <tt>true</tt> means that\r\n * P2P is now in use, <tt>false</tt> means that the JVB connection is now in use\r\n * @private\r\n */\r\nJitsiConference.prototype._setP2PStatus = function(newStatus) {\r\n    if (this.p2p === newStatus) {\r\n        logger.debug(`Called _setP2PStatus with the same status: ${newStatus}`);\r\n\r\n        return;\r\n    }\r\n    this.p2p = newStatus;\r\n    if (newStatus) {\r\n        logger.info('Peer to peer connection established!');\r\n\r\n        // When we end up in a valid P2P session need to reset the properties\r\n        // in case they have persisted, after session with another peer.\r\n        Statistics.analytics.addPermanentProperties({\r\n            p2pFailed: false,\r\n            forceJvb121: false\r\n        });\r\n\r\n        // Sync up video transfer active in case p2pJingleSession not existed\r\n        // when the lastN value was being adjusted.\r\n        const isVideoActive = this.getLastN() !== 0;\r\n\r\n        this.p2pJingleSession\r\n            .setMediaTransferActive(true, isVideoActive)\r\n            .catch(error => {\r\n                logger.error(\r\n                    'Failed to sync up P2P video transfer status'\r\n                        + `(${isVideoActive})`, error);\r\n            });\r\n    } else {\r\n        logger.info('Peer to peer connection closed!');\r\n    }\r\n\r\n    // Put the JVB connection on hold/resume\r\n    if (this.jvbJingleSession) {\r\n        this.statistics.sendConnectionResumeOrHoldEvent(\r\n            this.jvbJingleSession.peerconnection, !newStatus);\r\n    }\r\n\r\n    // Clear dtmfManager, so that it can be recreated with new connection\r\n    this.dtmfManager = null;\r\n\r\n    // Update P2P status\r\n    this.eventEmitter.emit(\r\n        JitsiConferenceEvents.P2P_STATUS,\r\n        this,\r\n        this.p2p);\r\n    this.eventEmitter.emit(\r\n        JitsiConferenceEvents._MEDIA_SESSION_ACTIVE_CHANGED,\r\n        this._getActiveMediaSession());\r\n\r\n    // Refresh connection interrupted/restored\r\n    this.eventEmitter.emit(\r\n        this.isConnectionInterrupted()\r\n            ? JitsiConferenceEvents.CONNECTION_INTERRUPTED\r\n            : JitsiConferenceEvents.CONNECTION_RESTORED);\r\n};\r\n\r\n/**\r\n * Starts new P2P session.\r\n * @param {string} remoteJid the JID of the remote participant\r\n * @private\r\n */\r\nJitsiConference.prototype._startP2PSession = function(remoteJid) {\r\n    this._maybeClearDeferredStartP2P();\r\n    if (this.p2pJingleSession) {\r\n        logger.error('P2P session already started!');\r\n\r\n        return;\r\n    }\r\n\r\n    this.isP2PConnectionInterrupted = false;\r\n    this.p2pJingleSession\r\n        = this.xmpp.connection.jingle.newP2PJingleSession(\r\n            this.room.myroomjid,\r\n            remoteJid);\r\n    logger.info(\r\n        'Created new P2P JingleSession', this.room.myroomjid, remoteJid);\r\n    this._sendConferenceJoinAnalyticsEvent();\r\n\r\n    this.p2pJingleSession.initialize(\r\n        this.room,\r\n        this.rtc, {\r\n            ...this.options.config,\r\n            enableInsertableStreams: this.isE2EEEnabled()\r\n        });\r\n\r\n    logger.info('Starting CallStats for P2P connection...');\r\n\r\n    let remoteID = Strophe.getResourceFromJid(this.p2pJingleSession.remoteJid);\r\n\r\n    const participant = this.participants[remoteID];\r\n\r\n    if (participant) {\r\n        remoteID = participant.getStatsID() || remoteID;\r\n    }\r\n\r\n    this.statistics.startCallStats(\r\n        this.p2pJingleSession.peerconnection,\r\n        remoteID);\r\n\r\n    const localTracks = this.getLocalTracks();\r\n\r\n    this.p2pJingleSession.invite(localTracks);\r\n};\r\n\r\n/**\r\n * Suspends media transfer over the JVB connection.\r\n * @private\r\n */\r\nJitsiConference.prototype._suspendMediaTransferForJvbConnection = function() {\r\n    logger.info('Suspending media transfer over the JVB connection...');\r\n    this.jvbJingleSession.setMediaTransferActive(false, false).then(\r\n        () => {\r\n            logger.info('Suspended media transfer over the JVB connection !');\r\n        },\r\n        error => {\r\n            logger.error(\r\n                'Failed to suspend media transfer over the JVB connection:',\r\n                error);\r\n        });\r\n};\r\n\r\n/**\r\n * Method when called will decide whether it's the time to start or stop\r\n * the P2P session.\r\n * @param {boolean} userLeftEvent if <tt>true</tt> it means that the call\r\n * originates from the user left event.\r\n * @private\r\n */\r\nJitsiConference.prototype._maybeStartOrStopP2P = function(userLeftEvent) {\r\n    if (!this.isP2PEnabled() || this.isP2PTestModeEnabled() || browser.isFirefox() || browser.isWebKitBased()) {\r\n        logger.info('Auto P2P disabled');\r\n\r\n        return;\r\n    }\r\n    const peers = this.getParticipants();\r\n    const peerCount = peers.length;\r\n\r\n    // FIXME 1 peer and it must *support* P2P switching\r\n    const shouldBeInP2P = this._shouldBeInP2PMode();\r\n\r\n    // Clear deferred \"start P2P\" task\r\n    if (!shouldBeInP2P && this.deferredStartP2PTask) {\r\n        this._maybeClearDeferredStartP2P();\r\n    }\r\n\r\n    // Start peer to peer session\r\n    if (!this.p2pJingleSession && shouldBeInP2P) {\r\n        const peer = peerCount && peers[0];\r\n\r\n\r\n        const myId = this.myUserId();\r\n        const peersId = peer.getId();\r\n\r\n        if (myId > peersId) {\r\n            logger.debug(\r\n                'I\\'m the bigger peersId - '\r\n                + 'the other peer should start P2P', myId, peersId);\r\n\r\n            return;\r\n        } else if (myId === peersId) {\r\n            logger.error('The same IDs ? ', myId, peersId);\r\n\r\n            return;\r\n        }\r\n\r\n        const jid = peer.getJid();\r\n\r\n        if (userLeftEvent) {\r\n            if (this.deferredStartP2PTask) {\r\n                logger.error('Deferred start P2P task\\'s been set already!');\r\n\r\n                return;\r\n            }\r\n            logger.info(\r\n                `Will start P2P with: ${jid} after ${\r\n                    this.backToP2PDelay} seconds...`);\r\n            this.deferredStartP2PTask = setTimeout(\r\n                this._startP2PSession.bind(this, jid),\r\n                this.backToP2PDelay * 1000);\r\n        } else {\r\n            logger.info(`Will start P2P with: ${jid}`);\r\n            this._startP2PSession(jid);\r\n        }\r\n    } else if (this.p2pJingleSession && !shouldBeInP2P) {\r\n        logger.info(`Will stop P2P with: ${this.p2pJingleSession.remoteJid}`);\r\n\r\n        // Log that there will be a switch back to the JVB connection\r\n        if (this.p2pJingleSession.isInitiator && peerCount > 1) {\r\n            Statistics.sendAnalyticsAndLog(\r\n                createP2PEvent(ACTION_P2P_SWITCH_TO_JVB));\r\n        }\r\n        this._stopP2PSession();\r\n    }\r\n};\r\n\r\n/**\r\n * Tells whether or not this conference should be currently in the P2P mode.\r\n *\r\n * @private\r\n * @returns {boolean}\r\n */\r\nJitsiConference.prototype._shouldBeInP2PMode = function() {\r\n    const peers = this.getParticipants();\r\n    const peerCount = peers.length;\r\n    const hasBotPeer = peers.find(p => p.getBotType() === 'poltergeist' || p.hasFeature(FEATURE_JIGASI)) !== undefined;\r\n    const shouldBeInP2P = peerCount === 1 && !hasBotPeer;\r\n\r\n    logger.debug(`P2P? peerCount: ${peerCount}, hasBotPeer: ${hasBotPeer} => ${shouldBeInP2P}`);\r\n\r\n    return shouldBeInP2P;\r\n};\r\n\r\n/**\r\n * Stops the current P2P session.\r\n * @param {string} [reason=\"success\"] one of the Jingle \"reason\" element\r\n * names as defined by https://xmpp.org/extensions/xep-0166.html#def-reason\r\n * @param {string} [reasonDescription=\"Turing off P2P session\"] text\r\n * description that will be included in the session terminate message\r\n * @private\r\n */\r\nJitsiConference.prototype._stopP2PSession = function(\r\n        reason,\r\n        reasonDescription) {\r\n    if (!this.p2pJingleSession) {\r\n        logger.error('No P2P session to be stopped!');\r\n\r\n        return;\r\n    }\r\n\r\n    const wasP2PEstablished = this.isP2PActive();\r\n\r\n    // Swap remote tracks, but only if the P2P has been fully established\r\n    if (wasP2PEstablished) {\r\n        if (this.jvbJingleSession) {\r\n            this._resumeMediaTransferForJvbConnection();\r\n        }\r\n\r\n        // Remove remote P2P tracks\r\n        this._removeRemoteP2PTracks();\r\n    }\r\n\r\n    // Stop P2P stats\r\n    logger.info('Stopping remote stats for P2P connection');\r\n    this.statistics.stopRemoteStats(this.p2pJingleSession.peerconnection);\r\n    logger.info('Stopping CallStats for P2P connection');\r\n    this.statistics.stopCallStats(this.p2pJingleSession.peerconnection);\r\n\r\n    this.p2pJingleSession.terminate(\r\n        () => {\r\n            logger.info('P2P session terminate RESULT');\r\n        },\r\n        error => {\r\n            // Because both initiator and responder are simultaneously\r\n            // terminating their JingleSessions in case of the 'to JVB switch'\r\n            // when 3rd participant joins, both will dispose their sessions and\r\n            // reply with 'item-not-found' (see strophe.jingle.js). We don't\r\n            // want to log this as an error since it's expected behaviour.\r\n            //\r\n            // We want them both to terminate, because in case of initiator's\r\n            // crash the responder would stay in P2P mode until ICE fails which\r\n            // could take up to 20 seconds.\r\n            //\r\n            // NOTE lack of 'reason' is considered as graceful session terminate\r\n            // where both initiator and responder terminate their sessions\r\n            // simultaneously.\r\n            if (reason) {\r\n                logger.error(\r\n                    'An error occurred while trying to terminate'\r\n                        + ' P2P Jingle session', error);\r\n            }\r\n        }, {\r\n            reason: reason ? reason : 'success',\r\n            reasonDescription: reasonDescription\r\n                ? reasonDescription : 'Turing off P2P session',\r\n            sendSessionTerminate: this.room\r\n                && this.getParticipantById(\r\n                    Strophe.getResourceFromJid(this.p2pJingleSession.remoteJid))\r\n        });\r\n\r\n    this.p2pJingleSession = null;\r\n\r\n    // Update P2P status and other affected events/states\r\n    this._setP2PStatus(false);\r\n\r\n    if (wasP2PEstablished) {\r\n        // Add back remote JVB tracks\r\n        if (this.jvbJingleSession) {\r\n            this._addRemoteJVBTracks();\r\n        } else {\r\n            logger.info('Not adding remote JVB tracks - no session yet');\r\n        }\r\n    }\r\n};\r\n\r\n/**\r\n * Checks whether or not the conference is currently in the peer to peer mode.\r\n * Being in peer to peer mode means that the direct connection has been\r\n * established and the P2P connection is being used for media transmission.\r\n * @return {boolean} <tt>true</tt> if in P2P mode or <tt>false</tt> otherwise.\r\n */\r\nJitsiConference.prototype.isP2PActive = function() {\r\n    return this.p2p;\r\n};\r\n\r\n/**\r\n * Returns the current ICE state of the P2P connection.\r\n * NOTE: method is used by the jitsi-meet-torture tests.\r\n * @return {string|null} an ICE state or <tt>null</tt> if there's currently\r\n * no P2P connection.\r\n */\r\nJitsiConference.prototype.getP2PConnectionState = function() {\r\n    if (this.isP2PActive()) {\r\n        return this.p2pJingleSession.peerconnection.getConnectionState();\r\n    }\r\n\r\n    return null;\r\n};\r\n\r\n\r\n/**\r\n * Manually starts new P2P session (should be used only in the tests).\r\n */\r\nJitsiConference.prototype.startP2PSession = function() {\r\n    const peers = this.getParticipants();\r\n\r\n    // Start peer to peer session\r\n    if (peers.length === 1) {\r\n        const peerJid = peers[0].getJid();\r\n\r\n        this._startP2PSession(peerJid);\r\n    } else {\r\n        throw new Error(\r\n            'There must be exactly 1 participant to start the P2P session !');\r\n    }\r\n};\r\n\r\n/**\r\n * Manually stops the current P2P session (should be used only in the tests)\r\n */\r\nJitsiConference.prototype.stopP2PSession = function() {\r\n    this._stopP2PSession();\r\n};\r\n\r\n/**\r\n * Get a summary of how long current participants have been the dominant speaker\r\n * @returns {object}\r\n */\r\nJitsiConference.prototype.getSpeakerStats = function() {\r\n    return this.speakerStatsCollector.getStats();\r\n};\r\n\r\n/**\r\n * Sets the constraints for the video that is requested from the bridge.\r\n *\r\n * @param {Object} videoConstraints The constraints which are specified in the\r\n * following format. The message updates the fields that are present and leaves the\r\n * rest unchanged on the bridge. Therefore, any field that is not applicable anymore\r\n * should be cleared by passing an empty object or list (whatever is applicable).\r\n * {\r\n *      'lastN': 20,\r\n *      'selectedEndpoints': ['A', 'B', 'C'],\r\n *      'onStageEndpoints': ['A'],\r\n *      'defaultConstraints': { 'maxHeight': 180 },\r\n *      'constraints': {\r\n *          'A': { 'maxHeight': 720 }\r\n *      }\r\n * }\r\n */\r\nJitsiConference.prototype.setReceiverConstraints = function(videoConstraints) {\r\n    this.receiveVideoController.setReceiverConstraints(videoConstraints);\r\n};\r\n\r\n/**\r\n * Sets the maximum video size the local participant should receive from remote\r\n * participants.\r\n *\r\n * @param {number} maxFrameHeight - the maximum frame height, in pixels,\r\n * this receiver is willing to receive.\r\n * @returns {void}\r\n */\r\nJitsiConference.prototype.setReceiverVideoConstraint = function(maxFrameHeight) {\r\n    this.receiveVideoController.setPreferredReceiveMaxFrameHeight(maxFrameHeight);\r\n};\r\n\r\n/**\r\n * Sets the maximum video size the local participant should send to remote\r\n * participants.\r\n * @param {number} maxFrameHeight - The user preferred max frame height.\r\n * @returns {Promise} promise that will be resolved when the operation is\r\n * successful and rejected otherwise.\r\n */\r\nJitsiConference.prototype.setSenderVideoConstraint = function(maxFrameHeight) {\r\n    return this.sendVideoController.setPreferredSendMaxFrameHeight(maxFrameHeight);\r\n};\r\n\r\n/**\r\n * Creates a video SIP GW session and returns it if service is enabled. Before\r\n * creating a session one need to check whether video SIP GW service is\r\n * available in the system {@link JitsiConference.isVideoSIPGWAvailable}. Even\r\n * if there are available nodes to serve this request, after creating the\r\n * session those nodes can be taken and the request about using the\r\n * created session can fail.\r\n *\r\n * @param {string} sipAddress - The sip address to be used.\r\n * @param {string} displayName - The display name to be used for this session.\r\n * @returns {JitsiVideoSIPGWSession|Error} Returns null if conference is not\r\n * initialised and there is no room.\r\n */\r\nJitsiConference.prototype.createVideoSIPGWSession\r\n    = function(sipAddress, displayName) {\r\n        if (!this.room) {\r\n            return new Error(VideoSIPGWConstants.ERROR_NO_CONNECTION);\r\n        }\r\n\r\n        return this.videoSIPGWHandler\r\n            .createVideoSIPGWSession(sipAddress, displayName);\r\n    };\r\n\r\n/**\r\n * Sends a conference.join analytics event.\r\n *\r\n * @returns {void}\r\n */\r\nJitsiConference.prototype._sendConferenceJoinAnalyticsEvent = function() {\r\n    const meetingId = this.getMeetingUniqueId();\r\n\r\n    if (this._conferenceJoinAnalyticsEventSent || !meetingId || this.getActivePeerConnection() === null) {\r\n        return;\r\n    }\r\n\r\n    Statistics.sendAnalytics(createConferenceEvent('joined', {\r\n        meetingId,\r\n        participantId: `${meetingId}.${this._statsCurrentId}`\r\n    }));\r\n    this._conferenceJoinAnalyticsEventSent = Date.now();\r\n};\r\n\r\n/**\r\n * Sends conference.left analytics event.\r\n * @private\r\n */\r\nJitsiConference.prototype._sendConferenceLeftAnalyticsEvent = function() {\r\n    const meetingId = this.getMeetingUniqueId();\r\n\r\n    if (!meetingId || !this._conferenceJoinAnalyticsEventSent) {\r\n\r\n        return;\r\n    }\r\n\r\n    Statistics.sendAnalytics(createConferenceEvent('left', {\r\n        meetingId,\r\n        participantId: `${meetingId}.${this._statsCurrentId}`,\r\n        stats: {\r\n            duration: Math.floor((Date.now() - this._conferenceJoinAnalyticsEventSent) / 1000),\r\n            perf: this.getPerformanceStats()\r\n        }\r\n    }));\r\n};\r\n\r\n/**\r\n * Restarts all active media sessions.\r\n *\r\n * @returns {void}\r\n */\r\nJitsiConference.prototype._restartMediaSessions = function() {\r\n    if (this.p2pJingleSession) {\r\n        this.stopP2PSession();\r\n    }\r\n\r\n    if (this.jvbJingleSession) {\r\n        this.jvbJingleSession.terminate(\r\n            null /* success callback => we don't care */,\r\n            error => {\r\n                logger.warn('An error occurred while trying to terminate the JVB session', error);\r\n            }, {\r\n                reason: 'success',\r\n                reasonDescription: 'restart required',\r\n                requestRestart: true,\r\n                sendSessionTerminate: true\r\n            });\r\n    }\r\n\r\n    this._maybeStartOrStopP2P(false);\r\n};\r\n\r\n/**\r\n * Returns whether End-To-End encryption is enabled.\r\n *\r\n * @returns {boolean}\r\n */\r\nJitsiConference.prototype.isE2EEEnabled = function() {\r\n    return this._e2eEncryption && this._e2eEncryption.isEnabled();\r\n};\r\n\r\n/**\r\n * Returns whether End-To-End encryption is supported. Note that not all participants\r\n * in the conference may support it.\r\n *\r\n * @returns {boolean}\r\n */\r\nJitsiConference.prototype.isE2EESupported = function() {\r\n    return E2EEncryption.isSupported(this.options.config);\r\n};\r\n\r\n/**\r\n * Enables / disables End-to-End encryption.\r\n *\r\n * @param {boolean} enabled whether to enable E2EE or not.\r\n * @returns {void}\r\n */\r\nJitsiConference.prototype.toggleE2EE = function(enabled) {\r\n    if (!this.isE2EESupported()) {\r\n        logger.warn('Cannot enable / disable E2EE: platform is not supported.');\r\n\r\n        return;\r\n    }\r\n\r\n    this._e2eEncryption.setEnabled(enabled);\r\n};\r\n\r\n/**\r\n * Returns <tt>true</tt> if lobby support is enabled in the backend.\r\n *\r\n * @returns {boolean} whether lobby is supported in the backend.\r\n */\r\nJitsiConference.prototype.isLobbySupported = function() {\r\n    return Boolean(this.room && this.room.getLobby().isSupported());\r\n};\r\n\r\n/**\r\n * Returns <tt>true</tt> if the room has members only enabled.\r\n *\r\n * @returns {boolean} whether conference room is members only.\r\n */\r\nJitsiConference.prototype.isMembersOnly = function() {\r\n    return Boolean(this.room && this.room.membersOnlyEnabled);\r\n};\r\n\r\n/**\r\n * Enables lobby by moderators\r\n *\r\n * @returns {Promise} resolves when lobby room is joined or rejects with the error.\r\n */\r\nJitsiConference.prototype.enableLobby = function() {\r\n    if (this.room && this.isModerator()) {\r\n        return this.room.getLobby().enable();\r\n    }\r\n\r\n    return Promise.reject(\r\n        new Error('The conference not started or user is not moderator'));\r\n};\r\n\r\n/**\r\n * Disabled lobby by moderators\r\n *\r\n * @returns {void}\r\n */\r\nJitsiConference.prototype.disableLobby = function() {\r\n    if (this.room && this.isModerator()) {\r\n        this.room.getLobby().disable();\r\n    } else {\r\n        logger.warn(`Failed to disable lobby, ${this.room ? '' : 'not in a room, '}${\r\n            this.isModerator() ? '' : 'participant is not a moderator'}`);\r\n    }\r\n};\r\n\r\n/**\r\n * Joins the lobby room with display name and optional email or with a shared password to skip waiting.\r\n *\r\n * @param {string} displayName Display name should be set to show it to moderators.\r\n * @param {string} email Optional email is used to present avatar to the moderator.\r\n * @returns {Promise<never>}\r\n */\r\nJitsiConference.prototype.joinLobby = function(displayName, email) {\r\n    if (this.room) {\r\n        return this.room.getLobby().join(displayName, email);\r\n    }\r\n\r\n    return Promise.reject(new Error('The conference not started'));\r\n};\r\n\r\n/**\r\n * Denies an occupant in the lobby room access to the conference.\r\n * @param {string} id The participant id.\r\n */\r\nJitsiConference.prototype.lobbyDenyAccess = function(id) {\r\n    if (this.room) {\r\n        this.room.getLobby().denyAccess(id);\r\n    }\r\n};\r\n\r\n/**\r\n * Approves the request to join the conference to a participant waiting in the lobby.\r\n *\r\n * @param {string} id The participant id.\r\n */\r\nJitsiConference.prototype.lobbyApproveAccess = function(id) {\r\n    if (this.room) {\r\n        this.room.getLobby().approveAccess(id);\r\n    }\r\n};\r\n\r\n/**\r\n * Returns <tt>true</tt> if AV Moderation support is enabled in the backend.\r\n *\r\n * @returns {boolean} whether AV Moderation is supported in the backend.\r\n */\r\nJitsiConference.prototype.isAVModerationSupported = function() {\r\n    return Boolean(this.room && this.room.getAVModeration().isSupported());\r\n};\r\n\r\n/**\r\n * Enables AV Moderation.\r\n * @param {MediaType} mediaType \"audio\" or \"video\"\r\n */\r\nJitsiConference.prototype.enableAVModeration = function(mediaType) {\r\n    if (this.room && this.isModerator()\r\n        && (mediaType === MediaType.AUDIO || mediaType === MediaType.VIDEO)) {\r\n        this.room.getAVModeration().enable(true, mediaType);\r\n    } else {\r\n        logger.warn(`Failed to enable AV moderation, ${this.room ? '' : 'not in a room, '}${\r\n            this.isModerator() ? '' : 'participant is not a moderator, '}${\r\n            this.room && this.isModerator() ? 'wrong media type passed' : ''}`);\r\n    }\r\n};\r\n\r\n/**\r\n * Disables AV Moderation.\r\n * @param {MediaType} mediaType \"audio\" or \"video\"\r\n */\r\nJitsiConference.prototype.disableAVModeration = function(mediaType) {\r\n    if (this.room && this.isModerator()\r\n        && (mediaType === MediaType.AUDIO || mediaType === MediaType.VIDEO)) {\r\n        this.room.getAVModeration().enable(false, mediaType);\r\n    } else {\r\n        logger.warn(`Failed to disable AV moderation, ${this.room ? '' : 'not in a room, '}${\r\n            this.isModerator() ? '' : 'participant is not a moderator, '}${\r\n            this.room && this.isModerator() ? 'wrong media type passed' : ''}`);\r\n    }\r\n};\r\n\r\n/**\r\n * Approve participant access to certain media, allows unmuting audio or video.\r\n *\r\n * @param {MediaType} mediaType \"audio\" or \"video\"\r\n * @param id the id of the participant.\r\n */\r\nJitsiConference.prototype.avModerationApprove = function(mediaType, id) {\r\n    if (this.room && this.isModerator()\r\n        && (mediaType === MediaType.AUDIO || mediaType === MediaType.VIDEO)) {\r\n\r\n        const participant = this.getParticipantById(id);\r\n\r\n        if (!participant) {\r\n            return;\r\n        }\r\n\r\n        this.room.getAVModeration().approve(mediaType, participant.getJid());\r\n    } else {\r\n        logger.warn(`AV moderation skipped , ${this.room ? '' : 'not in a room, '}${\r\n            this.isModerator() ? '' : 'participant is not a moderator, '}${\r\n            this.room && this.isModerator() ? 'wrong media type passed' : ''}`);\r\n    }\r\n};\r\n","/* global __filename */\r\n\r\nimport { getLogger } from 'jitsi-meet-logger';\r\nimport { Strophe } from 'strophe.js';\r\n\r\nimport * as JitsiConferenceErrors from './JitsiConferenceErrors';\r\nimport * as JitsiConferenceEvents from './JitsiConferenceEvents';\r\nimport { SPEAKERS_AUDIO_LEVELS } from './modules/statistics/constants';\r\nimport Statistics from './modules/statistics/statistics';\r\nimport EventEmitterForwarder from './modules/util/EventEmitterForwarder';\r\nimport * as MediaType from './service/RTC/MediaType';\r\nimport RTCEvents from './service/RTC/RTCEvents';\r\nimport VideoType from './service/RTC/VideoType';\r\nimport AuthenticationEvents\r\n    from './service/authentication/AuthenticationEvents';\r\nimport {\r\n    ACTION_JINGLE_SA_TIMEOUT,\r\n    createBridgeDownEvent,\r\n    createConnectionStageReachedEvent,\r\n    createFocusLeftEvent,\r\n    createJingleEvent,\r\n    createRemotelyMutedEvent\r\n} from './service/statistics/AnalyticsEvents';\r\nimport XMPPEvents from './service/xmpp/XMPPEvents';\r\n\r\nconst logger = getLogger(__filename);\r\n\r\n/**\r\n * Setups all event listeners related to conference\r\n * @param conference {JitsiConference} the conference\r\n */\r\nexport default function JitsiConferenceEventManager(conference) {\r\n    this.conference = conference;\r\n    this.xmppListeners = {};\r\n\r\n    // Listeners related to the conference only\r\n    conference.on(JitsiConferenceEvents.TRACK_MUTE_CHANGED,\r\n        track => {\r\n            if (!track.isLocal() || !conference.statistics) {\r\n                return;\r\n            }\r\n            const session\r\n                = track.isP2P\r\n                    ? conference.p2pJingleSession : conference.jvbJingleSession;\r\n\r\n            // TPC will be null, before the conference starts, but the event\r\n            // still should be queued\r\n            const tpc = (session && session.peerconnection) || null;\r\n\r\n            conference.statistics.sendMuteEvent(\r\n                tpc,\r\n                track.isMuted(),\r\n                track.getType());\r\n        });\r\n}\r\n\r\n/**\r\n * Setups event listeners related to conference.chatRoom\r\n */\r\nJitsiConferenceEventManager.prototype.setupChatRoomListeners = function() {\r\n    const conference = this.conference;\r\n    const chatRoom = conference.room;\r\n\r\n    this.chatRoomForwarder = new EventEmitterForwarder(chatRoom,\r\n        this.conference.eventEmitter);\r\n\r\n    chatRoom.addListener(XMPPEvents.ICE_RESTARTING, jingleSession => {\r\n        if (!jingleSession.isP2P) {\r\n            // If using DataChannel as bridge channel, it must be closed\r\n            // before ICE restart, otherwise Chrome will not trigger \"opened\"\r\n            // event for the channel established with the new bridge.\r\n            // TODO: This may be bypassed when using a WebSocket as bridge\r\n            // channel.\r\n            conference.rtc.closeBridgeChannel();\r\n        }\r\n\r\n        // else: there are no DataChannels in P2P session (at least for now)\r\n    });\r\n\r\n    chatRoom.addListener(XMPPEvents.PARTICIPANT_FEATURES_CHANGED, (from, features) => {\r\n        const participant = conference.getParticipantById(Strophe.getResourceFromJid(from));\r\n\r\n        if (participant) {\r\n            participant.setFeatures(features);\r\n            conference.eventEmitter.emit(JitsiConferenceEvents.PARTCIPANT_FEATURES_CHANGED, participant);\r\n        }\r\n    });\r\n\r\n    chatRoom.addListener(\r\n        XMPPEvents.ICE_RESTART_SUCCESS,\r\n        (jingleSession, offerIq) => {\r\n            // The JVB data chanel needs to be reopened in case the conference\r\n            // has been moved to a new bridge.\r\n            !jingleSession.isP2P\r\n                && conference._setBridgeChannel(\r\n                    offerIq, jingleSession.peerconnection);\r\n        });\r\n\r\n\r\n    chatRoom.addListener(XMPPEvents.AUDIO_MUTED_BY_FOCUS,\r\n        actor => {\r\n            // TODO: Add a way to differentiate between commands which caused\r\n            // us to mute and those that did not change our state (i.e. we were\r\n            // already muted).\r\n            Statistics.sendAnalytics(createRemotelyMutedEvent(MediaType.AUDIO));\r\n\r\n            conference.mutedByFocusActor = actor;\r\n\r\n            // set isMutedByFocus when setAudioMute Promise ends\r\n            conference.rtc.setAudioMute(true).then(\r\n                () => {\r\n                    conference.isMutedByFocus = true;\r\n                    conference.mutedByFocusActor = null;\r\n                })\r\n                .catch(\r\n                    error => {\r\n                        conference.mutedByFocusActor = null;\r\n                        logger.warn(\r\n                            'Error while audio muting due to focus request', error);\r\n                    });\r\n        }\r\n    );\r\n\r\n    chatRoom.addListener(XMPPEvents.VIDEO_MUTED_BY_FOCUS,\r\n        actor => {\r\n            // TODO: Add a way to differentiate between commands which caused\r\n            // us to mute and those that did not change our state (i.e. we were\r\n            // already muted).\r\n            Statistics.sendAnalytics(createRemotelyMutedEvent(MediaType.VIDEO));\r\n\r\n            conference.mutedVideoByFocusActor = actor;\r\n\r\n            // set isVideoMutedByFocus when setVideoMute Promise ends\r\n            conference.rtc.setVideoMute(true).then(\r\n                () => {\r\n                    conference.isVideoMutedByFocus = true;\r\n                    conference.mutedVideoByFocusActor = null;\r\n                })\r\n                .catch(\r\n                    error => {\r\n                        conference.mutedVideoByFocusActor = null;\r\n                        logger.warn(\r\n                            'Error while video muting due to focus request', error);\r\n                    });\r\n        }\r\n    );\r\n\r\n    this.chatRoomForwarder.forward(XMPPEvents.SUBJECT_CHANGED,\r\n        JitsiConferenceEvents.SUBJECT_CHANGED);\r\n\r\n    this.chatRoomForwarder.forward(XMPPEvents.MUC_JOINED,\r\n        JitsiConferenceEvents.CONFERENCE_JOINED);\r\n\r\n    this.chatRoomForwarder.forward(XMPPEvents.MEETING_ID_SET,\r\n        JitsiConferenceEvents.CONFERENCE_UNIQUE_ID_SET);\r\n\r\n    // send some analytics events\r\n    chatRoom.addListener(XMPPEvents.MUC_JOINED,\r\n        () => {\r\n            this.conference._onMucJoined();\r\n\r\n            this.conference.isJvbConnectionInterrupted = false;\r\n\r\n            // TODO: Move all of the 'connectionTimes' logic to its own module.\r\n            Object.keys(chatRoom.connectionTimes).forEach(key => {\r\n                const event\r\n                    = createConnectionStageReachedEvent(\r\n                        `conference_${key}`,\r\n                        { value: chatRoom.connectionTimes[key] });\r\n\r\n                Statistics.sendAnalytics(event);\r\n            });\r\n\r\n            // TODO: Move all of the 'connectionTimes' logic to its own module.\r\n            Object.keys(chatRoom.xmpp.connectionTimes).forEach(key => {\r\n                const event\r\n                    = createConnectionStageReachedEvent(\r\n                        `xmpp_${key}`,\r\n                        { value: chatRoom.xmpp.connectionTimes[key] });\r\n\r\n                Statistics.sendAnalytics(event);\r\n            });\r\n        });\r\n\r\n    chatRoom.addListener(XMPPEvents.RENEGOTIATION_FAILED, (e, session) => {\r\n        if (!session.isP2P) {\r\n            conference.eventEmitter.emit(JitsiConferenceEvents.CONFERENCE_FAILED,\r\n                JitsiConferenceErrors.OFFER_ANSWER_FAILED, e);\r\n        }\r\n    });\r\n\r\n    this.chatRoomForwarder.forward(XMPPEvents.ROOM_JOIN_ERROR,\r\n        JitsiConferenceEvents.CONFERENCE_FAILED,\r\n        JitsiConferenceErrors.CONNECTION_ERROR);\r\n\r\n    this.chatRoomForwarder.forward(XMPPEvents.ROOM_CONNECT_ERROR,\r\n        JitsiConferenceEvents.CONFERENCE_FAILED,\r\n        JitsiConferenceErrors.CONNECTION_ERROR);\r\n    this.chatRoomForwarder.forward(XMPPEvents.ROOM_CONNECT_NOT_ALLOWED_ERROR,\r\n        JitsiConferenceEvents.CONFERENCE_FAILED,\r\n        JitsiConferenceErrors.NOT_ALLOWED_ERROR);\r\n    this.chatRoomForwarder.forward(XMPPEvents.ROOM_CONNECT_MEMBERS_ONLY_ERROR,\r\n        JitsiConferenceEvents.CONFERENCE_FAILED,\r\n        JitsiConferenceErrors.MEMBERS_ONLY_ERROR);\r\n\r\n    this.chatRoomForwarder.forward(XMPPEvents.ROOM_MAX_USERS_ERROR,\r\n        JitsiConferenceEvents.CONFERENCE_FAILED,\r\n        JitsiConferenceErrors.CONFERENCE_MAX_USERS);\r\n\r\n    this.chatRoomForwarder.forward(XMPPEvents.PASSWORD_REQUIRED,\r\n        JitsiConferenceEvents.CONFERENCE_FAILED,\r\n        JitsiConferenceErrors.PASSWORD_REQUIRED);\r\n\r\n    this.chatRoomForwarder.forward(XMPPEvents.AUTHENTICATION_REQUIRED,\r\n        JitsiConferenceEvents.CONFERENCE_FAILED,\r\n        JitsiConferenceErrors.AUTHENTICATION_REQUIRED);\r\n\r\n    this.chatRoomForwarder.forward(XMPPEvents.BRIDGE_DOWN,\r\n        JitsiConferenceEvents.CONFERENCE_FAILED,\r\n        JitsiConferenceErrors.VIDEOBRIDGE_NOT_AVAILABLE);\r\n    chatRoom.addListener(\r\n        XMPPEvents.BRIDGE_DOWN,\r\n        () => Statistics.sendAnalytics(createBridgeDownEvent()));\r\n\r\n    chatRoom.addListener(XMPPEvents.CONNECTION_RESTARTED,\r\n        jingleSession => {\r\n            conference._onConferenceRestarted(jingleSession);\r\n        });\r\n\r\n    this.chatRoomForwarder.forward(XMPPEvents.RESERVATION_ERROR,\r\n        JitsiConferenceEvents.CONFERENCE_FAILED,\r\n        JitsiConferenceErrors.RESERVATION_ERROR);\r\n\r\n    this.chatRoomForwarder.forward(XMPPEvents.GRACEFUL_SHUTDOWN,\r\n        JitsiConferenceEvents.CONFERENCE_FAILED,\r\n        JitsiConferenceErrors.GRACEFUL_SHUTDOWN);\r\n\r\n    chatRoom.addListener(XMPPEvents.CONNECTION_ICE_FAILED,\r\n        jingleSession => {\r\n            conference._onIceConnectionFailed(jingleSession);\r\n        });\r\n\r\n    this.chatRoomForwarder.forward(XMPPEvents.MUC_DESTROYED,\r\n        JitsiConferenceEvents.CONFERENCE_FAILED,\r\n        JitsiConferenceErrors.CONFERENCE_DESTROYED);\r\n\r\n    this.chatRoomForwarder.forward(XMPPEvents.CHAT_ERROR_RECEIVED,\r\n        JitsiConferenceEvents.CONFERENCE_ERROR,\r\n        JitsiConferenceErrors.CHAT_ERROR);\r\n\r\n    this.chatRoomForwarder.forward(XMPPEvents.FOCUS_DISCONNECTED,\r\n        JitsiConferenceEvents.CONFERENCE_FAILED,\r\n        JitsiConferenceErrors.FOCUS_DISCONNECTED);\r\n\r\n    chatRoom.addListener(XMPPEvents.FOCUS_LEFT,\r\n        () => {\r\n            Statistics.sendAnalytics(createFocusLeftEvent());\r\n            conference.eventEmitter.emit(\r\n                JitsiConferenceEvents.CONFERENCE_FAILED,\r\n                JitsiConferenceErrors.FOCUS_LEFT);\r\n        });\r\n\r\n    chatRoom.addListener(XMPPEvents.SESSION_ACCEPT_TIMEOUT,\r\n        jingleSession => {\r\n            Statistics.sendAnalyticsAndLog(\r\n                createJingleEvent(\r\n                    ACTION_JINGLE_SA_TIMEOUT,\r\n                    { p2p: jingleSession.isP2P }));\r\n        });\r\n\r\n    chatRoom.addListener(XMPPEvents.RECORDER_STATE_CHANGED,\r\n        (session, jid) => {\r\n\r\n            if (jid) {\r\n                const participant = conference.getParticipantById(\r\n                    Strophe.getResourceFromJid(jid));\r\n\r\n                if (session.getStatus() === 'off') {\r\n                    session.setTerminator(participant);\r\n                } else if (session.getStatus() === 'on') {\r\n                    session.setInitiator(participant);\r\n                }\r\n            }\r\n\r\n            conference.eventEmitter.emit(\r\n                JitsiConferenceEvents.RECORDER_STATE_CHANGED,\r\n                session);\r\n        });\r\n\r\n    this.chatRoomForwarder.forward(XMPPEvents.TRANSCRIPTION_STATUS_CHANGED,\r\n        JitsiConferenceEvents.TRANSCRIPTION_STATUS_CHANGED);\r\n\r\n    this.chatRoomForwarder.forward(XMPPEvents.VIDEO_SIP_GW_AVAILABILITY_CHANGED,\r\n        JitsiConferenceEvents.VIDEO_SIP_GW_AVAILABILITY_CHANGED);\r\n\r\n    this.chatRoomForwarder.forward(\r\n        XMPPEvents.VIDEO_SIP_GW_SESSION_STATE_CHANGED,\r\n        JitsiConferenceEvents.VIDEO_SIP_GW_SESSION_STATE_CHANGED);\r\n\r\n    this.chatRoomForwarder.forward(XMPPEvents.PHONE_NUMBER_CHANGED,\r\n        JitsiConferenceEvents.PHONE_NUMBER_CHANGED);\r\n\r\n    chatRoom.setParticipantPropertyListener((node, from) => {\r\n        const participant = conference.getParticipantById(from);\r\n\r\n        if (!participant) {\r\n            return;\r\n        }\r\n\r\n        participant.setProperty(\r\n            node.tagName.substring('jitsi_participant_'.length),\r\n            node.value);\r\n    });\r\n\r\n    chatRoom.addListener(XMPPEvents.KICKED,\r\n        conference.onMemberKicked.bind(conference));\r\n    chatRoom.addListener(XMPPEvents.SUSPEND_DETECTED,\r\n        conference.onSuspendDetected.bind(conference));\r\n\r\n    this.chatRoomForwarder.forward(XMPPEvents.MUC_LOCK_CHANGED,\r\n        JitsiConferenceEvents.LOCK_STATE_CHANGED);\r\n\r\n    this.chatRoomForwarder.forward(XMPPEvents.MUC_MEMBERS_ONLY_CHANGED,\r\n        JitsiConferenceEvents.MEMBERS_ONLY_CHANGED);\r\n\r\n    chatRoom.addListener(XMPPEvents.MUC_MEMBER_JOINED,\r\n        conference.onMemberJoined.bind(conference));\r\n    this.chatRoomForwarder.forward(XMPPEvents.MUC_LOBBY_MEMBER_JOINED,\r\n        JitsiConferenceEvents.LOBBY_USER_JOINED);\r\n    this.chatRoomForwarder.forward(XMPPEvents.MUC_LOBBY_MEMBER_UPDATED,\r\n        JitsiConferenceEvents.LOBBY_USER_UPDATED);\r\n    this.chatRoomForwarder.forward(XMPPEvents.MUC_LOBBY_MEMBER_LEFT,\r\n        JitsiConferenceEvents.LOBBY_USER_LEFT);\r\n    chatRoom.addListener(XMPPEvents.MUC_MEMBER_BOT_TYPE_CHANGED,\r\n        conference._onMemberBotTypeChanged.bind(conference));\r\n    chatRoom.addListener(XMPPEvents.MUC_MEMBER_LEFT,\r\n        conference.onMemberLeft.bind(conference));\r\n    this.chatRoomForwarder.forward(XMPPEvents.MUC_LEFT,\r\n        JitsiConferenceEvents.CONFERENCE_LEFT);\r\n    this.chatRoomForwarder.forward(XMPPEvents.MUC_DENIED_ACCESS,\r\n        JitsiConferenceEvents.CONFERENCE_FAILED,\r\n        JitsiConferenceErrors.CONFERENCE_ACCESS_DENIED);\r\n\r\n    chatRoom.addListener(XMPPEvents.DISPLAY_NAME_CHANGED,\r\n        conference.onDisplayNameChanged.bind(conference));\r\n\r\n    chatRoom.addListener(XMPPEvents.LOCAL_ROLE_CHANGED, role => {\r\n        conference.onLocalRoleChanged(role);\r\n\r\n        // log all events for the recorder operated by the moderator\r\n        if (conference.statistics && conference.isModerator()) {\r\n            conference.on(JitsiConferenceEvents.RECORDER_STATE_CHANGED,\r\n                recorderSession => {\r\n                    const logObject = {\r\n                        error: recorderSession.getError(),\r\n                        id: 'recorder_status',\r\n                        status: recorderSession.getStatus()\r\n                    };\r\n\r\n                    Statistics.sendLog(JSON.stringify(logObject));\r\n                });\r\n        }\r\n    });\r\n\r\n    chatRoom.addListener(XMPPEvents.MUC_ROLE_CHANGED,\r\n        conference.onUserRoleChanged.bind(conference));\r\n\r\n    chatRoom.addListener(AuthenticationEvents.IDENTITY_UPDATED,\r\n        (authEnabled, authIdentity) => {\r\n            conference.authEnabled = authEnabled;\r\n            conference.authIdentity = authIdentity;\r\n            conference.eventEmitter.emit(\r\n                JitsiConferenceEvents.AUTH_STATUS_CHANGED, authEnabled,\r\n                authIdentity);\r\n        });\r\n\r\n    chatRoom.addListener(\r\n        XMPPEvents.MESSAGE_RECEIVED,\r\n\r\n        // eslint-disable-next-line max-params\r\n        (jid, txt, myJid, ts) => {\r\n            const id = Strophe.getResourceFromJid(jid);\r\n\r\n            conference.eventEmitter.emit(\r\n                JitsiConferenceEvents.MESSAGE_RECEIVED,\r\n                id, txt, ts);\r\n        });\r\n\r\n    chatRoom.addListener(\r\n        XMPPEvents.PRIVATE_MESSAGE_RECEIVED,\r\n\r\n        // eslint-disable-next-line max-params\r\n        (jid, txt, myJid, ts) => {\r\n            const id = Strophe.getResourceFromJid(jid);\r\n\r\n            conference.eventEmitter.emit(\r\n                JitsiConferenceEvents.PRIVATE_MESSAGE_RECEIVED,\r\n                id, txt, ts);\r\n        });\r\n\r\n    chatRoom.addListener(XMPPEvents.PRESENCE_STATUS,\r\n        (jid, status) => {\r\n            const id = Strophe.getResourceFromJid(jid);\r\n            const participant = conference.getParticipantById(id);\r\n\r\n            if (!participant || participant._status === status) {\r\n                return;\r\n            }\r\n            participant._status = status;\r\n            conference.eventEmitter.emit(\r\n                JitsiConferenceEvents.USER_STATUS_CHANGED, id, status);\r\n        });\r\n\r\n    chatRoom.addListener(XMPPEvents.JSON_MESSAGE_RECEIVED,\r\n        (from, payload) => {\r\n            const id = Strophe.getResourceFromJid(from);\r\n            const participant = conference.getParticipantById(id);\r\n\r\n            if (participant) {\r\n                conference.eventEmitter.emit(\r\n                    JitsiConferenceEvents.ENDPOINT_MESSAGE_RECEIVED,\r\n                    participant, payload);\r\n            }/* else {\r\n                logger.warn(\r\n                    'Ignored XMPPEvents.JSON_MESSAGE_RECEIVED for not existing '\r\n                    + `participant: ${from}`,\r\n                    payload);\r\n            }*/\r\n        });\r\n\r\n    chatRoom.addPresenceListener('startmuted', (data, from) => {\r\n        let isModerator = false;\r\n\r\n        if (conference.myUserId() === from && conference.isModerator()) {\r\n            isModerator = true;\r\n        } else {\r\n            const participant = conference.getParticipantById(from);\r\n\r\n            if (participant && participant.isModerator()) {\r\n                isModerator = true;\r\n            }\r\n        }\r\n\r\n        if (!isModerator) {\r\n            return;\r\n        }\r\n\r\n        const startAudioMuted = data.attributes.audio === 'true';\r\n        const startVideoMuted = data.attributes.video === 'true';\r\n\r\n        let updated = false;\r\n\r\n        if (startAudioMuted !== conference.startMutedPolicy.audio) {\r\n            conference.startMutedPolicy.audio = startAudioMuted;\r\n            updated = true;\r\n        }\r\n\r\n        if (startVideoMuted !== conference.startMutedPolicy.video) {\r\n            conference.startMutedPolicy.video = startVideoMuted;\r\n            updated = true;\r\n        }\r\n\r\n        if (updated) {\r\n            conference.eventEmitter.emit(\r\n                JitsiConferenceEvents.START_MUTED_POLICY_CHANGED,\r\n                conference.startMutedPolicy\r\n            );\r\n        }\r\n    });\r\n\r\n    if (conference.statistics) {\r\n        // FIXME ICE related events should end up in RTCEvents eventually\r\n        chatRoom.addListener(XMPPEvents.CONNECTION_ICE_FAILED,\r\n            session => {\r\n                conference.statistics.sendIceConnectionFailedEvent(\r\n                    session.peerconnection);\r\n            });\r\n\r\n        // FIXME XMPPEvents.ADD_ICE_CANDIDATE_FAILED is never emitted\r\n        chatRoom.addListener(XMPPEvents.ADD_ICE_CANDIDATE_FAILED,\r\n            (e, pc) => {\r\n                conference.statistics.sendAddIceCandidateFailed(e, pc);\r\n            });\r\n    }\r\n};\r\n\r\n/**\r\n * Setups event listeners related to conference.rtc\r\n */\r\nJitsiConferenceEventManager.prototype.setupRTCListeners = function() {\r\n    const conference = this.conference;\r\n    const rtc = conference.rtc;\r\n\r\n    rtc.addListener(\r\n        RTCEvents.REMOTE_TRACK_ADDED,\r\n        conference.onRemoteTrackAdded.bind(conference));\r\n\r\n    rtc.addListener(\r\n        RTCEvents.REMOTE_TRACK_REMOVED,\r\n        conference.onRemoteTrackRemoved.bind(conference));\r\n\r\n    rtc.addListener(RTCEvents.DOMINANT_SPEAKER_CHANGED,\r\n        (dominant, previous) => {\r\n            if (conference.lastDominantSpeaker !== dominant && conference.room) {\r\n                conference.lastDominantSpeaker = dominant;\r\n                conference.eventEmitter.emit(\r\n                    JitsiConferenceEvents.DOMINANT_SPEAKER_CHANGED, dominant, previous);\r\n\r\n                if (previous && previous.length) {\r\n                    const speakerList = previous.slice(0);\r\n\r\n                    // Add the dominant speaker to the top of the list (exclude self).\r\n                    if (conference.myUserId !== dominant) {\r\n                        speakerList.splice(0, 0, dominant);\r\n                    }\r\n\r\n                    // Trim the list to the top 5 speakers only.\r\n                    if (speakerList.length > SPEAKERS_AUDIO_LEVELS) {\r\n                        speakerList.splice(SPEAKERS_AUDIO_LEVELS, speakerList.length - SPEAKERS_AUDIO_LEVELS);\r\n                    }\r\n                    conference.statistics && conference.statistics.setSpeakerList(speakerList);\r\n                }\r\n                if (conference.statistics && conference.myUserId() === dominant) {\r\n                    // We are the new dominant speaker.\r\n                    conference.statistics.sendDominantSpeakerEvent(conference.room.roomjid);\r\n                }\r\n            }\r\n        });\r\n\r\n    rtc.addListener(RTCEvents.DATA_CHANNEL_OPEN, () => {\r\n        const now = window.performance.now();\r\n        const key = 'data.channel.opened';\r\n\r\n        // TODO: Move all of the 'connectionTimes' logic to its own module.\r\n        logger.log(`(TIME) ${key}:\\t`, now);\r\n        conference.room.connectionTimes[key] = now;\r\n        Statistics.sendAnalytics(\r\n            createConnectionStageReachedEvent(key, { value: now }));\r\n\r\n        conference.eventEmitter.emit(JitsiConferenceEvents.DATA_CHANNEL_OPENED);\r\n    });\r\n\r\n    rtc.addListener(RTCEvents.ENDPOINT_MESSAGE_RECEIVED,\r\n        (from, payload) => {\r\n            const participant = conference.getParticipantById(from);\r\n\r\n            if (participant) {\r\n                conference.eventEmitter.emit(\r\n                    JitsiConferenceEvents.ENDPOINT_MESSAGE_RECEIVED,\r\n                    participant, payload);\r\n            } else {\r\n                /*  //  Ignore messages for content carrier particpants.  \r\n                logger.warn(\r\n                    'Ignored ENDPOINT_MESSAGE_RECEIVED for not existing '\r\n                        + `participant: ${from}`,\r\n                    payload);\r\n                */\r\n            }\r\n        });\r\n\r\n    rtc.addListener(RTCEvents.ENDPOINT_STATS_RECEIVED,\r\n        (from, payload) => {\r\n            const participant = conference.getParticipantById(from);\r\n\r\n            if (participant) {\r\n                conference.eventEmitter.emit(JitsiConferenceEvents.ENDPOINT_STATS_RECEIVED, participant, payload);\r\n            } else {\r\n                logger.warn(`Ignoring ENDPOINT_STATS_RECEIVED for a non-existant participant: ${from}`);\r\n            }\r\n        });\r\n\r\n    rtc.addListener(RTCEvents.LOCAL_UFRAG_CHANGED,\r\n        (tpc, ufrag) => {\r\n            if (!tpc.isP2P) {\r\n                Statistics.sendLog(\r\n                    JSON.stringify({\r\n                        id: 'local_ufrag',\r\n                        value: ufrag\r\n                    }));\r\n            }\r\n        });\r\n    rtc.addListener(RTCEvents.REMOTE_UFRAG_CHANGED,\r\n        (tpc, ufrag) => {\r\n            if (!tpc.isP2P) {\r\n                Statistics.sendLog(\r\n                    JSON.stringify({\r\n                        id: 'remote_ufrag',\r\n                        value: ufrag\r\n                    }));\r\n            }\r\n        });\r\n\r\n    rtc.addListener(RTCEvents.CREATE_ANSWER_FAILED,\r\n        (e, tpc) => {\r\n            conference.statistics.sendCreateAnswerFailed(e, tpc);\r\n            if (!tpc.isP2P) {\r\n                conference.eventEmitter.emit(JitsiConferenceEvents.CONFERENCE_FAILED,\r\n                    JitsiConferenceErrors.OFFER_ANSWER_FAILED, e);\r\n            }\r\n        });\r\n\r\n    rtc.addListener(RTCEvents.CREATE_OFFER_FAILED,\r\n        (e, tpc) => {\r\n            conference.statistics.sendCreateOfferFailed(e, tpc);\r\n            if (!tpc.isP2P) {\r\n                conference.eventEmitter.emit(JitsiConferenceEvents.CONFERENCE_FAILED,\r\n                    JitsiConferenceErrors.OFFER_ANSWER_FAILED, e);\r\n            }\r\n        });\r\n\r\n    rtc.addListener(RTCEvents.SET_LOCAL_DESCRIPTION_FAILED,\r\n        (e, tpc) => {\r\n            conference.statistics.sendSetLocalDescFailed(e, tpc);\r\n            if (!tpc.isP2P) {\r\n                conference.eventEmitter.emit(JitsiConferenceEvents.CONFERENCE_FAILED,\r\n                    JitsiConferenceErrors.OFFER_ANSWER_FAILED, e);\r\n            }\r\n        });\r\n\r\n    rtc.addListener(RTCEvents.SET_REMOTE_DESCRIPTION_FAILED,\r\n        (e, tpc) => {\r\n            conference.statistics.sendSetRemoteDescFailed(e, tpc);\r\n            if (!tpc.isP2P) {\r\n                conference.eventEmitter.emit(JitsiConferenceEvents.CONFERENCE_FAILED,\r\n                    JitsiConferenceErrors.OFFER_ANSWER_FAILED, e);\r\n            }\r\n        });\r\n\r\n    rtc.addListener(RTCEvents.LOCAL_TRACK_SSRC_UPDATED,\r\n        (track, ssrc) => {\r\n            // when starting screen sharing, the track is created and when\r\n            // we do set local description and we process the ssrc we\r\n            // will be notified for it and we will report it with the event\r\n            // for screen sharing\r\n            if (track.isVideoTrack() && track.videoType === VideoType.DESKTOP) {\r\n                conference.statistics.sendScreenSharingEvent(true, ssrc);\r\n            }\r\n        });\r\n};\r\n\r\n/**\r\n * Removes event listeners related to conference.xmpp\r\n */\r\nJitsiConferenceEventManager.prototype.removeXMPPListeners = function() {\r\n    const conference = this.conference;\r\n\r\n    Object.keys(this.xmppListeners).forEach(eventName => {\r\n        conference.xmpp.removeListener(\r\n            eventName,\r\n            this.xmppListeners[eventName]);\r\n    });\r\n    this.xmppListeners = {};\r\n};\r\n\r\n\r\n/**\r\n * Setups event listeners related to conference.xmpp\r\n */\r\nJitsiConferenceEventManager.prototype.setupXMPPListeners = function() {\r\n    const conference = this.conference;\r\n\r\n    this._addConferenceXMPPListener(\r\n        XMPPEvents.CALL_INCOMING,\r\n        conference.onIncomingCall.bind(conference));\r\n    this._addConferenceXMPPListener(\r\n        XMPPEvents.CALL_ACCEPTED,\r\n        conference.onCallAccepted.bind(conference));\r\n    this._addConferenceXMPPListener(\r\n        XMPPEvents.TRANSPORT_INFO,\r\n        conference.onTransportInfo.bind(conference));\r\n    this._addConferenceXMPPListener(\r\n        XMPPEvents.CALL_ENDED,\r\n        conference.onCallEnded.bind(conference));\r\n\r\n    this._addConferenceXMPPListener(XMPPEvents.START_MUTED_FROM_FOCUS,\r\n        (audioMuted, videoMuted) => {\r\n            if (conference.options.config.ignoreStartMuted) {\r\n                return;\r\n            }\r\n\r\n            conference.startAudioMuted = audioMuted;\r\n            conference.startVideoMuted = videoMuted;\r\n\r\n            // mute existing local tracks because this is initial mute from\r\n            // Jicofo\r\n            conference.getLocalTracks().forEach(track => {\r\n                switch (track.getType()) {\r\n                case MediaType.AUDIO:\r\n                    conference.startAudioMuted && track.mute();\r\n                    break;\r\n                case MediaType.VIDEO:\r\n                    conference.startVideoMuted && track.mute();\r\n                    break;\r\n                }\r\n            });\r\n\r\n            conference.eventEmitter.emit(JitsiConferenceEvents.STARTED_MUTED);\r\n        });\r\n\r\n    this._addConferenceXMPPListener(XMPPEvents.CONFERENCE_TIMESTAMP_RECEIVED,\r\n        createdTimestamp => {\r\n            conference.eventEmitter.emit(JitsiConferenceEvents.CONFERENCE_CREATED_TIMESTAMP, createdTimestamp);\r\n        });\r\n\r\n    this._addConferenceXMPPListener(XMPPEvents.AV_MODERATION_CHANGED,\r\n        (value, mediaType, actorJid) => {\r\n            const actorParticipant = conference.getParticipants().find(p => p.getJid() === actorJid);\r\n\r\n            conference.eventEmitter.emit(JitsiConferenceEvents.AV_MODERATION_CHANGED, {\r\n                enabled: value,\r\n                mediaType,\r\n                actor: actorParticipant\r\n            });\r\n        });\r\n    this._addConferenceXMPPListener(XMPPEvents.AV_MODERATION_PARTICIPANT_APPROVED,\r\n        (mediaType, jid) => {\r\n            const participant = conference.getParticipantById(Strophe.getResourceFromJid(jid));\r\n\r\n            if (participant) {\r\n                conference.eventEmitter.emit(JitsiConferenceEvents.AV_MODERATION_PARTICIPANT_APPROVED, {\r\n                    participant,\r\n                    mediaType\r\n                });\r\n            }\r\n        });\r\n    this._addConferenceXMPPListener(XMPPEvents.AV_MODERATION_APPROVED,\r\n        value => conference.eventEmitter.emit(JitsiConferenceEvents.AV_MODERATION_APPROVED, { mediaType: value }));\r\n};\r\n\r\n/**\r\n * Add XMPP listener and save its reference for remove on leave conference.\r\n */\r\nJitsiConferenceEventManager.prototype._addConferenceXMPPListener = function(\r\n        eventName, listener) {\r\n    this.xmppListeners[eventName] = listener;\r\n    this.conference.xmpp.addListener(eventName, listener);\r\n};\r\n\r\n/**\r\n * Setups event listeners related to conference.statistics\r\n */\r\nJitsiConferenceEventManager.prototype.setupStatisticsListeners = function() {\r\n    const conference = this.conference;\r\n\r\n    if (!conference.statistics) {\r\n        return;\r\n    }\r\n\r\n    /* eslint-disable max-params */\r\n    conference.statistics.addAudioLevelListener((tpc, ssrc, level, isLocal) => {\r\n        conference.rtc.setAudioLevel(tpc, ssrc, level, isLocal);\r\n    });\r\n\r\n    /* eslint-enable max-params */\r\n\r\n    // Forward the \"before stats disposed\" event\r\n    conference.statistics.addBeforeDisposedListener(() => {\r\n        conference.eventEmitter.emit(\r\n            JitsiConferenceEvents.BEFORE_STATISTICS_DISPOSED);\r\n    });\r\n\r\n    // if we are in startSilent mode we will not be sending/receiving so nothing to detect\r\n    if (!conference.options.config.startSilent) {\r\n        conference.statistics.addByteSentStatsListener((tpc, stats) => {\r\n            conference.getLocalTracks(MediaType.AUDIO).forEach(track => {\r\n                const ssrc = tpc.getLocalSSRC(track);\r\n\r\n                if (!ssrc || !stats.hasOwnProperty(ssrc)) {\r\n                    return;\r\n                }\r\n\r\n                track._onByteSentStatsReceived(tpc, stats[ssrc]);\r\n            });\r\n        });\r\n    }\r\n};\r\n","import { BrowserDetection } from '@jitsi/js-utils';\r\nimport { getLogger } from 'jitsi-meet-logger';\r\n\r\nconst logger = getLogger(__filename);\r\n\r\n/* Minimum required Chrome / Chromium version. This applies also to derivatives. */\r\nconst MIN_REQUIRED_CHROME_VERSION = 72;\r\n\r\n// TODO: Move this code to js-utils.\r\n\r\n// NOTE: Now we are extending BrowserDetection in order to preserve\r\n// RTCBrowserType interface but maybe it worth exporting BrowserCapabilities\r\n// and BrowserDetection as separate objects in future.\r\n\r\n/**\r\n * Implements browser capabilities for lib-jitsi-meet.\r\n */\r\nexport default class BrowserCapabilities extends BrowserDetection {\r\n    /**\r\n     * Creates new BrowserCapabilities instance.\r\n     */\r\n    constructor() {\r\n        super();\r\n        logger.info(\r\n            `This appears to be ${this.getName()}, ver: ${this.getVersion()}`);\r\n    }\r\n\r\n    /**\r\n     * Tells whether or not the <tt>MediaStream/tt> is removed from\r\n     * the <tt>PeerConnection</tt> and disposed on video mute (in order to turn\r\n     * off the camera device).\r\n     * @return {boolean} <tt>true</tt> if the current browser supports this\r\n     * strategy or <tt>false</tt> otherwise.\r\n     */\r\n    doesVideoMuteByStreamRemove() {\r\n        return this.isChromiumBased() || this.isWebKitBased();\r\n    }\r\n\r\n    /**\r\n     * Checks if the current browser is Chromium based, that is, it's either\r\n     * Chrome / Chromium or uses it as its engine, but doesn't identify as\r\n     * Chrome.\r\n     *\r\n     * This includes the following browsers:\r\n     * - Chrome and Chromium\r\n     * - Other browsers which use the Chrome engine, but are detected as Chrome,\r\n     *   such as Brave and Vivaldi\r\n     * - Browsers which are NOT Chrome but use it as their engine, and have\r\n     *   custom detection code: Opera, Electron and NW.JS\r\n     */\r\n    isChromiumBased() {\r\n        return this.isChrome()\r\n            || this.isElectron()\r\n            || this.isNWJS()\r\n            || this.isOpera();\r\n    }\r\n\r\n    /**\r\n     * Checks if the current browser is WebKit based. It's either\r\n     * Safari or uses WebKit as its engine.\r\n     *\r\n     * This includes Chrome and Firefox on iOS\r\n     *\r\n     * @returns {boolean}\r\n     */\r\n    isWebKitBased() {\r\n        // https://trac.webkit.org/changeset/236144/webkit/trunk/LayoutTests/webrtc/video-addLegacyTransceiver.html\r\n        return this._bowser.isEngine('webkit')\r\n            && typeof navigator.mediaDevices !== 'undefined'\r\n            && typeof navigator.mediaDevices.getUserMedia !== 'undefined'\r\n            && typeof window.RTCRtpTransceiver !== 'undefined'\r\n            // eslint-disable-next-line no-undef\r\n            && Object.keys(RTCRtpTransceiver.prototype).indexOf('currentDirection') > -1;\r\n    }\r\n\r\n    /**\r\n     * Checks whether current running context is a Trusted Web Application.\r\n     *\r\n     * @returns {boolean} Whether the current context is a TWA.\r\n     */\r\n    isTwa() {\r\n        return 'matchMedia' in window && window.matchMedia('(display-mode:standalone)').matches;\r\n    }\r\n\r\n    /**\r\n     * Checks if the current browser is supported.\r\n     *\r\n     * @returns {boolean} true if the browser is supported, false otherwise.\r\n     */\r\n    isSupported() {\r\n        return (this.isChromiumBased() && this._getChromiumBasedVersion() >= MIN_REQUIRED_CHROME_VERSION)\r\n            || this.isFirefox()\r\n            || this.isReactNative()\r\n            || this.isWebKitBased();\r\n    }\r\n\r\n    /**\r\n     * Returns whether or not the current environment needs a user interaction\r\n     * with the page before any unmute can occur.\r\n     *\r\n     * @returns {boolean}\r\n     */\r\n    isUserInteractionRequiredForUnmute() {\r\n        return this.isFirefox() && this.isVersionLessThan('68');\r\n    }\r\n\r\n    /**\r\n     * Checks if the current browser triggers 'onmute'/'onunmute' events when\r\n     * user's connection is interrupted and the video stops playback.\r\n     * @returns {*|boolean} 'true' if the event is supported or 'false'\r\n     * otherwise.\r\n     */\r\n    supportsVideoMuteOnConnInterrupted() {\r\n        return this.isChromiumBased() || this.isReactNative() || this.isWebKitBased();\r\n    }\r\n\r\n    /**\r\n     * Checks if the current browser reports upload and download bandwidth\r\n     * statistics.\r\n     * @return {boolean}\r\n     */\r\n    supportsBandwidthStatistics() {\r\n        // FIXME bandwidth stats are currently not implemented for FF on our\r\n        // side, but not sure if not possible ?\r\n        return !this.isFirefox() && !this.isWebKitBased();\r\n    }\r\n\r\n    /**\r\n     * Checks if the current browser supports setting codec preferences on the transceiver.\r\n     * @returns {boolean}\r\n     */\r\n    supportsCodecPreferences() {\r\n        return Boolean(window.RTCRtpTransceiver\r\n            && typeof window.RTCRtpTransceiver.setCodecPreferences !== 'undefined'\r\n            && window.RTCRtpReceiver\r\n            && typeof window.RTCRtpReceiver.getCapabilities !== 'undefined')\r\n\r\n            // this is not working on Safari because of the following bug\r\n            // https://bugs.webkit.org/show_bug.cgi?id=215567\r\n            && !this.isWebKitBased();\r\n    }\r\n\r\n    /**\r\n     * Checks if the current browser support the device change event.\r\n     * @return {boolean}\r\n     */\r\n    supportsDeviceChangeEvent() {\r\n        return navigator.mediaDevices\r\n            && typeof navigator.mediaDevices.ondevicechange !== 'undefined'\r\n            && typeof navigator.mediaDevices.addEventListener !== 'undefined';\r\n    }\r\n\r\n    /**\r\n     * Checks if the current browser supports RTT statistics for srflx local\r\n     * candidates through the legacy getStats() API.\r\n     */\r\n    supportsLocalCandidateRttStatistics() {\r\n        return this.isChromiumBased() || this.isReactNative() || this.isWebKitBased();\r\n    }\r\n\r\n    /**\r\n     * Checks if the current browser supports the Long Tasks API that lets us observe\r\n     * performance measurement events and be notified of tasks that take longer than\r\n     * 50ms to execute on the main thread.\r\n     */\r\n    supportsPerformanceObserver() {\r\n        return typeof window.PerformanceObserver !== 'undefined'\r\n            && PerformanceObserver.supportedEntryTypes.indexOf('longtask') > -1;\r\n    }\r\n\r\n    /**\r\n     * Checks if the current browser supports audio level stats on the receivers.\r\n     */\r\n    supportsReceiverStats() {\r\n        return typeof window.RTCRtpReceiver !== 'undefined'\r\n            && Object.keys(RTCRtpReceiver.prototype).indexOf('getSynchronizationSources') > -1\r\n\r\n            // Disable this on Safari because it is reporting 0.000001 as the audio levels for all\r\n            // remote audio tracks.\r\n            && !this.isWebKitBased();\r\n    }\r\n\r\n    /**\r\n     * Checks if the current browser reports round trip time statistics for\r\n     * the ICE candidate pair.\r\n     * @return {boolean}\r\n     */\r\n    supportsRTTStatistics() {\r\n        // Firefox does not seem to report RTT for ICE candidate pair:\r\n        // eslint-disable-next-line max-len\r\n        // https://www.w3.org/TR/webrtc-stats/#dom-rtcicecandidatepairstats-currentroundtriptime\r\n        // It does report mozRTT for RTP streams, but at the time of this\r\n        // writing it's value does not make sense most of the time\r\n        // (is reported as 1):\r\n        // https://bugzilla.mozilla.org/show_bug.cgi?id=1241066\r\n        // For Chrome and others we rely on 'googRtt'.\r\n        return !this.isFirefox();\r\n    }\r\n\r\n    /**\r\n     * Checks if the browser uses SDP munging for turning on simulcast.\r\n     *\r\n     * @returns {boolean}\r\n     */\r\n    usesSdpMungingForSimulcast() {\r\n        return this.isChromiumBased() || this.isReactNative() || this.isWebKitBased();\r\n    }\r\n\r\n    /**\r\n     * Checks if the browser uses webrtc-adapter. All browsers except React Native do.\r\n     *\r\n     * @returns {boolean}\r\n     */\r\n    usesAdapter() {\r\n        return !this.isReactNative();\r\n    }\r\n\r\n    /**\r\n     * Checks if the browser uses RIDs/MIDs for siganling the simulcast streams\r\n     * to the bridge instead of the ssrcs.\r\n     */\r\n    usesRidsForSimulcast() {\r\n        return false;\r\n    }\r\n\r\n    /**\r\n     * Checks if the browser supports getDisplayMedia.\r\n     * @returns {boolean} {@code true} if the browser supports getDisplayMedia.\r\n     */\r\n    supportsGetDisplayMedia() {\r\n        return typeof navigator.getDisplayMedia !== 'undefined'\r\n            || (typeof navigator.mediaDevices !== 'undefined'\r\n                && typeof navigator.mediaDevices.getDisplayMedia\r\n                    !== 'undefined');\r\n    }\r\n\r\n    /**\r\n     * Checks if the browser supports insertable streams, needed for E2EE.\r\n     * @returns {boolean} {@code true} if the browser supports insertable streams.\r\n     */\r\n    supportsInsertableStreams() {\r\n        if (!(typeof window.RTCRtpSender !== 'undefined'\r\n            && (window.RTCRtpSender.prototype.createEncodedStreams\r\n                || window.RTCRtpSender.prototype.createEncodedVideoStreams))) {\r\n            return false;\r\n        }\r\n\r\n        // Feature-detect transferable streams which we need to operate in a worker.\r\n        // See https://groups.google.com/a/chromium.org/g/blink-dev/c/1LStSgBt6AM/m/hj0odB8pCAAJ\r\n        const stream = new ReadableStream();\r\n\r\n        try {\r\n            window.postMessage(stream, '*', [ stream ]);\r\n\r\n            return true;\r\n        } catch {\r\n            return false;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Whether the browser supports the RED format for audio.\r\n     */\r\n    supportsAudioRed() {\r\n        return Boolean(window.RTCRtpSender\r\n            && window.RTCRtpSender.getCapabilities\r\n            && window.RTCRtpSender.getCapabilities('audio').codecs.some(codec => codec.mimeType === 'audio/red')\r\n            && window.RTCRtpReceiver\r\n            && window.RTCRtpReceiver.getCapabilities\r\n            && window.RTCRtpReceiver.getCapabilities('audio').codecs.some(codec => codec.mimeType === 'audio/red'));\r\n    }\r\n\r\n    /**\r\n     * Checks if the browser supports unified plan.\r\n     *\r\n     * @returns {boolean}\r\n     */\r\n    supportsUnifiedPlan() {\r\n        return !this.isReactNative();\r\n    }\r\n\r\n    /**\r\n     * Checks if the browser supports voice activity detection via the @type {VADAudioAnalyser} service.\r\n     *\r\n     * @returns {boolean}\r\n     */\r\n    supportsVADDetection() {\r\n        return this.isChromiumBased();\r\n    }\r\n\r\n    /**\r\n     * Returns the version of a Chromium based browser.\r\n     *\r\n     * @returns {Number}\r\n     */\r\n    _getChromiumBasedVersion() {\r\n        if (this.isChromiumBased()) {\r\n            // NW.JS doesn't expose the Chrome version in the UA string.\r\n            if (this.isNWJS()) {\r\n                // eslint-disable-next-line no-undef\r\n                return Number.parseInt(process.versions.chromium, 10);\r\n            }\r\n\r\n            // Here we process all browsers which use the Chrome engine but\r\n            // don't necessarily identify as Chrome. We cannot use the version\r\n            // comparing functions because the Electron, Opera and NW.JS\r\n            // versions are inconsequential here, as we need to know the actual\r\n            // Chrome engine version.\r\n            const ua = navigator.userAgent;\r\n\r\n            if (ua.match(/Chrome/)) {\r\n                const version\r\n                    = Number.parseInt(ua.match(/Chrome\\/([\\d.]+)/)[1], 10);\r\n\r\n                return version;\r\n            }\r\n        }\r\n\r\n        return -1;\r\n    }\r\n}\r\n","import { getLogger } from 'jitsi-meet-logger';\r\n\r\nimport {\r\n    TYPE_OPERATIONAL,\r\n    TYPE_PAGE,\r\n    TYPE_TRACK,\r\n    TYPE_UI\r\n} from '../../service/statistics/AnalyticsEvents';\r\nimport browser from '../browser';\r\n\r\nconst MAX_CACHE_SIZE = 100;\r\n\r\n// eslist-disable-line no-undef\r\nconst logger = getLogger(__filename);\r\n\r\n/**\r\n * This class provides an API to lib-jitsi-meet and its users for sending\r\n * analytics events. It serves as a bridge to different backend implementations\r\n * (\"analytics handlers\") and a cache for events attempted to be sent before\r\n * the analytics handlers were enabled.\r\n *\r\n * The API is designed to be an easy replacement for the previous version of\r\n * this adapter, and is meant to be extended with more convenience methods.\r\n *\r\n *\r\n * The API calls are translated to objects with the following structure, which\r\n * are then passed to the sendEvent(event) function of the underlying handlers:\r\n *\r\n * {\r\n *    type,\r\n *\r\n *    action,\r\n *    actionSubject,\r\n *    actionSubjectId,\r\n *    attributes,\r\n *    categories,\r\n *    containerId,\r\n *    containerType,\r\n *    name,\r\n *    objectId,\r\n *    objectType,\r\n *    source,\r\n *    tags\r\n * }\r\n *\r\n * The 'type' is one of 'operational', 'page', 'track' or 'ui', and some of the\r\n * other properties are considered required according to the type.\r\n *\r\n * For events with type 'page', the required properties are: name.\r\n *\r\n * For events with type 'operational' and 'ui', the required properties are:\r\n * action, actionSubject, source\r\n *\r\n * For events with type 'page', the required properties are:\r\n * action, actionSubject, source, containerType, containerId, objectType,\r\n * objectId\r\n */\r\nclass AnalyticsAdapter {\r\n    /**\r\n     * Creates new AnalyticsAdapter instance.\r\n     */\r\n    constructor() {\r\n        this.reset();\r\n    }\r\n\r\n    /**\r\n     * Reset the state to the initial one.\r\n     *\r\n     * @returns {void}\r\n     */\r\n    reset() {\r\n        /**\r\n         * Whether this AnalyticsAdapter has been disposed of or not. Once this\r\n         * is set to true, the AnalyticsAdapter is disabled and does not accept\r\n         * any more events, and it can not be re-enabled.\r\n         * @type {boolean}\r\n         */\r\n        this.disposed = false;\r\n\r\n        /**\r\n         * The set of handlers to which events will be sent.\r\n         * @type {Set<any>}\r\n         */\r\n        this.analyticsHandlers = new Set();\r\n\r\n        /**\r\n         * The cache of events which are not sent yet. The cache is enabled\r\n         * while this field is truthy, and disabled otherwise.\r\n         * @type {Array}\r\n         */\r\n        this.cache = [];\r\n\r\n        /**\r\n         * Map of properties that will be added to every event. Note that the\r\n         * keys will be prefixed with \"permanent.\".\r\n         */\r\n        this.permanentProperties = {};\r\n\r\n        /**\r\n         * The name of the conference that this AnalyticsAdapter is associated\r\n         * with.\r\n         * @type {null}\r\n         */\r\n        this.conferenceName = '';\r\n\r\n        this.addPermanentProperties({\r\n            'user_agent': navigator.userAgent,\r\n            'browser_name': browser.getName()\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Dispose analytics. Clears all handlers.\r\n     */\r\n    dispose() {\r\n        logger.warn('Disposing of analytics adapter.');\r\n\r\n        if (this.analyticsHandlers && this.analyticsHandlers.size > 0) {\r\n            this.analyticsHandlers.forEach(handler => {\r\n                if (typeof handler.dispose === 'function') {\r\n                    handler.dispose();\r\n                }\r\n            });\r\n        }\r\n\r\n        this.setAnalyticsHandlers([]);\r\n        this.disposed = true;\r\n    }\r\n\r\n    /**\r\n     * Sets the handlers that are going to be used to send analytics. Sends any\r\n     * cached events.\r\n     * @param {Array} handlers the handlers\r\n     */\r\n    setAnalyticsHandlers(handlers) {\r\n        if (this.disposed) {\r\n            return;\r\n        }\r\n\r\n        this.analyticsHandlers = new Set(handlers);\r\n\r\n        this._setUserProperties();\r\n\r\n        // Note that we disable the cache even if the set of handlers is empty.\r\n        const cache = this.cache;\r\n\r\n        this.cache = null;\r\n        if (cache) {\r\n            cache.forEach(event => this._sendEvent(event));\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Set the user properties to the analytics handlers.\r\n     *\r\n     * @returns {void}\r\n     */\r\n    _setUserProperties() {\r\n        this.analyticsHandlers.forEach(handler => {\r\n            try {\r\n                handler.setUserProperties(this.permanentProperties);\r\n            } catch (error) {\r\n                logger.warn('Error in setUserProperties method of one of the '\r\n                    + `analytics handlers: ${error}`);\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Adds a set of permanent properties to this this AnalyticsAdapter.\r\n     * Permanent properties will be added as \"attributes\" to events sent to\r\n     * the underlying \"analytics handlers\", and their keys will be prefixed\r\n     * by \"permanent_\", i.e. adding a permanent property {key: \"value\"} will\r\n     * result in {\"permanent_key\": \"value\"} object to be added to the\r\n     * \"attributes\" field of events.\r\n     *\r\n     * @param {Object} properties the properties to add\r\n     */\r\n    addPermanentProperties(properties) {\r\n        this.permanentProperties = {\r\n            ...this.permanentProperties,\r\n            ...properties\r\n        };\r\n\r\n        this._setUserProperties();\r\n    }\r\n\r\n    /**\r\n     * Sets the name of the conference that this AnalyticsAdapter is associated\r\n     * with.\r\n     * @param name the name to set.\r\n     */\r\n    setConferenceName(name) {\r\n        this.conferenceName = name;\r\n        this.addPermanentProperties({ 'conference_name': name });\r\n    }\r\n\r\n    /**\r\n     * Sends an event with a given name and given properties. The first\r\n     * parameter is either a string or an object. If it is a string, it is used\r\n     * as the event name and the second parameter is used at the attributes to\r\n     * attach to the event. If it is an object, it represents the whole event,\r\n     * including any desired attributes, and the second parameter is ignored.\r\n     *\r\n     * @param {String|Object} eventName either a string to be used as the name\r\n     * of the event, or an event object. If an event object is passed, the\r\n     * properties parameters is ignored.\r\n     * @param {Object} properties the properties/attributes to attach to the\r\n     * event, if eventName is a string.\r\n     */\r\n    sendEvent(eventName, properties = {}) {\r\n        if (this.disposed) {\r\n            return;\r\n        }\r\n\r\n        let event = null;\r\n\r\n        if (typeof eventName === 'string') {\r\n            event = {\r\n                type: TYPE_OPERATIONAL,\r\n                action: eventName,\r\n                actionSubject: eventName,\r\n                source: eventName,\r\n                attributes: properties\r\n            };\r\n        } else if (typeof eventName === 'object') {\r\n            event = eventName;\r\n        }\r\n\r\n        if (!this._verifyRequiredFields(event)) {\r\n            logger.error(\r\n                `Dropping a mis-formatted event: ${JSON.stringify(event)}`);\r\n\r\n            return;\r\n        }\r\n\r\n        this._sendEvent(event);\r\n    }\r\n\r\n    /**\r\n     * Checks whether an event has all of the required fields set, and tries\r\n     * to fill in some of the missing fields with reasonable default values.\r\n     * Returns true if after this operation the event has all of the required\r\n     * fields set, and false otherwise (if some of the required fields were not\r\n     * set and the attempt to fill them in with a default failed).\r\n     *\r\n     * @param event the event object.\r\n     * @return {boolean} true if the event (after the call to this function)\r\n     * contains all of the required fields, and false otherwise.\r\n     * @private\r\n     */\r\n    _verifyRequiredFields(event) {\r\n        if (!event) {\r\n            return false;\r\n        }\r\n\r\n        if (!event.type) {\r\n            event.type = TYPE_OPERATIONAL;\r\n        }\r\n\r\n        const type = event.type;\r\n\r\n        if (type !== TYPE_OPERATIONAL && type !== TYPE_PAGE\r\n            && type !== TYPE_UI && type !== TYPE_TRACK) {\r\n            logger.error(`Unknown event type: ${type}`);\r\n\r\n            return false;\r\n        }\r\n\r\n        if (type === TYPE_PAGE) {\r\n            return Boolean(event.name);\r\n        }\r\n\r\n        // Try to set some reasonable default values in case some of the\r\n        // parameters required by the handler API are missing.\r\n        event.action = event.action || event.name || event.actionSubject;\r\n        event.actionSubject = event.actionSubject || event.name || event.action;\r\n        event.source = event.source || event.name || event.action\r\n            || event.actionSubject;\r\n\r\n        if (!event.action || !event.actionSubject || !event.source) {\r\n            logger.error(\r\n                'Required field missing (action, actionSubject or source)');\r\n\r\n            return false;\r\n        }\r\n\r\n        // Track events have additional required fields.\r\n        if (type === TYPE_TRACK) {\r\n            event.objectType = event.objectType || 'generic-object-type';\r\n            event.containerType = event.containerType || 'conference';\r\n            if (event.containerType === 'conference' && !event.containerId) {\r\n                event.containerId = this.conferenceName;\r\n            }\r\n\r\n\r\n            if (!event.objectType || !event.objectId\r\n                || !event.containerType || !event.containerId) {\r\n                logger.error(\r\n                    'Required field missing (containerId, containerType, '\r\n                        + 'objectId or objectType)');\r\n\r\n                return false;\r\n            }\r\n        }\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Saves an event to the cache, if the cache is enabled.\r\n     * @param event the event to save.\r\n     * @returns {boolean} true if the event was saved, and false otherwise (i.e.\r\n     * if the cache was disabled).\r\n     * @private\r\n     */\r\n    _maybeCacheEvent(event) {\r\n        if (this.cache) {\r\n            this.cache.push(event);\r\n\r\n            // We limit the size of the cache, in case the user fails to ever\r\n            // set the analytics handlers.\r\n            if (this.cache.length > MAX_CACHE_SIZE) {\r\n                this.cache.splice(0, 1);\r\n            }\r\n\r\n            return true;\r\n        }\r\n\r\n        return false;\r\n\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param event\r\n     * @private\r\n     */\r\n    _sendEvent(event) {\r\n        if (this._maybeCacheEvent(event)) {\r\n            // The event was consumed by the cache.\r\n        } else {\r\n            this.analyticsHandlers.forEach(handler => {\r\n                try {\r\n                    handler.sendEvent(event);\r\n                } catch (e) {\r\n                    logger.warn(`Error sending analytics event: ${e}`);\r\n                }\r\n            });\r\n        }\r\n    }\r\n}\r\n\r\nexport default new AnalyticsAdapter();\r\n","\r\nimport { getLogger } from 'jitsi-meet-logger';\r\n\r\nimport * as StatisticsEvents from '../../service/statistics/Events';\r\nimport { RunningAverage } from '../util/MathUtil';\r\n\r\nconst logger = getLogger(__filename);\r\nconst MILLI_SECONDS = 1000;\r\nconst SECONDS = 60;\r\n\r\n/**\r\n * This class creates an observer that monitors browser's performance measurement events\r\n * as they are recorded in the browser's performance timeline and computes an average and\r\n * a maximum value for the long task events. Tasks are classified as long tasks if they take\r\n * longer than 50ms to execute on the main thread.\r\n */\r\nexport class PerformanceObserverStats {\r\n    /**\r\n     * Creates a new instance of Performance observer statistics.\r\n     *\r\n     * @param {*} emitter Event emitter for emitting stats periodically\r\n     * @param {*} statsInterval interval for calculating the stats\r\n     */\r\n    constructor(emitter, statsInterval) {\r\n        this.eventEmitter = emitter;\r\n        this.longTasks = 0;\r\n        this.maxDuration = 0;\r\n        this.performanceStatsInterval = statsInterval;\r\n        this.stats = new RunningAverage();\r\n    }\r\n\r\n    /**\r\n     * Obtains the average rate of long tasks observed per min and the\r\n     * duration of the longest task recorded by the observer.\r\n     * @returns {Object}\r\n     */\r\n    getLongTasksStats() {\r\n        return {\r\n            avgRatePerMinute: (this.stats.getAverage() * SECONDS).toFixed(2), // calc rate per min\r\n            maxDurationMs: this.maxDuration\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Starts the performance observer by registering the callback function\r\n     * that calculates the performance statistics periodically.\r\n     * @returns {void}\r\n     */\r\n    startObserver() {\r\n        // Create a handler for when the long task event is fired.\r\n        this.longTaskEventHandler = list => {\r\n            const entries = list.getEntries();\r\n\r\n            for (const task of entries) {\r\n                this.longTasks++;\r\n                this.maxDuration = Math.max(this.maxDuration, task.duration).toFixed(3);\r\n            }\r\n        };\r\n\r\n        // Create an observer for monitoring long tasks.\r\n        logger.info('Creating a Performance Observer for monitoring Long Tasks');\r\n        this.observer = new PerformanceObserver(this.longTaskEventHandler);\r\n        this.observer.observe({ type: 'longtask',\r\n            buffered: true });\r\n        const startTime = Date.now();\r\n\r\n        // Calculate the average # of events/sec and emit a stats event.\r\n        this.longTasksIntervalId = setInterval(() => {\r\n            const now = Date.now();\r\n            const interval = this._lastTimeStamp\r\n                ? (now - this._lastTimeStamp) / MILLI_SECONDS\r\n                : (now - startTime) / MILLI_SECONDS;\r\n            const rate = this.longTasks / interval;\r\n\r\n            this.stats.addNext(rate);\r\n            this.eventEmitter.emit(\r\n                StatisticsEvents.LONG_TASKS_STATS, this.getLongTasksStats());\r\n\r\n            // Reset the counter and start counting events again.\r\n            this.longTasks = 0;\r\n            this._lastTimeStamp = Date.now();\r\n        }, this.performanceStatsInterval);\r\n    }\r\n\r\n    /**\r\n     * Stops the performance observer.\r\n     * @returns {void}\r\n     */\r\n    stopObserver() {\r\n        this.observer && this.observer.disconnect();\r\n        this.longTaskEventHandler = null;\r\n        if (this.longTasksIntervalId) {\r\n            clearInterval(this.longTasksIntervalId);\r\n            this.longTasksIntervalId = null;\r\n        }\r\n    }\r\n}\r\n","import { getLogger } from 'jitsi-meet-logger';\r\n\r\nimport * as MediaType from '../../service/RTC/MediaType';\r\nimport * as StatisticsEvents from '../../service/statistics/Events';\r\nimport browser from '../browser';\r\n\r\nconst GlobalOnErrorHandler = require('../util/GlobalOnErrorHandler');\r\n\r\nconst logger = getLogger(__filename);\r\n\r\n/**\r\n * Calculates packet lost percent using the number of lost packets and the\r\n * number of all packet.\r\n * @param lostPackets the number of lost packets\r\n * @param totalPackets the number of all packets.\r\n * @returns {number} packet loss percent\r\n */\r\nfunction calculatePacketLoss(lostPackets, totalPackets) {\r\n    if (!totalPackets || totalPackets <= 0\r\n            || !lostPackets || lostPackets <= 0) {\r\n        return 0;\r\n    }\r\n\r\n    return Math.round((lostPackets / totalPackets) * 100);\r\n}\r\n\r\n/**\r\n * Holds \"statistics\" for a single SSRC.\r\n * @constructor\r\n */\r\nfunction SsrcStats() {\r\n    this.loss = {};\r\n    this.bitrate = {\r\n        download: 0,\r\n        upload: 0\r\n    };\r\n    this.resolution = {};\r\n    this.framerate = 0;\r\n    this.codec = '';\r\n}\r\n\r\n/**\r\n * Sets the \"loss\" object.\r\n * @param loss the value to set.\r\n */\r\nSsrcStats.prototype.setLoss = function(loss) {\r\n    this.loss = loss || {};\r\n};\r\n\r\n/**\r\n * Sets resolution that belong to the ssrc represented by this instance.\r\n * @param resolution new resolution value to be set.\r\n */\r\nSsrcStats.prototype.setResolution = function(resolution) {\r\n    this.resolution = resolution || {};\r\n};\r\n\r\n/**\r\n * Adds the \"download\" and \"upload\" fields from the \"bitrate\" parameter to\r\n * the respective fields of the \"bitrate\" field of this object.\r\n * @param bitrate an object holding the values to add.\r\n */\r\nSsrcStats.prototype.addBitrate = function(bitrate) {\r\n    this.bitrate.download += bitrate.download;\r\n    this.bitrate.upload += bitrate.upload;\r\n};\r\n\r\n/**\r\n * Resets the bit rate for given <tt>ssrc</tt> that belong to the peer\r\n * represented by this instance.\r\n */\r\nSsrcStats.prototype.resetBitrate = function() {\r\n    this.bitrate.download = 0;\r\n    this.bitrate.upload = 0;\r\n};\r\n\r\n/**\r\n * Sets the \"framerate\".\r\n * @param framerate the value to set.\r\n */\r\nSsrcStats.prototype.setFramerate = function(framerate) {\r\n    this.framerate = framerate || 0;\r\n};\r\n\r\nSsrcStats.prototype.setCodec = function(codec) {\r\n    this.codec = codec || '';\r\n};\r\n\r\n/**\r\n *\r\n */\r\nfunction ConferenceStats() {\r\n\r\n    /**\r\n     * The bandwidth\r\n     * @type {{}}\r\n     */\r\n    this.bandwidth = {};\r\n\r\n    /**\r\n     * The bit rate\r\n     * @type {{}}\r\n     */\r\n    this.bitrate = {};\r\n\r\n    /**\r\n     * The packet loss rate\r\n     * @type {{}}\r\n     */\r\n    this.packetLoss = null;\r\n\r\n    /**\r\n     * Array with the transport information.\r\n     * @type {Array}\r\n     */\r\n    this.transport = [];\r\n}\r\n\r\n/* eslint-disable max-params */\r\n\r\n/**\r\n * <tt>StatsCollector</tt> registers for stats updates of given\r\n * <tt>peerconnection</tt> in given <tt>interval</tt>. On each update particular\r\n * stats are extracted and put in {@link SsrcStats} objects. Once the processing\r\n * is done <tt>audioLevelsUpdateCallback</tt> is called with <tt>this</tt>\r\n * instance as an event source.\r\n *\r\n * @param peerconnection WebRTC PeerConnection object.\r\n * @param audioLevelsInterval\r\n * @param statsInterval stats refresh interval given in ms.\r\n * @param eventEmitter\r\n * @constructor\r\n */\r\nexport default function StatsCollector(peerconnection, audioLevelsInterval, statsInterval, eventEmitter) {\r\n    this.peerconnection = peerconnection;\r\n    this.baselineAudioLevelsReport = null;\r\n    this.currentAudioLevelsReport = null;\r\n    this.currentStatsReport = null;\r\n    this.previousStatsReport = null;\r\n    this.audioLevelReportHistory = {};\r\n    this.audioLevelsIntervalId = null;\r\n    this.eventEmitter = eventEmitter;\r\n    this.conferenceStats = new ConferenceStats();\r\n\r\n    // Updates stats interval\r\n    this.audioLevelsIntervalMilis = audioLevelsInterval;\r\n\r\n    this.speakerList = [];\r\n    this.statsIntervalId = null;\r\n    this.statsIntervalMilis = statsInterval;\r\n\r\n    /**\r\n     * Maps SSRC numbers to {@link SsrcStats}.\r\n     * @type {Map<number,SsrcStats}\r\n     */\r\n    this.ssrc2stats = new Map();\r\n}\r\n\r\n/**\r\n * Set the list of the remote speakers for which audio levels are to be calculated.\r\n *\r\n * @param {Array<string>} speakerList - Endpoint ids.\r\n * @returns {void}\r\n */\r\nStatsCollector.prototype.setSpeakerList = function(speakerList) {\r\n    this.speakerList = speakerList;\r\n};\r\n\r\n/**\r\n * Stops stats updates.\r\n */\r\nStatsCollector.prototype.stop = function() {\r\n    if (this.audioLevelsIntervalId) {\r\n        clearInterval(this.audioLevelsIntervalId);\r\n        this.audioLevelsIntervalId = null;\r\n    }\r\n\r\n    if (this.statsIntervalId) {\r\n        clearInterval(this.statsIntervalId);\r\n        this.statsIntervalId = null;\r\n    }\r\n};\r\n\r\n/**\r\n * Callback passed to <tt>getStats</tt> method.\r\n * @param error an error that occurred on <tt>getStats</tt> call.\r\n */\r\nStatsCollector.prototype.errorCallback = function(error) {\r\n    GlobalOnErrorHandler.callErrorHandler(error);\r\n    logger.error('Get stats error', error);\r\n    this.stop();\r\n};\r\n\r\n/**\r\n * Starts stats updates.\r\n */\r\nStatsCollector.prototype.start = function(startAudioLevelStats) {\r\n    if (startAudioLevelStats) {\r\n        if (browser.supportsReceiverStats()) {\r\n            logger.info('Using RTCRtpSynchronizationSource for remote audio levels');\r\n        }\r\n        this.audioLevelsIntervalId = setInterval(\r\n            () => {\r\n                if (browser.supportsReceiverStats()) {\r\n                    const audioLevels = this.peerconnection.getAudioLevels(this.speakerList);\r\n\r\n                    for (const ssrc in audioLevels) {\r\n                        if (audioLevels.hasOwnProperty(ssrc)) {\r\n                            // Use a scaling factor of 2.5 to report the same\r\n                            // audio levels that getStats reports.\r\n                            const audioLevel = audioLevels[ssrc] * 2.5;\r\n\r\n                            this.eventEmitter.emit(\r\n                                StatisticsEvents.AUDIO_LEVEL,\r\n                                this.peerconnection,\r\n                                Number.parseInt(ssrc, 10),\r\n                                audioLevel,\r\n                                false /* isLocal */);\r\n                        }\r\n                    }\r\n                } else {\r\n                    // Interval updates\r\n                    this.peerconnection.getStats()\r\n                        .then(report => {\r\n                            this.currentAudioLevelsReport = typeof report?.result === 'function'\r\n                                ? report.result()\r\n                                : report;\r\n                            this.processAudioLevelReport();\r\n                            this.baselineAudioLevelsReport = this.currentAudioLevelsReport;\r\n                        })\r\n                        .catch(error => this.errorCallback(error));\r\n                }\r\n            },\r\n            this.audioLevelsIntervalMilis\r\n        );\r\n    }\r\n\r\n    const processStats = () => {\r\n        // Interval updates\r\n        this.peerconnection.getStats()\r\n            .then(report => {\r\n                this.currentStatsReport = typeof report?.result === 'function'\r\n                    ? report.result()\r\n                    : report;\r\n\r\n                try {\r\n                    this.processStatsReport();\r\n                } catch (error) {\r\n                    GlobalOnErrorHandler.callErrorHandler(error);\r\n                    logger.error('Processing of RTP stats failed:', error);\r\n                }\r\n                this.previousStatsReport = this.currentStatsReport;\r\n            })\r\n            .catch(error => this.errorCallback(error));\r\n    };\r\n\r\n    processStats();\r\n    this.statsIntervalId = setInterval(processStats, this.statsIntervalMilis);\r\n};\r\n\r\n/**\r\n *\r\n */\r\nStatsCollector.prototype._processAndEmitReport = function() {\r\n    // process stats\r\n    const totalPackets = {\r\n        download: 0,\r\n        upload: 0\r\n    };\r\n    const lostPackets = {\r\n        download: 0,\r\n        upload: 0\r\n    };\r\n    let bitrateDownload = 0;\r\n    let bitrateUpload = 0;\r\n    const resolutions = {};\r\n    const framerates = {};\r\n    const codecs = {};\r\n    let audioBitrateDownload = 0;\r\n    let audioBitrateUpload = 0;\r\n    let audioCodec;\r\n    let videoBitrateDownload = 0;\r\n    let videoBitrateUpload = 0;\r\n    let videoCodec;\r\n\r\n    for (const [ ssrc, ssrcStats ] of this.ssrc2stats) {\r\n        // process packet loss stats\r\n        const loss = ssrcStats.loss;\r\n        const type = loss.isDownloadStream ? 'download' : 'upload';\r\n\r\n        totalPackets[type] += loss.packetsTotal;\r\n        lostPackets[type] += loss.packetsLost;\r\n\r\n        // process bitrate stats\r\n        bitrateDownload += ssrcStats.bitrate.download;\r\n        bitrateUpload += ssrcStats.bitrate.upload;\r\n\r\n        // collect resolutions and framerates\r\n        const track = this.peerconnection.getTrackBySSRC(ssrc);\r\n\r\n        if (track) {\r\n            if (track.isAudioTrack()) {\r\n                audioBitrateDownload += ssrcStats.bitrate.download;\r\n                audioBitrateUpload += ssrcStats.bitrate.upload;\r\n                audioCodec = ssrcStats.codec;\r\n            } else {\r\n                videoBitrateDownload += ssrcStats.bitrate.download;\r\n                videoBitrateUpload += ssrcStats.bitrate.upload;\r\n                videoCodec = ssrcStats.codec;\r\n            }\r\n\r\n            const participantId = track.getParticipantId();\r\n\r\n            if (participantId) {\r\n                const resolution = ssrcStats.resolution;\r\n\r\n                if (resolution.width\r\n                        && resolution.height\r\n                        && resolution.width !== -1\r\n                        && resolution.height !== -1) {\r\n                    const userResolutions = resolutions[participantId] || {};\r\n\r\n                    userResolutions[ssrc] = resolution;\r\n                    resolutions[participantId] = userResolutions;\r\n                }\r\n                if (ssrcStats.framerate !== 0) {\r\n                    const userFramerates = framerates[participantId] || {};\r\n\r\n                    userFramerates[ssrc] = ssrcStats.framerate;\r\n                    framerates[participantId] = userFramerates;\r\n                }\r\n                if (audioCodec && videoCodec) {\r\n                    const codecDesc = {\r\n                        'audio': audioCodec,\r\n                        'video': videoCodec\r\n                    };\r\n\r\n                    const userCodecs = codecs[participantId] || {};\r\n\r\n                    userCodecs[ssrc] = codecDesc;\r\n                    codecs[participantId] = userCodecs;\r\n                }\r\n            } else {\r\n                logger.error(`No participant ID returned by ${track}`);\r\n            }\r\n        }\r\n\r\n        ssrcStats.resetBitrate();\r\n    }\r\n\r\n    this.conferenceStats.bitrate = {\r\n        'upload': bitrateUpload,\r\n        'download': bitrateDownload\r\n    };\r\n\r\n    this.conferenceStats.bitrate.audio = {\r\n        'upload': audioBitrateUpload,\r\n        'download': audioBitrateDownload\r\n    };\r\n\r\n    this.conferenceStats.bitrate.video = {\r\n        'upload': videoBitrateUpload,\r\n        'download': videoBitrateDownload\r\n    };\r\n\r\n    this.conferenceStats.packetLoss = {\r\n        total:\r\n            calculatePacketLoss(\r\n                lostPackets.download + lostPackets.upload,\r\n                totalPackets.download + totalPackets.upload),\r\n        download:\r\n            calculatePacketLoss(lostPackets.download, totalPackets.download),\r\n        upload:\r\n            calculatePacketLoss(lostPackets.upload, totalPackets.upload)\r\n    };\r\n\r\n    const avgAudioLevels = {};\r\n    let localAvgAudioLevels;\r\n\r\n    Object.keys(this.audioLevelReportHistory).forEach(ssrc => {\r\n        const { data, isLocal } = this.audioLevelReportHistory[ssrc];\r\n        const avgAudioLevel = data.reduce((sum, currentValue) => sum + currentValue) / data.length;\r\n\r\n        if (isLocal) {\r\n            localAvgAudioLevels = avgAudioLevel;\r\n        } else {\r\n            const track = this.peerconnection.getTrackBySSRC(Number(ssrc));\r\n\r\n            if (track) {\r\n                const participantId = track.getParticipantId();\r\n\r\n                if (participantId) {\r\n                    avgAudioLevels[participantId] = avgAudioLevel;\r\n                }\r\n            }\r\n        }\r\n    });\r\n    this.audioLevelReportHistory = {};\r\n\r\n    this.eventEmitter.emit(\r\n        StatisticsEvents.CONNECTION_STATS,\r\n        this.peerconnection,\r\n        {\r\n            'bandwidth': this.conferenceStats.bandwidth,\r\n            'bitrate': this.conferenceStats.bitrate,\r\n            'packetLoss': this.conferenceStats.packetLoss,\r\n            'resolution': resolutions,\r\n            'framerate': framerates,\r\n            'codec': codecs,\r\n            'transport': this.conferenceStats.transport,\r\n            localAvgAudioLevels,\r\n            avgAudioLevels\r\n        });\r\n    this.conferenceStats.transport = [];\r\n};\r\n\r\n/**\r\n * Converts the value to a non-negative number.\r\n * If the value is either invalid or negative then 0 will be returned.\r\n * @param {*} v\r\n * @return {number}\r\n * @private\r\n */\r\nStatsCollector.prototype.getNonNegativeValue = function(v) {\r\n    let value = v;\r\n\r\n    if (typeof value !== 'number') {\r\n        value = Number(value);\r\n    }\r\n\r\n    if (isNaN(value)) {\r\n        return 0;\r\n    }\r\n\r\n    return Math.max(0, value);\r\n};\r\n\r\n/**\r\n * Calculates bitrate between before and now using a supplied field name and its\r\n * value in the stats.\r\n * @param {RTCInboundRtpStreamStats|RTCSentRtpStreamStats} now the current stats\r\n * @param {RTCInboundRtpStreamStats|RTCSentRtpStreamStats} before the\r\n * previous stats.\r\n * @param fieldName the field to use for calculations.\r\n * @return {number} the calculated bitrate between now and before.\r\n * @private\r\n */\r\nStatsCollector.prototype._calculateBitrate = function(now, before, fieldName) {\r\n    const bytesNow = this.getNonNegativeValue(now[fieldName]);\r\n    const bytesBefore = this.getNonNegativeValue(before[fieldName]);\r\n    const bytesProcessed = Math.max(0, bytesNow - bytesBefore);\r\n\r\n    const timeMs = now.timestamp - before.timestamp;\r\n    let bitrateKbps = 0;\r\n\r\n    if (timeMs > 0) {\r\n        // TODO is there any reason to round here?\r\n        bitrateKbps = Math.round((bytesProcessed * 8) / timeMs);\r\n    }\r\n\r\n    return bitrateKbps;\r\n};\r\n\r\n/**\r\n * Stats processing for spec-compliant RTCPeerConnection#getStats.\r\n */\r\nStatsCollector.prototype.processStatsReport = function() {\r\n    if (!this.previousStatsReport) {\r\n        return;\r\n    }\r\n    const byteSentStats = {};\r\n\r\n    this.currentStatsReport.forEach(now => {\r\n        // RTCIceCandidatePairStats - https://w3c.github.io/webrtc-stats/#candidatepair-dict*\r\n        if (now.type === 'candidate-pair' && now.nominated && now.state === 'succeeded') {\r\n            const availableIncomingBitrate = now.availableIncomingBitrate;\r\n            const availableOutgoingBitrate = now.availableOutgoingBitrate;\r\n\r\n            if (availableIncomingBitrate || availableOutgoingBitrate) {\r\n                this.conferenceStats.bandwidth = {\r\n                    'download': Math.round(availableIncomingBitrate / 1000),\r\n                    'upload': Math.round(availableOutgoingBitrate / 1000)\r\n                };\r\n            }\r\n\r\n            const remoteUsedCandidate = this.currentStatsReport.get(now.remoteCandidateId);\r\n            const localUsedCandidate = this.currentStatsReport.get(now.localCandidateId);\r\n\r\n            // RTCIceCandidateStats\r\n            // https://w3c.github.io/webrtc-stats/#icecandidate-dict*\r\n            if (remoteUsedCandidate && localUsedCandidate) {\r\n                const remoteIpAddress = browser.isChromiumBased()\r\n                    ? remoteUsedCandidate.ip\r\n                    : remoteUsedCandidate.address;\r\n                const remotePort = remoteUsedCandidate.port;\r\n                const ip = `${remoteIpAddress}:${remotePort}`;\r\n\r\n                const localIpAddress = browser.isChromiumBased()\r\n                    ? localUsedCandidate.ip\r\n                    : localUsedCandidate.address;\r\n                const localPort = localUsedCandidate.port;\r\n                const localip = `${localIpAddress}:${localPort}`;\r\n                const type = remoteUsedCandidate.protocol;\r\n\r\n                // Save the address unless it has been saved already.\r\n                const conferenceStatsTransport = this.conferenceStats.transport;\r\n\r\n                if (!conferenceStatsTransport.some(t =>\r\n                    t.ip === ip\r\n                    && t.type === type\r\n                    && t.localip === localip)) {\r\n                    conferenceStatsTransport.push({\r\n                        ip,\r\n                        type,\r\n                        localip,\r\n                        p2p: this.peerconnection.isP2P,\r\n                        localCandidateType: localUsedCandidate.candidateType,\r\n                        remoteCandidateType: remoteUsedCandidate.candidateType,\r\n                        networkType: localUsedCandidate.networkType,\r\n                        rtt: now.currentRoundTripTime * 1000\r\n                    });\r\n                }\r\n            }\r\n\r\n        // RTCReceivedRtpStreamStats\r\n        // https://w3c.github.io/webrtc-stats/#receivedrtpstats-dict*\r\n        // RTCSentRtpStreamStats\r\n        // https://w3c.github.io/webrtc-stats/#sentrtpstats-dict*\r\n        } else if (now.type === 'inbound-rtp' || now.type === 'outbound-rtp') {\r\n            const before = this.previousStatsReport.get(now.id);\r\n            const ssrc = this.getNonNegativeValue(now.ssrc);\r\n\r\n            if (!before || !ssrc) {\r\n                return;\r\n            }\r\n\r\n            let ssrcStats = this.ssrc2stats.get(ssrc);\r\n\r\n            if (!ssrcStats) {\r\n                ssrcStats = new SsrcStats();\r\n                this.ssrc2stats.set(ssrc, ssrcStats);\r\n            }\r\n\r\n            let isDownloadStream = true;\r\n            let key = 'packetsReceived';\r\n\r\n            if (now.type === 'outbound-rtp') {\r\n                isDownloadStream = false;\r\n                key = 'packetsSent';\r\n            }\r\n\r\n            let packetsNow = now[key];\r\n\r\n            if (!packetsNow || packetsNow < 0) {\r\n                packetsNow = 0;\r\n            }\r\n\r\n            const packetsBefore = this.getNonNegativeValue(before[key]);\r\n            const packetsDiff = Math.max(0, packetsNow - packetsBefore);\r\n\r\n            const packetsLostNow = this.getNonNegativeValue(now.packetsLost);\r\n            const packetsLostBefore = this.getNonNegativeValue(before.packetsLost);\r\n            const packetsLostDiff = Math.max(0, packetsLostNow - packetsLostBefore);\r\n\r\n            ssrcStats.setLoss({\r\n                packetsTotal: packetsDiff + packetsLostDiff,\r\n                packetsLost: packetsLostDiff,\r\n                isDownloadStream\r\n            });\r\n\r\n            // Get the resolution and framerate for only remote video sources here. For the local video sources,\r\n            // 'track' stats will be used since they have the updated resolution based on the simulcast streams\r\n            // currently being sent. Promise based getStats reports three 'outbound-rtp' streams and there will be\r\n            // more calculations needed to determine what is the highest resolution stream sent by the client if the\r\n            // 'outbound-rtp' stats are used.\r\n            if (now.type === 'inbound-rtp') {\r\n                const resolution = {\r\n                    height: now.frameHeight,\r\n                    width: now.frameWidth\r\n                };\r\n                const frameRate = now.framesPerSecond;\r\n\r\n                if (resolution.height && resolution.width) {\r\n                    ssrcStats.setResolution(resolution);\r\n                }\r\n                ssrcStats.setFramerate(Math.round(frameRate || 0));\r\n\r\n                ssrcStats.addBitrate({\r\n                    'download': this._calculateBitrate(now, before, 'bytesReceived'),\r\n                    'upload': 0\r\n                });\r\n            } else {\r\n                byteSentStats[ssrc] = this.getNonNegativeValue(now.bytesSent);\r\n                ssrcStats.addBitrate({\r\n                    'download': 0,\r\n                    'upload': this._calculateBitrate(now, before, 'bytesSent')\r\n                });\r\n            }\r\n\r\n            const codec = this.currentStatsReport.get(now.codecId);\r\n\r\n            if (codec) {\r\n                /**\r\n                 * The mime type has the following form: video/VP8 or audio/ISAC,\r\n                 * so we what to keep just the type after the '/', audio and video\r\n                 * keys will be added on the processing side.\r\n                 */\r\n                const codecShortType = codec.mimeType.split('/')[1];\r\n\r\n                codecShortType && ssrcStats.setCodec(codecShortType);\r\n            }\r\n\r\n        // Use track stats for resolution and framerate of the local video source.\r\n        // RTCVideoHandlerStats - https://w3c.github.io/webrtc-stats/#vststats-dict*\r\n        // RTCMediaHandlerStats - https://w3c.github.io/webrtc-stats/#mststats-dict*\r\n        } else if (now.type === 'track' && now.kind === MediaType.VIDEO && !now.remoteSource) {\r\n            const resolution = {\r\n                height: now.frameHeight,\r\n                width: now.frameWidth\r\n            };\r\n            const localVideoTracks = this.peerconnection.getLocalTracks(MediaType.VIDEO);\r\n\r\n            if (!localVideoTracks?.length) {\r\n                return;\r\n            }\r\n\r\n            const ssrc = this.peerconnection.getLocalSSRC(localVideoTracks[0]);\r\n\r\n            if (!ssrc) {\r\n                return;\r\n            }\r\n            let ssrcStats = this.ssrc2stats.get(ssrc);\r\n\r\n            if (!ssrcStats) {\r\n                ssrcStats = new SsrcStats();\r\n                this.ssrc2stats.set(ssrc, ssrcStats);\r\n            }\r\n            if (resolution.height && resolution.width) {\r\n                ssrcStats.setResolution(resolution);\r\n            }\r\n\r\n            // Calculate the frame rate. 'framesSent' is the total aggregate value for all the simulcast streams.\r\n            // Therefore, it needs to be divided by the total number of active simulcast streams.\r\n            let frameRate = now.framesPerSecond;\r\n\r\n            if (!frameRate) {\r\n                const before = this.previousStatsReport.get(now.id);\r\n\r\n                if (before) {\r\n                    const timeMs = now.timestamp - before.timestamp;\r\n\r\n                    if (timeMs > 0 && now.framesSent) {\r\n                        const numberOfFramesSinceBefore = now.framesSent - before.framesSent;\r\n\r\n                        frameRate = (numberOfFramesSinceBefore / timeMs) * 1000;\r\n                    }\r\n                }\r\n\r\n                if (!frameRate) {\r\n                    return;\r\n                }\r\n            }\r\n\r\n            // Get the number of simulcast streams currently enabled from TPC.\r\n            const numberOfActiveStreams = this.peerconnection.getActiveSimulcastStreams();\r\n\r\n            // Reset frame rate to 0 when video is suspended as a result of endpoint falling out of last-n.\r\n            frameRate = numberOfActiveStreams ? Math.round(frameRate / numberOfActiveStreams) : 0;\r\n            ssrcStats.setFramerate(frameRate);\r\n        }\r\n    });\r\n\r\n    this.eventEmitter.emit(StatisticsEvents.BYTE_SENT_STATS, this.peerconnection, byteSentStats);\r\n    this._processAndEmitReport();\r\n};\r\n\r\n/**\r\n * Stats processing logic.\r\n */\r\nStatsCollector.prototype.processAudioLevelReport = function() {\r\n    if (!this.baselineAudioLevelsReport) {\r\n        return;\r\n    }\r\n\r\n    this.currentAudioLevelsReport.forEach(now => {\r\n        if (now.type !== 'track') {\r\n            return;\r\n        }\r\n\r\n        // Audio level\r\n        const audioLevel = now.audioLevel;\r\n\r\n        if (!audioLevel) {\r\n            return;\r\n        }\r\n\r\n        const trackIdentifier = now.trackIdentifier;\r\n        const ssrc = this.peerconnection.getSsrcByTrackId(trackIdentifier);\r\n\r\n        if (ssrc) {\r\n            const isLocal\r\n                = ssrc === this.peerconnection.getLocalSSRC(\r\n                this.peerconnection.getLocalTracks(MediaType.AUDIO));\r\n\r\n            this.eventEmitter.emit(\r\n                StatisticsEvents.AUDIO_LEVEL,\r\n                this.peerconnection,\r\n                ssrc,\r\n                audioLevel,\r\n                isLocal);\r\n        }\r\n    });\r\n};\r\n\r\n","/**\r\n * Implements utility to forward events from one eventEmitter to another.\r\n * @param src {object} instance of EventEmitter or another class that implements\r\n * addListener method which will register listener to EventEmitter instance.\r\n * @param dest {object} instance of EventEmitter or another class that\r\n * implements emit method which will emit an event.\r\n */\r\nfunction EventEmitterForwarder(src, dest) {\r\n    if (!src || !dest || typeof src.addListener !== 'function'\r\n        || typeof dest.emit !== 'function') {\r\n        throw new Error('Invalid arguments passed to EventEmitterForwarder');\r\n    }\r\n    this.src = src;\r\n    this.dest = dest;\r\n}\r\n\r\n/**\r\n * Adds event to be forwarded from src to dest.\r\n * @param srcEvent {string} the event that EventEmitterForwarder is listening\r\n * for.\r\n * @param dstEvent {string} the event that will be fired from dest.\r\n * @param arguments all other passed arguments are going to be fired with\r\n * dstEvent.\r\n */\r\nEventEmitterForwarder.prototype.forward = function(...args) {\r\n    const srcEvent = args[0];\r\n\r\n    // This will be the \"this\" value for emit function.\r\n\r\n    args[0] = this.dest;\r\n\r\n    // Using bind.apply to pass the arguments as Array-like object (\"arguments\")\r\n    this.src.addListener(\r\n        srcEvent,\r\n        Function.prototype.bind.apply(this.dest.emit, args));\r\n};\r\n\r\nmodule.exports = EventEmitterForwarder;\r\n","\r\nimport { Strophe } from 'strophe.js';\r\n\r\n\r\nimport * as JitsiConferenceEvents from './JitsiConferenceEvents';\r\nimport { ParticipantConnectionStatus }\r\n    from './modules/connectivity/ParticipantConnectionStatus';\r\nimport * as MediaType from './service/RTC/MediaType';\r\n\r\n/**\r\n * Represents a participant in (i.e. a member of) a conference.\r\n */\r\nexport default class JitsiParticipant {\r\n\r\n    /* eslint-disable max-params */\r\n\r\n    /**\r\n     * Initializes a new JitsiParticipant instance.\r\n     *\r\n     * @constructor\r\n     * @param jid the conference XMPP jid\r\n     * @param conference\r\n     * @param displayName\r\n     * @param {Boolean} hidden - True if the new JitsiParticipant instance is to\r\n     * represent a hidden participant; otherwise, false.\r\n     * @param {string} statsID - optional participant statsID\r\n     * @param {string} status - the initial status if any.\r\n     * @param {object} identity - the xmpp identity\r\n     */\r\n    constructor(jid, conference, displayName, hidden, statsID, status, identity) {\r\n        this._jid = jid;\r\n        this._id = Strophe.getResourceFromJid(jid);\r\n        this._conference = conference;\r\n        this._displayName = displayName;\r\n        this._supportsDTMF = false;\r\n        this._tracks = [];\r\n        this._role = 'none';\r\n        this._status = status;\r\n        this._hidden = hidden;\r\n        this._statsID = statsID;\r\n        this._connectionStatus = ParticipantConnectionStatus.ACTIVE;\r\n        this._properties = {};\r\n        this._identity = identity;\r\n        this._features = new Set();\r\n    }\r\n\r\n    /* eslint-enable max-params */\r\n\r\n    /**\r\n     * @returns {JitsiConference} The conference that this participant belongs\r\n     * to.\r\n     */\r\n    getConference() {\r\n        return this._conference;\r\n    }\r\n\r\n    /**\r\n     * Gets the value of a property of this participant.\r\n     */\r\n    getProperty(name) {\r\n        return this._properties[name];\r\n    }\r\n\r\n    /**\r\n     * Checks whether this <tt>JitsiParticipant</tt> has any video tracks which\r\n     * are muted according to their underlying WebRTC <tt>MediaStreamTrack</tt>\r\n     * muted status.\r\n     * @return {boolean} <tt>true</tt> if this <tt>participant</tt> contains any\r\n     * video <tt>JitsiTrack</tt>s which are muted as defined in\r\n     * {@link JitsiTrack.isWebRTCTrackMuted}.\r\n     */\r\n    hasAnyVideoTrackWebRTCMuted() {\r\n        return (\r\n            this.getTracks().some(\r\n                jitsiTrack =>\r\n                    jitsiTrack.getType() === MediaType.VIDEO\r\n                        && jitsiTrack.isWebRTCTrackMuted()));\r\n    }\r\n\r\n    /**\r\n     * Updates participant's connection status.\r\n     * @param {string} state the current participant connection state.\r\n     * {@link ParticipantConnectionStatus}.\r\n     * @private\r\n     */\r\n    _setConnectionStatus(status) {\r\n        this._connectionStatus = status;\r\n    }\r\n\r\n    /**\r\n     * Return participant's connectivity status.\r\n     *\r\n     * @returns {string} the connection status\r\n     * <tt>ParticipantConnectionStatus</tt> of the user.\r\n     * {@link ParticipantConnectionStatus}.\r\n     */\r\n    getConnectionStatus() {\r\n        return this._connectionStatus;\r\n    }\r\n\r\n    /**\r\n     * Sets the value of a property of this participant, and fires an event if\r\n     * the value has changed.\r\n     * @name the name of the property.\r\n     * @value the value to set.\r\n     */\r\n    setProperty(name, value) {\r\n        const oldValue = this._properties[name];\r\n\r\n        if (value !== oldValue) {\r\n            this._properties[name] = value;\r\n            this._conference.eventEmitter.emit(\r\n                JitsiConferenceEvents.PARTICIPANT_PROPERTY_CHANGED,\r\n                this,\r\n                name,\r\n                oldValue,\r\n                value);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * @returns {Array.<JitsiTrack>} The list of media tracks for this\r\n     * participant.\r\n     */\r\n    getTracks() {\r\n        return this._tracks.slice();\r\n    }\r\n\r\n    /**\r\n     * @param {MediaType} mediaType\r\n     * @returns {Array.<JitsiTrack>} an array of media tracks for this\r\n     * participant, for given media type.\r\n     */\r\n    getTracksByMediaType(mediaType) {\r\n        return this.getTracks().filter(track => track.getType() === mediaType);\r\n    }\r\n\r\n    /**\r\n     * @returns {String} The ID of this participant.\r\n     */\r\n    getId() {\r\n        return this._id;\r\n    }\r\n\r\n    /**\r\n     * @returns {String} The JID of this participant.\r\n     */\r\n    getJid() {\r\n        return this._jid;\r\n    }\r\n\r\n    /**\r\n     * @returns {String} The human-readable display name of this participant.\r\n     */\r\n    getDisplayName() {\r\n        return this._displayName;\r\n    }\r\n\r\n    /**\r\n     * @returns {String} The stats ID of this participant.\r\n     */\r\n    getStatsID() {\r\n        return this._statsID;\r\n    }\r\n\r\n    /**\r\n     * @returns {String} The status of the participant.\r\n     */\r\n    getStatus() {\r\n        return this._status;\r\n    }\r\n\r\n    /**\r\n     * @returns {Boolean} Whether this participant is a moderator or not.\r\n     */\r\n    isModerator() {\r\n        return this._role === 'moderator';\r\n    }\r\n\r\n    /**\r\n     * @returns {Boolean} Whether this participant is a hidden participant. Some\r\n     * special system participants may want to join hidden (like for example the\r\n     * recorder).\r\n     */\r\n    isHidden() {\r\n        return this._hidden;\r\n    }\r\n\r\n    /**\r\n     * @returns {Boolean} Whether this participant has muted their audio.\r\n     */\r\n    isAudioMuted() {\r\n        return this._isMediaTypeMuted(MediaType.AUDIO);\r\n    }\r\n\r\n    /**\r\n     * Determines whether all JitsiTracks which are of a specific MediaType and\r\n     * which belong to this JitsiParticipant are muted.\r\n     *\r\n     * @param {MediaType} mediaType - The MediaType of the JitsiTracks to be\r\n     * checked.\r\n     * @private\r\n     * @returns {Boolean} True if all JitsiTracks which are of the specified\r\n     * mediaType and which belong to this JitsiParticipant are muted; otherwise,\r\n     * false.\r\n     */\r\n    _isMediaTypeMuted(mediaType) {\r\n        return this.getTracks().reduce(\r\n            (muted, track) =>\r\n                muted && (track.getType() !== mediaType || track.isMuted()),\r\n            true);\r\n    }\r\n\r\n    /**\r\n     * @returns {Boolean} Whether this participant has muted their video.\r\n     */\r\n    isVideoMuted() {\r\n        return this._isMediaTypeMuted(MediaType.VIDEO);\r\n    }\r\n\r\n    /**\r\n     * @returns {String} The role of this participant.\r\n     */\r\n    getRole() {\r\n        return this._role;\r\n    }\r\n\r\n    /**\r\n     * Sets a new participant role.\r\n     * @param {String} newRole - the new role.\r\n     */\r\n    setRole(newRole) {\r\n        this._role = newRole;\r\n    }\r\n\r\n    /**\r\n     *\r\n     */\r\n    supportsDTMF() {\r\n        return this._supportsDTMF;\r\n    }\r\n\r\n    /**\r\n     * Returns a set with the features for the participant.\r\n     * @returns {Promise<Set<String>, Error>}\r\n     */\r\n    getFeatures() {\r\n        return Promise.resolve(this._features);\r\n    }\r\n\r\n    /**\r\n     * Checks current set features.\r\n     * @param {String} feature - the feature to check.\r\n     * @return {boolean} <tt>true</tt> if this <tt>participant</tt> contains the\r\n     * <tt>feature</tt>.\r\n     */\r\n    hasFeature(feature) {\r\n        return this._features.has(feature);\r\n    }\r\n\r\n    /**\r\n     * Set new features.\r\n     * @param {Set<String>|undefined} newFeatures - Sets new features.\r\n     */\r\n    setFeatures(newFeatures) {\r\n        this._features = newFeatures || new Set();\r\n    }\r\n\r\n    /**\r\n     * Returns the bot type for the participant.\r\n     *\r\n     * @returns {string|undefined} - The bot type of the participant.\r\n     */\r\n    getBotType() {\r\n        return this._botType;\r\n    }\r\n\r\n    /**\r\n     * Sets the bot type for the participant.\r\n     * @param {String} newBotType - The new bot type to set.\r\n     */\r\n    setBotType(newBotType) {\r\n        this._botType = newBotType;\r\n    }\r\n}\r\n","import {\r\n    CONNECTION_DISCONNECTED,\r\n    CONNECTION_ESTABLISHED,\r\n    CONNECTION_FAILED\r\n} from './JitsiConnectionEvents';\r\nimport XMPP from './modules/xmpp/xmpp';\r\n\r\n/**\r\n * @typedef {Object} UpgradeRoleError\r\n *\r\n * @property {JitsiConnectionErrors} [connectionError] - One of\r\n * {@link JitsiConnectionErrors} which occurred when trying to connect to the\r\n * XMPP server.\r\n * @property {String} [authenticationError] - One of XMPP error conditions\r\n * returned by Jicofo on authentication attempt. See\r\n * {@link https://xmpp.org/rfcs/rfc3920.html#streams-error}.\r\n * @property {String} [message] - More details about the error.\r\n * @property {Object} [credentials] - The credentials that failed the\r\n * authentication.\r\n * @property {String} [credentials.jid] - The XMPP ID part of the credentials\r\n * that failed the authentication.\r\n * @property {string} [credentials.password] - The password part of the\r\n * credentials that failed the authentication.\r\n *\r\n * NOTE If neither one of the errors is present, then the operation has been\r\n * canceled.\r\n */\r\n\r\n/* eslint-disable no-invalid-this */\r\n\r\n/**\r\n * Connects to the XMPP server using the specified credentials and contacts\r\n * Jicofo in order to obtain a session ID (which is then stored in the local\r\n * storage). The user's role of the parent conference will be upgraded to\r\n * moderator (by Jicofo). It's also used to join the conference when starting\r\n * from anonymous domain and only authenticated users are allowed to create new\r\n * rooms.\r\n *\r\n * @param {Object} options\r\n * @param {string} options.id - XMPP user's ID to log in. For example,\r\n * user@xmpp-server.com.\r\n * @param {string} options.password - XMPP user's password to log in with.\r\n * @param {string} [options.roomPassword] - The password to join the MUC with.\r\n * @param {Function} [options.onLoginSuccessful] - Callback called when logging\r\n * into the XMPP server was successful. The next step will be to obtain a new\r\n * session ID from Jicofo and join the MUC using it which will effectively\r\n * upgrade the user's role to moderator.\r\n * @returns {Object} A <tt>thenable</tt> which (1) settles when the process of\r\n * authenticating and upgrading the role of the specified XMPP user finishes and\r\n * (2) has a <tt>cancel</tt> method that allows the caller to interrupt the\r\n * process. If the process finishes successfully, the session ID has been stored\r\n * in the settings and the <tt>thenable</tt> is resolved. If the process\r\n * finishes with failure, the <tt>thenable</tt> is rejected with reason of type\r\n * {@link UpgradeRoleError} which will have either <tt>connectionError</tt> or\r\n * <tt>authenticationError</tt> property set depending on which of the steps has\r\n * failed. If <tt>cancel</tt> is called before the process finishes, then the\r\n * thenable will be rejected with an empty object (i.e. no error property will\r\n * be set on the rejection reason).\r\n */\r\nexport default function authenticateAndUpgradeRole({\r\n    // 1. Log the specified XMPP user in.\r\n    id,\r\n    password,\r\n    onCreateResource,\r\n\r\n    // 2. Let the API client/consumer know as soon as the XMPP user has been\r\n    //    successfully logged in.\r\n    onLoginSuccessful,\r\n\r\n    // 3. Join the MUC.\r\n    roomPassword\r\n}) {\r\n    let canceled = false;\r\n    let rejectPromise;\r\n    let xmpp = new XMPP(this.connection.options);\r\n\r\n    const process = new Promise((resolve, reject) => {\r\n        // The process is represented by a Thenable with a cancel method. The\r\n        // Thenable is implemented using Promise and the cancel using the\r\n        // Promise's reject function.\r\n        rejectPromise = reject;\r\n\r\n\r\n        xmpp.addListener(\r\n            CONNECTION_DISCONNECTED,\r\n            () => {\r\n                xmpp = undefined;\r\n            });\r\n        xmpp.addListener(\r\n            CONNECTION_ESTABLISHED,\r\n            () => {\r\n                if (canceled) {\r\n                    return;\r\n                }\r\n\r\n                // Let the caller know that the XMPP login was successful.\r\n                onLoginSuccessful && onLoginSuccessful();\r\n\r\n                // Now authenticate with Jicofo and get a new session ID.\r\n                const room = xmpp.createRoom(\r\n                    this.options.name,\r\n                    this.options.config,\r\n                    onCreateResource\r\n                );\r\n\r\n                room.moderator.authenticate()\r\n                    .then(() => {\r\n                        xmpp && xmpp.disconnect();\r\n\r\n                        if (canceled) {\r\n                            return;\r\n                        }\r\n\r\n                        // At this point we should have the new session ID\r\n                        // stored in the settings. Jicofo will allow to join the\r\n                        // room.\r\n                        this.join(roomPassword);\r\n\r\n                        resolve();\r\n                    })\r\n                    .catch(({ error, message }) => {\r\n                        xmpp.disconnect();\r\n\r\n                        reject({\r\n                            authenticationError: error,\r\n                            message\r\n                        });\r\n                    });\r\n            });\r\n        xmpp.addListener(\r\n            CONNECTION_FAILED,\r\n            (connectionError, message, credentials) => {\r\n                reject({\r\n                    connectionError,\r\n                    credentials,\r\n                    message\r\n                });\r\n                xmpp = undefined;\r\n            });\r\n\r\n        canceled || xmpp.connect(id, password);\r\n    });\r\n\r\n    /**\r\n     * Cancels the process, if it's in progress, of authenticating and upgrading\r\n     * the role of the local participant/user.\r\n     *\r\n     * @public\r\n     * @returns {void}\r\n     */\r\n    process.cancel = () => {\r\n        canceled = true;\r\n        rejectPromise({});\r\n        xmpp && xmpp.disconnect();\r\n    };\r\n\r\n    return process;\r\n}\r\n\r\n/* eslint-enable no-invalid-this */\r\n","/* global __filename */\r\n\r\nimport { getLogger } from 'jitsi-meet-logger';\r\n\r\nconst logger = getLogger(__filename);\r\n\r\n// Flag to set on senders / receivers to avoid setting up the encryption transform\r\n// more than once.\r\nconst kJitsiE2EE = Symbol('kJitsiE2EE');\r\n\r\n/**\r\n * Context encapsulating the cryptography bits required for E2EE.\r\n * This uses the WebRTC Insertable Streams API which is explained in\r\n *   https://github.com/alvestrand/webrtc-media-streams/blob/master/explainer.md\r\n * that provides access to the encoded frames and allows them to be transformed.\r\n *\r\n * The encoded frame format is explained below in the _encodeFunction method.\r\n * High level design goals were:\r\n * - do not require changes to existing SFUs and retain (VP8) metadata.\r\n * - allow the SFU to rewrite SSRCs, timestamp, pictureId.\r\n * - allow for the key to be rotated frequently.\r\n */\r\nexport default class E2EEcontext {\r\n    /**\r\n     * Build a new E2EE context instance, which will be used in a given conference.\r\n     */\r\n    constructor() {\r\n        // Determine the URL for the worker script. Relative URLs are relative to\r\n        // the entry point, not the script that launches the worker.\r\n        let baseUrl = '';\r\n        const ljm = document.querySelector('script[src*=\"lib-jitsi-meet\"]');\r\n\r\n        if (ljm) {\r\n            const idx = ljm.src.lastIndexOf('/');\r\n\r\n            baseUrl = `${ljm.src.substring(0, idx)}/`;\r\n        }\r\n\r\n        // Initialize the E2EE worker. In order to avoid CORS issues, start the worker and have it\r\n        // synchronously load the JS.\r\n        const workerUrl = `${baseUrl}lib-jitsi-meet.e2ee-worker.js`;\r\n        const workerBlob\r\n            = new Blob([ `importScripts(\"${workerUrl}\");` ], { type: 'application/javascript' });\r\n        const blobUrl = window.URL.createObjectURL(workerBlob);\r\n\r\n        this._worker = new Worker(blobUrl, { name: 'E2EE Worker' });\r\n        this._worker.onerror = e => logger.onerror(e);\r\n    }\r\n\r\n    /**\r\n     * Cleans up all state associated with the given participant. This is needed when a\r\n     * participant leaves the current conference.\r\n     *\r\n     * @param {string} participantId - The participant that just left.\r\n     */\r\n    cleanup(participantId) {\r\n        this._worker.postMessage({\r\n            operation: 'cleanup',\r\n            participantId\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Handles the given {@code RTCRtpReceiver} by creating a {@code TransformStream} which will inject\r\n     * a frame decoder.\r\n     *\r\n     * @param {RTCRtpReceiver} receiver - The receiver which will get the decoding function injected.\r\n     * @param {string} kind - The kind of track this receiver belongs to.\r\n     * @param {string} participantId - The participant id that this receiver belongs to.\r\n     */\r\n    handleReceiver(receiver, kind, participantId) {\r\n        if (receiver[kJitsiE2EE]) {\r\n            return;\r\n        }\r\n        receiver[kJitsiE2EE] = true;\r\n\r\n        let receiverStreams;\r\n\r\n        if (receiver.createEncodedStreams) {\r\n            receiverStreams = receiver.createEncodedStreams();\r\n        } else {\r\n            receiverStreams = kind === 'video' ? receiver.createEncodedVideoStreams()\r\n                : receiver.createEncodedAudioStreams();\r\n        }\r\n\r\n        this._worker.postMessage({\r\n            operation: 'decode',\r\n            readableStream: receiverStreams.readable || receiverStreams.readableStream,\r\n            writableStream: receiverStreams.writable || receiverStreams.writableStream,\r\n            participantId\r\n        }, [ receiverStreams.readable || receiverStreams.readableStream,\r\n            receiverStreams.writable || receiverStreams.writableStream ]);\r\n    }\r\n\r\n    /**\r\n     * Handles the given {@code RTCRtpSender} by creating a {@code TransformStream} which will inject\r\n     * a frame encoder.\r\n     *\r\n     * @param {RTCRtpSender} sender - The sender which will get the encoding function injected.\r\n     * @param {string} kind - The kind of track this sender belongs to.\r\n     * @param {string} participantId - The participant id that this sender belongs to.\r\n     */\r\n    handleSender(sender, kind, participantId) {\r\n        if (sender[kJitsiE2EE]) {\r\n            return;\r\n        }\r\n        sender[kJitsiE2EE] = true;\r\n\r\n        let senderStreams;\r\n\r\n        if (sender.createEncodedStreams) {\r\n            senderStreams = sender.createEncodedStreams();\r\n        } else {\r\n            senderStreams = kind === 'video' ? sender.createEncodedVideoStreams()\r\n                : sender.createEncodedAudioStreams();\r\n        }\r\n\r\n        this._worker.postMessage({\r\n            operation: 'encode',\r\n            readableStream: senderStreams.readable || senderStreams.readableStream,\r\n            writableStream: senderStreams.writable || senderStreams.writableStream,\r\n            participantId\r\n        }, [ senderStreams.readable || senderStreams.readableStream,\r\n            senderStreams.writable || senderStreams.writableStream ]);\r\n    }\r\n\r\n    /**\r\n     * Set the E2EE key for the specified participant.\r\n     *\r\n     * @param {string} participantId - the ID of the participant who's key we are setting.\r\n     * @param {Uint8Array | boolean} key - they key for the given participant.\r\n     * @param {Number} keyIndex - the key index.\r\n     */\r\n    setKey(participantId, key, keyIndex) {\r\n        this._worker.postMessage({\r\n            operation: 'setKey',\r\n            participantId,\r\n            key,\r\n            keyIndex\r\n        });\r\n    }\r\n}\r\n","import { getLogger } from 'jitsi-meet-logger';\r\n\r\nimport {\r\n    default as NetworkInfo,\r\n    NETWORK_INFO_EVENT\r\n} from '../connectivity/NetworkInfo';\r\nimport { getJitterDelay } from '../util/Retry';\r\n\r\nconst logger = getLogger(__filename);\r\n\r\n/**\r\n * The class contains the logic for triggering connection resume via XEP-0198 stream management.\r\n * It does two things, the first one is it tracks the internet online/offline status and it makes sure that\r\n * the reconnect is attempted only while online. The seconds thing is that it tracks the retry attempts and extends\r\n * the retry interval using the full jitter pattern.\r\n */\r\nexport default class ResumeTask {\r\n    /**\r\n     * Initializes new {@code RetryTask}.\r\n     * @param {Strophe.Connection} stropheConnection - The Strophe connection instance.\r\n     */\r\n    constructor(stropheConnection) {\r\n        this._stropheConn = stropheConnection;\r\n\r\n        /**\r\n         * The counter increased before each resume retry attempt, used to calculate exponential backoff.\r\n         * @type {number}\r\n         * @private\r\n         */\r\n        this._resumeRetryN = 0;\r\n\r\n        this._retryDelay = undefined;\r\n    }\r\n\r\n    /**\r\n     * @returns {number|undefined} - How much the app will wait before trying to resume the XMPP connection. When\r\n     * 'undefined' it means that no resume task was not scheduled.\r\n     */\r\n    get retryDelay() {\r\n        return this._retryDelay;\r\n    }\r\n\r\n    /**\r\n     * Called by {@link XmppConnection} when the connection drops and it's a signal it wants to schedule a reconnect.\r\n     *\r\n     * @returns {void}\r\n     */\r\n    schedule() {\r\n        this._cancelResume();\r\n\r\n        this._resumeRetryN += 1;\r\n\r\n        this._networkOnlineListener\r\n            = NetworkInfo.addEventListener(\r\n                NETWORK_INFO_EVENT,\r\n                ({ isOnline }) => {\r\n                    if (isOnline) {\r\n                        this._scheduleResume();\r\n                    } else {\r\n                        this._cancelResume();\r\n                    }\r\n                });\r\n\r\n        NetworkInfo.isOnline() && this._scheduleResume();\r\n    }\r\n\r\n    /**\r\n     * Schedules a delayed timeout which will execute the resume action.\r\n     * @private\r\n     * @returns {void}\r\n     */\r\n    _scheduleResume() {\r\n        if (this._resumeTimeout) {\r\n\r\n            // NO-OP\r\n            return;\r\n        }\r\n\r\n        // The retry delay will be:\r\n        //   1st retry: 1.5s - 3s\r\n        //   2nd retry: 3s - 9s\r\n        //   3rd and next retry: 4.5s - 27s\r\n        this._resumeRetryN = Math.min(3, this._resumeRetryN);\r\n        this._retryDelay = getJitterDelay(\r\n            /* retry */ this._resumeRetryN,\r\n            /* minDelay */ this._resumeRetryN * 1500,\r\n            3);\r\n\r\n        logger.info(`Will try to resume the XMPP connection in ${this.retryDelay}ms`);\r\n\r\n        this._resumeTimeout = setTimeout(() => this._resumeConnection(), this.retryDelay);\r\n    }\r\n\r\n    /**\r\n     * Cancels the delayed resume task.\r\n     *\r\n     * @private\r\n     * @returns {void}\r\n     */\r\n    _cancelResume() {\r\n        if (this._resumeTimeout) {\r\n            logger.info('Canceling connection resume task');\r\n            clearTimeout(this._resumeTimeout);\r\n            this._resumeTimeout = undefined;\r\n            this._retryDelay = undefined;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Resumes the XMPP connection using the stream management plugin.\r\n     *\r\n     * @private\r\n     * @returns {void}\r\n     */\r\n    _resumeConnection() {\r\n        const { streamManagement } = this._stropheConn;\r\n        const resumeToken = streamManagement.getResumeToken();\r\n\r\n        // Things may have changed since when the task was scheduled\r\n        if (!resumeToken) {\r\n            return;\r\n        }\r\n\r\n        logger.info('Trying to resume the XMPP connection');\r\n\r\n        const url = new URL(this._stropheConn.service);\r\n        let { search } = url;\r\n        const pattern = /(previd=)([\\w-]+)/;\r\n        const oldToken = search.match(pattern);\r\n\r\n        // Replace previd if the previd value has changed.\r\n        if (oldToken && oldToken.indexOf(resumeToken) === -1) {\r\n            search = search.replace(pattern, `$1${resumeToken}`);\r\n\r\n        // Append previd if it doesn't exist.\r\n        } else if (!oldToken) {\r\n            search += search.indexOf('?') === -1 ? `?previd=${resumeToken}` : `&previd=${resumeToken}`;\r\n        }\r\n\r\n        url.search = search;\r\n\r\n        this._stropheConn.service = url.toString();\r\n\r\n        streamManagement.resume();\r\n    }\r\n\r\n    /**\r\n     * Cancels the retry task. It's called by {@link XmppConnection} when it's no longer interested in reconnecting for\r\n     * example when the disconnect method is called.\r\n     *\r\n     * @returns {void}\r\n     */\r\n    cancel() {\r\n        this._cancelResume();\r\n        this._resumeRetryN = 0;\r\n        if (this._networkOnlineListener) {\r\n            this._networkOnlineListener();\r\n            this._networkOnlineListener = null;\r\n        }\r\n    }\r\n}\r\n","/**\r\n* Gets next timeout using the full jitter pattern.\r\n*\r\n* NOTE that there are no checks for argument correctness, so either do the math or use defaults.\r\n*\r\n* @param {number} retry - The retry number.\r\n* @param {number} minDelay - The minimal delay in milliseconds.\r\n* @param {number} base - The exponent base.\r\n* @returns {number} - The amount of waiting before trying another time given in milliseconds.\r\n* @private\r\n*/\r\nexport function getJitterDelay(retry, minDelay = 500, base = 2) {\r\n    return Math.floor((Math.random() * ((Math.pow(base, retry) * 1000) - minDelay)) + minDelay);\r\n}\r\n","/**\r\n * Attaches to the {@link Strophe.Connection.rawInput} which is called whenever any data is received from the server.\r\n */\r\nexport default class LastRequestTracker {\r\n    /**\r\n     * Initializes new instance.\r\n     */\r\n    constructor() {\r\n        this._lastSuccess = null;\r\n        this._lastFailedMessage = null;\r\n    }\r\n\r\n    /**\r\n     * Starts tracking requests on the given connection.\r\n     *\r\n     * @param {XmppConnection} xmppConnection - The XMPP connection which manages the given {@code stropheConnection}.\r\n     * @param {Object} stropheConnection - Strophe connection instance.\r\n     */\r\n    startTracking(xmppConnection, stropheConnection) {\r\n        const originalRawInput = stropheConnection.rawInput;\r\n\r\n        stropheConnection.rawInput = (...args) => {\r\n            const rawMessage = args[0];\r\n\r\n            if (rawMessage.includes('failure')) {\r\n                this._lastFailedMessage = rawMessage;\r\n            }\r\n\r\n            // It's okay to use rawInput callback only once the connection has been established, otherwise it will\r\n            // treat 'item-not-found' or other connection error on websocket reconnect as successful stanza received.\r\n            if (xmppConnection.connected) {\r\n                this._lastSuccess = Date.now();\r\n            }\r\n            originalRawInput.apply(stropheConnection, args);\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Returns the last raw failed incoming message on the xmpp connection.\r\n     *\r\n     * @returns {string|null}\r\n     */\r\n    getLastFailedMessage() {\r\n        return this._lastFailedMessage;\r\n    }\r\n\r\n    /**\r\n     * Returns how many milliseconds have passed since the last successful BOSH request.\r\n     *\r\n     * @returns {number|null}\r\n     */\r\n    getTimeSinceLastSuccess() {\r\n        return this._lastSuccess\r\n            ? Date.now() - this._lastSuccess\r\n            : null;\r\n    }\r\n}\r\n","import { getLogger } from 'jitsi-meet-logger';\r\nimport { $iq, Strophe } from 'strophe.js';\r\n\r\nimport GlobalOnErrorHandler from '../util/GlobalOnErrorHandler';\r\n\r\nimport ConnectionPlugin from './ConnectionPlugin';\r\n\r\n\r\nconst logger = getLogger(__filename);\r\n\r\n/**\r\n * Default ping every 10 sec\r\n */\r\nconst PING_DEFAULT_INTERVAL = 10000;\r\n\r\n/**\r\n * Default ping timeout error after 5 sec of waiting.\r\n */\r\nconst PING_DEFAULT_TIMEOUT = 5000;\r\n\r\n/**\r\n * Default value for how many ping failures will be tolerated before the WebSocket connection is killed.\r\n * The worst case scenario in case of ping timing out without a response is (25 seconds at the time of this writing):\r\n * PING_THRESHOLD * PING_INTERVAL + PING_TIMEOUT\r\n */\r\nconst PING_DEFAULT_THRESHOLD = 2;\r\n\r\n/**\r\n * XEP-0199 ping plugin.\r\n *\r\n * Registers \"urn:xmpp:ping\" namespace under Strophe.NS.PING.\r\n */\r\nexport default class PingConnectionPlugin extends ConnectionPlugin {\r\n    /**\r\n     * Constructs new object\r\n     * @param {Object} options\r\n     * @param {Function} options.onPingThresholdExceeded - Callback called when ping fails too many times (controlled\r\n     * by the {@link PING_THRESHOLD} constant).\r\n     * @param {Function} options._getTimeSinceLastServerResponse - A function to obtain the last seen\r\n     * response from the server.\r\n     * @param {Object} options.pingOptions - The ping options if any.\r\n     * @constructor\r\n     */\r\n    constructor({ getTimeSinceLastServerResponse, onPingThresholdExceeded, pingOptions = {} }) {\r\n        super();\r\n        this.failedPings = 0;\r\n        this._onPingThresholdExceeded = onPingThresholdExceeded;\r\n        this._getTimeSinceLastServerResponse = getTimeSinceLastServerResponse;\r\n\r\n        this.pingInterval = typeof pingOptions.interval === 'number' ? pingOptions.interval : PING_DEFAULT_INTERVAL;\r\n        this.pingTimeout = typeof pingOptions.timeout === 'number' ? pingOptions.timeout : PING_DEFAULT_TIMEOUT;\r\n        this.pingThreshold = typeof pingOptions.threshold === 'number'\r\n            ? pingOptions.threshold : PING_DEFAULT_THRESHOLD;\r\n\r\n        // The number of timestamps of send pings to keep.\r\n        // The current value is 2 minutes.\r\n        this.pingTimestampsToKeep = Math.round(120000 / this.pingInterval);\r\n        this.pingExecIntervals = new Array(this.pingTimestampsToKeep);\r\n    }\r\n\r\n    /**\r\n     * Initializes the plugin. Method called by Strophe.\r\n     * @param connection Strophe connection instance.\r\n     */\r\n    init(connection) {\r\n        super.init(connection);\r\n        Strophe.addNamespace('PING', 'urn:xmpp:ping');\r\n    }\r\n\r\n    /* eslint-disable max-params */\r\n\r\n    /**\r\n     * Sends \"ping\" to given <tt>jid</tt>\r\n     * @param jid the JID to which ping request will be sent.\r\n     * @param success callback called on success.\r\n     * @param error callback called on error.\r\n     * @param timeout ms how long are we going to wait for the response. On\r\n     * timeout <tt>error<//t> callback is called with undefined error argument.\r\n     */\r\n    ping(jid, success, error, timeout) {\r\n        this._addPingExecutionTimestamp();\r\n\r\n        const iq = $iq({\r\n            type: 'get',\r\n            to: jid\r\n        });\r\n\r\n        iq.c('ping', { xmlns: Strophe.NS.PING });\r\n        this.connection.sendIQ2(iq, { timeout })\r\n            .then(success, error);\r\n    }\r\n\r\n    /* eslint-enable max-params */\r\n\r\n    /**\r\n     * Starts to send ping in given interval to specified remote JID.\r\n     * This plugin supports only one such task and <tt>stopInterval</tt>\r\n     * must be called before starting a new one.\r\n     * @param remoteJid remote JID to which ping requests will be sent to.\r\n     */\r\n    startInterval(remoteJid) {\r\n        clearInterval(this.intervalId);\r\n        this.intervalId = window.setInterval(() => {\r\n\r\n            // when there were some server responses in the interval since the last time we checked (_lastServerCheck)\r\n            // let's skip the ping\r\n\r\n            const now = Date.now();\r\n\r\n            if (this._getTimeSinceLastServerResponse() < now - this._lastServerCheck) {\r\n                // do this just to keep in sync the intervals so we can detect suspended device\r\n                this._addPingExecutionTimestamp();\r\n\r\n                this._lastServerCheck = now;\r\n                this.failedPings = 0;\r\n\r\n                return;\r\n            }\r\n\r\n            this.ping(remoteJid, () => {\r\n                // server response is measured on raw input and ping response time is measured after all the xmpp\r\n                // processing is done in js, so there can be some misalignment when we do the check above.\r\n                // That's why we store the last time we got the response\r\n                this._lastServerCheck = this._getTimeSinceLastServerResponse() + Date.now();\r\n\r\n                this.failedPings = 0;\r\n            }, error => {\r\n                this.failedPings += 1;\r\n                const errmsg = `Ping ${error ? 'error' : 'timeout'}`;\r\n\r\n                if (this.failedPings >= this.pingThreshold) {\r\n                    GlobalOnErrorHandler.callErrorHandler(new Error(errmsg));\r\n                    logger.error(errmsg, error);\r\n                    this._onPingThresholdExceeded && this._onPingThresholdExceeded();\r\n                } else {\r\n                    logger.warn(errmsg, error);\r\n                }\r\n            }, this.pingTimeout);\r\n        }, this.pingInterval);\r\n        logger.info(`XMPP pings will be sent every ${this.pingInterval} ms`);\r\n    }\r\n\r\n    /**\r\n     * Stops current \"ping\"  interval task.\r\n     */\r\n    stopInterval() {\r\n        if (this.intervalId) {\r\n            window.clearInterval(this.intervalId);\r\n            this.intervalId = null;\r\n            this.failedPings = 0;\r\n            logger.info('Ping interval cleared');\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Adds the current time to the array of send ping timestamps.\r\n     * @private\r\n     */\r\n    _addPingExecutionTimestamp() {\r\n        this.pingExecIntervals.push(new Date().getTime());\r\n\r\n        // keep array length to PING_TIMESTAMPS_TO_KEEP\r\n        if (this.pingExecIntervals.length > this.pingTimestampsToKeep) {\r\n            this.pingExecIntervals.shift();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Returns the maximum time between the recent sent pings, if there is a\r\n     * big value it means the computer was inactive for some time(suspended).\r\n     * Checks the maximum gap between sending pings, considering and the\r\n     * current time. Trying to detect computer inactivity (sleep).\r\n     *\r\n     * @returns {int} the time ping was suspended, if it was not 0 is returned.\r\n     */\r\n    getPingSuspendTime() {\r\n        const pingIntervals = this.pingExecIntervals.slice();\r\n\r\n        // we need current time, as if ping was sent now\r\n        // if computer sleeps we will get correct interval after next\r\n        // scheduled ping, bet we sometimes need that interval before waiting\r\n        // for the next ping, on closing the connection on error.\r\n        pingIntervals.push(new Date().getTime());\r\n\r\n        let maxInterval = 0;\r\n        let previousTS = pingIntervals[0];\r\n\r\n        pingIntervals.forEach(e => {\r\n            const currentInterval = e - previousTS;\r\n\r\n            if (currentInterval > maxInterval) {\r\n                maxInterval = currentInterval;\r\n            }\r\n\r\n            previousTS = e;\r\n        });\r\n\r\n        // remove the interval between the ping sent\r\n        // this way in normal execution there is no suspend and the return\r\n        // will be 0 or close to 0.\r\n        maxInterval -= this.pingInterval;\r\n\r\n        // make sure we do not return less than 0\r\n        return Math.max(maxInterval, 0);\r\n    }\r\n}\r\n","/* global $ */\r\n\r\nimport { getLogger } from 'jitsi-meet-logger';\r\nimport { Strophe } from 'strophe.js';\r\n\r\nimport XMPPEvents from '../../service/xmpp/XMPPEvents';\r\n\r\nimport ChatRoom from './ChatRoom';\r\nimport { ConnectionPluginListenable } from './ConnectionPlugin';\r\n\r\nconst logger = getLogger(__filename);\r\n\r\n/**\r\n * MUC connection plugin.\r\n */\r\nexport default class MucConnectionPlugin extends ConnectionPluginListenable {\r\n    /**\r\n     *\r\n     * @param xmpp\r\n     */\r\n    constructor(xmpp) {\r\n        super();\r\n        this.xmpp = xmpp;\r\n        this.rooms = {};\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param connection\r\n     */\r\n    init(connection) {\r\n        super.init(connection);\r\n\r\n        // add handlers (just once)\r\n        this.connection.addHandler(this.onPresence.bind(this), null,\r\n            'presence', null, null, null, null);\r\n        this.connection.addHandler(this.onPresenceUnavailable.bind(this),\r\n            null, 'presence', 'unavailable', null);\r\n        this.connection.addHandler(this.onPresenceError.bind(this), null,\r\n            'presence', 'error', null);\r\n        this.connection.addHandler(this.onMessage.bind(this), null,\r\n            'message', null, null);\r\n        this.connection.addHandler(this.onMute.bind(this),\r\n            'http://jitsi.org/jitmeet/audio', 'iq', 'set', null, null);\r\n        this.connection.addHandler(this.onMuteVideo.bind(this),\r\n            'http://jitsi.org/jitmeet/video', 'iq', 'set', null, null);\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param jid\r\n     * @param password\r\n     * @param options\r\n     */\r\n    createRoom(jid, password, options) {\r\n        const roomJid = Strophe.getBareJidFromJid(jid);\r\n\r\n        if (this.rooms[roomJid]) {\r\n            const errmsg = 'You are already in the room!';\r\n\r\n            logger.error(errmsg);\r\n            throw new Error(errmsg);\r\n        }\r\n        this.rooms[roomJid] = new ChatRoom(this.connection, jid,\r\n            password, this.xmpp, options);\r\n        this.eventEmitter.emit(\r\n            XMPPEvents.EMUC_ROOM_ADDED, this.rooms[roomJid]);\r\n\r\n        return this.rooms[roomJid];\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param jid\r\n     */\r\n    doLeave(jid) {\r\n        this.eventEmitter.emit(\r\n            XMPPEvents.EMUC_ROOM_REMOVED, this.rooms[jid]);\r\n        delete this.rooms[jid];\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param pres\r\n     */\r\n    onPresence(pres) {\r\n        const from = pres.getAttribute('from');\r\n\r\n        // What is this for? A workaround for something?\r\n        if (pres.getAttribute('type')) {\r\n            return true;\r\n        }\r\n\r\n        const room = this.rooms[Strophe.getBareJidFromJid(from)];\r\n\r\n        if (!room) {\r\n            return true;\r\n        }\r\n\r\n        // Parse status.\r\n        if ($(pres).find('>x[xmlns=\"http://jabber.org/protocol/muc#user\"]'\r\n            + '>status[code=\"201\"]').length) {\r\n            room.createNonAnonymousRoom();\r\n        }\r\n\r\n        room.onPresence(pres);\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param pres\r\n     */\r\n    onPresenceUnavailable(pres) {\r\n        const from = pres.getAttribute('from');\r\n        const room = this.rooms[Strophe.getBareJidFromJid(from)];\r\n\r\n        if (!room) {\r\n            return true;\r\n        }\r\n\r\n        room.onPresenceUnavailable(pres, from);\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param pres\r\n     */\r\n    onPresenceError(pres) {\r\n        const from = pres.getAttribute('from');\r\n        const room = this.rooms[Strophe.getBareJidFromJid(from)];\r\n\r\n        if (!room) {\r\n            return true;\r\n        }\r\n\r\n        room.onPresenceError(pres, from);\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param msg\r\n     */\r\n    onMessage(msg) {\r\n        // FIXME: this is a hack. but jingle on muc makes nickchanges hard\r\n        const from = msg.getAttribute('from');\r\n        const room = this.rooms[Strophe.getBareJidFromJid(from)];\r\n\r\n        if (!room) {\r\n            return true;\r\n        }\r\n\r\n        room.onMessage(msg, from);\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * TODO: Document\r\n     * @param iq\r\n     */\r\n    onMute(iq) {\r\n        const from = iq.getAttribute('from');\r\n        const room = this.rooms[Strophe.getBareJidFromJid(from)];\r\n\r\n        // Returning false would result in the listener being deregistered by Strophe\r\n        if (!room) {\r\n            return true;\r\n        }\r\n\r\n        room.onMute(iq);\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * TODO: Document\r\n     * @param iq\r\n     */\r\n    onMuteVideo(iq) {\r\n        const from = iq.getAttribute('from');\r\n        const room = this.rooms[Strophe.getBareJidFromJid(from)];\r\n\r\n        // Returning false would result in the listener being deregistered by Strophe\r\n        if (!room) {\r\n            return true;\r\n        }\r\n\r\n        room.onMuteVideo(iq);\r\n\r\n        return true;\r\n    }\r\n}\r\n","/* global $, __filename */\r\n\r\nimport { getLogger } from 'jitsi-meet-logger';\r\nimport isEqual from 'lodash.isequal';\r\nimport { $iq, $msg, $pres, Strophe } from 'strophe.js';\r\n\r\nimport * as JitsiTranscriptionStatus from '../../JitsiTranscriptionStatus';\r\nimport * as MediaType from '../../service/RTC/MediaType';\r\nimport XMPPEvents from '../../service/xmpp/XMPPEvents';\r\nimport GlobalOnErrorHandler from '../util/GlobalOnErrorHandler';\r\nimport Listenable from '../util/Listenable';\r\n\r\nimport AVModeration from './AVModeration';\r\nimport Lobby from './Lobby';\r\nimport XmppConnection from './XmppConnection';\r\nimport Moderator from './moderator';\r\n\r\nconst logger = getLogger(__filename);\r\n\r\nexport const parser = {\r\n    packet2JSON(xmlElement, nodes) {\r\n        for (const child of Array.from(xmlElement.children)) {\r\n            const node = {\r\n                attributes: {},\r\n                children: [],\r\n                tagName: child.tagName\r\n            };\r\n\r\n            for (const attr of Array.from(child.attributes)) {\r\n                node.attributes[attr.name] = attr.value;\r\n            }\r\n            const text = Strophe.getText(child);\r\n\r\n            if (text) {\r\n                // Using Strophe.getText will do work for traversing all direct\r\n                // child text nodes but returns an escaped value, which is not\r\n                // desirable at this point.\r\n                node.value = Strophe.xmlunescape(text);\r\n            }\r\n            nodes.push(node);\r\n            this.packet2JSON(child, node.children);\r\n        }\r\n    },\r\n    json2packet(nodes, packet) {\r\n        for (let i = 0; i < nodes.length; i++) {\r\n            const node = nodes[i];\r\n\r\n            if (node) {\r\n                packet.c(node.tagName, node.attributes);\r\n                if (node.value) {\r\n                    packet.t(node.value);\r\n                }\r\n                if (node.children) {\r\n                    this.json2packet(node.children, packet);\r\n                }\r\n                packet.up();\r\n            }\r\n        }\r\n\r\n        // packet.up();\r\n    }\r\n};\r\n\r\n/**\r\n * Returns array of JS objects from the presence JSON associated with the passed\r\n / nodeName\r\n * @param pres the presence JSON\r\n * @param nodeName the name of the node (videomuted, audiomuted, etc)\r\n */\r\nfunction filterNodeFromPresenceJSON(pres, nodeName) {\r\n    const res = [];\r\n\r\n    for (let i = 0; i < pres.length; i++) {\r\n        if (pres[i].tagName === nodeName) {\r\n            res.push(pres[i]);\r\n        }\r\n    }\r\n\r\n    return res;\r\n}\r\n\r\n// XXX As ChatRoom constructs XMPP stanzas and Strophe is build around the idea\r\n// of chaining function calls, allow long function call chains.\r\n/* eslint-disable newline-per-chained-call */\r\n\r\n/**\r\n * Array of affiliations that are allowed in members only room.\r\n * @type {string[]}\r\n */\r\nconst MEMBERS_AFFILIATIONS = [ 'owner', 'admin', 'member' ];\r\n\r\n/**\r\n *\r\n */\r\nexport default class ChatRoom extends Listenable {\r\n\r\n    /* eslint-disable max-params */\r\n\r\n    /**\r\n     *\r\n     * @param {XmppConnection} connection - The XMPP connection instance.\r\n     * @param jid\r\n     * @param password\r\n     * @param XMPP\r\n     * @param options\r\n     * @param {boolean} options.disableFocus - when set to {@code false} will\r\n     * not invite Jicofo into the room.\r\n     * @param {boolean} options.disableDiscoInfo - when set to {@code false} will skip disco info.\r\n     * This is intended to be used only for lobby rooms.\r\n     * @param {boolean} options.enableLobby - when set to {@code false} will skip creating lobby room.\r\n     */\r\n    constructor(connection, jid, password, XMPP, options) {\r\n        super();\r\n        this.xmpp = XMPP;\r\n        this.connection = connection;\r\n        this.roomjid = Strophe.getBareJidFromJid(jid);\r\n        this.myroomjid = jid;\r\n        this.password = password;\r\n        logger.info(`Joined MUC as ${this.myroomjid}`);\r\n        this.members = {};\r\n        this.presMap = {};\r\n        this.presHandlers = {};\r\n        this._removeConnListeners = [];\r\n        this.joined = false;\r\n        this.role = null;\r\n        this.focusMucJid = null;\r\n        this.noBridgeAvailable = false;\r\n        this.options = options || {};\r\n        this.moderator\r\n            = new Moderator(this.roomjid, this.xmpp, this.eventEmitter, {\r\n                connection: this.xmpp.options,\r\n                conference: this.options\r\n            });\r\n        if (typeof this.options.enableLobby === 'undefined' || this.options.enableLobby) {\r\n            this.lobby = new Lobby(this);\r\n        }\r\n        this.avModeration = new AVModeration(this);\r\n        this.initPresenceMap(options);\r\n        this.lastPresences = {};\r\n        this.phoneNumber = null;\r\n        this.phonePin = null;\r\n        this.connectionTimes = {};\r\n        this.participantPropertyListener = null;\r\n\r\n        this.locked = false;\r\n        this.transcriptionStatus = JitsiTranscriptionStatus.OFF;\r\n    }\r\n\r\n    /* eslint-enable max-params */\r\n\r\n    /**\r\n     *\r\n     */\r\n    initPresenceMap(options = {}) {\r\n        this.presMap.to = this.myroomjid;\r\n        this.presMap.xns = 'http://jabber.org/protocol/muc';\r\n        this.presMap.nodes = [];\r\n\r\n        if (options.statsId) {\r\n            this.presMap.nodes.push({\r\n                'tagName': 'stats-id',\r\n                'value': options.statsId\r\n            });\r\n        }\r\n\r\n        if (options.deploymentInfo && options.deploymentInfo.userRegion) {\r\n            this.presMap.nodes.push({\r\n                'tagName': 'region',\r\n                'attributes': {\r\n                    id: options.deploymentInfo.userRegion,\r\n                    xmlns: 'http://jitsi.org/jitsi-meet'\r\n                }\r\n            });\r\n        }\r\n\r\n        this.presenceUpdateTime = Date.now();\r\n    }\r\n\r\n    /**\r\n     * Joins the chat room.\r\n     * @param {string} password - Password to unlock room on joining.\r\n     * @returns {Promise} - resolved when join completes. At the time of this\r\n     * writing it's never rejected.\r\n     */\r\n    join(password) {\r\n        this.password = password;\r\n\r\n        return new Promise(resolve => {\r\n            this.options.disableFocus\r\n                && logger.info(`Conference focus disabled for ${this.roomjid}`);\r\n\r\n            const preJoin\r\n                = this.options.disableFocus\r\n                    ? Promise.resolve()\r\n                    : this.moderator.allocateConferenceFocus();\r\n\r\n            preJoin.then(() => {\r\n                this.sendPresence(true);\r\n                this._removeConnListeners.push(\r\n                    this.connection.addEventListener(\r\n                        XmppConnection.Events.CONN_STATUS_CHANGED,\r\n                        this.onConnStatusChanged.bind(this))\r\n                );\r\n                resolve();\r\n            });\r\n        });\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param fromJoin - Whether this is initial presence to join the room.\r\n     */\r\n    sendPresence(fromJoin) {\r\n        const to = this.presMap.to;\r\n\r\n        if (!this.connection || !this.connection.connected || !to || (!this.joined && !fromJoin)) {\r\n            // Too early to send presence - not initialized\r\n            return;\r\n        }\r\n\r\n        const pres = $pres({ to });\r\n\r\n        // xep-0045 defines: \"including in the initial presence stanza an empty\r\n        // <x/> element qualified by the 'http://jabber.org/protocol/muc'\r\n        // namespace\" and subsequent presences should not include that or it can\r\n        // be considered as joining, and server can send us the message history\r\n        // for the room on every presence\r\n        if (fromJoin) {\r\n            pres.c('x', { xmlns: this.presMap.xns });\r\n\r\n            if (this.password) {\r\n                pres.c('password').t(this.password).up();\r\n            }\r\n            if (this.options.billingId) {\r\n                pres.c('billingid').t(this.options.billingId).up();\r\n            }\r\n\r\n            pres.up();\r\n        }\r\n\r\n        parser.json2packet(this.presMap.nodes, pres);\r\n\r\n        // we store time we last synced presence state\r\n        this.presenceSyncTime = Date.now();\r\n\r\n        this.connection.send(pres);\r\n        if (fromJoin) {\r\n            // XXX We're pressed for time here because we're beginning a complex\r\n            // and/or lengthy conference-establishment process which supposedly\r\n            // involves multiple RTTs. We don't have the time to wait for\r\n            // Strophe to decide to send our IQ.\r\n            this.connection.flush();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Sends the presence unavailable, signaling the server\r\n     * we want to leave the room.\r\n     */\r\n    doLeave() {\r\n        logger.log('do leave', this.myroomjid);\r\n        const pres = $pres({ to: this.myroomjid,\r\n            type: 'unavailable' });\r\n\r\n        this.presMap.length = 0;\r\n\r\n        // XXX Strophe is asynchronously sending by default. Unfortunately, that\r\n        // means that there may not be enough time to send the unavailable\r\n        // presence. Switching Strophe to synchronous sending is not much of an\r\n        // option because it may lead to a noticeable delay in navigating away\r\n        // from the current location. As a compromise, we will try to increase\r\n        // the chances of sending the unavailable presence within the short time\r\n        // span that we have upon unloading by invoking flush() on the\r\n        // connection. We flush() once before sending/queuing the unavailable\r\n        // presence in order to attemtp to have the unavailable presence at the\r\n        // top of the send queue. We flush() once more after sending/queuing the\r\n        // unavailable presence in order to attempt to have it sent as soon as\r\n        // possible.\r\n        // FIXME do not use Strophe.Connection in the ChatRoom directly\r\n        !this.connection.isUsingWebSocket && this.connection.flush();\r\n        this.connection.send(pres);\r\n        this.connection.flush();\r\n    }\r\n\r\n    /**\r\n     *\r\n     */\r\n    discoRoomInfo() {\r\n        // https://xmpp.org/extensions/xep-0045.html#disco-roominfo\r\n\r\n        const getInfo\r\n            = $iq({\r\n                type: 'get',\r\n                to: this.roomjid\r\n            })\r\n                .c('query', { xmlns: Strophe.NS.DISCO_INFO });\r\n\r\n        this.connection.sendIQ(getInfo, result => {\r\n            const locked\r\n                = $(result).find('>query>feature[var=\"muc_passwordprotected\"]')\r\n                    .length\r\n                    === 1;\r\n\r\n            if (locked !== this.locked) {\r\n                this.eventEmitter.emit(XMPPEvents.MUC_LOCK_CHANGED, locked);\r\n                this.locked = locked;\r\n            }\r\n\r\n            const meetingIdValEl\r\n                = $(result).find('>query>x[type=\"result\"]>field[var=\"muc#roominfo_meetingId\"]>value');\r\n\r\n            if (meetingIdValEl.length) {\r\n                this.setMeetingId(meetingIdValEl.text());\r\n            } else {\r\n                logger.warn('No meeting ID from backend');\r\n            }\r\n\r\n            const membersOnly = $(result).find('>query>feature[var=\"muc_membersonly\"]').length === 1;\r\n\r\n            const lobbyRoomField\r\n                = $(result).find('>query>x[type=\"result\"]>field[var=\"muc#roominfo_lobbyroom\"]>value');\r\n\r\n            if (this.lobby) {\r\n                this.lobby.setLobbyRoomJid(lobbyRoomField && lobbyRoomField.length ? lobbyRoomField.text() : undefined);\r\n            }\r\n\r\n            if (membersOnly !== this.membersOnlyEnabled) {\r\n                this.membersOnlyEnabled = membersOnly;\r\n                this.eventEmitter.emit(XMPPEvents.MUC_MEMBERS_ONLY_CHANGED, membersOnly);\r\n            }\r\n\r\n        }, error => {\r\n            GlobalOnErrorHandler.callErrorHandler(error);\r\n            logger.error('Error getting room info: ', error);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Sets the meeting unique Id (received from the backend).\r\n     *\r\n     * @param {string} meetingId - The new meetings id.\r\n     * @returns {void}\r\n     */\r\n    setMeetingId(meetingId) {\r\n        if (this.meetingId !== meetingId) {\r\n            if (this.meetingId) {\r\n                logger.warn(`Meeting Id changed from:${this.meetingId} to:${meetingId}`);\r\n            }\r\n            this.meetingId = meetingId;\r\n            this.eventEmitter.emit(XMPPEvents.MEETING_ID_SET, meetingId);\r\n        }\r\n    }\r\n\r\n    /**\r\n     *\r\n     */\r\n    createNonAnonymousRoom() {\r\n        // http://xmpp.org/extensions/xep-0045.html#createroom-reserved\r\n\r\n        if (this.options.disableDiscoInfo) {\r\n            return;\r\n        }\r\n\r\n        const getForm = $iq({ type: 'get',\r\n            to: this.roomjid })\r\n            .c('query', { xmlns: 'http://jabber.org/protocol/muc#owner' })\r\n            .c('x', { xmlns: 'jabber:x:data',\r\n                type: 'submit' });\r\n\r\n        this.connection.sendIQ(getForm, form => {\r\n            if (!$(form).find(\r\n                    '>query>x[xmlns=\"jabber:x:data\"]'\r\n                    + '>field[var=\"muc#roomconfig_whois\"]').length) {\r\n                const errmsg = 'non-anonymous rooms not supported';\r\n\r\n                GlobalOnErrorHandler.callErrorHandler(new Error(errmsg));\r\n                logger.error(errmsg);\r\n\r\n                return;\r\n            }\r\n\r\n            const formSubmit = $iq({ to: this.roomjid,\r\n                type: 'set' })\r\n                .c('query', { xmlns: 'http://jabber.org/protocol/muc#owner' });\r\n\r\n            formSubmit.c('x', { xmlns: 'jabber:x:data',\r\n                type: 'submit' });\r\n\r\n            formSubmit.c('field', { 'var': 'FORM_TYPE' })\r\n                .c('value')\r\n                .t('http://jabber.org/protocol/muc#roomconfig').up().up();\r\n\r\n            formSubmit.c('field', { 'var': 'muc#roomconfig_whois' })\r\n                .c('value').t('anyone').up().up();\r\n\r\n            this.connection.sendIQ(formSubmit);\r\n\r\n        }, error => {\r\n            GlobalOnErrorHandler.callErrorHandler(error);\r\n            logger.error('Error getting room configuration form: ', error);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Handles Xmpp Connection status updates.\r\n     *\r\n     * @param {Strophe.Status} status - The Strophe connection status.\r\n     */\r\n    onConnStatusChanged(status) {\r\n\t\t/*\r\n        const StatusString = ['ERROR', 'CONNECTING', 'CONNFAIL', 'AUTHENTICATING','AUTHFAIL',\r\n            'CONNECTED', 'DISCONNECTED', 'DISCONNECTING', 'ATTACHED', 'REDIRECT', 'CONNTIMEOUT',\r\n            'BINDREQUIRED']\r\n    \r\n        console.log(`Xmpp onConnStatusChanged ${StatusString[status]}`)\r\n\t\t*/\r\n        // Send cached presence when the XMPP connection is re-established.\r\n        if (status === XmppConnection.Status.CONNECTED) {\r\n            this.sendPresence();\r\n        }\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param pres\r\n     */\r\n    onPresence(pres) {\r\n        const from = pres.getAttribute('from');\r\n        const member = {};\r\n        const statusEl = pres.getElementsByTagName('status')[0];\r\n\r\n        if (statusEl) {\r\n            member.status = statusEl.textContent || '';\r\n        }\r\n        let hasStatusUpdate = false;\r\n        let hasVersionUpdate = false;\r\n        const xElement\r\n            = pres.getElementsByTagNameNS(\r\n                'http://jabber.org/protocol/muc#user', 'x')[0];\r\n        const mucUserItem\r\n            = xElement && xElement.getElementsByTagName('item')[0];\r\n\r\n        member.affiliation\r\n            = mucUserItem && mucUserItem.getAttribute('affiliation');\r\n        member.role = mucUserItem && mucUserItem.getAttribute('role');\r\n\r\n        // Focus recognition\r\n        const jid = mucUserItem && mucUserItem.getAttribute('jid');\r\n\r\n        member.jid = jid;\r\n        member.isFocus\r\n            = jid && jid.indexOf(`${this.moderator.getFocusUserJid()}/`) === 0;\r\n        member.isHiddenDomain\r\n            = jid && jid.indexOf('@') > 0\r\n                && this.options.hiddenDomain\r\n                    === jid.substring(jid.indexOf('@') + 1, jid.indexOf('/'));\r\n\r\n        this.eventEmitter.emit(XMPPEvents.PRESENCE_RECEIVED, {\r\n            fromHiddenDomain: member.isHiddenDomain,\r\n            presence: pres\r\n        });\r\n\r\n        const xEl = pres.querySelector('x');\r\n\r\n        if (xEl) {\r\n            xEl.remove();\r\n        }\r\n\r\n        const nodes = [];\r\n\r\n        parser.packet2JSON(pres, nodes);\r\n        this.lastPresences[from] = nodes;\r\n\r\n        // process nodes to extract data needed for MUC_JOINED and\r\n        // MUC_MEMBER_JOINED events\r\n        const extractIdentityInformation = node => {\r\n            const identity = {};\r\n            const userInfo = node.children.find(c => c.tagName === 'user');\r\n\r\n            if (userInfo) {\r\n                identity.user = {};\r\n                for (const tag of [ 'id', 'name', 'avatar' ]) {\r\n                    const child\r\n                        = userInfo.children.find(c => c.tagName === tag);\r\n\r\n                    if (child) {\r\n                        identity.user[tag] = child.value;\r\n                    }\r\n                }\r\n            }\r\n            const groupInfo = node.children.find(c => c.tagName === 'group');\r\n\r\n            if (groupInfo) {\r\n                identity.group = groupInfo.value;\r\n            }\r\n\r\n            return identity;\r\n        };\r\n\r\n        for (let i = 0; i < nodes.length; i++) {\r\n            const node = nodes[i];\r\n\r\n            switch (node.tagName) {\r\n            case 'bot': {\r\n                const { attributes } = node;\r\n\r\n                if (!attributes) {\r\n                    break;\r\n                }\r\n                const { type } = attributes;\r\n\r\n                member.botType = type;\r\n                break;\r\n            }\r\n            case 'nick':\r\n                member.nick = node.value;\r\n                break;\r\n            case 'userId':\r\n                member.id = node.value;\r\n                break;\r\n            case 'stats-id':\r\n                member.statsID = node.value;\r\n                break;\r\n            case 'identity':\r\n                member.identity = extractIdentityInformation(node);\r\n                break;\r\n            case 'features': {\r\n                member.features = this._extractFeatures(node);\r\n                break;\r\n            }\r\n            case 'stat': {\r\n                const { attributes } = node;\r\n\r\n                if (!attributes) {\r\n                    break;\r\n                }\r\n                const { name } = attributes;\r\n\r\n                if (name === 'version') {\r\n                    member.version = attributes.value;\r\n                }\r\n                break;\r\n            }\r\n            }\r\n        }\r\n\r\n        if (from === this.myroomjid) {\r\n            const newRole\r\n                = member.affiliation === 'owner' ? member.role : 'none';\r\n\r\n            if (this.role !== newRole) {\r\n                this.role = newRole;\r\n                this.eventEmitter.emit(\r\n                    XMPPEvents.LOCAL_ROLE_CHANGED,\r\n                    this.role);\r\n            }\r\n            if (!this.joined) {\r\n                this.joined = true;\r\n                const now = this.connectionTimes['muc.joined']\r\n                    = window.performance.now();\r\n\r\n                logger.log('(TIME) MUC joined:\\t', now);\r\n\r\n                // set correct initial state of locked\r\n                if (this.password) {\r\n                    this.locked = true;\r\n                }\r\n\r\n                // Re-send presence in case any presence updates were added,\r\n                // but blocked from sending, during the join process.\r\n                // send the presence only if there was a modification after we had synced it\r\n                if (this.presenceUpdateTime >= this.presenceSyncTime) {\r\n                    this.sendPresence();\r\n                }\r\n\r\n                this.eventEmitter.emit(XMPPEvents.MUC_JOINED);\r\n\r\n                // Now let's check the disco-info to retrieve the\r\n                // meeting Id if any\r\n                !this.options.disableDiscoInfo && this.discoRoomInfo();\r\n            }\r\n        } else if (jid === undefined) {\r\n            logger.info('Ignoring member with undefined JID');\r\n        } else if (this.members[from] === undefined) {\r\n            // new participant\r\n            this.members[from] = member;\r\n            logger.log('entered', from, member);\r\n            hasStatusUpdate = member.status !== undefined;\r\n            hasVersionUpdate = member.version !== undefined;\r\n            if (member.isFocus) {\r\n                this._initFocus(from, member.features);\r\n            } else {\r\n                // identity is being added to member joined, so external\r\n                // services can be notified for that (currently identity is\r\n                // not used inside library)\r\n                this.eventEmitter.emit(\r\n                    XMPPEvents.MUC_MEMBER_JOINED,\r\n                    from,\r\n                    member.nick,\r\n                    member.role,\r\n                    member.isHiddenDomain,\r\n                    member.statsID,\r\n                    member.status,\r\n                    member.identity,\r\n                    member.botType,\r\n                    member.jid,\r\n                    member.features);\r\n\r\n                // we are reporting the status with the join\r\n                // so we do not want a second event about status update\r\n                hasStatusUpdate = false;\r\n            }\r\n        } else {\r\n            // Presence update for existing participant\r\n            // Watch role change:\r\n            const memberOfThis = this.members[from];\r\n\r\n            if (memberOfThis.role !== member.role) {\r\n                memberOfThis.role = member.role;\r\n                this.eventEmitter.emit(\r\n                    XMPPEvents.MUC_ROLE_CHANGED, from, member.role);\r\n            }\r\n\r\n            // affiliation changed\r\n            if (memberOfThis.affiliation !== member.affiliation) {\r\n                memberOfThis.affiliation = member.affiliation;\r\n            }\r\n\r\n            // fire event that botType had changed\r\n            if (memberOfThis.botType !== member.botType) {\r\n                memberOfThis.botType = member.botType;\r\n                this.eventEmitter.emit(\r\n                    XMPPEvents.MUC_MEMBER_BOT_TYPE_CHANGED,\r\n                    from,\r\n                    member.botType);\r\n            }\r\n\r\n            if (member.isFocus) {\r\n                // From time to time first few presences of the focus are not\r\n                // containing it's jid. That way we can mark later the focus\r\n                // member instead of not marking it at all and not starting the\r\n                // conference.\r\n                // FIXME: Maybe there is a better way to handle this issue. It\r\n                // seems there is some period of time in prosody that the\r\n                // configuration form is received but not applied. And if any\r\n                // participant joins during that period of time the first\r\n                // presence from the focus won't contain\r\n                // <item jid=\"focus...\" />.\r\n                // By default we are disabling the waiting for form submission in order to use the room\r\n                // and we had enabled by default that jids are public in the room ,\r\n                // so this case should not happen, if public jid is turned off we will receive the jid\r\n                // when we become moderator in the room\r\n                memberOfThis.isFocus = true;\r\n                this._initFocus(from, member.features);\r\n            }\r\n\r\n            // store the new display name\r\n            if (member.displayName) {\r\n                memberOfThis.displayName = member.displayName;\r\n            }\r\n\r\n            // update stored status message to be able to detect changes\r\n            if (memberOfThis.status !== member.status) {\r\n                hasStatusUpdate = true;\r\n                memberOfThis.status = member.status;\r\n            }\r\n\r\n            if (memberOfThis.version !== member.version) {\r\n                hasVersionUpdate = true;\r\n                memberOfThis.version = member.version;\r\n            }\r\n\r\n            if (!isEqual(memberOfThis.features, member.features)) {\r\n                memberOfThis.features = member.features;\r\n                this.eventEmitter.emit(XMPPEvents.PARTICIPANT_FEATURES_CHANGED, from, member.features);\r\n            }\r\n        }\r\n\r\n        // after we had fired member or room joined events, lets fire events\r\n        // for the rest info we got in presence\r\n        for (let i = 0; i < nodes.length; i++) {\r\n            const node = nodes[i];\r\n\r\n            switch (node.tagName) {\r\n            case 'nick':\r\n                if (!member.isFocus) {\r\n                    const displayName\r\n                        = this.xmpp.options.displayJids\r\n                            ? Strophe.getResourceFromJid(from)\r\n                            : member.nick;\r\n\r\n                    this.eventEmitter.emit(\r\n                        XMPPEvents.DISPLAY_NAME_CHANGED,\r\n                        from,\r\n                        displayName);\r\n                }\r\n                break;\r\n            case 'bridgeNotAvailable':\r\n                if (member.isFocus && !this.noBridgeAvailable) {\r\n                    this.noBridgeAvailable = true;\r\n                    this.eventEmitter.emit(XMPPEvents.BRIDGE_DOWN);\r\n                }\r\n                break;\r\n            case 'conference-properties':\r\n                if (member.isFocus) {\r\n                    const properties = {};\r\n\r\n                    for (let j = 0; j < node.children.length; j++) {\r\n                        const { attributes } = node.children[j];\r\n\r\n                        if (attributes && attributes.key) {\r\n                            properties[attributes.key] = attributes.value;\r\n                        }\r\n                    }\r\n\r\n                    this.eventEmitter.emit(\r\n                        XMPPEvents.CONFERENCE_PROPERTIES_CHANGED, properties);\r\n\r\n                    this.restartByTerminateSupported = properties['support-terminate-restart'] === 'true';\r\n                    logger.info(`Jicofo supports restart by terminate: ${this.supportsRestartByTerminate()}`);\r\n                }\r\n                break;\r\n            case 'transcription-status': {\r\n                const { attributes } = node;\r\n\r\n                if (!attributes) {\r\n                    break;\r\n                }\r\n\r\n                const { status } = attributes;\r\n\r\n                if (status && status !== this.transcriptionStatus) {\r\n                    this.transcriptionStatus = status;\r\n                    this.eventEmitter.emit(\r\n                        XMPPEvents.TRANSCRIPTION_STATUS_CHANGED,\r\n                        status\r\n                    );\r\n                }\r\n\r\n\r\n                break;\r\n            }\r\n            case 'call-control': {\r\n                const att = node.attributes;\r\n\r\n                if (!att) {\r\n                    break;\r\n                }\r\n                this.phoneNumber = att.phone || null;\r\n                this.phonePin = att.pin || null;\r\n                this.eventEmitter.emit(XMPPEvents.PHONE_NUMBER_CHANGED);\r\n                break;\r\n            }\r\n            default:\r\n                this.processNode(node, from);\r\n            }\r\n        }\r\n\r\n        // Trigger status message update if necessary\r\n        if (hasStatusUpdate) {\r\n            this.eventEmitter.emit(\r\n                XMPPEvents.PRESENCE_STATUS,\r\n                from,\r\n                member.status);\r\n        }\r\n\r\n        if (hasVersionUpdate) {\r\n            logger.info(`Received version for ${jid}: ${member.version}`);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Extracts the features from the presence.\r\n     * @param node the node to process.\r\n     * @return features the Set of features where extracted data is added.\r\n     * @private\r\n     */\r\n    _extractFeatures(node) {\r\n        const features = new Set();\r\n\r\n        for (let j = 0; j < node.children.length; j++) {\r\n            const { attributes } = node.children[j];\r\n\r\n            if (attributes && attributes.var) {\r\n                features.add(attributes.var);\r\n            }\r\n        }\r\n\r\n        return features;\r\n    }\r\n\r\n    /**\r\n     * Initialize some properties when the focus participant is verified.\r\n     * @param from jid of the focus\r\n     * @param features the features reported in jicofo presence\r\n     */\r\n    _initFocus(from, features) {\r\n        this.focusMucJid = from;\r\n        this.focusFeatures = features;\r\n    }\r\n\r\n    /**\r\n     * Sets the special listener to be used for \"command\"s whose name starts\r\n     * with \"jitsi_participant_\".\r\n     */\r\n    setParticipantPropertyListener(listener) {\r\n        this.participantPropertyListener = listener;\r\n    }\r\n\r\n    /**\r\n     * Checks if Jicofo supports restarting Jingle session after 'session-terminate'.\r\n     * @returns {boolean}\r\n     */\r\n    supportsRestartByTerminate() {\r\n        return this.restartByTerminateSupported;\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param node\r\n     * @param from\r\n     */\r\n    processNode(node, from) {\r\n        // make sure we catch all errors coming from any handler\r\n        // otherwise we can remove the presence handler from strophe\r\n        try {\r\n            let tagHandlers = this.presHandlers[node.tagName];\r\n\r\n            if (node.tagName.startsWith('jitsi_participant_')) {\r\n                tagHandlers = [ this.participantPropertyListener ];\r\n            }\r\n\r\n            if (tagHandlers) {\r\n                tagHandlers.forEach(handler => {\r\n                    handler(node, Strophe.getResourceFromJid(from), from);\r\n                });\r\n            }\r\n        } catch (e) {\r\n            GlobalOnErrorHandler.callErrorHandler(e);\r\n            logger.error(`Error processing:${node.tagName} node.`, e);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Send text message to the other participants in the conference\r\n     * @param message\r\n     * @param elementName\r\n     */\r\n    sendMessage(message, elementName) {\r\n        const msg = $msg({ to: this.roomjid,\r\n            type: 'groupchat' });\r\n\r\n        // We are adding the message in a packet extension. If this element\r\n        // is different from 'body', we add a custom namespace.\r\n        // e.g. for 'json-message' extension of message stanza.\r\n        if (elementName === 'body') {\r\n            msg.c(elementName, {}, message);\r\n        } else {\r\n            msg.c(elementName, { xmlns: 'http://jitsi.org/jitmeet' }, message);\r\n        }\r\n\r\n        this.connection.send(msg);\r\n        this.eventEmitter.emit(XMPPEvents.SENDING_CHAT_MESSAGE, message);\r\n    }\r\n\r\n    /* eslint-disable max-params */\r\n    /**\r\n     * Send private text message to another participant of the conference\r\n     * @param id id/muc resource of the receiver\r\n     * @param message\r\n     * @param elementName\r\n     */\r\n    sendPrivateMessage(id, message, elementName) {\r\n        const msg = $msg({ to: `${this.roomjid}/${id}`,\r\n            type: 'chat' });\r\n\r\n        // We are adding the message in packet. If this element is different\r\n        // from 'body', we add our custom namespace for the same.\r\n        // e.g. for 'json-message' message extension.\r\n        if (elementName === 'body') {\r\n            msg.c(elementName, message).up();\r\n        } else {\r\n            msg.c(elementName, { xmlns: 'http://jitsi.org/jitmeet' }, message)\r\n                .up();\r\n        }\r\n\r\n        this.connection.send(msg);\r\n        this.eventEmitter.emit(\r\n            XMPPEvents.SENDING_PRIVATE_CHAT_MESSAGE, message);\r\n    }\r\n    /* eslint-enable max-params */\r\n\r\n    /**\r\n     *\r\n     * @param subject\r\n     */\r\n    setSubject(subject) {\r\n        const msg = $msg({ to: this.roomjid,\r\n            type: 'groupchat' });\r\n\r\n        msg.c('subject', subject);\r\n        this.connection.send(msg);\r\n    }\r\n\r\n    /**\r\n     * Called when participant leaves.\r\n     * @param jid the jid of the participant that leaves\r\n     * @param skipEvents optional params to skip any events, including check\r\n     * whether this is the focus that left\r\n     */\r\n    onParticipantLeft(jid, skipEvents) {\r\n        delete this.lastPresences[jid];\r\n\r\n        if (skipEvents) {\r\n            return;\r\n        }\r\n\r\n        this.eventEmitter.emit(XMPPEvents.MUC_MEMBER_LEFT, jid);\r\n\r\n        this.moderator.onMucMemberLeft(jid);\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param pres\r\n     * @param from\r\n     */\r\n    onPresenceUnavailable(pres, from) {\r\n        // ignore presence\r\n        if ($(pres).find('>ignore[xmlns=\"http://jitsi.org/jitmeet/\"]').length) {\r\n            return true;\r\n        }\r\n\r\n        // room destroyed ?\r\n        const destroySelect = $(pres).find('>x[xmlns=\"http://jabber.org/protocol/muc#user\"]>destroy');\r\n\r\n        if (destroySelect.length) {\r\n            let reason;\r\n            const reasonSelect\r\n                = $(pres).find(\r\n                    '>x[xmlns=\"http://jabber.org/protocol/muc#user\"]'\r\n                        + '>destroy>reason');\r\n\r\n            if (reasonSelect.length) {\r\n                reason = reasonSelect.text();\r\n            }\r\n\r\n            this.eventEmitter.emit(XMPPEvents.MUC_DESTROYED, reason, destroySelect.attr('jid'));\r\n            this.connection.emuc.doLeave(this.roomjid);\r\n\r\n            return true;\r\n        }\r\n\r\n        // Status code 110 indicates that this notification is \"self-presence\".\r\n        const isSelfPresence\r\n            = $(pres)\r\n                .find(\r\n                    '>x[xmlns=\"http://jabber.org/protocol/muc#user\"]>'\r\n                        + 'status[code=\"110\"]')\r\n                .length;\r\n        const isKick\r\n            = $(pres)\r\n                .find(\r\n                    '>x[xmlns=\"http://jabber.org/protocol/muc#user\"]'\r\n                        + '>status[code=\"307\"]')\r\n                .length;\r\n        const membersKeys = Object.keys(this.members);\r\n\r\n        if (isKick) {\r\n            const actorSelect\r\n                = $(pres)\r\n                .find('>x[xmlns=\"http://jabber.org/protocol/muc#user\"]>item>actor');\r\n\r\n            let actorNick;\r\n\r\n            if (actorSelect.length) {\r\n                actorNick = actorSelect.attr('nick');\r\n            }\r\n\r\n            let reason;\r\n            const reasonSelect\r\n                = $(pres).find(\r\n                '>x[xmlns=\"http://jabber.org/protocol/muc#user\"]'\r\n                + '>item>reason');\r\n\r\n            if (reasonSelect.length) {\r\n                reason = reasonSelect.text();\r\n            }\r\n\r\n            // we first fire the kicked so we can show the participant\r\n            // who kicked, before notifying that participant left\r\n            // we fire kicked for us and for any participant kicked\r\n            this.eventEmitter.emit(\r\n                XMPPEvents.KICKED,\r\n                isSelfPresence,\r\n                actorNick,\r\n                Strophe.getResourceFromJid(from),\r\n                reason);\r\n        }\r\n\r\n        if (isSelfPresence) {\r\n            // If the status code is 110 this means we're leaving and we would\r\n            // like to remove everyone else from our view, so we trigger the\r\n            // event.\r\n            membersKeys.forEach(jid => {\r\n                const member = this.members[jid];\r\n\r\n                delete this.members[jid];\r\n                this.onParticipantLeft(jid, member.isFocus);\r\n            });\r\n            this.connection.emuc.doLeave(this.roomjid);\r\n\r\n            // we fire muc_left only if this is not a kick,\r\n            // kick has both statuses 110 and 307.\r\n            if (!isKick) {\r\n                this.eventEmitter.emit(XMPPEvents.MUC_LEFT);\r\n            }\r\n        } else {\r\n            delete this.members[from];\r\n            this.onParticipantLeft(from, false);\r\n        }\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param msg\r\n     * @param from\r\n     */\r\n    onMessage(msg, from) {\r\n        const type = msg.getAttribute('type');\r\n\r\n        if (type === 'error') {\r\n            const errorMsg = $(msg).find('>error>text').text();\r\n\r\n            this.eventEmitter.emit(XMPPEvents.CHAT_ERROR_RECEIVED, errorMsg);\r\n\r\n            return true;\r\n        }\r\n\r\n        const txt = $(msg).find('>body').text();\r\n        const subject = $(msg).find('>subject');\r\n\r\n        if (subject.length) {\r\n            const subjectText = subject.text();\r\n\r\n            if (subjectText || subjectText === '') {\r\n                this.eventEmitter.emit(XMPPEvents.SUBJECT_CHANGED, subjectText);\r\n                logger.log(`Subject is changed to ${subjectText}`);\r\n            }\r\n        }\r\n\r\n        // xep-0203 delay\r\n        let stamp = $(msg).find('>delay').attr('stamp');\r\n\r\n        if (!stamp) {\r\n            // or xep-0091 delay, UTC timestamp\r\n            stamp = $(msg).find('>[xmlns=\"jabber:x:delay\"]').attr('stamp');\r\n\r\n            if (stamp) {\r\n                // the format is CCYYMMDDThh:mm:ss\r\n                const dateParts\r\n                    = stamp.match(/(\\d{4})(\\d{2})(\\d{2}T\\d{2}:\\d{2}:\\d{2})/);\r\n\r\n                stamp = `${dateParts[1]}-${dateParts[2]}-${dateParts[3]}Z`;\r\n            }\r\n        }\r\n\r\n        if (from === this.roomjid) {\r\n            let invite;\r\n\r\n            if ($(msg).find('>x[xmlns=\"http://jabber.org/protocol/muc#user\"]>status[code=\"104\"]').length) {\r\n                this.discoRoomInfo();\r\n            } else if ((invite = $(msg).find('>x[xmlns=\"http://jabber.org/protocol/muc#user\"]>invite'))\r\n                        && invite.length) {\r\n                const passwordSelect = $(msg).find('>x[xmlns=\"http://jabber.org/protocol/muc#user\"]>password');\r\n                let password;\r\n\r\n                if (passwordSelect && passwordSelect.length) {\r\n                    password = passwordSelect.text();\r\n                }\r\n\r\n                this.eventEmitter.emit(XMPPEvents.INVITE_MESSAGE_RECEIVED,\r\n                    from, invite.attr('from'), txt, password);\r\n            }\r\n        }\r\n\r\n        const jsonMessage = $(msg).find('>json-message').text();\r\n\r\n        if (jsonMessage) {\r\n            const parsedJson = this.xmpp.tryParseJSONAndVerify(jsonMessage);\r\n\r\n            // We emit this event if the message is a valid json, and is not\r\n            // delivered after a delay, i.e. stamp is undefined.\r\n            // e.g. - subtitles should not be displayed if delayed.\r\n            if (parsedJson && stamp === undefined) {\r\n                this.eventEmitter.emit(XMPPEvents.JSON_MESSAGE_RECEIVED,\r\n                    from, parsedJson);\r\n\r\n                return;\r\n            }\r\n        }\r\n\r\n        if (txt) {\r\n            if (type === 'chat') {\r\n                this.eventEmitter.emit(XMPPEvents.PRIVATE_MESSAGE_RECEIVED,\r\n                        from, txt, this.myroomjid, stamp);\r\n            } else if (type === 'groupchat') {\r\n                this.eventEmitter.emit(XMPPEvents.MESSAGE_RECEIVED,\r\n                        from, txt, this.myroomjid, stamp);\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param pres\r\n     * @param from\r\n     */\r\n    onPresenceError(pres, from) {\r\n        if ($(pres)\r\n                .find(\r\n                    '>error[type=\"auth\"]'\r\n                        + '>not-authorized['\r\n                        + 'xmlns=\"urn:ietf:params:xml:ns:xmpp-stanzas\"]')\r\n                .length) {\r\n            logger.log('on password required', from);\r\n            this.eventEmitter.emit(XMPPEvents.PASSWORD_REQUIRED);\r\n        } else if ($(pres)\r\n                .find(\r\n                    '>error[type=\"cancel\"]'\r\n                        + '>not-allowed['\r\n                        + 'xmlns=\"urn:ietf:params:xml:ns:xmpp-stanzas\"]')\r\n                .length) {\r\n            const toDomain = Strophe.getDomainFromJid(pres.getAttribute('to'));\r\n\r\n            if (toDomain === this.xmpp.options.hosts.anonymousdomain) {\r\n                // enter the room by replying with 'not-authorized'. This would\r\n                // result in reconnection from authorized domain.\r\n                // We're either missing Jicofo/Prosody config for anonymous\r\n                // domains or something is wrong.\r\n                this.eventEmitter.emit(XMPPEvents.ROOM_JOIN_ERROR);\r\n\r\n            } else {\r\n                logger.warn('onPresError ', pres);\r\n                this.eventEmitter.emit(\r\n                    XMPPEvents.ROOM_CONNECT_NOT_ALLOWED_ERROR);\r\n            }\r\n        } else if ($(pres).find('>error>service-unavailable').length) {\r\n            logger.warn('Maximum users limit for the room has been reached',\r\n                pres);\r\n            this.eventEmitter.emit(XMPPEvents.ROOM_MAX_USERS_ERROR);\r\n        } else if ($(pres)\r\n            .find(\r\n                '>error[type=\"auth\"]'\r\n                + '>registration-required['\r\n                + 'xmlns=\"urn:ietf:params:xml:ns:xmpp-stanzas\"]').length) {\r\n\r\n            // let's extract the lobby jid from the custom field\r\n            const lobbyRoomNode = $(pres).find('>lobbyroom');\r\n            let lobbyRoomJid;\r\n\r\n            if (lobbyRoomNode.length) {\r\n                lobbyRoomJid = lobbyRoomNode.text();\r\n            }\r\n\r\n            this.eventEmitter.emit(XMPPEvents.ROOM_CONNECT_MEMBERS_ONLY_ERROR, lobbyRoomJid);\r\n        } else {\r\n            logger.warn('onPresError ', pres);\r\n            this.eventEmitter.emit(XMPPEvents.ROOM_CONNECT_ERROR);\r\n        }\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param jid\r\n     * @param affiliation\r\n     */\r\n    setAffiliation(jid, affiliation) {\r\n        const grantIQ = $iq({\r\n            to: this.roomjid,\r\n            type: 'set'\r\n        })\r\n        .c('query', { xmlns: 'http://jabber.org/protocol/muc#admin' })\r\n        .c('item', {\r\n            affiliation,\r\n            nick: Strophe.getResourceFromJid(jid)\r\n        })\r\n        .c('reason').t(`Your affiliation has been changed to '${affiliation}'.`)\r\n        .up().up().up();\r\n\r\n        this.connection.sendIQ(\r\n            grantIQ,\r\n            result => logger.log('Set affiliation of participant with jid: ', jid, 'to', affiliation, result),\r\n            error => logger.log('Set affiliation of participant error: ', error));\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param jid\r\n     * @param reason\r\n     */\r\n    kick(jid, reason = 'You have been kicked.') {\r\n        const kickIQ = $iq({ to: this.roomjid,\r\n            type: 'set' })\r\n            .c('query', { xmlns: 'http://jabber.org/protocol/muc#admin' })\r\n            .c('item', { nick: Strophe.getResourceFromJid(jid),\r\n                role: 'none' })\r\n            .c('reason').t(reason).up().up().up();\r\n\r\n        this.connection.sendIQ(\r\n            kickIQ,\r\n            result => logger.log('Kick participant with jid: ', jid, result),\r\n            error => logger.log('Kick participant error: ', error));\r\n    }\r\n\r\n    /* eslint-disable max-params */\r\n\r\n    /**\r\n     *\r\n     * @param key\r\n     * @param onSuccess\r\n     * @param onError\r\n     * @param onNotSupported\r\n     */\r\n    lockRoom(key, onSuccess, onError, onNotSupported) {\r\n        // http://xmpp.org/extensions/xep-0045.html#roomconfig\r\n        this.connection.sendIQ(\r\n            $iq({\r\n                to: this.roomjid,\r\n                type: 'get'\r\n            })\r\n                .c('query', { xmlns: 'http://jabber.org/protocol/muc#owner' }),\r\n            res => {\r\n                if ($(res)\r\n                        .find(\r\n                            '>query>x[xmlns=\"jabber:x:data\"]'\r\n                                + '>field[var=\"muc#roomconfig_roomsecret\"]')\r\n                        .length) {\r\n                    const formsubmit\r\n                        = $iq({\r\n                            to: this.roomjid,\r\n                            type: 'set'\r\n                        })\r\n                            .c('query', {\r\n                                xmlns: 'http://jabber.org/protocol/muc#owner'\r\n                            });\r\n\r\n                    formsubmit.c('x', {\r\n                        xmlns: 'jabber:x:data',\r\n                        type: 'submit'\r\n                    });\r\n                    formsubmit\r\n                        .c('field', { 'var': 'FORM_TYPE' })\r\n                        .c('value')\r\n                        .t('http://jabber.org/protocol/muc#roomconfig')\r\n                        .up()\r\n                        .up();\r\n                    formsubmit\r\n                        .c('field', { 'var': 'muc#roomconfig_roomsecret' })\r\n                        .c('value')\r\n                        .t(key)\r\n                        .up()\r\n                        .up();\r\n                    formsubmit\r\n                        .c('field',\r\n                             { 'var': 'muc#roomconfig_passwordprotectedroom' })\r\n                        .c('value')\r\n                        .t(key === null || key.length === 0 ? '0' : '1')\r\n                        .up()\r\n                        .up();\r\n\r\n                    // if members only enabled\r\n                    if (this.membersOnlyEnabled) {\r\n                        formsubmit\r\n                            .c('field', { 'var': 'muc#roomconfig_membersonly' })\r\n                            .c('value')\r\n                            .t('true')\r\n                            .up()\r\n                            .up();\r\n                    }\r\n\r\n                    // Fixes a bug in prosody 0.9.+\r\n                    // https://prosody.im/issues/issue/373\r\n                    formsubmit\r\n                        .c('field', { 'var': 'muc#roomconfig_whois' })\r\n                        .c('value')\r\n                        .t('anyone')\r\n                        .up()\r\n                        .up();\r\n\r\n                    this.connection.sendIQ(\r\n                        formsubmit,\r\n                        () => {\r\n\r\n                            // we set the password in chat room so we can use it\r\n                            // later when dialing out\r\n                            this.password = key;\r\n                            onSuccess();\r\n                        },\r\n                        onError);\r\n                } else {\r\n                    onNotSupported();\r\n                }\r\n            },\r\n            onError);\r\n    }\r\n\r\n    /* eslint-enable max-params */\r\n\r\n    /**\r\n     * Turns off or on the members only config for the main room.\r\n     *\r\n     * @param {boolean} enabled - Whether to turn it on or off.\r\n     * @param onSuccess - optional callback.\r\n     * @param onError - optional callback.\r\n     */\r\n    setMembersOnly(enabled, onSuccess, onError) {\r\n        if (enabled && Object.values(this.members).filter(m => !m.isFocus).length) {\r\n            // first grant membership to all that are in the room\r\n            // currently there is a bug in prosody where it handles only the first item\r\n            // that's why we will send iq per member\r\n            Object.values(this.members).forEach(m => {\r\n                if (m.jid && !MEMBERS_AFFILIATIONS.includes(m.affiliation)) {\r\n                    this.xmpp.connection.sendIQ(\r\n                        $iq({\r\n                            to: this.roomjid,\r\n                            type: 'set' })\r\n                        .c('query', {\r\n                            xmlns: 'http://jabber.org/protocol/muc#admin' })\r\n                        .c('item', {\r\n                            'affiliation': 'member',\r\n                            'jid': m.jid\r\n                        }).up().up());\r\n                }\r\n            });\r\n        }\r\n\r\n        const errorCallback = onError ? onError : () => {}; // eslint-disable-line no-empty-function\r\n\r\n        this.xmpp.connection.sendIQ(\r\n            $iq({\r\n                to: this.roomjid,\r\n                type: 'get'\r\n            }).c('query', { xmlns: 'http://jabber.org/protocol/muc#owner' }),\r\n            res => {\r\n                if ($(res).find('>query>x[xmlns=\"jabber:x:data\"]>field[var=\"muc#roomconfig_membersonly\"]').length) {\r\n                    const formToSubmit\r\n                        = $iq({\r\n                            to: this.roomjid,\r\n                            type: 'set'\r\n                        }).c('query', { xmlns: 'http://jabber.org/protocol/muc#owner' });\r\n\r\n                    formToSubmit.c('x', {\r\n                        xmlns: 'jabber:x:data',\r\n                        type: 'submit'\r\n                    });\r\n                    formToSubmit\r\n                        .c('field', { 'var': 'FORM_TYPE' })\r\n                        .c('value')\r\n                        .t('http://jabber.org/protocol/muc#roomconfig')\r\n                        .up()\r\n                        .up();\r\n                    formToSubmit\r\n                        .c('field', { 'var': 'muc#roomconfig_membersonly' })\r\n                        .c('value')\r\n                        .t(enabled ? 'true' : 'false')\r\n                        .up()\r\n                        .up();\r\n\r\n                    // if room is locked from other participant or we are locking it\r\n                    if (this.locked) {\r\n                        formToSubmit\r\n                            .c('field',\r\n                                { 'var': 'muc#roomconfig_passwordprotectedroom' })\r\n                            .c('value')\r\n                            .t('1')\r\n                            .up()\r\n                            .up();\r\n                    }\r\n\r\n                    this.xmpp.connection.sendIQ(formToSubmit, onSuccess, errorCallback);\r\n                } else {\r\n                    errorCallback(new Error('Setting members only room not supported!'));\r\n                }\r\n            },\r\n            errorCallback);\r\n    }\r\n\r\n    /**\r\n     * Adds the key to the presence map, overriding any previous value.\r\n     * This method is used by jibri.\r\n     *\r\n     * @param key The key to add or replace.\r\n     * @param values The new values.\r\n     * @returns {boolean|null} <tt>true</tt> if the operation succeeded or <tt>false</tt> when no add or replce was\r\n     * performed as the value was already there.\r\n     * @deprecated Use 'addOrReplaceInPresence' instead. TODO: remove it from here and jibri.\r\n     */\r\n    addToPresence(key, values) {\r\n        return this.addOrReplaceInPresence(key, values);\r\n    }\r\n\r\n    /**\r\n     * Adds the key to the presence map, overriding any previous value.\r\n     * @param key The key to add or replace.\r\n     * @param values The new values.\r\n     * @returns {boolean|null} <tt>true</tt> if the operation succeeded or <tt>false</tt> when no add or replace was\r\n     * performed as the value was already there.\r\n     */\r\n    addOrReplaceInPresence(key, values) {\r\n        values.tagName = key;\r\n\r\n        const matchingNodes = this.presMap.nodes.filter(node => key === node.tagName);\r\n\r\n        // if we have found just one, let's check is it the same\r\n        if (matchingNodes.length === 1 && isEqual(matchingNodes[0], values)) {\r\n            return false;\r\n        }\r\n\r\n        this.removeFromPresence(key);\r\n        this.presMap.nodes.push(values);\r\n        this.presenceUpdateTime = Date.now();\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Retrieves a value from the presence map.\r\n     *\r\n     * @param {string} key - The key to find the value for.\r\n     * @returns {Object?}\r\n     */\r\n    getFromPresence(key) {\r\n        return this.presMap.nodes.find(node => key === node.tagName);\r\n    }\r\n\r\n    /**\r\n     * Removes a key from the presence map.\r\n     * @param key\r\n     */\r\n    removeFromPresence(key) {\r\n        const nodes = this.presMap.nodes.filter(node => key !== node.tagName);\r\n\r\n        this.presMap.nodes = nodes;\r\n        this.presenceUpdateTime = Date.now();\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param name\r\n     * @param handler\r\n     */\r\n    addPresenceListener(name, handler) {\r\n        if (typeof handler !== 'function') {\r\n            throw new Error('\"handler\" is not a function');\r\n        }\r\n        let tagHandlers = this.presHandlers[name];\r\n\r\n        if (!tagHandlers) {\r\n            this.presHandlers[name] = tagHandlers = [];\r\n        }\r\n        if (tagHandlers.indexOf(handler) === -1) {\r\n            tagHandlers.push(handler);\r\n        } else {\r\n            logger.warn(\r\n                `Trying to add the same handler more than once for: ${name}`);\r\n        }\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param name\r\n     * @param handler\r\n     */\r\n    removePresenceListener(name, handler) {\r\n        const tagHandlers = this.presHandlers[name];\r\n        const handlerIdx = tagHandlers ? tagHandlers.indexOf(handler) : -1;\r\n\r\n        // eslint-disable-next-line no-negated-condition\r\n        if (handlerIdx !== -1) {\r\n            tagHandlers.splice(handlerIdx, 1);\r\n        } else {\r\n            logger.warn(`Handler for: ${name} was not registered`);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Checks if the user identified by given <tt>mucJid</tt> is the conference\r\n     * focus.\r\n     * @param mucJid the full MUC address of the user to be checked.\r\n     * @returns {boolean|null} <tt>true</tt> if MUC user is the conference focus\r\n     * or <tt>false</tt> if is not. When given <tt>mucJid</tt> does not exist in\r\n     * the MUC then <tt>null</tt> is returned.\r\n     */\r\n    isFocus(mucJid) {\r\n        const member = this.members[mucJid];\r\n\r\n        if (member) {\r\n            return member.isFocus;\r\n        }\r\n\r\n        return null;\r\n    }\r\n\r\n    /**\r\n     *\r\n     */\r\n    isModerator() {\r\n        return this.role === 'moderator';\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param peerJid\r\n     */\r\n    getMemberRole(peerJid) {\r\n        if (this.members[peerJid]) {\r\n            return this.members[peerJid].role;\r\n        }\r\n\r\n        return null;\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param mute\r\n     * @param callback\r\n     */\r\n    setVideoMute(mute, callback) {\r\n        this.sendVideoInfoPresence(mute);\r\n        if (callback) {\r\n            callback(mute);\r\n        }\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param mute\r\n     * @param callback\r\n     */\r\n    setAudioMute(mute, callback) {\r\n        return this.sendAudioInfoPresence(mute, callback);\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param mute\r\n     */\r\n    addAudioInfoToPresence(mute) {\r\n        const audioMutedTagName = 'audiomuted';\r\n\r\n        // we skip adding it as muted is default value\r\n        if (mute && !this.getFromPresence(audioMutedTagName)) {\r\n            return false;\r\n        }\r\n\r\n        return this.addOrReplaceInPresence(\r\n            audioMutedTagName,\r\n            {\r\n                value: mute.toString()\r\n            });\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param mute\r\n     * @param callback\r\n     */\r\n    sendAudioInfoPresence(mute, callback) {\r\n        // FIXME resend presence on CONNECTED\r\n        this.addAudioInfoToPresence(mute) && this.sendPresence();\r\n        if (callback) {\r\n            callback();\r\n        }\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param mute\r\n     */\r\n    addVideoInfoToPresence(mute) {\r\n        const videoMutedTagName = 'videomuted';\r\n\r\n        // we skip adding it as muted is default value\r\n        if (mute && !this.getFromPresence(videoMutedTagName)) {\r\n            return false;\r\n        }\r\n\r\n        return this.addOrReplaceInPresence(\r\n            videoMutedTagName,\r\n            {\r\n                value: mute.toString()\r\n            });\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param mute\r\n     */\r\n    sendVideoInfoPresence(mute) {\r\n        this.addVideoInfoToPresence(mute) && this.sendPresence();\r\n    }\r\n\r\n    /**\r\n     * Obtains the info about given media advertised in the MUC presence of\r\n     * the participant identified by the given endpoint JID.\r\n     * @param {string} endpointId the endpoint ID mapped to the participant\r\n     * which corresponds to MUC nickname.\r\n     * @param {MediaType} mediaType the type of the media for which presence\r\n     * info will be obtained.\r\n     * @return {PeerMediaInfo} presenceInfo an object with media presence\r\n     * info or <tt>null</tt> either if there is no presence available or if\r\n     * the media type given is invalid.\r\n     */\r\n    getMediaPresenceInfo(endpointId, mediaType) {\r\n        // Will figure out current muted status by looking up owner's presence\r\n        const pres = this.lastPresences[`${this.roomjid}/${endpointId}`];\r\n\r\n        if (!pres) {\r\n            // No presence available\r\n            return null;\r\n        }\r\n        const data = {\r\n            muted: true, // muted by default\r\n            videoType: undefined // no video type by default\r\n        };\r\n        let mutedNode = null;\r\n\r\n        if (mediaType === MediaType.AUDIO) {\r\n            mutedNode = filterNodeFromPresenceJSON(pres, 'audiomuted');\r\n        } else if (mediaType === MediaType.VIDEO) {\r\n            mutedNode = filterNodeFromPresenceJSON(pres, 'videomuted');\r\n            const codecTypeNode = filterNodeFromPresenceJSON(pres, 'jitsi_participant_codecType');\r\n            const videoTypeNode = filterNodeFromPresenceJSON(pres, 'videoType');\r\n\r\n            if (videoTypeNode.length > 0) {\r\n                data.videoType = videoTypeNode[0].value;\r\n            }\r\n            if (codecTypeNode.length > 0) {\r\n                data.codecType = codecTypeNode[0].value;\r\n            }\r\n        } else {\r\n            logger.error(`Unsupported media type: ${mediaType}`);\r\n\r\n            return null;\r\n        }\r\n\r\n        if (mutedNode.length > 0) {\r\n            data.muted = mutedNode[0].value === 'true';\r\n        }\r\n\r\n        return data;\r\n    }\r\n\r\n    /**\r\n     * Returns true if the SIP calls are supported and false otherwise\r\n     */\r\n    isSIPCallingSupported() {\r\n        if (this.moderator) {\r\n            return this.moderator.isSipGatewayEnabled();\r\n        }\r\n\r\n        return false;\r\n    }\r\n\r\n    /**\r\n     * Dials a number.\r\n     * @param number the number\r\n     */\r\n    dial(number) {\r\n        return this.connection.rayo.dial(number, 'fromnumber',\r\n            Strophe.getBareJidFromJid(this.myroomjid), this.password,\r\n            this.focusMucJid);\r\n    }\r\n\r\n    /**\r\n     * Hangup an existing call\r\n     */\r\n    hangup() {\r\n        return this.connection.rayo.hangup();\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @returns {Lobby}\r\n     */\r\n    getLobby() {\r\n        return this.lobby;\r\n    }\r\n\r\n    /**\r\n     * @returns {AVModeration}\r\n     */\r\n    getAVModeration() {\r\n        return this.avModeration;\r\n    }\r\n\r\n\r\n    /**\r\n     * Returns the phone number for joining the conference.\r\n     */\r\n    getPhoneNumber() {\r\n        return this.phoneNumber;\r\n    }\r\n\r\n    /**\r\n     * Returns the pin for joining the conference with phone.\r\n     */\r\n    getPhonePin() {\r\n        return this.phonePin;\r\n    }\r\n\r\n    /**\r\n     * Returns the meeting unique ID if any came from backend.\r\n     *\r\n     * @returns {string} - The meeting ID.\r\n     */\r\n    getMeetingId() {\r\n        return this.meetingId;\r\n    }\r\n\r\n    /**\r\n     * Mutes remote participant.\r\n     * @param jid of the participant\r\n     * @param mute\r\n     * @param mediaType\r\n     */\r\n    muteParticipant(jid, mute, mediaType) {\r\n        logger.info('set mute', mute);\r\n        const iqToFocus = $iq(\r\n            { to: this.focusMucJid,\r\n                type: 'set' })\r\n            .c('mute', {\r\n                xmlns: `http://jitsi.org/jitmeet/${mediaType}`,\r\n                jid\r\n            })\r\n            .t(mute.toString())\r\n            .up();\r\n\r\n        this.connection.sendIQ(\r\n            iqToFocus,\r\n            result => logger.log('set mute', result),\r\n            error => logger.log('set mute error', error));\r\n    }\r\n\r\n    /**\r\n     * TODO: Document\r\n     * @param iq\r\n     */\r\n    onMute(iq) {\r\n        const from = iq.getAttribute('from');\r\n\r\n        if (from !== this.focusMucJid) {\r\n            logger.warn('Ignored mute from non focus peer');\r\n\r\n            return;\r\n        }\r\n        const mute = $(iq).find('mute');\r\n\r\n        if (mute.length && mute.text() === 'true') {\r\n            this.eventEmitter.emit(XMPPEvents.AUDIO_MUTED_BY_FOCUS, mute.attr('actor'));\r\n        } else {\r\n            // XXX Why do we support anything but muting? Why do we encode the\r\n            // value in the text of the element? Why do we use a separate XML\r\n            // namespace?\r\n            logger.warn('Ignoring a mute request which does not explicitly '\r\n                + 'specify a positive mute command.');\r\n        }\r\n    }\r\n\r\n    /**\r\n     * TODO: Document\r\n     * @param iq\r\n     */\r\n    onMuteVideo(iq) {\r\n        const from = iq.getAttribute('from');\r\n\r\n        if (from !== this.focusMucJid) {\r\n            logger.warn('Ignored mute from non focus peer');\r\n\r\n            return;\r\n        }\r\n        const mute = $(iq).find('mute');\r\n\r\n        if (mute.length && mute.text() === 'true') {\r\n            this.eventEmitter.emit(XMPPEvents.VIDEO_MUTED_BY_FOCUS, mute.attr('actor'));\r\n        } else {\r\n            // XXX Why do we support anything but muting? Why do we encode the\r\n            // value in the text of the element? Why do we use a separate XML\r\n            // namespace?\r\n            logger.warn('Ignoring a mute request which does not explicitly '\r\n                + 'specify a positive mute command.');\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Clean any listeners or resources, executed on leaving.\r\n     */\r\n    clean() {\r\n        this._removeConnListeners.forEach(remove => remove());\r\n        this._removeConnListeners = [];\r\n\r\n        this.joined = false;\r\n    }\r\n\r\n    /**\r\n     * Leaves the room. Closes the jingle session.\r\n     * @returns {Promise} which is resolved if XMPPEvents.MUC_LEFT is received\r\n     * less than 5s after sending presence unavailable. Otherwise the promise is\r\n     * rejected.\r\n     */\r\n    leave() {\r\n        return new Promise((resolve, reject) => {\r\n            const timeout = setTimeout(() => onMucLeft(true), 5000);\r\n            const eventEmitter = this.eventEmitter;\r\n\r\n            this.clean();\r\n\r\n            /**\r\n             *\r\n             * @param doReject\r\n             */\r\n            function onMucLeft(doReject = false) {\r\n                eventEmitter.removeListener(XMPPEvents.MUC_LEFT, onMucLeft);\r\n                clearTimeout(timeout);\r\n                if (doReject) {\r\n                    // the timeout expired\r\n                    reject(new Error('The timeout for the confirmation about '\r\n                        + 'leaving the room expired.'));\r\n                } else {\r\n                    resolve();\r\n                }\r\n            }\r\n            eventEmitter.on(XMPPEvents.MUC_LEFT, onMucLeft);\r\n            this.doLeave();\r\n        });\r\n    }\r\n}\r\n\r\n/* eslint-enable newline-per-chained-call */\r\n","import { getLogger } from 'jitsi-meet-logger';\r\nimport { $msg } from 'strophe.js';\r\n\r\nimport * as MediaType from '../../service/RTC/MediaType';\r\nimport XMPPEvents from '../../service/xmpp/XMPPEvents';\r\n\r\nconst logger = getLogger(__filename);\r\n\r\n/**\r\n * The AVModeration logic.\r\n */\r\nexport default class AVModeration {\r\n\r\n    /**\r\n     * Constructs AV moderation room.\r\n     *\r\n     * @param {ChatRoom} room the main room.\r\n     */\r\n    constructor(room) {\r\n        this._xmpp = room.xmpp;\r\n\r\n        this._mainRoom = room;\r\n\r\n        this._momderationEnabledByType = {\r\n            [MediaType.AUDIO]: false,\r\n            [MediaType.VIDEO]: false\r\n        };\r\n\r\n        this._whitelistAudio = [];\r\n        this._whitelistVideo = [];\r\n\r\n        this._xmpp.addListener(XMPPEvents.AV_MODERATION_RECEIVED, this._onMessage.bind(this));\r\n    }\r\n\r\n    /**\r\n     * Whether AV moderation is supported on backend.\r\n     *\r\n     * @returns {boolean} whether AV moderation is supported on backend.\r\n     */\r\n    isSupported() {\r\n        return Boolean(this._xmpp.avModerationComponentAddress);\r\n    }\r\n\r\n    /**\r\n     * Enables or disables AV Moderation by sending a msg with command to the component.\r\n     */\r\n    enable(state, mediaType) {\r\n        if (!this.isSupported() || !this._mainRoom.isModerator()) {\r\n            logger.error(`Cannot enable:${state} AV moderation supported:${this.isSupported()}, \r\n                moderator:${this._mainRoom.isModerator()}`);\r\n\r\n            return;\r\n        }\r\n\r\n        if (state === this._momderationEnabledByType[mediaType]) {\r\n            logger.warn(`Moderation already in state:${state} for mediaType:${mediaType}`);\r\n\r\n            return;\r\n        }\r\n\r\n        // send the enable/disable message\r\n        const msg = $msg({ to: this._xmpp.avModerationComponentAddress });\r\n\r\n        msg.c('av_moderation', {\r\n            enable: state,\r\n            mediaType\r\n        }).up();\r\n\r\n        this._xmpp.connection.send(msg);\r\n    }\r\n\r\n    /**\r\n     * Approves that a participant can unmute by sending a msg with its jid to the component.\r\n     */\r\n    approve(mediaType, jid) {\r\n        if (!this.isSupported() || !this._mainRoom.isModerator()) {\r\n            logger.error(`Cannot approve in AV moderation supported:${this.isSupported()}, \r\n                moderator:${this._mainRoom.isModerator()}`);\r\n\r\n            return;\r\n        }\r\n\r\n        // send a message to whitelist the jid and approve it to unmute\r\n        const msg = $msg({ to: this._xmpp.avModerationComponentAddress });\r\n\r\n        msg.c('av_moderation', {\r\n            mediaType,\r\n            jidToWhitelist: jid }).up();\r\n\r\n        this._xmpp.connection.send(msg);\r\n    }\r\n\r\n    /**\r\n     * Receives av_moderation parsed messages as json.\r\n     * @param obj the parsed json content of the message to process.\r\n     * @private\r\n     */\r\n    _onMessage(obj) {\r\n        const newWhitelists = obj.whitelists;\r\n\r\n        if (newWhitelists) {\r\n            const fireEventApprovedJids = (mediaType, oldList, newList) => {\r\n                newList.filter(x => !oldList.includes(x))\r\n                    .forEach(jid => this._xmpp.eventEmitter\r\n                        .emit(XMPPEvents.AV_MODERATION_PARTICIPANT_APPROVED, mediaType, jid));\r\n            };\r\n\r\n            if (newWhitelists[MediaType.AUDIO]) {\r\n                fireEventApprovedJids(MediaType.AUDIO, this._whitelistAudio, newWhitelists[MediaType.AUDIO]);\r\n            }\r\n\r\n            if (newWhitelists[MediaType.VIDEO]) {\r\n                fireEventApprovedJids(MediaType.VIDEO, this._whitelistVideo, newWhitelists[MediaType.VIDEO]);\r\n            }\r\n        } else if (obj.enabled !== undefined && this._momderationEnabledByType[obj.mediaType] !== obj.enabled) {\r\n            this._momderationEnabledByType[obj.mediaType] = obj.enabled;\r\n\r\n            this._xmpp.eventEmitter.emit(XMPPEvents.AV_MODERATION_CHANGED, obj.enabled, obj.mediaType, obj.actor);\r\n        } else if (obj.approved) {\r\n            this._xmpp.eventEmitter.emit(XMPPEvents.AV_MODERATION_APPROVED, obj.mediaType);\r\n        }\r\n    }\r\n}\r\n","import { getLogger } from 'jitsi-meet-logger';\r\nimport { $msg, Strophe } from 'strophe.js';\r\n\r\nimport XMPPEvents from '../../service/xmpp/XMPPEvents';\r\n\r\nconst logger = getLogger(__filename);\r\n\r\n/**\r\n * The command type for updating a lobby participant's e-mail address.\r\n *\r\n * @type {string}\r\n */\r\nconst EMAIL_COMMAND = 'email';\r\n\r\n/**\r\n * The Lobby room implementation. Setting a room to members only, joining the lobby room\r\n * approving or denying access to participants from the lobby room.\r\n */\r\nexport default class Lobby {\r\n\r\n    /**\r\n     * Constructs lobby room.\r\n     *\r\n     * @param {ChatRoom} room the main room.\r\n     */\r\n    constructor(room) {\r\n        this.xmpp = room.xmpp;\r\n        this.mainRoom = room;\r\n\r\n        const maybeJoinLobbyRoom = this._maybeJoinLobbyRoom.bind(this);\r\n\r\n        this.mainRoom.addEventListener(\r\n            XMPPEvents.LOCAL_ROLE_CHANGED,\r\n            maybeJoinLobbyRoom);\r\n\r\n        this.mainRoom.addEventListener(\r\n            XMPPEvents.MUC_MEMBERS_ONLY_CHANGED,\r\n            maybeJoinLobbyRoom);\r\n\r\n        this.mainRoom.addEventListener(\r\n            XMPPEvents.ROOM_CONNECT_MEMBERS_ONLY_ERROR,\r\n            jid => {\r\n                this.lobbyRoomJid = jid;\r\n            });\r\n    }\r\n\r\n    /**\r\n     * Whether lobby is supported on backend.\r\n     *\r\n     * @returns {boolean} whether lobby is supported on backend.\r\n     */\r\n    isSupported() {\r\n        return this.xmpp.lobbySupported;\r\n    }\r\n\r\n    /**\r\n     * Enables lobby by setting the main room to be members only and joins the lobby chat room.\r\n     *\r\n     * @returns {Promise}\r\n     */\r\n    enable() {\r\n        if (!this.isSupported()) {\r\n            return Promise.reject(new Error('Lobby not supported!'));\r\n        }\r\n\r\n        return new Promise((resolve, reject) => {\r\n            this.mainRoom.setMembersOnly(true, resolve, reject);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Disable lobby by setting the main room to be non members only and levaes the lobby chat room if joined.\r\n     *\r\n     * @returns {void}\r\n     */\r\n    disable() {\r\n        if (!this.isSupported() || !this.mainRoom.isModerator()\r\n                || !this.lobbyRoom || !this.mainRoom.membersOnlyEnabled) {\r\n            return;\r\n        }\r\n\r\n        this.mainRoom.setMembersOnly(false);\r\n    }\r\n\r\n    /**\r\n     * Leaves the lobby room.\r\n     * @private\r\n     */\r\n    _leaveLobbyRoom() {\r\n        if (this.lobbyRoom) {\r\n            this.lobbyRoom.leave()\r\n                .then(() => {\r\n                    this.lobbyRoom = undefined;\r\n                    logger.info('Lobby room left!');\r\n                })\r\n                .catch(() => {}); // eslint-disable-line no-empty-function\r\n        }\r\n    }\r\n\r\n    /**\r\n     * We had received a jid for the lobby room.\r\n     *\r\n     * @param jid the lobby room jid to join.\r\n     */\r\n    setLobbyRoomJid(jid) {\r\n        this.lobbyRoomJid = jid;\r\n    }\r\n\r\n    /**\r\n     * Checks the state of mainRoom, lobbyRoom and current user role to decide whether to join lobby room.\r\n     * @private\r\n     */\r\n    _maybeJoinLobbyRoom() {\r\n        if (!this.isSupported()) {\r\n            return;\r\n        }\r\n\r\n        const isModerator = this.mainRoom.joined && this.mainRoom.isModerator();\r\n\r\n        if (isModerator && this.mainRoom.membersOnlyEnabled && !this.lobbyRoom) {\r\n            // join the lobby\r\n            this.join()\r\n                .then(() => logger.info('Joined lobby room'))\r\n                .catch(e => logger.error('Failed joining lobby', e));\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Joins a lobby room setting display name and eventually avatar(using the email provided).\r\n     *\r\n     * @param {string} username is required.\r\n     * @param {string} email is optional.\r\n     * @returns {Promise} resolves once we join the room.\r\n     */\r\n    join(displayName, email) {\r\n        const isModerator = this.mainRoom.joined && this.mainRoom.isModerator();\r\n\r\n        if (!this.lobbyRoomJid) {\r\n            return Promise.reject(new Error('Missing lobbyRoomJid, cannot join lobby room.'));\r\n        }\r\n\r\n        const roomName = Strophe.getNodeFromJid(this.lobbyRoomJid);\r\n        const customDomain = Strophe.getDomainFromJid(this.lobbyRoomJid);\r\n\r\n        this.lobbyRoom = this.xmpp.createRoom(\r\n            roomName, {\r\n                customDomain,\r\n                disableDiscoInfo: true,\r\n                disableFocus: true,\r\n                enableLobby: false\r\n            }\r\n        );\r\n\r\n        if (displayName) {\r\n            // remove previously set nickname\r\n            this.lobbyRoom.addOrReplaceInPresence('nick', {\r\n                attributes: { xmlns: 'http://jabber.org/protocol/nick' },\r\n                value: displayName\r\n            });\r\n        }\r\n\r\n        if (isModerator) {\r\n            this.lobbyRoom.addPresenceListener(EMAIL_COMMAND, (node, from) => {\r\n                this.mainRoom.eventEmitter.emit(XMPPEvents.MUC_LOBBY_MEMBER_UPDATED, from, { email: node.value });\r\n            });\r\n            this.lobbyRoom.addEventListener(\r\n                XMPPEvents.MUC_MEMBER_JOINED,\r\n                // eslint-disable-next-line max-params\r\n                (from, nick, role, isHiddenDomain, statsID, status, identity, botType, jid) => {\r\n                    // we need to ignore joins on lobby for participants that are already in the main room\r\n                    if (Object.values(this.mainRoom.members).find(m => m.jid === jid)) {\r\n                        return;\r\n                    }\r\n\r\n                    // we emit the new event on the main room so we can propagate\r\n                    // events to the conference\r\n                    this.mainRoom.eventEmitter.emit(\r\n                        XMPPEvents.MUC_LOBBY_MEMBER_JOINED,\r\n                        Strophe.getResourceFromJid(from),\r\n                        nick,\r\n                        identity ? identity.avatar : undefined\r\n                    );\r\n                });\r\n            this.lobbyRoom.addEventListener(\r\n                XMPPEvents.MUC_MEMBER_LEFT, from => {\r\n                    // we emit the new event on the main room so we can propagate\r\n                    // events to the conference\r\n                    this.mainRoom.eventEmitter.emit(\r\n                        XMPPEvents.MUC_LOBBY_MEMBER_LEFT,\r\n                        Strophe.getResourceFromJid(from)\r\n                    );\r\n                });\r\n            this.lobbyRoom.addEventListener(\r\n                XMPPEvents.MUC_DESTROYED,\r\n                () => {\r\n                    // let's make sure we emit that all lobby users had left\r\n                    Object.keys(this.lobbyRoom.members)\r\n                        .forEach(j => this.mainRoom.eventEmitter.emit(\r\n                            XMPPEvents.MUC_LOBBY_MEMBER_LEFT, Strophe.getResourceFromJid(j)));\r\n\r\n                    this.lobbyRoom.clean();\r\n\r\n                    this.lobbyRoom = undefined;\r\n                    logger.info('Lobby room left(destroyed)!');\r\n                });\r\n        } else {\r\n            // this should only be handled by those waiting in lobby\r\n            this.lobbyRoom.addEventListener(XMPPEvents.KICKED, isSelfPresence => {\r\n                if (isSelfPresence) {\r\n                    this.mainRoom.eventEmitter.emit(XMPPEvents.MUC_DENIED_ACCESS);\r\n\r\n                    this.lobbyRoom.clean();\r\n\r\n                    return;\r\n                }\r\n            });\r\n\r\n            // As there is still reference of the main room\r\n            // the invite will be detected and addressed to its eventEmitter, even though we are not in it\r\n            // the invite message should be received directly to the xmpp conn in general\r\n            this.mainRoom.addEventListener(\r\n                XMPPEvents.INVITE_MESSAGE_RECEIVED,\r\n                (roomJid, from, txt, invitePassword) => {\r\n                    logger.debug(`Received approval to join ${roomJid} ${from} ${txt}`);\r\n                    if (roomJid === this.mainRoom.roomjid) {\r\n                        // we are now allowed let's join and leave lobby\r\n                        this.mainRoom.join(invitePassword);\r\n\r\n                        this._leaveLobbyRoom();\r\n                    }\r\n                });\r\n            this.lobbyRoom.addEventListener(\r\n                XMPPEvents.MUC_DESTROYED,\r\n                (reason, jid) => {\r\n                    // we are receiving the jid of the main room\r\n                    // means we are invited to join, maybe lobby was disabled\r\n                    if (jid) {\r\n                        this.mainRoom.join();\r\n\r\n                        return;\r\n                    }\r\n\r\n                    this.lobbyRoom.clean();\r\n\r\n                    this.mainRoom.eventEmitter.emit(XMPPEvents.MUC_DESTROYED, reason);\r\n                });\r\n\r\n            // If participant retries joining shared password while waiting in the lobby\r\n            // and succeeds make sure we leave lobby\r\n            this.mainRoom.addEventListener(\r\n                XMPPEvents.MUC_JOINED,\r\n                () => {\r\n                    this._leaveLobbyRoom();\r\n                });\r\n        }\r\n\r\n        return new Promise((resolve, reject) => {\r\n            this.lobbyRoom.addEventListener(XMPPEvents.MUC_JOINED, () => {\r\n                resolve();\r\n\r\n                // send our email, as we do not handle this on initial presence we need a second one\r\n                if (email && !isModerator) {\r\n                    this.lobbyRoom.addOrReplaceInPresence(EMAIL_COMMAND, { value: email })\r\n                        && this.lobbyRoom.sendPresence();\r\n                }\r\n            });\r\n            this.lobbyRoom.addEventListener(XMPPEvents.ROOM_JOIN_ERROR, reject);\r\n            this.lobbyRoom.addEventListener(XMPPEvents.ROOM_CONNECT_NOT_ALLOWED_ERROR, reject);\r\n            this.lobbyRoom.addEventListener(XMPPEvents.ROOM_CONNECT_ERROR, reject);\r\n\r\n            this.lobbyRoom.join();\r\n        });\r\n\r\n    }\r\n\r\n    /**\r\n     * Should be possible only for moderators.\r\n     * @param id\r\n     */\r\n    denyAccess(id) {\r\n        if (!this.isSupported() || !this.mainRoom.isModerator()) {\r\n            return;\r\n        }\r\n\r\n        const jid = Object.keys(this.lobbyRoom.members)\r\n            .find(j => Strophe.getResourceFromJid(j) === id);\r\n\r\n        if (jid) {\r\n            this.lobbyRoom.kick(jid);\r\n        } else {\r\n            logger.error(`Not found member for ${id} in lobby room.`);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Should be possible only for moderators.\r\n     * @param id\r\n     */\r\n    approveAccess(id) {\r\n        if (!this.isSupported() || !this.mainRoom.isModerator()) {\r\n            return;\r\n        }\r\n\r\n        const memberRoomJid = Object.keys(this.lobbyRoom.members)\r\n            .find(j => Strophe.getResourceFromJid(j) === id);\r\n\r\n        if (memberRoomJid) {\r\n            const jid = this.lobbyRoom.members[memberRoomJid].jid;\r\n            const msgToSend\r\n                = $msg({ to: this.mainRoom.roomjid })\r\n                    .c('x', { xmlns: 'http://jabber.org/protocol/muc#user' })\r\n                    .c('invite', { to: jid });\r\n\r\n            this.xmpp.connection.sendIQ(msgToSend,\r\n                () => { }, // eslint-disable-line no-empty-function\r\n                e => {\r\n                    logger.error(`Error sending invite for ${jid}`, e);\r\n                });\r\n        } else {\r\n            logger.error(`Not found member for ${memberRoomJid} in lobby room.`);\r\n        }\r\n    }\r\n}\r\n","/* global $, Promise */\r\n\r\nimport { getLogger } from 'jitsi-meet-logger';\r\nimport { $iq, Strophe } from 'strophe.js';\r\n\r\nimport Settings from '../settings/Settings';\r\n\r\nconst AuthenticationEvents\r\n    = require('../../service/authentication/AuthenticationEvents');\r\nconst XMPPEvents = require('../../service/xmpp/XMPPEvents');\r\nconst GlobalOnErrorHandler = require('../util/GlobalOnErrorHandler');\r\n\r\nconst logger = getLogger(__filename);\r\n\r\n/**\r\n *\r\n * @param step\r\n */\r\nfunction createExpBackoffTimer(step) {\r\n    let count = 1;\r\n\r\n    return function(reset) {\r\n        // Reset call\r\n        if (reset) {\r\n            count = 1;\r\n\r\n            return;\r\n        }\r\n\r\n        // Calculate next timeout\r\n        const timeout = Math.pow(2, count - 1);\r\n\r\n        count += 1;\r\n\r\n        return timeout * step;\r\n    };\r\n}\r\n\r\n/* eslint-disable max-params */\r\n\r\n/**\r\n *\r\n * @param roomName\r\n * @param xmpp\r\n * @param emitter\r\n * @param options\r\n */\r\nexport default function Moderator(roomName, xmpp, emitter, options) {\r\n    this.roomName = roomName;\r\n    this.xmppService = xmpp;\r\n    this.getNextTimeout = createExpBackoffTimer(1000);\r\n    this.getNextErrorTimeout = createExpBackoffTimer(1000);\r\n\r\n    // External authentication stuff\r\n    this.externalAuthEnabled = false;\r\n    this.options = options;\r\n\r\n    // Whether SIP gateway (jigasi) support is enabled. This is set\r\n    // based on conference properties received in presence.\r\n    this.sipGatewayEnabled = false;\r\n\r\n    this.eventEmitter = emitter;\r\n\r\n    this.connection = this.xmppService.connection;\r\n\r\n    // FIXME: Message listener that talks to POPUP window\r\n    /**\r\n     *\r\n     * @param event\r\n     */\r\n    function listener(event) {\r\n        if (event.data && event.data.sessionId) {\r\n            if (event.origin !== window.location.origin) {\r\n                logger.warn(\r\n                    `Ignoring sessionId from different origin: ${\r\n                        event.origin}`);\r\n\r\n                return;\r\n            }\r\n            Settings.sessionId = event.data.sessionId;\r\n\r\n            // After popup is closed we will authenticate\r\n        }\r\n    }\r\n\r\n    // Register\r\n    if (window.addEventListener) {\r\n        window.addEventListener('message', listener, false);\r\n    } else {\r\n        window.attachEvent('onmessage', listener);\r\n    }\r\n}\r\n\r\n/* eslint-enable max-params */\r\n\r\nModerator.prototype.isExternalAuthEnabled = function() {\r\n    return this.externalAuthEnabled;\r\n};\r\n\r\nModerator.prototype.isSipGatewayEnabled = function() {\r\n    return this.sipGatewayEnabled;\r\n};\r\n\r\nModerator.prototype.onMucMemberLeft = function(jid) {\r\n    logger.info(`Someone left is it focus ? ${jid}`);\r\n    const resource = Strophe.getResourceFromJid(jid);\r\n\r\n    if (resource === 'focus') {\r\n        logger.info(\r\n            'Focus has left the room - leaving conference');\r\n        this.eventEmitter.emit(XMPPEvents.FOCUS_LEFT);\r\n    }\r\n};\r\n\r\nModerator.prototype.setFocusUserJid = function(focusJid) {\r\n    if (!this.focusUserJid) {\r\n        this.focusUserJid = focusJid;\r\n        logger.info(`Focus jid set to:  ${this.focusUserJid}`);\r\n    }\r\n};\r\n\r\nModerator.prototype.getFocusUserJid = function() {\r\n    return this.focusUserJid;\r\n};\r\n\r\nModerator.prototype.getFocusComponent = function() {\r\n    // Get focus component address\r\n    let focusComponent = this.options.connection.hosts.focus;\r\n\r\n    // If not specified use default:  'focus.domain'\r\n\r\n    if (!focusComponent) {\r\n        focusComponent = `focus.${this.options.connection.hosts.domain}`;\r\n    }\r\n\r\n    return focusComponent;\r\n};\r\n\r\nModerator.prototype.createConferenceIq = function() {\r\n    // Generate create conference IQ\r\n    const elem = $iq({ to: this.getFocusComponent(),\r\n        type: 'set' });\r\n\r\n    // Session Id used for authentication\r\n    const { sessionId } = Settings;\r\n    const machineUID = Settings.machineId;\r\n    const config = this.options.conference;\r\n\r\n    logger.info(`Session ID: ${sessionId} machine UID: ${machineUID}`);\r\n\r\n    elem.c('conference', {\r\n        xmlns: 'http://jitsi.org/protocol/focus',\r\n        room: this.roomName,\r\n        'machine-uid': machineUID\r\n    });\r\n\r\n    if (sessionId) {\r\n        elem.attrs({ 'session-id': sessionId });\r\n    }\r\n\r\n    elem.c(\r\n        'property', {\r\n            name: 'disableRtx',\r\n            value: Boolean(config.disableRtx)\r\n        }).up();\r\n\r\n    if (config.audioPacketDelay !== undefined) {\r\n        elem.c(\r\n            'property', {\r\n                name: 'audioPacketDelay',\r\n                value: config.audioPacketDelay\r\n            }).up();\r\n    }\r\n    if (config.startBitrate) {\r\n        elem.c(\r\n            'property', {\r\n                name: 'startBitrate',\r\n                value: config.startBitrate\r\n            }).up();\r\n    }\r\n    if (config.minBitrate) {\r\n        elem.c(\r\n            'property', {\r\n                name: 'minBitrate',\r\n                value: config.minBitrate\r\n            }).up();\r\n    }\r\n    if (config.testing && config.testing.octo\r\n        && typeof config.testing.octo.probability === 'number') {\r\n        if (Math.random() < config.testing.octo.probability) {\r\n            elem.c(\r\n                'property', {\r\n                    name: 'octo',\r\n                    value: true\r\n                }).up();\r\n        }\r\n    }\r\n\r\n    let openSctp;\r\n\r\n    switch (this.options.conference.openBridgeChannel) {\r\n    case 'datachannel':\r\n    case true:\r\n    case undefined:\r\n        openSctp = true;\r\n        break;\r\n    case 'websocket':\r\n        openSctp = false;\r\n        break;\r\n    }\r\n\r\n    elem.c(\r\n        'property', {\r\n            name: 'openSctp',\r\n            value: openSctp\r\n        }).up();\r\n\r\n    if (this.options.conference.startAudioMuted !== undefined) {\r\n        elem.c(\r\n            'property', {\r\n                name: 'startAudioMuted',\r\n                value: this.options.conference.startAudioMuted\r\n            }).up();\r\n    }\r\n    if (this.options.conference.startVideoMuted !== undefined) {\r\n        elem.c(\r\n            'property', {\r\n                name: 'startVideoMuted',\r\n                value: this.options.conference.startVideoMuted\r\n            }).up();\r\n    }\r\n    elem.up();\r\n\r\n    return elem;\r\n};\r\n\r\n\r\nModerator.prototype.parseSessionId = function(resultIq) {\r\n    // eslint-disable-next-line newline-per-chained-call\r\n    const sessionId = $(resultIq).find('conference').attr('session-id');\r\n\r\n    if (sessionId) {\r\n        logger.info(`Received sessionId:  ${sessionId}`);\r\n        Settings.sessionId = sessionId;\r\n    }\r\n};\r\n\r\nModerator.prototype.parseConfigOptions = function(resultIq) {\r\n    // eslint-disable-next-line newline-per-chained-call\r\n    this.setFocusUserJid($(resultIq).find('conference').attr('focusjid'));\r\n\r\n    const authenticationEnabled\r\n        = $(resultIq).find(\r\n            '>conference>property'\r\n            + '[name=\\'authentication\\'][value=\\'true\\']').length > 0;\r\n\r\n    logger.info(`Authentication enabled: ${authenticationEnabled}`);\r\n\r\n    this.externalAuthEnabled = $(resultIq).find(\r\n        '>conference>property'\r\n            + '[name=\\'externalAuth\\'][value=\\'true\\']').length > 0;\r\n\r\n    logger.info(\r\n        `External authentication enabled: ${this.externalAuthEnabled}`);\r\n\r\n    if (!this.externalAuthEnabled) {\r\n        // We expect to receive sessionId in 'internal' authentication mode\r\n        this.parseSessionId(resultIq);\r\n    }\r\n\r\n    // eslint-disable-next-line newline-per-chained-call\r\n    const authIdentity = $(resultIq).find('>conference').attr('identity');\r\n\r\n    this.eventEmitter.emit(AuthenticationEvents.IDENTITY_UPDATED,\r\n        authenticationEnabled, authIdentity);\r\n\r\n    // Check if jicofo has jigasi support enabled.\r\n    if ($(resultIq).find(\r\n        '>conference>property'\r\n        + '[name=\\'sipGatewayEnabled\\'][value=\\'true\\']').length) {\r\n        this.sipGatewayEnabled = true;\r\n    }\r\n\r\n    logger.info(`Sip gateway enabled:  ${this.sipGatewayEnabled}`);\r\n};\r\n\r\n// FIXME We need to show the fact that we're waiting for the focus to the user\r\n// (or that the focus is not available)\r\n/**\r\n * Allocates the conference focus.\r\n *\r\n * @param {Function} callback - the function to be called back upon the\r\n * successful allocation of the conference focus\r\n * @returns {Promise} - Resolved when Jicofo allows to join the room. It's never\r\n * rejected and it'll keep on pinging Jicofo forever.\r\n */\r\nModerator.prototype.allocateConferenceFocus = function() {\r\n    return new Promise(resolve => {\r\n        // Try to use focus user JID from the config\r\n        this.setFocusUserJid(this.options.connection.focusUserJid);\r\n\r\n        // Send create conference IQ\r\n        this.connection.sendIQ(\r\n            this.createConferenceIq(),\r\n            result => this._allocateConferenceFocusSuccess(result, resolve),\r\n            error => this._allocateConferenceFocusError(error, resolve));\r\n\r\n        // XXX We're pressed for time here because we're beginning a complex\r\n        // and/or lengthy conference-establishment process which supposedly\r\n        // involves multiple RTTs. We don't have the time to wait for Strophe to\r\n        // decide to send our IQ.\r\n        this.connection.flush();\r\n    });\r\n};\r\n\r\n/**\r\n * Invoked by {@link #allocateConferenceFocus} upon its request receiving an\r\n * error result.\r\n *\r\n * @param error - the error result of the request that\r\n * {@link #allocateConferenceFocus} sent\r\n * @param {Function} callback - the function to be called back upon the\r\n * successful allocation of the conference focus\r\n */\r\nModerator.prototype._allocateConferenceFocusError = function(error, callback) {\r\n    // If the session is invalid, remove and try again without session ID to get\r\n    // a new one\r\n    const invalidSession\r\n        = $(error).find('>error>session-invalid').length\r\n            || $(error).find('>error>not-acceptable').length;\r\n\r\n    if (invalidSession) {\r\n        logger.info('Session expired! - removing');\r\n        Settings.sessionId = undefined;\r\n    }\r\n    if ($(error).find('>error>graceful-shutdown').length) {\r\n        this.eventEmitter.emit(XMPPEvents.GRACEFUL_SHUTDOWN);\r\n\r\n        return;\r\n    }\r\n\r\n    // Check for error returned by the reservation system\r\n    const reservationErr = $(error).find('>error>reservation-error');\r\n\r\n    if (reservationErr.length) {\r\n        // Trigger error event\r\n        const errorCode = reservationErr.attr('error-code');\r\n        const errorTextNode = $(error).find('>error>text');\r\n        let errorMsg;\r\n\r\n        if (errorTextNode) {\r\n            errorMsg = errorTextNode.text();\r\n        }\r\n        this.eventEmitter.emit(\r\n            XMPPEvents.RESERVATION_ERROR,\r\n            errorCode,\r\n            errorMsg);\r\n\r\n        return;\r\n    }\r\n\r\n    // Not authorized to create new room\r\n    if ($(error).find('>error>not-authorized').length) {\r\n        logger.warn('Unauthorized to start the conference', error);\r\n        const toDomain = Strophe.getDomainFromJid(error.getAttribute('to'));\r\n\r\n        if (toDomain !== this.options.connection.hosts.anonymousdomain) {\r\n            // FIXME \"is external\" should come either from the focus or\r\n            // config.js\r\n            this.externalAuthEnabled = true;\r\n        }\r\n        this.eventEmitter.emit(XMPPEvents.AUTHENTICATION_REQUIRED);\r\n\r\n        return;\r\n    }\r\n    const waitMs = this.getNextErrorTimeout();\r\n    const errmsg = `Focus error, retry after ${waitMs}`;\r\n\r\n    GlobalOnErrorHandler.callErrorHandler(new Error(errmsg));\r\n    logger.error(errmsg, error);\r\n\r\n    // Show message\r\n    const focusComponent = this.getFocusComponent();\r\n    const retrySec = waitMs / 1000;\r\n\r\n    // FIXME: message is duplicated ? Do not show in case of session invalid\r\n    // which means just a retry\r\n\r\n    if (!invalidSession) {\r\n        this.eventEmitter.emit(\r\n            XMPPEvents.FOCUS_DISCONNECTED,\r\n            focusComponent,\r\n            retrySec);\r\n    }\r\n\r\n    // Reset response timeout\r\n    this.getNextTimeout(true);\r\n    window.setTimeout(\r\n        () => this.allocateConferenceFocus().then(callback),\r\n        waitMs);\r\n};\r\n\r\n/**\r\n * Invoked by {@link #allocateConferenceFocus} upon its request receiving a\r\n * success (i.e. non-error) result.\r\n *\r\n * @param result - the success (i.e. non-error) result of the request that\r\n * {@link #allocateConferenceFocus} sent\r\n * @param {Function} callback - the function to be called back upon the\r\n * successful allocation of the conference focus\r\n */\r\nModerator.prototype._allocateConferenceFocusSuccess = function(\r\n        result,\r\n        callback) {\r\n    // Setup config options\r\n    this.parseConfigOptions(result);\r\n\r\n    // Reset the error timeout (because we haven't failed here).\r\n    this.getNextErrorTimeout(true);\r\n\r\n    // eslint-disable-next-line newline-per-chained-call\r\n    if ($(result).find('conference').attr('ready') === 'true') {\r\n        // Reset the non-error timeout (because we've succeeded here).\r\n        this.getNextTimeout(true);\r\n\r\n        // Exec callback\r\n        callback();\r\n    } else {\r\n        const waitMs = this.getNextTimeout();\r\n\r\n        logger.info(`Waiting for the focus... ${waitMs}`);\r\n        window.setTimeout(\r\n            () => this.allocateConferenceFocus().then(callback),\r\n            waitMs);\r\n    }\r\n};\r\n\r\nModerator.prototype.authenticate = function() {\r\n    return new Promise((resolve, reject) => {\r\n        this.connection.sendIQ(\r\n            this.createConferenceIq(),\r\n            result => {\r\n                this.parseSessionId(result);\r\n                resolve();\r\n            },\r\n            errorIq => reject({\r\n                error: $(errorIq).find('iq>error :first')\r\n                    .prop('tagName'),\r\n                message: $(errorIq).find('iq>error>text')\r\n                    .text()\r\n            })\r\n        );\r\n    });\r\n};\r\n\r\nModerator.prototype.getLoginUrl = function(urlCallback, failureCallback) {\r\n    this._getLoginUrl(/* popup */ false, urlCallback, failureCallback);\r\n};\r\n\r\n/**\r\n *\r\n * @param {boolean} popup false for {@link Moderator#getLoginUrl} or true for\r\n * {@link Moderator#getPopupLoginUrl}\r\n * @param urlCb\r\n * @param failureCb\r\n */\r\nModerator.prototype._getLoginUrl = function(popup, urlCb, failureCb) {\r\n    const iq = $iq({ to: this.getFocusComponent(),\r\n        type: 'get' });\r\n    const attrs = {\r\n        xmlns: 'http://jitsi.org/protocol/focus',\r\n        room: this.roomName,\r\n        'machine-uid': Settings.machineId\r\n    };\r\n    let str = 'auth url'; // for logger\r\n\r\n    if (popup) {\r\n        attrs.popup = true;\r\n        str = `POPUP ${str}`;\r\n    }\r\n    iq.c('login-url', attrs);\r\n\r\n    /**\r\n     * Implements a failure callback which reports an error message and an error\r\n     * through (1) GlobalOnErrorHandler, (2) logger, and (3) failureCb.\r\n     *\r\n     * @param {string} errmsg the error messsage to report\r\n     * @param {*} error the error to report (in addition to errmsg)\r\n     */\r\n    function reportError(errmsg, err) {\r\n        GlobalOnErrorHandler.callErrorHandler(new Error(errmsg));\r\n        logger.error(errmsg, err);\r\n        failureCb(err);\r\n    }\r\n    this.connection.sendIQ(\r\n        iq,\r\n        result => {\r\n            // eslint-disable-next-line newline-per-chained-call\r\n            let url = $(result).find('login-url').attr('url');\r\n\r\n            url = decodeURIComponent(url);\r\n            if (url) {\r\n                logger.info(`Got ${str}: ${url}`);\r\n                urlCb(url);\r\n            } else {\r\n                reportError(`Failed to get ${str} from the focus`, result);\r\n            }\r\n        },\r\n        reportError.bind(undefined, `Get ${str} error`)\r\n    );\r\n};\r\n\r\nModerator.prototype.getPopupLoginUrl = function(urlCallback, failureCallback) {\r\n    this._getLoginUrl(/* popup */ true, urlCallback, failureCallback);\r\n};\r\n\r\nModerator.prototype.logout = function(callback) {\r\n    const iq = $iq({ to: this.getFocusComponent(),\r\n        type: 'set' });\r\n    const { sessionId } = Settings;\r\n\r\n    if (!sessionId) {\r\n        callback();\r\n\r\n        return;\r\n    }\r\n    iq.c('logout', {\r\n        xmlns: 'http://jitsi.org/protocol/focus',\r\n        'session-id': sessionId\r\n    });\r\n    this.connection.sendIQ(\r\n        iq,\r\n        result => {\r\n            // eslint-disable-next-line newline-per-chained-call\r\n            let logoutUrl = $(result).find('logout').attr('logout-url');\r\n\r\n            if (logoutUrl) {\r\n                logoutUrl = decodeURIComponent(logoutUrl);\r\n            }\r\n            logger.info(`Log out OK, url: ${logoutUrl}`, result);\r\n            Settings.sessionId = undefined;\r\n            callback(logoutUrl);\r\n        },\r\n        error => {\r\n            const errmsg = 'Logout error';\r\n\r\n            GlobalOnErrorHandler.callErrorHandler(new Error(errmsg));\r\n            logger.error(errmsg, error);\r\n        }\r\n    );\r\n};\r\n","const RandomUtil = require('./RandomUtil');\r\n\r\n/**\r\n * from faker.js - Copyright (c) 2014-2015 Matthew Bergman & Marak Squires\r\n * MIT License\r\n * http://github.com/marak/faker.js/\r\n *\r\n * @const\r\n */\r\nconst names = [\r\n    'Aaliyah', 'Aaron', 'Abagail', 'Abbey', 'Abbie', 'Abbigail', 'Abby',\r\n    'Abdiel', 'Abdul', 'Abdullah', 'Abe', 'Abel', 'Abelardo', 'Abigail',\r\n    'Abigale', 'Abigayle', 'Abner', 'Abraham', 'Ada', 'Adah', 'Adalberto',\r\n    'Adaline', 'Adam', 'Adan', 'Addie', 'Addison', 'Adela', 'Adelbert', 'Adele',\r\n    'Adelia', 'Adeline', 'Adell', 'Adella', 'Adelle', 'Aditya', 'Adolf',\r\n    'Adolfo', 'Adolph', 'Adolphus', 'Adonis', 'Adrain', 'Adrian', 'Adriana',\r\n    'Adrianna', 'Adriel', 'Adrien', 'Adrienne', 'Afton', 'Aglae', 'Agnes',\r\n    'Agustin', 'Agustina', 'Ahmad', 'Ahmed', 'Aida', 'Aidan', 'Aiden', 'Aileen',\r\n    'Aisha', 'Aiyana', 'Akeem', 'Al', 'Alaina', 'Alan', 'Alana', 'Alanis',\r\n    'Alanna', 'Alayna', 'Alba', 'Albert', 'Alberta', 'Albertha', 'Alberto',\r\n    'Albin', 'Albina', 'Alda', 'Alden', 'Alec', 'Aleen', 'Alejandra',\r\n    'Alejandrin', 'Alek', 'Alena', 'Alene', 'Alessandra', 'Alessandro',\r\n    'Alessia', 'Aletha', 'Alex', 'Alexa', 'Alexander', 'Alexandra', 'Alexandre',\r\n    'Alexandrea', 'Alexandria', 'Alexandrine', 'Alexandro', 'Alexane',\r\n    'Alexanne', 'Alexie', 'Alexis', 'Alexys', 'Alexzander', 'Alf', 'Alfonso',\r\n    'Alfonzo', 'Alford', 'Alfred', 'Alfreda', 'Alfredo', 'Ali', 'Alia', 'Alice',\r\n    'Alicia', 'Alisa', 'Alisha', 'Alison', 'Alivia', 'Aliya', 'Aliyah', 'Aliza',\r\n    'Alize', 'Allan', 'Allen', 'Allene', 'Allie', 'Allison', 'Ally', 'Alphonso',\r\n    'Alta', 'Althea', 'Alva', 'Alvah', 'Alvena', 'Alvera', 'Alverta', 'Alvina',\r\n    'Alvis', 'Alyce', 'Alycia', 'Alysa', 'Alysha', 'Alyson', 'Alysson',\r\n    'Amalia', 'Amanda', 'Amani', 'Amara', 'Amari', 'Amaya', 'Amber', 'Ambrose',\r\n    'Amelia', 'Amelie', 'Amely', 'America', 'Americo', 'Amie', 'Amina', 'Amir',\r\n    'Amira', 'Amiya', 'Amos', 'Amparo', 'Amy', 'Amya', 'Ana', 'Anabel',\r\n    'Anabelle', 'Anahi', 'Anais', 'Anastacio', 'Anastasia', 'Anderson', 'Andre',\r\n    'Andreane', 'Andreanne', 'Andres', 'Andrew', 'Andy', 'Angel', 'Angela',\r\n    'Angelica', 'Angelina', 'Angeline', 'Angelita', 'Angelo', 'Angie', 'Angus',\r\n    'Anibal', 'Anika', 'Anissa', 'Anita', 'Aniya', 'Aniyah', 'Anjali', 'Anna',\r\n    'Annabel', 'Annabell', 'Annabelle', 'Annalise', 'Annamae', 'Annamarie',\r\n    'Anne', 'Annetta', 'Annette', 'Annie', 'Ansel', 'Ansley', 'Anthony',\r\n    'Antoinette', 'Antone', 'Antonetta', 'Antonette', 'Antonia', 'Antonietta',\r\n    'Antonina', 'Antonio', 'Antwan', 'Antwon', 'Anya', 'April', 'Ara',\r\n    'Araceli', 'Aracely', 'Arch', 'Archibald', 'Ardella', 'Arden', 'Ardith',\r\n    'Arely', 'Ari', 'Ariane', 'Arianna', 'Aric', 'Ariel', 'Arielle', 'Arjun',\r\n    'Arlene', 'Arlie', 'Arlo', 'Armand', 'Armando', 'Armani', 'Arnaldo', 'Arne',\r\n    'Arno', 'Arnold', 'Arnoldo', 'Arnulfo', 'Aron', 'Art', 'Arthur', 'Arturo',\r\n    'Arvel', 'Arvid', 'Arvilla', 'Aryanna', 'Asa', 'Asha', 'Ashlee', 'Ashleigh',\r\n    'Ashley', 'Ashly', 'Ashlynn', 'Ashton', 'Ashtyn', 'Asia', 'Assunta',\r\n    'Astrid', 'Athena', 'Aubree', 'Aubrey', 'Audie', 'Audra', 'Audreanne',\r\n    'Audrey', 'August', 'Augusta', 'Augustine', 'Augustus', 'Aurelia',\r\n    'Aurelie', 'Aurelio', 'Aurore', 'Austen', 'Austin', 'Austyn', 'Autumn',\r\n    'Ava', 'Avery', 'Avis', 'Axel', 'Ayana', 'Ayden', 'Ayla', 'Aylin', 'Baby',\r\n    'Bailee', 'Bailey', 'Barbara', 'Barney', 'Baron', 'Barrett', 'Barry',\r\n    'Bart', 'Bartholome', 'Barton', 'Baylee', 'Beatrice', 'Beau', 'Beaulah',\r\n    'Bell', 'Bella', 'Belle', 'Ben', 'Benedict', 'Benjamin', 'Bennett',\r\n    'Bennie', 'Benny', 'Benton', 'Berenice', 'Bernadette', 'Bernadine',\r\n    'Bernard', 'Bernardo', 'Berneice', 'Bernhard', 'Bernice', 'Bernie',\r\n    'Berniece', 'Bernita', 'Berry', 'Bert', 'Berta', 'Bertha', 'Bertram',\r\n    'Bertrand', 'Beryl', 'Bessie', 'Beth', 'Bethany', 'Bethel', 'Betsy',\r\n    'Bette', 'Bettie', 'Betty', 'Bettye', 'Beulah', 'Beverly', 'Bianka', 'Bill',\r\n    'Billie', 'Billy', 'Birdie', 'Blair', 'Blaise', 'Blake', 'Blanca',\r\n    'Blanche', 'Blaze', 'Bo', 'Bobbie', 'Bobby', 'Bonita', 'Bonnie', 'Boris',\r\n    'Boyd', 'Brad', 'Braden', 'Bradford', 'Bradley', 'Bradly', 'Brady',\r\n    'Braeden', 'Brain', 'Brandi', 'Brando', 'Brandon', 'Brandt', 'Brandy',\r\n    'Brandyn', 'Brannon', 'Branson', 'Brant', 'Braulio', 'Braxton', 'Brayan',\r\n    'Breana', 'Breanna', 'Breanne', 'Brenda', 'Brendan', 'Brenden', 'Brendon',\r\n    'Brenna', 'Brennan', 'Brennon', 'Brent', 'Bret', 'Brett', 'Bria', 'Brian',\r\n    'Briana', 'Brianne', 'Brice', 'Bridget', 'Bridgette', 'Bridie', 'Brielle',\r\n    'Brigitte', 'Brionna', 'Brisa', 'Britney', 'Brittany', 'Brock', 'Broderick',\r\n    'Brody', 'Brook', 'Brooke', 'Brooklyn', 'Brooks', 'Brown', 'Bruce',\r\n    'Bryana', 'Bryce', 'Brycen', 'Bryon', 'Buck', 'Bud', 'Buddy', 'Buford',\r\n    'Bulah', 'Burdette', 'Burley', 'Burnice', 'Buster', 'Cade', 'Caden',\r\n    'Caesar', 'Caitlyn', 'Cale', 'Caleb', 'Caleigh', 'Cali', 'Calista',\r\n    'Callie', 'Camden', 'Cameron', 'Camila', 'Camilla', 'Camille', 'Camren',\r\n    'Camron', 'Camryn', 'Camylle', 'Candace', 'Candelario', 'Candice',\r\n    'Candida', 'Candido', 'Cara', 'Carey', 'Carissa', 'Carlee', 'Carleton',\r\n    'Carley', 'Carli', 'Carlie', 'Carlo', 'Carlos', 'Carlotta', 'Carmel',\r\n    'Carmela', 'Carmella', 'Carmelo', 'Carmen', 'Carmine', 'Carol', 'Carolanne',\r\n    'Carole', 'Carolina', 'Caroline', 'Carolyn', 'Carolyne', 'Carrie',\r\n    'Carroll', 'Carson', 'Carter', 'Cary', 'Casandra', 'Casey', 'Casimer',\r\n    'Casimir', 'Casper', 'Cassandra', 'Cassandre', 'Cassidy', 'Cassie',\r\n    'Catalina', 'Caterina', 'Catharine', 'Catherine', 'Cathrine', 'Cathryn',\r\n    'Cathy', 'Cayla', 'Ceasar', 'Cecelia', 'Cecil', 'Cecile', 'Cecilia',\r\n    'Cedrick', 'Celestine', 'Celestino', 'Celia', 'Celine', 'Cesar', 'Chad',\r\n    'Chadd', 'Chadrick', 'Chaim', 'Chance', 'Chandler', 'Chanel', 'Chanelle',\r\n    'Charity', 'Charlene', 'Charles', 'Charley', 'Charlie', 'Charlotte',\r\n    'Chase', 'Chasity', 'Chauncey', 'Chaya', 'Chaz', 'Chelsea', 'Chelsey',\r\n    'Chelsie', 'Chesley', 'Chester', 'Chet', 'Cheyanne', 'Cheyenne', 'Chloe',\r\n    'Chris', 'Christ', 'Christa', 'Christelle', 'Christian', 'Christiana',\r\n    'Christina', 'Christine', 'Christop', 'Christophe', 'Christopher',\r\n    'Christy', 'Chyna', 'Ciara', 'Cicero', 'Cielo', 'Cierra', 'Cindy',\r\n    'Citlalli', 'Clair', 'Claire', 'Clara', 'Clarabelle', 'Clare', 'Clarissa',\r\n    'Clark', 'Claud', 'Claude', 'Claudia', 'Claudie', 'Claudine', 'Clay',\r\n    'Clemens', 'Clement', 'Clementina', 'Clementine', 'Clemmie', 'Cleo',\r\n    'Cleora', 'Cleta', 'Cletus', 'Cleve', 'Cleveland', 'Clifford', 'Clifton',\r\n    'Clint', 'Clinton', 'Clotilde', 'Clovis', 'Cloyd', 'Clyde', 'Coby', 'Cody',\r\n    'Colby', 'Cole', 'Coleman', 'Colin', 'Colleen', 'Collin', 'Colt', 'Colten',\r\n    'Colton', 'Columbus', 'Concepcion', 'Conner', 'Connie', 'Connor', 'Conor',\r\n    'Conrad', 'Constance', 'Constantin', 'Consuelo', 'Cooper', 'Cora',\r\n    'Coralie', 'Corbin', 'Cordelia', 'Cordell', 'Cordia', 'Cordie', 'Corene',\r\n    'Corine', 'Cornelius', 'Cornell', 'Corrine', 'Cortez', 'Cortney', 'Cory',\r\n    'Coty', 'Courtney', 'Coy', 'Craig', 'Crawford', 'Creola', 'Cristal',\r\n    'Cristian', 'Cristina', 'Cristobal', 'Cristopher', 'Cruz', 'Crystal',\r\n    'Crystel', 'Cullen', 'Curt', 'Curtis', 'Cydney', 'Cynthia', 'Cyril',\r\n    'Cyrus', 'Dagmar', 'Dahlia', 'Daija', 'Daisha', 'Daisy', 'Dakota', 'Dale',\r\n    'Dallas', 'Dallin', 'Dalton', 'Damaris', 'Dameon', 'Damian', 'Damien',\r\n    'Damion', 'Damon', 'Dan', 'Dana', 'Dandre', 'Dane', 'D\\'angelo', 'Dangelo',\r\n    'Danial', 'Daniela', 'Daniella', 'Danielle', 'Danika', 'Dannie', 'Danny',\r\n    'Dante', 'Danyka', 'Daphne', 'Daphnee', 'Daphney', 'Darby', 'Daren',\r\n    'Darian', 'Dariana', 'Darien', 'Dario', 'Darion', 'Darius', 'Darlene',\r\n    'Daron', 'Darrel', 'Darrell', 'Darren', 'Darrick', 'Darrin', 'Darrion',\r\n    'Darron', 'Darryl', 'Darwin', 'Daryl', 'Dashawn', 'Dasia', 'Dave', 'David',\r\n    'Davin', 'Davion', 'Davon', 'Davonte', 'Dawn', 'Dawson', 'Dax', 'Dayana',\r\n    'Dayna', 'Dayne', 'Dayton', 'Dean', 'Deangelo', 'Deanna', 'Deborah',\r\n    'Declan', 'Dedric', 'Dedrick', 'Dee', 'Deion', 'Deja', 'Dejah', 'Dejon',\r\n    'Dejuan', 'Delaney', 'Delbert', 'Delfina', 'Delia', 'Delilah', 'Dell',\r\n    'Della', 'Delmer', 'Delores', 'Delpha', 'Delphia', 'Delphine', 'Delta',\r\n    'Demarco', 'Demarcus', 'Demario', 'Demetris', 'Demetrius', 'Demond', 'Dena',\r\n    'Denis', 'Dennis', 'Deon', 'Deondre', 'Deontae', 'Deonte', 'Dereck',\r\n    'Derek', 'Derick', 'Deron', 'Derrick', 'Deshaun', 'Deshawn', 'Desiree',\r\n    'Desmond', 'Dessie', 'Destany', 'Destin', 'Destinee', 'Destiney', 'Destini',\r\n    'Destiny', 'Devan', 'Devante', 'Deven', 'Devin', 'Devon', 'Devonte',\r\n    'Devyn', 'Dewayne', 'Dewitt', 'Dexter', 'Diamond', 'Diana', 'Dianna',\r\n    'Diego', 'Dillan', 'Dillon', 'Dimitri', 'Dina', 'Dino', 'Dion', 'Dixie',\r\n    'Dock', 'Dolly', 'Dolores', 'Domenic', 'Domenica', 'Domenick', 'Domenico',\r\n    'Domingo', 'Dominic', 'Dominique', 'Don', 'Donald', 'Donato', 'Donavon',\r\n    'Donna', 'Donnell', 'Donnie', 'Donny', 'Dora', 'Dorcas', 'Dorian', 'Doris',\r\n    'Dorothea', 'Dorothy', 'Dorris', 'Dortha', 'Dorthy', 'Doug', 'Douglas',\r\n    'Dovie', 'Doyle', 'Drake', 'Drew', 'Duane', 'Dudley', 'Dulce', 'Duncan',\r\n    'Durward', 'Dustin', 'Dusty', 'Dwight', 'Dylan', 'Earl', 'Earlene',\r\n    'Earline', 'Earnest', 'Earnestine', 'Easter', 'Easton', 'Ebba', 'Ebony',\r\n    'Ed', 'Eda', 'Edd', 'Eddie', 'Eden', 'Edgar', 'Edgardo', 'Edison', 'Edmond',\r\n    'Edmund', 'Edna', 'Eduardo', 'Edward', 'Edwardo', 'Edwin', 'Edwina',\r\n    'Edyth', 'Edythe', 'Effie', 'Efrain', 'Efren', 'Eileen', 'Einar', 'Eino',\r\n    'Eladio', 'Elaina', 'Elbert', 'Elda', 'Eldon', 'Eldora', 'Eldred',\r\n    'Eldridge', 'Eleanora', 'Eleanore', 'Eleazar', 'Electa', 'Elena', 'Elenor',\r\n    'Elenora', 'Eleonore', 'Elfrieda', 'Eli', 'Elian', 'Eliane', 'Elias',\r\n    'Eliezer', 'Elijah', 'Elinor', 'Elinore', 'Elisa', 'Elisabeth', 'Elise',\r\n    'Eliseo', 'Elisha', 'Elissa', 'Eliza', 'Elizabeth', 'Ella', 'Ellen',\r\n    'Ellie', 'Elliot', 'Elliott', 'Ellis', 'Ellsworth', 'Elmer', 'Elmira',\r\n    'Elmo', 'Elmore', 'Elna', 'Elnora', 'Elody', 'Eloisa', 'Eloise', 'Elouise',\r\n    'Eloy', 'Elroy', 'Elsa', 'Else', 'Elsie', 'Elta', 'Elton', 'Elva', 'Elvera',\r\n    'Elvie', 'Elvis', 'Elwin', 'Elwyn', 'Elyse', 'Elyssa', 'Elza', 'Emanuel',\r\n    'Emelia', 'Emelie', 'Emely', 'Emerald', 'Emerson', 'Emery', 'Emie', 'Emil',\r\n    'Emile', 'Emilia', 'Emiliano', 'Emilie', 'Emilio', 'Emily', 'Emma',\r\n    'Emmalee', 'Emmanuel', 'Emmanuelle', 'Emmet', 'Emmett', 'Emmie', 'Emmitt',\r\n    'Emmy', 'Emory', 'Ena', 'Enid', 'Enoch', 'Enola', 'Enos', 'Enrico',\r\n    'Enrique', 'Ephraim', 'Era', 'Eriberto', 'Eric', 'Erica', 'Erich', 'Erick',\r\n    'Ericka', 'Erik', 'Erika', 'Erin', 'Erling', 'Erna', 'Ernest', 'Ernestina',\r\n    'Ernestine', 'Ernesto', 'Ernie', 'Ervin', 'Erwin', 'Eryn', 'Esmeralda',\r\n    'Esperanza', 'Esta', 'Esteban', 'Estefania', 'Estel', 'Estell', 'Estella',\r\n    'Estelle', 'Estevan', 'Esther', 'Estrella', 'Etha', 'Ethan', 'Ethel',\r\n    'Ethelyn', 'Ethyl', 'Ettie', 'Eudora', 'Eugene', 'Eugenia', 'Eula', 'Eulah',\r\n    'Eulalia', 'Euna', 'Eunice', 'Eusebio', 'Eva', 'Evalyn', 'Evan',\r\n    'Evangeline', 'Evans', 'Eve', 'Eveline', 'Evelyn', 'Everardo', 'Everett',\r\n    'Everette', 'Evert', 'Evie', 'Ewald', 'Ewell', 'Ezekiel', 'Ezequiel',\r\n    'Ezra', 'Fabian', 'Fabiola', 'Fae', 'Fannie', 'Fanny', 'Fatima', 'Faustino',\r\n    'Fausto', 'Favian', 'Fay', 'Faye', 'Federico', 'Felicia', 'Felicita',\r\n    'Felicity', 'Felipa', 'Felipe', 'Felix', 'Felton', 'Fermin', 'Fern',\r\n    'Fernando', 'Ferne', 'Fidel', 'Filiberto', 'Filomena', 'Finn', 'Fiona',\r\n    'Flavie', 'Flavio', 'Fleta', 'Fletcher', 'Flo', 'Florence', 'Florencio',\r\n    'Florian', 'Florida', 'Florine', 'Flossie', 'Floy', 'Floyd', 'Ford',\r\n    'Forest', 'Forrest', 'Foster', 'Frances', 'Francesca', 'Francesco',\r\n    'Francis', 'Francisca', 'Francisco', 'Franco', 'Frank', 'Frankie', 'Franz',\r\n    'Fred', 'Freda', 'Freddie', 'Freddy', 'Frederic', 'Frederick', 'Frederik',\r\n    'Frederique', 'Fredrick', 'Fredy', 'Freeda', 'Freeman', 'Freida', 'Frida',\r\n    'Frieda', 'Friedrich', 'Fritz', 'Furman', 'Gabe', 'Gabriel', 'Gabriella',\r\n    'Gabrielle', 'Gaetano', 'Gage', 'Gail', 'Gardner', 'Garett', 'Garfield',\r\n    'Garland', 'Garnet', 'Garnett', 'Garret', 'Garrett', 'Garrick', 'Garrison',\r\n    'Garry', 'Garth', 'Gaston', 'Gavin', 'Gay', 'Gayle', 'Gaylord', 'Gene',\r\n    'General', 'Genesis', 'Genevieve', 'Gennaro', 'Genoveva', 'Geo', 'Geoffrey',\r\n    'George', 'Georgette', 'Georgiana', 'Georgianna', 'Geovanni', 'Geovanny',\r\n    'Geovany', 'Gerald', 'Geraldine', 'Gerard', 'Gerardo', 'Gerda', 'Gerhard',\r\n    'Germaine', 'German', 'Gerry', 'Gerson', 'Gertrude', 'Gia', 'Gianni',\r\n    'Gideon', 'Gilbert', 'Gilberto', 'Gilda', 'Giles', 'Gillian', 'Gina',\r\n    'Gino', 'Giovani', 'Giovanna', 'Giovanni', 'Giovanny', 'Gisselle',\r\n    'Giuseppe', 'Gladyce', 'Gladys', 'Glen', 'Glenda', 'Glenna', 'Glennie',\r\n    'Gloria', 'Godfrey', 'Golda', 'Golden', 'Gonzalo', 'Gordon', 'Grace',\r\n    'Gracie', 'Graciela', 'Grady', 'Graham', 'Grant', 'Granville', 'Grayce',\r\n    'Grayson', 'Green', 'Greg', 'Gregg', 'Gregoria', 'Gregorio', 'Gregory',\r\n    'Greta', 'Gretchen', 'Greyson', 'Griffin', 'Grover', 'Guadalupe', 'Gudrun',\r\n    'Guido', 'Guillermo', 'Guiseppe', 'Gunnar', 'Gunner', 'Gus', 'Gussie',\r\n    'Gust', 'Gustave', 'Guy', 'Gwen', 'Gwendolyn', 'Hadley', 'Hailee', 'Hailey',\r\n    'Hailie', 'Hal', 'Haleigh', 'Haley', 'Halie', 'Halle', 'Hallie', 'Hank',\r\n    'Hanna', 'Hannah', 'Hans', 'Hardy', 'Harley', 'Harmon', 'Harmony', 'Harold',\r\n    'Harrison', 'Harry', 'Harvey', 'Haskell', 'Hassan', 'Hassie', 'Hattie',\r\n    'Haven', 'Hayden', 'Haylee', 'Hayley', 'Haylie', 'Hazel', 'Hazle', 'Heath',\r\n    'Heather', 'Heaven', 'Heber', 'Hector', 'Heidi', 'Helen', 'Helena',\r\n    'Helene', 'Helga', 'Hellen', 'Helmer', 'Heloise', 'Henderson', 'Henri',\r\n    'Henriette', 'Henry', 'Herbert', 'Herman', 'Hermann', 'Hermina', 'Herminia',\r\n    'Herminio', 'Hershel', 'Herta', 'Hertha', 'Hester', 'Hettie', 'Hilario',\r\n    'Hilbert', 'Hilda', 'Hildegard', 'Hillard', 'Hillary', 'Hilma', 'Hilton',\r\n    'Hipolito', 'Hiram', 'Hobart', 'Holden', 'Hollie', 'Hollis', 'Holly',\r\n    'Hope', 'Horace', 'Horacio', 'Hortense', 'Hosea', 'Houston', 'Howard',\r\n    'Howell', 'Hoyt', 'Hubert', 'Hudson', 'Hugh', 'Hulda', 'Humberto', 'Hunter',\r\n    'Hyman', 'Ian', 'Ibrahim', 'Icie', 'Ida', 'Idell', 'Idella', 'Ignacio',\r\n    'Ignatius', 'Ike', 'Ila', 'Ilene', 'Iliana', 'Ima', 'Imani', 'Imelda',\r\n    'Immanuel', 'Imogene', 'Ines', 'Irma', 'Irving', 'Irwin', 'Isaac', 'Isabel',\r\n    'Isabell', 'Isabella', 'Isabelle', 'Isac', 'Isadore', 'Isai', 'Isaiah',\r\n    'Isaias', 'Isidro', 'Ismael', 'Isobel', 'Isom', 'Israel', 'Issac', 'Itzel',\r\n    'Iva', 'Ivah', 'Ivory', 'Ivy', 'Izabella', 'Izaiah', 'Jabari', 'Jace',\r\n    'Jacey', 'Jacinthe', 'Jacinto', 'Jack', 'Jackeline', 'Jackie', 'Jacklyn',\r\n    'Jackson', 'Jacky', 'Jaclyn', 'Jacquelyn', 'Jacques', 'Jacynthe', 'Jada',\r\n    'Jade', 'Jaden', 'Jadon', 'Jadyn', 'Jaeden', 'Jaida', 'Jaiden', 'Jailyn',\r\n    'Jaime', 'Jairo', 'Jakayla', 'Jake', 'Jakob', 'Jaleel', 'Jalen', 'Jalon',\r\n    'Jalyn', 'Jamaal', 'Jamal', 'Jamar', 'Jamarcus', 'Jamel', 'Jameson',\r\n    'Jamey', 'Jamie', 'Jamil', 'Jamir', 'Jamison', 'Jammie', 'Jan', 'Jana',\r\n    'Janae', 'Jane', 'Janelle', 'Janessa', 'Janet', 'Janice', 'Janick', 'Janie',\r\n    'Janis', 'Janiya', 'Jannie', 'Jany', 'Jaquan', 'Jaquelin', 'Jaqueline',\r\n    'Jared', 'Jaren', 'Jarod', 'Jaron', 'Jarred', 'Jarrell', 'Jarret',\r\n    'Jarrett', 'Jarrod', 'Jarvis', 'Jasen', 'Jasmin', 'Jason', 'Jasper',\r\n    'Jaunita', 'Javier', 'Javon', 'Javonte', 'Jay', 'Jayce', 'Jaycee', 'Jayda',\r\n    'Jayde', 'Jayden', 'Jaydon', 'Jaylan', 'Jaylen', 'Jaylin', 'Jaylon',\r\n    'Jayme', 'Jayne', 'Jayson', 'Jazlyn', 'Jazmin', 'Jazmyn', 'Jazmyne', 'Jean',\r\n    'Jeanette', 'Jeanie', 'Jeanne', 'Jed', 'Jedediah', 'Jedidiah', 'Jeff',\r\n    'Jefferey', 'Jeffery', 'Jeffrey', 'Jeffry', 'Jena', 'Jenifer', 'Jennie',\r\n    'Jennifer', 'Jennings', 'Jennyfer', 'Jensen', 'Jerad', 'Jerald', 'Jeramie',\r\n    'Jeramy', 'Jerel', 'Jeremie', 'Jeremy', 'Jermain', 'Jermaine', 'Jermey',\r\n    'Jerod', 'Jerome', 'Jeromy', 'Jerrell', 'Jerrod', 'Jerrold', 'Jerry',\r\n    'Jess', 'Jesse', 'Jessica', 'Jessie', 'Jessika', 'Jessy', 'Jessyca',\r\n    'Jesus', 'Jett', 'Jettie', 'Jevon', 'Jewel', 'Jewell', 'Jillian', 'Jimmie',\r\n    'Jimmy', 'Jo', 'Joan', 'Joana', 'Joanie', 'Joanne', 'Joannie', 'Joanny',\r\n    'Joany', 'Joaquin', 'Jocelyn', 'Jodie', 'Jody', 'Joe', 'Joel', 'Joelle',\r\n    'Joesph', 'Joey', 'Johan', 'Johann', 'Johanna', 'Johathan', 'John',\r\n    'Johnathan', 'Johnathon', 'Johnnie', 'Johnny', 'Johnpaul', 'Johnson',\r\n    'Jolie', 'Jon', 'Jonas', 'Jonatan', 'Jonathan', 'Jonathon', 'Jordan',\r\n    'Jordane', 'Jordi', 'Jordon', 'Jordy', 'Jordyn', 'Jorge', 'Jose', 'Josefa',\r\n    'Josefina', 'Joseph', 'Josephine', 'Josh', 'Joshua', 'Joshuah', 'Josiah',\r\n    'Josiane', 'Josianne', 'Josie', 'Josue', 'Jovan', 'Jovani', 'Jovanny',\r\n    'Jovany', 'Joy', 'Joyce', 'Juana', 'Juanita', 'Judah', 'Judd', 'Jude',\r\n    'Judge', 'Judson', 'Judy', 'Jules', 'Julia', 'Julian', 'Juliana',\r\n    'Julianne', 'Julie', 'Julien', 'Juliet', 'Julio', 'Julius', 'June',\r\n    'Junior', 'Junius', 'Justen', 'Justice', 'Justina', 'Justine', 'Juston',\r\n    'Justus', 'Justyn', 'Juvenal', 'Juwan', 'Kacey', 'Kaci', 'Kacie', 'Kade',\r\n    'Kaden', 'Kadin', 'Kaela', 'Kaelyn', 'Kaia', 'Kailee', 'Kailey', 'Kailyn',\r\n    'Kaitlin', 'Kaitlyn', 'Kale', 'Kaleb', 'Kaleigh', 'Kaley', 'Kali', 'Kallie',\r\n    'Kameron', 'Kamille', 'Kamren', 'Kamron', 'Kamryn', 'Kane', 'Kara',\r\n    'Kareem', 'Karelle', 'Karen', 'Kari', 'Kariane', 'Karianne', 'Karina',\r\n    'Karine', 'Karl', 'Karlee', 'Karley', 'Karli', 'Karlie', 'Karolann',\r\n    'Karson', 'Kasandra', 'Kasey', 'Kassandra', 'Katarina', 'Katelin',\r\n    'Katelyn', 'Katelynn', 'Katharina', 'Katherine', 'Katheryn', 'Kathleen',\r\n    'Kathlyn', 'Kathryn', 'Kathryne', 'Katlyn', 'Katlynn', 'Katrina', 'Katrine',\r\n    'Kattie', 'Kavon', 'Kay', 'Kaya', 'Kaycee', 'Kayden', 'Kayla', 'Kaylah',\r\n    'Kaylee', 'Kayleigh', 'Kayley', 'Kayli', 'Kaylie', 'Kaylin', 'Keagan',\r\n    'Keanu', 'Keara', 'Keaton', 'Keegan', 'Keeley', 'Keely', 'Keenan', 'Keira',\r\n    'Keith', 'Kellen', 'Kelley', 'Kelli', 'Kellie', 'Kelly', 'Kelsi', 'Kelsie',\r\n    'Kelton', 'Kelvin', 'Ken', 'Kendall', 'Kendra', 'Kendrick', 'Kenna',\r\n    'Kennedi', 'Kennedy', 'Kenneth', 'Kennith', 'Kenny', 'Kenton', 'Kenya',\r\n    'Kenyatta', 'Kenyon', 'Keon', 'Keshaun', 'Keshawn', 'Keven', 'Kevin',\r\n    'Kevon', 'Keyon', 'Keyshawn', 'Khalid', 'Khalil', 'Kian', 'Kiana', 'Kianna',\r\n    'Kiara', 'Kiarra', 'Kiel', 'Kiera', 'Kieran', 'Kiley', 'Kim', 'Kimberly',\r\n    'King', 'Kip', 'Kira', 'Kirk', 'Kirsten', 'Kirstin', 'Kitty', 'Kobe',\r\n    'Koby', 'Kody', 'Kolby', 'Kole', 'Korbin', 'Korey', 'Kory', 'Kraig', 'Kris',\r\n    'Krista', 'Kristian', 'Kristin', 'Kristina', 'Kristofer', 'Kristoffer',\r\n    'Kristopher', 'Kristy', 'Krystal', 'Krystel', 'Krystina', 'Kurt', 'Kurtis',\r\n    'Kyla', 'Kyle', 'Kylee', 'Kyleigh', 'Kyler', 'Kylie', 'Kyra', 'Lacey',\r\n    'Lacy', 'Ladarius', 'Lafayette', 'Laila', 'Laisha', 'Lamar', 'Lambert',\r\n    'Lamont', 'Lance', 'Landen', 'Lane', 'Laney', 'Larissa', 'Laron', 'Larry',\r\n    'Larue', 'Laura', 'Laurel', 'Lauren', 'Laurence', 'Lauretta', 'Lauriane',\r\n    'Laurianne', 'Laurie', 'Laurine', 'Laury', 'Lauryn', 'Lavada', 'Lavern',\r\n    'Laverna', 'Laverne', 'Lavina', 'Lavinia', 'Lavon', 'Lavonne', 'Lawrence',\r\n    'Lawson', 'Layla', 'Layne', 'Lazaro', 'Lea', 'Leann', 'Leanna', 'Leanne',\r\n    'Leatha', 'Leda', 'Lee', 'Leif', 'Leila', 'Leilani', 'Lela', 'Lelah',\r\n    'Leland', 'Lelia', 'Lempi', 'Lemuel', 'Lenna', 'Lennie', 'Lenny', 'Lenora',\r\n    'Lenore', 'Leo', 'Leola', 'Leon', 'Leonard', 'Leonardo', 'Leone', 'Leonel',\r\n    'Leonie', 'Leonor', 'Leonora', 'Leopold', 'Leopoldo', 'Leora', 'Lera',\r\n    'Lesley', 'Leslie', 'Lesly', 'Lessie', 'Lester', 'Leta', 'Letha', 'Letitia',\r\n    'Levi', 'Lew', 'Lewis', 'Lexi', 'Lexie', 'Lexus', 'Lia', 'Liam', 'Liana',\r\n    'Libbie', 'Libby', 'Lila', 'Lilian', 'Liliana', 'Liliane', 'Lilla',\r\n    'Lillian', 'Lilliana', 'Lillie', 'Lilly', 'Lily', 'Lilyan', 'Lina',\r\n    'Lincoln', 'Linda', 'Lindsay', 'Lindsey', 'Linnea', 'Linnie', 'Linwood',\r\n    'Lionel', 'Lisa', 'Lisandro', 'Lisette', 'Litzy', 'Liza', 'Lizeth',\r\n    'Lizzie', 'Llewellyn', 'Lloyd', 'Logan', 'Lois', 'Lola', 'Lolita', 'Loma',\r\n    'Lon', 'London', 'Lonie', 'Lonnie', 'Lonny', 'Lonzo', 'Lora', 'Loraine',\r\n    'Loren', 'Lorena', 'Lorenz', 'Lorenza', 'Lorenzo', 'Lori', 'Lorine',\r\n    'Lorna', 'Lottie', 'Lou', 'Louie', 'Louisa', 'Lourdes', 'Louvenia',\r\n    'Lowell', 'Loy', 'Loyal', 'Loyce', 'Lucas', 'Luciano', 'Lucie', 'Lucienne',\r\n    'Lucile', 'Lucinda', 'Lucio', 'Lucious', 'Lucius', 'Lucy', 'Ludie',\r\n    'Ludwig', 'Lue', 'Luella', 'Luigi', 'Luis', 'Luisa', 'Lukas', 'Lula',\r\n    'Lulu', 'Luna', 'Lupe', 'Lura', 'Lurline', 'Luther', 'Luz', 'Lyda', 'Lydia',\r\n    'Lyla', 'Lynn', 'Lyric', 'Lysanne', 'Mabel', 'Mabelle', 'Mable', 'Mac',\r\n    'Macey', 'Maci', 'Macie', 'Mack', 'Mackenzie', 'Macy', 'Madaline',\r\n    'Madalyn', 'Maddison', 'Madeline', 'Madelyn', 'Madelynn', 'Madge', 'Madie',\r\n    'Madilyn', 'Madisen', 'Madison', 'Madisyn', 'Madonna', 'Madyson', 'Mae',\r\n    'Maegan', 'Maeve', 'Mafalda', 'Magali', 'Magdalen', 'Magdalena', 'Maggie',\r\n    'Magnolia', 'Magnus', 'Maia', 'Maida', 'Maiya', 'Major', 'Makayla',\r\n    'Makenna', 'Makenzie', 'Malachi', 'Malcolm', 'Malika', 'Malinda', 'Mallie',\r\n    'Mallory', 'Malvina', 'Mandy', 'Manley', 'Manuel', 'Manuela', 'Mara',\r\n    'Marc', 'Marcel', 'Marcelina', 'Marcelino', 'Marcella', 'Marcelle',\r\n    'Marcellus', 'Marcelo', 'Marcia', 'Marco', 'Marcos', 'Marcus', 'Margaret',\r\n    'Margarete', 'Margarett', 'Margaretta', 'Margarette', 'Margarita', 'Marge',\r\n    'Margie', 'Margot', 'Margret', 'Marguerite', 'Maria', 'Mariah', 'Mariam',\r\n    'Marian', 'Mariana', 'Mariane', 'Marianna', 'Marianne', 'Mariano',\r\n    'Maribel', 'Marie', 'Mariela', 'Marielle', 'Marietta', 'Marilie', 'Marilou',\r\n    'Marilyne', 'Marina', 'Mario', 'Marion', 'Marisa', 'Marisol', 'Maritza',\r\n    'Marjolaine', 'Marjorie', 'Marjory', 'Mark', 'Markus', 'Marlee', 'Marlen',\r\n    'Marlene', 'Marley', 'Marlin', 'Marlon', 'Marques', 'Marquis', 'Marquise',\r\n    'Marshall', 'Marta', 'Martin', 'Martina', 'Martine', 'Marty', 'Marvin',\r\n    'Mary', 'Maryam', 'Maryjane', 'Maryse', 'Mason', 'Mateo', 'Mathew',\r\n    'Mathias', 'Mathilde', 'Matilda', 'Matilde', 'Matt', 'Matteo', 'Mattie',\r\n    'Maud', 'Maude', 'Maudie', 'Maureen', 'Maurice', 'Mauricio', 'Maurine',\r\n    'Maverick', 'Mavis', 'Max', 'Maxie', 'Maxime', 'Maximilian', 'Maximillia',\r\n    'Maximillian', 'Maximo', 'Maximus', 'Maxine', 'Maxwell', 'May', 'Maya',\r\n    'Maybell', 'Maybelle', 'Maye', 'Maymie', 'Maynard', 'Mayra', 'Mazie',\r\n    'Mckayla', 'Mckenna', 'Mckenzie', 'Meagan', 'Meaghan', 'Meda', 'Megane',\r\n    'Meggie', 'Meghan', 'Mekhi', 'Melany', 'Melba', 'Melisa', 'Melissa',\r\n    'Mellie', 'Melody', 'Melvin', 'Melvina', 'Melyna', 'Melyssa', 'Mercedes',\r\n    'Meredith', 'Merl', 'Merle', 'Merlin', 'Merritt', 'Mertie', 'Mervin',\r\n    'Meta', 'Mia', 'Micaela', 'Micah', 'Michael', 'Michaela', 'Michale',\r\n    'Micheal', 'Michel', 'Michele', 'Michelle', 'Miguel', 'Mikayla', 'Mike',\r\n    'Mikel', 'Milan', 'Miles', 'Milford', 'Miller', 'Millie', 'Milo', 'Milton',\r\n    'Mina', 'Minerva', 'Minnie', 'Miracle', 'Mireille', 'Mireya', 'Misael',\r\n    'Missouri', 'Misty', 'Mitchel', 'Mitchell', 'Mittie', 'Modesta', 'Modesto',\r\n    'Mohamed', 'Mohammad', 'Mohammed', 'Moises', 'Mollie', 'Molly', 'Mona',\r\n    'Monica', 'Monique', 'Monroe', 'Monserrat', 'Monserrate', 'Montana',\r\n    'Monte', 'Monty', 'Morgan', 'Moriah', 'Morris', 'Mortimer', 'Morton',\r\n    'Mose', 'Moses', 'Moshe', 'Mossie', 'Mozell', 'Mozelle', 'Muhammad',\r\n    'Muriel', 'Murl', 'Murphy', 'Murray', 'Mustafa', 'Mya', 'Myah', 'Mylene',\r\n    'Myles', 'Myra', 'Myriam', 'Myrl', 'Myrna', 'Myron', 'Myrtice', 'Myrtie',\r\n    'Myrtis', 'Myrtle', 'Nadia', 'Nakia', 'Name', 'Nannie', 'Naomi', 'Naomie',\r\n    'Napoleon', 'Narciso', 'Nash', 'Nasir', 'Nat', 'Natalia', 'Natalie',\r\n    'Natasha', 'Nathan', 'Nathanael', 'Nathanial', 'Nathaniel', 'Nathen',\r\n    'Nayeli', 'Neal', 'Ned', 'Nedra', 'Neha', 'Neil', 'Nelda', 'Nella', 'Nelle',\r\n    'Nellie', 'Nels', 'Nelson', 'Neoma', 'Nestor', 'Nettie', 'Neva', 'Newell',\r\n    'Newton', 'Nia', 'Nicholas', 'Nicholaus', 'Nichole', 'Nick', 'Nicklaus',\r\n    'Nickolas', 'Nico', 'Nicola', 'Nicolas', 'Nicole', 'Nicolette', 'Nigel',\r\n    'Nikita', 'Nikki', 'Nikko', 'Niko', 'Nikolas', 'Nils', 'Nina', 'Noah',\r\n    'Noble', 'Noe', 'Noel', 'Noelia', 'Noemi', 'Noemie', 'Noemy', 'Nola',\r\n    'Nolan', 'Nona', 'Nora', 'Norbert', 'Norberto', 'Norene', 'Norma', 'Norris',\r\n    'Norval', 'Norwood', 'Nova', 'Novella', 'Nya', 'Nyah', 'Nyasia', 'Obie',\r\n    'Oceane', 'Ocie', 'Octavia', 'Oda', 'Odell', 'Odessa', 'Odie', 'Ofelia',\r\n    'Okey', 'Ola', 'Olaf', 'Ole', 'Olen', 'Oleta', 'Olga', 'Olin', 'Oliver',\r\n    'Ollie', 'Oma', 'Omari', 'Omer', 'Ona', 'Onie', 'Opal', 'Ophelia', 'Ora',\r\n    'Oral', 'Oran', 'Oren', 'Orie', 'Orin', 'Orion', 'Orland', 'Orlando',\r\n    'Orlo', 'Orpha', 'Orrin', 'Orval', 'Orville', 'Osbaldo', 'Osborne', 'Oscar',\r\n    'Osvaldo', 'Oswald', 'Oswaldo', 'Otha', 'Otho', 'Otilia', 'Otis', 'Ottilie',\r\n    'Ottis', 'Otto', 'Ova', 'Owen', 'Ozella', 'Pablo', 'Paige', 'Palma',\r\n    'Pamela', 'Pansy', 'Paolo', 'Paris', 'Parker', 'Pascale', 'Pasquale', 'Pat',\r\n    'Patience', 'Patricia', 'Patrick', 'Patsy', 'Pattie', 'Paul', 'Paula',\r\n    'Pauline', 'Paxton', 'Payton', 'Pearl', 'Pearlie', 'Pearline', 'Pedro',\r\n    'Peggie', 'Penelope', 'Percival', 'Percy', 'Perry', 'Pete', 'Peter',\r\n    'Petra', 'Peyton', 'Philip', 'Phoebe', 'Phyllis', 'Pierce', 'Pierre',\r\n    'Pietro', 'Pink', 'Pinkie', 'Piper', 'Polly', 'Porter', 'Precious',\r\n    'Presley', 'Preston', 'Price', 'Prince', 'Princess', 'Priscilla',\r\n    'Providenci', 'Prudence', 'Queen', 'Queenie', 'Quentin', 'Quincy', 'Quinn',\r\n    'Quinten', 'Quinton', 'Rachael', 'Rachel', 'Rachelle', 'Rae', 'Raegan',\r\n    'Rafael', 'Rafaela', 'Raheem', 'Rahsaan', 'Rahul', 'Raina', 'Raleigh',\r\n    'Ralph', 'Ramiro', 'Ramon', 'Ramona', 'Randal', 'Randall', 'Randi', 'Randy',\r\n    'Ransom', 'Raoul', 'Raphael', 'Raphaelle', 'Raquel', 'Rashad', 'Rashawn',\r\n    'Rasheed', 'Raul', 'Raven', 'Ray', 'Raymond', 'Raymundo', 'Reagan',\r\n    'Reanna', 'Reba', 'Rebeca', 'Rebecca', 'Rebeka', 'Rebekah', 'Reece', 'Reed',\r\n    'Reese', 'Regan', 'Reggie', 'Reginald', 'Reid', 'Reilly', 'Reina',\r\n    'Reinhold', 'Remington', 'Rene', 'Renee', 'Ressie', 'Reta', 'Retha',\r\n    'Retta', 'Reuben', 'Reva', 'Rex', 'Rey', 'Reyes', 'Reymundo', 'Reyna',\r\n    'Reynold', 'Rhea', 'Rhett', 'Rhianna', 'Rhiannon', 'Rhoda', 'Ricardo',\r\n    'Richard', 'Richie', 'Richmond', 'Rick', 'Rickey', 'Rickie', 'Ricky',\r\n    'Rico', 'Rigoberto', 'Riley', 'Rita', 'River', 'Robb', 'Robbie', 'Robert',\r\n    'Roberta', 'Roberto', 'Robin', 'Robyn', 'Rocio', 'Rocky', 'Rod', 'Roderick',\r\n    'Rodger', 'Rodolfo', 'Rodrick', 'Rodrigo', 'Roel', 'Rogelio', 'Roger',\r\n    'Rogers', 'Rolando', 'Rollin', 'Roma', 'Romaine', 'Roman', 'Ron', 'Ronaldo',\r\n    'Ronny', 'Roosevelt', 'Rory', 'Rosa', 'Rosalee', 'Rosalia', 'Rosalind',\r\n    'Rosalinda', 'Rosalyn', 'Rosamond', 'Rosanna', 'Rosario', 'Roscoe', 'Rose',\r\n    'Rosella', 'Roselyn', 'Rosemarie', 'Rosemary', 'Rosendo', 'Rosetta',\r\n    'Rosie', 'Rosina', 'Roslyn', 'Ross', 'Rossie', 'Rowan', 'Rowena', 'Rowland',\r\n    'Roxane', 'Roxanne', 'Roy', 'Royal', 'Royce', 'Rozella', 'Ruben', 'Rubie',\r\n    'Ruby', 'Rubye', 'Rudolph', 'Rudy', 'Rupert', 'Russ', 'Russel', 'Russell',\r\n    'Rusty', 'Ruth', 'Ruthe', 'Ruthie', 'Ryan', 'Ryann', 'Ryder', 'Rylan',\r\n    'Rylee', 'Ryleigh', 'Ryley', 'Sabina', 'Sabrina', 'Sabryna', 'Sadie',\r\n    'Sadye', 'Sage', 'Saige', 'Sallie', 'Sally', 'Salma', 'Salvador',\r\n    'Salvatore', 'Sam', 'Samanta', 'Samantha', 'Samara', 'Samir', 'Sammie',\r\n    'Sammy', 'Samson', 'Sandra', 'Sandrine', 'Sandy', 'Sanford', 'Santa',\r\n    'Santiago', 'Santina', 'Santino', 'Santos', 'Sarah', 'Sarai', 'Sarina',\r\n    'Sasha', 'Saul', 'Savanah', 'Savanna', 'Savannah', 'Savion', 'Scarlett',\r\n    'Schuyler', 'Scot', 'Scottie', 'Scotty', 'Seamus', 'Sean', 'Sebastian',\r\n    'Sedrick', 'Selena', 'Selina', 'Selmer', 'Serena', 'Serenity', 'Seth',\r\n    'Shad', 'Shaina', 'Shakira', 'Shana', 'Shane', 'Shanel', 'Shanelle',\r\n    'Shania', 'Shanie', 'Shaniya', 'Shanna', 'Shannon', 'Shanny', 'Shanon',\r\n    'Shany', 'Sharon', 'Shaun', 'Shawn', 'Shawna', 'Shaylee', 'Shayna',\r\n    'Shayne', 'Shea', 'Sheila', 'Sheldon', 'Shemar', 'Sheridan', 'Sherman',\r\n    'Sherwood', 'Shirley', 'Shyann', 'Shyanne', 'Sibyl', 'Sid', 'Sidney',\r\n    'Sienna', 'Sierra', 'Sigmund', 'Sigrid', 'Sigurd', 'Silas', 'Sim', 'Simeon',\r\n    'Simone', 'Sincere', 'Sister', 'Skye', 'Skyla', 'Skylar', 'Sofia',\r\n    'Soledad', 'Solon', 'Sonia', 'Sonny', 'Sonya', 'Sophia', 'Sophie',\r\n    'Spencer', 'Stacey', 'Stacy', 'Stan', 'Stanford', 'Stanley', 'Stanton',\r\n    'Stefan', 'Stefanie', 'Stella', 'Stephan', 'Stephania', 'Stephanie',\r\n    'Stephany', 'Stephen', 'Stephon', 'Sterling', 'Steve', 'Stevie', 'Stewart',\r\n    'Stone', 'Stuart', 'Summer', 'Sunny', 'Susan', 'Susana', 'Susanna', 'Susie',\r\n    'Suzanne', 'Sven', 'Syble', 'Sydnee', 'Sydney', 'Sydni', 'Sydnie', 'Sylvan',\r\n    'Sylvester', 'Sylvia', 'Tabitha', 'Tad', 'Talia', 'Talon', 'Tamara',\r\n    'Tamia', 'Tania', 'Tanner', 'Tanya', 'Tara', 'Taryn', 'Tate', 'Tatum',\r\n    'Tatyana', 'Taurean', 'Tavares', 'Taya', 'Taylor', 'Teagan', 'Ted', 'Telly',\r\n    'Terence', 'Teresa', 'Terrance', 'Terrell', 'Terrence', 'Terrill', 'Terry',\r\n    'Tess', 'Tessie', 'Tevin', 'Thad', 'Thaddeus', 'Thalia', 'Thea', 'Thelma',\r\n    'Theo', 'Theodora', 'Theodore', 'Theresa', 'Therese', 'Theresia', 'Theron',\r\n    'Thomas', 'Thora', 'Thurman', 'Tia', 'Tiana', 'Tianna', 'Tiara', 'Tierra',\r\n    'Tiffany', 'Tillman', 'Timmothy', 'Timmy', 'Timothy', 'Tina', 'Tito',\r\n    'Titus', 'Tobin', 'Toby', 'Tod', 'Tom', 'Tomas', 'Tomasa', 'Tommie',\r\n    'Toney', 'Toni', 'Tony', 'Torey', 'Torrance', 'Torrey', 'Toy', 'Trace',\r\n    'Tracey', 'Tracy', 'Travis', 'Travon', 'Tre', 'Tremaine', 'Tremayne',\r\n    'Trent', 'Trenton', 'Tressa', 'Tressie', 'Treva', 'Trever', 'Trevion',\r\n    'Trevor', 'Trey', 'Trinity', 'Trisha', 'Tristian', 'Tristin', 'Triston',\r\n    'Troy', 'Trudie', 'Trycia', 'Trystan', 'Turner', 'Twila', 'Tyler', 'Tyra',\r\n    'Tyree', 'Tyreek', 'Tyrel', 'Tyrell', 'Tyrese', 'Tyrique', 'Tyshawn',\r\n    'Tyson', 'Ubaldo', 'Ulices', 'Ulises', 'Una', 'Unique', 'Urban', 'Uriah',\r\n    'Uriel', 'Ursula', 'Vada', 'Valentin', 'Valentina', 'Valentine', 'Valerie',\r\n    'Vallie', 'Van', 'Vance', 'Vanessa', 'Vaughn', 'Veda', 'Velda', 'Vella',\r\n    'Velma', 'Velva', 'Vena', 'Verda', 'Verdie', 'Vergie', 'Verla', 'Verlie',\r\n    'Vern', 'Verna', 'Verner', 'Vernice', 'Vernie', 'Vernon', 'Verona',\r\n    'Veronica', 'Vesta', 'Vicenta', 'Vicente', 'Vickie', 'Vicky', 'Victor',\r\n    'Victoria', 'Vida', 'Vidal', 'Vilma', 'Vince', 'Vincent', 'Vincenza',\r\n    'Vincenzo', 'Vinnie', 'Viola', 'Violet', 'Violette', 'Virgie', 'Virgil',\r\n    'Virginia', 'Virginie', 'Vita', 'Vito', 'Viva', 'Vivian', 'Viviane',\r\n    'Vivianne', 'Vivien', 'Vivienne', 'Vladimir', 'Wade', 'Waino', 'Waldo',\r\n    'Walker', 'Wallace', 'Walter', 'Walton', 'Wanda', 'Ward', 'Warren',\r\n    'Watson', 'Wava', 'Waylon', 'Wayne', 'Webster', 'Weldon', 'Wellington',\r\n    'Wendell', 'Wendy', 'Werner', 'Westley', 'Weston', 'Whitney', 'Wilber',\r\n    'Wilbert', 'Wilburn', 'Wiley', 'Wilford', 'Wilfred', 'Wilfredo', 'Wilfrid',\r\n    'Wilhelm', 'Wilhelmine', 'Will', 'Willa', 'Willard', 'William', 'Willie',\r\n    'Willis', 'Willow', 'Willy', 'Wilma', 'Wilmer', 'Wilson', 'Wilton',\r\n    'Winfield', 'Winifred', 'Winnifred', 'Winona', 'Winston', 'Woodrow',\r\n    'Wyatt', 'Wyman', 'Xander', 'Xavier', 'Xzavier', 'Yadira', 'Yasmeen',\r\n    'Yasmin', 'Yasmine', 'Yazmin', 'Yesenia', 'Yessenia', 'Yolanda', 'Yoshiko',\r\n    'Yvette', 'Yvonne', 'Zachariah', 'Zachary', 'Zachery', 'Zack', 'Zackary',\r\n    'Zackery', 'Zakary', 'Zander', 'Zane', 'Zaria', 'Zechariah', 'Zelda',\r\n    'Zella', 'Zelma', 'Zena', 'Zetta', 'Zion', 'Zita', 'Zoe', 'Zoey', 'Zoie',\r\n    'Zoila', 'Zola', 'Zora', 'Zula'\r\n];\r\n\r\n/**\r\n * Generate random username.\r\n * @returns {string} random username\r\n */\r\nfunction generateUsername() {\r\n    const name = RandomUtil.randomElement(names);\r\n    const suffix = RandomUtil.randomAlphanumStr(3);\r\n\r\n    return `${name}-${suffix}`;\r\n}\r\n\r\nmodule.exports = {\r\n    generateUsername\r\n};\r\n","/* global $, __filename */\r\n\r\nimport { getLogger } from 'jitsi-meet-logger';\r\nimport { $iq, Strophe } from 'strophe.js';\r\n\r\nimport {\r\n    ACTION_JINGLE_TR_RECEIVED,\r\n    ACTION_JINGLE_TR_SUCCESS,\r\n    createJingleEvent\r\n} from '../../service/statistics/AnalyticsEvents';\r\nimport XMPPEvents from '../../service/xmpp/XMPPEvents';\r\nimport Statistics from '../statistics/statistics';\r\nimport GlobalOnErrorHandler from '../util/GlobalOnErrorHandler';\r\nimport RandomUtil from '../util/RandomUtil';\r\n\r\nimport ConnectionPlugin from './ConnectionPlugin';\r\nimport JingleSessionPC from './JingleSessionPC';\r\n\r\nconst logger = getLogger(__filename);\r\n\r\n// XXX Strophe is build around the idea of chaining function calls so allow long\r\n// function call chains.\r\n/* eslint-disable newline-per-chained-call */\r\n\r\n/**\r\n *\r\n */\r\nexport default class JingleConnectionPlugin extends ConnectionPlugin {\r\n    /**\r\n     * Creates new <tt>JingleConnectionPlugin</tt>\r\n     * @param {XMPP} xmpp\r\n     * @param {EventEmitter} eventEmitter\r\n     * @param {Object} iceConfig an object that holds the iceConfig to be passed\r\n     * to the p2p and the jvb <tt>PeerConnection</tt>.\r\n     */\r\n    constructor(xmpp, eventEmitter, iceConfig) {\r\n        super();\r\n        this.xmpp = xmpp;\r\n        this.eventEmitter = eventEmitter;\r\n        this.sessions = {};\r\n        this.jvbIceConfig = iceConfig.jvb;\r\n        this.p2pIceConfig = iceConfig.p2p;\r\n        this.mediaConstraints = {\r\n            offerToReceiveAudio: true,\r\n            offerToReceiveVideo: true\r\n        };\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param connection\r\n     */\r\n    init(connection) {\r\n        super.init(connection);\r\n        this.connection.addHandler(this.onJingle.bind(this),\r\n            'urn:xmpp:jingle:1', 'iq', 'set', null, null);\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param iq\r\n     */\r\n    onJingle(iq) {\r\n        const sid = $(iq).find('jingle').attr('sid');\r\n        const action = $(iq).find('jingle').attr('action');\r\n        const fromJid = iq.getAttribute('from');\r\n\r\n        // send ack first\r\n        const ack = $iq({ type: 'result',\r\n            to: fromJid,\r\n            id: iq.getAttribute('id')\r\n        });\r\n\r\n        logger.log(`on jingle ${action} from ${fromJid}`, iq);\r\n        let sess = this.sessions[sid];\r\n\r\n        if (action !== 'session-initiate') {\r\n            if (!sess) {\r\n                ack.attrs({ type: 'error' });\r\n                ack.c('error', { type: 'cancel' })\r\n                    .c('item-not-found', {\r\n                        xmlns: 'urn:ietf:params:xml:ns:xmpp-stanzas'\r\n                    })\r\n                    .up()\r\n                    .c('unknown-session', {\r\n                        xmlns: 'urn:xmpp:jingle:errors:1'\r\n                    });\r\n                logger.warn('invalid session id', iq);\r\n                this.connection.send(ack);\r\n\r\n                return true;\r\n            }\r\n\r\n            // local jid is not checked\r\n            if (fromJid !== sess.remoteJid) {\r\n                logger.warn(\r\n                    'jid mismatch for session id', sid, sess.remoteJid, iq);\r\n                ack.attrs({ type: 'error' });\r\n                ack.c('error', { type: 'cancel' })\r\n                    .c('item-not-found', {\r\n                        xmlns: 'urn:ietf:params:xml:ns:xmpp-stanzas'\r\n                    })\r\n                    .up()\r\n                    .c('unknown-session', {\r\n                        xmlns: 'urn:xmpp:jingle:errors:1'\r\n                    });\r\n                this.connection.send(ack);\r\n\r\n                return true;\r\n            }\r\n        } else if (sess !== undefined) {\r\n            // Existing session with same session id. This might be out-of-order\r\n            // if the sess.remoteJid is the same as from.\r\n            ack.attrs({ type: 'error' });\r\n            ack.c('error', { type: 'cancel' })\r\n                .c('service-unavailable', {\r\n                    xmlns: 'urn:ietf:params:xml:ns:xmpp-stanzas'\r\n                })\r\n                .up();\r\n            logger.warn('duplicate session id', sid, iq);\r\n            this.connection.send(ack);\r\n\r\n            return true;\r\n        }\r\n        const now = window.performance.now();\r\n\r\n        // FIXME that should work most of the time, but we'd have to\r\n        // think how secure it is to assume that user with \"focus\"\r\n        // nickname is Jicofo.\r\n        const isP2P = Strophe.getResourceFromJid(fromJid) !== 'focus';\r\n\r\n        // see http://xmpp.org/extensions/xep-0166.html#concepts-session\r\n\r\n        switch (action) {\r\n        case 'session-initiate': {\r\n            logger.log('(TIME) received session-initiate:\\t', now);\r\n            const startMuted = $(iq).find('jingle>startmuted');\r\n\r\n            if (startMuted && startMuted.length > 0) {\r\n                const audioMuted = startMuted.attr('audio');\r\n                const videoMuted = startMuted.attr('video');\r\n\r\n                this.eventEmitter.emit(\r\n                    XMPPEvents.START_MUTED_FROM_FOCUS,\r\n                    audioMuted === 'true',\r\n                    videoMuted === 'true');\r\n            }\r\n\r\n            logger.info(\r\n                `Marking session from ${fromJid\r\n                } as ${isP2P ? '' : '*not*'} P2P`);\r\n\r\n            const iceConfig = isP2P ? this.p2pIceConfig : this.jvbIceConfig;\r\n\r\n            sess\r\n                = new JingleSessionPC(\r\n                    $(iq).find('jingle').attr('sid'),\r\n                    $(iq).attr('to'),\r\n                    fromJid,\r\n                    this.connection,\r\n                    this.mediaConstraints,\r\n\r\n                    // Makes a copy in order to prevent exception thrown on RN when either this.p2pIceConfig or\r\n                    // this.jvbIceConfig is modified and there's a PeerConnection instance holding a reference\r\n                    JSON.parse(JSON.stringify(iceConfig)),\r\n                    isP2P,\r\n                    /* initiator */ false);\r\n\r\n            this.sessions[sess.sid] = sess;\r\n\r\n            this.eventEmitter.emit(XMPPEvents.CALL_INCOMING,\r\n                sess, $(iq).find('>jingle'), now);\r\n            break;\r\n        }\r\n        case 'session-accept': {\r\n            this.eventEmitter.emit(\r\n                XMPPEvents.CALL_ACCEPTED, sess, $(iq).find('>jingle'));\r\n            break;\r\n        }\r\n        case 'content-modify': {\r\n            sess.modifyContents($(iq).find('>jingle'));\r\n            break;\r\n        }\r\n        case 'transport-info': {\r\n            this.eventEmitter.emit(\r\n                XMPPEvents.TRANSPORT_INFO, sess, $(iq).find('>jingle'));\r\n            break;\r\n        }\r\n        case 'session-terminate': {\r\n            logger.log('terminating...', sess.sid);\r\n            let reasonCondition = null;\r\n            let reasonText = null;\r\n\r\n            if ($(iq).find('>jingle>reason').length) {\r\n                reasonCondition\r\n                    = $(iq).find('>jingle>reason>:first')[0].tagName;\r\n                reasonText = $(iq).find('>jingle>reason>text').text();\r\n            }\r\n            this.terminate(sess.sid, reasonCondition, reasonText);\r\n            this.eventEmitter.emit(XMPPEvents.CALL_ENDED,\r\n                sess, reasonCondition, reasonText);\r\n            break;\r\n        }\r\n        case 'transport-replace':\r\n            logger.info('(TIME) Start transport replace:\\t', now);\r\n            Statistics.sendAnalytics(createJingleEvent(\r\n                ACTION_JINGLE_TR_RECEIVED,\r\n                {\r\n                    p2p: isP2P,\r\n                    value: now\r\n                }));\r\n\r\n            sess.replaceTransport($(iq).find('>jingle'), () => {\r\n                const successTime = window.performance.now();\r\n\r\n                logger.info('(TIME) Transport replace success:\\t', successTime);\r\n                Statistics.sendAnalytics(createJingleEvent(\r\n                    ACTION_JINGLE_TR_SUCCESS,\r\n                    {\r\n                        p2p: isP2P,\r\n                        value: successTime\r\n                    }));\r\n            }, error => {\r\n                GlobalOnErrorHandler.callErrorHandler(error);\r\n                logger.error('Transport replace failed', error);\r\n                sess.sendTransportReject();\r\n            });\r\n            break;\r\n        case 'addsource': // FIXME: proprietary, un-jingleish\r\n        case 'source-add': // FIXME: proprietary\r\n            sess.addRemoteStream($(iq).find('>jingle>content'));\r\n            break;\r\n        case 'removesource': // FIXME: proprietary, un-jingleish\r\n        case 'source-remove': // FIXME: proprietary\r\n            sess.removeRemoteStream($(iq).find('>jingle>content'));\r\n            break;\r\n        default:\r\n            logger.warn('jingle action not implemented', action);\r\n            ack.attrs({ type: 'error' });\r\n            ack.c('error', { type: 'cancel' })\r\n                .c('bad-request',\r\n                    { xmlns: 'urn:ietf:params:xml:ns:xmpp-stanzas' })\r\n                .up();\r\n            break;\r\n        }\r\n        this.connection.send(ack);\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Creates new <tt>JingleSessionPC</tt> meant to be used in a direct P2P\r\n     * connection, configured as 'initiator'.\r\n     * @param {string} me our JID\r\n     * @param {string} peer remote participant's JID\r\n     * @return {JingleSessionPC}\r\n     */\r\n    newP2PJingleSession(me, peer) {\r\n        const sess\r\n            = new JingleSessionPC(\r\n                RandomUtil.randomHexString(12),\r\n                me,\r\n                peer,\r\n                this.connection,\r\n                this.mediaConstraints,\r\n                this.p2pIceConfig,\r\n                /* P2P */ true,\r\n                /* initiator */ true);\r\n\r\n        this.sessions[sess.sid] = sess;\r\n\r\n        return sess;\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param sid\r\n     * @param reasonCondition\r\n     * @param reasonText\r\n     */\r\n    terminate(sid, reasonCondition, reasonText) {\r\n        if (this.sessions.hasOwnProperty(sid)) {\r\n            if (this.sessions[sid].state !== 'ended') {\r\n                this.sessions[sid].onTerminated(reasonCondition, reasonText);\r\n            }\r\n            delete this.sessions[sid];\r\n        }\r\n    }\r\n\r\n    /**\r\n     *\r\n     */\r\n    getStunAndTurnCredentials() {\r\n        // get stun and turn configuration from server via xep-0215\r\n        // uses time-limited credentials as described in\r\n        // http://tools.ietf.org/html/draft-uberti-behave-turn-rest-00\r\n        //\r\n        // See https://modules.prosody.im/mod_turncredentials.html\r\n        // for a prosody module which implements this.\r\n        // Or the new implementation https://modules.prosody.im/mod_external_services which will be in prosody 0.12\r\n        //\r\n        // Currently, this doesn't work with updateIce and therefore credentials\r\n        // with a long validity have to be fetched before creating the\r\n        // peerconnection.\r\n        // TODO: implement refresh via updateIce as described in\r\n        //      https://code.google.com/p/webrtc/issues/detail?id=1650\r\n        this.connection.sendIQ(\r\n            $iq({ type: 'get',\r\n                to: this.xmpp.options.hosts.domain })\r\n                .c('services', { xmlns: 'urn:xmpp:extdisco:2' }),\r\n            v2Res => this.onReceiveStunAndTurnCredentials(v2Res),\r\n            v2Err => {\r\n                logger.warn('getting turn credentials with extdisco:2 failed, trying extdisco:1', v2Err);\r\n                this.connection.sendIQ(\r\n                    $iq({ type: 'get',\r\n                        to: this.xmpp.options.hosts.domain })\r\n                        .c('services', { xmlns: 'urn:xmpp:extdisco:1' }),\r\n                    v1Res => this.onReceiveStunAndTurnCredentials(v1Res),\r\n                    v1Err => {\r\n                        logger.warn('getting turn credentials failed', v1Err);\r\n                        logger.warn('is mod_turncredentials or similar installed and configured?');\r\n                    }\r\n                );\r\n            });\r\n    }\r\n\r\n    /**\r\n     * Parses response when querying for services using urn:xmpp:extdisco:1 or urn:xmpp:extdisco:2.\r\n     * Stores results in jvbIceConfig and p2pIceConfig.\r\n     * @param res The response iq.\r\n     * @return {boolean} Whether something was processed from the supplied message.\r\n     */\r\n    onReceiveStunAndTurnCredentials(res) {\r\n        const iceservers = [];\r\n\r\n        $(res).find('>services>service').each((idx, el) => {\r\n            // eslint-disable-next-line no-param-reassign\r\n            el = $(el);\r\n            const dict = {};\r\n            const type = el.attr('type');\r\n\r\n            switch (type) {\r\n            case 'stun':\r\n                dict.urls = `stun:${el.attr('host')}`;\r\n                if (el.attr('port')) {\r\n                    dict.urls += `:${el.attr('port')}`;\r\n                }\r\n                iceservers.push(dict);\r\n                break;\r\n            case 'turn':\r\n            case 'turns': {\r\n                dict.urls = `${type}:`;\r\n                dict.username = el.attr('username');\r\n                dict.urls += el.attr('host');\r\n                const port = el.attr('port');\r\n\r\n                if (port) {\r\n                    dict.urls += `:${el.attr('port')}`;\r\n                }\r\n                const transport = el.attr('transport');\r\n\r\n                if (transport && transport !== 'udp') {\r\n                    dict.urls += `?transport=${transport}`;\r\n                }\r\n\r\n                dict.credential = el.attr('password')\r\n                        || dict.credential;\r\n                iceservers.push(dict);\r\n                break;\r\n            }\r\n            }\r\n        });\r\n\r\n        const options = this.xmpp.options;\r\n\r\n        // Shuffle ICEServers for loadbalancing\r\n        for (let i = iceservers.length - 1; i > 0; i--) {\r\n            const j = Math.floor(Math.random() * (i + 1));\r\n            const temp = iceservers[i];\r\n\r\n            iceservers[i] = iceservers[j];\r\n            iceservers[j] = temp;\r\n        }\r\n\r\n        let filter;\r\n\r\n        if (options.useTurnUdp) {\r\n            filter = s => s.urls.startsWith('turn');\r\n        } else {\r\n            // By default we filter out STUN and TURN/UDP and leave only TURN/TCP.\r\n            filter = s => s.urls.startsWith('turn') && (s.urls.indexOf('transport=tcp') >= 0);\r\n        }\r\n\r\n        this.jvbIceConfig.iceServers = iceservers.filter(filter);\r\n        this.p2pIceConfig.iceServers = iceservers;\r\n\r\n        return iceservers.length > 0;\r\n    }\r\n\r\n    /**\r\n     * Returns the data saved in 'updateLog' in a format to be logged.\r\n     */\r\n    getLog() {\r\n        const data = {};\r\n\r\n        Object.keys(this.sessions).forEach(sid => {\r\n            const session = this.sessions[sid];\r\n            const pc = session.peerconnection;\r\n\r\n            if (pc && pc.updateLog) {\r\n                // FIXME: should probably be a .dump call\r\n                data[`jingle_${sid}`] = {\r\n                    updateLog: pc.updateLog,\r\n                    stats: pc.stats,\r\n                    url: window.location.href\r\n                };\r\n            }\r\n        });\r\n\r\n        return data;\r\n    }\r\n}\r\n\r\n/* eslint-enable newline-per-chained-call */\r\n","/* global __filename */\r\n\r\nimport async from 'async';\r\nimport { getLogger } from 'jitsi-meet-logger';\r\n\r\nconst logger = getLogger(__filename);\r\n\r\n/**\r\n * A queue for async task execution.\r\n */\r\nexport default class AsyncQueue {\r\n    /**\r\n     * Creates new instance.\r\n     */\r\n    constructor() {\r\n        this._queue = async.queue(this._processQueueTasks.bind(this), 1);\r\n        this._stopped = false;\r\n    }\r\n\r\n    /**\r\n     * Removes any pending tasks from the queue.\r\n     */\r\n    clear() {\r\n        this._queue.kill();\r\n    }\r\n\r\n    /**\r\n     * Internal task processing implementation which makes things work.\r\n     */\r\n    _processQueueTasks(task, finishedCallback) {\r\n        try {\r\n            task(finishedCallback);\r\n        } catch (error) {\r\n            logger.error(`Task failed: ${error}`);\r\n            finishedCallback(error);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * The 'task' function will be given a callback it MUST call with either:\r\n     *  1) No arguments if it was successful or\r\n     *  2) An error argument if there was an error\r\n     * If the task wants to process the success or failure of the task, it\r\n     * should pass the {@code callback} to the push function, e.g.:\r\n     * queue.push(task, (err) => {\r\n     *     if (err) {\r\n     *         // error handling\r\n     *     } else {\r\n     *         // success handling\r\n     *     }\r\n     * });\r\n     *\r\n     * @param {function} task - The task to be executed. See the description above.\r\n     * @param {function} [callback] - Optional callback to be called after the task has been executed.\r\n     */\r\n    push(task, callback) {\r\n        if (this._stopped) {\r\n            callback && callback(new Error('The queue has been stopped'));\r\n\r\n            return;\r\n        }\r\n        this._queue.push(task, callback);\r\n    }\r\n\r\n    /**\r\n     * Shutdowns the queue. All already queued tasks will execute, but no future tasks can be added. If a task is added\r\n     * after the queue has been shutdown then the callback will be called with an error.\r\n     */\r\n    shutdown() {\r\n        this._stopped = true;\r\n    }\r\n}\r\n","/**\r\n * Implements a simple hash code for a string (see\r\n * https://en.wikipedia.org/wiki/Java_hashCode()).\r\n *\r\n * @param {string} The string to return a hash of.\r\n * @return {Number} the integer hash code of the string.\r\n */\r\nfunction integerHash(string) {\r\n    if (!string) {\r\n        return 0;\r\n    }\r\n\r\n    let char, hash = 0, i;\r\n\r\n    for (i = 0; i < string.length; i++) {\r\n        char = string.charCodeAt(i);\r\n        hash += char * Math.pow(31, string.length - 1 - i);\r\n        hash = Math.abs(hash | 0); // eslint-disable-line no-bitwise\r\n    }\r\n\r\n    return hash;\r\n}\r\n\r\nmodule.exports = { integerHash };\r\n","/* global __filename */\r\nimport { getLogger } from 'jitsi-meet-logger';\r\n\r\nimport Listenable from '../util/Listenable';\r\n\r\nimport * as JingleSessionState from './JingleSessionState';\r\n\r\nconst logger = getLogger(__filename);\r\n\r\n/**\r\n * JingleSession provides an API to manage a single Jingle session. We will\r\n * have different implementations depending on the underlying interface used\r\n * (i.e. WebRTC and ORTC) and here we hold the code common to all of them.\r\n */\r\nexport default class JingleSession extends Listenable {\r\n\r\n    /* eslint-disable max-params */\r\n\r\n    /**\r\n     * Creates new <tt>JingleSession</tt>.\r\n     * @param {string} sid the Jingle session identifier\r\n     * @param {string} localJid our JID\r\n     * @param {string} remoteJid the JID of the remote peer\r\n     * @param {XmppConnection} connection the XMPP connection\r\n     * @param {Object} mediaConstraints the media constraints object passed to\r\n     * the PeerConnection onCreateAnswer/Offer as defined by the WebRTC.\r\n     * @param {Object} iceConfig the ICE servers config object as defined by\r\n     * the WebRTC. Passed to the PeerConnection's constructor.\r\n     * @param {boolean} isInitiator indicates if it will be the side which\r\n     * initiates the session.\r\n     */\r\n    constructor(\r\n            sid,\r\n            localJid,\r\n            remoteJid,\r\n            connection,\r\n            mediaConstraints,\r\n            iceConfig,\r\n            isInitiator) {\r\n        super();\r\n        this.sid = sid;\r\n        this.localJid = localJid;\r\n        this.remoteJid = remoteJid;\r\n        this.connection = connection;\r\n        this.mediaConstraints = mediaConstraints;\r\n        this.iceConfig = iceConfig;\r\n\r\n        /**\r\n         * Indicates whether this instance is an initiator or an answerer of\r\n         * the Jingle session.\r\n         * @type {boolean}\r\n         */\r\n        this.isInitiator = isInitiator;\r\n\r\n        /**\r\n         * Whether to use dripping or not. Dripping is sending trickle\r\n         * candidates not one-by-one.\r\n         */\r\n        this.usedrip = true;\r\n\r\n        /**\r\n         *  When dripping is used, stores ICE candidates which are to be sent.\r\n         */\r\n        this.dripContainer = [];\r\n\r\n        /**\r\n         * The chat room instance associated with the session.\r\n         * @type {ChatRoom}\r\n         */\r\n        this.room = null;\r\n\r\n        /**\r\n         * Jingle session state - uninitialized until {@link initialize} is\r\n         * called @type {JingleSessionState}\r\n         */\r\n        this.state = null;\r\n\r\n        /**\r\n         * The RTC service instance\r\n         * @type {RTC}\r\n         */\r\n        this.rtc = null;\r\n    }\r\n\r\n    /**\r\n     * Returns XMPP address of this session's initiator.\r\n     * @return {string}\r\n     */\r\n    get initiatorJid() {\r\n        return this.isInitiator ? this.localJid : this.remoteJid;\r\n    }\r\n\r\n    /**\r\n     * Returns XMPP address of this session's responder.\r\n     * @return {string}\r\n     */\r\n    get responderJid() {\r\n        return this.isInitiator ? this.remoteJid : this.localJid;\r\n    }\r\n\r\n    /* eslint-enable max-params */\r\n\r\n    /**\r\n     * Prepares this object to initiate a session.\r\n     * @param {ChatRoom} room the chat room for the conference associated with\r\n     * this session\r\n     * @param {RTC} rtc the RTC service instance\r\n     * @param {object} options - the options, see implementing class's\r\n     * {@link #doInitialize} description for more details.\r\n     */\r\n    initialize(room, rtc, options) {\r\n        if (this.state !== null) {\r\n            const errmsg\r\n                = `attempt to initiate on session ${this.sid}\r\n                   in state ${this.state}`;\r\n\r\n            logger.error(errmsg);\r\n            throw new Error(errmsg);\r\n        }\r\n        this.room = room;\r\n        this.rtc = rtc;\r\n        this.state = JingleSessionState.PENDING;\r\n        this.doInitialize(options);\r\n    }\r\n\r\n    /**\r\n     * The implementing class finishes initialization here. Called at the end of\r\n     * {@link initialize}.\r\n     * @param {Object} options - The options specific to the implementing class.\r\n     * @protected\r\n     */\r\n    doInitialize(options) { } // eslint-disable-line no-unused-vars, no-empty-function, max-len\r\n\r\n    /* eslint-disable no-unused-vars, no-empty-function */\r\n\r\n    /**\r\n     * Adds the ICE candidates found in the 'contents' array as remote\r\n     * candidates?\r\n     * Note: currently only used on transport-info\r\n     *\r\n     * @param contents\r\n     */\r\n    addIceCandidates(contents) {}\r\n\r\n    /* eslint-enable no-unused-vars, no-empty-function */\r\n\r\n    /**\r\n     * Returns current state of this <tt>JingleSession</tt> instance.\r\n     * @returns {JingleSessionState} the current state of this session instance.\r\n     */\r\n    getState() {\r\n        return this.state;\r\n    }\r\n\r\n    /* eslint-disable no-unused-vars, no-empty-function */\r\n\r\n    /**\r\n     * Handles an 'add-source' event.\r\n     *\r\n     * @param contents an array of Jingle 'content' elements.\r\n     */\r\n    addSources(contents) {}\r\n\r\n    /**\r\n     * Handles a 'remove-source' event.\r\n     *\r\n     * @param contents an array of Jingle 'content' elements.\r\n     */\r\n    removeSources(contents) {}\r\n\r\n    /**\r\n     * Terminates this Jingle session by sending session-terminate\r\n     * @param success a callback called once the 'session-terminate' packet has\r\n     * been acknowledged with RESULT.\r\n     * @param failure a callback called when either timeout occurs or ERROR\r\n     * response is received.\r\n     * @param {Object} options\r\n     * @param {string} [options.reason] XMPP Jingle error condition\r\n     * @param {string} [options.reasonDescription] some meaningful error message\r\n     * @param {boolean} [options.requestRestart=false] set to true to ask Jicofo to start a new session one this once is\r\n     * terminated.\r\n     * @param {boolean} [options.sendSessionTerminate=true] set to false to skip\r\n     * sending session-terminate. It may not make sense to send it if the XMPP\r\n     * connection has been closed already or if the remote peer has disconnected\r\n     */\r\n    terminate(success, failure, options) {}\r\n\r\n    /**\r\n     * Handles an offer from the remote peer (prepares to accept a session).\r\n     * @param jingle the 'jingle' XML element.\r\n     * @param success callback called when we the incoming session has been\r\n     * accepted\r\n     * @param failure callback called when we fail for any reason, will supply\r\n     * error object with details(which is meant more to be printed to the logger\r\n     * than analysed in the code, as the error is unrecoverable anyway)\r\n     */\r\n    acceptOffer(jingle, success, failure) {}\r\n\r\n    /**\r\n     * Returns the JID of the initiator of the jingle session.\r\n     */\r\n    _getInitiatorJid() {\r\n        return this.isInitiator ? this.localJid : this.remoteJid;\r\n    }\r\n\r\n    /* eslint-enable no-unused-vars, no-empty-function */\r\n}\r\n","/* global __filename */\r\n\r\nimport { getLogger } from 'jitsi-meet-logger';\r\n\r\nimport * as MediaType from '../../service/RTC/MediaType';\r\nimport * as SignalingEvents from '../../service/RTC/SignalingEvents';\r\nimport SignalingLayer from '../../service/RTC/SignalingLayer';\r\n\r\nconst logger = getLogger(__filename);\r\n\r\n/**\r\n * Default XMPP implementation of the {@link SignalingLayer} interface. Obtains\r\n * the data from the MUC presence.\r\n */\r\nexport default class SignalingLayerImpl extends SignalingLayer {\r\n    /**\r\n     * Creates new instance.\r\n     */\r\n    constructor() {\r\n        super();\r\n\r\n        /**\r\n         * A map that stores SSRCs of remote streams. And is used only locally\r\n         * We store the mapping when jingle is received, and later is used\r\n         * onaddstream webrtc event where we have only the ssrc\r\n         * FIXME: This map got filled and never cleaned and can grow during long\r\n         * conference\r\n         * @type {Map<number, string>} maps SSRC number to jid\r\n         */\r\n        this.ssrcOwners = new Map();\r\n\r\n        /**\r\n         *\r\n         * @type {ChatRoom|null}\r\n         */\r\n        this.chatRoom = null;\r\n    }\r\n\r\n    /**\r\n     * Sets the <tt>ChatRoom</tt> instance used and binds presence listeners.\r\n     * @param {ChatRoom} room\r\n     */\r\n    setChatRoom(room) {\r\n        const oldChatRoom = this.chatRoom;\r\n\r\n        this.chatRoom = room;\r\n        if (oldChatRoom) {\r\n            oldChatRoom.removePresenceListener(\r\n                'audiomuted', this._audioMuteHandler);\r\n            oldChatRoom.removePresenceListener(\r\n                'videomuted', this._videoMuteHandler);\r\n            oldChatRoom.removePresenceListener(\r\n                'videoType', this._videoTypeHandler);\r\n        }\r\n        if (room) {\r\n            // SignalingEvents\r\n            this._audioMuteHandler = (node, from) => {\r\n                this.eventEmitter.emit(\r\n                    SignalingEvents.PEER_MUTED_CHANGED,\r\n                    from, MediaType.AUDIO, node.value === 'true');\r\n            };\r\n            room.addPresenceListener('audiomuted', this._audioMuteHandler);\r\n\r\n            this._videoMuteHandler = (node, from) => {\r\n                this.eventEmitter.emit(\r\n                    SignalingEvents.PEER_MUTED_CHANGED,\r\n                    from, MediaType.VIDEO, node.value === 'true');\r\n            };\r\n            room.addPresenceListener('videomuted', this._videoMuteHandler);\r\n\r\n            this._videoTypeHandler = (node, from) => {\r\n                this.eventEmitter.emit(\r\n                    SignalingEvents.PEER_VIDEO_TYPE_CHANGED,\r\n                    from, node.value);\r\n            };\r\n            room.addPresenceListener('videoType', this._videoTypeHandler);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * @inheritDoc\r\n     */\r\n    getPeerMediaInfo(owner, mediaType) {\r\n        if (this.chatRoom) {\r\n            return this.chatRoom.getMediaPresenceInfo(owner, mediaType);\r\n        }\r\n        logger.error('Requested peer media info, before room was set');\r\n    }\r\n\r\n    /**\r\n     * @inheritDoc\r\n     */\r\n    getSSRCOwner(ssrc) {\r\n        return this.ssrcOwners.get(ssrc);\r\n    }\r\n\r\n    /**\r\n     * Set an SSRC owner.\r\n     * @param {number} ssrc an SSRC to be owned\r\n     * @param {string} endpointId owner's ID (MUC nickname)\r\n     * @throws TypeError if <tt>ssrc</tt> is not a number\r\n     */\r\n    setSSRCOwner(ssrc, endpointId) {\r\n        if (typeof ssrc !== 'number') {\r\n            throw new TypeError(`SSRC(${ssrc}) must be a number`);\r\n        }\r\n        this.ssrcOwners.set(ssrc, endpointId);\r\n    }\r\n}\r\n","\r\nimport Listenable from '../../modules/util/Listenable';\r\n\r\n/**\r\n * An object that carries the info about specific media type advertised by\r\n * participant in the signaling channel.\r\n * @typedef {Object} PeerMediaInfo\r\n * @property {boolean} muted indicates if the media is currently muted\r\n * @property {VideoType|undefined} videoType the type of the video if applicable\r\n */\r\n\r\n/**\r\n * Interface used to expose the information carried over the signaling channel\r\n * which is not available to the RTC module in the media SDP.\r\n *\r\n * @interface SignalingLayer\r\n */\r\nexport default class SignalingLayer extends Listenable {\r\n\r\n    /**\r\n     * Obtains the endpoint ID for given SSRC.\r\n     * @param {number} ssrc the SSRC number.\r\n     * @return {string|null} the endpoint ID for given media SSRC.\r\n     */\r\n    getSSRCOwner(ssrc) { // eslint-disable-line no-unused-vars\r\n        throw new Error('not implemented');\r\n    }\r\n\r\n    /**\r\n     * Obtains the info about given media advertised in the MUC presence of\r\n     * the participant identified by the given MUC JID.\r\n     * @param {string} owner the MUC jid of the participant for whom\r\n     * {@link PeerMediaInfo} will be obtained.\r\n     * @param {MediaType} mediaType the type of the media for which presence\r\n     * info will be obtained.\r\n     * @return {PeerMediaInfo|null} presenceInfo an object with media presence\r\n     * info or <tt>null</tt> either if there is no presence available for given\r\n     * JID or if the media type given is invalid.\r\n     */\r\n    getPeerMediaInfo(owner, mediaType) { // eslint-disable-line no-unused-vars\r\n        throw new Error('not implemented');\r\n    }\r\n}\r\n","import { Strophe } from 'strophe.js';\r\n\r\nimport ConnectionPlugin from './ConnectionPlugin';\r\n\r\n/**\r\n *  Logs raw stanzas and makes them available for download as JSON\r\n */\r\nclass StropheLogger extends ConnectionPlugin {\r\n    /**\r\n     *\r\n     */\r\n    constructor() {\r\n        super();\r\n        this.log = [];\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param connection\r\n     */\r\n    init(connection) {\r\n        super.init(connection);\r\n        this.connection.rawInput = this.logIncoming.bind(this);\r\n        this.connection.rawOutput = this.logOutgoing.bind(this);\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param stanza\r\n     */\r\n    logIncoming(stanza) {\r\n        this.log.push([ new Date().getTime(), 'incoming', stanza ]);\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param stanza\r\n     */\r\n    logOutgoing(stanza) {\r\n        this.log.push([ new Date().getTime(), 'outgoing', stanza ]);\r\n    }\r\n}\r\n\r\n/**\r\n *\r\n */\r\nexport default function() {\r\n    Strophe.addConnectionPlugin('logger', new StropheLogger());\r\n}\r\n","/* global $ */\r\n\r\nimport { getLogger } from 'jitsi-meet-logger';\r\nimport { $iq } from 'strophe.js';\r\n\r\nimport ConnectionPlugin from './ConnectionPlugin';\r\n\r\nconst logger = getLogger(__filename);\r\n\r\nconst RAYO_XMLNS = 'urn:xmpp:rayo:1';\r\n\r\n/**\r\n *\r\n */\r\nexport default class RayoConnectionPlugin extends ConnectionPlugin {\r\n    /**\r\n     *\r\n     * @param connection\r\n     */\r\n    init(connection) {\r\n        super.init(connection);\r\n\r\n        this.connection.addHandler(\r\n            this.onRayo.bind(this), RAYO_XMLNS, 'iq', 'set', null, null);\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param iq\r\n     */\r\n    onRayo(iq) {\r\n        logger.info('Rayo IQ', iq);\r\n    }\r\n\r\n    /* eslint-disable max-params */\r\n\r\n    /**\r\n     *\r\n     * @param to\r\n     * @param from\r\n     * @param roomName\r\n     * @param roomPass\r\n     * @param focusMucJid\r\n     */\r\n    dial(to, from, roomName, roomPass, focusMucJid) {\r\n        return new Promise((resolve, reject) => {\r\n            if (!focusMucJid) {\r\n                reject(new Error('Internal error!'));\r\n\r\n                return;\r\n            }\r\n            const req = $iq({\r\n                type: 'set',\r\n                to: focusMucJid\r\n            });\r\n\r\n            req.c('dial', {\r\n                xmlns: RAYO_XMLNS,\r\n                to,\r\n                from\r\n            });\r\n            req.c('header', {\r\n                name: 'JvbRoomName',\r\n                value: roomName\r\n            }).up();\r\n\r\n            if (roomPass && roomPass.length) {\r\n                req.c('header', {\r\n                    name: 'JvbRoomPassword',\r\n                    value: roomPass\r\n                }).up();\r\n            }\r\n\r\n            this.connection.sendIQ(\r\n                req,\r\n                result => {\r\n                    logger.info('Dial result ', result);\r\n\r\n                    // eslint-disable-next-line newline-per-chained-call\r\n                    const resource = $(result).find('ref').attr('uri');\r\n\r\n                    this.callResource = resource.substr('xmpp:'.length);\r\n                    logger.info(`Received call resource: ${this.callResource}`);\r\n                    resolve();\r\n                },\r\n                error => {\r\n                    logger.info('Dial error ', error);\r\n                    reject(error);\r\n                });\r\n        });\r\n    }\r\n\r\n    /* eslint-enable max-params */\r\n\r\n    /**\r\n     *\r\n     */\r\n    hangup() {\r\n        return new Promise((resolve, reject) => {\r\n            if (!this.callResource) {\r\n                reject(new Error('No call in progress'));\r\n                logger.warn('No call in progress');\r\n\r\n                return;\r\n            }\r\n\r\n            const req = $iq({\r\n                type: 'set',\r\n                to: this.callResource\r\n            });\r\n\r\n            req.c('hangup', {\r\n                xmlns: RAYO_XMLNS\r\n            });\r\n\r\n            this.connection.sendIQ(req, result => {\r\n                logger.info('Hangup result ', result);\r\n                this.callResource = null;\r\n                resolve();\r\n            }, error => {\r\n                logger.info('Hangup error ', error);\r\n                this.callResource = null;\r\n                reject(new Error('Hangup error '));\r\n            });\r\n        });\r\n    }\r\n}\r\n","/* global __filename */\r\n/**\r\n * Strophe logger implementation. Logs from level WARN and above.\r\n */\r\nimport { getLogger } from 'jitsi-meet-logger';\r\nimport { Strophe } from 'strophe.js';\r\n\r\nimport GlobalOnErrorHandler from '../util/GlobalOnErrorHandler';\r\n\r\nconst logger = getLogger(__filename);\r\n\r\n/**\r\n * This is the last HTTP error status captured from Strophe debug logs.\r\n * The purpose of storing it is to distinguish between the network and\r\n * infrastructure reason for connection being dropped (see connectionHandler in\r\n * xmpp.js). The value will be cleared (-1) if the subsequent request succeeds\r\n * which means that the failure could be transient.\r\n *\r\n * FIXME in the latest Strophe (not released on npm) there is API to handle\r\n * particular HTTP errors, but there is no way to learn if the subsequent\r\n * request succeeded in order to tell if the error was one time incident or if\r\n * it was the reason for dropping the connection by Strophe (the connection is\r\n * dropped after 5 subsequent failures). Ideally Strophe should provide more\r\n * details about the reason on why the connection stopped.\r\n *\r\n * @type {number}\r\n */\r\nlet lastErrorStatus = -1;\r\n\r\n/**\r\n * A regular expression used to catch Strophe's log message indicating that the\r\n * last BOSH request was successful. When there is such message seen the\r\n * {@link lastErrorStatus} will be set back to '-1'.\r\n * @type {RegExp}\r\n */\r\nconst resetLastErrorStatusRegExpr = /request id \\d+.\\d+ got 200/;\r\n\r\n/**\r\n * A regular expression used to capture the current value of the BOSH request\r\n * error status (HTTP error code or '0' or something else).\r\n * @type {RegExp}\r\n */\r\nconst lastErrorStatusRegExpr\r\n    = /request errored, status: (\\d+), number of errors: \\d+/;\r\n\r\n/**\r\n *\r\n */\r\nexport default function() {\r\n\r\n    Strophe.log = function(level, msg) {\r\n        // Our global handler reports uncaught errors to the stats which may\r\n        // interpret those as partial call failure.\r\n        // Strophe log entry about secondary request timeout does not mean that\r\n        // it's a final failure(the request will be restarted), so we lower it's\r\n        // level here to a warning.\r\n        logger.trace('Strophe', level, msg);\r\n        if (typeof msg === 'string'\r\n                && msg.indexOf('Request ') !== -1\r\n                && msg.indexOf('timed out (secondary), restarting') !== -1) {\r\n            // eslint-disable-next-line no-param-reassign\r\n            level = Strophe.LogLevel.WARN;\r\n        }\r\n\r\n        /* eslint-disable no-case-declarations */\r\n        switch (level) {\r\n        case Strophe.LogLevel.DEBUG:\r\n            // The log message which reports successful status is logged on\r\n            // Strophe's DEBUG level.\r\n            if (lastErrorStatus !== -1\r\n                    && resetLastErrorStatusRegExpr.test(msg)) {\r\n                logger.debug('Reset lastErrorStatus');\r\n                lastErrorStatus = -1;\r\n            }\r\n            break;\r\n        case Strophe.LogLevel.WARN:\r\n            logger.warn(`Strophe: ${msg}`);\r\n            const errStatusCapture = lastErrorStatusRegExpr.exec(msg);\r\n\r\n            if (errStatusCapture && errStatusCapture.length === 2) {\r\n                lastErrorStatus = parseInt(errStatusCapture[1], 10);\r\n                logger.debug(`lastErrorStatus set to: ${lastErrorStatus}`);\r\n            }\r\n            break;\r\n        case Strophe.LogLevel.ERROR:\r\n        case Strophe.LogLevel.FATAL:\r\n            // eslint-disable-next-line no-param-reassign\r\n            msg = `Strophe: ${msg}`;\r\n            GlobalOnErrorHandler.callErrorHandler(new Error(msg));\r\n            logger.error(msg);\r\n            break;\r\n        }\r\n\r\n        /* eslint-enable no-case-declarations */\r\n    };\r\n\r\n    /**\r\n     * Returns error status (HTTP error code) of the last BOSH request.\r\n     *\r\n     * @return {number} HTTP error code, '0' for unknown or \"god knows what\"\r\n     * (this is a hack).\r\n     */\r\n    Strophe.getLastErrorStatus = function() {\r\n        return lastErrorStatus;\r\n    };\r\n\r\n    Strophe.getStatusString = function(status) {\r\n        switch (status) {\r\n        case Strophe.Status.BINDREQUIRED:\r\n            return 'BINDREQUIRED';\r\n        case Strophe.Status.ERROR:\r\n            return 'ERROR';\r\n        case Strophe.Status.CONNECTING:\r\n            return 'CONNECTING';\r\n        case Strophe.Status.CONNFAIL:\r\n            return 'CONNFAIL';\r\n        case Strophe.Status.AUTHENTICATING:\r\n            return 'AUTHENTICATING';\r\n        case Strophe.Status.AUTHFAIL:\r\n            return 'AUTHFAIL';\r\n        case Strophe.Status.CONNECTED:\r\n            return 'CONNECTED';\r\n        case Strophe.Status.DISCONNECTED:\r\n            return 'DISCONNECTED';\r\n        case Strophe.Status.DISCONNECTING:\r\n            return 'DISCONNECTING';\r\n        case Strophe.Status.ATTACHED:\r\n            return 'ATTACHED';\r\n        default:\r\n            return 'unknown';\r\n        }\r\n    };\r\n}\r\n","\r\nimport { getLogger } from 'jitsi-meet-logger';\r\n\r\nimport * as JitsiConferenceEvents from '../../JitsiConferenceEvents';\r\nimport CodecMimeType from '../../service/RTC/CodecMimeType';\r\nimport * as MediaType from '../../service/RTC/MediaType';\r\nimport browser from '../browser';\r\n\r\nconst logger = getLogger(__filename);\r\n\r\n/**\r\n * This class handles the codec selection mechanism for the conference based on the config.js settings.\r\n * The preferred codec is selected based on the settings and the list of codecs supported by the browser.\r\n * The preferred codec is published in presence which is then used by the other endpoints in the\r\n * conference to pick a supported codec at join time and when the call transitions between p2p and jvb\r\n * connections.\r\n */\r\nexport class CodecSelection {\r\n    /**\r\n     * Creates a new instance for a given conference.\r\n     *\r\n     * @param {JitsiConference} conference the conference instance\r\n     * @param {*} options\r\n     * @param {string} options.disabledCodec the codec that needs to be disabled.\r\n     * @param {boolean} options.enforcePreferredCodec whether codec preference has to be\r\n     * enforced even when an endpoints that doesn't support the preferred codec joins the call.\r\n     * Falling back to the standard codec will be skipped when this option is true, endpoints\r\n     * that do not support the preferred codec may not be able to encode/decode video when this happens.\r\n     * @param {string} options.jvbCodec the codec that is preferred on jvb connection.\r\n     * @param {string} options.p2pCodec the codec that is preferred on p2p connection.\r\n     */\r\n    constructor(conference, options) {\r\n        this.conference = conference;\r\n        this.options = options;\r\n\r\n        // VP8 cannot be disabled and it will be the default codec when no preference is set.\r\n        this.disabledCodec = options.disabledCodec === CodecMimeType.VP8\r\n            ? undefined\r\n            : this._getCodecMimeType(options.disabledCodec);\r\n\r\n        // Check if the codec values passed are valid.\r\n        const jvbCodec = this._getCodecMimeType(options.jvbCodec);\r\n        const p2pCodec = this._getCodecMimeType(options.p2pCodec);\r\n\r\n        this.jvbPreferredCodec = jvbCodec && this._isCodecSupported(jvbCodec) ? jvbCodec : CodecMimeType.VP8;\r\n        this.p2pPreferredCodec = p2pCodec && this._isCodecSupported(p2pCodec) ? p2pCodec : CodecMimeType.VP8;\r\n        logger.debug(`Codec preferences for the conference are JVB: ${this.jvbPreferredCodec},\r\n            P2P: ${this.p2pPreferredCodec}`);\r\n\r\n        // Do not prefer VP9 on Firefox because of the following bug.\r\n        // https://bugzilla.mozilla.org/show_bug.cgi?id=1633876\r\n        if (browser.isFirefox() && this.jvbPreferredCodec === CodecMimeType.VP9) {\r\n            this.jvbPreferredCodec = CodecMimeType.VP8;\r\n        }\r\n\r\n        this.conference.on(\r\n            JitsiConferenceEvents.USER_JOINED,\r\n            () => this._selectPreferredCodec());\r\n        this.conference.on(\r\n            JitsiConferenceEvents.USER_LEFT,\r\n            () => this._selectPreferredCodec());\r\n        this.conference.on(\r\n            JitsiConferenceEvents._MEDIA_SESSION_STARTED,\r\n            session => this._onMediaSessionStared(session));\r\n    }\r\n\r\n    /**\r\n     * Checks if a given string is a valid video codec mime type.\r\n     *\r\n     * @param {string} codec the codec string that needs to be validated.\r\n     * @returns {CodecMimeType|null} mime type if valid, null otherwise.\r\n     * @private\r\n     */\r\n    _getCodecMimeType(codec) {\r\n        if (typeof codec === 'string') {\r\n            return Object.values(CodecMimeType).find(value => value === codec.toLowerCase());\r\n        }\r\n\r\n        return null;\r\n    }\r\n\r\n    /**\r\n     * Checks if the given codec is supported by the browser.\r\n     *\r\n     * @param {CodecMimeType} preferredCodec codec to be checked.\r\n     * @returns {boolean} true if the given codec is supported, false otherwise.\r\n     * @private\r\n     */\r\n    _isCodecSupported(preferredCodec) {\r\n        // Skip the check on FF and RN because they do not support the getCapabilities API.\r\n        // It is safe to assume both of them support all the codecs supported by Chrome.\r\n        if (browser.isFirefox() || browser.isReactNative()) {\r\n            return true;\r\n        }\r\n\r\n        return window.RTCRtpReceiver\r\n            && window.RTCRtpReceiver.getCapabilities\r\n            && window.RTCRtpReceiver.getCapabilities('video').codecs\r\n            .some(codec => codec.mimeType.toLowerCase() === `video/${preferredCodec}`);\r\n    }\r\n\r\n    /**\r\n     * Handles the {@link JitsiConferenceEvents._MEDIA_SESSION_STARTED} event. Codecs need to be\r\n     * configured on the media session that is newly created.\r\n     *\r\n     * @param {JingleSessionPC} mediaSession media session that started.\r\n     * @returns {void}\r\n     * @private\r\n     */\r\n    _onMediaSessionStared(mediaSession) {\r\n        const preferredCodec = mediaSession.isP2P ? this.p2pPreferredCodec : this.jvbPreferredCodec;\r\n        const disabledCodec = this.disabledCodec && this._isCodecSupported(this.disabledCodec)\r\n            ? this.disabledCodec\r\n            : null;\r\n\r\n        this._selectPreferredCodec(mediaSession, preferredCodec, disabledCodec);\r\n    }\r\n\r\n    /**\r\n     * Sets the codec on the media session based on the preferred codec setting and the supported codecs\r\n     * published by the remote participants in their presence.\r\n     *\r\n     * @param {JingleSessionPC} mediaSession session for which the codec selection has to be made.\r\n     * @param {CodecMimeType} preferredCodec preferred codec.\r\n     * @param {CodecMimeType} disabledCodec codec that needs to be disabled.\r\n     */\r\n    _selectPreferredCodec(mediaSession = null, preferredCodec = null, disabledCodec = null) {\r\n        const session = mediaSession ? mediaSession : this.conference.jvbJingleSession;\r\n        const codec = preferredCodec ? preferredCodec : this.jvbPreferredCodec;\r\n        let selectedCodec = codec;\r\n\r\n        if (session && !session.isP2P && !this.options.enforcePreferredCodec) {\r\n            const remoteParticipants = this.conference.getParticipants().map(participant => participant.getId());\r\n\r\n            for (const remote of remoteParticipants) {\r\n                const peerMediaInfo = session.signalingLayer.getPeerMediaInfo(remote, MediaType.VIDEO);\r\n\r\n                if (peerMediaInfo && peerMediaInfo.codecType && peerMediaInfo.codecType !== codec) {\r\n                    selectedCodec = peerMediaInfo.codecType;\r\n                }\r\n            }\r\n        }\r\n        session && session.setVideoCodecs(selectedCodec, disabledCodec);\r\n    }\r\n\r\n    /**\r\n     * Returns the preferred codec for the conference. The preferred codec for the JVB media session\r\n     * is the one that gets published in presence and a comparision is made whenever a participant joins\r\n     * or leaves the call.\r\n     *\r\n     * @returns {CodecMimeType} preferred codec.\r\n     */\r\n    getPreferredCodec() {\r\n        return this.jvbPreferredCodec;\r\n    }\r\n}\r\n","import { getLogger } from 'jitsi-meet-logger';\r\n\r\nimport RTCEvents from '../../service/RTC/RTCEvents';\r\nimport { createBridgeChannelClosedEvent } from '../../service/statistics/AnalyticsEvents';\r\nimport Statistics from '../statistics/statistics';\r\nimport GlobalOnErrorHandler from '../util/GlobalOnErrorHandler';\r\n\r\nconst logger = getLogger(__filename);\r\n\r\n/**\r\n * Handles a WebRTC RTCPeerConnection or a WebSocket instance to communicate\r\n * with the videobridge.\r\n */\r\nexport default class BridgeChannel {\r\n    /**\r\n     * Binds \"ondatachannel\" event listener on the given RTCPeerConnection\r\n     * instance, or creates a WebSocket connection with the videobridge.\r\n     * At least one of both, peerconnection or wsUrl parameters, must be\r\n     * given.\r\n     * @param {RTCPeerConnection} [peerconnection] WebRTC peer connection\r\n     * instance.\r\n     * @param {string} [wsUrl] WebSocket URL.\r\n     * @param {EventEmitter} emitter the EventEmitter instance to use for event emission.\r\n     */\r\n    constructor(peerconnection, wsUrl, emitter) {\r\n        if (!peerconnection && !wsUrl) {\r\n            throw new TypeError('At least peerconnection or wsUrl must be given');\r\n        } else if (peerconnection && wsUrl) {\r\n            throw new TypeError('Just one of peerconnection or wsUrl must be given');\r\n        }\r\n\r\n        if (peerconnection) {\r\n            logger.debug('constructor() with peerconnection');\r\n        } else {\r\n            logger.debug(`constructor() with wsUrl:\"${wsUrl}\"`);\r\n        }\r\n\r\n        // The underlying WebRTC RTCDataChannel or WebSocket instance.\r\n        // @type {RTCDataChannel|WebSocket}\r\n        this._channel = null;\r\n\r\n        // @type {EventEmitter}\r\n        this._eventEmitter = emitter;\r\n\r\n        // Whether a RTCDataChannel or WebSocket is internally used.\r\n        // @type {string} \"datachannel\" / \"websocket\"\r\n        this._mode = null;\r\n\r\n        // Indicates whether the connection retries are enabled or not.\r\n        this._areRetriesEnabled = false;\r\n\r\n        // Indicates whether the connection was closed from the client or not.\r\n        this._closedFromClient = false;\r\n\r\n        // If a RTCPeerConnection is given, listen for new RTCDataChannel\r\n        // event.\r\n        if (peerconnection) {\r\n            const datachannel\r\n                = peerconnection.createDataChannel(\r\n                    'JVB data channel', {\r\n                        protocol: 'http://jitsi.org/protocols/colibri'\r\n                    });\r\n\r\n            // Handle the RTCDataChannel.\r\n            this._handleChannel(datachannel);\r\n            this._mode = 'datachannel';\r\n\r\n        // Otherwise create a WebSocket connection.\r\n        } else if (wsUrl) {\r\n            this._areRetriesEnabled = true;\r\n            this._wsUrl = wsUrl;\r\n            this._initWebSocket();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Initializes the web socket channel.\r\n     *\r\n     * @returns {void}\r\n     */\r\n    _initWebSocket() {\r\n        // Create a WebSocket instance.\r\n        const ws = new WebSocket(this._wsUrl);\r\n\r\n        // Handle the WebSocket.\r\n        this._handleChannel(ws);\r\n        this._mode = 'websocket';\r\n    }\r\n\r\n    /**\r\n     * Starts the websocket connection retries.\r\n     *\r\n     * @returns {void}\r\n     */\r\n    _startConnectionRetries() {\r\n        let timeoutS = 1;\r\n\r\n        const reload = () => {\r\n            if (this.isOpen()) {\r\n                return;\r\n            }\r\n            this._initWebSocket(this._wsUrl);\r\n            timeoutS = Math.min(timeoutS * 2, 60);\r\n            this._retryTimeout = setTimeout(reload, timeoutS * 1000);\r\n        };\r\n\r\n        this._retryTimeout = setTimeout(reload, timeoutS * 1000);\r\n    }\r\n\r\n    /**\r\n     * Stops the websocket connection retries.\r\n     *\r\n     * @returns {void}\r\n     */\r\n    _stopConnectionRetries() {\r\n        if (this._retryTimeout) {\r\n            clearTimeout(this._retryTimeout);\r\n            this._retryTimeout = undefined;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Retries to establish the websocket connection after the connection was closed by the server.\r\n     *\r\n     * @param {CloseEvent} closeEvent - The close event that triggered the retries.\r\n     * @returns {void}\r\n     */\r\n    _retryWebSocketConnection(closeEvent) {\r\n        if (!this._areRetriesEnabled) {\r\n            return;\r\n        }\r\n        const { code, reason } = closeEvent;\r\n\r\n        Statistics.sendAnalytics(createBridgeChannelClosedEvent(code, reason));\r\n        this._areRetriesEnabled = false;\r\n        this._eventEmitter.once(RTCEvents.DATA_CHANNEL_OPEN, () => {\r\n            this._stopConnectionRetries();\r\n            this._areRetriesEnabled = true;\r\n        });\r\n        this._startConnectionRetries();\r\n    }\r\n\r\n    /**\r\n     * The channel mode.\r\n     * @return {string} \"datachannel\" or \"websocket\" (or null if not yet set).\r\n     */\r\n    get mode() {\r\n        return this._mode;\r\n    }\r\n\r\n    /**\r\n     * Closes the currently opened channel.\r\n     */\r\n    close() {\r\n        this._closedFromClient = true;\r\n        this._stopConnectionRetries();\r\n        this._areRetriesEnabled = false;\r\n        if (this._channel) {\r\n            try {\r\n                this._channel.close();\r\n            } catch (error) {} // eslint-disable-line no-empty\r\n\r\n            this._channel = null;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Whether there is an underlying RTCDataChannel or WebSocket and it's\r\n     * open.\r\n     * @return {boolean}\r\n     */\r\n    isOpen() {\r\n        return this._channel && (this._channel.readyState === 'open'\r\n            || this._channel.readyState === WebSocket.OPEN);\r\n    }\r\n\r\n    /**\r\n     * Sends local stats via the bridge channel.\r\n     * @param {Object} payload The payload of the message.\r\n     * @throws NetworkError/InvalidStateError/Error if the operation fails or if there is no data channel created.\r\n     */\r\n    sendEndpointStatsMessage(payload) {\r\n        this._send({\r\n            colibriClass: 'EndpointStats',\r\n            ...payload\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Sends message via the channel.\r\n     * @param {string} to The id of the endpoint that should receive the\r\n     * message. If \"\" the message will be sent to all participants.\r\n     * @param  {object} payload The payload of the message.\r\n     * @throws NetworkError or InvalidStateError from RTCDataChannel#send (@see\r\n     * {@link https://developer.mozilla.org/docs/Web/API/RTCDataChannel/send})\r\n     * or from WebSocket#send or Error with \"No opened channel\" message.\r\n     */\r\n    sendMessage(to, payload) {\r\n        this._send({\r\n            colibriClass: 'EndpointMessage',\r\n            msgPayload: payload,\r\n            to\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Sends a \"lastN value changed\" message via the channel.\r\n     * @param {number} value The new value for lastN. -1 means unlimited.\r\n     */\r\n    sendSetLastNMessage(value) {\r\n        logger.log(`Sending lastN=${value}.`);\r\n\r\n        this._send({\r\n            colibriClass: 'LastNChangedEvent',\r\n            lastN: value\r\n        });\r\n    }\r\n   /**\r\n     * Sends a \"perceptive endpoints value\" or percieve message via the channel.\r\n     * @param {number} value The new value for array of perceptive endpoints.\r\n     */\r\n    sendSetPercieveEventMessage(value) {\r\n        const jsonObject = {\r\n            colibriClass: 'PercieveEvent',\r\n            perceptibles: value     //  [[participant ids for video], [participant ids for audio]]\r\n        };\r\n\r\n        this._send(jsonObject);\r\n        logger.log('Channel PerceptEvent peceptible endpoints set to:', value);\r\n    }\r\n\r\n    /**\r\n     * Sends a \"selected endpoints changed\" message via the channel.\r\n     *\r\n     * @param {Array<string>} endpointIds - The ids of the selected endpoints.\r\n     * @throws NetworkError or InvalidStateError from RTCDataChannel#send (@see\r\n     * {@link https://developer.mozilla.org/docs/Web/API/RTCDataChannel/send})\r\n     * or from WebSocket#send or Error with \"No opened channel\" message.\r\n     */\r\n    sendSelectedEndpointsMessage(endpointIds) {\r\n        logger.log(`Sending selected endpoints: ${endpointIds}.`);\r\n\r\n        this._send({\r\n            colibriClass: 'SelectedEndpointsChangedEvent',\r\n            selectedEndpoints: endpointIds\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Sends a \"receiver video constraint\" message via the channel.\r\n     * @param {Number} maxFrameHeightPixels the maximum frame height,\r\n     * in pixels, this receiver is willing to receive\r\n     */\r\n    sendReceiverVideoConstraintMessage(maxFrameHeightPixels) {\r\n        logger.log(`Sending ReceiverVideoConstraint with maxFrameHeight=${maxFrameHeightPixels}px`);\r\n        this._send({\r\n            colibriClass: 'ReceiverVideoConstraint',\r\n            maxFrameHeight: maxFrameHeightPixels\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Sends a 'ReceiverVideoConstraints' message via the bridge channel.\r\n     *\r\n     * @param {ReceiverVideoConstraints} constraints video constraints.\r\n     */\r\n    sendNewReceiverVideoConstraintsMessage(constraints) {\r\n        logger.log(`Sending ReceiverVideoConstraints with ${JSON.stringify(constraints)}`);\r\n        this._send({\r\n            colibriClass: 'ReceiverVideoConstraints',\r\n            ...constraints\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Sends a 'VideoTypeMessage' message via the bridge channel.\r\n     *\r\n     * @param {string} videoType 'camera', 'desktop' or 'none'.\r\n     */\r\n    sendVideoTypeMessage(videoType) {\r\n        logger.debug(`Sending VideoTypeMessage with video type as ${videoType}`);\r\n        this._send({\r\n            colibriClass: 'VideoTypeMessage',\r\n            videoType\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Set events on the given RTCDataChannel or WebSocket instance.\r\n     */\r\n    _handleChannel(channel) {\r\n        const emitter = this._eventEmitter;\r\n\r\n        channel.onopen = () => {\r\n            logger.info(`${this._mode} channel opened`);\r\n\r\n            // Code sample for sending string and/or binary data.\r\n            // Sends string message to the bridge:\r\n            //     channel.send(\"Hello bridge!\");\r\n            // Sends 12 bytes binary message to the bridge:\r\n            //     channel.send(new ArrayBuffer(12));\r\n\r\n            emitter.emit(RTCEvents.DATA_CHANNEL_OPEN);\r\n        };\r\n\r\n        channel.onerror = event => {\r\n            // WS error events contain no information about the failure (this is available in the onclose event) and\r\n            // the event references the WS object itself, which causes hangs on mobile.\r\n            if (this._mode !== 'websocket') {\r\n                logger.error(`Channel error: ${event.message}`);\r\n            }\r\n        };\r\n\r\n        channel.onmessage = ({ data }) => {\r\n            // JSON object.\r\n            let obj;\r\n\r\n            try {\r\n                obj = JSON.parse(data);\r\n            } catch (error) {\r\n                GlobalOnErrorHandler.callErrorHandler(error);\r\n                logger.error('Failed to parse channel message as JSON: ', data, error);\r\n\r\n                return;\r\n            }\r\n\r\n            const colibriClass = obj.colibriClass;\r\n\r\n            switch (colibriClass) {\r\n            case 'DominantSpeakerEndpointChangeEvent': {\r\n                const { dominantSpeakerEndpoint, previousSpeakers = [] } = obj;\r\n\r\n                logger.debug(`Dominant speaker: ${dominantSpeakerEndpoint}, previous speakers: ${previousSpeakers}`);\r\n                emitter.emit(RTCEvents.DOMINANT_SPEAKER_CHANGED, dominantSpeakerEndpoint, previousSpeakers);\r\n                break;\r\n            }\r\n            case 'EndpointConnectivityStatusChangeEvent': {\r\n                const endpoint = obj.endpoint;\r\n                const isActive = obj.active === 'true';\r\n\r\n                logger.info(`Endpoint connection status changed: ${endpoint} active=${isActive}`);\r\n                emitter.emit(RTCEvents.ENDPOINT_CONN_STATUS_CHANGED, endpoint, isActive);\r\n\r\n                break;\r\n            }\r\n            case 'EndpointMessage': {\r\n                emitter.emit(RTCEvents.ENDPOINT_MESSAGE_RECEIVED, obj.from, obj.msgPayload);\r\n\r\n                break;\r\n            }\r\n            case 'EndpointStats': {\r\n                emitter.emit(RTCEvents.ENDPOINT_STATS_RECEIVED, obj.from, obj);\r\n\r\n                break;\r\n            }\r\n            case 'LastNEndpointsChangeEvent': {\r\n                // The new/latest list of last-n endpoint IDs (i.e. endpoints for which the bridge is sending video).\r\n                const lastNEndpoints = obj.lastNEndpoints;\r\n\r\n                logger.info(`New forwarded endpoints: ${lastNEndpoints}`);\r\n                emitter.emit(RTCEvents.LASTN_ENDPOINT_CHANGED, lastNEndpoints);\r\n\r\n                break;\r\n            }\r\n            case 'SenderVideoConstraints': {\r\n                const videoConstraints = obj.videoConstraints;\r\n\r\n                if (videoConstraints) {\r\n                    logger.info(`SenderVideoConstraints: ${JSON.stringify(videoConstraints)}`);\r\n                    emitter.emit(RTCEvents.SENDER_VIDEO_CONSTRAINTS_CHANGED, videoConstraints);\r\n                }\r\n                break;\r\n            }\r\n            case 'ServerHello': {\r\n                logger.info(`Received ServerHello, version=${obj.version}.`);\r\n                break;\r\n            }\r\n            default: {\r\n                logger.debug('Channel JSON-formatted message: ', obj);\r\n\r\n                // The received message appears to be appropriately formatted\r\n                // (i.e. is a JSON object which assigns a value to the\r\n                // mandatory property colibriClass) so don't just swallow it,\r\n                // expose it to public consumption.\r\n                emitter.emit(`rtc.datachannel.${colibriClass}`, obj);\r\n            }\r\n            }\r\n        };\r\n\r\n        channel.onclose = event => {\r\n            logger.info(`Channel closed by ${this._closedFromClient ? 'client' : 'server'}`);\r\n\r\n            if (this._mode === 'websocket') {\r\n                if (!this._closedFromClient) {\r\n                    logger.error(`Channel closed: ${event.code} ${event.reason}`);\r\n                    this._retryWebSocketConnection(event);\r\n                }\r\n            }\r\n\r\n            // Remove the channel.\r\n            this._channel = null;\r\n        };\r\n\r\n        // Store the channel.\r\n        this._channel = channel;\r\n    }\r\n\r\n    /**\r\n     * Sends passed object via the channel.\r\n     * @param {object} jsonObject The object that will be sent.\r\n     * @throws NetworkError or InvalidStateError from RTCDataChannel#send (@see\r\n     * {@link https://developer.mozilla.org/docs/Web/API/RTCDataChannel/send})\r\n     * or from WebSocket#send or Error with \"No opened channel\" message.\r\n     */\r\n    _send(jsonObject) {\r\n        const channel = this._channel;\r\n\r\n        if (!this.isOpen()) {\r\n            logger.error('Bridge Channel send: no opened channel.');\r\n            throw new Error('No opened channel');\r\n        }\r\n\r\n        channel.send(JSON.stringify(jsonObject));\r\n    }\r\n}\r\n","/* global __filename, RTCSessionDescription */\r\n\r\nimport { Interop } from '@jitsi/sdp-interop';\r\nimport { getLogger } from 'jitsi-meet-logger';\r\nimport transform from 'sdp-transform';\r\n\r\nimport * as CodecMimeType from '../../service/RTC/CodecMimeType';\r\nimport MediaDirection from '../../service/RTC/MediaDirection';\r\nimport * as MediaType from '../../service/RTC/MediaType';\r\nimport RTCEvents from '../../service/RTC/RTCEvents';\r\nimport * as SignalingEvents from '../../service/RTC/SignalingEvents';\r\nimport * as VideoType from '../../service/RTC/VideoType';\r\nimport browser from '../browser';\r\nimport LocalSdpMunger from '../sdp/LocalSdpMunger';\r\nimport RtxModifier from '../sdp/RtxModifier';\r\nimport SDP from '../sdp/SDP';\r\nimport SDPUtil from '../sdp/SDPUtil';\r\nimport SdpConsistency from '../sdp/SdpConsistency';\r\nimport { SdpTransformWrap } from '../sdp/SdpTransformUtil';\r\nimport * as GlobalOnErrorHandler from '../util/GlobalOnErrorHandler';\r\n\r\nimport JitsiRemoteTrack from './JitsiRemoteTrack';\r\nimport RTC from './RTC';\r\nimport RTCUtils from './RTCUtils';\r\nimport { SIM_LAYER_RIDS, TPCUtils } from './TPCUtils';\r\n\r\n// FIXME SDP tools should end up in some kind of util module\r\n\r\nconst logger = getLogger(__filename);\r\nconst DEGRADATION_PREFERENCE_CAMERA = 'maintain-framerate';\r\nconst DEGRADATION_PREFERENCE_DESKTOP = 'maintain-resolution';\r\nconst DESKTOP_SHARE_RATE = 500000;\r\nconst HD_BITRATE = 2500000;\r\nconst LD_BITRATE = 200000;\r\nconst SD_BITRATE = 700000;\r\n\r\n/* eslint-disable max-params */\r\n\r\n/**\r\n * Creates new instance of 'TraceablePeerConnection'.\r\n *\r\n * @param {RTC} rtc the instance of <tt>RTC</tt> service\r\n * @param {number} id the peer connection id assigned by the parent RTC module.\r\n * @param {SignalingLayer} signalingLayer the signaling layer instance\r\n * @param {object} iceConfig WebRTC 'PeerConnection' ICE config\r\n * @param {object} constraints WebRTC 'PeerConnection' constraints\r\n * @param {boolean} isP2P indicates whether or not the new instance will be used in a peer to peer connection.\r\n * @param {object} options <tt>TracablePeerConnection</tt> config options.\r\n * @param {boolean} options.disableSimulcast if set to 'true' will disable the simulcast.\r\n * @param {boolean} options.disableRtx if set to 'true' will disable the RTX.\r\n * @param {string} options.disabledCodec the mime type of the code that should not be negotiated on the peerconnection.\r\n * @param {string} options.preferredCodec the mime type of the codec that needs to be made the preferred codec for the\r\n * peerconnection.\r\n * @param {boolean} options.startSilent If set to 'true' no audio will be sent or received.\r\n * @param {boolean} options.usesUnifiedPlan Indicates if the  browser is running in unified plan mode.\r\n *\r\n * FIXME: initially the purpose of TraceablePeerConnection was to be able to\r\n * debug the peer connection. Since many other responsibilities have been added\r\n * it would make sense to extract a separate class from it and come up with\r\n * a more suitable name.\r\n *\r\n * @constructor\r\n */\r\nexport default function TraceablePeerConnection(\r\n        rtc,\r\n        id,\r\n        signalingLayer,\r\n        iceConfig,\r\n        constraints,\r\n        isP2P,\r\n        options) {\r\n\r\n    /**\r\n     * Indicates whether or not this peer connection instance is actively\r\n     * sending/receiving audio media. When set to <tt>false</tt> the SDP audio\r\n     * media direction will be adjusted to 'inactive' in order to suspend\r\n     * the transmission.\r\n     * @type {boolean}\r\n     * @private\r\n     */\r\n    this.audioTransferActive = !(options.startSilent === true);\r\n\r\n    /**\r\n     * The DTMF sender instance used to send DTMF tones.\r\n     *\r\n     * @type {RTCDTMFSender|undefined}\r\n     * @private\r\n     */\r\n    this._dtmfSender = undefined;\r\n\r\n    /**\r\n     * @typedef {Object} TouchToneRequest\r\n     * @property {string} tones - The DTMF tones string as defined by\r\n     * {@code RTCDTMFSender.insertDTMF}, 'tones' argument.\r\n     * @property {number} duration - The amount of time in milliseconds that\r\n     * each DTMF should last.\r\n     * @property {string} interToneGap - The length of time in miliseconds to\r\n     * wait between tones.\r\n     */\r\n    /**\r\n     * TouchToneRequests which are waiting to be played. This queue is filled\r\n     * if there are touch tones currently being played.\r\n     *\r\n     * @type {Array<TouchToneRequest>}\r\n     * @private\r\n     */\r\n    this._dtmfTonesQueue = [];\r\n\r\n    /**\r\n     * Indicates whether or not this peer connection instance is actively\r\n     * sending/receiving video media. When set to <tt>false</tt> the SDP video\r\n     * media direction will be adjusted to 'inactive' in order to suspend\r\n     * the transmission.\r\n     * @type {boolean}\r\n     * @private\r\n     */\r\n    this.videoTransferActive = true;\r\n\r\n    /**\r\n     * The parent instance of RTC service which created this\r\n     * <tt>TracablePeerConnection</tt>.\r\n     * @type {RTC}\r\n     */\r\n    this.rtc = rtc;\r\n\r\n    /**\r\n     * The peer connection identifier assigned by the RTC module.\r\n     * @type {number}\r\n     */\r\n    this.id = id;\r\n\r\n    /**\r\n     * Indicates whether or not this instance is used in a peer to peer\r\n     * connection.\r\n     * @type {boolean}\r\n     */\r\n    this.isP2P = isP2P;\r\n\r\n    // FIXME: We should support multiple streams per jid.\r\n    /**\r\n     * The map holds remote tracks associated with this peer connection.\r\n     * It maps user's JID to media type and remote track\r\n     * (one track per media type per user's JID).\r\n     * @type {Map<string, Map<MediaType, JitsiRemoteTrack>>}\r\n     */\r\n    this.remoteTracks = new Map();\r\n\r\n    /**\r\n     * A map which stores local tracks mapped by {@link JitsiLocalTrack.rtcId}\r\n     * @type {Map<number, JitsiLocalTrack>}\r\n     */\r\n    this.localTracks = new Map();\r\n\r\n    /**\r\n     * Keeps tracks of the WebRTC <tt>MediaStream</tt>s that have been added to\r\n     * the underlying WebRTC PeerConnection.\r\n     * @type {Array}\r\n     * @private\r\n     */\r\n    this._addedStreams = [];\r\n\r\n    /**\r\n     * @typedef {Object} TPCGroupInfo\r\n     * @property {string} semantics the SSRC groups semantics\r\n     * @property {Array<number>} ssrcs group's SSRCs in order where the first\r\n     * one is group's primary SSRC, the second one is secondary (RTX) and so\r\n     * on...\r\n     */\r\n    /**\r\n     * @typedef {Object} TPCSSRCInfo\r\n     * @property {Array<number>} ssrcs an array which holds all track's SSRCs\r\n     * @property {Array<TPCGroupInfo>} groups an array stores all track's SSRC\r\n     * groups\r\n     */\r\n    /**\r\n     * Holds the info about local track's SSRCs mapped per their\r\n     * {@link JitsiLocalTrack.rtcId}\r\n     * @type {Map<number, TPCSSRCInfo>}\r\n     */\r\n    this.localSSRCs = new Map();\r\n\r\n    /**\r\n     * The local ICE username fragment for this session.\r\n     */\r\n    this.localUfrag = null;\r\n\r\n    /**\r\n     * The remote ICE username fragment for this session.\r\n     */\r\n    this.remoteUfrag = null;\r\n\r\n    /**\r\n     * The signaling layer which operates this peer connection.\r\n     * @type {SignalingLayer}\r\n     */\r\n    this.signalingLayer = signalingLayer;\r\n\r\n    // SignalingLayer listeners\r\n    this._peerVideoTypeChanged = this._peerVideoTypeChanged.bind(this);\r\n    this.signalingLayer.on(\r\n        SignalingEvents.PEER_VIDEO_TYPE_CHANGED,\r\n        this._peerVideoTypeChanged);\r\n\r\n    this._peerMutedChanged = this._peerMutedChanged.bind(this);\r\n    this.signalingLayer.on(\r\n        SignalingEvents.PEER_MUTED_CHANGED,\r\n        this._peerMutedChanged);\r\n    this.options = options;\r\n\r\n    // Make sure constraints is properly formatted in order to provide information about whether or not this\r\n    // connection is P2P to rtcstats.\r\n    const safeConstraints = constraints || {};\r\n\r\n    safeConstraints.optional = safeConstraints.optional || [];\r\n\r\n    // The `optional` parameter needs to be of type array, otherwise chrome will throw an error.\r\n    // Firefox and Safari just ignore it.\r\n    if (Array.isArray(safeConstraints.optional)) {\r\n        safeConstraints.optional.push({ rtcStatsSFUP2P: this.isP2P });\r\n    } else {\r\n        logger.warn('Optional param is not an array, rtcstats p2p data is omitted.');\r\n    }\r\n\r\n    this.peerconnection\r\n        = new RTCUtils.RTCPeerConnectionType(iceConfig, safeConstraints);\r\n\r\n    // The standard video bitrates are used in Unified plan when switching\r\n    // between camera/desktop tracks on the same sender.\r\n    const standardVideoBitrates = {\r\n        low: LD_BITRATE,\r\n        standard: SD_BITRATE,\r\n        high: HD_BITRATE\r\n    };\r\n\r\n    // Check if the max. bitrates for video are specified through config.js videoQuality settings.\r\n    // These bitrates will be applied on all browsers for camera sources in both simulcast and p2p mode.\r\n    this.videoBitrates = this.options.videoQuality && this.options.videoQuality.maxBitratesVideo\r\n        ? this.options.videoQuality.maxBitratesVideo\r\n        : standardVideoBitrates;\r\n\r\n    this.tpcUtils = new TPCUtils(this, this.videoBitrates);\r\n    this.updateLog = [];\r\n    this.stats = {};\r\n    this.statsinterval = null;\r\n\r\n    /**\r\n    * Flag used to indicate if the browser is running in unified  plan mode.\r\n    */\r\n    this._usesUnifiedPlan = options.usesUnifiedPlan;\r\n\r\n    /**\r\n     * Flag used to indicate if RTCRtpTransceiver#setCodecPreferences is to be used instead of SDP\r\n     * munging for codec selection.\r\n     */\r\n    this._usesTransceiverCodecPreferences = browser.supportsCodecPreferences() && this._usesUnifiedPlan;\r\n    this._usesTransceiverCodecPreferences\r\n        && logger.info('Using RTCRtpTransceiver#setCodecPreferences for codec selection');\r\n\r\n    /**\r\n     * @type {number} The max number of stats to keep in this.stats. Limit to\r\n     * 300 values, i.e. 5 minutes; set to 0 to disable\r\n     */\r\n    this.maxstats = options.maxstats;\r\n\r\n    this.interop = new Interop();\r\n    const Simulcast = require('@jitsi/sdp-simulcast');\r\n\r\n    this.simulcast = new Simulcast(\r\n        {\r\n            numOfLayers: SIM_LAYER_RIDS.length,\r\n            explodeRemoteSimulcast: false,\r\n            usesUnifiedPlan: this._usesUnifiedPlan\r\n        });\r\n    this.sdpConsistency = new SdpConsistency(this.toString());\r\n\r\n    /**\r\n     * Munges local SDP provided to the Jingle Session in order to prevent from\r\n     * sending SSRC updates on attach/detach and mute/unmute (for video).\r\n     * @type {LocalSdpMunger}\r\n     */\r\n    this.localSdpMunger = new LocalSdpMunger(this, this.rtc.getLocalEndpointId());\r\n\r\n    /**\r\n     * TracablePeerConnection uses RTC's eventEmitter\r\n     * @type {EventEmitter}\r\n     */\r\n    this.eventEmitter = rtc.eventEmitter;\r\n    this.rtxModifier = new RtxModifier();\r\n\r\n    /**\r\n     * The height constraint applied on the video sender.\r\n     */\r\n    this.senderVideoMaxHeight = null;\r\n\r\n    // override as desired\r\n    this.trace = (what, info) => {\r\n        logger.debug(what, info);\r\n\r\n        this.updateLog.push({\r\n            time: new Date(),\r\n            type: what,\r\n            value: info || ''\r\n        });\r\n    };\r\n    this.onicecandidate = null;\r\n    this.peerconnection.onicecandidate = event => {\r\n        this.trace(\r\n            'onicecandidate',\r\n            JSON.stringify(event.candidate, null, ' '));\r\n\r\n        if (this.onicecandidate !== null) {\r\n            this.onicecandidate(event);\r\n        }\r\n    };\r\n\r\n    // Use track events when browser is running in unified plan mode and stream events in plan-b mode.\r\n    if (this._usesUnifiedPlan) {\r\n        this.onTrack = evt => {\r\n            const stream = evt.streams[0];\r\n\r\n            this._remoteTrackAdded(stream, evt.track, evt.transceiver);\r\n            stream.addEventListener('removetrack', e => {\r\n                this._remoteTrackRemoved(stream, e.track);\r\n            });\r\n        };\r\n        this.peerconnection.addEventListener('track', this.onTrack);\r\n    } else {\r\n        this.peerconnection.onaddstream = event => this._remoteStreamAdded(event.stream);\r\n        this.peerconnection.onremovestream = event => this._remoteStreamRemoved(event.stream);\r\n    }\r\n    this.onsignalingstatechange = null;\r\n    this.peerconnection.onsignalingstatechange = event => {\r\n        this.trace('onsignalingstatechange', this.signalingState);\r\n        if (this.onsignalingstatechange !== null) {\r\n            this.onsignalingstatechange(event);\r\n        }\r\n    };\r\n    this.oniceconnectionstatechange = null;\r\n    this.peerconnection.oniceconnectionstatechange = event => {\r\n        this.trace('oniceconnectionstatechange', this.iceConnectionState);\r\n        if (this.oniceconnectionstatechange !== null) {\r\n            this.oniceconnectionstatechange(event);\r\n        }\r\n    };\r\n    this.onnegotiationneeded = null;\r\n    this.peerconnection.onnegotiationneeded = event => {\r\n        this.trace('onnegotiationneeded');\r\n        if (this.onnegotiationneeded !== null) {\r\n            this.onnegotiationneeded(event);\r\n        }\r\n    };\r\n    this.ondatachannel = null;\r\n    this.peerconnection.ondatachannel = event => {\r\n        this.trace('ondatachannel');\r\n        if (this.ondatachannel !== null) {\r\n            this.ondatachannel(event);\r\n        }\r\n    };\r\n\r\n    if (this.maxstats) {\r\n        this.statsinterval = window.setInterval(() => {\r\n            this.getStats().then(stats => {\r\n                if (typeof stats?.result === 'function') {\r\n                    const results = stats.result();\r\n\r\n                    for (let i = 0; i < results.length; ++i) {\r\n                        const res = results[i];\r\n\r\n                        res.names().forEach(name => {\r\n                            this._processStat(res, name, res.stat(name));\r\n                        });\r\n                    }\r\n                } else {\r\n                    stats.forEach(r => this._processStat(r, '', r));\r\n                }\r\n            });\r\n        }, 1000);\r\n    }\r\n\r\n    logger.info(`Create new ${this}`);\r\n}\r\n\r\n/* eslint-enable max-params */\r\n\r\n/**\r\n * Process stat and adds it to the array of stats we store.\r\n * @param report the current stats report.\r\n * @param name the name of the report, if available\r\n * @param statValue the value to add.\r\n * @private\r\n */\r\nTraceablePeerConnection.prototype._processStat\r\n    = function(report, name, statValue) {\r\n        const id = `${report.id}-${name}`;\r\n        let s = this.stats[id];\r\n        const now = new Date();\r\n\r\n        if (!s) {\r\n            this.stats[id] = s = {\r\n                startTime: now,\r\n                endTime: now,\r\n                values: [],\r\n                times: []\r\n            };\r\n        }\r\n        s.values.push(statValue);\r\n        s.times.push(now.getTime());\r\n        if (s.values.length > this.maxstats) {\r\n            s.values.shift();\r\n            s.times.shift();\r\n        }\r\n        s.endTime = now;\r\n    };\r\n\r\n/**\r\n * Returns a string representation of a SessionDescription object.\r\n */\r\nconst dumpSDP = function(description) {\r\n    if (typeof description === 'undefined' || description === null) {\r\n        return '';\r\n    }\r\n\r\n    return `type: ${description.type}\\r\\n${description.sdp}`;\r\n};\r\n\r\n\r\n/**\r\n * Forwards the {@link peerconnection.iceConnectionState} state except that it\r\n * will convert \"completed\" into \"connected\" where both mean that the ICE has\r\n * succeeded and is up and running. We never see \"completed\" state for\r\n * the JVB connection, but it started appearing for the P2P one. This method\r\n * allows to adapt old logic to this new situation.\r\n * @return {string}\r\n */\r\nTraceablePeerConnection.prototype.getConnectionState = function() {\r\n    const state = this.peerconnection.iceConnectionState;\r\n\r\n    if (state === 'completed') {\r\n        return 'connected';\r\n    }\r\n\r\n    return state;\r\n};\r\n\r\n/**\r\n * Obtains the media direction for given {@link MediaType}. The method takes\r\n * into account whether or not there are any local tracks for media and\r\n * the {@link audioTransferActive} and {@link videoTransferActive} flags.\r\n * @param {MediaType} mediaType\r\n * @param {boolean} isAddOperation whether the direction is to be calculated after a source-add action.\r\n * @return {string} one of the SDP direction constants ('sendrecv, 'recvonly'\r\n * etc.) which should be used when setting local description on the peer\r\n * connection.\r\n * @private\r\n */\r\nTraceablePeerConnection.prototype.getDesiredMediaDirection = function(mediaType, isAddOperation = false) {\r\n    const hasLocalSource = this.hasAnyTracksOfType(mediaType);\r\n\r\n    if (this._usesUnifiedPlan) {\r\n        return isAddOperation\r\n            ? hasLocalSource ? MediaDirection.SENDRECV : MediaDirection.SENDONLY\r\n            : hasLocalSource ? MediaDirection.RECVONLY : MediaDirection.INACTIVE;\r\n    }\r\n\r\n    const mediaTransferActive = mediaType === MediaType.AUDIO ? this.audioTransferActive : this.videoTransferActive;\r\n\r\n    if (mediaTransferActive) {\r\n        return hasLocalSource ? MediaDirection.SENDRECV : MediaDirection.RECVONLY;\r\n    }\r\n\r\n    return MediaDirection.INACTIVE;\r\n};\r\n\r\n/**\r\n * Returns the list of RTCRtpReceivers created for the source of the given media type associated with\r\n * the set of remote endpoints specified.\r\n * @param {Array<string>} endpoints list of the endpoints\r\n * @param {string} mediaType 'audio' or 'video'\r\n * @returns {Array<RTCRtpReceiver>} list of receivers created by the peerconnection.\r\n */\r\nTraceablePeerConnection.prototype._getReceiversByEndpointIds = function(endpoints, mediaType) {\r\n    let remoteTracks = [];\r\n    let receivers = [];\r\n\r\n    for (const endpoint of endpoints) {\r\n        remoteTracks = remoteTracks.concat(this.getRemoteTracks(endpoint, mediaType));\r\n    }\r\n\r\n    // Get the ids of the MediaStreamTracks associated with each of these remote tracks.\r\n    const remoteTrackIds = remoteTracks.map(remote => remote.track?.id);\r\n\r\n    receivers = this.peerconnection.getReceivers()\r\n        .filter(receiver => receiver.track\r\n            && receiver.track.kind === mediaType\r\n            && remoteTrackIds.find(trackId => trackId === receiver.track.id));\r\n\r\n    return receivers;\r\n};\r\n\r\n/**\r\n * Tells whether or not this TPC instance is using Simulcast.\r\n * @return {boolean} <tt>true</tt> if simulcast is enabled and active or\r\n * <tt>false</tt> if it's turned off.\r\n */\r\nTraceablePeerConnection.prototype.isSimulcastOn = function() {\r\n    return !this.options.disableSimulcast;\r\n};\r\n\r\n/**\r\n * Handles {@link SignalingEvents.PEER_VIDEO_TYPE_CHANGED}\r\n * @param {string} endpointId the video owner's ID (MUC nickname)\r\n * @param {VideoType} videoType the new value\r\n * @private\r\n */\r\nTraceablePeerConnection.prototype._peerVideoTypeChanged = function(\r\n        endpointId,\r\n        videoType) {\r\n    // Check if endpointId has a value to avoid action on random track\r\n    if (!endpointId) {\r\n        logger.error(`${this} No endpointID on peerVideoTypeChanged`);\r\n\r\n        return;\r\n    }\r\n    const videoTrack = this.getRemoteTracks(endpointId, MediaType.VIDEO);\r\n\r\n    if (videoTrack.length) {\r\n        // NOTE 1 track per media type is assumed\r\n        videoTrack[0]._setVideoType(videoType);\r\n    }\r\n};\r\n\r\n/**\r\n * Handles remote track mute / unmute events.\r\n * @param {string} endpointId the track owner's identifier (MUC nickname)\r\n * @param {MediaType} mediaType \"audio\" or \"video\"\r\n * @param {boolean} isMuted the new mute state\r\n * @private\r\n */\r\nTraceablePeerConnection.prototype._peerMutedChanged = function(\r\n        endpointId,\r\n        mediaType,\r\n        isMuted) {\r\n    // Check if endpointId is a value to avoid doing action on all remote tracks\r\n    if (!endpointId) {\r\n        logger.error(`${this} On peerMuteChanged - no endpoint ID`);\r\n\r\n        return;\r\n    }\r\n    const track = this.getRemoteTracks(endpointId, mediaType);\r\n\r\n    if (track.length) {\r\n        // NOTE 1 track per media type is assumed\r\n        track[0].setMute(isMuted);\r\n    }\r\n};\r\n\r\n/**\r\n * Obtains audio levels of the remote audio tracks by getting the source information on the RTCRtpReceivers.\r\n * The information relevant to the ssrc is updated each time a RTP packet constaining the ssrc is received.\r\n * @param {Array<string>} speakerList list of endpoint ids for which audio levels are to be gathered.\r\n * @returns {Object} containing ssrc and audio level information as a key-value pair.\r\n */\r\nTraceablePeerConnection.prototype.getAudioLevels = function(speakerList = []) {\r\n    const audioLevels = {};\r\n    const audioReceivers = speakerList.length\r\n        ? this._getReceiversByEndpointIds(speakerList, MediaType.AUDIO)\r\n        : this.peerconnection.getReceivers()\r\n            .filter(receiver => receiver.track && receiver.track.kind === MediaType.AUDIO && receiver.track.enabled);\r\n\r\n    audioReceivers.forEach(remote => {\r\n        const ssrc = remote.getSynchronizationSources();\r\n\r\n        if (ssrc && ssrc.length) {\r\n            // As per spec, this audiolevel is a value between 0..1 (linear), where 1.0\r\n            // represents 0 dBov, 0 represents silence, and 0.5 represents approximately\r\n            // 6 dBSPL change in the sound pressure level from 0 dBov.\r\n            // https://www.w3.org/TR/webrtc/#dom-rtcrtpcontributingsource-audiolevel\r\n            audioLevels[ssrc[0].source] = ssrc[0].audioLevel;\r\n        }\r\n    });\r\n\r\n    return audioLevels;\r\n};\r\n\r\n/**\r\n * Obtains local tracks for given {@link MediaType}. If the <tt>mediaType</tt>\r\n * argument is omitted the list of all local tracks will be returned.\r\n * @param {MediaType} [mediaType]\r\n * @return {Array<JitsiLocalTrack>}\r\n */\r\nTraceablePeerConnection.prototype.getLocalTracks = function(mediaType) {\r\n    let tracks = Array.from(this.localTracks.values());\r\n\r\n    if (mediaType !== undefined) {\r\n        tracks = tracks.filter(track => track.getType() === mediaType);\r\n    }\r\n\r\n    return tracks;\r\n};\r\n\r\n/**\r\n * Retrieves the local video track.\r\n *\r\n * @returns {JitsiLocalTrack|undefined} - local video track.\r\n */\r\nTraceablePeerConnection.prototype.getLocalVideoTrack = function() {\r\n    return this.getLocalTracks(MediaType.VIDEO)[0];\r\n};\r\n\r\n/**\r\n * Checks whether or not this {@link TraceablePeerConnection} instance contains\r\n * any local tracks for given <tt>mediaType</tt>.\r\n * @param {MediaType} mediaType\r\n * @return {boolean}\r\n */\r\nTraceablePeerConnection.prototype.hasAnyTracksOfType = function(mediaType) {\r\n    if (!mediaType) {\r\n        throw new Error('\"mediaType\" is required');\r\n    }\r\n\r\n    return this.getLocalTracks(mediaType).length > 0;\r\n};\r\n\r\n/**\r\n * Obtains all remote tracks currently known to this PeerConnection instance.\r\n * @param {string} [endpointId] the track owner's identifier (MUC nickname)\r\n * @param {MediaType} [mediaType] the remote tracks will be filtered\r\n * by their media type if this argument is specified.\r\n * @return {Array<JitsiRemoteTrack>}\r\n */\r\nTraceablePeerConnection.prototype.getRemoteTracks = function(\r\n        endpointId,\r\n        mediaType) {\r\n    const remoteTracks = [];\r\n    const endpoints\r\n        = endpointId ? [ endpointId ] : this.remoteTracks.keys();\r\n\r\n    for (const endpoint of endpoints) {\r\n        const endpointTrackMap = this.remoteTracks.get(endpoint);\r\n\r\n        if (!endpointTrackMap) {\r\n\r\n            // Otherwise an empty Map() would have to be allocated above\r\n            // eslint-disable-next-line no-continue\r\n            continue;\r\n        }\r\n\r\n        for (const trackMediaType of endpointTrackMap.keys()) {\r\n            // per media type filtering\r\n            if (!mediaType || mediaType === trackMediaType) {\r\n                const mediaTrack = endpointTrackMap.get(trackMediaType);\r\n\r\n                if (mediaTrack) {\r\n                    remoteTracks.push(mediaTrack);\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    return remoteTracks;\r\n};\r\n\r\n/**\r\n * Parses the remote description and returns the sdp lines of the sources associated with a remote participant.\r\n *\r\n * @param {string} id Endpoint id of the remote participant.\r\n * @returns {Array<string>} The sdp lines that have the ssrc information.\r\n */\r\nTraceablePeerConnection.prototype.getRemoteSourceInfoByParticipant = function(id) {\r\n    const removeSsrcInfo = [];\r\n    const remoteTracks = this.getRemoteTracks(id);\r\n\r\n    if (!remoteTracks?.length) {\r\n        return removeSsrcInfo;\r\n    }\r\n    const primarySsrcs = remoteTracks.map(track => track.getSSRC());\r\n    const sdp = new SDP(this.remoteDescription.sdp);\r\n\r\n    primarySsrcs.forEach((ssrc, idx) => {\r\n        for (const media of sdp.media) {\r\n            let lines = '';\r\n            let ssrcLines = SDPUtil.findLines(media, `a=ssrc:${ssrc}`);\r\n\r\n            if (ssrcLines.length) {\r\n                if (!removeSsrcInfo[idx]) {\r\n                    removeSsrcInfo[idx] = '';\r\n                }\r\n\r\n                // Check if there are any FID groups present for the primary ssrc.\r\n                const fidLines = SDPUtil.findLines(media, `a=ssrc-group:FID ${ssrc}`);\r\n\r\n                if (fidLines.length) {\r\n                    const secondarySsrc = fidLines[0].split(' ')[2];\r\n\r\n                    lines += `${fidLines[0]}\\r\\n`;\r\n                    ssrcLines = ssrcLines.concat(SDPUtil.findLines(media, `a=ssrc:${secondarySsrc}`));\r\n                }\r\n                removeSsrcInfo[idx] += `${ssrcLines.join('\\r\\n')}\\r\\n`;\r\n                removeSsrcInfo[idx] += lines;\r\n            }\r\n        }\r\n    });\r\n\r\n    return removeSsrcInfo;\r\n};\r\n\r\n/**\r\n * Returns the target bitrates configured for the local video source.\r\n *\r\n * @returns {Object}\r\n */\r\nTraceablePeerConnection.prototype.getTargetVideoBitrates = function() {\r\n    const currentCodec = this.getConfiguredVideoCodec();\r\n\r\n    return this.videoBitrates[currentCodec.toUpperCase()] || this.videoBitrates;\r\n};\r\n\r\n/**\r\n * Tries to find {@link JitsiTrack} for given SSRC number. It will search both\r\n * local and remote tracks bound to this instance.\r\n * @param {number} ssrc\r\n * @return {JitsiTrack|null}\r\n */\r\nTraceablePeerConnection.prototype.getTrackBySSRC = function(ssrc) {\r\n    if (typeof ssrc !== 'number') {\r\n        throw new Error(`SSRC ${ssrc} is not a number`);\r\n    }\r\n    for (const localTrack of this.localTracks.values()) {\r\n        if (this.getLocalSSRC(localTrack) === ssrc) {\r\n            return localTrack;\r\n        }\r\n    }\r\n    for (const remoteTrack of this.getRemoteTracks()) {\r\n        if (remoteTrack.getSSRC() === ssrc) {\r\n            return remoteTrack;\r\n        }\r\n    }\r\n\r\n    return null;\r\n};\r\n\r\n/**\r\n * Tries to find SSRC number for given {@link JitsiTrack} id. It will search\r\n * both local and remote tracks bound to this instance.\r\n * @param {string} id\r\n * @return {number|null}\r\n */\r\nTraceablePeerConnection.prototype.getSsrcByTrackId = function(id) {\r\n\r\n    const findTrackById = track => track.getTrack().id === id;\r\n    const localTrack = this.getLocalTracks().find(findTrackById);\r\n\r\n    if (localTrack) {\r\n        return this.getLocalSSRC(localTrack);\r\n    }\r\n\r\n    const remoteTrack = this.getRemoteTracks().find(findTrackById);\r\n\r\n    if (remoteTrack) {\r\n        return remoteTrack.getSSRC();\r\n    }\r\n\r\n    return null;\r\n};\r\n\r\n/**\r\n * Called when new remote MediaStream is added to the PeerConnection.\r\n * @param {MediaStream} stream the WebRTC MediaStream for remote participant\r\n */\r\nTraceablePeerConnection.prototype._remoteStreamAdded = function(stream) {\r\n    const streamId = RTC.getStreamID(stream);\r\n\r\n    if (!RTC.isUserStreamById(streamId)) {\r\n        logger.info(`${this} ignored remote 'stream added' event for non-user stream[id=${streamId}]`);\r\n\r\n        return;\r\n    }\r\n\r\n    // Bind 'addtrack'/'removetrack' event handlers\r\n    if (browser.isChromiumBased()) {\r\n        stream.onaddtrack = event => {\r\n            this._remoteTrackAdded(stream, event.track);\r\n        };\r\n        stream.onremovetrack = event => {\r\n            this._remoteTrackRemoved(stream, event.track);\r\n        };\r\n    }\r\n\r\n    // Call remoteTrackAdded for each track in the stream\r\n    const streamAudioTracks = stream.getAudioTracks();\r\n\r\n    for (const audioTrack of streamAudioTracks) {\r\n        this._remoteTrackAdded(stream, audioTrack);\r\n    }\r\n    const streamVideoTracks = stream.getVideoTracks();\r\n\r\n    for (const videoTrack of streamVideoTracks) {\r\n        this._remoteTrackAdded(stream, videoTrack);\r\n    }\r\n};\r\n\r\n\r\n/**\r\n * Called on \"track added\" and \"stream added\" PeerConnection events (because we\r\n * handle streams on per track basis). Finds the owner and the SSRC for\r\n * the track and passes that to ChatRoom for further processing.\r\n * @param {MediaStream} stream the WebRTC MediaStream instance which is\r\n * the parent of the track\r\n * @param {MediaStreamTrack} track the WebRTC MediaStreamTrack added for remote\r\n * participant.\r\n * @param {RTCRtpTransceiver} transceiver the WebRTC transceiver that is created\r\n * for the remote participant in unified plan.\r\n */\r\nTraceablePeerConnection.prototype._remoteTrackAdded = function(stream, track, transceiver = null) {\r\n    const streamId = RTC.getStreamID(stream);\r\n    const mediaType = track.kind;\r\n\r\n    if (!this.isP2P && !RTC.isUserStreamById(streamId)) {\r\n        logger.info(`${this} ignored remote 'stream added' event for non-user stream[id=${streamId}]`);\r\n\r\n        return;\r\n    }\r\n    logger.info(`${this} adding remote track for stream[id=${streamId},type=${mediaType}]`);\r\n\r\n    // look up an associated JID for a stream id\r\n    if (!mediaType) {\r\n        GlobalOnErrorHandler.callErrorHandler(\r\n            new Error(\r\n                `MediaType undefined for remote track, stream id: ${streamId}`\r\n            ));\r\n\r\n        // Abort\r\n        return;\r\n    }\r\n\r\n    const remoteSDP = this._usesUnifiedPlan\r\n        ? new SDP(this.peerconnection.remoteDescription.sdp)\r\n        : new SDP(this.remoteDescription.sdp);\r\n    let mediaLines;\r\n\r\n    // In unified plan mode, find the matching mline using 'mid' if its availble, otherwise use the\r\n    // 'msid' attribute of the stream.\r\n    if (this._usesUnifiedPlan) {\r\n        if (transceiver && transceiver.mid) {\r\n            const mid = transceiver.mid;\r\n\r\n            mediaLines = remoteSDP.media.filter(mls => SDPUtil.findLine(mls, `a=mid:${mid}`));\r\n        } else {\r\n            mediaLines = remoteSDP.media.filter(mls => {\r\n                const msid = SDPUtil.findLine(mls, 'a=msid:');\r\n\r\n                return typeof msid !== 'undefined' && streamId === msid.substring(7).split(' ')[0];\r\n            });\r\n        }\r\n    } else {\r\n        mediaLines = remoteSDP.media.filter(mls => mls.startsWith(`m=${mediaType}`));\r\n    }\r\n\r\n    if (!mediaLines.length) {\r\n        GlobalOnErrorHandler.callErrorHandler(\r\n            new Error(`No media lines found in remote SDP for remote stream[id=${streamId},type=${mediaType}]`));\r\n\r\n        // Abort\r\n        return;\r\n    }\r\n\r\n    let ssrcLines = SDPUtil.findLines(mediaLines[0], 'a=ssrc:');\r\n\r\n    ssrcLines\r\n        = ssrcLines.filter(line => line.indexOf(`msid:${streamId}`) !== -1);\r\n    if (!ssrcLines.length) {\r\n        GlobalOnErrorHandler.callErrorHandler(\r\n            new Error(`No SSRC lines found in remote SDP for remote stream[msid=${streamId},type=${mediaType}]`));\r\n\r\n        // Abort\r\n        return;\r\n    }\r\n\r\n    // FIXME the length of ssrcLines[0] not verified, but it will fail\r\n    // with global error handler anyway\r\n\r\n    //  hasevr  extract all ssrcs --------------------------------------------\r\n    //  const ssrcStr = ssrcLines[0].substring(7).split(' ')[0];\r\n    //  const trackSsrc = Number(ssrcStr);\r\n    const ssrcs = ssrcLines.map((ssrcLine) => Number(ssrcLine.substring(7).split(' ')[0]))\r\n    const trackSsrc = ssrcs[0]\r\n\t//  ----------------------------------------------------------------------\r\n    const ownerEndpointId = this.signalingLayer.getSSRCOwner(trackSsrc);\r\n\r\n    if (isNaN(trackSsrc) || trackSsrc < 0) {\r\n        GlobalOnErrorHandler.callErrorHandler(\r\n            new Error(\r\n                `Invalid SSRC for remote stream[ssrc=${trackSsrc},id=${streamId},type=${mediaType}]`));\r\n\r\n        // Abort\r\n        return;\r\n    } else if (!ownerEndpointId) {\r\n        GlobalOnErrorHandler.callErrorHandler(\r\n            new Error(\r\n                `No SSRC owner known for remote stream[ssrc=${trackSsrc},id=${streamId},type=${mediaType}]`));\r\n\r\n        // Abort\r\n        return;\r\n    }\r\n\r\n    logger.info(`${this} creating remote track[endpoint=${ownerEndpointId},ssrc=${trackSsrc},type=${mediaType}]`);\r\n\r\n    const peerMediaInfo\r\n        = this.signalingLayer.getPeerMediaInfo(ownerEndpointId, mediaType);\r\n\r\n    if (!peerMediaInfo) {\r\n        GlobalOnErrorHandler.callErrorHandler(\r\n            new Error(`${this}: no peer media info available for ${ownerEndpointId}`));\r\n\r\n        return;\r\n    }\r\n\r\n    const muted = peerMediaInfo.muted;\r\n    const videoType = peerMediaInfo.videoType; // can be undefined\r\n\r\n    this._createRemoteTrack(\r\n        ownerEndpointId, stream, track, mediaType, videoType, ssrcs, muted);\r\n};\r\n\r\n// FIXME cleanup params\r\n/* eslint-disable max-params */\r\n\r\n/**\r\n * Initializes a new JitsiRemoteTrack instance with the data provided by\r\n * the signaling layer and SDP.\r\n *\r\n * @param {string} ownerEndpointId the owner's endpoint ID (MUC nickname)\r\n * @param {MediaStream} stream the WebRTC stream instance\r\n * @param {MediaStreamTrack} track the WebRTC track instance\r\n * @param {MediaType} mediaType the track's type of the media\r\n * @param {VideoType} [videoType] the track's type of the video (if applicable)\r\n * @param {number} ssrcs the track's all SSRC numbers\r\n * @param {boolean} muted the initial muted status\r\n */\r\nTraceablePeerConnection.prototype._createRemoteTrack = function(\r\n        ownerEndpointId,\r\n        stream,\r\n        track,\r\n        mediaType,\r\n        videoType,\r\n        ssrcs,\r\n        muted) {\r\n    let remoteTracksMap = this.remoteTracks.get(ownerEndpointId);\r\n\r\n    if (!remoteTracksMap) {\r\n        remoteTracksMap = new Map();\r\n        this.remoteTracks.set(ownerEndpointId, remoteTracksMap);\r\n    }\r\n\r\n    const existingTrack = remoteTracksMap.get(mediaType);\r\n\r\n    if (existingTrack && existingTrack.getTrack() === track) {\r\n        // Ignore duplicated event which can originate either from 'onStreamAdded' or 'onTrackAdded'.\r\n        logger.info(`${this} ignored duplicated track event for track[endpoint=${ownerEndpointId},type=${mediaType}]`);\r\n\r\n        return;\r\n    } else if (existingTrack) {\r\n        logger.error(`${this} received a second remote track for track[endpoint=${ownerEndpointId},type=${mediaType}]`\r\n            + 'deleting the existing track');\r\n\r\n        // The exisiting track needs to be removed here. We can get here when Jicofo reverses the order of source-add\r\n        // and source-remove messages. Ideally, when a remote endpoint changes source, like switching devices, it sends\r\n        // a source-remove (for old ssrc) followed by a source-add (for new ssrc) and Jicofo then should forward these\r\n        // two messages to all the other endpoints in the conference in the same order. However, sometimes, these\r\n        // messages arrive at the client in the reverse order resulting in two remote tracks (of same media type) being\r\n        // created and in case of video, a black strip (that of the first track which has ended) appears over the live\r\n        // track obscuring it. Removing the existing track when that happens will fix this issue.\r\n        this._remoteTrackRemoved(existingTrack.getOriginalStream(), existingTrack.getTrack());\r\n    }\r\n\r\n    const remoteTrack\r\n        = new JitsiRemoteTrack(\r\n                this.rtc,\r\n                this.rtc.conference,\r\n                ownerEndpointId,\r\n                stream,\r\n                track,\r\n                mediaType,\r\n                videoType,\r\n                ssrcs,\r\n                muted,\r\n                this.isP2P);\r\n\r\n    remoteTracksMap.set(mediaType, remoteTrack);\r\n\r\n    this.eventEmitter.emit(RTCEvents.REMOTE_TRACK_ADDED, remoteTrack, this);\r\n};\r\n\r\n/* eslint-enable max-params */\r\n\r\n/**\r\n * Handles remote stream removal.\r\n * @param stream the WebRTC MediaStream object which is being removed from the\r\n * PeerConnection\r\n */\r\nTraceablePeerConnection.prototype._remoteStreamRemoved = function(stream) {\r\n    if (!RTC.isUserStream(stream)) {\r\n        const id = RTC.getStreamID(stream);\r\n\r\n        logger.info(`Ignored remote 'stream removed' event for stream[id=${id}]`);\r\n\r\n        return;\r\n    }\r\n\r\n    // Call remoteTrackRemoved for each track in the stream\r\n    const streamVideoTracks = stream.getVideoTracks();\r\n\r\n    for (const videoTrack of streamVideoTracks) {\r\n        this._remoteTrackRemoved(stream, videoTrack);\r\n    }\r\n    const streamAudioTracks = stream.getAudioTracks();\r\n\r\n    for (const audioTrack of streamAudioTracks) {\r\n        this._remoteTrackRemoved(stream, audioTrack);\r\n    }\r\n};\r\n\r\n/**\r\n * Handles remote media track removal.\r\n * @param {MediaStream} stream WebRTC MediaStream instance which is the parent\r\n * of the track.\r\n * @param {MediaStreamTrack} track the WebRTC MediaStreamTrack which has been\r\n * removed from the PeerConnection.\r\n */\r\nTraceablePeerConnection.prototype._remoteTrackRemoved = function(\r\n        stream,\r\n        track) {\r\n    const streamId = RTC.getStreamID(stream);\r\n    const trackId = track && RTC.getTrackID(track);\r\n\r\n    if (!RTC.isUserStreamById(streamId)) {\r\n        logger.info(`${this} ignored remote 'stream removed' event for non-user stream[id=${streamId}]`);\r\n\r\n        return;\r\n    }\r\n    logger.info(`${this} remote track removed stream[id=${streamId},trackId=${trackId}]`);\r\n\r\n    if (!streamId) {\r\n        GlobalOnErrorHandler.callErrorHandler(new Error(`${this} remote track removal failed - no stream ID`));\r\n\r\n        return;\r\n    }\r\n\r\n    if (!trackId) {\r\n        GlobalOnErrorHandler.callErrorHandler(new Error(`${this} remote track removal failed - no track ID`));\r\n\r\n        return;\r\n    }\r\n\r\n    if (!this._removeRemoteTrackById(streamId, trackId)) {\r\n        // NOTE this warning is always printed when user leaves the room,\r\n        // because we remove remote tracks manually on MUC member left event,\r\n        // before the SSRCs are removed by Jicofo. In most cases it is fine to\r\n        // ignore this warning, but still it's better to keep it printed for\r\n        // debugging purposes.\r\n        //\r\n        // We could change the behaviour to emit track removed only from here,\r\n        // but the order of the events will change and consuming apps could\r\n        // behave unexpectedly (the \"user left\" event would come before \"track\r\n        // removed\" events).\r\n        logger.warn(`${this} Removed track not found for stream[id=${streamId},trackId=${trackId}]`);\r\n    }\r\n};\r\n\r\n/**\r\n * Finds remote track by it's stream and track ids.\r\n * @param {string} streamId the media stream id as defined by the WebRTC\r\n * @param {string} trackId the media track id as defined by the WebRTC\r\n * @return {JitsiRemoteTrack|undefined} the track's instance or\r\n * <tt>undefined</tt> if not found.\r\n * @private\r\n */\r\nTraceablePeerConnection.prototype._getRemoteTrackById = function(\r\n        streamId,\r\n        trackId) {\r\n    // .find will break the loop once the first match is found\r\n    for (const endpointTrackMap of this.remoteTracks.values()) {\r\n        for (const mediaTrack of endpointTrackMap.values()) {\r\n            // FIXME verify and try to use ===\r\n            /* eslint-disable eqeqeq */\r\n            if (mediaTrack.getStreamId() == streamId\r\n                && mediaTrack.getTrackId() == trackId) {\r\n                return mediaTrack;\r\n            }\r\n\r\n            /* eslint-enable eqeqeq */\r\n        }\r\n    }\r\n\r\n    return undefined;\r\n};\r\n\r\n/**\r\n * Removes all JitsiRemoteTracks associated with given MUC nickname\r\n * (resource part of the JID). Returns array of removed tracks.\r\n *\r\n * @param {string} owner - The resource part of the MUC JID.\r\n * @returns {JitsiRemoteTrack[]}\r\n */\r\nTraceablePeerConnection.prototype.removeRemoteTracks = function(owner) {\r\n    const removedTracks = [];\r\n    const remoteTracksMap = this.remoteTracks.get(owner);\r\n\r\n    if (remoteTracksMap) {\r\n        const removedAudioTrack = remoteTracksMap.get(MediaType.AUDIO);\r\n        const removedVideoTrack = remoteTracksMap.get(MediaType.VIDEO);\r\n\r\n        removedAudioTrack && removedTracks.push(removedAudioTrack);\r\n        removedVideoTrack && removedTracks.push(removedVideoTrack);\r\n\r\n        this.remoteTracks.delete(owner);\r\n    }\r\n    logger.debug(`${this} removed remote tracks[endpoint=${owner},count=${removedTracks.length}`);\r\n\r\n    return removedTracks;\r\n};\r\n\r\n/**\r\n * Removes and disposes given <tt>JitsiRemoteTrack</tt> instance. Emits\r\n * {@link RTCEvents.REMOTE_TRACK_REMOVED}.\r\n * @param {JitsiRemoteTrack} toBeRemoved\r\n */\r\nTraceablePeerConnection.prototype._removeRemoteTrack = function(toBeRemoved) {\r\n    toBeRemoved.dispose();\r\n    const participantId = toBeRemoved.getParticipantId();\r\n    const remoteTracksMap = this.remoteTracks.get(participantId);\r\n\r\n    if (!remoteTracksMap) {\r\n        logger.error(`${this} removeRemoteTrack: no remote tracks map for endpoint=${participantId}`);\r\n    } else if (!remoteTracksMap.delete(toBeRemoved.getType())) {\r\n        logger.error(`${this} Failed to remove ${toBeRemoved} - type mapping messed up ?`);\r\n    }\r\n    this.eventEmitter.emit(RTCEvents.REMOTE_TRACK_REMOVED, toBeRemoved);\r\n};\r\n\r\n/**\r\n * Removes and disposes <tt>JitsiRemoteTrack</tt> identified by given stream and\r\n * track ids.\r\n *\r\n * @param {string} streamId the media stream id as defined by the WebRTC\r\n * @param {string} trackId the media track id as defined by the WebRTC\r\n * @returns {JitsiRemoteTrack|undefined} the track which has been removed or\r\n * <tt>undefined</tt> if no track matching given stream and track ids was\r\n * found.\r\n */\r\nTraceablePeerConnection.prototype._removeRemoteTrackById = function(\r\n        streamId,\r\n        trackId) {\r\n    const toBeRemoved = this._getRemoteTrackById(streamId, trackId);\r\n\r\n    if (toBeRemoved) {\r\n        this._removeRemoteTrack(toBeRemoved);\r\n    }\r\n\r\n    return toBeRemoved;\r\n};\r\n\r\n/**\r\n * @typedef {Object} SSRCGroupInfo\r\n * @property {Array<number>} ssrcs group's SSRCs\r\n * @property {string} semantics\r\n */\r\n/**\r\n * @typedef {Object} TrackSSRCInfo\r\n * @property {Array<number>} ssrcs track's SSRCs\r\n * @property {Array<SSRCGroupInfo>} groups track's SSRC groups\r\n */\r\n/**\r\n * Returns map with keys msid and <tt>TrackSSRCInfo</tt> values.\r\n * @param {Object} desc the WebRTC SDP instance.\r\n * @return {Map<string,TrackSSRCInfo>}\r\n */\r\nfunction extractSSRCMap(desc) {\r\n    /**\r\n     * Track SSRC infos mapped by stream ID (msid)\r\n     * @type {Map<string,TrackSSRCInfo>}\r\n     */\r\n    const ssrcMap = new Map();\r\n\r\n    /**\r\n     * Groups mapped by primary SSRC number\r\n     * @type {Map<number,Array<SSRCGroupInfo>>}\r\n     */\r\n    const groupsMap = new Map();\r\n\r\n    if (typeof desc !== 'object' || desc === null\r\n        || typeof desc.sdp !== 'string') {\r\n        logger.warn('An empty description was passed as an argument');\r\n\r\n        return ssrcMap;\r\n    }\r\n\r\n    const session = transform.parse(desc.sdp);\r\n\r\n    if (!Array.isArray(session.media)) {\r\n        return ssrcMap;\r\n    }\r\n\r\n    for (const mLine of session.media) {\r\n        if (!Array.isArray(mLine.ssrcs)) {\r\n            continue; // eslint-disable-line no-continue\r\n        }\r\n\r\n        if (Array.isArray(mLine.ssrcGroups)) {\r\n            for (const group of mLine.ssrcGroups) {\r\n                if (typeof group.semantics !== 'undefined'\r\n                    && typeof group.ssrcs !== 'undefined') {\r\n                    // Parse SSRCs and store as numbers\r\n                    const groupSSRCs\r\n                        = group.ssrcs.split(' ').map(\r\n                            ssrcStr => parseInt(ssrcStr, 10));\r\n                    const primarySSRC = groupSSRCs[0];\r\n\r\n                    // Note that group.semantics is already present\r\n\r\n                    group.ssrcs = groupSSRCs;\r\n\r\n                    // eslint-disable-next-line max-depth\r\n                    if (!groupsMap.has(primarySSRC)) {\r\n                        groupsMap.set(primarySSRC, []);\r\n                    }\r\n                    groupsMap.get(primarySSRC).push(group);\r\n                }\r\n            }\r\n        }\r\n        for (const ssrc of mLine.ssrcs) {\r\n            if (ssrc.attribute !== 'msid') {\r\n                continue; // eslint-disable-line no-continue\r\n            }\r\n\r\n            const msid = ssrc.value;\r\n            let ssrcInfo = ssrcMap.get(msid);\r\n\r\n            if (!ssrcInfo) {\r\n                ssrcInfo = {\r\n                    ssrcs: [],\r\n                    groups: [],\r\n                    msid\r\n                };\r\n                ssrcMap.set(msid, ssrcInfo);\r\n            }\r\n\r\n            const ssrcNumber = ssrc.id;\r\n\r\n            ssrcInfo.ssrcs.push(ssrcNumber);\r\n\r\n            if (groupsMap.has(ssrcNumber)) {\r\n                const ssrcGroups = groupsMap.get(ssrcNumber);\r\n\r\n                for (const group of ssrcGroups) {\r\n                    ssrcInfo.groups.push(group);\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    return ssrcMap;\r\n}\r\n\r\n/**\r\n * Takes a SessionDescription object and returns a \"normalized\" version.\r\n * Currently it takes care of ordering the a=ssrc lines and denoting receive\r\n * only SSRCs.\r\n */\r\nconst normalizePlanB = function(desc) {\r\n    if (typeof desc !== 'object' || desc === null\r\n        || typeof desc.sdp !== 'string') {\r\n        logger.warn('An empty description was passed as an argument');\r\n\r\n        return desc;\r\n    }\r\n\r\n    // eslint-disable-next-line no-shadow\r\n    const transform = require('sdp-transform');\r\n    const session = transform.parse(desc.sdp);\r\n\r\n    if (typeof session !== 'undefined'\r\n            && typeof session.media !== 'undefined'\r\n            && Array.isArray(session.media)) {\r\n        session.media.forEach(mLine => {\r\n\r\n            // Chrome appears to be picky about the order in which a=ssrc lines\r\n            // are listed in an m-line when rtx is enabled (and thus there are\r\n            // a=ssrc-group lines with FID semantics). Specifically if we have\r\n            // \"a=ssrc-group:FID S1 S2\" and the \"a=ssrc:S2\" lines appear before\r\n            // the \"a=ssrc:S1\" lines, SRD fails.\r\n            // So, put SSRC which appear as the first SSRC in an FID ssrc-group\r\n            // first.\r\n            const firstSsrcs = [];\r\n            const newSsrcLines = [];\r\n\r\n            if (typeof mLine.ssrcGroups !== 'undefined'\r\n                && Array.isArray(mLine.ssrcGroups)) {\r\n                mLine.ssrcGroups.forEach(group => {\r\n                    if (typeof group.semantics !== 'undefined'\r\n                        && group.semantics === 'FID') {\r\n                        if (typeof group.ssrcs !== 'undefined') {\r\n                            firstSsrcs.push(Number(group.ssrcs.split(' ')[0]));\r\n                        }\r\n                    }\r\n                });\r\n            }\r\n\r\n            if (Array.isArray(mLine.ssrcs)) {\r\n                let i;\r\n\r\n                for (i = 0; i < mLine.ssrcs.length; i++) {\r\n                    if (typeof mLine.ssrcs[i] === 'object'\r\n                        && typeof mLine.ssrcs[i].id !== 'undefined'\r\n                        && firstSsrcs.indexOf(mLine.ssrcs[i].id) >= 0) {\r\n                        newSsrcLines.push(mLine.ssrcs[i]);\r\n                        delete mLine.ssrcs[i];\r\n                    }\r\n                }\r\n\r\n                for (i = 0; i < mLine.ssrcs.length; i++) {\r\n                    if (typeof mLine.ssrcs[i] !== 'undefined') {\r\n                        newSsrcLines.push(mLine.ssrcs[i]);\r\n                    }\r\n                }\r\n\r\n                mLine.ssrcs = replaceDefaultUnifiedPlanMsid(newSsrcLines);\r\n            }\r\n        });\r\n    }\r\n\r\n    const resStr = transform.write(session);\r\n\r\n\r\n    return new RTCSessionDescription({\r\n        type: desc.type,\r\n        sdp: resStr\r\n    });\r\n};\r\n\r\n/**\r\n * Unified plan differentiates a remote track not associated with a stream using\r\n * the msid \"-\", which can incorrectly trigger an onaddstream event in plan-b.\r\n * For jitsi, these tracks are actually receive-only ssrcs. To prevent\r\n * onaddstream from firing, remove the ssrcs with msid \"-\" except the cname\r\n * line. Normally the ssrcs are not used by the client, as the bridge controls\r\n * media flow, but keep one reference to the ssrc for the p2p case.\r\n *\r\n * @param {Array<Object>} ssrcLines - The ssrc lines from a remote description.\r\n * @private\r\n * @returns {Array<Object>} ssrcLines with removed lines referencing msid \"-\".\r\n */\r\nfunction replaceDefaultUnifiedPlanMsid(ssrcLines = []) {\r\n    if (!browser.isChrome() || !browser.isVersionGreaterThan(70)) {\r\n        return ssrcLines;\r\n    }\r\n\r\n    let filteredLines = [ ...ssrcLines ];\r\n\r\n    const problematicSsrcIds = ssrcLines.filter(ssrcLine =>\r\n        ssrcLine.attribute === 'mslabel' && ssrcLine.value === '-')\r\n        .map(ssrcLine => ssrcLine.id);\r\n\r\n    problematicSsrcIds.forEach(ssrcId => {\r\n        // Find the cname which is to be modified and left in.\r\n        const cnameLine = filteredLines.find(line =>\r\n            line.id === ssrcId && line.attribute === 'cname');\r\n\r\n        cnameLine.value = `${MediaDirection.RECVONLY}-${ssrcId}`;\r\n\r\n        // Remove all of lines for the ssrc.\r\n        filteredLines\r\n            = filteredLines.filter(line => line.id !== ssrcId);\r\n\r\n        // But re-add the cname line so there is a reference kept to the ssrc\r\n        // in the SDP.\r\n        filteredLines.push(cnameLine);\r\n    });\r\n\r\n    return filteredLines;\r\n}\r\n\r\n/**\r\n * Makes sure that both audio and video directions are configured as 'sendrecv'.\r\n * @param {Object} localDescription the SDP object as defined by WebRTC.\r\n * @param {object} options <tt>TracablePeerConnection</tt> config options.\r\n */\r\nconst enforceSendRecv = function(localDescription, options) {\r\n    if (!localDescription) {\r\n        throw new Error('No local description passed in.');\r\n    }\r\n\r\n    const transformer = new SdpTransformWrap(localDescription.sdp);\r\n    const audioMedia = transformer.selectMedia(MediaType.AUDIO);\r\n    let changed = false;\r\n\r\n    if (audioMedia && audioMedia.direction !== MediaDirection.SENDRECV) {\r\n        if (options.startSilent) {\r\n            audioMedia.direction = MediaDirection.INACTIVE;\r\n        } else {\r\n            audioMedia.direction = MediaDirection.SENDRECV;\r\n        }\r\n\r\n        changed = true;\r\n    }\r\n\r\n    const videoMedia = transformer.selectMedia(MediaType.VIDEO);\r\n\r\n    if (videoMedia && videoMedia.direction !== MediaDirection.SENDRECV) {\r\n        videoMedia.direction = MediaDirection.SENDRECV;\r\n        changed = true;\r\n    }\r\n\r\n    if (changed) {\r\n        return new RTCSessionDescription({\r\n            type: localDescription.type,\r\n            sdp: transformer.toRawSDP()\r\n        });\r\n    }\r\n\r\n    return localDescription;\r\n};\r\n\r\n/**\r\n *\r\n * @param {JitsiLocalTrack} localTrack\r\n */\r\nTraceablePeerConnection.prototype.getLocalSSRC = function(localTrack) {\r\n    const ssrcInfo = this._getSSRC(localTrack.rtcId);\r\n\r\n    return ssrcInfo && ssrcInfo.ssrcs[0];\r\n};\r\n\r\n/**\r\n * When doing unified plan simulcast, we'll have a set of ssrcs with the\r\n * same msid but no ssrc-group, since unified plan signals the simulcast\r\n * group via the a=simulcast line.  Unfortunately, Jicofo will complain\r\n * if it sees ssrcs with matching msids but no ssrc-group, so we'll inject\r\n * an ssrc-group line to make Jicofo happy.\r\n * @param desc A session description object (with 'type' and 'sdp' fields)\r\n * @return A session description object with its sdp field modified to\r\n * contain an inject ssrc-group for simulcast\r\n */\r\nTraceablePeerConnection.prototype._injectSsrcGroupForUnifiedSimulcast\r\n    = function(desc) {\r\n        const sdp = transform.parse(desc.sdp);\r\n        const video = sdp.media.find(mline => mline.type === 'video');\r\n\r\n        // Check if the browser supports RTX, add only the primary ssrcs to the\r\n        // SIM group if that is the case.\r\n        video.ssrcGroups = video.ssrcGroups || [];\r\n        const fidGroups = video.ssrcGroups.filter(group => group.semantics === 'FID');\r\n\r\n        if (video.simulcast || video.simulcast_03) {\r\n            const ssrcs = [];\r\n\r\n            if (fidGroups && fidGroups.length) {\r\n                fidGroups.forEach(group => {\r\n                    ssrcs.push(group.ssrcs.split(' ')[0]);\r\n                });\r\n            } else {\r\n                video.ssrcs.forEach(ssrc => {\r\n                    if (ssrc.attribute === 'msid') {\r\n                        ssrcs.push(ssrc.id);\r\n                    }\r\n                });\r\n            }\r\n            if (video.ssrcGroups.find(group => group.semantics === 'SIM')) {\r\n                // Group already exists, no need to do anything\r\n                return desc;\r\n            }\r\n            video.ssrcGroups.push({\r\n                semantics: 'SIM',\r\n                ssrcs: ssrcs.join(' ')\r\n            });\r\n        }\r\n\r\n        return new RTCSessionDescription({\r\n            type: desc.type,\r\n            sdp: transform.write(sdp)\r\n        });\r\n    };\r\n\r\n/* eslint-disable-next-line vars-on-top */\r\nconst getters = {\r\n    signalingState() {\r\n        return this.peerconnection.signalingState;\r\n    },\r\n    iceConnectionState() {\r\n        return this.peerconnection.iceConnectionState;\r\n    },\r\n    localDescription() {\r\n        let desc = this.peerconnection.localDescription;\r\n\r\n        if (!desc) {\r\n            logger.debug(`${this} getLocalDescription no localDescription found`);\r\n\r\n            return {};\r\n        }\r\n\r\n        this.trace('getLocalDescription::preTransform', dumpSDP(desc));\r\n\r\n        // If the browser is running in unified plan mode and this is a jvb connection,\r\n        // transform the SDP to Plan B first.\r\n        if (this._usesUnifiedPlan && !this.isP2P) {\r\n            desc = this.interop.toPlanB(desc);\r\n            this.trace('getLocalDescription::postTransform (Plan B)',\r\n                dumpSDP(desc));\r\n\r\n            desc = this._injectSsrcGroupForUnifiedSimulcast(desc);\r\n            this.trace('getLocalDescription::postTransform (inject ssrc group)',\r\n                dumpSDP(desc));\r\n        } else if (!this._usesUnifiedPlan) {\r\n            if (browser.doesVideoMuteByStreamRemove()) {\r\n                desc = this.localSdpMunger.maybeAddMutedLocalVideoTracksToSDP(desc);\r\n                logger.debug(\r\n                    'getLocalDescription::postTransform (munge local SDP)', desc);\r\n            }\r\n\r\n            // What comes out of this getter will be signalled over Jingle to\r\n            // the other peer, so we need to make sure the media direction is\r\n            // 'sendrecv' because we won't change the direction later and don't want\r\n            // the other peer to think we can't send or receive.\r\n            //\r\n            // Note that the description we set in chrome does have the accurate\r\n            // direction (e.g. 'recvonly'), since that is technically what is\r\n            // happening (check setLocalDescription impl).\r\n            desc = enforceSendRecv(desc, this.options);\r\n        }\r\n\r\n        // See the method's doc for more info about this transformation.\r\n        desc = this.localSdpMunger.transformStreamIdentifiers(desc);\r\n\r\n        return desc;\r\n    },\r\n    remoteDescription() {\r\n        let desc = this.peerconnection.remoteDescription;\r\n\r\n        if (!desc) {\r\n            logger.debug(`${this} getRemoteDescription no remoteDescription found`);\r\n\r\n            return {};\r\n        }\r\n        this.trace('getRemoteDescription::preTransform', dumpSDP(desc));\r\n\r\n        if (this._usesUnifiedPlan) {\r\n            if (this.isP2P) {\r\n                // Adjust the media direction for p2p based on whether a local source has been added.\r\n                desc = this._adjustRemoteMediaDirection(desc);\r\n            } else {\r\n                // If this is a jvb connection, transform the SDP to Plan B first.\r\n                desc = this.interop.toPlanB(desc);\r\n                this.trace('getRemoteDescription::postTransform (Plan B)', dumpSDP(desc));\r\n            }\r\n        }\r\n\r\n        return desc;\r\n    }\r\n};\r\n\r\nObject.keys(getters).forEach(prop => {\r\n    Object.defineProperty(\r\n        TraceablePeerConnection.prototype,\r\n        prop, {\r\n            get: getters[prop]\r\n        }\r\n    );\r\n});\r\n\r\nTraceablePeerConnection.prototype._getSSRC = function(rtcId) {\r\n    return this.localSSRCs.get(rtcId);\r\n};\r\n\r\n/**\r\n * Checks if screensharing is in progress.\r\n *\r\n * @returns {boolean}  Returns true if a desktop track has been added to the\r\n * peerconnection, false otherwise.\r\n */\r\nTraceablePeerConnection.prototype._isSharingScreen = function() {\r\n    const track = this.getLocalVideoTrack();\r\n\r\n    return track && track.videoType === VideoType.DESKTOP;\r\n};\r\n\r\n/**\r\n * Munges the order of the codecs in the SDP passed based on the preference\r\n * set through config.js settings. All instances of the specified codec are\r\n * moved up to the top of the list when it is preferred. The specified codec\r\n * is deleted from the list if the configuration specifies that the codec be\r\n * disabled.\r\n * @param {RTCSessionDescription} description that needs to be munged.\r\n * @returns {RTCSessionDescription} the munged description.\r\n */\r\nTraceablePeerConnection.prototype._mungeCodecOrder = function(description) {\r\n    if (!this.codecPreference || this._usesTransceiverCodecPreferences) {\r\n        return description;\r\n    }\r\n\r\n    const parsedSdp = transform.parse(description.sdp);\r\n\r\n    for (const mLine of parsedSdp.media) {\r\n        if (this.codecPreference.enable && mLine.type === this.codecPreference.mediaType) {\r\n            SDPUtil.preferCodec(mLine, this.codecPreference.mimeType);\r\n\r\n            // Strip the high profile H264 codecs on mobile clients for p2p connection.\r\n            // High profile codecs give better quality at the expense of higher load which\r\n            // we do not want on mobile clients.\r\n            // Jicofo offers only the baseline code for the jvb connection.\r\n            // TODO - add check for mobile browsers once js-utils provides that check.\r\n            if (this.codecPreference.mimeType === CodecMimeType.H264 && browser.isReactNative() && this.isP2P) {\r\n                SDPUtil.stripCodec(mLine, this.codecPreference.mimeType, true /* high profile */);\r\n            }\r\n\r\n            // Set the max bitrate here on the SDP so that the configured max. bitrate is effective\r\n            // as soon as the browser switches to VP9.\r\n            if (this.codecPreference.mimeType === CodecMimeType.VP9) {\r\n                const bitrates = this.videoBitrates.VP9 || this.videoBitrates;\r\n                const hdBitrate = bitrates.high ? bitrates.high : HD_BITRATE;\r\n                const limit = Math.floor((this._isSharingScreen() ? HD_BITRATE : hdBitrate) / 1000);\r\n\r\n                // Use only the HD bitrate for now as there is no API available yet for configuring\r\n                // the bitrates on the individual SVC layers.\r\n                mLine.bandwidth = [ {\r\n                    type: 'AS',\r\n                    limit\r\n                } ];\r\n            } else {\r\n                // Clear the bandwidth limit in SDP when VP9 is no longer the preferred codec.\r\n                // This is needed on react native clients as react-native-webrtc returns the\r\n                // SDP that the application passed instead of returning the SDP off the native side.\r\n                // This line automatically gets cleared on web on every renegotiation.\r\n                mLine.bandwidth = undefined;\r\n            }\r\n        } else if (mLine.type === this.codecPreference.mediaType) {\r\n            SDPUtil.stripCodec(mLine, this.codecPreference.mimeType);\r\n        }\r\n    }\r\n\r\n    return new RTCSessionDescription({\r\n        type: description.type,\r\n        sdp: transform.write(parsedSdp)\r\n    });\r\n};\r\n\r\n/**\r\n * Checks if given track belongs to this peerconnection instance.\r\n *\r\n * @param {JitsiLocalTrack|JitsiRemoteTrack} track - The track to be checked.\r\n * @returns {boolean}\r\n */\r\nTraceablePeerConnection.prototype.containsTrack = function(track) {\r\n    if (track.isLocal()) {\r\n        return this.localTracks.has(track.rtcId);\r\n    }\r\n\r\n    const participantId = track.getParticipantId();\r\n    const remoteTracksMap = this.remoteTracks.get(participantId);\r\n\r\n    return Boolean(remoteTracksMap && remoteTracksMap.get(track.getType()) === track);\r\n};\r\n\r\n/**\r\n * Add {@link JitsiLocalTrack} to this TPC.\r\n * @param {JitsiLocalTrack} track\r\n * @param {boolean} isInitiator indicates if the endpoint is the offerer.\r\n * @returns {Promise<void>} - resolved when done.\r\n */\r\nTraceablePeerConnection.prototype.addTrack = function(track, isInitiator = false) {\r\n    const rtcId = track.rtcId;\r\n\r\n    logger.info(`${this} adding ${track}`);\r\n\r\n    if (this.localTracks.has(rtcId)) {\r\n\r\n        return Promise.reject(new Error(`${track} is already in ${this}`));\r\n    }\r\n\r\n    this.localTracks.set(rtcId, track);\r\n\r\n    if (this._usesUnifiedPlan) {\r\n        try {\r\n            this.tpcUtils.addTrack(track, isInitiator);\r\n        } catch (error) {\r\n            logger.error(`${this} Adding track=${track} failed: ${error?.message}`);\r\n\r\n            return Promise.reject(error);\r\n        }\r\n    } else {\r\n        // In all other cases, i.e., plan-b and unified plan bridge case, use addStream API to\r\n        // add the track to the peerconnection.\r\n        // TODO - addTransceiver doesn't generate a MSID for the stream, which is needed for signaling\r\n        // the ssrc to Jicofo. Switch to using UUID as MSID when addTransceiver is used in Unified plan\r\n        // JVB connection case as well.\r\n        const webrtcStream = track.getOriginalStream();\r\n\r\n        if (webrtcStream) {\r\n            this._addStream(webrtcStream);\r\n\r\n        // It's not ok for a track to not have a WebRTC stream if:\r\n        } else if (!browser.doesVideoMuteByStreamRemove()\r\n                    || track.isAudioTrack()\r\n                    || (track.isVideoTrack() && !track.isMuted())) {\r\n            return Promise.reject(new Error(`${this} no WebRTC stream for track=${track}`));\r\n        }\r\n\r\n        // Muted video tracks do not have WebRTC stream\r\n        if (browser.doesVideoMuteByStreamRemove() && track.isVideoTrack() && track.isMuted()) {\r\n            const ssrcInfo = this.generateNewStreamSSRCInfo(track);\r\n\r\n            this.sdpConsistency.setPrimarySsrc(ssrcInfo.ssrcs[0]);\r\n            const simGroup\r\n                = ssrcInfo.groups.find(groupInfo => groupInfo.semantics === 'SIM');\r\n\r\n            if (simGroup) {\r\n                this.simulcast.setSsrcCache(simGroup.ssrcs);\r\n            }\r\n            const fidGroups\r\n                = ssrcInfo.groups.filter(\r\n                    groupInfo => groupInfo.semantics === 'FID');\r\n\r\n            if (fidGroups) {\r\n                const rtxSsrcMapping = new Map();\r\n\r\n                fidGroups.forEach(fidGroup => {\r\n                    const primarySsrc = fidGroup.ssrcs[0];\r\n                    const rtxSsrc = fidGroup.ssrcs[1];\r\n\r\n                    rtxSsrcMapping.set(primarySsrc, rtxSsrc);\r\n                });\r\n                this.rtxModifier.setSsrcCache(rtxSsrcMapping);\r\n            }\r\n        }\r\n    }\r\n    let promiseChain = Promise.resolve();\r\n\r\n    // On Firefox, the encodings have to be configured on the sender only after the transceiver is created.\r\n    if (browser.isFirefox()) {\r\n        promiseChain = promiseChain.then(() => this.tpcUtils.setEncodings(track));\r\n    }\r\n\r\n    return promiseChain;\r\n};\r\n\r\n/**\r\n * Adds local track as part of the unmute operation.\r\n * @param {JitsiLocalTrack} track the track to be added as part of the unmute\r\n * operation\r\n * @return {Promise<boolean>} Promise that resolves to true if the underlying PeerConnection's\r\n * state has changed and renegotiation is required, false if no renegotiation is needed or\r\n * Promise is rejected when something goes wrong.\r\n */\r\nTraceablePeerConnection.prototype.addTrackUnmute = function(track) {\r\n    if (!this._assertTrackBelongs('addTrackUnmute', track)) {\r\n        // Abort\r\n        return Promise.reject('Track not found on the peerconnection');\r\n    }\r\n\r\n    logger.info(`${this} Adding track=${track} as unmute`);\r\n    const webRtcStream = track.getOriginalStream();\r\n\r\n    if (!webRtcStream) {\r\n        logger.error(`${this} Unable to add track=${track} as unmute - no WebRTC stream`);\r\n\r\n        return Promise.reject('Stream not found');\r\n    }\r\n\r\n    if (this._usesUnifiedPlan) {\r\n        return this.tpcUtils.addTrackUnmute(track);\r\n    }\r\n\r\n    this._addStream(webRtcStream);\r\n\r\n    return Promise.resolve(true);\r\n};\r\n\r\n/**\r\n * Adds WebRTC media stream to the underlying PeerConnection\r\n * @param {MediaStream} mediaStream\r\n * @private\r\n */\r\nTraceablePeerConnection.prototype._addStream = function(mediaStream) {\r\n    this.peerconnection.addStream(mediaStream);\r\n    this._addedStreams.push(mediaStream);\r\n};\r\n\r\n/**\r\n * Removes WebRTC media stream from the underlying PeerConection\r\n * @param {MediaStream} mediaStream\r\n */\r\nTraceablePeerConnection.prototype._removeStream = function(mediaStream) {\r\n    this.peerconnection.removeStream(mediaStream);\r\n    this._addedStreams\r\n        = this._addedStreams.filter(stream => stream !== mediaStream);\r\n};\r\n\r\n/**\r\n * This method when called will check if given <tt>localTrack</tt> belongs to\r\n * this TPC (that it has been previously added using {@link addTrack}). If the\r\n * track does not belong an error message will be logged.\r\n * @param {string} methodName the method name that will be logged in an error\r\n * message\r\n * @param {JitsiLocalTrack} localTrack\r\n * @return {boolean} <tt>true</tt> if given local track belongs to this TPC or\r\n * <tt>false</tt> otherwise.\r\n * @private\r\n */\r\nTraceablePeerConnection.prototype._assertTrackBelongs = function(\r\n        methodName,\r\n        localTrack) {\r\n    const doesBelong = this.localTracks.has(localTrack.rtcId);\r\n\r\n    if (!doesBelong) {\r\n        logger.error(`${this} ${methodName}: track=${localTrack} does not belong to pc`);\r\n    }\r\n\r\n    return doesBelong;\r\n};\r\n\r\n/**\r\n * Returns the codec that is configured on the client as the preferred video codec.\r\n * This takes into account the current order of codecs in the local description sdp.\r\n *\r\n * @returns {CodecMimeType} The codec that is set as the preferred codec to receive\r\n * video in the local SDP.\r\n */\r\nTraceablePeerConnection.prototype.getConfiguredVideoCodec = function() {\r\n    const sdp = this.peerconnection.localDescription?.sdp;\r\n    const defaultCodec = CodecMimeType.VP8;\r\n\r\n    if (!sdp) {\r\n        return defaultCodec;\r\n    }\r\n    const parsedSdp = transform.parse(sdp);\r\n    const mLine = parsedSdp.media.find(m => m.type === MediaType.VIDEO);\r\n    const codec = mLine.rtp[0].codec;\r\n\r\n    if (codec) {\r\n        return Object.values(CodecMimeType).find(value => value === codec.toLowerCase());\r\n    }\r\n\r\n    return defaultCodec;\r\n};\r\n\r\n/**\r\n * Sets the codec preference on the peerconnection. The codec preference goes into effect when\r\n * the next renegotiation happens.\r\n *\r\n * @param {CodecMimeType} preferredCodec the preferred codec.\r\n * @param {CodecMimeType} disabledCodec the codec that needs to be disabled.\r\n * @returns {void}\r\n */\r\nTraceablePeerConnection.prototype.setVideoCodecs = function(preferredCodec = null, disabledCodec = null) {\r\n    // If both enable and disable are set, disable settings will prevail.\r\n    const enable = disabledCodec === null;\r\n    const mimeType = disabledCodec ? disabledCodec : preferredCodec;\r\n\r\n    if (this.codecPreference && (preferredCodec || disabledCodec)) {\r\n        this.codecPreference.enable = enable;\r\n        this.codecPreference.mimeType = mimeType;\r\n    } else if (preferredCodec || disabledCodec) {\r\n        this.codecPreference = {\r\n            enable,\r\n            mediaType: MediaType.VIDEO,\r\n            mimeType\r\n        };\r\n    } else {\r\n        logger.warn(`${this} Invalid codec settings[preferred=${preferredCodec},disabled=${disabledCodec}],\r\n            atleast one value is needed`);\r\n    }\r\n};\r\n\r\n/**\r\n * Tells if the given WebRTC <tt>MediaStream</tt> has been added to\r\n * the underlying WebRTC PeerConnection.\r\n * @param {MediaStream} mediaStream\r\n * @returns {boolean}\r\n */\r\nTraceablePeerConnection.prototype.isMediaStreamInPc = function(mediaStream) {\r\n    return this._addedStreams.indexOf(mediaStream) > -1;\r\n};\r\n\r\n/**\r\n * Remove local track from this TPC.\r\n * @param {JitsiLocalTrack} localTrack the track to be removed from this TPC.\r\n *\r\n * FIXME It should probably remove a boolean just like {@link removeTrackMute}\r\n *       The same applies to addTrack.\r\n */\r\nTraceablePeerConnection.prototype.removeTrack = function(localTrack) {\r\n    const webRtcStream = localTrack.getOriginalStream();\r\n\r\n    this.trace(\r\n        'removeStream',\r\n        localTrack.rtcId, webRtcStream ? webRtcStream.id : undefined);\r\n\r\n    if (!this._assertTrackBelongs('removeStream', localTrack)) {\r\n        // Abort - nothing to be done here\r\n        return;\r\n    }\r\n    this.localTracks.delete(localTrack.rtcId);\r\n    this.localSSRCs.delete(localTrack.rtcId);\r\n\r\n    if (webRtcStream) {\r\n        this.peerconnection.removeStream(webRtcStream);\r\n    }\r\n};\r\n\r\n/**\r\n * Returns the sender corresponding to the given media type.\r\n * @param {MEDIA_TYPE} mediaType - The media type 'audio' or 'video' to be used for the search.\r\n * @returns {RTPSender|undefined} - The found sender or undefined if no sender\r\n * was found.\r\n */\r\nTraceablePeerConnection.prototype.findSenderByKind = function(mediaType) {\r\n    return this.peerconnection.getSenders().find(s => s.track && s.track.kind === mediaType);\r\n};\r\n\r\n/**\r\n * Returns the receiver corresponding to the given MediaStreamTrack.\r\n *\r\n * @param {MediaSreamTrack} track - The media stream track used for the search.\r\n * @returns {RTCRtpReceiver|undefined} - The found receiver or undefined if no receiver\r\n * was found.\r\n */\r\nTraceablePeerConnection.prototype.findReceiverForTrack = function(track) {\r\n    return this.peerconnection.getReceivers().find(r => r.track === track);\r\n};\r\n\r\n/**\r\n * Returns the sender corresponding to the given MediaStreamTrack.\r\n *\r\n * @param {MediaSreamTrack} track - The media stream track used for the search.\r\n * @returns {RTCRtpSender|undefined} - The found sender or undefined if no sender\r\n * was found.\r\n */\r\nTraceablePeerConnection.prototype.findSenderForTrack = function(track) {\r\n    return this.peerconnection.getSenders().find(s => s.track === track);\r\n};\r\n\r\n/**\r\n * Replaces <tt>oldTrack</tt> with <tt>newTrack</tt> from the peer connection.\r\n * Either <tt>oldTrack</tt> or <tt>newTrack</tt> can be null; replacing a valid\r\n * <tt>oldTrack</tt> with a null <tt>newTrack</tt> effectively just removes\r\n * <tt>oldTrack</tt>\r\n *\r\n * @param {JitsiLocalTrack|null} oldTrack - The current track in use to be\r\n * replaced\r\n * @param {JitsiLocalTrack|null} newTrack - The new track to use\r\n * @returns {Promise<boolean>} - If the promise resolves with true,\r\n * renegotiation will be needed. Otherwise no renegotiation is needed.\r\n */\r\nTraceablePeerConnection.prototype.replaceTrack = function(oldTrack, newTrack) {\r\n    if (this._usesUnifiedPlan) {\r\n        logger.debug(`${this} TPC.replaceTrack using unified plan`);\r\n\r\n        return this.tpcUtils.replaceTrack(oldTrack, newTrack)\r\n\r\n            // renegotiate when SDP is used for simulcast munging\r\n            .then(() => this.isSimulcastOn() && browser.usesSdpMungingForSimulcast());\r\n    }\r\n\r\n    logger.debug(`${this} TPC.replaceTrack using plan B`);\r\n\r\n    let promiseChain = Promise.resolve();\r\n\r\n    if (oldTrack) {\r\n        this.removeTrack(oldTrack);\r\n    }\r\n    if (newTrack) {\r\n        promiseChain = this.addTrack(newTrack);\r\n    }\r\n\r\n    return promiseChain.then(() => true);\r\n};\r\n\r\n/**\r\n * Removes local track as part of the mute operation.\r\n * @param {JitsiLocalTrack} localTrack the local track to be remove as part of\r\n * the mute operation.\r\n * @return {Promise<boolean>} Promise that resolves to true if the underlying PeerConnection's\r\n * state has changed and renegotiation is required, false if no renegotiation is needed or\r\n * Promise is rejected when something goes wrong.\r\n */\r\nTraceablePeerConnection.prototype.removeTrackMute = function(localTrack) {\r\n    const webRtcStream = localTrack.getOriginalStream();\r\n\r\n    this.trace(\r\n        'removeStreamMute',\r\n        localTrack.rtcId, webRtcStream ? webRtcStream.id : null);\r\n\r\n    if (!this._assertTrackBelongs('removeStreamMute', localTrack)) {\r\n        // Abort - nothing to be done here\r\n        return Promise.reject('Track not found in the peerconnection');\r\n    }\r\n\r\n    if (this._usesUnifiedPlan) {\r\n        return this.tpcUtils.removeTrackMute(localTrack);\r\n    }\r\n\r\n    if (webRtcStream) {\r\n        logger.info(`${this} Removing track=${localTrack} as mute`);\r\n        this._removeStream(webRtcStream);\r\n\r\n        return Promise.resolve(true);\r\n    }\r\n\r\n    logger.error(`${this} removeStreamMute - no WebRTC stream for track=${localTrack}`);\r\n\r\n    return Promise.reject('Stream not found');\r\n};\r\n\r\nTraceablePeerConnection.prototype.createDataChannel = function(label, opts) {\r\n    this.trace('createDataChannel', label, opts);\r\n\r\n    return this.peerconnection.createDataChannel(label, opts);\r\n};\r\n\r\n/**\r\n * Ensures that the simulcast ssrc-group appears after any other ssrc-groups\r\n * in the SDP so that simulcast is properly activated.\r\n *\r\n * @param {Object} localSdp the WebRTC session description instance for\r\n * the local description.\r\n * @private\r\n */\r\nTraceablePeerConnection.prototype._ensureSimulcastGroupIsLast = function(\r\n        localSdp) {\r\n    let sdpStr = localSdp.sdp;\r\n\r\n    const videoStartIndex = sdpStr.indexOf('m=video');\r\n    const simStartIndex = sdpStr.indexOf('a=ssrc-group:SIM', videoStartIndex);\r\n    let otherStartIndex = sdpStr.lastIndexOf('a=ssrc-group');\r\n\r\n    if (simStartIndex === -1\r\n        || otherStartIndex === -1\r\n        || otherStartIndex === simStartIndex) {\r\n        return localSdp;\r\n    }\r\n\r\n    const simEndIndex = sdpStr.indexOf('\\r\\n', simStartIndex);\r\n    const simStr = sdpStr.substring(simStartIndex, simEndIndex + 2);\r\n\r\n    sdpStr = sdpStr.replace(simStr, '');\r\n    otherStartIndex = sdpStr.lastIndexOf('a=ssrc-group');\r\n    const otherEndIndex = sdpStr.indexOf('\\r\\n', otherStartIndex);\r\n    const sdpHead = sdpStr.slice(0, otherEndIndex);\r\n    const simStrTrimmed = simStr.trim();\r\n    const sdpTail = sdpStr.slice(otherEndIndex);\r\n\r\n    sdpStr = `${sdpHead}\\r\\n${simStrTrimmed}${sdpTail}`;\r\n\r\n    return new RTCSessionDescription({\r\n        type: localSdp.type,\r\n        sdp: sdpStr\r\n    });\r\n};\r\n\r\n/**\r\n * Will adjust audio and video media direction in the given SDP object to\r\n * reflect the current status of the {@link audioTransferActive} and\r\n * {@link videoTransferActive} flags.\r\n * @param {RTCSessionDescription} localDescription the WebRTC session description instance for\r\n * the local description.\r\n * @private\r\n */\r\nTraceablePeerConnection.prototype._adjustLocalMediaDirection = function(localDescription) {\r\n    const transformer = new SdpTransformWrap(localDescription.sdp);\r\n    let modifiedDirection = false;\r\n    const audioMedia = transformer.selectMedia(MediaType.AUDIO);\r\n\r\n    if (audioMedia) {\r\n        const desiredAudioDirection = this.getDesiredMediaDirection(MediaType.AUDIO);\r\n\r\n        if (audioMedia.direction !== desiredAudioDirection) {\r\n            audioMedia.direction = desiredAudioDirection;\r\n            logger.info(`${this} Adjusted local audio direction to ${desiredAudioDirection}`);\r\n            modifiedDirection = true;\r\n        }\r\n    } else {\r\n        logger.warn(`${this} No \"audio\" media found in the local description`);\r\n    }\r\n\r\n    const videoMedia = transformer.selectMedia(MediaType.VIDEO);\r\n\r\n    if (videoMedia) {\r\n        const desiredVideoDirection = this.getDesiredMediaDirection(MediaType.VIDEO);\r\n\r\n        if (videoMedia.direction !== desiredVideoDirection) {\r\n            videoMedia.direction = desiredVideoDirection;\r\n            logger.info(`${this} Adjusted local video direction to ${desiredVideoDirection}`);\r\n            modifiedDirection = true;\r\n        }\r\n    } else {\r\n        logger.warn(`${this} No \"video\" media found in the local description`);\r\n    }\r\n\r\n    if (modifiedDirection) {\r\n        return new RTCSessionDescription({\r\n            type: localDescription.type,\r\n            sdp: transformer.toRawSDP()\r\n        });\r\n    }\r\n\r\n    return localDescription;\r\n};\r\n\r\n/**\r\n * Adjusts the media direction on the remote description based on availability of local and remote sources in a p2p\r\n * media connection.\r\n *\r\n * @param {RTCSessionDescription} remoteDescription the WebRTC session description instance for the remote description.\r\n * @returns the transformed remoteDescription.\r\n * @private\r\n */\r\nTraceablePeerConnection.prototype._adjustRemoteMediaDirection = function(remoteDescription) {\r\n    const transformer = new SdpTransformWrap(remoteDescription.sdp);\r\n\r\n    [ MediaType.AUDIO, MediaType.VIDEO ].forEach(mediaType => {\r\n        const media = transformer.selectMedia(mediaType);\r\n        const hasLocalSource = this.hasAnyTracksOfType(mediaType);\r\n        const hasRemoteSource = this.getRemoteTracks(null, mediaType).length > 0;\r\n\r\n        media.direction = hasLocalSource && hasRemoteSource\r\n            ? MediaDirection.SENDRECV\r\n            : hasLocalSource ? MediaDirection.RECVONLY : MediaDirection.SENDONLY;\r\n    });\r\n\r\n    return new RTCSessionDescription({\r\n        type: remoteDescription.type,\r\n        sdp: transformer.toRawSDP()\r\n    });\r\n};\r\n\r\n/**\r\n * Munges the stereo flag as well as the opusMaxAverageBitrate in the SDP, based\r\n * on values set through config.js, if present.\r\n *\r\n * @param {RTCSessionDescription} description that needs to be munged.\r\n * @returns {RTCSessionDescription} the munged description.\r\n */\r\nTraceablePeerConnection.prototype._mungeOpus = function(description) {\r\n    const { audioQuality } = this.options;\r\n\r\n    if (!audioQuality?.stereo && !audioQuality?.opusMaxAverageBitrate) {\r\n        return description;\r\n    }\r\n\r\n    const parsedSdp = transform.parse(description.sdp);\r\n    const mLines = parsedSdp.media;\r\n\r\n    for (const mLine of mLines) {\r\n        if (mLine.type === 'audio') {\r\n            const { payload } = mLine.rtp.find(protocol => protocol.codec === CodecMimeType.OPUS);\r\n\r\n            if (!payload) {\r\n                // eslint-disable-next-line no-continue\r\n                continue;\r\n            }\r\n\r\n            let fmtpOpus = mLine.fmtp.find(protocol => protocol.payload === payload);\r\n\r\n            if (!fmtpOpus) {\r\n                fmtpOpus = {\r\n                    payload,\r\n                    config: ''\r\n                };\r\n            }\r\n\r\n            const fmtpConfig = transform.parseParams(fmtpOpus.config);\r\n            let sdpChanged = false;\r\n\r\n            if (audioQuality?.stereo) {\r\n                fmtpConfig.stereo = 1;\r\n                sdpChanged = true;\r\n            }\r\n\r\n            if (audioQuality?.opusMaxAverageBitrate) {\r\n                fmtpConfig.maxaveragebitrate = audioQuality.opusMaxAverageBitrate;\r\n                sdpChanged = true;\r\n            }\r\n\r\n            if (!sdpChanged) {\r\n                // eslint-disable-next-line no-continue\r\n                continue;\r\n            }\r\n\r\n            let mungedConfig = '';\r\n\r\n            for (const key of Object.keys(fmtpConfig)) {\r\n                mungedConfig += `${key}=${fmtpConfig[key]}; `;\r\n            }\r\n\r\n            fmtpOpus.config = mungedConfig.trim();\r\n        }\r\n    }\r\n\r\n    return new RTCSessionDescription({\r\n        type: description.type,\r\n        sdp: transform.write(parsedSdp)\r\n    });\r\n};\r\n\r\nTraceablePeerConnection.prototype.setLocalDescription = function(description) {\r\n    let localSdp = description;\r\n\r\n    this.trace('setLocalDescription::preTransform', dumpSDP(localSdp));\r\n\r\n    // Munge the order of the codecs based on the preferences set through config.js\r\n    localSdp = this._mungeCodecOrder(localSdp);\r\n\r\n    // Munge stereo flag and opusMaxAverageBitrate based on config.js\r\n    localSdp = this._mungeOpus(localSdp);\r\n\r\n    if (!this._usesUnifiedPlan) {\r\n        localSdp = this._adjustLocalMediaDirection(localSdp);\r\n        localSdp = this._ensureSimulcastGroupIsLast(localSdp);\r\n    } else if (!this.isP2P) {\r\n\r\n        // if we're using unified plan, transform to it first.\r\n        localSdp = this.interop.toUnifiedPlan(localSdp);\r\n        this.trace(\r\n            'setLocalDescription::postTransform (Unified Plan)',\r\n            dumpSDP(localSdp));\r\n    }\r\n\r\n    return new Promise((resolve, reject) => {\r\n        this.peerconnection.setLocalDescription(localSdp)\r\n            .then(() => {\r\n                this.trace('setLocalDescriptionOnSuccess');\r\n                const localUfrag = SDPUtil.getUfrag(localSdp.sdp);\r\n\r\n                if (localUfrag !== this.localUfrag) {\r\n                    this.localUfrag = localUfrag;\r\n                    this.eventEmitter.emit(\r\n                        RTCEvents.LOCAL_UFRAG_CHANGED, this, localUfrag);\r\n                }\r\n                resolve();\r\n            }, err => {\r\n                this.trace('setLocalDescriptionOnFailure', err);\r\n                this.eventEmitter.emit(\r\n                    RTCEvents.SET_LOCAL_DESCRIPTION_FAILED,\r\n                    err, this);\r\n                reject(err);\r\n            });\r\n    });\r\n};\r\n\r\n/**\r\n * Enables/disables audio media transmission on this peer connection. When\r\n * disabled the SDP audio media direction in the local SDP will be adjusted to\r\n * 'inactive' which means that no data will be sent nor accepted, but\r\n * the connection should be kept alive.\r\n * @param {boolean} active <tt>true</tt> to enable audio media transmission or\r\n * <tt>false</tt> to disable. If the value is not a boolean the call will have\r\n * no effect.\r\n * @return {boolean} <tt>true</tt> if the value has changed and sRD/sLD cycle\r\n * needs to be executed in order for the changes to take effect or\r\n * <tt>false</tt> if the given value was the same as the previous one.\r\n * @public\r\n */\r\nTraceablePeerConnection.prototype.setAudioTransferActive = function(active) {\r\n    logger.debug(`${this} audio transfer active: ${active}`);\r\n    const changed = this.audioTransferActive !== active;\r\n\r\n    this.audioTransferActive = active;\r\n\r\n    if (this._usesUnifiedPlan) {\r\n        this.tpcUtils.setAudioTransferActive(active);\r\n\r\n        // false means no renegotiation up the chain which is not needed in the Unified mode\r\n        return false;\r\n    }\r\n\r\n    return changed;\r\n};\r\n\r\n/**\r\n * Sets the degradation preference on the video sender. This setting determines if\r\n * resolution or framerate will be preferred when bandwidth or cpu is constrained.\r\n * Sets it to 'maintain-framerate' when a camera track is added to the pc, sets it\r\n * to 'maintain-resolution' when a desktop track is being shared instead.\r\n * @returns {Promise<void>}\r\n */\r\nTraceablePeerConnection.prototype.setSenderVideoDegradationPreference = function() {\r\n    if (!this.peerconnection.getSenders) {\r\n        logger.debug(`${this} Browser does not support RTCRtpSender`);\r\n\r\n        return Promise.resolve();\r\n    }\r\n    const localVideoTrack = this.getLocalVideoTrack();\r\n    const videoSender = this.findSenderByKind(MediaType.VIDEO);\r\n\r\n    if (!videoSender) {\r\n        return Promise.resolve();\r\n    }\r\n    const parameters = videoSender.getParameters();\r\n    const preference = localVideoTrack.videoType === VideoType.CAMERA\r\n        ? DEGRADATION_PREFERENCE_CAMERA\r\n        : this.options.capScreenshareBitrate && !this._usesUnifiedPlan\r\n\r\n            // Prefer resolution for low fps share.\r\n            ? DEGRADATION_PREFERENCE_DESKTOP\r\n\r\n            // Prefer frame-rate for high fps share.\r\n            : DEGRADATION_PREFERENCE_CAMERA;\r\n\r\n    logger.info(`${this} Setting a degradation preference [preference=${preference},track=${localVideoTrack}`);\r\n    parameters.degradationPreference = preference;\r\n    this.tpcUtils.updateEncodingsResolution(parameters);\r\n\r\n    return videoSender.setParameters(parameters);\r\n};\r\n\r\n/**\r\n * Sets the max bitrate on the RTCRtpSender so that the\r\n * bitrate of the enocder doesn't exceed the configured value.\r\n * This is needed for the desktop share until spec-complaint\r\n * simulcast is implemented.\r\n * @param {JitsiLocalTrack} localTrack - the local track whose\r\n * max bitrate is to be configured.\r\n * @returns {Promise<void>}\r\n */\r\nTraceablePeerConnection.prototype.setMaxBitRate = function() {\r\n    // For VP9, max bitrate is configured by setting b=AS value in SDP. Browsers do\r\n    // not yet support setting max bitrates for individual VP9 SVC layers.\r\n    if (this.getConfiguredVideoCodec() === CodecMimeType.VP9 || !window.RTCRtpSender) {\r\n        return Promise.resolve();\r\n    }\r\n    const localVideoTrack = this.getLocalVideoTrack();\r\n\r\n    if (!localVideoTrack) {\r\n        return Promise.resolve();\r\n    }\r\n\r\n    const videoType = localVideoTrack.videoType;\r\n    const planBScreenSharing = !this._usesUnifiedPlan && videoType === VideoType.DESKTOP;\r\n\r\n    // Apply the maxbitrates on the video track when one of the conditions is met.\r\n    // 1. Max. bitrates for video are specified through videoQuality settings in config.js\r\n    // 2. Track is a desktop track and bitrate is capped using capScreenshareBitrate option in plan-b mode.\r\n    // 3. The client is running in Unified plan mode.\r\n    if (!((this.options.videoQuality && this.options.videoQuality.maxBitratesVideo)\r\n        || (planBScreenSharing && this.options.capScreenshareBitrate)\r\n        || this._usesUnifiedPlan)) {\r\n        return Promise.resolve();\r\n    }\r\n\r\n    const presenterEnabled = localVideoTrack._originalStream\r\n        && localVideoTrack._originalStream.id !== localVideoTrack.getStreamId();\r\n    const videoSender = this.findSenderByKind(MediaType.VIDEO);\r\n\r\n    if (!videoSender) {\r\n        return Promise.resolve();\r\n    }\r\n    const parameters = videoSender.getParameters();\r\n\r\n    if (!(parameters.encodings && parameters.encodings.length)) {\r\n        return Promise.resolve();\r\n    }\r\n\r\n    if (this.isSimulcastOn()) {\r\n        for (const encoding in parameters.encodings) {\r\n            if (parameters.encodings.hasOwnProperty(encoding)) {\r\n                let bitrate;\r\n\r\n                if (planBScreenSharing) {\r\n                    // On chromium, set a max bitrate of 500 Kbps for screenshare when capScreenshareBitrate\r\n                    // is enabled through config.js and presenter is not turned on.\r\n                    // FIXME the top 'isSimulcastOn' condition is confusing for screensharing, because\r\n                    // if capScreenshareBitrate option is enabled then the simulcast is turned off\r\n                    bitrate = this.options.capScreenshareBitrate\r\n                        ? presenterEnabled ? HD_BITRATE : DESKTOP_SHARE_RATE\r\n\r\n                        // Remove the bitrate config if not capScreenshareBitrate:\r\n                        // When switching from camera to desktop and videoQuality.maxBitratesVideo were set,\r\n                        // then the 'maxBitrate' setting must be cleared, because if simulcast is enabled for screen\r\n                        // and maxBitrates are set then Chrome will not send the screen stream (plan B).\r\n                        : undefined;\r\n                } else {\r\n                    bitrate = this.tpcUtils.localStreamEncodingsConfig[encoding].maxBitrate;\r\n                }\r\n\r\n                logger.info(`${this} Setting a max bitrate of ${bitrate} bps on layer `\r\n                    + `${this.tpcUtils.localStreamEncodingsConfig[encoding].rid}`);\r\n                parameters.encodings[encoding].maxBitrate = bitrate;\r\n            }\r\n        }\r\n    } else {\r\n        // Do not change the max bitrate for desktop tracks in non-simulcast mode.\r\n        let bitrate = this.getTargetVideoBitrates()?.high;\r\n\r\n        if (videoType === VideoType.CAMERA) {\r\n            // Determine the bitrates based on the sender constraint applied for unicast tracks.\r\n            const scaleFactor = this.senderVideoMaxHeight\r\n                ? Math.floor(localVideoTrack.resolution / this.senderVideoMaxHeight)\r\n                : 1;\r\n            const encoding = this.tpcUtils.localStreamEncodingsConfig\r\n                .find(layer => layer.scaleResolutionDownBy === scaleFactor);\r\n\r\n            if (encoding) {\r\n                logger.info(`${this} Setting max bitrate=${encoding.maxBitrate} bps on track=${localVideoTrack}`);\r\n                bitrate = encoding.maxBitrate;\r\n            }\r\n        }\r\n        parameters.encodings[0].maxBitrate = bitrate;\r\n    }\r\n    this.tpcUtils.updateEncodingsResolution(parameters);\r\n\r\n    return videoSender.setParameters(parameters);\r\n};\r\n\r\nTraceablePeerConnection.prototype.setRemoteDescription = function(description) {\r\n    this.trace('setRemoteDescription::preTransform', dumpSDP(description));\r\n\r\n    /* eslint-disable no-param-reassign */\r\n\r\n    // Munge the order of the codecs based on the preferences set through config.js\r\n    description = this._mungeCodecOrder(description);\r\n\r\n    // Munge stereo flag and opusMaxAverageBitrate based on config.js\r\n    description = this._mungeOpus(description);\r\n\r\n    /* eslint-enable no-param-reassign */\r\n\r\n    if (!this._usesUnifiedPlan) {\r\n        // TODO the focus should squeze or explode the remote simulcast\r\n        if (this.isSimulcastOn()) {\r\n            // eslint-disable-next-line no-param-reassign\r\n            description = this.simulcast.mungeRemoteDescription(description, true /* add x-google-conference flag */);\r\n            this.trace(\r\n                'setRemoteDescription::postTransform (simulcast)',\r\n                dumpSDP(description));\r\n        }\r\n\r\n        // eslint-disable-next-line no-param-reassign\r\n        description = normalizePlanB(description);\r\n    } else if (!this.isP2P) {\r\n        const currentDescription = this.peerconnection.remoteDescription;\r\n\r\n        // eslint-disable-next-line no-param-reassign\r\n        description = this.interop.toUnifiedPlan(description, currentDescription);\r\n        this.trace(\r\n            'setRemoteDescription::postTransform (Unified)',\r\n            dumpSDP(description));\r\n\r\n        if (this.isSimulcastOn()) {\r\n            // eslint-disable-next-line no-param-reassign\r\n            description = this.simulcast.mungeRemoteDescription(description);\r\n\r\n            // eslint-disable-next-line no-param-reassign\r\n            description = this.tpcUtils.insertUnifiedPlanSimulcastReceive(description);\r\n            this.trace(\r\n                'setRemoteDescription::postTransform (sim receive)',\r\n                dumpSDP(description));\r\n        }\r\n    }\r\n\r\n    if (this._usesUnifiedPlan) {\r\n        // eslint-disable-next-line no-param-reassign\r\n        description = this.tpcUtils.ensureCorrectOrderOfSsrcs(description);\r\n    }\r\n\r\n    return new Promise((resolve, reject) => {\r\n        this.peerconnection.setRemoteDescription(description)\r\n            .then(() => {\r\n                this.trace('setRemoteDescriptionOnSuccess');\r\n                const remoteUfrag = SDPUtil.getUfrag(description.sdp);\r\n\r\n                if (remoteUfrag !== this.remoteUfrag) {\r\n                    this.remoteUfrag = remoteUfrag;\r\n                    this.eventEmitter.emit(\r\n                        RTCEvents.REMOTE_UFRAG_CHANGED, this, remoteUfrag);\r\n                }\r\n                resolve();\r\n            }, err => {\r\n                this.trace('setRemoteDescriptionOnFailure', err);\r\n                this.eventEmitter.emit(\r\n                    RTCEvents.SET_REMOTE_DESCRIPTION_FAILED,\r\n                    err,\r\n                    this);\r\n                reject(err);\r\n            });\r\n    });\r\n};\r\n\r\n/**\r\n * Changes the resolution of the video stream that is sent to the peer based on\r\n * the user preferred value. If simulcast is enabled on the peerconection, all the\r\n * simulcast encodings that have a resolution height lower or equal to the value\r\n * provided will remain active. For the non-simulcast case, video constraint is\r\n * applied on the track.\r\n * @param {number} frameHeight - The user preferred max frame height.\r\n * @returns {Promise} promise that will be resolved when the operation is\r\n * successful and rejected otherwise.\r\n */\r\nTraceablePeerConnection.prototype.setSenderVideoConstraint = function(frameHeight = null) {\r\n    if (frameHeight < 0) {\r\n        throw new Error(`Invalid frameHeight: ${frameHeight}`);\r\n    }\r\n\r\n    // XXX: This is not yet supported on mobile.\r\n    if (browser.isReactNative()) {\r\n        return Promise.resolve();\r\n    }\r\n\r\n    // Need to explicitly check for null as 0 is falsy, but a valid value\r\n    const newHeight = frameHeight === null ? this.senderVideoMaxHeight : frameHeight;\r\n\r\n    this.senderVideoMaxHeight = newHeight;\r\n\r\n    // If layer suspension is disabled and sender constraint is not configured for the conference,\r\n    // resolve here so that the encodings stay enabled. This can happen in custom apps built using\r\n    // lib-jitsi-meet.\r\n    if (newHeight === null) {\r\n        return Promise.resolve();\r\n    }\r\n\r\n    logger.log(`${this} senderVideoMaxHeight: ${newHeight}`);\r\n\r\n    const localVideoTrack = this.getLocalVideoTrack();\r\n\r\n    if (!localVideoTrack || localVideoTrack.isMuted()) {\r\n        return Promise.resolve();\r\n    }\r\n    const videoSender = this.findSenderByKind(MediaType.VIDEO);\r\n\r\n    if (!videoSender) {\r\n        return Promise.resolve();\r\n    }\r\n    const parameters = videoSender.getParameters();\r\n\r\n    if (!parameters || !parameters.encodings || !parameters.encodings.length) {\r\n        return Promise.resolve();\r\n    }\r\n\r\n    if (this.isSimulcastOn()) {\r\n        // Determine the encodings that need to stay enabled based on the new frameHeight provided.\r\n        this.encodingsEnabledState = this.tpcUtils.getLocalStreamHeightConstraints(localVideoTrack.track)\r\n            .map(height => height <= newHeight);\r\n\r\n        // Always keep the LD stream enabled, specifically when the LD stream's resolution is higher than of the\r\n        // requested resolution. This can happen when camera is captured at resolutions higher than 720p but the\r\n        // requested resolution is 180. Since getParameters doesn't give us information about the resolutions\r\n        // of the simulcast encodings, we have to rely on our initial config for the simulcast streams.\r\n        const ldStreamIndex = this.tpcUtils.localStreamEncodingsConfig\r\n            .findIndex(layer => layer.scaleResolutionDownBy === 4.0);\r\n\r\n        if (newHeight > 0 && ldStreamIndex !== -1) {\r\n            this.encodingsEnabledState[ldStreamIndex] = true;\r\n        }\r\n        for (const encoding in parameters.encodings) {\r\n            if (parameters.encodings.hasOwnProperty(encoding)) {\r\n                parameters.encodings[encoding].active = this.encodingsEnabledState[encoding];\r\n            }\r\n        }\r\n        this.tpcUtils.updateEncodingsResolution(parameters);\r\n    } else if (newHeight > 0) {\r\n        // Do not scale down the desktop tracks until SendVideoController is able to propagate the sender constraints\r\n        // only on the active media connection. Right now, the sender constraints received on the bridge channel\r\n        // are propagated on both the jvb and p2p connections in cases where they both are active at the same time.\r\n        parameters.encodings[0].scaleResolutionDownBy\r\n            = localVideoTrack.videoType === VideoType.DESKTOP || localVideoTrack.resolution <= newHeight\r\n                ? 1\r\n                : localVideoTrack.resolution ? Math.floor(localVideoTrack.resolution / newHeight) : undefined;\r\n        parameters.encodings[0].active = true;\r\n    } else {\r\n        parameters.encodings[0].scaleResolutionDownBy = undefined;\r\n        parameters.encodings[0].active = false;\r\n    }\r\n\r\n    logger.info(`${this} setting max height=${newHeight},encodings=${JSON.stringify(parameters.encodings)}`);\r\n\r\n    return videoSender.setParameters(parameters).then(() => {\r\n        localVideoTrack.maxEnabledResolution = newHeight;\r\n        this.eventEmitter.emit(RTCEvents.LOCAL_TRACK_MAX_ENABLED_RESOLUTION_CHANGED, localVideoTrack);\r\n\r\n        // Max bitrate needs to be reconfigured on the sender in p2p/non-simulcast case if needed when\r\n        // the send resolution changes.\r\n        if (this.isP2P || !this.isSimulcastOn()) {\r\n            return this.setMaxBitRate();\r\n        }\r\n    });\r\n};\r\n\r\n/**\r\n * Enables/disables video media transmission on this peer connection. When\r\n * disabled the SDP video media direction in the local SDP will be adjusted to\r\n * 'inactive' which means that no data will be sent nor accepted, but\r\n * the connection should be kept alive.\r\n * @param {boolean} active <tt>true</tt> to enable video media transmission or\r\n * <tt>false</tt> to disable. If the value is not a boolean the call will have\r\n * no effect.\r\n * @return {boolean} <tt>true</tt> if the value has changed and sRD/sLD cycle\r\n * needs to be executed in order for the changes to take effect or\r\n * <tt>false</tt> if the given value was the same as the previous one.\r\n * @public\r\n */\r\nTraceablePeerConnection.prototype.setVideoTransferActive = function(active) {\r\n    logger.debug(`${this} video transfer active: ${active}`);\r\n    const changed = this.videoTransferActive !== active;\r\n\r\n    this.videoTransferActive = active;\r\n\r\n    if (this._usesUnifiedPlan) {\r\n        this.tpcUtils.setVideoTransferActive(active);\r\n\r\n        // false means no renegotiation up the chain which is not needed in the Unified mode\r\n        return false;\r\n    }\r\n\r\n    return changed;\r\n};\r\n\r\n/**\r\n * Sends DTMF tones if possible.\r\n *\r\n * @param {string} tones - The DTMF tones string as defined by {@code RTCDTMFSender.insertDTMF}, 'tones' argument.\r\n * @param {number} duration - The amount of time in milliseconds that each DTMF should last. It's 200ms by default.\r\n * @param {number} interToneGap - The length of time in miliseconds to wait between tones. It's 200ms by default.\r\n *\r\n * @returns {void}\r\n */\r\nTraceablePeerConnection.prototype.sendTones = function(tones, duration = 200, interToneGap = 200) {\r\n    if (!this._dtmfSender) {\r\n        if (this.peerconnection.getSenders) {\r\n            const rtpSender = this.peerconnection.getSenders().find(s => s.dtmf);\r\n\r\n            this._dtmfSender = rtpSender && rtpSender.dtmf;\r\n            this._dtmfSender && logger.info(`${this} initialized DTMFSender using getSenders`);\r\n        }\r\n\r\n        if (!this._dtmfSender) {\r\n            const localAudioTrack = Array.from(this.localTracks.values()).find(t => t.isAudioTrack());\r\n\r\n            if (this.peerconnection.createDTMFSender && localAudioTrack) {\r\n                this._dtmfSender = this.peerconnection.createDTMFSender(localAudioTrack.getTrack());\r\n            }\r\n            this._dtmfSender && logger.info(`${this} initialized DTMFSender using deprecated createDTMFSender`);\r\n        }\r\n\r\n        if (this._dtmfSender) {\r\n            this._dtmfSender.ontonechange = this._onToneChange.bind(this);\r\n        }\r\n    }\r\n\r\n    if (this._dtmfSender) {\r\n        if (this._dtmfSender.toneBuffer) {\r\n            this._dtmfTonesQueue.push({\r\n                tones,\r\n                duration,\r\n                interToneGap\r\n            });\r\n\r\n            return;\r\n        }\r\n\r\n        this._dtmfSender.insertDTMF(tones, duration, interToneGap);\r\n    } else {\r\n        logger.warn(`${this} sendTones - failed to select DTMFSender`);\r\n    }\r\n};\r\n\r\n/**\r\n * Callback ivoked by {@code this._dtmfSender} when it has finished playing\r\n * a single tone.\r\n *\r\n * @param {Object} event - The tonechange event which indicates what characters\r\n * are left to be played for the current tone.\r\n * @private\r\n * @returns {void}\r\n */\r\nTraceablePeerConnection.prototype._onToneChange = function(event) {\r\n    // An empty event.tone indicates the current tones have finished playing.\r\n    // Automatically start playing any queued tones on finish.\r\n    if (this._dtmfSender && event.tone === '' && this._dtmfTonesQueue.length) {\r\n        const { tones, duration, interToneGap } = this._dtmfTonesQueue.shift();\r\n\r\n        this._dtmfSender.insertDTMF(tones, duration, interToneGap);\r\n    }\r\n};\r\n\r\n/**\r\n * Makes the underlying TraceablePeerConnection generate new SSRC for\r\n * the recvonly video stream.\r\n */\r\nTraceablePeerConnection.prototype.generateRecvonlySsrc = function() {\r\n    const newSSRC = SDPUtil.generateSsrc();\r\n\r\n    logger.info(`${this} generated new recvonly SSRC=${newSSRC}`);\r\n    this.sdpConsistency.setPrimarySsrc(newSSRC);\r\n};\r\n\r\n/**\r\n * Makes the underlying TraceablePeerConnection forget the current primary video\r\n * SSRC.\r\n */\r\nTraceablePeerConnection.prototype.clearRecvonlySsrc = function() {\r\n    logger.info(`${this} Clearing primary video SSRC!`);\r\n    this.sdpConsistency.clearVideoSsrcCache();\r\n};\r\n\r\n/**\r\n * Closes underlying WebRTC PeerConnection instance and removes all remote\r\n * tracks by emitting {@link RTCEvents.REMOTE_TRACK_REMOVED} for each one of\r\n * them.\r\n */\r\nTraceablePeerConnection.prototype.close = function() {\r\n    this.trace('stop');\r\n\r\n    // Off SignalingEvents\r\n    this.signalingLayer.off(SignalingEvents.PEER_MUTED_CHANGED, this._peerMutedChanged);\r\n    this.signalingLayer.off(SignalingEvents.PEER_VIDEO_TYPE_CHANGED, this._peerVideoTypeChanged);\r\n    this._usesUnifiedPlan && this.peerconnection.removeEventListener('track', this.onTrack);\r\n\r\n    for (const peerTracks of this.remoteTracks.values()) {\r\n        for (const remoteTrack of peerTracks.values()) {\r\n            this._removeRemoteTrack(remoteTrack);\r\n        }\r\n    }\r\n    this.remoteTracks.clear();\r\n\r\n    this._addedStreams = [];\r\n\r\n    this._dtmfSender = null;\r\n    this._dtmfTonesQueue = [];\r\n\r\n    if (!this.rtc._removePeerConnection(this)) {\r\n        logger.error(`${this} RTC._removePeerConnection returned false`);\r\n    }\r\n    if (this.statsinterval !== null) {\r\n        window.clearInterval(this.statsinterval);\r\n        this.statsinterval = null;\r\n    }\r\n    logger.info(`${this} Closing peerconnection`);\r\n    this.peerconnection.close();\r\n};\r\n\r\nTraceablePeerConnection.prototype.createAnswer = function(constraints) {\r\n    return this._createOfferOrAnswer(false /* answer */, constraints);\r\n};\r\n\r\nTraceablePeerConnection.prototype.createOffer = function(constraints) {\r\n    return this._createOfferOrAnswer(true /* offer */, constraints);\r\n};\r\n\r\nTraceablePeerConnection.prototype._createOfferOrAnswer = function(\r\n        isOffer,\r\n        constraints) {\r\n    const logName = isOffer ? 'Offer' : 'Answer';\r\n\r\n    this.trace(`create${logName}`, JSON.stringify(constraints, null, ' '));\r\n\r\n    const handleSuccess = (resultSdp, resolveFn, rejectFn) => {\r\n        try {\r\n            this.trace(\r\n                `create${logName}OnSuccess::preTransform`, dumpSDP(resultSdp));\r\n\r\n            if (!this._usesUnifiedPlan) {\r\n                // If there are no local video tracks, then a \"recvonly\"\r\n                // SSRC needs to be generated\r\n                if (!this.hasAnyTracksOfType(MediaType.VIDEO)\r\n                    && !this.sdpConsistency.hasPrimarySsrcCached()) {\r\n                    this.generateRecvonlySsrc();\r\n                }\r\n\r\n                // eslint-disable-next-line no-param-reassign\r\n                resultSdp = new RTCSessionDescription({\r\n                    type: resultSdp.type,\r\n                    sdp: this.sdpConsistency.makeVideoPrimarySsrcsConsistent(\r\n                        resultSdp.sdp)\r\n                });\r\n\r\n                this.trace(\r\n                    `create${logName}OnSuccess::postTransform `\r\n                         + '(make primary audio/video ssrcs consistent)',\r\n                    dumpSDP(resultSdp));\r\n            }\r\n\r\n            // Configure simulcast for camera tracks always and for desktop tracks only when\r\n            // the \"capScreenshareBitrate\" flag in config.js is disabled.\r\n            if (this.isSimulcastOn() && browser.usesSdpMungingForSimulcast()\r\n                && (!this.options.capScreenshareBitrate\r\n                || (this.options.capScreenshareBitrate && !this._isSharingScreen()))) {\r\n                // eslint-disable-next-line no-param-reassign\r\n                resultSdp = this.simulcast.mungeLocalDescription(resultSdp);\r\n                this.trace(\r\n                    `create${logName}`\r\n                        + 'OnSuccess::postTransform (simulcast)',\r\n                    dumpSDP(resultSdp));\r\n            }\r\n\r\n            if (!this.options.disableRtx && browser.usesSdpMungingForSimulcast()) {\r\n                // eslint-disable-next-line no-param-reassign\r\n                resultSdp = new RTCSessionDescription({\r\n                    type: resultSdp.type,\r\n                    sdp: this.rtxModifier.modifyRtxSsrcs(resultSdp.sdp)\r\n                });\r\n\r\n                this.trace(\r\n                    `create${logName}`\r\n                         + 'OnSuccess::postTransform (rtx modifier)',\r\n                    dumpSDP(resultSdp));\r\n            }\r\n\r\n            const ssrcMap = extractSSRCMap(resultSdp);\r\n\r\n            logger.debug('Got local SSRCs MAP: ', ssrcMap);\r\n            this._processLocalSSRCsMap(ssrcMap);\r\n\r\n            resolveFn(resultSdp);\r\n        } catch (e) {\r\n            this.trace(`create${logName}OnError`, e);\r\n            this.trace(`create${logName}OnError`, dumpSDP(resultSdp));\r\n            logger.error(`${this} create${logName}OnError`, e, dumpSDP(resultSdp));\r\n\r\n            rejectFn(e);\r\n        }\r\n    };\r\n\r\n    const handleFailure = (err, rejectFn) => {\r\n        this.trace(`create${logName}OnFailure`, err);\r\n        const eventType\r\n            = isOffer\r\n                ? RTCEvents.CREATE_OFFER_FAILED\r\n                : RTCEvents.CREATE_ANSWER_FAILED;\r\n\r\n        this.eventEmitter.emit(eventType, err, this);\r\n\r\n        rejectFn(err);\r\n    };\r\n\r\n    // Set the codec preference before creating an offer or answer so that the generated SDP will have\r\n    // the correct preference order.\r\n    if (this._usesTransceiverCodecPreferences) {\r\n        const transceiver = this.peerconnection.getTransceivers()\r\n            .find(t => t.receiver && t.receiver?.track?.kind === MediaType.VIDEO);\r\n\r\n        if (transceiver) {\r\n            let capabilities = RTCRtpReceiver.getCapabilities(MediaType.VIDEO)?.codecs;\r\n            const mimeType = this.codecPreference?.mimeType;\r\n            const enable = this.codecPreference?.enable;\r\n\r\n            if (capabilities && mimeType && enable) {\r\n                // Move the desired codec (all variations of it as well) to the beginning of the list.\r\n                /* eslint-disable-next-line arrow-body-style */\r\n                capabilities.sort(caps => {\r\n                    return caps.mimeType.toLowerCase() === `${MediaType.VIDEO}/${mimeType}` ? -1 : 1;\r\n                });\r\n            } else if (capabilities && mimeType) {\r\n                capabilities = capabilities\r\n                    .filter(caps => caps.mimeType.toLowerCase() !== `${MediaType.VIDEO}/${mimeType}`);\r\n            }\r\n\r\n            try {\r\n                transceiver.setCodecPreferences(capabilities);\r\n            } catch (err) {\r\n                logger.warn(`${this} Setting codec[preference=${mimeType},enable=${enable}] failed`, err);\r\n            }\r\n        }\r\n    }\r\n\r\n    return new Promise((resolve, reject) => {\r\n        let oaPromise;\r\n\r\n        if (isOffer) {\r\n            oaPromise = this.peerconnection.createOffer(constraints);\r\n        } else {\r\n            oaPromise = this.peerconnection.createAnswer(constraints);\r\n        }\r\n\r\n        oaPromise\r\n            .then(\r\n                sdp => handleSuccess(sdp, resolve, reject),\r\n                error => handleFailure(error, reject));\r\n    });\r\n};\r\n\r\n/**\r\n * Extract primary SSRC from given {@link TrackSSRCInfo} object.\r\n * @param {TrackSSRCInfo} ssrcObj\r\n * @return {number|null} the primary SSRC or <tt>null</tt>\r\n */\r\nTraceablePeerConnection.prototype._extractPrimarySSRC = function(ssrcObj) {\r\n    if (ssrcObj && ssrcObj.groups && ssrcObj.groups.length) {\r\n        return ssrcObj.groups[0].ssrcs[0];\r\n    } else if (ssrcObj && ssrcObj.ssrcs && ssrcObj.ssrcs.length) {\r\n        return ssrcObj.ssrcs[0];\r\n    }\r\n\r\n    return null;\r\n};\r\n\r\n/**\r\n * Goes over the SSRC map extracted from the latest local description and tries\r\n * to match them with the local tracks (by MSID). Will update the values\r\n * currently stored in the {@link TraceablePeerConnection.localSSRCs} map.\r\n * @param {Map<string,TrackSSRCInfo>} ssrcMap\r\n * @private\r\n */\r\nTraceablePeerConnection.prototype._processLocalSSRCsMap = function(ssrcMap) {\r\n    for (const track of this.localTracks.values()) {\r\n        const trackMSID = track.storedMSID;\r\n\r\n        if (ssrcMap.has(trackMSID)) {\r\n            const newSSRC = ssrcMap.get(trackMSID);\r\n\r\n            if (!newSSRC) {\r\n                logger.error(`${this} No SSRC found for stream=${trackMSID}`);\r\n\r\n                return;\r\n            }\r\n            const oldSSRC = this.localSSRCs.get(track.rtcId);\r\n            const newSSRCNum = this._extractPrimarySSRC(newSSRC);\r\n            const oldSSRCNum = this._extractPrimarySSRC(oldSSRC);\r\n\r\n            // eslint-disable-next-line no-negated-condition\r\n            if (newSSRCNum !== oldSSRCNum) {\r\n                oldSSRCNum && logger.error(`${this} Overwriting SSRC for [track=${track},id=${trackMSID}]`\r\n                    + ` with ssrc=${newSSRC}`);\r\n                this.localSSRCs.set(track.rtcId, newSSRC);\r\n                this.eventEmitter.emit(RTCEvents.LOCAL_TRACK_SSRC_UPDATED, track, newSSRCNum);\r\n            }\r\n        } else if (!track.isVideoTrack() && !track.isMuted()) {\r\n            // It is normal to find no SSRCs for a muted video track in\r\n            // the local SDP as the recv-only SSRC is no longer munged in.\r\n            // So log the warning only if it's not a muted video track.\r\n            logger.warn(`${this} No SSRCs found in the local SDP for track[track=${track},id=${trackMSID}]`);\r\n        }\r\n    }\r\n};\r\n\r\nTraceablePeerConnection.prototype.addIceCandidate = function(candidate) {\r\n    this.trace('addIceCandidate', JSON.stringify({\r\n        candidate: candidate.candidate,\r\n        sdpMid: candidate.sdpMid,\r\n        sdpMLineIndex: candidate.sdpMLineIndex,\r\n        usernameFragment: candidate.usernameFragment\r\n    }, null, ' '));\r\n\r\n    return this.peerconnection.addIceCandidate(candidate);\r\n};\r\n\r\n/**\r\n * Returns the number of simulcast streams that are currently enabled on the peerconnection.\r\n *\r\n * @returns {number} The number of simulcast streams currently enabled or 1 when simulcast is disabled.\r\n */\r\nTraceablePeerConnection.prototype.getActiveSimulcastStreams = function() {\r\n    let activeStreams = 1;\r\n\r\n    if (this.isSimulcastOn() && this.encodingsEnabledState) {\r\n        activeStreams = this.encodingsEnabledState.filter(stream => Boolean(stream))?.length;\r\n    } else if (this.isSimulcastOn()) {\r\n        activeStreams = SIM_LAYER_RIDS.length;\r\n    }\r\n\r\n    return activeStreams;\r\n};\r\n\r\n/**\r\n * Obtains call-related stats from the peer connection.\r\n *\r\n * @returns {Promise<Object>} Promise which resolves with data providing statistics about\r\n * the peerconnection.\r\n */\r\nTraceablePeerConnection.prototype.getStats = function() {\r\n    return this.peerconnection.getStats();\r\n};\r\n\r\n/**\r\n * Generates and stores new SSRC info object for given local track.\r\n * The method should be called only for a video track being added to this TPC\r\n * in the muted state (given that the current browser uses this strategy).\r\n * @param {JitsiLocalTrack} track\r\n * @return {TPCSSRCInfo}\r\n */\r\nTraceablePeerConnection.prototype.generateNewStreamSSRCInfo = function(track) {\r\n    const rtcId = track.rtcId;\r\n    let ssrcInfo = this._getSSRC(rtcId);\r\n\r\n    if (ssrcInfo) {\r\n        logger.error(`${this} Overwriting local SSRCs for track id=${rtcId}`);\r\n    }\r\n\r\n    // Configure simulcast for camera tracks always and for desktop tracks only when\r\n    // the \"capScreenshareBitrate\" flag in config.js is disabled.\r\n    if (this.isSimulcastOn()\r\n        && (!this.options.capScreenshareBitrate\r\n        || (this.options.capScreenshareBitrate && !this._isSharingScreen()))) {\r\n        ssrcInfo = {\r\n            ssrcs: [],\r\n            groups: []\r\n        };\r\n        for (let i = 0; i < SIM_LAYER_RIDS.length; i++) {\r\n            ssrcInfo.ssrcs.push(SDPUtil.generateSsrc());\r\n        }\r\n        ssrcInfo.groups.push({\r\n            ssrcs: ssrcInfo.ssrcs.slice(),\r\n            semantics: 'SIM'\r\n        });\r\n    } else {\r\n        ssrcInfo = {\r\n            ssrcs: [ SDPUtil.generateSsrc() ],\r\n            groups: []\r\n        };\r\n    }\r\n    if (!this.options.disableRtx) {\r\n        // Specifically use a for loop here because we'll\r\n        //  be adding to the list we're iterating over, so we\r\n        //  only want to iterate through the items originally\r\n        //  on the list\r\n        const currNumSsrcs = ssrcInfo.ssrcs.length;\r\n\r\n        for (let i = 0; i < currNumSsrcs; ++i) {\r\n            const primarySsrc = ssrcInfo.ssrcs[i];\r\n            const rtxSsrc = SDPUtil.generateSsrc();\r\n\r\n            ssrcInfo.ssrcs.push(rtxSsrc);\r\n            ssrcInfo.groups.push({\r\n                ssrcs: [ primarySsrc, rtxSsrc ],\r\n                semantics: 'FID'\r\n            });\r\n        }\r\n    }\r\n    ssrcInfo.msid = track.storedMSID;\r\n    this.localSSRCs.set(rtcId, ssrcInfo);\r\n\r\n    return ssrcInfo;\r\n};\r\n\r\n/**\r\n * Creates a text representation of this <tt>TraceablePeerConnection</tt>\r\n * instance.\r\n * @return {string}\r\n */\r\nTraceablePeerConnection.prototype.toString = function() {\r\n    return `TPC[id=${this.id},type=${this.isP2P ? 'P2P' : 'JVB'}]`;\r\n};\r\n","/* global __filename */\r\n\r\nimport { getLogger } from 'jitsi-meet-logger';\r\n\r\nimport MediaDirection from '../../service/RTC/MediaDirection';\r\nimport * as MediaType from '../../service/RTC/MediaType';\r\n\r\nimport { SdpTransformWrap } from './SdpTransformUtil';\r\n\r\nconst logger = getLogger(__filename);\r\n\r\n/**\r\n * Fakes local SDP exposed to {@link JingleSessionPC} through the local\r\n * description getter. Modifies the SDP, so that it will contain muted local\r\n * video tracks description, even though their underlying {MediaStreamTrack}s\r\n * are no longer in the WebRTC peerconnection. That prevents from SSRC updates\r\n * being sent to Jicofo/remote peer and prevents sRD/sLD cycle on the remote\r\n * side.\r\n */\r\nexport default class LocalSdpMunger {\r\n\r\n    /**\r\n     * Creates new <tt>LocalSdpMunger</tt> instance.\r\n     *\r\n     * @param {TraceablePeerConnection} tpc\r\n     * @param {string} localEndpointId - The endpoint id of the local user.\r\n     */\r\n    constructor(tpc, localEndpointId) {\r\n        this.tpc = tpc;\r\n        this.localEndpointId = localEndpointId;\r\n    }\r\n\r\n    /**\r\n     * Makes sure that muted local video tracks associated with the parent\r\n     * {@link TraceablePeerConnection} are described in the local SDP. It's done\r\n     * in order to prevent from sending 'source-remove'/'source-add' Jingle\r\n     * notifications when local video track is muted (<tt>MediaStream</tt> is\r\n     * removed from the peerconnection).\r\n     *\r\n     * NOTE 1 video track is assumed\r\n     *\r\n     * @param {SdpTransformWrap} transformer the transformer instance which will\r\n     * be used to process the SDP.\r\n     * @return {boolean} <tt>true</tt> if there were any modifications to\r\n     * the SDP wrapped by <tt>transformer</tt>.\r\n     * @private\r\n     */\r\n    _addMutedLocalVideoTracksToSDP(transformer) {\r\n        // Go over each video tracks and check if the SDP has to be changed\r\n        const localVideos = this.tpc.getLocalTracks(MediaType.VIDEO);\r\n\r\n        if (!localVideos.length) {\r\n            return false;\r\n        } else if (localVideos.length !== 1) {\r\n            logger.error(\r\n                `${this.tpc} there is more than 1 video track ! `\r\n                    + 'Strange things may happen !', localVideos);\r\n        }\r\n\r\n        const videoMLine = transformer.selectMedia('video');\r\n\r\n        if (!videoMLine) {\r\n            logger.debug(\r\n                `${this.tpc} unable to hack local video track SDP`\r\n                    + '- no \"video\" media');\r\n\r\n            return false;\r\n        }\r\n\r\n        let modified = false;\r\n\r\n        for (const videoTrack of localVideos) {\r\n            const muted = videoTrack.isMuted();\r\n            const mediaStream = videoTrack.getOriginalStream();\r\n\r\n            // During the mute/unmute operation there are periods of time when\r\n            // the track's underlying MediaStream is not added yet to\r\n            // the PeerConnection. The SDP needs to be munged in such case.\r\n            const isInPeerConnection\r\n                = mediaStream && this.tpc.isMediaStreamInPc(mediaStream);\r\n            const shouldFakeSdp = muted || !isInPeerConnection;\r\n\r\n            if (!shouldFakeSdp) {\r\n                continue; // eslint-disable-line no-continue\r\n            }\r\n\r\n            // Inject removed SSRCs\r\n            const requiredSSRCs\r\n                = this.tpc.isSimulcastOn()\r\n                    ? this.tpc.simulcast.ssrcCache\r\n                    : [ this.tpc.sdpConsistency.cachedPrimarySsrc ];\r\n\r\n            if (!requiredSSRCs.length) {\r\n                logger.error(`No SSRCs stored for: ${videoTrack} in ${this.tpc}`);\r\n\r\n                continue; // eslint-disable-line no-continue\r\n            }\r\n\r\n            modified = true;\r\n\r\n            // We need to fake sendrecv.\r\n            // NOTE the SDP produced here goes only to Jicofo and is never set\r\n            // as localDescription. That's why\r\n            // TraceablePeerConnection.mediaTransferActive is ignored here.\r\n            videoMLine.direction = MediaDirection.SENDRECV;\r\n\r\n            // Check if the recvonly has MSID\r\n            const primarySSRC = requiredSSRCs[0];\r\n\r\n            // FIXME The cname could come from the stream, but may turn out to\r\n            // be too complex. It is fine to come up with any value, as long as\r\n            // we only care about the actual SSRC values when deciding whether\r\n            // or not an update should be sent.\r\n            const primaryCname = `injected-${primarySSRC}`;\r\n\r\n            for (const ssrcNum of requiredSSRCs) {\r\n                // Remove old attributes\r\n                videoMLine.removeSSRC(ssrcNum);\r\n\r\n                // Inject\r\n                videoMLine.addSSRCAttribute({\r\n                    id: ssrcNum,\r\n                    attribute: 'cname',\r\n                    value: primaryCname\r\n                });\r\n                videoMLine.addSSRCAttribute({\r\n                    id: ssrcNum,\r\n                    attribute: 'msid',\r\n                    value: videoTrack.storedMSID\r\n                });\r\n            }\r\n            if (requiredSSRCs.length > 1) {\r\n                const group = {\r\n                    ssrcs: requiredSSRCs.join(' '),\r\n                    semantics: 'SIM'\r\n                };\r\n\r\n                if (!videoMLine.findGroup(group.semantics, group.ssrcs)) {\r\n                    // Inject the group\r\n                    videoMLine.addSSRCGroup(group);\r\n                }\r\n            }\r\n\r\n            // Insert RTX\r\n            // FIXME in P2P RTX is used by Chrome regardless of config option\r\n            // status. Because of that 'source-remove'/'source-add'\r\n            // notifications are still sent to remove/add RTX SSRC and FID group\r\n            if (!this.tpc.options.disableRtx) {\r\n                this.tpc.rtxModifier.modifyRtxSsrcs2(videoMLine);\r\n            }\r\n        }\r\n\r\n        return modified;\r\n    }\r\n\r\n    /**\r\n     * Returns a string that can be set as the MSID attribute for a source.\r\n     *\r\n     * @param {string} mediaType - Media type of the source.\r\n     * @param {string} trackId - Id of the MediaStreamTrack associated with the source.\r\n     * @param {string} streamId - Id of the MediaStream associated with the source.\r\n     * @returns {string|null}\r\n     */\r\n    _generateMsidAttribute(mediaType, trackId, streamId = null) {\r\n        if (!(mediaType && trackId)) {\r\n            logger.warn(`Unable to munge local MSID - track id=${trackId} or media type=${mediaType} is missing`);\r\n\r\n            return null;\r\n        }\r\n        const pcId = this.tpc.id;\r\n\r\n        // Handle a case on Firefox when the browser doesn't produce a 'a:ssrc' line with the 'msid' attribute or has\r\n        // '-' for the stream id part of the msid line. Jicofo needs an unique identifier to be associated with a ssrc\r\n        // and uses the msid for that.\r\n        if (streamId === '-' || !streamId) {\r\n            return `${this.localEndpointId}-${mediaType}-${pcId} ${trackId}-${pcId}`;\r\n        }\r\n\r\n        return `${streamId}-${pcId} ${trackId}-${pcId}`;\r\n    }\r\n\r\n    /**\r\n     * Modifies 'cname', 'msid', 'label' and 'mslabel' by appending\r\n     * the id of {@link LocalSdpMunger#tpc} at the end, preceding by a dash\r\n     * sign.\r\n     *\r\n     * @param {MLineWrap} mediaSection - The media part (audio or video) of the\r\n     * session description which will be modified in place.\r\n     * @returns {void}\r\n     * @private\r\n     */\r\n    _transformMediaIdentifiers(mediaSection) {\r\n        const pcId = this.tpc.id;\r\n\r\n        for (const ssrcLine of mediaSection.ssrcs) {\r\n            switch (ssrcLine.attribute) {\r\n            case 'cname':\r\n            case 'label':\r\n            case 'mslabel':\r\n                ssrcLine.value = ssrcLine.value && `${ssrcLine.value}-${pcId}`;\r\n                break;\r\n            case 'msid': {\r\n                if (ssrcLine.value) {\r\n                    const streamAndTrackIDs = ssrcLine.value.split(' ');\r\n\r\n                    if (streamAndTrackIDs.length === 2) {\r\n                        ssrcLine.value\r\n                            = this._generateMsidAttribute(\r\n                                mediaSection.mLine?.type,\r\n                                streamAndTrackIDs[1],\r\n                                streamAndTrackIDs[0]);\r\n                    } else {\r\n                        logger.warn(`Unable to munge local MSID - weird format detected: ${ssrcLine.value}`);\r\n                    }\r\n                }\r\n                break;\r\n            }\r\n            }\r\n        }\r\n\r\n        // If the msid attribute is missing, then remove the ssrc from the transformed description so that a\r\n        // source-remove is signaled to Jicofo. This happens when the direction of the transceiver (or m-line)\r\n        // is set to 'inactive' or 'recvonly' on Firefox, Chrome (unified) and Safari.\r\n        const msid = mediaSection.ssrcs.find(s => s.attribute === 'msid');\r\n\r\n        if (!this.tpc.isP2P\r\n            && (!msid\r\n                || mediaSection.mLine?.direction === MediaDirection.RECVONLY\r\n                || mediaSection.mLine?.direction === MediaDirection.INACTIVE)) {\r\n            mediaSection.ssrcs = undefined;\r\n            mediaSection.ssrcGroups = undefined;\r\n\r\n        // Add the msid attribute if it is missing for p2p sources. Firefox doesn't produce a a=ssrc line\r\n        // with msid attribute.\r\n        } else if (this.tpc.isP2P && mediaSection.mLine?.direction === MediaDirection.SENDRECV) {\r\n            const msidLine = mediaSection.mLine?.msid;\r\n            const trackId = msidLine && msidLine.split(' ')[1];\r\n            const sources = [ ...new Set(mediaSection.mLine?.ssrcs?.map(s => s.id)) ];\r\n\r\n            for (const source of sources) {\r\n                const msidExists = mediaSection.ssrcs\r\n                    .find(ssrc => ssrc.id === source && ssrc.attribute === 'msid');\r\n\r\n                if (!msidExists) {\r\n                    const generatedMsid = this._generateMsidAttribute(mediaSection.mLine?.type, trackId);\r\n\r\n                    mediaSection.ssrcs.push({\r\n                        id: source,\r\n                        attribute: 'msid',\r\n                        value: generatedMsid\r\n                    });\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Maybe modifies local description to fake local video tracks SDP when\r\n     * those are muted.\r\n     *\r\n     * @param {object} desc the WebRTC SDP object instance for the local\r\n     * description.\r\n     * @returns {RTCSessionDescription}\r\n     */\r\n    maybeAddMutedLocalVideoTracksToSDP(desc) {\r\n        if (!desc) {\r\n            throw new Error('No local description passed in.');\r\n        }\r\n\r\n        const transformer = new SdpTransformWrap(desc.sdp);\r\n\r\n        if (this._addMutedLocalVideoTracksToSDP(transformer)) {\r\n            return new RTCSessionDescription({\r\n                type: desc.type,\r\n                sdp: transformer.toRawSDP()\r\n            });\r\n        }\r\n\r\n        return desc;\r\n    }\r\n\r\n    /**\r\n     * This transformation will make sure that stream identifiers are unique\r\n     * across all of the local PeerConnections even if the same stream is used\r\n     * by multiple instances at the same time.\r\n     * Each PeerConnection assigns different SSRCs to the same local\r\n     * MediaStream, but the MSID remains the same as it's used to identify\r\n     * the stream by the WebRTC backend. The transformation will append\r\n     * {@link TraceablePeerConnection#id} at the end of each stream's identifier\r\n     * (\"cname\", \"msid\", \"label\" and \"mslabel\").\r\n     *\r\n     * @param {RTCSessionDescription} sessionDesc - The local session\r\n     * description (this instance remains unchanged).\r\n     * @return {RTCSessionDescription} - Transformed local session description\r\n     * (a modified copy of the one given as the input).\r\n     */\r\n    transformStreamIdentifiers(sessionDesc) {\r\n        // FIXME similar check is probably duplicated in all other transformers\r\n        if (!sessionDesc || !sessionDesc.sdp || !sessionDesc.type) {\r\n            return sessionDesc;\r\n        }\r\n\r\n        const transformer = new SdpTransformWrap(sessionDesc.sdp);\r\n        const audioMLine = transformer.selectMedia('audio');\r\n\r\n        if (audioMLine) {\r\n            this._transformMediaIdentifiers(audioMLine);\r\n        }\r\n\r\n        const videoMLine = transformer.selectMedia('video');\r\n\r\n        if (videoMLine) {\r\n            this._transformMediaIdentifiers(videoMLine);\r\n        }\r\n\r\n        return new RTCSessionDescription({\r\n            type: sessionDesc.type,\r\n            sdp: transformer.toRawSDP()\r\n        });\r\n    }\r\n}\r\n","/* global __filename */\r\n\r\nimport { getLogger } from 'jitsi-meet-logger';\r\n\r\nimport SDPUtil from './SDPUtil';\r\nimport { parseSecondarySSRC, SdpTransformWrap } from './SdpTransformUtil';\r\n\r\nconst logger = getLogger(__filename);\r\n\r\n/**\r\n * Begin helper functions\r\n */\r\n/**\r\n * Updates or inserts the appropriate rtx information for primarySsrc with\r\n *  the given rtxSsrc.  If no rtx ssrc for primarySsrc currently exists, it will\r\n *  add the appropriate ssrc and ssrc group lines.  If primarySsrc already has\r\n *  an rtx ssrc, the appropriate ssrc and group lines will be updated\r\n * @param {MLineWrap} mLine\r\n * @param {object} primarySsrcInfo the info (ssrc, msid & cname) for the\r\n *  primary ssrc\r\n * @param {number} rtxSsrc the rtx ssrc to associate with the primary ssrc\r\n */\r\nfunction updateAssociatedRtxStream(mLine, primarySsrcInfo, rtxSsrc) {\r\n    const primarySsrc = primarySsrcInfo.id;\r\n    const primarySsrcMsid = primarySsrcInfo.msid;\r\n    const primarySsrcCname = primarySsrcInfo.cname;\r\n\r\n    const previousRtxSSRC = mLine.getRtxSSRC(primarySsrc);\r\n\r\n    if (previousRtxSSRC === rtxSsrc) {\r\n        return;\r\n    }\r\n    if (previousRtxSSRC) {\r\n        // Stream already had an rtx ssrc that is different than the one given,\r\n        //  remove all trace of the old one\r\n        mLine.removeSSRC(previousRtxSSRC);\r\n        mLine.removeGroupsWithSSRC(previousRtxSSRC);\r\n    }\r\n    mLine.addSSRCAttribute({\r\n        id: rtxSsrc,\r\n        attribute: 'cname',\r\n        value: primarySsrcCname\r\n    });\r\n    mLine.addSSRCAttribute({\r\n        id: rtxSsrc,\r\n        attribute: 'msid',\r\n        value: primarySsrcMsid\r\n    });\r\n    mLine.addSSRCGroup({\r\n        semantics: 'FID',\r\n        ssrcs: `${primarySsrc} ${rtxSsrc}`\r\n    });\r\n}\r\n\r\n/**\r\n * End helper functions\r\n */\r\n\r\n/**\r\n * Adds any missing RTX streams for video streams\r\n *  and makes sure that they remain consistent\r\n */\r\nexport default class RtxModifier {\r\n    /**\r\n     * Constructor\r\n     */\r\n    constructor() {\r\n        /**\r\n         * Map of video ssrc to corresponding RTX\r\n         *  ssrc\r\n         */\r\n        this.correspondingRtxSsrcs = new Map();\r\n    }\r\n\r\n    /**\r\n     * Clear the cached map of primary video ssrcs to\r\n     *  their corresponding rtx ssrcs so that they will\r\n     *  not be used for the next call to modifyRtxSsrcs\r\n     */\r\n    clearSsrcCache() {\r\n        this.correspondingRtxSsrcs.clear();\r\n    }\r\n\r\n    /**\r\n     * Explicitly set the primary video ssrc -> rtx ssrc\r\n     *  mapping to be used in modifyRtxSsrcs\r\n     * @param {Map} ssrcMapping a mapping of primary video\r\n     *  ssrcs to their corresponding rtx ssrcs\r\n     */\r\n    setSsrcCache(ssrcMapping) {\r\n        logger.debug('Setting ssrc cache to ', ssrcMapping);\r\n        this.correspondingRtxSsrcs = ssrcMapping;\r\n    }\r\n\r\n    /**\r\n     * Adds RTX ssrcs for any video ssrcs that don't\r\n     *  already have them.  If the video ssrc has been\r\n     *  seen before, and already had an RTX ssrc generated,\r\n     *  the same RTX ssrc will be used again.\r\n     * @param {string} sdpStr sdp in raw string format\r\n     */\r\n    modifyRtxSsrcs(sdpStr) {\r\n        const sdpTransformer = new SdpTransformWrap(sdpStr);\r\n        const videoMLine = sdpTransformer.selectMedia('video');\r\n\r\n        if (!videoMLine) {\r\n            logger.debug(`No 'video' media found in the sdp: ${sdpStr}`);\r\n\r\n            return sdpStr;\r\n        }\r\n\r\n        return this.modifyRtxSsrcs2(videoMLine)\r\n            ? sdpTransformer.toRawSDP() : sdpStr;\r\n    }\r\n\r\n    /**\r\n     * Does the same thing as {@link modifyRtxSsrcs}, but takes the\r\n     *  {@link MLineWrap} instance wrapping video media as an argument.\r\n     * @param {MLineWrap} videoMLine\r\n     * @return {boolean} <tt>true</tt> if the SDP wrapped by\r\n     *  {@link SdpTransformWrap} has been modified or <tt>false</tt> otherwise.\r\n     */\r\n    modifyRtxSsrcs2(videoMLine) {\r\n        if (videoMLine.direction === 'recvonly') {\r\n\r\n            return false;\r\n        }\r\n        if (videoMLine.getSSRCCount() < 1) {\r\n\r\n            return false;\r\n        }\r\n        const primaryVideoSsrcs = videoMLine.getPrimaryVideoSSRCs();\r\n\r\n        for (const ssrc of primaryVideoSsrcs) {\r\n            const msid = videoMLine.getSSRCAttrValue(ssrc, 'msid');\r\n            const cname = videoMLine.getSSRCAttrValue(ssrc, 'cname');\r\n            let correspondingRtxSsrc = this.correspondingRtxSsrcs.get(ssrc);\r\n\r\n            if (!correspondingRtxSsrc) {\r\n                // If there's one in the sdp already for it, we'll just set\r\n                //  that as the corresponding one\r\n                const previousAssociatedRtxStream = videoMLine.getRtxSSRC(ssrc);\r\n\r\n                if (previousAssociatedRtxStream) {\r\n                    correspondingRtxSsrc = previousAssociatedRtxStream;\r\n                } else {\r\n                    correspondingRtxSsrc = SDPUtil.generateSsrc();\r\n                }\r\n                this.correspondingRtxSsrcs.set(ssrc, correspondingRtxSsrc);\r\n            }\r\n            updateAssociatedRtxStream(\r\n                videoMLine,\r\n                {\r\n                    id: ssrc,\r\n                    cname,\r\n                    msid\r\n                },\r\n                correspondingRtxSsrc);\r\n        }\r\n\r\n        // FIXME we're not looking into much details whether the SDP has been\r\n        // modified or not once the precondition requirements are met.\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Strip all rtx streams from the given sdp\r\n     * @param {string} sdpStr sdp in raw string format\r\n     * @returns {string} sdp string with all rtx streams stripped\r\n     */\r\n    stripRtx(sdpStr) {\r\n        const sdpTransformer = new SdpTransformWrap(sdpStr);\r\n        const videoMLine = sdpTransformer.selectMedia('video');\r\n\r\n        if (!videoMLine) {\r\n            logger.debug(`No 'video' media found in the sdp: ${sdpStr}`);\r\n\r\n            return sdpStr;\r\n        }\r\n        if (videoMLine.direction === 'recvonly') {\r\n            logger.debug('RtxModifier doing nothing, video m line is recvonly');\r\n\r\n            return sdpStr;\r\n        }\r\n        if (videoMLine.getSSRCCount() < 1) {\r\n            logger.debug('RtxModifier doing nothing, no video ssrcs present');\r\n\r\n            return sdpStr;\r\n        }\r\n        if (!videoMLine.containsAnySSRCGroups()) {\r\n            logger.debug('RtxModifier doing nothing, '\r\n              + 'no video ssrcGroups present');\r\n\r\n            return sdpStr;\r\n        }\r\n        const fidGroups = videoMLine.findGroups('FID');\r\n\r\n        // Remove the fid groups from the mline\r\n\r\n        videoMLine.removeGroupsBySemantics('FID');\r\n\r\n        // Get the rtx ssrcs and remove them from the mline\r\n        for (const fidGroup of fidGroups) {\r\n            const rtxSsrc = parseSecondarySSRC(fidGroup);\r\n\r\n            videoMLine.removeSSRC(rtxSsrc);\r\n        }\r\n\r\n        return sdpTransformer.toRawSDP();\r\n    }\r\n}\r\n","/* global __filename */\r\n\r\nimport { getLogger } from 'jitsi-meet-logger';\r\n\r\nimport {\r\n    parsePrimarySSRC,\r\n    parseSecondarySSRC,\r\n    SdpTransformWrap\r\n} from './SdpTransformUtil';\r\n\r\nconst logger = getLogger(__filename);\r\n\r\n/**\r\n * Handles the work of keeping video ssrcs consistent across multiple\r\n * o/a cycles, making it such that all stream operations can be\r\n * kept local and do not need to be signaled.\r\n * NOTE: This only keeps the 'primary' video ssrc consistent: meaning\r\n * the primary video stream\r\n */\r\nexport default class SdpConsistency {\r\n    /**\r\n     * Constructor\r\n     * @param {string} logPrefix the log prefix appended to every logged\r\n     * message, currently used to distinguish for which\r\n     * <tt>TraceablePeerConnection</tt> the instance works.\r\n     */\r\n    constructor(logPrefix) {\r\n        this.clearVideoSsrcCache();\r\n        this.logPrefix = logPrefix;\r\n    }\r\n\r\n    /**\r\n     * Clear the cached video primary and primary rtx ssrcs so that\r\n     *  they will not be used for the next call to\r\n     *  makeVideoPrimarySsrcsConsistent\r\n     */\r\n    clearVideoSsrcCache() {\r\n        this.cachedPrimarySsrc = null;\r\n        this.injectRecvOnly = false;\r\n    }\r\n\r\n    /**\r\n     * Explicitly set the primary ssrc to be used in\r\n     *  makeVideoPrimarySsrcsConsistent\r\n     * @param {number} primarySsrc the primarySsrc to be used\r\n     *  in future calls to makeVideoPrimarySsrcsConsistent\r\n     * @throws Error if <tt>primarySsrc</tt> is not a number\r\n     */\r\n    setPrimarySsrc(primarySsrc) {\r\n        if (typeof primarySsrc !== 'number') {\r\n            throw new Error('Primary SSRC must be a number!');\r\n        }\r\n        this.cachedPrimarySsrc = primarySsrc;\r\n    }\r\n\r\n    /**\r\n     * Checks whether or not there is a primary video SSRC cached already.\r\n     * @return {boolean}\r\n     */\r\n    hasPrimarySsrcCached() {\r\n        return Boolean(this.cachedPrimarySsrc);\r\n    }\r\n\r\n    /**\r\n     * Given an sdp string, either:\r\n     *  1) record the primary video and primary rtx ssrcs to be\r\n     *   used in future calls to makeVideoPrimarySsrcsConsistent or\r\n     *  2) change the primary and primary rtx ssrcs in the given sdp\r\n     *   to match the ones previously cached\r\n     * @param {string} sdpStr the sdp string to (potentially)\r\n     *  change to make the video ssrcs consistent\r\n     * @returns {string} a (potentially) modified sdp string\r\n     *  with ssrcs consistent with this class' cache\r\n     */\r\n    makeVideoPrimarySsrcsConsistent(sdpStr) {\r\n        const sdpTransformer = new SdpTransformWrap(sdpStr);\r\n        const videoMLine = sdpTransformer.selectMedia('video');\r\n\r\n        if (!videoMLine) {\r\n            logger.debug(`${this.logPrefix} no 'video' media found in the sdp: ${sdpStr}`);\r\n\r\n            return sdpStr;\r\n        }\r\n\r\n        if (videoMLine.direction === 'recvonly') {\r\n            // If the mline is recvonly, we'll add the primary\r\n            //  ssrc as a recvonly ssrc\r\n            if (this.cachedPrimarySsrc && this.injectRecvOnly) {\r\n                videoMLine.addSSRCAttribute({\r\n                    id: this.cachedPrimarySsrc,\r\n                    attribute: 'cname',\r\n                    value: `recvonly-${this.cachedPrimarySsrc}`\r\n                });\r\n            } else {\r\n                logger.info(`${this.logPrefix} no SSRC found for the recvonly video stream!`);\r\n            }\r\n        } else {\r\n            const newPrimarySsrc = videoMLine.getPrimaryVideoSsrc();\r\n\r\n            if (!newPrimarySsrc) {\r\n                logger.info(`${this.logPrefix} sdp-consistency couldn't parse new primary ssrc`);\r\n\r\n                return sdpStr;\r\n            }\r\n            if (this.cachedPrimarySsrc) {\r\n                videoMLine.replaceSSRC(newPrimarySsrc, this.cachedPrimarySsrc);\r\n                for (const group of videoMLine.ssrcGroups) {\r\n                    if (group.semantics === 'FID') {\r\n                        const primarySsrc = parsePrimarySSRC(group);\r\n                        const rtxSsrc = parseSecondarySSRC(group);\r\n\r\n                        // eslint-disable-next-line max-depth\r\n                        if (primarySsrc === newPrimarySsrc) {\r\n                            group.ssrcs\r\n                                = `${this.cachedPrimarySsrc} ${rtxSsrc}`;\r\n                        }\r\n                    }\r\n                }\r\n            } else {\r\n                this.cachedPrimarySsrc = newPrimarySsrc;\r\n            }\r\n            this.injectRecvOnly = true;\r\n        }\r\n\r\n        return sdpTransformer.toRawSDP();\r\n    }\r\n}\r\n","import * as JitsiTrackEvents from '../../JitsiTrackEvents';\r\nimport { createTtfmEvent } from '../../service/statistics/AnalyticsEvents';\r\nimport Statistics from '../statistics/statistics';\r\n\r\nimport JitsiTrack from './JitsiTrack';\r\n\r\nconst logger = require('jitsi-meet-logger').getLogger(__filename);\r\n\r\nconst RTCEvents = require('../../service/RTC/RTCEvents');\r\n\r\nlet ttfmTrackerAudioAttached = false;\r\nlet ttfmTrackerVideoAttached = false;\r\n\r\n/**\r\n * List of container events that we are going to process. _onContainerEventHandler will be added as listener to the\r\n * container for every event in the list.\r\n */\r\nconst containerEvents = [\r\n    'abort', 'canplay', 'canplaythrough', 'emptied', 'ended', 'error', 'loadeddata', 'loadedmetadata', 'loadstart',\r\n    'pause', 'play', 'playing', 'ratechange', 'stalled', 'suspend', 'waiting'\r\n];\r\n\r\n/* eslint-disable max-params */\r\n\r\n/**\r\n * Represents a single media track (either audio or video).\r\n */\r\nexport default class JitsiRemoteTrack extends JitsiTrack {\r\n    /**\r\n     * Creates new JitsiRemoteTrack instance.\r\n     * @param {RTC} rtc the RTC service instance.\r\n     * @param {JitsiConference} conference the conference to which this track\r\n     *        belongs to\r\n     * @param {string} ownerEndpointId the endpoint ID of the track owner\r\n     * @param {MediaStream} stream WebRTC MediaStream, parent of the track\r\n     * @param {MediaStreamTrack} track underlying WebRTC MediaStreamTrack for\r\n     *        the new JitsiRemoteTrack\r\n     * @param {MediaType} mediaType the type of the media\r\n     * @param {VideoType} videoType the type of the video if applicable\r\n     * @param {number} ssrcs the SSRC numbers of the Media Stream\r\n     * @param {boolean} muted the initial muted state\r\n     * @param {boolean} isP2P indicates whether or not this track belongs to a\r\n     * P2P session\r\n     * @throws {TypeError} if <tt>ssrc</tt> is not a number.\r\n     * @constructor\r\n     */\r\n    constructor(\r\n            rtc,\r\n            conference,\r\n            ownerEndpointId,\r\n            stream,\r\n            track,\r\n            mediaType,\r\n            videoType,\r\n            ssrcs,\r\n            muted,\r\n            isP2P) {\r\n        super(\r\n            conference,\r\n            stream,\r\n            track,\r\n            () => {\r\n                // Nothing to do if the track is inactive.\r\n            },\r\n            mediaType,\r\n            videoType);\r\n        this.rtc = rtc;\r\n\r\n        // Prevent from mixing up type of SSRC which should be a number\r\n        if (ssrcs.length === 0){\r\n            throw new TypeError(`No SSRCs`);\r\n        }\r\n        ssrcs.forEach((ssrc) => {\r\n            if  (typeof ssrc !== 'number') {\r\n                throw new TypeError(`SSRC ${ssrc} is not a number`);\r\n            }\r\n        })\r\n        this.ssrcs = ssrcs;\r\n        this.ownerEndpointId = ownerEndpointId;\r\n        this.muted = muted;\r\n        this.isP2P = isP2P;\r\n\r\n        logger.debug(`New remote track added: ${this}`);\r\n\r\n        // we want to mark whether the track has been ever muted\r\n        // to detect ttfm events for startmuted conferences, as it can\r\n        // significantly increase ttfm values\r\n        this.hasBeenMuted = muted;\r\n\r\n        // Bind 'onmute' and 'onunmute' event handlers\r\n        if (this.rtc && this.track) {\r\n            this._bindTrackHandlers();\r\n        }\r\n        this._containerHandlers = {};\r\n        containerEvents.forEach(event => {\r\n            this._containerHandlers[event] = this._containerEventHandler.bind(this, event);\r\n        });\r\n    }\r\n\r\n    /* eslint-enable max-params */\r\n    /**\r\n     * Attaches the track handlers.\r\n     *\r\n     * @returns {void}\r\n     */\r\n    _bindTrackHandlers() {\r\n        this.track.addEventListener('mute', () => this._onTrackMute());\r\n        this.track.addEventListener('unmute', () => this._onTrackUnmute());\r\n        this.track.addEventListener('ended', () => {\r\n            logger.debug(`\"onended\" event(${Date.now()}): ${this}`);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Callback invoked when the track is muted. Emits an event notifying\r\n     * listeners of the mute event.\r\n     *\r\n     * @private\r\n     * @returns {void}\r\n     */\r\n    _onTrackMute() {\r\n        logger.debug(`\"onmute\" event(${Date.now()}): ${this}`);\r\n\r\n        this.rtc.eventEmitter.emit(RTCEvents.REMOTE_TRACK_MUTE, this);\r\n    }\r\n\r\n    /**\r\n     * Callback invoked when the track is unmuted. Emits an event notifying\r\n     * listeners of the mute event.\r\n     *\r\n     * @private\r\n     * @returns {void}\r\n     */\r\n    _onTrackUnmute() {\r\n        logger.debug(`\"onunmute\" event(${Date.now()}): ${this}`);\r\n\r\n        this.rtc.eventEmitter.emit(RTCEvents.REMOTE_TRACK_UNMUTE, this);\r\n    }\r\n\r\n    /**\r\n     * Sets current muted status and fires an events for the change.\r\n     * @param value the muted status.\r\n     */\r\n    setMute(value) {\r\n        if (this.muted === value) {\r\n            return;\r\n        }\r\n\r\n        if (value) {\r\n            this.hasBeenMuted = true;\r\n        }\r\n\r\n        // we can have a fake video stream\r\n        if (this.stream) {\r\n            this.stream.muted = value;\r\n        }\r\n\r\n        this.muted = value;\r\n        this.emit(JitsiTrackEvents.TRACK_MUTE_CHANGED, this);\r\n    }\r\n\r\n    /**\r\n     * Returns the current muted status of the track.\r\n     * @returns {boolean|*|JitsiRemoteTrack.muted} <tt>true</tt> if the track is\r\n     * muted and <tt>false</tt> otherwise.\r\n     */\r\n    isMuted() {\r\n        return this.muted;\r\n    }\r\n\r\n    /**\r\n     * Returns the participant id which owns the track.\r\n     *\r\n     * @returns {string} the id of the participants. It corresponds to the\r\n     * Colibri endpoint id/MUC nickname in case of Jitsi-meet.\r\n     */\r\n    getParticipantId() {\r\n        return this.ownerEndpointId;\r\n    }\r\n\r\n    /**\r\n     * Return false;\r\n     */\r\n    isLocal() {\r\n        return false;\r\n    }\r\n\r\n    /**\r\n     * Returns the synchronization source identifier (SSRC) of this remote\r\n     * track.\r\n     *\r\n     * @returns {number} the SSRC of this remote track.\r\n     */\r\n    getSSRC() {\r\n        return this.ssrcs[0];\r\n    }\r\n    getSSRCs() {\r\n        return this.ssrcs;\r\n    }\r\n\r\n    /**\r\n     * Changes the video type of the track.\r\n     *\r\n     * @param {string} type - The new video type(\"camera\", \"desktop\").\r\n     */\r\n    _setVideoType(type) {\r\n        if (this.videoType === type) {\r\n            return;\r\n        }\r\n        this.videoType = type;\r\n        this.emit(JitsiTrackEvents.TRACK_VIDEOTYPE_CHANGED, type);\r\n    }\r\n\r\n    /**\r\n     * Handles track play events.\r\n     */\r\n    _playCallback() {\r\n        const type = this.isVideoTrack() ? 'video' : 'audio';\r\n\r\n        const now = window.performance.now();\r\n\r\n        console.log(`(TIME) Render ${type}:\\t`, now);\r\n        this.conference.getConnectionTimes()[`${type}.render`] = now;\r\n\r\n        // The conference can be started without calling GUM\r\n        // FIXME if there would be a module for connection times this kind\r\n        // of logic (gumDuration or ttfm) should end up there\r\n        const gumStart = window.connectionTimes['obtainPermissions.start'];\r\n        const gumEnd = window.connectionTimes['obtainPermissions.end'];\r\n        const gumDuration\r\n            = !isNaN(gumEnd) && !isNaN(gumStart) ? gumEnd - gumStart : 0;\r\n\r\n        // Subtract the muc.joined-to-session-initiate duration because jicofo\r\n        // waits until there are 2 participants to start Jingle sessions.\r\n        const ttfm = now\r\n            - (this.conference.getConnectionTimes()['session.initiate']\r\n                - this.conference.getConnectionTimes()['muc.joined'])\r\n            - gumDuration;\r\n\r\n        this.conference.getConnectionTimes()[`${type}.ttfm`] = ttfm;\r\n        console.log(`(TIME) TTFM ${type}:\\t`, ttfm);\r\n\r\n        Statistics.sendAnalytics(createTtfmEvent(\r\n            {\r\n                'media_type': type,\r\n                muted: this.hasBeenMuted,\r\n                value: ttfm\r\n            }));\r\n\r\n    }\r\n\r\n    /**\r\n     * Attach time to first media tracker only if there is conference and only\r\n     * for the first element.\r\n     * @param container the HTML container which can be 'video' or 'audio'\r\n     * element.\r\n     * @private\r\n     */\r\n    _attachTTFMTracker(container) {\r\n        if ((ttfmTrackerAudioAttached && this.isAudioTrack())\r\n            || (ttfmTrackerVideoAttached && this.isVideoTrack())) {\r\n            return;\r\n        }\r\n\r\n        if (this.isAudioTrack()) {\r\n            ttfmTrackerAudioAttached = true;\r\n        }\r\n        if (this.isVideoTrack()) {\r\n            ttfmTrackerVideoAttached = true;\r\n        }\r\n\r\n        container.addEventListener('canplay', this._playCallback.bind(this));\r\n    }\r\n\r\n    /**\r\n     * Called when the track has been attached to a new container.\r\n     *\r\n     * @param {HTMLElement} container the HTML container which can be 'video' or\r\n     * 'audio' element.\r\n     * @private\r\n     */\r\n    _onTrackAttach(container) {\r\n        logger.debug(`Track has been attached to a container: ${this}`);\r\n\r\n        containerEvents.forEach(event => {\r\n            container.addEventListener(event, this._containerHandlers[event]);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Called when the track has been detached from a container.\r\n     *\r\n     * @param {HTMLElement} container the HTML container which can be 'video' or\r\n     * 'audio' element.\r\n     * @private\r\n     */\r\n    _onTrackDetach(container) {\r\n        logger.debug(`Track has been detached from a container: ${this}`);\r\n\r\n        containerEvents.forEach(event => {\r\n            container.removeEventListener(event, this._containerHandlers[event]);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * An event handler for events triggered by the attached container.\r\n     *\r\n     * @param {string} type - The type of the event.\r\n     */\r\n    _containerEventHandler(type) {\r\n        logger.debug(`${type} handler was called for a container with attached ${this}`);\r\n    }\r\n\r\n    /**\r\n     * Returns a string with a description of the current status of the track.\r\n     *\r\n     * @returns {string}\r\n     */\r\n    _getStatus() {\r\n        const { enabled, muted, readyState } = this.track;\r\n\r\n        return `readyState: ${readyState}, muted: ${muted}, enabled: ${enabled}`;\r\n    }\r\n\r\n    /**\r\n     * Creates a text representation of this remote track instance.\r\n     * @return {string}\r\n     */\r\n    toString() {\r\n        return `RemoteTrack[userID: ${this.getParticipantId()}, type: ${this.getType()}, ssrc: ${\r\n            this.getSSRC()}, p2p: ${this.isP2P}, status: ${this._getStatus()}]`;\r\n    }\r\n}\r\n","import { getLogger } from 'jitsi-meet-logger';\r\n\r\nimport * as ConferenceEvents from '../../JitsiConferenceEvents';\r\nimport CodecMimeType from '../../service/RTC/CodecMimeType';\r\nimport * as RTCEvents from '../../service/RTC/RTCEvents';\r\nimport * as ConnectionQualityEvents from '../../service/connectivity/ConnectionQualityEvents';\r\nimport browser from '../browser';\r\n\r\nconst Resolutions = require('../../service/RTC/Resolutions');\r\nconst VideoType = require('../../service/RTC/VideoType');\r\nconst XMPPEvents = require('../../service/xmpp/XMPPEvents');\r\n\r\nconst logger = getLogger(__filename);\r\n\r\n/**\r\n * The value to use for the \"type\" field for messages sent by ConnectionQuality\r\n * over the data channel.\r\n */\r\nconst STATS_MESSAGE_TYPE = 'stats';\r\n\r\nconst kSimulcastFormats = [\r\n    { width: 1920,\r\n        height: 1080,\r\n        layers: 3,\r\n        target: 'high',\r\n        targetRN: 4000000 },\r\n    { width: 1280,\r\n        height: 720,\r\n        layers: 3,\r\n        target: 'high',\r\n        targetRN: 2500000 },\r\n    { width: 960,\r\n        height: 540,\r\n        layers: 3,\r\n        target: 'standard',\r\n        targetRN: 900000 },\r\n    { width: 640,\r\n        height: 360,\r\n        layers: 2,\r\n        target: 'standard',\r\n        targetRN: 500000 },\r\n    { width: 480,\r\n        height: 270,\r\n        layers: 2,\r\n        target: 'low',\r\n        targetRN: 350000 },\r\n    { width: 320,\r\n        height: 180,\r\n        layers: 1,\r\n        target: 'low',\r\n        targetRN: 150000 }\r\n];\r\n\r\n/**\r\n * The maximum bitrate to use as a measurement against the participant's current\r\n * bitrate. This cap helps in the cases where the participant's bitrate is high\r\n * but not enough to fulfill high targets, such as with 1080p.\r\n */\r\nconst MAX_TARGET_BITRATE = 2500;\r\n\r\n/**\r\n * The initial bitrate for video in kbps.\r\n */\r\nlet startBitrate = 800;\r\n\r\n/**\r\n * Gets the expected bitrate (in kbps) in perfect network conditions.\r\n * @param simulcast {boolean} whether simulcast is enabled or not.\r\n * @param resolution {Resolution} the resolution.\r\n * @param millisSinceStart {number} the number of milliseconds since sending video started.\r\n * @param videoQualitySettings {Object} the bitrate and codec settings for the local video source.\r\n */\r\nfunction getTarget(simulcast, resolution, millisSinceStart, videoQualitySettings) {\r\n    // Completely ignore the bitrate in the first 5 seconds, as the first\r\n    // event seems to fire very early and the value is suspicious and causes\r\n    // false positives.\r\n    if (millisSinceStart < 15000) {\r\n        return 1;\r\n    }\r\n\r\n    let target = 0;\r\n    let height = Math.min(resolution.height, resolution.width);\r\n\r\n    // Find the first format with height no bigger than ours.\r\n    let simulcastFormat = kSimulcastFormats.find(f => f.height <= height);\r\n\r\n    if (simulcastFormat && simulcast && videoQualitySettings.codec === CodecMimeType.VP8) {\r\n        // Sum the target fields from all simulcast layers for the given\r\n        // resolution (e.g. 720p + 360p + 180p) for VP8 simulcast.\r\n        for (height = simulcastFormat.height; height >= 180; height /= 2) {\r\n            const targetHeight = height;\r\n\r\n            simulcastFormat = kSimulcastFormats.find(f => f.height === targetHeight);\r\n            if (simulcastFormat) {\r\n                target += browser.isReactNative()\r\n                    ? simulcastFormat.targetRN\r\n                    : videoQualitySettings[simulcastFormat.target];\r\n            } else {\r\n                break;\r\n            }\r\n        }\r\n    } else if (simulcastFormat) {\r\n        // For VP9 SVC, H.264 (simulcast automatically disabled) and p2p, target bitrate will be\r\n        // same as that of the individual stream bitrate.\r\n        target = browser.isReactNative()\r\n            ? simulcastFormat.targetRN\r\n            : videoQualitySettings[simulcastFormat.target];\r\n    }\r\n\r\n    // Allow for an additional 1 second for ramp up -- delay any initial drop\r\n    // of connection quality by 1 second. Convert target from bps to kbps.\r\n    return Math.min(target / 1000, rampUp(Math.max(0, millisSinceStart - 1000)));\r\n}\r\n\r\n/**\r\n * Gets the bitrate to which GCC would have ramped up in perfect network\r\n * conditions after millisSinceStart milliseconds.\r\n * @param millisSinceStart {number} the number of milliseconds since sending\r\n * video was enabled.\r\n */\r\nfunction rampUp(millisSinceStart) {\r\n    if (millisSinceStart > 60000) {\r\n        return Number.MAX_SAFE_INTEGER;\r\n    }\r\n\r\n    // According to GCC the send side bandwidth estimation grows with at most\r\n    // 8% per second.\r\n    // https://tools.ietf.org/html/draft-ietf-rmcat-gcc-02#section-5.5\r\n    return startBitrate * Math.pow(1.08, millisSinceStart / 1000);\r\n}\r\n\r\n/**\r\n * A class which monitors the local statistics coming from the RTC modules, and\r\n * calculates a \"connection quality\" value, in percent, for the media\r\n * connection. A value of 100% indicates a very good network connection, and a\r\n * value of 0% indicates a poor connection.\r\n */\r\nexport default class ConnectionQuality {\r\n    /**\r\n     *\r\n     * @param conference\r\n     * @param eventEmitter\r\n     * @param options\r\n     */\r\n    constructor(conference, eventEmitter, options) {\r\n        this.eventEmitter = eventEmitter;\r\n\r\n        /**\r\n         * The owning JitsiConference.\r\n         */\r\n        this._conference = conference;\r\n\r\n        /**\r\n         * Holds statistics about the local connection quality.\r\n         */\r\n        this._localStats = {\r\n            connectionQuality: 100,\r\n            jvbRTT: undefined\r\n        };\r\n\r\n        /**\r\n         * The time this._localStats.connectionQuality was last updated.\r\n         */\r\n        this._lastConnectionQualityUpdate = -1;\r\n\r\n        /**\r\n         * Maps a participant ID to an object holding connection quality\r\n         * statistics received from this participant.\r\n         */\r\n        this._remoteStats = {};\r\n\r\n        /**\r\n         * The time that the ICE state last changed to CONNECTED. We use this\r\n         * to calculate how much time we as a sender have had to ramp-up.\r\n         */\r\n        this._timeIceConnected = -1;\r\n\r\n        /**\r\n         * The time that local video was unmuted. We use this to calculate how\r\n         * much time we as a sender have had to ramp-up.\r\n         */\r\n        this._timeVideoUnmuted = -1;\r\n\r\n        // We assume a global startBitrate value for the sake of simplicity.\r\n        if (options.config.startBitrate && options.config.startBitrate > 0) {\r\n            startBitrate = options.config.startBitrate;\r\n        }\r\n\r\n        // TODO: consider ignoring these events and letting the user of\r\n        // lib-jitsi-meet handle these separately.\r\n        conference.on(\r\n            ConferenceEvents.CONNECTION_INTERRUPTED,\r\n            () => {\r\n                this._updateLocalConnectionQuality(0);\r\n                this.eventEmitter.emit(\r\n                    ConnectionQualityEvents.LOCAL_STATS_UPDATED,\r\n                    this._localStats);\r\n                this._broadcastLocalStats();\r\n            });\r\n\r\n        conference.room.addListener(\r\n            XMPPEvents.ICE_CONNECTION_STATE_CHANGED,\r\n            (jingleSession, newState) => {\r\n                if (!jingleSession.isP2P && newState === 'connected') {\r\n                    this._timeIceConnected = window.performance.now();\r\n                }\r\n            });\r\n\r\n        // Listen to DataChannel message from other participants in the\r\n        // conference, and update the _remoteStats field accordingly.\r\n        // TODO - Delete this when all the mobile endpoints switch to using the new Colibri\r\n        // message format for sending the endpoint stats.\r\n        conference.on(\r\n            ConferenceEvents.ENDPOINT_MESSAGE_RECEIVED,\r\n            (participant, payload) => {\r\n                if (payload.type === STATS_MESSAGE_TYPE) {\r\n                    this._updateRemoteStats(\r\n                        participant.getId(), payload.values);\r\n                }\r\n            });\r\n\r\n        conference.on(\r\n            ConferenceEvents.ENDPOINT_STATS_RECEIVED,\r\n            (participant, payload) => {\r\n                this._updateRemoteStats(participant.getId(), payload);\r\n            });\r\n\r\n        // Listen to local statistics events originating from the RTC module and update the _localStats field.\r\n        conference.statistics.addConnectionStatsListener(this._updateLocalStats.bind(this));\r\n\r\n        // Save the last time we were unmuted.\r\n        conference.on(\r\n            ConferenceEvents.TRACK_MUTE_CHANGED,\r\n            track => {\r\n                if (track.isVideoTrack()) {\r\n                    if (track.isMuted()) {\r\n                        this._timeVideoUnmuted = -1;\r\n                    } else {\r\n                        this._maybeUpdateUnmuteTime();\r\n                    }\r\n                }\r\n            });\r\n        conference.on(\r\n            ConferenceEvents.TRACK_ADDED,\r\n            track => {\r\n                if (track.isVideoTrack() && !track.isMuted()) {\r\n                    this._maybeUpdateUnmuteTime();\r\n                }\r\n            });\r\n        conference.rtc.on(\r\n            RTCEvents.LOCAL_TRACK_MAX_ENABLED_RESOLUTION_CHANGED,\r\n            track => {\r\n                this._localStats.maxEnabledResolution = track.maxEnabledResolution;\r\n            });\r\n\r\n        conference.on(\r\n            ConferenceEvents.SERVER_REGION_CHANGED,\r\n            serverRegion => {\r\n                this._localStats.serverRegion = serverRegion;\r\n            });\r\n\r\n        conference.on(\r\n            ConferenceEvents.PROPERTIES_CHANGED,\r\n            properties => {\r\n                this._localStats.bridgeCount\r\n                    = Number((properties || {})['bridge-count']);\r\n            }\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Sets _timeVideoUnmuted if it was previously unset. If it was already set,\r\n     * doesn't change it.\r\n     */\r\n    _maybeUpdateUnmuteTime() {\r\n        if (this._timeVideoUnmuted < 0) {\r\n            this._timeVideoUnmuted = window.performance.now();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Calculates a new \"connection quality\" value.\r\n     * @param videoType {VideoType} the type of the video source (camera or a screen capture).\r\n     * @param isMuted {boolean} whether the local video is muted.\r\n     * @param resolutionName {Resolution} the input resolution used by the camera.\r\n     * @returns {*} the newly calculated connection quality.\r\n     */\r\n    _calculateConnectionQuality(videoType, isMuted, resolutionName) {\r\n\r\n        // resolutionName is an index into Resolutions (where \"720\" is\r\n        // \"1280x720\" and \"960\" is \"960x720\" ...).\r\n        const resolution = Resolutions[resolutionName];\r\n\r\n        let quality = 100;\r\n        let packetLoss;\r\n\r\n        // TODO: take into account packet loss for received streams\r\n\r\n        if (this._localStats.packetLoss) {\r\n            packetLoss = this._localStats.packetLoss.upload;\r\n\r\n            // Ugly Hack Alert (UHA):\r\n            // The packet loss for the upload direction is calculated based on\r\n            // incoming RTCP Receiver Reports. Since we don't have RTCP\r\n            // termination for audio, these reports come from the actual\r\n            // receivers in the conference and therefore the reported packet\r\n            // loss includes loss from the bridge to the receiver.\r\n            // When we are sending video this effect is small, because the\r\n            // number of video packets is much larger than the number of audio\r\n            // packets (and our calculation is based on the total number of\r\n            // received and lost packets).\r\n            // When video is muted, however, the effect might be significant,\r\n            // but we don't know what it is. We do know that it is positive, so\r\n            // as a temporary solution, until RTCP termination is implemented\r\n            // for the audio streams, we relax the packet loss checks here.\r\n            if (isMuted) {\r\n                packetLoss *= 0.5;\r\n            }\r\n        }\r\n\r\n        if (isMuted || !resolution || videoType === VideoType.DESKTOP\r\n            || this._timeIceConnected < 0\r\n            || this._timeVideoUnmuted < 0) {\r\n\r\n            // Calculate a value based on packet loss only.\r\n            if (packetLoss === undefined) {\r\n                logger.error('Cannot calculate connection quality, unknown '\r\n                    + 'packet loss.');\r\n                quality = 100;\r\n            } else if (packetLoss <= 2) {\r\n                quality = 100; // Full 5 bars.\r\n            } else if (packetLoss <= 4) {\r\n                quality = 70; // 4 bars\r\n            } else if (packetLoss <= 6) {\r\n                quality = 50; // 3 bars\r\n            } else if (packetLoss <= 8) {\r\n                quality = 30; // 2 bars\r\n            } else if (packetLoss <= 12) {\r\n                quality = 10; // 1 bars\r\n            } else {\r\n                quality = 0; // Still 1 bar, but slower climb-up.\r\n            }\r\n        } else {\r\n            // Calculate a value based on the send video bitrate on the active TPC.\r\n            const activeTPC = this._conference.getActivePeerConnection();\r\n\r\n            if (activeTPC) {\r\n                const isSimulcastOn = activeTPC.isSimulcastOn();\r\n                const videoQualitySettings = activeTPC.getTargetVideoBitrates();\r\n\r\n                // Add the codec info as well.\r\n                videoQualitySettings.codec = activeTPC.getConfiguredVideoCodec();\r\n\r\n                // Time since sending of video was enabled.\r\n                const millisSinceStart = window.performance.now()\r\n                    - Math.max(this._timeVideoUnmuted, this._timeIceConnected);\r\n\r\n                // Expected sending bitrate in perfect conditions.\r\n                let target = getTarget(isSimulcastOn, resolution, millisSinceStart, videoQualitySettings);\r\n\r\n                target = Math.min(target, MAX_TARGET_BITRATE);\r\n                quality = 100 * this._localStats.bitrate.upload / target;\r\n            }\r\n\r\n            // Whatever the bitrate, drop early if there is significant loss\r\n            if (packetLoss && packetLoss >= 10) {\r\n                quality = Math.min(quality, 30);\r\n            }\r\n        }\r\n\r\n        // Make sure that the quality doesn't climb quickly\r\n        if (this._lastConnectionQualityUpdate > 0) {\r\n            const maxIncreasePerSecond = 2;\r\n            const prevConnectionQuality = this._localStats.connectionQuality;\r\n            const diffSeconds = (window.performance.now() - this._lastConnectionQualityUpdate) / 1000;\r\n\r\n            quality = Math.min(quality, prevConnectionQuality + (diffSeconds * maxIncreasePerSecond));\r\n        }\r\n\r\n        return Math.min(100, quality);\r\n    }\r\n\r\n    /**\r\n     * Updates the localConnectionQuality value\r\n     * @param values {number} the new value. Should be in [0, 100].\r\n     */\r\n    _updateLocalConnectionQuality(value) {\r\n        this._localStats.connectionQuality = value;\r\n        this._lastConnectionQualityUpdate = window.performance.now();\r\n    }\r\n\r\n    /**\r\n     * Broadcasts the local statistics to all other participants in the\r\n     * conference.\r\n     */\r\n    _broadcastLocalStats() {\r\n        // Send only the data that remote participants care about.\r\n        const data = {\r\n            bitrate: this._localStats.bitrate,\r\n            packetLoss: this._localStats.packetLoss,\r\n            connectionQuality: this._localStats.connectionQuality,\r\n            jvbRTT: this._localStats.jvbRTT,\r\n            serverRegion: this._localStats.serverRegion,\r\n            maxEnabledResolution: this._localStats.maxEnabledResolution,\r\n            avgAudioLevels: this._localStats.localAvgAudioLevels\r\n        };\r\n\r\n        try {\r\n            this._conference.sendEndpointStatsMessage(data);\r\n        } catch (err) {\r\n            // Ignore the error as we might hit it in the beginning of the call before the channel is ready.\r\n            // The statistics will be sent again after few seconds and error is logged elseware as well.\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Updates the local statistics\r\n     * @param {TraceablePeerConnection} tpc the peerconnection which emitted\r\n     * the stats\r\n     * @param data new statistics\r\n     */\r\n    _updateLocalStats(tpc, data) {\r\n        // Update jvbRTT\r\n        if (!tpc.isP2P) {\r\n            const jvbRTT\r\n                = data.transport\r\n                    && data.transport.length && data.transport[0].rtt;\r\n\r\n            this._localStats.jvbRTT = jvbRTT ? jvbRTT : undefined;\r\n        }\r\n\r\n        // Do not continue with processing of other stats if they do not\r\n        // originate from the active peerconnection\r\n        if (tpc !== this._conference.getActivePeerConnection()) {\r\n            return;\r\n        }\r\n\r\n        let key;\r\n        const updateLocalConnectionQuality\r\n            = !this._conference.isConnectionInterrupted();\r\n        const localVideoTrack\r\n            = this._conference.getLocalVideoTrack();\r\n        const videoType\r\n            = localVideoTrack ? localVideoTrack.videoType : undefined;\r\n        const isMuted = localVideoTrack ? localVideoTrack.isMuted() : true;\r\n        const resolution = localVideoTrack\r\n            ? Math.min(localVideoTrack.resolution, localVideoTrack.maxEnabledResolution) : null;\r\n\r\n        if (!isMuted) {\r\n            this._maybeUpdateUnmuteTime();\r\n        }\r\n\r\n        // Copy the fields already in 'data'.\r\n        for (key in data) {\r\n            if (data.hasOwnProperty(key)) {\r\n                this._localStats[key] = data[key];\r\n            }\r\n        }\r\n\r\n        // And re-calculate the connectionQuality field.\r\n        if (updateLocalConnectionQuality) {\r\n            this._updateLocalConnectionQuality(\r\n                this._calculateConnectionQuality(\r\n                    videoType,\r\n                    isMuted,\r\n                    resolution));\r\n        }\r\n\r\n        this.eventEmitter.emit(\r\n            ConnectionQualityEvents.LOCAL_STATS_UPDATED,\r\n            this._localStats);\r\n        this._broadcastLocalStats();\r\n    }\r\n\r\n    /**\r\n     * Updates remote statistics\r\n     * @param id the id of the remote participant\r\n     * @param data the statistics received\r\n     */\r\n    _updateRemoteStats(id, data) {\r\n        // Use only the fields we need\r\n        this._remoteStats[id] = {\r\n            bitrate: data.bitrate,\r\n            packetLoss: data.packetLoss,\r\n            connectionQuality: data.connectionQuality,\r\n            jvbRTT: data.jvbRTT,\r\n            serverRegion: data.serverRegion,\r\n            maxEnabledResolution: data.maxEnabledResolution,\r\n            avgAudioLevels: data.avgAudioLevels\r\n        };\r\n\r\n        this.eventEmitter.emit(\r\n            ConnectionQualityEvents.REMOTE_STATS_UPDATED,\r\n            id,\r\n            this._remoteStats[id]);\r\n    }\r\n\r\n    /**\r\n     * Returns the local statistics.\r\n     * Exported only for use in jitsi-meet-torture.\r\n     */\r\n    getStats() {\r\n        return this._localStats;\r\n    }\r\n}\r\n","/* global __filename */\r\nimport { getLogger } from 'jitsi-meet-logger';\r\n\r\nimport * as JitsiConferenceErrors from '../../JitsiConferenceErrors';\r\nimport * as JitsiConferenceEvents from '../../JitsiConferenceEvents';\r\n\r\nconst logger = getLogger(__filename);\r\n\r\n/**\r\n * This class deals with shenanigans around JVB media session's ICE failed status handling.\r\n *\r\n * If ICE restarts are NOT explicitly enabled by the {@code enableIceRestart} config option, then the conference will\r\n * delay emitting the {@JitsiConferenceErrors.ICE_FAILED} event by 15 seconds. If the network info module reports\r\n * the internet offline status then the time will start counting after the internet comes back online.\r\n *\r\n * If ICE restart are enabled, then a delayed ICE failed notification to Jicofo will be sent, only if the ICE connection\r\n * does not recover soon after or before the XMPP connection is restored (if it was ever broken). If ICE fails while\r\n * the XMPP connection is not broken then the notifications will be sent after 2 seconds delay.\r\n */\r\nexport default class IceFailedHandling {\r\n    /**\r\n     * Creates new {@code DelayedIceFailed} task.\r\n     * @param {JitsiConference} conference\r\n     */\r\n    constructor(conference) {\r\n        this._conference = conference;\r\n    }\r\n\r\n    /**\r\n     * After making sure there's no way for the ICE connection to recover this method either sends ICE failed\r\n     * notification to Jicofo or emits the ice failed conference event.\r\n     * @private\r\n     * @returns {void}\r\n     */\r\n    _actOnIceFailed() {\r\n        const { enableForcedReload, enableIceRestart } = this._conference.options.config;\r\n        const explicitlyDisabled = typeof enableIceRestart !== 'undefined' && !enableIceRestart;\r\n        const supportsRestartByTerminate = this._conference.room.supportsRestartByTerminate();\r\n        const useTerminateForRestart = supportsRestartByTerminate && !enableIceRestart;\r\n        const reloadClient = this._conference.restartInProgress && enableForcedReload;\r\n\r\n        logger.info('ICE failed,'\r\n            + ` enableForcedReload: ${enableForcedReload},`\r\n            + ` enableIceRestart: ${enableIceRestart},`\r\n            + ` restartInProgress: ${this._conference.restartInProgress},`\r\n            + ` supports restart by terminate: ${supportsRestartByTerminate}`);\r\n\r\n        if (explicitlyDisabled || (!enableIceRestart && !supportsRestartByTerminate) || reloadClient) {\r\n            logger.info('ICE failed, but ICE restarts are disabled');\r\n            this._conference.eventEmitter.emit(\r\n                JitsiConferenceEvents.CONFERENCE_FAILED,\r\n                JitsiConferenceErrors.ICE_FAILED);\r\n\r\n            return;\r\n        }\r\n\r\n        const jvbConnection = this._conference.jvbJingleSession;\r\n        const jvbConnIceState = jvbConnection && jvbConnection.getIceConnectionState();\r\n\r\n        if (!jvbConnection) {\r\n            logger.warn('Not sending ICE failed - no JVB connection');\r\n        } else if (jvbConnIceState === 'connected') {\r\n            logger.info('ICE connection restored - not sending ICE failed');\r\n        } else {\r\n            logger.info('Sending ICE failed - the connection did not recover, '\r\n                + `ICE state: ${jvbConnIceState}, `\r\n                + `use 'session-terminate': ${useTerminateForRestart}`);\r\n            if (useTerminateForRestart) {\r\n                this._conference.jvbJingleSession.terminate(\r\n                    () => {\r\n                        logger.info('session-terminate for ice restart - done');\r\n                    },\r\n                    error => {\r\n                        logger.error(`session-terminate for ice restart - error: ${error.message}`);\r\n                    }, {\r\n                        reason: 'connectivity-error',\r\n                        reasonDescription: 'ICE FAILED',\r\n                        requestRestart: true,\r\n                        sendSessionTerminate: true\r\n                    });\r\n            } else {\r\n                this._conference.jvbJingleSession.sendIceFailedNotification();\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Starts the task.\r\n     */\r\n    start() {\r\n        //  Using xmpp.ping allows to handle both XMPP being disconnected and internet offline cases. The ping function\r\n        // uses sendIQ2 method which is resilient to XMPP connection disconnected state and will patiently wait until it\r\n        // gets reconnected.\r\n        //  This also handles the case about waiting for the internet to come back online, because ping\r\n        // will only succeed when the internet is online and then there's a chance for the ICE to recover from FAILED to\r\n        // CONNECTED which is the extra 2 second timeout after ping.\r\n        //  The 65 second timeout is given on purpose as there's no chance for XMPP to recover after 65 seconds of no\r\n        // communication with the server. Such resume attempt will result in unrecoverable conference failed event due\r\n        // to 'item-not-found' error returned by the server.\r\n        this._conference.xmpp.ping(65000).then(\r\n            () => {\r\n                if (!this._canceled) {\r\n                    this._iceFailedTimeout = window.setTimeout(() => {\r\n                        this._iceFailedTimeout = undefined;\r\n                        this._actOnIceFailed();\r\n                    }, 2000);\r\n                }\r\n            },\r\n            error => {\r\n                logger.error('PING error/timeout - not sending ICE failed', error);\r\n            });\r\n    }\r\n\r\n    /**\r\n     * Cancels the task.\r\n     */\r\n    cancel() {\r\n        this._canceled = true;\r\n        window.clearTimeout(this._iceFailedTimeout);\r\n    }\r\n}\r\n","import EventEmitter from 'events';\r\n\r\nimport * as JitsiConferenceEvents from '../../JitsiConferenceEvents';\r\nimport * as JitsiTrackEvents from '../../JitsiTrackEvents';\r\nimport browser from '../browser';\r\n\r\nimport * as DetectionEvents from './DetectionEvents';\r\n\r\n// We wait a certain time interval for constant silence input from the current device to account for\r\n// potential abnormalities and for a better use experience i.e. don't generate event the instant\r\n// an audio track is added to the tcr.\r\n// Potential improvement - add this as a configurable parameter.\r\nconst SILENCE_PERIOD_MS = 4000;\r\n\r\n/**\r\n * Detect if there is no audio input on the current TraceAblePeerConnection selected track. The no audio\r\n * state must be constant for a configured amount of time in order for the event to be triggered.\r\n * @fires DetectionEvents.AUDIO_INPUT_STATE_CHANGE\r\n * @fires DetectionEvents.NO_AUDIO_INPUT\r\n */\r\nexport default class NoAudioSignalDetection extends EventEmitter {\r\n    /**\r\n     * Creates new NoAudioSignalDetection.\r\n     *\r\n     * @param conference the JitsiConference instance that created us.\r\n     * @constructor\r\n     */\r\n    constructor(conference) {\r\n        super();\r\n\r\n        this._conference = conference;\r\n        this._timeoutTrigger = null;\r\n        this._hasAudioInput = null;\r\n\r\n        if (!browser.supportsReceiverStats()) {\r\n            conference.statistics.addAudioLevelListener(this._audioLevel.bind(this));\r\n        }\r\n        conference.on(JitsiConferenceEvents.TRACK_ADDED, this._trackAdded.bind(this));\r\n    }\r\n\r\n    /**\r\n     * Clear the timeout state.\r\n     */\r\n    _clearTriggerTimeout() {\r\n        clearTimeout(this._timeoutTrigger);\r\n        this._timeoutTrigger = null;\r\n    }\r\n\r\n\r\n    /**\r\n     * Generated event triggered by a change in the current conference audio input state.\r\n     *\r\n     * @param {*} audioLevel - The audio level of the ssrc.\r\n     * @fires DetectionEvents.AUDIO_INPUT_STATE_CHANGE\r\n     */\r\n    _handleAudioInputStateChange(audioLevel) {\r\n        // Current audio input state of the active local track in the conference, true for audio input false for no\r\n        // audio input.\r\n        const status = audioLevel !== 0;\r\n\r\n        // If this is the first audio event picked up or the current status is different from the previous trigger\r\n        // the event.\r\n        if (this._hasAudioInput === null || this._hasAudioInput !== status) {\r\n            this._hasAudioInput = status;\r\n            this.emit(DetectionEvents.AUDIO_INPUT_STATE_CHANGE, this._hasAudioInput);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Generate event triggered by a prolonged period of no audio input.\r\n     *\r\n     * @param {number} audioLevel - The audio level of the ssrc.\r\n     * @fires DetectionEvents.NO_AUDIO_INPUT\r\n     */\r\n    _handleNoAudioInputDetection(audioLevel) {\r\n        if (this._eventFired) {\r\n            return;\r\n        }\r\n\r\n        if (audioLevel === 0 && !this._timeoutTrigger) {\r\n            this._timeoutTrigger = setTimeout(() => {\r\n                this._eventFired = true;\r\n\r\n                this.emit(DetectionEvents.NO_AUDIO_INPUT);\r\n            }, SILENCE_PERIOD_MS);\r\n        } else if (audioLevel !== 0 && this._timeoutTrigger) {\r\n            this._clearTriggerTimeout();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Receives audio level events for all send and receive streams on the current TraceablePeerConnection.\r\n     *\r\n     * @param {TraceablePeerConnection} tpc - TraceablePeerConnection of the owning conference.\r\n     * @param {number} ssrc - The synchronization source identifier (SSRC) of the endpoint/participant/stream\r\n     * being reported.\r\n     * @param {number} audioLevel - The audio level of the ssrc.\r\n     * @param {boolean} isLocal - true for local/send streams or false for remote/receive streams.\r\n     */\r\n    _audioLevel(tpc, ssrc, audioLevel, isLocal) {\r\n        // We are interested in the local audio streams\r\n        if (!isLocal || !this._audioTrack) {\r\n            return;\r\n        }\r\n\r\n        // Get currently active local tracks from the TraceablePeerConnection\r\n        const localSSRCs = tpc.localSSRCs.get(this._audioTrack.rtcId);\r\n\r\n        // Only target the current active track in the tpc. For some reason audio levels for previous\r\n        // devices are also picked up from the PeerConnection so we filter them out.\r\n        if (!localSSRCs || !localSSRCs.ssrcs.includes(ssrc)) {\r\n            return;\r\n        }\r\n\r\n        // First handle audio input state change. In case the state changed to no input the no audio input event\r\n        // can try to fire again.\r\n        this._handleAudioInputStateChange(audioLevel);\r\n        this._handleNoAudioInputDetection(audioLevel);\r\n    }\r\n\r\n    /**\r\n     * Notifies NoAudioSignalDetection that a JitsiTrack was added to the associated JitsiConference.\r\n     * Only take into account local audio tracks.\r\n     *\r\n     * @param {JitsiTrack} track - The added JitsiTrack.\r\n     */\r\n    _trackAdded(track) {\r\n        if (track.isLocalAudioTrack()) {\r\n            // Reset state for the new track.\r\n            this._audioTrack = track;\r\n            this._eventFired = false;\r\n            this._clearTriggerTimeout();\r\n\r\n            // Listen for the audio levels on the newly added audio track\r\n            if (browser.supportsReceiverStats()) {\r\n                track.on(\r\n                    JitsiTrackEvents.NO_AUDIO_INPUT,\r\n                    audioLevel => {\r\n                        this._handleNoAudioInputDetection(audioLevel);\r\n                    }\r\n                );\r\n                track.on(\r\n                    JitsiTrackEvents.TRACK_AUDIO_LEVEL_CHANGED,\r\n                    audioLevel => {\r\n                        this._handleNoAudioInputDetection(audioLevel);\r\n                        this._handleAudioInputStateChange(audioLevel);\r\n                    }\r\n                );\r\n            }\r\n        }\r\n    }\r\n}\r\n","import * as JitsiConferenceEvents from '../../JitsiConferenceEvents';\r\nimport RTCEvents from '../../service/RTC/RTCEvents';\r\n\r\n/**\r\n * The value which we use to say, every sound over this threshold\r\n * is talking on the mic.\r\n * @type {number}\r\n */\r\nconst SPEECH_DETECT_THRESHOLD = 0.6;\r\n\r\n/**\r\n * The <tt>P2PDominantSpeakerDetection</tt> is activated only when p2p is\r\n * currently used.\r\n * Listens for changes in the audio level changes of the local p2p audio track\r\n * or remote p2p one and fires dominant speaker events to be able to use\r\n * features depending on those events (speaker stats), to make them work without\r\n * the video bridge.\r\n */\r\nexport default class P2PDominantSpeakerDetection {\r\n    /**\r\n     * Creates P2PDominantSpeakerDetection\r\n     * @param conference the JitsiConference instance that created us.\r\n     * @constructor\r\n     */\r\n    constructor(conference) {\r\n        this.conference = conference;\r\n\r\n        conference.addEventListener(\r\n            JitsiConferenceEvents.TRACK_AUDIO_LEVEL_CHANGED,\r\n            this._audioLevel.bind(this));\r\n\r\n        this.myUserID = this.conference.myUserId();\r\n    }\r\n\r\n    /**\r\n     * Receives audio level events for all streams in the conference.\r\n     *\r\n     * @param {String} id - The participant id\r\n     * @param {number} audioLevel - The audio level.\r\n     */\r\n    _audioLevel(id, audioLevel) {\r\n\r\n        // we do not process if p2p is not active\r\n        // or audio level is under certain threshold\r\n        // or if the audio level is for local audio track which is muted\r\n        if (!this.conference.isP2PActive()\r\n            || audioLevel <= SPEECH_DETECT_THRESHOLD\r\n            || (id === this.myUserID\r\n                    && this.conference.getLocalAudioTrack().isMuted())) {\r\n            return;\r\n        }\r\n\r\n        this.conference.rtc.eventEmitter.emit(\r\n            RTCEvents.DOMINANT_SPEAKER_CHANGED,\r\n            id);\r\n    }\r\n}\r\n","import { EventEmitter } from 'events';\r\n\r\nimport { calculateAverage, filterPositiveValues } from '../util/MathUtil';\r\n\r\nimport { VAD_NOISY_DEVICE, DETECTOR_STATE_CHANGE } from './DetectionEvents';\r\n\r\n/**\r\n * The average value VAD needs to be under over a period of time to be considered noise.\r\n * @type {number}\r\n */\r\nconst VAD_NOISE_AVG_THRESHOLD = 0.2;\r\n\r\n/**\r\n * The average values that audio input need to be over to be considered loud.\r\n * @type {number}\r\n */\r\nconst NOISY_AUDIO_LEVEL_THRESHOLD = 0.040;\r\n\r\n/**\r\n * The value that a VAD score needs to be under in order for processing to begin.\r\n * @type {number}\r\n */\r\nconst VAD_SCORE_TRIGGER = 0.2;\r\n\r\n/**\r\n * The value that a VAD score needs to be under in order for processing to begin.\r\n * @type {number}\r\n */\r\nconst AUDIO_LEVEL_SCORE_TRIGGER = 0.020;\r\n\r\n/**\r\n * Time span over which we calculate an average score used to determine if we trigger the event.\r\n * @type {number}\r\n */\r\nconst PROCESS_TIME_FRAME_SPAN_MS = 1500;\r\n\r\n/**\r\n * Detect if provided VAD score and PCM data is considered noise.\r\n */\r\nexport default class VADNoiseDetection extends EventEmitter {\r\n    /**\r\n     * Creates <tt>VADNoiseDetection</tt>\r\n     *\r\n     * @constructor\r\n     */\r\n    constructor() {\r\n        super();\r\n\r\n        /**\r\n         * Flag which denotes the current state of the detection service i.e.if there is already a processing operation\r\n         * ongoing.\r\n         */\r\n        this._processing = false;\r\n\r\n        /**\r\n         * Buffer that keeps the VAD scores for a period of time.\r\n         */\r\n        this._scoreArray = [];\r\n\r\n        /**\r\n         * Buffer that keeps audio level samples for a period of time.\r\n         */\r\n        this._audioLvlArray = [];\r\n\r\n        /**\r\n         * Current state of the service, if it's not active no processing will occur.\r\n         */\r\n        this._active = false;\r\n\r\n        this._calculateNoisyScore = this._calculateNoisyScore.bind(this);\r\n    }\r\n\r\n    /**\r\n     * Compute cumulative VAD score and PCM audio levels once the PROCESS_TIME_FRAME_SPAN_MS timeout has elapsed.\r\n     * If the score is above the set threshold fire the event.\r\n     * @returns {void}\r\n     * @fires VAD_NOISY_DEVICE\r\n     */\r\n    _calculateNoisyScore() {\r\n        const scoreAvg = calculateAverage(this._scoreArray);\r\n        const audioLevelAvg = calculateAverage(this._audioLvlArray);\r\n\r\n        if (scoreAvg < VAD_NOISE_AVG_THRESHOLD && audioLevelAvg > NOISY_AUDIO_LEVEL_THRESHOLD) {\r\n            this.emit(VAD_NOISY_DEVICE);\r\n\r\n            this._setActiveState(false);\r\n        }\r\n\r\n        // We reset the context in case a new process phase needs to be triggered.\r\n        this.reset();\r\n    }\r\n\r\n    /**\r\n     * Record the vad score and average volume in the appropriate buffers.\r\n     *\r\n     * @param {number} vadScore\r\n     * @param {number} avgAudioLvl - average audio level of the PCM sample associated with the VAD score.s\r\n     */\r\n    _recordValues(vadScore, avgAudioLvl) {\r\n        this._scoreArray.push(vadScore);\r\n        this._audioLvlArray.push(avgAudioLvl);\r\n    }\r\n\r\n    /**\r\n     * Set the active state of the detection service and notify any listeners.\r\n     *\r\n     * @param {boolean} active\r\n     * @fires DETECTOR_STATE_CHANGE\r\n     */\r\n    _setActiveState(active) {\r\n        this._active = active;\r\n        this.emit(DETECTOR_STATE_CHANGE, this._active);\r\n    }\r\n\r\n    /**\r\n     * Change the state according to the muted status of the tracked device.\r\n     *\r\n     * @param {boolean} isMuted - Is the device muted or not.\r\n     */\r\n    changeMuteState(isMuted) {\r\n        // This service only needs to run when the microphone is not muted.\r\n        this._setActiveState(!isMuted);\r\n        this.reset();\r\n    }\r\n\r\n    /**\r\n     * Check whether or not the service is active or not.\r\n     *\r\n     * @returns {boolean}\r\n     */\r\n    isActive() {\r\n        return this._active;\r\n    }\r\n\r\n    /**\r\n     * Reset the processing context, clear buffers, cancel the timeout trigger.\r\n     *\r\n     * @returns {void}\r\n     */\r\n    reset() {\r\n        this._processing = false;\r\n        this._scoreArray = [];\r\n        this._audioLvlArray = [];\r\n        clearTimeout(this._processTimeout);\r\n    }\r\n\r\n    /**\r\n     * Listens for {@link TrackVADEmitter} events and processes them.\r\n     *\r\n     * @param {Object} vadScore -VAD score emitted by {@link TrackVADEmitter}\r\n     * @param {Date}   vadScore.timestamp - Exact time at which processed PCM sample was generated.\r\n     * @param {number} vadScore.score - VAD score on a scale from 0 to 1 (i.e. 0.7)\r\n     * @param {Float32Array} vadScore.pcmData - Raw PCM Data associated with the VAD score.\r\n     * @param {string} vadScore.deviceId - Device id of the associated track.\r\n     * @listens VAD_SCORE_PUBLISHED\r\n     */\r\n    processVADScore(vadScore) {\r\n        if (!this._active) {\r\n            return;\r\n        }\r\n\r\n        // There is a processing phase on going, add score to buffer array.\r\n        if (this._processing) {\r\n            // Filter and calculate sample average so we don't have to process one large array at a time.\r\n            const posAudioLevels = filterPositiveValues(vadScore.pcmData);\r\n\r\n            this._recordValues(vadScore.score, calculateAverage(posAudioLevels));\r\n\r\n            return;\r\n        }\r\n\r\n        // If the VAD score for the sample is low and audio level has a high enough level we can start listening for\r\n        // noise\r\n        if (vadScore.score < VAD_SCORE_TRIGGER) {\r\n            const posAudioLevels = filterPositiveValues(vadScore.pcmData);\r\n            const avgAudioLvl = calculateAverage(posAudioLevels);\r\n\r\n            if (avgAudioLvl > AUDIO_LEVEL_SCORE_TRIGGER) {\r\n                this._processing = true;\r\n                this._recordValues(vadScore.score, avgAudioLvl);\r\n\r\n                // Once the preset timeout executes the final score will be calculated.\r\n                this._processTimeout = setTimeout(this._calculateNoisyScore, PROCESS_TIME_FRAME_SPAN_MS);\r\n            }\r\n        }\r\n    }\r\n}\r\n","import { EventEmitter } from 'events';\r\n\r\nimport { calculateAverage } from '../util/MathUtil';\r\n\r\nimport { VAD_TALK_WHILE_MUTED, DETECTOR_STATE_CHANGE } from './DetectionEvents';\r\n\r\n\r\n/**\r\n * The threshold which the average VAD values for a span of time needs to exceed to trigger an event.\r\n * @type {number}\r\n */\r\nconst VAD_AVG_THRESHOLD = 0.6;\r\n\r\n/**\r\n * The VAD score needed to trigger the processing algorithm, i.e. if a sample has the VAD score >= VAD_VOICE_LEVEL\r\n * we start processing all scores for a time span defined by const PROCESS_TIME_FRAME_SPAN_MS.\r\n * @type {number}\r\n */\r\nconst VAD_VOICE_LEVEL = 0.9;\r\n\r\n/**\r\n * Sample rate of TrackVADEmitter, it defines how many audio samples are processed at a time.\r\n * @type {number}\r\n */\r\n\r\n/**\r\n * Time span over which we calculate an average score used to determine if we trigger the event.\r\n * @type {number}\r\n */\r\nconst PROCESS_TIME_FRAME_SPAN_MS = 700;\r\n\r\n/**\r\n * Detect if provided VAD score which is generated on a muted device is voice and fires an event.\r\n */\r\nexport default class VADTalkMutedDetection extends EventEmitter {\r\n    /**\r\n     * Creates <tt>VADTalkMutedDetection</tt>\r\n     * @constructor\r\n     */\r\n    constructor() {\r\n        super();\r\n\r\n        /**\r\n         * Flag which denotes the current state of the detection service i.e.if there is already a processing operation\r\n         * ongoing.\r\n         */\r\n        this._processing = false;\r\n\r\n        /**\r\n         * Buffer that keeps the VAD scores for a period of time.\r\n         */\r\n        this._scoreArray = [];\r\n\r\n        /**\r\n         * Current mute state of the audio track being monitored.\r\n         */\r\n        this._active = false;\r\n\r\n        this._calculateVADScore = this._calculateVADScore.bind(this);\r\n    }\r\n\r\n    /**\r\n     * Compute cumulative VAD score function called once the PROCESS_TIME_FRAME_SPAN_MS timeout has elapsed.\r\n     * @returns {void}\r\n     * @fires VAD_TALK_WHILE_MUTED\r\n     */\r\n    _calculateVADScore() {\r\n        const score = calculateAverage(this._scoreArray);\r\n\r\n        if (score > VAD_AVG_THRESHOLD) {\r\n            this.emit(VAD_TALK_WHILE_MUTED);\r\n\r\n            // Event was fired. Stop event emitter and remove listeners so no residue events kick off after this point\r\n            // and a single VAD_TALK_WHILE_MUTED is generated per mic muted state.\r\n            this._setActiveState(false);\r\n        }\r\n\r\n        // We reset the context in case a new process phase needs to be triggered.\r\n        this.reset();\r\n    }\r\n\r\n    /**\r\n     * Set the active state of the detection service and notify any listeners.\r\n     *\r\n     * @param {boolean} active\r\n     * @fires DETECTOR_STATE_CHANGE\r\n     */\r\n    _setActiveState(active) {\r\n        this._active = active;\r\n        this.emit(DETECTOR_STATE_CHANGE, this._active);\r\n    }\r\n\r\n    /**\r\n     * Change the state according to the muted status of the tracked device.\r\n     *\r\n     * @param {boolean} isMuted - Is the device muted or not.\r\n     */\r\n    changeMuteState(isMuted) {\r\n        // This service only needs to run when the microphone is muted.\r\n        this._setActiveState(isMuted);\r\n        this.reset();\r\n    }\r\n\r\n    /**\r\n     * Check whether or not the service is active or not.\r\n     *\r\n     * @returns {boolean}\r\n     */\r\n    isActive() {\r\n        return this._active;\r\n    }\r\n\r\n    /**\r\n     * Listens for {@link TrackVADEmitter} events and processes them.\r\n     *\r\n     * @param {Object} vadScore -VAD score emitted by {@link TrackVADEmitter}\r\n     * @param {Date}   vadScore.timestamp - Exact time at which processed PCM sample was generated.\r\n     * @param {number} vadScore.score - VAD score on a scale from 0 to 1 (i.e. 0.7)\r\n     * @param {string} vadScore.deviceId - Device id of the associated track.\r\n     * @listens VAD_SCORE_PUBLISHED\r\n     */\r\n    processVADScore(vadScore) {\r\n        if (!this._active) {\r\n            return;\r\n        }\r\n\r\n        // There is a processing phase on going, add score to buffer array.\r\n        if (this._processing) {\r\n            this._scoreArray.push(vadScore.score);\r\n\r\n            return;\r\n        }\r\n\r\n        // Because we remove all listeners on the vadEmitter once the main event is triggered,\r\n        // there is no need to check for rogue events.\r\n        if (vadScore.score > VAD_VOICE_LEVEL) {\r\n            this._processing = true;\r\n            this._scoreArray.push(vadScore.score);\r\n\r\n            // Start gathering VAD scores for the configured period of time.\r\n            this._processTimeout = setTimeout(this._calculateVADScore, PROCESS_TIME_FRAME_SPAN_MS);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Reset the processing context, clear buffer, cancel the timeout trigger.\r\n     *\r\n     * @returns {void}\r\n     */\r\n    reset() {\r\n        this._processing = false;\r\n        this._scoreArray = [];\r\n        clearTimeout(this._processTimeout);\r\n    }\r\n}\r\n","/* global __filename */\r\nimport { getLogger } from 'jitsi-meet-logger';\r\n\r\nimport * as JitsiConferenceEvents from '../../JitsiConferenceEvents';\r\nimport * as E2ePingEvents\r\n    from '../../service/e2eping/E2ePingEvents';\r\nimport { createE2eRttEvent } from '../../service/statistics/AnalyticsEvents';\r\nimport Statistics from '../statistics/statistics';\r\n\r\nconst logger = getLogger(__filename);\r\n\r\n/**\r\n * The 'type' of a message which designates an e2e ping request.\r\n * @type {string}\r\n */\r\nconst E2E_PING_REQUEST = 'e2e-ping-request';\r\n\r\n/**\r\n * The 'type' of a message which designates an e2e ping response.\r\n * @type {string}\r\n */\r\nconst E2E_PING_RESPONSE = 'e2e-ping-response';\r\n\r\n/**\r\n * Saves e2e ping related state for a single JitsiParticipant.\r\n */\r\nclass ParticipantWrapper {\r\n    /**\r\n     * Creates a ParticipantWrapper\r\n     * @param {JitsiParticipant} participant - The remote participant that this\r\n     * object wraps.\r\n     * @param {E2ePing} e2eping\r\n     */\r\n    constructor(participant, e2eping) {\r\n        // The JitsiParticipant\r\n        this.participant = participant;\r\n\r\n        // The E2ePing\r\n        this.e2eping = e2eping;\r\n\r\n        // Caches the ID\r\n        this.id = participant.getId();\r\n\r\n        // Recently sent requests\r\n        this.requests = {};\r\n\r\n        // The ID of the last sent request. We just increment it for each new\r\n        // request. Start at 1 so we can consider only thruthy values valid.\r\n        this.lastRequestId = 1;\r\n\r\n        this.clearIntervals = this.clearIntervals.bind(this);\r\n        this.sendRequest = this.sendRequest.bind(this);\r\n        this.handleResponse = this.handleResponse.bind(this);\r\n        this.maybeSendAnalytics = this.maybeSendAnalytics.bind(this);\r\n        this.sendAnalytics = this.sendAnalytics.bind(this);\r\n\r\n        // If the data channel was already open (this is likely a participant\r\n        // joining an existing conference) send a request immediately.\r\n        if (e2eping.isDataChannelOpen) {\r\n            this.sendRequest();\r\n        }\r\n\r\n        this.pingInterval = window.setInterval(\r\n            this.sendRequest, e2eping.pingIntervalMs);\r\n        this.analyticsInterval = window.setTimeout(\r\n            this.maybeSendAnalytics, this.e2eping.analyticsIntervalMs);\r\n    }\r\n\r\n    /**\r\n     * Clears the interval which sends pings.\r\n     * @type {*}\r\n     */\r\n    clearIntervals() {\r\n        if (this.pingInterval) {\r\n            window.clearInterval(this.pingInterval);\r\n        }\r\n        if (this.analyticsInterval) {\r\n            window.clearInterval(this.analyticsInterval);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Sends the next ping request.\r\n     * @type {*}\r\n     */\r\n    sendRequest() {\r\n        const requestId = this.lastRequestId++;\r\n        const requestMessage = {\r\n            type: E2E_PING_REQUEST,\r\n            id: requestId\r\n        };\r\n\r\n        this.e2eping.sendMessage(requestMessage, this.id);\r\n        this.requests[requestId] = {\r\n            id: requestId,\r\n            timeSent: window.performance.now()\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Handles a response from this participant.\r\n     * @type {*}\r\n     */\r\n    handleResponse(response) {\r\n        const request = this.requests[response.id];\r\n\r\n        if (request) {\r\n            request.rtt = window.performance.now() - request.timeSent;\r\n            this.e2eping.eventEmitter.emit(\r\n                E2ePingEvents.E2E_RTT_CHANGED,\r\n                this.participant,\r\n                request.rtt);\r\n        }\r\n\r\n        this.maybeSendAnalytics();\r\n    }\r\n\r\n    /**\r\n     * Goes over the requests, clearing ones which we don't need anymore, and\r\n     * if it finds at least one request with a valid RTT in the last\r\n     * 'analyticsIntervalMs' then sends an analytics event.\r\n     * @type {*}\r\n     */\r\n    maybeSendAnalytics() {\r\n        const now = window.performance.now();\r\n\r\n        // The RTT we'll report is the minimum RTT measured in the last\r\n        // analyticsInterval\r\n        let rtt = Infinity;\r\n        let request, requestId;\r\n\r\n        // It's time to send analytics. Clean up all requests and find the\r\n        for (requestId in this.requests) {\r\n            if (this.requests.hasOwnProperty(requestId)) {\r\n                request = this.requests[requestId];\r\n\r\n                if (request.timeSent < now - this.e2eping.analyticsIntervalMs) {\r\n                    // An old request. We don't care about it anymore.\r\n                    delete this.requests[requestId];\r\n                } else if (request.rtt) {\r\n                    rtt = Math.min(rtt, request.rtt);\r\n                }\r\n            }\r\n        }\r\n\r\n        if (rtt < Infinity) {\r\n            this.sendAnalytics(rtt);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Sends an analytics event for this participant with the given RTT.\r\n     * @type {*}\r\n     */\r\n    sendAnalytics(rtt) {\r\n        Statistics.sendAnalytics(createE2eRttEvent(\r\n            this.id,\r\n            this.participant.getProperty('region'),\r\n            rtt));\r\n    }\r\n}\r\n\r\n/**\r\n * Implements end-to-end ping (from one conference participant to another) via\r\n * the jitsi-videobridge channel (either WebRTC data channel or web socket).\r\n *\r\n * TODO: use a broadcast message instead of individual pings to each remote\r\n * participant.\r\n *\r\n * This class:\r\n * 1. Sends periodic ping requests to all other participants in the\r\n * conference.\r\n * 2. Responds to ping requests from other participants.\r\n * 3. Fires events with the end-to-end RTT to each participant whenever a\r\n * response is received.\r\n * 4. Fires analytics events with the end-to-end RTT periodically.\r\n */\r\nexport default class E2ePing {\r\n    /**\r\n     * @param {JitsiConference} conference - The conference.\r\n     * @param {Function} sendMessage - The function to use to send a message.\r\n     * @param {Object} options\r\n     */\r\n    constructor(conference, options, sendMessage) {\r\n        this.conference = conference;\r\n        this.eventEmitter = conference.eventEmitter;\r\n        this.sendMessage = sendMessage;\r\n\r\n        // The interval at which pings will be sent (<= 0 disables sending).\r\n        this.pingIntervalMs = 10000;\r\n\r\n        // The interval at which analytics events will be sent.\r\n        this.analyticsIntervalMs = 60000;\r\n\r\n        // Maps a participant ID to its ParticipantWrapper\r\n        this.participants = {};\r\n\r\n        // Whether the WebRTC channel has been opened or not.\r\n        this.isDataChannelOpen = false;\r\n\r\n        if (options && options.e2eping) {\r\n            if (typeof options.e2eping.pingInterval === 'number') {\r\n                this.pingIntervalMs = options.e2eping.pingInterval;\r\n            }\r\n            if (typeof options.e2eping.analyticsInterval === 'number') {\r\n                this.analyticsIntervalMs = options.e2eping.analyticsInterval;\r\n            }\r\n\r\n            // We want to report at most once a ping interval.\r\n            if (this.analyticsIntervalMs > 0 && this.analyticsIntervalMs\r\n                < this.pingIntervalMs) {\r\n                this.analyticsIntervalMs = this.pingIntervalMs;\r\n            }\r\n        }\r\n        logger.info(\r\n            `Initializing e2e ping; pingInterval=${\r\n                this.pingIntervalMs}, analyticsInterval=${\r\n                this.analyticsIntervalMs}.`);\r\n\r\n        this.participantJoined = this.participantJoined.bind(this);\r\n        conference.on(\r\n            JitsiConferenceEvents.USER_JOINED,\r\n            this.participantJoined);\r\n\r\n        this.participantLeft = this.participantLeft.bind(this);\r\n        conference.on(\r\n            JitsiConferenceEvents.USER_LEFT,\r\n            this.participantLeft);\r\n\r\n        this.messageReceived = this.messageReceived.bind(this);\r\n        conference.on(\r\n            JitsiConferenceEvents.ENDPOINT_MESSAGE_RECEIVED,\r\n            this.messageReceived);\r\n\r\n        this.dataChannelOpened = this.dataChannelOpened.bind(this);\r\n        conference.on(\r\n            JitsiConferenceEvents.DATA_CHANNEL_OPENED,\r\n            this.dataChannelOpened);\r\n    }\r\n\r\n    /**\r\n     * Notifies this instance that the communications channel has been opened\r\n     * and it can now send messages via sendMessage.\r\n     */\r\n    dataChannelOpened() {\r\n        this.isDataChannelOpen = true;\r\n\r\n        //\tconsole.log(`dataChannelOpened for `, this.participants)\r\n\r\n        // We don't want to wait the whole interval before sending the first\r\n        // request, but we can't send it immediately after the participant joins\r\n        // either, because our data channel might not have initialized.\r\n        // So once the data channel initializes, send requests to everyone.\r\n        // Wait an additional 200ms to give a chance to the remote side (if it\r\n        // also just connected as is the case for the first 2 participants in a\r\n        // conference) to open its data channel.\r\n        for (const id in this.participants) {\r\n            if (this.participants.hasOwnProperty(id)) {\r\n                const participantWrapper = this.participants[id];\r\n\r\n                window.setTimeout(participantWrapper.sendRequest, 200);\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Handles a message that was received.\r\n     *\r\n     * @param participant - The message sender.\r\n     * @param payload - The payload of the message.\r\n     */\r\n    messageReceived(participant, payload) {\r\n        // Listen to E2E PING requests and responses from other participants\r\n        // in the conference.\r\n        if (payload.type === E2E_PING_REQUEST) {\r\n            this.handleRequest(participant.getId(), payload);\r\n        } else if (payload.type === E2E_PING_RESPONSE) {\r\n            this.handleResponse(participant.getId(), payload);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Handles a participant joining the conference. Starts to send ping\r\n     * requests to the participant.\r\n     *\r\n     * @param {String} id - The ID of the participant.\r\n     * @param {JitsiParticipant} participant - The participant that joined.\r\n     */\r\n    participantJoined(id, participant) {\r\n        if (this.pingIntervalMs <= 0) {\r\n            return;\r\n        }\r\n\r\n        if (this.participants[id]) {\r\n            logger.info(\r\n                `Participant wrapper already exists for ${id}. Clearing.`);\r\n            this.participants[id].clearIntervals();\r\n            delete this.participants[id];\r\n        }\r\n\r\n        this.participants[id] = new ParticipantWrapper(participant, this);\r\n    }\r\n\r\n    /**\r\n     * Handles a participant leaving the conference. Stops sending requests.\r\n     *\r\n     * @param {String} id - The ID of the participant.\r\n     */\r\n    participantLeft(id) {\r\n        if (this.pingIntervalMs <= 0) {\r\n            return;\r\n        }\r\n\r\n        if (this.participants[id]) {\r\n            this.participants[id].clearIntervals();\r\n            delete this.participants[id];\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Handles a ping request coming from another participant.\r\n     *\r\n     * @param {string} participantId - The ID of the participant who sent the\r\n     * request.\r\n     * @param {Object} request - The request.\r\n     */\r\n    handleRequest(participantId, request) {\r\n        // If it's a valid request, just send a response.\r\n        if (request && request.id) {\r\n            const response = {\r\n                type: E2E_PING_RESPONSE,\r\n                id: request.id\r\n            };\r\n\r\n            this.sendMessage(response, participantId);\r\n        } else {\r\n            logger.info(\r\n                `Received an invalid e2e ping request from ${participantId}.`);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Handles a ping response coming from another participant\r\n     * @param {string} participantId - The ID of the participant who sent the\r\n     * response.\r\n     * @param {Object} response - The response.\r\n     */\r\n    handleResponse(participantId, response) {\r\n        const participantWrapper = this.participants[participantId];\r\n\r\n        if (participantWrapper) {\r\n            participantWrapper.handleResponse(response);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Stops this E2ePing (i.e. stop sending requests).\r\n     */\r\n    stop() {\r\n        logger.info('Stopping e2eping');\r\n\r\n        this.conference.off(\r\n            JitsiConferenceEvents.USER_JOINED,\r\n            this.participantJoined);\r\n        this.conference.off(\r\n            JitsiConferenceEvents.USER_LEFT,\r\n            this.participantLeft);\r\n        this.conference.off(\r\n            JitsiConferenceEvents.ENDPOINT_MESSAGE_RECEIVED,\r\n            this.messageReceived);\r\n        this.conference.off(\r\n            JitsiConferenceEvents.DATA_CHANNEL_OPENED,\r\n            this.dataChannelOpened);\r\n\r\n        for (const id in this.participants) {\r\n            if (this.participants.hasOwnProperty(id)) {\r\n                this.participants[id].clearIntervals();\r\n            }\r\n        }\r\n\r\n        this.participants = {};\r\n    }\r\n}\r\n\r\n","/* global __filename */\r\n\r\nimport { getLogger } from 'jitsi-meet-logger';\r\n\r\nimport * as JitsiConferenceEvents from '../../JitsiConferenceEvents';\r\n\r\nconst logger = getLogger(__filename);\r\n\r\n/**\r\n * Emits {@link JitsiConferenceEvents.JVB121_STATUS} events based on the current\r\n * P2P status and the conference participants count. See the event description\r\n * for more info.\r\n */\r\nexport default class Jvb121EventGenerator {\r\n    /**\r\n     * Creates new <tt>Jvb121EventGenerator</tt> for the given conference.\r\n     * @param {JitsiConference} conference\r\n     */\r\n    constructor(conference) {\r\n        this._conference = conference;\r\n\r\n        /**\r\n         * Indicates whether it's a one to one JVB conference (<tt>true</tt>)\r\n         * or a multiparty (<tt>false</tt>). Will be also <tt>false</tt> if\r\n         * the conference is currently in the P2P mode.\r\n         * @type {boolean}\r\n         * @private\r\n         */\r\n        this._jvb121 = true;\r\n\r\n        this._conference.addEventListener(\r\n            JitsiConferenceEvents.USER_JOINED, () => this.evaluateStatus());\r\n        this._conference.addEventListener(\r\n            JitsiConferenceEvents.USER_LEFT, () => this.evaluateStatus());\r\n        this._conference.addEventListener(\r\n            JitsiConferenceEvents.P2P_STATUS, () => this.evaluateStatus());\r\n    }\r\n\r\n    /**\r\n     * Checks whether the JVB121 value should be updated and a new event\r\n     * emitted.\r\n     */\r\n    evaluateStatus() {\r\n        const oldStatus = this._jvb121;\r\n        const newStatus\r\n            = !this._conference.isP2PActive()\r\n                && this._conference.getParticipantCount() <= 2;\r\n\r\n        if (oldStatus !== newStatus) {\r\n            this._jvb121 = newStatus;\r\n            logger.debug(`JVB121 status ${oldStatus} => ${newStatus}`);\r\n            this._conference.eventEmitter.emit(\r\n                JitsiConferenceEvents.JVB121_STATUS, oldStatus, newStatus);\r\n        }\r\n    }\r\n}\r\n","import { getLogger } from 'jitsi-meet-logger';\r\nimport isEqual from 'lodash.isequal';\r\n\r\nimport * as JitsiConferenceEvents from '../../JitsiConferenceEvents';\r\n\r\nconst logger = getLogger(__filename);\r\nconst MAX_HEIGHT_ONSTAGE = 2160;\r\nconst MAX_HEIGHT_THUMBNAIL = 180;\r\nconst LASTN_UNLIMITED = -1;\r\n\r\n/**\r\n * This class translates the legacy signaling format between the client and the bridge (that affects bandwidth\r\n * allocation) to the new format described here https://github.com/jitsi/jitsi-videobridge/blob/master/doc/allocation.md\r\n */\r\nexport class ReceiverVideoConstraints {\r\n    /**\r\n     * Creates a new instance.\r\n     */\r\n    constructor() {\r\n        // Default constraints used for endpoints that are not explicitly included in constraints.\r\n        // These constraints are used for endpoints that are thumbnails in the stage view.\r\n        this._defaultConstraints = { 'maxHeight': MAX_HEIGHT_THUMBNAIL };\r\n\r\n        // The number of videos requested from the bridge.\r\n        this._lastN = LASTN_UNLIMITED;\r\n\r\n        // The number representing the maximum video height the local client should receive from the bridge.\r\n        this._maxFrameHeight = MAX_HEIGHT_ONSTAGE;\r\n\r\n        // The endpoint IDs of the participants that are currently selected.\r\n        this._selectedEndpoints = [];\r\n\r\n        this._receiverVideoConstraints = {\r\n            constraints: {},\r\n            defaultConstraints: this.defaultConstraints,\r\n            lastN: this._lastN,\r\n            onStageEndpoints: [],\r\n            selectedEndpoints: this._selectedEndpoints\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Returns the receiver video constraints that need to be sent on the bridge channel.\r\n     */\r\n    get constraints() {\r\n        this._receiverVideoConstraints.lastN = this._lastN;\r\n\r\n        if (!this._selectedEndpoints.length) {\r\n            return this._receiverVideoConstraints;\r\n        }\r\n\r\n        // The client is assumed to be in TileView if it has selected more than one endpoint, otherwise it is\r\n        // assumed to be in StageView.\r\n        this._receiverVideoConstraints.constraints = {};\r\n        if (this._selectedEndpoints.length > 1) {\r\n            /**\r\n             * Tile view.\r\n             * Only the default constraints are specified here along with lastN (if it is set).\r\n             * {\r\n             *  'colibriClass': 'ReceiverVideoConstraints',\r\n             *  'defaultConstraints': { 'maxHeight': 360 }\r\n             * }\r\n             */\r\n            this._receiverVideoConstraints.defaultConstraints = { 'maxHeight': this._maxFrameHeight };\r\n            this._receiverVideoConstraints.onStageEndpoints = [];\r\n            this._receiverVideoConstraints.selectedEndpoints = [];\r\n        } else {\r\n            /**\r\n             * Stage view.\r\n             * The participant on stage is specified in onStageEndpoints and a higher maxHeight is specified\r\n             * for that endpoint while a default maxHeight of 180 is applied to all the other endpoints.\r\n             * {\r\n             *  'colibriClass': 'ReceiverVideoConstraints',\r\n             *  'onStageEndpoints': ['A'],\r\n             *  'defaultConstraints': { 'maxHeight':  180 },\r\n             *  'constraints': {\r\n             *      'A': { 'maxHeight': 720 }\r\n             *   }\r\n             * }\r\n             */\r\n            this._receiverVideoConstraints.constraints[this._selectedEndpoints[0]] = {\r\n                'maxHeight': this._maxFrameHeight\r\n            };\r\n            this._receiverVideoConstraints.defaultConstraints = this._defaultConstraints;\r\n            this._receiverVideoConstraints.onStageEndpoints = this._selectedEndpoints;\r\n            this._receiverVideoConstraints.selectedEndpoints = [];\r\n        }\r\n\r\n        return this._receiverVideoConstraints;\r\n    }\r\n\r\n    /**\r\n     * Updates the lastN field of the ReceiverVideoConstraints sent to the bridge.\r\n     *\r\n     * @param {number} value\r\n     * @returns {boolean} Returns true if the the value has been updated, false otherwise.\r\n     */\r\n    updateLastN(value) {\r\n        const changed = this._lastN !== value;\r\n\r\n        if (changed) {\r\n            this._lastN = value;\r\n            logger.debug(`Updating ReceiverVideoConstraints lastN(${value})`);\r\n        }\r\n\r\n        return changed;\r\n    }\r\n\r\n    /**\r\n     * Updates the resolution (height requested) in the contraints field of the ReceiverVideoConstraints\r\n     * sent to the bridge.\r\n     *\r\n     * @param {number} maxFrameHeight\r\n     * @requires {boolean} Returns true if the the value has been updated, false otherwise.\r\n     */\r\n    updateReceiveResolution(maxFrameHeight) {\r\n        const changed = this._maxFrameHeight !== maxFrameHeight;\r\n\r\n        if (changed) {\r\n            this._maxFrameHeight = maxFrameHeight;\r\n            logger.debug(`Updating receive maxFrameHeight: ${maxFrameHeight}`);\r\n        }\r\n\r\n        return changed;\r\n    }\r\n\r\n    /**\r\n     * Updates the receiver constraints sent to the bridge.\r\n     *\r\n     * @param {Object} videoConstraints\r\n     * @returns {boolean} Returns true if the the value has been updated, false otherwise.\r\n     */\r\n    updateReceiverVideoConstraints(videoConstraints) {\r\n        const changed = !isEqual(this._receiverVideoConstraints, videoConstraints);\r\n\r\n        if (changed) {\r\n            this._receiverVideoConstraints = videoConstraints;\r\n            logger.debug(`Updating ReceiverVideoConstraints ${JSON.stringify(videoConstraints)}`);\r\n        }\r\n\r\n        return changed;\r\n    }\r\n\r\n    /**\r\n     * Updates the list of selected endpoints.\r\n     *\r\n     * @param {Array<string>} ids\r\n     * @returns {void}\r\n     */\r\n    updateSelectedEndpoints(ids) {\r\n        logger.debug(`Updating selected endpoints: ${JSON.stringify(ids)}`);\r\n        this._selectedEndpoints = ids;\r\n    }\r\n}\r\n\r\n/**\r\n * This class manages the receive video contraints for a given {@link JitsiConference}. These constraints are\r\n * determined by the application based on how the remote video streams need to be displayed. This class is responsible\r\n * for communicating these constraints to the bridge over the bridge channel.\r\n */\r\nexport class ReceiveVideoController {\r\n    /**\r\n     * Creates a new instance for a given conference.\r\n     *\r\n     * @param {JitsiConference} conference the conference instance for which the new instance will be managing\r\n     * the receive video quality constraints.\r\n     * @param {RTC} rtc the rtc instance which is responsible for initializing the bridge channel.\r\n     */\r\n    constructor(conference, rtc) {\r\n        this._conference = conference;\r\n        this._rtc = rtc;\r\n\r\n        const { config } = conference.options;\r\n\r\n        // The number of videos requested from the bridge, -1 represents unlimited or all available videos.\r\n        this._lastN = config?.startLastN ?? (config?.channelLastN || LASTN_UNLIMITED);\r\n\r\n        // The number representing the maximum video height the local client should receive from the bridge.\r\n        this._maxFrameHeight = MAX_HEIGHT_ONSTAGE;\r\n\r\n        // Enable new receiver constraints by default unless it is explicitly disabled through config.js.\r\n        const useNewReceiverConstraints = config?.useNewBandwidthAllocationStrategy ?? true;\r\n\r\n        if (useNewReceiverConstraints) {\r\n            this._receiverVideoConstraints = new ReceiverVideoConstraints();\r\n            const lastNUpdated = this._receiverVideoConstraints.updateLastN(this._lastN);\r\n\r\n            lastNUpdated && this._rtc.setNewReceiverVideoConstraints(this._receiverVideoConstraints.constraints);\r\n        } else {\r\n            this._rtc.setLastN(this._lastN);\r\n        }\r\n\r\n        // The endpoint IDs of the participants that are currently selected.\r\n        this._selectedEndpoints = [];\r\n\r\n        this._conference.on(\r\n            JitsiConferenceEvents._MEDIA_SESSION_STARTED,\r\n            session => this._onMediaSessionStarted(session));\r\n    }\r\n\r\n    /**\r\n     * Handles the {@link JitsiConferenceEvents.MEDIA_SESSION_STARTED}, that is when the conference creates new media\r\n     * session. The preferred receive frameHeight is applied on the media session.\r\n     *\r\n     * @param {JingleSessionPC} mediaSession - the started media session.\r\n     * @returns {void}\r\n     * @private\r\n     */\r\n    _onMediaSessionStarted(mediaSession) {\r\n        if (mediaSession.isP2P || !this._receiverVideoConstraints) {\r\n            mediaSession.setReceiverVideoConstraint(this._maxFrameHeight);\r\n        } else {\r\n            this._receiverVideoConstraints.updateReceiveResolution(this._maxFrameHeight);\r\n            this._rtc.setNewReceiverVideoConstraints(this._receiverVideoConstraints.constraints);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Returns the lastN value for the conference.\r\n     *\r\n     * @returns {number}\r\n     */\r\n    getLastN() {\r\n        return this._lastN;\r\n    }\r\n\r\n    /**\r\n     * Elects the participants with the given ids to be the selected participants in order to always receive video\r\n     * for this participant (even when last n is enabled).\r\n     *\r\n     * @param {Array<string>} ids - The user ids.\r\n     * @returns {void}\r\n     */\r\n    selectEndpoints(ids) {\r\n        this._selectedEndpoints = ids;\r\n\r\n        if (this._receiverVideoConstraints) {\r\n            // Filter out the local endpointId from the list of selected endpoints.\r\n            const remoteEndpointIds = ids.filter(id => id !== this._conference.myUserId());\r\n            const oldConstraints = JSON.parse(JSON.stringify(this._receiverVideoConstraints.constraints));\r\n\r\n            remoteEndpointIds.length && this._receiverVideoConstraints.updateSelectedEndpoints(remoteEndpointIds);\r\n            const newConstraints = this._receiverVideoConstraints.constraints;\r\n\r\n            // Send bridge message only when the constraints change.\r\n            if (!isEqual(newConstraints, oldConstraints)) {\r\n                this._rtc.setNewReceiverVideoConstraints(newConstraints);\r\n            }\r\n\r\n            return;\r\n        }\r\n        this._rtc.selectEndpoints(ids);\r\n    }\r\n\r\n    /**\r\n     * Selects a new value for \"lastN\". The requested amount of videos are going to be delivered after the value is\r\n     * in effect. Set to -1 for unlimited or all available videos.\r\n     *\r\n     * @param {number} value the new value for lastN.\r\n     * @returns {void}\r\n     */\r\n    setLastN(value) {\r\n        if (this._lastN !== value) {\r\n            this._lastN = value;\r\n\r\n            if (this._receiverVideoConstraints) {\r\n                const lastNUpdated = this._receiverVideoConstraints.updateLastN(value);\r\n\r\n                // Send out the message on the bridge channel if lastN was updated.\r\n                lastNUpdated && this._rtc.setNewReceiverVideoConstraints(this._receiverVideoConstraints.constraints);\r\n\r\n                return;\r\n            }\r\n            this._rtc.setLastN(value);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Sets the maximum video resolution the local participant should receive from remote participants.\r\n     *\r\n     * @param {number|undefined} maxFrameHeight - the new value.\r\n     * @returns {void}\r\n     */\r\n    setPreferredReceiveMaxFrameHeight(maxFrameHeight) {\r\n        this._maxFrameHeight = maxFrameHeight;\r\n\r\n        for (const session of this._conference._getMediaSessions()) {\r\n            if (session.isP2P || !this._receiverVideoConstraints) {\r\n                maxFrameHeight && session.setReceiverVideoConstraint(maxFrameHeight);\r\n            } else {\r\n                const resolutionUpdated = this._receiverVideoConstraints.updateReceiveResolution(maxFrameHeight);\r\n\r\n                resolutionUpdated\r\n                    && this._rtc.setNewReceiverVideoConstraints(this._receiverVideoConstraints.constraints);\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Sets the receiver constraints for the conference.\r\n     *\r\n     * @param {Object} constraints The video constraints.\r\n     */\r\n    setReceiverConstraints(constraints) {\r\n        if (!this._receiverVideoConstraints) {\r\n            this._receiverVideoConstraints = new ReceiverVideoConstraints();\r\n        }\r\n\r\n        const constraintsChanged = this._receiverVideoConstraints.updateReceiverVideoConstraints(constraints);\r\n\r\n        if (constraintsChanged) {\r\n            this._lastN = constraints.lastN ?? this._lastN;\r\n            this._selectedEndpoints = constraints.selectedEndpoints ?? this._selectedEndpoints;\r\n            this._rtc.setNewReceiverVideoConstraints(constraints);\r\n\r\n            const p2pSession = this._conference._getMediaSessions().find(session => session.isP2P);\r\n\r\n            if (p2pSession) {\r\n                let maxFrameHeight = Object.values(constraints.constraints)[0]?.maxHeight;\r\n\r\n                if (!maxFrameHeight) {\r\n                    maxFrameHeight = constraints.defaultConstraints?.maxHeight;\r\n                }\r\n                maxFrameHeight && p2pSession.setReceiverVideoConstraint(maxFrameHeight);\r\n            }\r\n        }\r\n    }\r\n}\r\n","import * as JitsiConferenceEvents from '../../JitsiConferenceEvents';\r\nimport RTCEvents from '../../service/RTC/RTCEvents';\r\nimport MediaSessionEvents from '../xmpp/MediaSessionEvents';\r\n\r\n/**\r\n * The class manages send video constraints across media sessions({@link JingleSessionPC}) which belong to\r\n * {@link JitsiConference}. It finds the lowest common value, between the local user's send preference and\r\n * the remote party's receive preference. Also this module will consider only the active session's receive value,\r\n * because local tracks are shared and while JVB may have no preference, the remote p2p may have and they may be totally\r\n * different.\r\n */\r\nexport class SendVideoController {\r\n    /**\r\n     * Creates new instance for a given conference.\r\n     *\r\n     * @param {JitsiConference} conference - the conference instance for which the new instance will be managing\r\n     * the send video quality constraints.\r\n     * @param {RTC} rtc - the rtc instance that is responsible for sending the messages on the bridge channel.\r\n     */\r\n    constructor(conference, rtc) {\r\n        this.conference = conference;\r\n        this.layerSuspensionEnabled = conference.options?.config?.enableLayerSuspension;\r\n        this.rtc = rtc;\r\n        this.conference.on(\r\n            JitsiConferenceEvents._MEDIA_SESSION_STARTED,\r\n            session => this._onMediaSessionStarted(session));\r\n        this.conference.on(\r\n            JitsiConferenceEvents._MEDIA_SESSION_ACTIVE_CHANGED,\r\n            () => this._propagateSendMaxFrameHeight());\r\n        this.rtc.on(\r\n            RTCEvents.SENDER_VIDEO_CONSTRAINTS_CHANGED,\r\n            videoConstraints => {\r\n                // Propagate the sender constraint only if it has changed.\r\n                if (this._senderVideoConstraints?.idealHeight !== videoConstraints.idealHeight) {\r\n                    this._senderVideoConstraints = videoConstraints;\r\n                    this._propagateSendMaxFrameHeight();\r\n                }\r\n            });\r\n    }\r\n\r\n    /**\r\n     * Handles the {@link JitsiConferenceEvents.MEDIA_SESSION_STARTED}, that is when the conference creates new media\r\n     * session. It doesn't mean it's already active though. For example the JVB connection may be created after\r\n     * the conference has entered the p2p mode already.\r\n     *\r\n     * @param {JingleSessionPC} mediaSession - the started media session.\r\n     * @private\r\n     */\r\n    _onMediaSessionStarted(mediaSession) {\r\n        mediaSession.addListener(\r\n            MediaSessionEvents.REMOTE_VIDEO_CONSTRAINTS_CHANGED,\r\n            session => {\r\n                if (session === this.conference._getActiveMediaSession()) {\r\n                    this._propagateSendMaxFrameHeight();\r\n                }\r\n            });\r\n\r\n        // Set the degradation preference on the local video track.\r\n        mediaSession.setSenderVideoDegradationPreference();\r\n\r\n        // Set the max bitrates on video sender if they are specified in config.js videoQuality settings.\r\n        mediaSession.setSenderMaxBitrates();\r\n    }\r\n\r\n    /**\r\n     * Figures out the send video constraint as specified by {@link selectSendMaxFrameHeight} and sets it on all media\r\n     * sessions for the reasons mentioned in this class description.\r\n     *\r\n     * @returns {Promise<void[]>}\r\n     * @private\r\n     */\r\n    _propagateSendMaxFrameHeight() {\r\n        const sendMaxFrameHeight = this.selectSendMaxFrameHeight();\r\n        const promises = [];\r\n\r\n        if (sendMaxFrameHeight >= 0) {\r\n            for (const session of this.conference._getMediaSessions()) {\r\n                promises.push(session.setSenderVideoConstraint(sendMaxFrameHeight));\r\n            }\r\n        }\r\n\r\n        return Promise.all(promises);\r\n    }\r\n\r\n    /**\r\n     * Selects the lowest common value for the local video send constraint by looking at local user's preference and\r\n     * the active media session's receive preference set by the remote party.\r\n     *\r\n     * @returns {number|undefined}\r\n     */\r\n    selectSendMaxFrameHeight() {\r\n        const activeMediaSession = this.conference._getActiveMediaSession();\r\n        const remoteRecvMaxFrameHeight = activeMediaSession\r\n            ? activeMediaSession.isP2P\r\n                ? activeMediaSession.getRemoteRecvMaxFrameHeight()\r\n                : this.layerSuspensionEnabled ? this._senderVideoConstraints?.idealHeight : undefined\r\n            : undefined;\r\n\r\n        if (this.preferredSendMaxFrameHeight >= 0 && remoteRecvMaxFrameHeight >= 0) {\r\n            return Math.min(this.preferredSendMaxFrameHeight, remoteRecvMaxFrameHeight);\r\n        } else if (remoteRecvMaxFrameHeight >= 0) {\r\n            return remoteRecvMaxFrameHeight;\r\n        }\r\n\r\n        return this.preferredSendMaxFrameHeight;\r\n    }\r\n\r\n    /**\r\n     * Sets local preference for max send video frame height.\r\n     *\r\n     * @param {number} maxFrameHeight - the new value to set.\r\n     * @returns {Promise<void[]>} - resolved when the operation is complete.\r\n     */\r\n    setPreferredSendMaxFrameHeight(maxFrameHeight) {\r\n        this.preferredSendMaxFrameHeight = maxFrameHeight;\r\n\r\n        return this._propagateSendMaxFrameHeight();\r\n    }\r\n}\r\n","import { getLogger } from 'jitsi-meet-logger';\r\n\r\nimport XMPPEvents from '../../service/xmpp/XMPPEvents';\r\n\r\nimport JibriSession from './JibriSession';\r\nimport recordingXMLUtils from './recordingXMLUtils';\r\n\r\nconst logger = getLogger(__filename);\r\n\r\n/**\r\n * A class responsible for starting and stopping recording sessions and emitting\r\n * state updates for them.\r\n */\r\nclass RecordingManager {\r\n    /**\r\n     * Initialize {@code RecordingManager} with other objects that are necessary\r\n     * for starting a recording.\r\n     *\r\n     * @param {ChatRoom} chatRoom - The chat room to handle.\r\n     * @returns {void}\r\n     */\r\n    constructor(chatRoom) {\r\n        /**\r\n         * All known recording sessions from the current conference.\r\n         */\r\n        this._sessions = {};\r\n\r\n        this._chatRoom = chatRoom;\r\n\r\n        this.onPresence = this.onPresence.bind(this);\r\n\r\n        this._chatRoom.eventEmitter.addListener(\r\n            XMPPEvents.PRESENCE_RECEIVED, this.onPresence);\r\n    }\r\n\r\n    /**\r\n     * Finds an existing recording session by session ID.\r\n     *\r\n     * @param {string} sessionID - The session ID associated with the recording.\r\n     * @returns {JibriSession|undefined}\r\n     */\r\n    getSession(sessionID) {\r\n        return this._sessions[sessionID];\r\n    }\r\n\r\n    /**\r\n     * Callback to invoke to parse through a presence update to find recording\r\n     * related updates (from Jibri participant doing the recording and the\r\n     * focus which controls recording).\r\n     *\r\n     * @param {Object} event - The presence data from the pubsub event.\r\n     * @param {Node} event.presence - An XMPP presence update.\r\n     * @param {boolean} event.fromHiddenDomain - Whether or not the update comes\r\n     * from a participant that is trusted but not visible, as would be the case\r\n     * with the Jibri recorder participant.\r\n     * @returns {void}\r\n     */\r\n    onPresence({ fromHiddenDomain, presence }) {\r\n        if (recordingXMLUtils.isFromFocus(presence)) {\r\n            this._handleFocusPresence(presence);\r\n        } else if (fromHiddenDomain) {\r\n            this._handleJibriPresence(presence);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Start a recording session.\r\n     *\r\n     * @param {Object} options - Configuration for the recording.\r\n     * @param {string} [options.appData] - Data specific to the app/service that\r\n     * the result file will be uploaded.\r\n     * @param {string} [optional] options.broadcastId - The channel on which a\r\n     * live stream will occur.\r\n     * @param {string} options.mode - The mode in which recording should be\r\n     * started. Recognized values are \"file\" and \"stream\".\r\n     * @param {string} [optional] options.streamId - The stream key to be used\r\n     * for live stream broadcasting. Required for live streaming.\r\n     * @returns {Promise} A promise for starting a recording, which will pass\r\n     * back the session on success. The promise resolves after receiving an\r\n     * acknowledgment of the start request success or fail.\r\n     */\r\n    startRecording(options) {\r\n        const session = new JibriSession({\r\n            ...options,\r\n            connection: this._chatRoom.connection\r\n        });\r\n\r\n        return session.start({\r\n            appData: options.appData,\r\n            broadcastId: options.broadcastId,\r\n            focusMucJid: this._chatRoom.focusMucJid,\r\n            streamId: options.streamId\r\n        })\r\n            .then(() => {\r\n                // Only store the session and emit if the session has not been\r\n                // added already. This is a workaround for the session getting\r\n                // created due to a presence update to announce a \"pending\"\r\n                // recording being received before JibriSession#start finishes.\r\n                if (!this.getSession(session.getID())) {\r\n                    this._addSession(session);\r\n                    this._emitSessionUpdate(session);\r\n                }\r\n\r\n                return session;\r\n            })\r\n            .catch(error => {\r\n                this._emitSessionUpdate(session);\r\n\r\n                return Promise.reject(error);\r\n            });\r\n    }\r\n\r\n    /**\r\n     * Stop a recording session.\r\n     *\r\n     * @param {string} sessionID - The ID associated with the recording session\r\n     * to be stopped.\r\n     * @returns {Promise} The promise resolves after receiving an\r\n     * acknowledgment of the stop request success or fail.\r\n     */\r\n    stopRecording(sessionID) {\r\n        const session = this.getSession(sessionID);\r\n\r\n        if (session) {\r\n            return session.stop({ focusMucJid: this._chatRoom.focusMucJid });\r\n        }\r\n\r\n        return Promise.reject(new Error('Could not find session'));\r\n    }\r\n\r\n    /**\r\n     * Stores a reference to the passed in JibriSession.\r\n     *\r\n     * @param {string} session - The JibriSession instance to store.\r\n     * @returns {void}\r\n     */\r\n    _addSession(session) {\r\n        this._sessions[session.getID()] = session;\r\n    }\r\n\r\n    /**\r\n     * Create a new instance of a recording session and stores a reference to\r\n     * it.\r\n     *\r\n     * @param {string} sessionID - The session ID of the recording in progress.\r\n     * @param {string} status - The current status of the recording session.\r\n     * @param {string} mode - The recording mode of the session.\r\n     * @returns {JibriSession}\r\n     */\r\n    _createSession(sessionID, status, mode) {\r\n        const session = new JibriSession({\r\n            connection: this._chatRoom.connection,\r\n            focusMucJid: this._chatRoom.focusMucJid,\r\n            mode,\r\n            sessionID,\r\n            status\r\n        });\r\n\r\n        this._addSession(session);\r\n\r\n        return session;\r\n    }\r\n\r\n    /**\r\n     * Notifies listeners of an update to a recording session.\r\n     *\r\n     * @param {JibriSession} session - The session that has been updated.\r\n     * @param {string|undefined} initiator - The jid of the initiator of the update.\r\n     */\r\n    _emitSessionUpdate(session, initiator) {\r\n        this._chatRoom.eventEmitter.emit(\r\n            XMPPEvents.RECORDER_STATE_CHANGED, session, initiator);\r\n    }\r\n\r\n    /**\r\n     * Parses presence to update an existing JibriSession or to create a new\r\n     * JibriSession.\r\n     *\r\n     * @param {Node} presence - An XMPP presence update.\r\n     * @returns {void}\r\n     */\r\n    _handleFocusPresence(presence) {\r\n        const jibriStatus = recordingXMLUtils.getFocusRecordingUpdate(presence);\r\n\r\n        if (!jibriStatus) {\r\n            return;\r\n        }\r\n\r\n        const { error, initiator, recordingMode, sessionID, status } = jibriStatus;\r\n\r\n        // We'll look for an existing session or create one (in case we're a\r\n        // participant joining a call with an existing recording going on).\r\n        let session = this.getSession(sessionID);\r\n\r\n        // Handle the case where a status update is received in presence but\r\n        // the local participant has joined while the JibriSession has already\r\n        // ended.\r\n        if (!session && status === 'off') {\r\n            logger.warn(\r\n                'Ignoring recording presence update',\r\n                'Received a new session with status off.');\r\n\r\n            return;\r\n        }\r\n\r\n        // Jicofo sends updates via presence, and any extension in presence\r\n        // is sent until it is explicitly removed.  It's difficult for\r\n        // Jicofo to know when a presence has been sent once, so it won't\r\n        // remove jibri status extension.  This means we may receive the same\r\n        // status update more than once, so check for that here\r\n        if (session\r\n            && session.getStatus() === status\r\n            && session.getError() === error) {\r\n            logger.warn('Ignoring duplicate presence update: ',\r\n                JSON.stringify(jibriStatus));\r\n\r\n            return;\r\n        }\r\n\r\n        if (!session) {\r\n            session = this._createSession(sessionID, status, recordingMode);\r\n        }\r\n\r\n        session.setStatus(status);\r\n\r\n        if (error) {\r\n            session.setError(error);\r\n        }\r\n\r\n        this._emitSessionUpdate(session, initiator);\r\n    }\r\n\r\n    /**\r\n     * Handles updates from the Jibri which can broadcast a YouTube URL that\r\n     * needs to be updated in a JibriSession.\r\n     *\r\n     * @param {Node} presence - An XMPP presence update.\r\n     * @returns {void}\r\n     */\r\n    _handleJibriPresence(presence) {\r\n        const { liveStreamViewURL, mode, sessionID }\r\n            = recordingXMLUtils.getHiddenDomainUpdate(presence);\r\n\r\n        if (!sessionID) {\r\n            logger.warn(\r\n                'Ignoring potential jibri presence due to no session id.');\r\n\r\n            return;\r\n        }\r\n\r\n        let session = this.getSession(sessionID);\r\n\r\n        if (!session) {\r\n            session = this._createSession(sessionID, '', mode);\r\n        }\r\n\r\n        session.setLiveStreamViewURL(liveStreamViewURL);\r\n\r\n        this._emitSessionUpdate(session);\r\n    }\r\n}\r\n\r\nexport default RecordingManager;\r\n","import { getLogger } from 'jitsi-meet-logger';\r\n\r\nimport * as ConferenceEvents from '../../JitsiConferenceEvents';\r\nimport * as MediaType from '../../service/RTC/MediaType';\r\nimport * as ConnectionQualityEvents from '../../service/connectivity/ConnectionQualityEvents';\r\nimport { createAudioOutputProblemEvent } from '../../service/statistics/AnalyticsEvents';\r\n\r\nimport Statistics from './statistics';\r\n\r\nconst logger = getLogger(__filename);\r\n\r\n/**\r\n * Number of local samples that will be used for comparison before and after the remote sample is received.\r\n */\r\nconst NUMBER_OF_LOCAL_SAMPLES = 2;\r\n\r\n/**\r\n * Collects the average audio levels per participant from the local stats and the stats received by every remote\r\n * participant and compares them to detect potential audio problem for a participant.\r\n */\r\nexport default class AudioOutputProblemDetector {\r\n\r\n    /**\r\n     * Creates new <tt>AudioOutputProblemDetector</tt> instance.\r\n     *\r\n     * @param {JitsiCofnerence} conference - The conference instance to be monitored.\r\n     */\r\n    constructor(conference) {\r\n        this._conference = conference;\r\n        this._localAudioLevelCache = {};\r\n        this._reportedParticipants = [];\r\n        this._audioProblemCandidates = {};\r\n        this._numberOfRemoteAudioLevelsReceived = {};\r\n        this._onLocalAudioLevelsReport = this._onLocalAudioLevelsReport.bind(this);\r\n        this._onRemoteAudioLevelReceived = this._onRemoteAudioLevelReceived.bind(this);\r\n        this._clearUserData = this._clearUserData.bind(this);\r\n        this._conference.on(ConnectionQualityEvents.REMOTE_STATS_UPDATED, this._onRemoteAudioLevelReceived);\r\n        this._conference.statistics.addConnectionStatsListener(this._onLocalAudioLevelsReport);\r\n        this._conference.on(ConferenceEvents.USER_LEFT, this._clearUserData);\r\n    }\r\n\r\n    /**\r\n     * A listener for audio level data received by a remote participant.\r\n     *\r\n     * @param {string} userID - The user id of the participant that sent the data.\r\n     * @param {number} audioLevel - The average audio level value.\r\n     * @returns {void}\r\n     */\r\n    _onRemoteAudioLevelReceived(userID, { avgAudioLevels }) {\r\n        const numberOfReports = (this._numberOfRemoteAudioLevelsReceived[userID] + 1) || 0;\r\n\r\n        this._numberOfRemoteAudioLevelsReceived[userID] = numberOfReports;\r\n\r\n        if (this._reportedParticipants.indexOf(userID) !== -1 || (userID in this._audioProblemCandidates)\r\n                || avgAudioLevels <= 0 || numberOfReports < 3) {\r\n            return;\r\n        }\r\n\r\n        const participant = this._conference.getParticipantById(userID);\r\n\r\n        if (participant) {\r\n            const tracks = participant.getTracksByMediaType(MediaType.AUDIO);\r\n\r\n            if (tracks.length > 0 && participant.isAudioMuted()) {\r\n                // We don't need to report an error if everything seems fine with the participant and its tracks but\r\n                // the participant is audio muted. Since those are average audio levels we potentially can receive non\r\n                // zero values for muted track.\r\n                return;\r\n            }\r\n        }\r\n\r\n        const localAudioLevels = this._localAudioLevelCache[userID];\r\n\r\n        if (!Array.isArray(localAudioLevels) || localAudioLevels.every(audioLevel => audioLevel === 0)) {\r\n            this._audioProblemCandidates[userID] = {\r\n                remoteAudioLevels: avgAudioLevels,\r\n                localAudioLevels: []\r\n            };\r\n        }\r\n    }\r\n\r\n    /**\r\n     * A listener for audio level data retrieved by the local stats.\r\n     *\r\n     * @param {TraceablePeerConnection} tpc - The <tt>TraceablePeerConnection</tt> instance used to gather the data.\r\n     * @param {Object} avgAudioLevels - The average audio levels per participant.\r\n     * @returns {void}\r\n     */\r\n    _onLocalAudioLevelsReport(tpc, { avgAudioLevels }) {\r\n        if (tpc !== this._conference.getActivePeerConnection()) {\r\n            return;\r\n        }\r\n\r\n        Object.keys(avgAudioLevels).forEach(userID => {\r\n            if (this._reportedParticipants.indexOf(userID) !== -1) {\r\n                return;\r\n            }\r\n\r\n            const localAudioLevels = this._localAudioLevelCache[userID];\r\n\r\n            if (!Array.isArray(localAudioLevels)) {\r\n                this._localAudioLevelCache[userID] = [ ];\r\n            } else if (localAudioLevels.length >= NUMBER_OF_LOCAL_SAMPLES) {\r\n                localAudioLevels.shift();\r\n            }\r\n\r\n            this._localAudioLevelCache[userID].push(avgAudioLevels[userID]);\r\n        });\r\n\r\n\r\n        Object.keys(this._audioProblemCandidates).forEach(userID => {\r\n            const { localAudioLevels, remoteAudioLevels } = this._audioProblemCandidates[userID];\r\n\r\n            localAudioLevels.push(avgAudioLevels[userID]);\r\n\r\n            if (localAudioLevels.length === NUMBER_OF_LOCAL_SAMPLES) {\r\n                if (localAudioLevels.every(audioLevel => typeof audioLevel === 'undefined' || audioLevel === 0)) {\r\n                    const localAudioLevelsString = JSON.stringify(localAudioLevels);\r\n\r\n                    Statistics.sendAnalytics(\r\n                        createAudioOutputProblemEvent(userID, localAudioLevelsString, remoteAudioLevels));\r\n                    logger.warn(`A potential problem is detected with the audio output for participant ${\r\n                        userID}, local audio levels: ${localAudioLevelsString}, remote audio levels: ${\r\n                        remoteAudioLevels}`);\r\n                    this._reportedParticipants.push(userID);\r\n                    this._clearUserData(userID);\r\n                }\r\n\r\n                delete this._audioProblemCandidates[userID];\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Clears the data stored for a participant.\r\n     *\r\n     * @param {string} userID - The id of the participant.\r\n     * @returns {void}\r\n     */\r\n    _clearUserData(userID) {\r\n        delete this._localAudioLevelCache[userID];\r\n    }\r\n\r\n    /**\r\n     * Disposes the allocated resources.\r\n     *\r\n     * @returns {void}\r\n     */\r\n    dispose() {\r\n        this._conference.off(ConnectionQualityEvents.REMOTE_STATS_UPDATED, this._onRemoteAudioLevelReceived);\r\n        this._conference.off(ConferenceEvents.USER_LEFT, this._clearUserData);\r\n        this._conference.statistics.removeConnectionStatsListener(this._onLocalAudioLevelsReport);\r\n        this._localAudioLevelCache = undefined;\r\n        this._audioProblemCandidates = undefined;\r\n        this._reportedParticipants = undefined;\r\n        this._numberOfRemoteAudioLevelsReceived = undefined;\r\n        this._conference = undefined;\r\n    }\r\n}\r\n","/* global __filename */\r\nimport { getLogger } from 'jitsi-meet-logger';\r\nimport isEqual from 'lodash.isequal';\r\n\r\nimport * as ConferenceEvents from '../../JitsiConferenceEvents';\r\nimport * as MediaType from '../../service/RTC/MediaType';\r\nimport * as VideoType from '../../service/RTC/VideoType';\r\nimport * as ConnectionQualityEvents\r\n    from '../../service/connectivity/ConnectionQualityEvents';\r\nimport {\r\n    createRtpStatsEvent,\r\n    createTransportStatsEvent\r\n} from '../../service/statistics/AnalyticsEvents';\r\nimport browser from '../browser';\r\n\r\nimport Statistics from './statistics';\r\n\r\n\r\nconst logger = getLogger(__filename);\r\n\r\n/**\r\n * This will calculate an average for one, named stat and submit it to\r\n * the analytics module when requested. It automatically counts the samples.\r\n */\r\nclass AverageStatReport {\r\n    /**\r\n     * Creates new <tt>AverageStatReport</tt> for given name.\r\n     * @param {string} name that's the name of the event that will be reported\r\n     * to the analytics module.\r\n     */\r\n    constructor(name) {\r\n        this.name = name;\r\n        this.count = 0;\r\n        this.sum = 0;\r\n        this.samples = [];\r\n    }\r\n\r\n    /**\r\n     * Adds the next value that will be included in the average when\r\n     * {@link calculate} is called.\r\n     * @param {number} nextValue\r\n     */\r\n    addNext(nextValue) {\r\n        if (typeof nextValue !== 'number') {\r\n            logger.error(\r\n                `${this.name} - invalid value for idx: ${this.count}`,\r\n                nextValue);\r\n        } else if (!isNaN(nextValue)) {\r\n            this.sum += nextValue;\r\n            this.samples.push(nextValue);\r\n            this.count += 1;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Calculates an average for the samples collected using {@link addNext}.\r\n     * @return {number|NaN} an average of all collected samples or <tt>NaN</tt>\r\n     * if no samples were collected.\r\n     */\r\n    calculate() {\r\n        return this.sum / this.count;\r\n    }\r\n\r\n    /**\r\n     * Appends the report to the analytics \"data\" object. The object will be\r\n     * set under <tt>prefix</tt> + {@link this.name} key.\r\n     * @param {Object} report the analytics \"data\" object\r\n     */\r\n    appendReport(report) {\r\n        report[`${this.name}_avg`] = this.calculate();\r\n        report[`${this.name}_samples`] = JSON.stringify(this.samples);\r\n    }\r\n\r\n    /**\r\n     * Clears all memory of any samples collected, so that new average can be\r\n     * calculated using this instance.\r\n     */\r\n    reset() {\r\n        this.samples = [];\r\n        this.sum = 0;\r\n        this.count = 0;\r\n    }\r\n}\r\n\r\n/**\r\n * Class gathers the stats that are calculated and reported for a\r\n * {@link TraceablePeerConnection} even if it's not currently active. For\r\n * example we want to monitor RTT for the JVB connection while in P2P mode.\r\n */\r\nclass ConnectionAvgStats {\r\n    /**\r\n     * Creates new <tt>ConnectionAvgStats</tt>\r\n     * @param {AvgRTPStatsReporter} avgRtpStatsReporter\r\n     * @param {boolean} isP2P\r\n     * @param {number} n the number of samples, before arithmetic mean is to be\r\n     * calculated and values submitted to the analytics module.\r\n     */\r\n    constructor(avgRtpStatsReporter, isP2P, n) {\r\n        /**\r\n         * Is this instance for JVB or P2P connection ?\r\n         * @type {boolean}\r\n         */\r\n        this.isP2P = isP2P;\r\n\r\n        /**\r\n         * How many samples are to be included in arithmetic mean calculation.\r\n         * @type {number}\r\n         * @private\r\n         */\r\n        this._n = n;\r\n\r\n        /**\r\n         * The current sample index. Starts from 0 and goes up to {@link _n})\r\n         * when analytics report will be submitted.\r\n         * @type {number}\r\n         * @private\r\n         */\r\n        this._sampleIdx = 0;\r\n\r\n        /**\r\n         * Average round trip time reported by the ICE candidate pair.\r\n         * @type {AverageStatReport}\r\n         */\r\n        this._avgRTT = new AverageStatReport('rtt');\r\n\r\n        /**\r\n         * Map stores average RTT to the JVB reported by remote participants.\r\n         * Mapped per participant id {@link JitsiParticipant.getId}.\r\n         *\r\n         * This is used only when {@link ConnectionAvgStats.isP2P} equals to\r\n         * <tt>false</tt>.\r\n         *\r\n         * @type {Map<string,AverageStatReport>}\r\n         * @private\r\n         */\r\n        this._avgRemoteRTTMap = new Map();\r\n\r\n        /**\r\n         * The conference for which stats will be collected and reported.\r\n         * @type {JitsiConference}\r\n         * @private\r\n         */\r\n        this._avgRtpStatsReporter = avgRtpStatsReporter;\r\n\r\n        /**\r\n         * The latest average E2E RTT for the JVB connection only.\r\n         *\r\n         * This is used only when {@link ConnectionAvgStats.isP2P} equals to\r\n         * <tt>false</tt>.\r\n         *\r\n         * @type {number}\r\n         */\r\n        this._avgEnd2EndRTT = undefined;\r\n\r\n        this._onConnectionStats = (tpc, stats) => {\r\n            if (this.isP2P === tpc.isP2P) {\r\n                this._calculateAvgStats(stats);\r\n            }\r\n        };\r\n\r\n        const conference = avgRtpStatsReporter._conference;\r\n\r\n        conference.statistics.addConnectionStatsListener(\r\n            this._onConnectionStats);\r\n\r\n        if (!this.isP2P) {\r\n            this._onUserLeft = id => this._avgRemoteRTTMap.delete(id);\r\n            conference.on(ConferenceEvents.USER_LEFT, this._onUserLeft);\r\n\r\n            this._onRemoteStatsUpdated\r\n                = (id, data) => this._processRemoteStats(id, data);\r\n            conference.on(\r\n                ConnectionQualityEvents.REMOTE_STATS_UPDATED,\r\n                this._onRemoteStatsUpdated);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Processes next batch of stats.\r\n     * @param {go figure} data\r\n     * @private\r\n     */\r\n    _calculateAvgStats(data) {\r\n        if (!data) {\r\n            logger.error('No stats');\r\n\r\n            return;\r\n        }\r\n\r\n        if (browser.supportsRTTStatistics()) {\r\n            if (data.transport && data.transport.length) {\r\n                this._avgRTT.addNext(data.transport[0].rtt);\r\n            }\r\n        }\r\n\r\n        this._sampleIdx += 1;\r\n\r\n        if (this._sampleIdx >= this._n) {\r\n            if (browser.supportsRTTStatistics()) {\r\n                const conference = this._avgRtpStatsReporter._conference;\r\n\r\n                const batchReport = {\r\n                    p2p: this.isP2P,\r\n                    'conference_size': conference.getParticipantCount()\r\n                };\r\n\r\n                if (data.transport && data.transport.length) {\r\n                    Object.assign(batchReport, {\r\n                        'local_candidate_type':\r\n                            data.transport[0].localCandidateType,\r\n                        'remote_candidate_type':\r\n                            data.transport[0].remoteCandidateType,\r\n                        'transport_type': data.transport[0].type\r\n                    });\r\n                }\r\n\r\n                this._avgRTT.appendReport(batchReport);\r\n\r\n                if (this.isP2P) {\r\n                    // Report RTT diff only for P2P.\r\n                    const jvbEnd2EndRTT = this\r\n                        ._avgRtpStatsReporter.jvbStatsMonitor._avgEnd2EndRTT;\r\n\r\n                    if (!isNaN(jvbEnd2EndRTT)) {\r\n                        // eslint-disable-next-line dot-notation\r\n                        batchReport['rtt_diff']\r\n                            = this._avgRTT.calculate() - jvbEnd2EndRTT;\r\n                    }\r\n                } else {\r\n                    // Report end to end RTT only for JVB.\r\n                    const avgRemoteRTT = this._calculateAvgRemoteRTT();\r\n                    const avgLocalRTT = this._avgRTT.calculate();\r\n\r\n                    this._avgEnd2EndRTT = avgLocalRTT + avgRemoteRTT;\r\n\r\n                    if (!isNaN(avgLocalRTT) && !isNaN(avgRemoteRTT)) {\r\n                        // eslint-disable-next-line dot-notation\r\n                        batchReport['end2end_rtt_avg'] = this._avgEnd2EndRTT;\r\n                    }\r\n                }\r\n\r\n                Statistics.sendAnalytics(createRtpStatsEvent(batchReport));\r\n            }\r\n\r\n            this._resetAvgStats();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Calculates arithmetic mean of all RTTs towards the JVB reported by\r\n     * participants.\r\n     * @return {number|NaN} NaN if not available (not enough data)\r\n     * @private\r\n     */\r\n    _calculateAvgRemoteRTT() {\r\n        let count = 0, sum = 0;\r\n\r\n        // FIXME should we ignore RTT for participant\r\n        // who \"is having connectivity issues\" ?\r\n        for (const remoteAvg of this._avgRemoteRTTMap.values()) {\r\n            const avg = remoteAvg.calculate();\r\n\r\n            if (!isNaN(avg)) {\r\n                sum += avg;\r\n                count += 1;\r\n                remoteAvg.reset();\r\n            }\r\n        }\r\n\r\n        return sum / count;\r\n    }\r\n\r\n    /**\r\n     * Processes {@link ConnectionQualityEvents.REMOTE_STATS_UPDATED} to analyse\r\n     * RTT towards the JVB reported by each participant.\r\n     * @param {string} id {@link JitsiParticipant.getId}\r\n     * @param {go figure in ConnectionQuality.js} data\r\n     * @private\r\n     */\r\n    _processRemoteStats(id, data) {\r\n        const validData = typeof data.jvbRTT === 'number';\r\n        let rttAvg = this._avgRemoteRTTMap.get(id);\r\n\r\n        if (!rttAvg && validData) {\r\n            rttAvg = new AverageStatReport(`${id}_stat_rtt`);\r\n            this._avgRemoteRTTMap.set(id, rttAvg);\r\n        }\r\n\r\n        if (validData) {\r\n            rttAvg.addNext(data.jvbRTT);\r\n        } else if (rttAvg) {\r\n            this._avgRemoteRTTMap.delete(id);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Reset cache of all averages and {@link _sampleIdx}.\r\n     * @private\r\n     */\r\n    _resetAvgStats() {\r\n        this._avgRTT.reset();\r\n        if (this._avgRemoteRTTMap) {\r\n            this._avgRemoteRTTMap.clear();\r\n        }\r\n        this._sampleIdx = 0;\r\n    }\r\n\r\n    /**\r\n     *\r\n     */\r\n    dispose() {\r\n\r\n        const conference = this._avgRtpStatsReporter._conference;\r\n\r\n        conference.statistics.removeConnectionStatsListener(\r\n            this._onConnectionStats);\r\n        if (!this.isP2P) {\r\n            conference.off(\r\n                ConnectionQualityEvents.REMOTE_STATS_UPDATED,\r\n                this._onRemoteStatsUpdated);\r\n            conference.off(\r\n                ConferenceEvents.USER_LEFT,\r\n                this._onUserLeft);\r\n        }\r\n    }\r\n}\r\n\r\n/**\r\n * Reports average RTP statistics values (arithmetic mean) to the analytics\r\n * module for things like bit rate, bandwidth, packet loss etc. It keeps track\r\n * of the P2P vs JVB conference modes and submits the values under different\r\n * namespaces (the events for P2P mode have 'p2p.' prefix). Every switch between\r\n * P2P mode resets the data collected so far and averages are calculated from\r\n * scratch.\r\n */\r\nexport default class AvgRTPStatsReporter {\r\n    /**\r\n     * Creates new instance of <tt>AvgRTPStatsReporter</tt>\r\n     * @param {JitsiConference} conference\r\n     * @param {number} n the number of samples, before arithmetic mean is to be\r\n     * calculated and values submitted to the analytics module.\r\n     */\r\n    constructor(conference, n) {\r\n        /**\r\n         * How many {@link ConnectionQualityEvents.LOCAL_STATS_UPDATED} samples\r\n         * are to be included in arithmetic mean calculation.\r\n         * @type {number}\r\n         * @private\r\n         */\r\n        this._n = n;\r\n\r\n        if (n > 0) {\r\n            logger.info(`Avg RTP stats will be calculated every ${n} samples`);\r\n        } else {\r\n            logger.info('Avg RTP stats reports are disabled.');\r\n\r\n            // Do not initialize\r\n            return;\r\n        }\r\n\r\n        /**\r\n         * The current sample index. Starts from 0 and goes up to {@link _n})\r\n         * when analytics report will be submitted.\r\n         * @type {number}\r\n         * @private\r\n         */\r\n        this._sampleIdx = 0;\r\n\r\n        /**\r\n         * The conference for which stats will be collected and reported.\r\n         * @type {JitsiConference}\r\n         * @private\r\n         */\r\n        this._conference = conference;\r\n\r\n        /**\r\n         * Average audio upload bitrate\r\n         * XXX What are the units?\r\n         * @type {AverageStatReport}\r\n         * @private\r\n         */\r\n        this._avgAudioBitrateUp\r\n            = new AverageStatReport('bitrate_audio_upload');\r\n\r\n        /**\r\n         * Average audio download bitrate\r\n         * XXX What are the units?\r\n         * @type {AverageStatReport}\r\n         * @private\r\n         */\r\n        this._avgAudioBitrateDown\r\n            = new AverageStatReport('bitrate_audio_download');\r\n\r\n        /**\r\n         * Average video upload bitrate\r\n         * XXX What are the units?\r\n         * @type {AverageStatReport}\r\n         * @private\r\n         */\r\n        this._avgVideoBitrateUp\r\n            = new AverageStatReport('bitrate_video_upload');\r\n\r\n        /**\r\n         * Average video download bitrate\r\n         * XXX What are the units?\r\n         * @type {AverageStatReport}\r\n         * @private\r\n         */\r\n        this._avgVideoBitrateDown\r\n            = new AverageStatReport('bitrate_video_download');\r\n\r\n        /**\r\n         * Average upload bandwidth\r\n         * XXX What are the units?\r\n         * @type {AverageStatReport}\r\n         * @private\r\n         */\r\n        this._avgBandwidthUp\r\n            = new AverageStatReport('bandwidth_upload');\r\n\r\n        /**\r\n         * Average download bandwidth\r\n         * XXX What are the units?\r\n         * @type {AverageStatReport}\r\n         * @private\r\n         */\r\n        this._avgBandwidthDown\r\n            = new AverageStatReport('bandwidth_download');\r\n\r\n        /**\r\n         * Average total packet loss\r\n         * XXX What are the units?\r\n         * @type {AverageStatReport}\r\n         * @private\r\n         */\r\n        this._avgPacketLossTotal\r\n            = new AverageStatReport('packet_loss_total');\r\n\r\n        /**\r\n         * Average upload packet loss\r\n         * XXX What are the units?\r\n         * @type {AverageStatReport}\r\n         * @private\r\n         */\r\n        this._avgPacketLossUp\r\n            = new AverageStatReport('packet_loss_upload');\r\n\r\n        /**\r\n         * Average download packet loss\r\n         * XXX What are the units?\r\n         * @type {AverageStatReport}\r\n         * @private\r\n         */\r\n        this._avgPacketLossDown\r\n            = new AverageStatReport('packet_loss_download');\r\n\r\n        /**\r\n         * Average FPS for remote videos\r\n         * @type {AverageStatReport}\r\n         * @private\r\n         */\r\n        this._avgRemoteFPS = new AverageStatReport('framerate_remote');\r\n\r\n        /**\r\n         * Average FPS for remote screen streaming videos (reported only if not\r\n         * a <tt>NaN</tt>).\r\n         * @type {AverageStatReport}\r\n         * @private\r\n         */\r\n        this._avgRemoteScreenFPS\r\n            = new AverageStatReport('framerate_screen_remote');\r\n\r\n        /**\r\n         * Average FPS for local video (camera)\r\n         * @type {AverageStatReport}\r\n         * @private\r\n         */\r\n        this._avgLocalFPS = new AverageStatReport('framerate_local');\r\n\r\n        /**\r\n         * Average FPS for local screen streaming video (reported only if not\r\n         * a <tt>NaN</tt>).\r\n         * @type {AverageStatReport}\r\n         * @private\r\n         */\r\n        this._avgLocalScreenFPS\r\n            = new AverageStatReport('framerate_screen_local');\r\n\r\n        /**\r\n         * Average pixels for remote screen streaming videos (reported only if\r\n         * not a <tt>NaN</tt>).\r\n         * @type {AverageStatReport}\r\n         * @private\r\n         */\r\n        this._avgRemoteCameraPixels\r\n            = new AverageStatReport('pixels_remote');\r\n\r\n        /**\r\n         * Average pixels for remote screen streaming videos (reported only if\r\n         * not a <tt>NaN</tt>).\r\n         * @type {AverageStatReport}\r\n         * @private\r\n         */\r\n        this._avgRemoteScreenPixels\r\n            = new AverageStatReport('pixels_screen_remote');\r\n\r\n        /**\r\n         * Average pixels for local video (camera)\r\n         * @type {AverageStatReport}\r\n         * @private\r\n         */\r\n        this._avgLocalCameraPixels\r\n            = new AverageStatReport('pixels_local');\r\n\r\n        /**\r\n         * Average pixels for local screen streaming video (reported only if not\r\n         * a <tt>NaN</tt>).\r\n         * @type {AverageStatReport}\r\n         * @private\r\n         */\r\n        this._avgLocalScreenPixels\r\n            = new AverageStatReport('pixels_screen_local');\r\n\r\n        /**\r\n         * Average connection quality as defined by\r\n         * the {@link ConnectionQuality} module.\r\n         * @type {AverageStatReport}\r\n         * @private\r\n         */\r\n        this._avgCQ = new AverageStatReport('connection_quality');\r\n\r\n        this._cachedTransportStats = undefined;\r\n\r\n        this._onLocalStatsUpdated = data => {\r\n            this._calculateAvgStats(data);\r\n            this._maybeSendTransportAnalyticsEvent(data);\r\n        };\r\n        conference.on(\r\n            ConnectionQualityEvents.LOCAL_STATS_UPDATED,\r\n            this._onLocalStatsUpdated);\r\n\r\n        this._onP2PStatusChanged = () => {\r\n            logger.debug('Resetting average stats calculation');\r\n            this._resetAvgStats();\r\n            this.jvbStatsMonitor._resetAvgStats();\r\n            this.p2pStatsMonitor._resetAvgStats();\r\n        };\r\n        conference.on(\r\n            ConferenceEvents.P2P_STATUS,\r\n            this._onP2PStatusChanged);\r\n\r\n        this._onJvb121StatusChanged = (oldStatus, newStatus) => {\r\n            // We want to reset only on the transition from false => true,\r\n            // because otherwise those stats are resetted on JVB <=> P2P\r\n            // transition.\r\n            if (newStatus === true) {\r\n                logger.info('Resetting JVB avg RTP stats');\r\n                this._resetAvgJvbStats();\r\n            }\r\n        };\r\n        conference.on(\r\n            ConferenceEvents.JVB121_STATUS,\r\n            this._onJvb121StatusChanged);\r\n\r\n        this.jvbStatsMonitor\r\n            = new ConnectionAvgStats(this, false /* JVB */, n);\r\n\r\n        this.p2pStatsMonitor\r\n            = new ConnectionAvgStats(this, true /* P2P */, n);\r\n    }\r\n\r\n    /**\r\n     * Processes next batch of stats reported on\r\n     * {@link ConnectionQualityEvents.LOCAL_STATS_UPDATED}.\r\n     * @param {go figure} data\r\n     * @private\r\n     */\r\n    _calculateAvgStats(data) {\r\n\r\n        if (!data) {\r\n            logger.error('No stats');\r\n\r\n            return;\r\n        }\r\n\r\n        const isP2P = this._conference.isP2PActive();\r\n        const confSize = this._conference.getParticipantCount();\r\n\r\n        if (!isP2P && confSize < 2) {\r\n\r\n            // There's no point in collecting stats for a JVB conference of 1.\r\n            // That happens for short period of time after everyone leaves\r\n            // the room, until Jicofo terminates the session.\r\n            return;\r\n        }\r\n\r\n        /* Uncomment to figure out stats structure\r\n        for (const key in data) {\r\n            if (data.hasOwnProperty(key)) {\r\n                logger.info(`local stat ${key}: `, data[key]);\r\n            }\r\n        } */\r\n\r\n        const bitrate = data.bitrate;\r\n        const bandwidth = data.bandwidth;\r\n        const packetLoss = data.packetLoss;\r\n        const frameRate = data.framerate;\r\n        const resolution = data.resolution;\r\n\r\n        if (!bitrate) {\r\n            logger.error('No \"bitrate\"');\r\n\r\n            return;\r\n        } else if (!bandwidth) {\r\n            logger.error('No \"bandwidth\"');\r\n\r\n            return;\r\n        } else if (!packetLoss) {\r\n            logger.error('No \"packetloss\"');\r\n\r\n            return;\r\n        } else if (!frameRate) {\r\n            logger.error('No \"framerate\"');\r\n\r\n            return;\r\n        } else if (!resolution) {\r\n            logger.error('No resolution');\r\n\r\n            return;\r\n        }\r\n\r\n        this._avgAudioBitrateUp.addNext(bitrate.audio.upload);\r\n        this._avgAudioBitrateDown.addNext(bitrate.audio.download);\r\n\r\n        this._avgVideoBitrateUp.addNext(bitrate.video.upload);\r\n        this._avgVideoBitrateDown.addNext(bitrate.video.download);\r\n\r\n        if (browser.supportsBandwidthStatistics()) {\r\n            this._avgBandwidthUp.addNext(bandwidth.upload);\r\n            this._avgBandwidthDown.addNext(bandwidth.download);\r\n        }\r\n\r\n        this._avgPacketLossUp.addNext(packetLoss.upload);\r\n        this._avgPacketLossDown.addNext(packetLoss.download);\r\n        this._avgPacketLossTotal.addNext(packetLoss.total);\r\n\r\n        this._avgCQ.addNext(data.connectionQuality);\r\n\r\n        if (frameRate) {\r\n            this._avgRemoteFPS.addNext(\r\n                this._calculateAvgVideoFps(\r\n                    frameRate, false /* remote */, VideoType.CAMERA));\r\n            this._avgRemoteScreenFPS.addNext(\r\n                this._calculateAvgVideoFps(\r\n                    frameRate, false /* remote */, VideoType.DESKTOP));\r\n\r\n            this._avgLocalFPS.addNext(\r\n                this._calculateAvgVideoFps(\r\n                    frameRate, true /* local */, VideoType.CAMERA));\r\n            this._avgLocalScreenFPS.addNext(\r\n                this._calculateAvgVideoFps(\r\n                    frameRate, true /* local */, VideoType.DESKTOP));\r\n        }\r\n\r\n        if (resolution) {\r\n            this._avgRemoteCameraPixels.addNext(\r\n                this._calculateAvgVideoPixels(\r\n                    resolution, false /* remote */, VideoType.CAMERA));\r\n\r\n            this._avgRemoteScreenPixels.addNext(\r\n                this._calculateAvgVideoPixels(\r\n                    resolution, false /* remote */, VideoType.DESKTOP));\r\n\r\n            this._avgLocalCameraPixels.addNext(\r\n                this._calculateAvgVideoPixels(\r\n                    resolution, true /* local */, VideoType.CAMERA));\r\n\r\n            this._avgLocalScreenPixels.addNext(\r\n                this._calculateAvgVideoPixels(\r\n                    resolution, true /* local */, VideoType.DESKTOP));\r\n        }\r\n\r\n        this._sampleIdx += 1;\r\n\r\n        if (this._sampleIdx >= this._n) {\r\n\r\n            const batchReport = {\r\n                p2p: isP2P,\r\n                'conference_size': confSize\r\n            };\r\n\r\n            if (data.transport && data.transport.length) {\r\n                Object.assign(batchReport, {\r\n                    'local_candidate_type':\r\n                        data.transport[0].localCandidateType,\r\n                    'remote_candidate_type':\r\n                        data.transport[0].remoteCandidateType,\r\n                    'transport_type': data.transport[0].type\r\n                });\r\n            }\r\n\r\n            this._avgAudioBitrateUp.appendReport(batchReport);\r\n            this._avgAudioBitrateDown.appendReport(batchReport);\r\n\r\n            this._avgVideoBitrateUp.appendReport(batchReport);\r\n            this._avgVideoBitrateDown.appendReport(batchReport);\r\n\r\n            if (browser.supportsBandwidthStatistics()) {\r\n                this._avgBandwidthUp.appendReport(batchReport);\r\n                this._avgBandwidthDown.appendReport(batchReport);\r\n            }\r\n            this._avgPacketLossUp.appendReport(batchReport);\r\n            this._avgPacketLossDown.appendReport(batchReport);\r\n            this._avgPacketLossTotal.appendReport(batchReport);\r\n\r\n            this._avgRemoteFPS.appendReport(batchReport);\r\n            if (!isNaN(this._avgRemoteScreenFPS.calculate())) {\r\n                this._avgRemoteScreenFPS.appendReport(batchReport);\r\n            }\r\n            this._avgLocalFPS.appendReport(batchReport);\r\n            if (!isNaN(this._avgLocalScreenFPS.calculate())) {\r\n                this._avgLocalScreenFPS.appendReport(batchReport);\r\n            }\r\n\r\n            this._avgRemoteCameraPixels.appendReport(batchReport);\r\n            if (!isNaN(this._avgRemoteScreenPixels.calculate())) {\r\n                this._avgRemoteScreenPixels.appendReport(batchReport);\r\n            }\r\n            this._avgLocalCameraPixels.appendReport(batchReport);\r\n            if (!isNaN(this._avgLocalScreenPixels.calculate())) {\r\n                this._avgLocalScreenPixels.appendReport(batchReport);\r\n            }\r\n\r\n            this._avgCQ.appendReport(batchReport);\r\n\r\n            Statistics.sendAnalytics(createRtpStatsEvent(batchReport));\r\n\r\n            this._resetAvgStats();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Calculates average number of pixels for the report\r\n     *\r\n     * @param {map} peerResolutions a map of peer resolutions\r\n     * @param {boolean} isLocal if the average is to be calculated for the local\r\n     * video or <tt>false</tt> if for remote videos.\r\n     * @param {VideoType} videoType\r\n     * @return {number|NaN} average number of pixels or <tt>NaN</tt> if there\r\n     * are no samples.\r\n     * @private\r\n     */\r\n    _calculateAvgVideoPixels(peerResolutions, isLocal, videoType) {\r\n        let peerPixelsSum = 0;\r\n        let peerCount = 0;\r\n        const myID = this._conference.myUserId();\r\n\r\n        for (const peerID of Object.keys(peerResolutions)) {\r\n            if (isLocal ? peerID === myID : peerID !== myID) {\r\n                const participant\r\n                    = isLocal\r\n                        ? null\r\n                        : this._conference.getParticipantById(peerID);\r\n                const videosResolution = peerResolutions[peerID];\r\n\r\n                // Do not continue without participant for non local peerID\r\n                if ((isLocal || participant) && videosResolution) {\r\n                    const peerAvgPixels = this._calculatePeerAvgVideoPixels(\r\n                        videosResolution, participant, videoType);\r\n\r\n                    if (!isNaN(peerAvgPixels)) {\r\n                        peerPixelsSum += peerAvgPixels;\r\n                        peerCount += 1;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        return peerPixelsSum / peerCount;\r\n    }\r\n\r\n    /**\r\n     * Calculate average pixels for either remote or local participant\r\n     * @param {object} videos maps resolution per video SSRC\r\n     * @param {JitsiParticipant|null} participant remote participant or\r\n     * <tt>null</tt> for local video pixels calculation.\r\n     * @param {VideoType} videoType the type of the video for which an average\r\n     * will be calculated.\r\n     * @return {number|NaN} average video pixels of all participant's videos or\r\n     * <tt>NaN</tt> if currently not available\r\n     * @private\r\n     */\r\n    _calculatePeerAvgVideoPixels(videos, participant, videoType) {\r\n        let ssrcs = Object.keys(videos).map(ssrc => Number(ssrc));\r\n        let videoTracks = null;\r\n\r\n        // NOTE that this method is supposed to be called for the stats\r\n        // received from the current peerconnection.\r\n        const tpc = this._conference.getActivePeerConnection();\r\n\r\n        if (participant) {\r\n            videoTracks = participant.getTracksByMediaType(MediaType.VIDEO);\r\n            if (videoTracks) {\r\n                ssrcs\r\n                    = ssrcs.filter(\r\n                        ssrc => videoTracks.find(\r\n                            track =>\r\n                                !track.isMuted()\r\n                                    && track.getSSRC() === ssrc\r\n                                    && track.videoType === videoType));\r\n            }\r\n        } else {\r\n            videoTracks = this._conference.getLocalTracks(MediaType.VIDEO);\r\n            ssrcs\r\n                = ssrcs.filter(\r\n                    ssrc => videoTracks.find(\r\n                        track =>\r\n                            !track.isMuted()\r\n                                && tpc.getLocalSSRC(track) === ssrc\r\n                                && track.videoType === videoType));\r\n        }\r\n\r\n        let peerPixelsSum = 0;\r\n        let peerSsrcCount = 0;\r\n\r\n        for (const ssrc of ssrcs) {\r\n            const peerSsrcPixels\r\n                = Number(videos[ssrc].height) * Number(videos[ssrc].width);\r\n\r\n            // FPS is reported as 0 for users with no video\r\n            if (!isNaN(peerSsrcPixels) && peerSsrcPixels > 0) {\r\n                peerPixelsSum += peerSsrcPixels;\r\n                peerSsrcCount += 1;\r\n            }\r\n        }\r\n\r\n        return peerPixelsSum / peerSsrcCount;\r\n    }\r\n\r\n\r\n    /**\r\n     * Calculates average FPS for the report\r\n     * @param {go figure} frameRate\r\n     * @param {boolean} isLocal if the average is to be calculated for the local\r\n     * video or <tt>false</tt> if for remote videos.\r\n     * @param {VideoType} videoType\r\n     * @return {number|NaN} average FPS or <tt>NaN</tt> if there are no samples.\r\n     * @private\r\n     */\r\n    _calculateAvgVideoFps(frameRate, isLocal, videoType) {\r\n        let peerFpsSum = 0;\r\n        let peerCount = 0;\r\n        const myID = this._conference.myUserId();\r\n\r\n        for (const peerID of Object.keys(frameRate)) {\r\n            if (isLocal ? peerID === myID : peerID !== myID) {\r\n                const participant\r\n                    = isLocal\r\n                        ? null : this._conference.getParticipantById(peerID);\r\n                const videosFps = frameRate[peerID];\r\n\r\n                // Do not continue without participant for non local peerID\r\n                if ((isLocal || participant) && videosFps) {\r\n                    const peerAvgFPS\r\n                        = this._calculatePeerAvgVideoFps(\r\n                            videosFps, participant, videoType);\r\n\r\n                    if (!isNaN(peerAvgFPS)) {\r\n                        peerFpsSum += peerAvgFPS;\r\n                        peerCount += 1;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        return peerFpsSum / peerCount;\r\n    }\r\n\r\n    /**\r\n     * Calculate average FPS for either remote or local participant\r\n     * @param {object} videos maps FPS per video SSRC\r\n     * @param {JitsiParticipant|null} participant remote participant or\r\n     * <tt>null</tt> for local FPS calculation.\r\n     * @param {VideoType} videoType the type of the video for which an average\r\n     * will be calculated.\r\n     * @return {number|NaN} average FPS of all participant's videos or\r\n     * <tt>NaN</tt> if currently not available\r\n     * @private\r\n     */\r\n    _calculatePeerAvgVideoFps(videos, participant, videoType) {\r\n        let ssrcs = Object.keys(videos).map(ssrc => Number(ssrc));\r\n        let videoTracks = null;\r\n\r\n        // NOTE that this method is supposed to be called for the stats\r\n        // received from the current peerconnection.\r\n        const tpc = this._conference.getActivePeerConnection();\r\n\r\n        if (participant) {\r\n            videoTracks = participant.getTracksByMediaType(MediaType.VIDEO);\r\n            if (videoTracks) {\r\n                ssrcs\r\n                    = ssrcs.filter(\r\n                        ssrc => videoTracks.find(\r\n                            track => !track.isMuted()\r\n                                && track.getSSRC() === ssrc\r\n                                && track.videoType === videoType));\r\n            }\r\n        } else {\r\n            videoTracks = this._conference.getLocalTracks(MediaType.VIDEO);\r\n            ssrcs\r\n                = ssrcs.filter(\r\n                    ssrc => videoTracks.find(\r\n                        track => !track.isMuted()\r\n                            && tpc.getLocalSSRC(track) === ssrc\r\n                            && track.videoType === videoType));\r\n        }\r\n\r\n        let peerFpsSum = 0;\r\n        let peerSsrcCount = 0;\r\n\r\n        for (const ssrc of ssrcs) {\r\n            const peerSsrcFps = Number(videos[ssrc]);\r\n\r\n            // FPS is reported as 0 for users with no video\r\n            if (!isNaN(peerSsrcFps) && peerSsrcFps > 0) {\r\n                peerFpsSum += peerSsrcFps;\r\n                peerSsrcCount += 1;\r\n            }\r\n        }\r\n\r\n        return peerFpsSum / peerSsrcCount;\r\n    }\r\n\r\n    /**\r\n     * Sends the 'transport.stats' analytics event whenever we detect that\r\n     * there is a change in the local or remote candidate type on the transport\r\n     * that is currently selected.\r\n     * @param {*} data\r\n     * @private\r\n     */\r\n    _maybeSendTransportAnalyticsEvent(data) {\r\n        if (!data || !data.transport || !data.transport.length) {\r\n            return;\r\n        }\r\n        const transportStats = {\r\n            p2p: data.transport[0].p2p,\r\n            'local_candidate_type': data.transport[0].localCandidateType,\r\n            'remote_candidate_type': data.transport[0].remoteCandidateType,\r\n            'transport_type': data.transport[0].type\r\n        };\r\n\r\n        if (!this._cachedTransportStats || !isEqual(transportStats, this._cachedTransportStats)) {\r\n            this._cachedTransportStats = transportStats;\r\n            Statistics.sendAnalytics(createTransportStatsEvent(transportStats));\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Resets the stats related to JVB connection. Must not be called when in\r\n     * P2P mode, because then the {@link AverageStatReport} instances are\r\n     * tracking P2P stats. Note that this should never happen unless something\r\n     * is wrong with the P2P and JVB121 events.\r\n     * @private\r\n     */\r\n    _resetAvgJvbStats() {\r\n        this._resetAvgStats();\r\n        this.jvbStatsMonitor._resetAvgStats();\r\n    }\r\n\r\n    /**\r\n     * Reset cache of all averages and {@link _sampleIdx}.\r\n     * @private\r\n     */\r\n    _resetAvgStats() {\r\n        this._avgAudioBitrateUp.reset();\r\n        this._avgAudioBitrateDown.reset();\r\n\r\n        this._avgVideoBitrateUp.reset();\r\n        this._avgVideoBitrateDown.reset();\r\n\r\n        this._avgBandwidthUp.reset();\r\n        this._avgBandwidthDown.reset();\r\n\r\n        this._avgPacketLossUp.reset();\r\n        this._avgPacketLossDown.reset();\r\n        this._avgPacketLossTotal.reset();\r\n\r\n        this._avgRemoteFPS.reset();\r\n        this._avgRemoteScreenFPS.reset();\r\n        this._avgLocalFPS.reset();\r\n        this._avgLocalScreenFPS.reset();\r\n\r\n        this._avgRemoteCameraPixels.reset();\r\n        this._avgRemoteScreenPixels.reset();\r\n        this._avgLocalCameraPixels.reset();\r\n        this._avgLocalScreenPixels.reset();\r\n\r\n        this._avgCQ.reset();\r\n\r\n        this._sampleIdx = 0;\r\n    }\r\n\r\n    /**\r\n     * Unregisters all event listeners and stops working.\r\n     */\r\n    dispose() {\r\n        this._conference.off(\r\n            ConferenceEvents.P2P_STATUS,\r\n            this._onP2PStatusChanged);\r\n        this._conference.off(\r\n            ConnectionQualityEvents.LOCAL_STATS_UPDATED,\r\n            this._onLocalStatsUpdated);\r\n        this._conference.off(\r\n            ConferenceEvents.JVB121_STATUS,\r\n            this._onJvb121StatusChanged);\r\n        this.jvbStatsMonitor.dispose();\r\n        this.p2pStatsMonitor.dispose();\r\n    }\r\n}\r\n","import * as JitsiConferenceEvents from '../../JitsiConferenceEvents';\r\nimport XMPPEvents from '../../service/xmpp/XMPPEvents';\r\n\r\nimport SpeakerStats from './SpeakerStats';\r\n\r\n/**\r\n * A collection for tracking speaker stats. Attaches listeners\r\n * to the conference to automatically update on tracked events.\r\n */\r\nexport default class SpeakerStatsCollector {\r\n    /**\r\n     * Initializes a new SpeakerStatsCollector instance.\r\n     *\r\n     * @constructor\r\n     * @param {JitsiConference} conference - The conference to track.\r\n     * @returns {void}\r\n     */\r\n    constructor(conference) {\r\n        this.stats = {\r\n            users: {\r\n\r\n                // userId: SpeakerStats\r\n            },\r\n            dominantSpeakerId: null\r\n        };\r\n\r\n        const userId = conference.myUserId();\r\n\r\n        this.stats.users[userId] = new SpeakerStats(userId, null, true);\r\n        this.conference = conference;\r\n\r\n        conference.addEventListener(\r\n            JitsiConferenceEvents.DOMINANT_SPEAKER_CHANGED,\r\n            this._onDominantSpeaker.bind(this));\r\n        conference.addEventListener(\r\n            JitsiConferenceEvents.USER_JOINED,\r\n            this._onUserJoin.bind(this));\r\n        conference.addEventListener(\r\n            JitsiConferenceEvents.USER_LEFT,\r\n            this._onUserLeave.bind(this));\r\n        conference.addEventListener(\r\n            JitsiConferenceEvents.DISPLAY_NAME_CHANGED,\r\n            this._onDisplayNameChange.bind(this));\r\n        if (conference.xmpp) {\r\n            conference.xmpp.addListener(\r\n                XMPPEvents.SPEAKER_STATS_RECEIVED,\r\n                this._updateStats.bind(this));\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Reacts to dominant speaker change events by changing its speaker stats\r\n     * models to reflect the current dominant speaker.\r\n     *\r\n     * @param {string} dominantSpeakerId - The user id of the new\r\n     * dominant speaker.\r\n     * @returns {void}\r\n     * @private\r\n     */\r\n    _onDominantSpeaker(dominantSpeakerId) {\r\n        const oldDominantSpeaker\r\n            = this.stats.users[this.stats.dominantSpeakerId];\r\n        const newDominantSpeaker = this.stats.users[dominantSpeakerId];\r\n\r\n        oldDominantSpeaker && oldDominantSpeaker.setDominantSpeaker(false);\r\n        newDominantSpeaker && newDominantSpeaker.setDominantSpeaker(true);\r\n        this.stats.dominantSpeakerId = dominantSpeakerId;\r\n    }\r\n\r\n    /**\r\n     * Reacts to user join events by creating a new SpeakerStats model.\r\n     *\r\n     * @param {string} userId - The user id of the new user.\r\n     * @param {JitsiParticipant} - The JitsiParticipant model for the new user.\r\n     * @returns {void}\r\n     * @private\r\n     */\r\n    _onUserJoin(userId, participant) {\r\n        if (participant.isHidden()) {\r\n            return;\r\n        }\r\n\r\n        if (!this.stats.users[userId]) {\r\n            this.stats.users[userId] = new SpeakerStats(userId, participant.getDisplayName());\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Reacts to user leave events by updating the associated user's\r\n     * SpeakerStats model.\r\n     *\r\n     * @param {string} userId - The user id of the user that left.\r\n     * @returns {void}\r\n     * @private\r\n     */\r\n    _onUserLeave(userId) {\r\n        const savedUser = this.stats.users[userId];\r\n\r\n        if (savedUser) {\r\n            savedUser.markAsHasLeft();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Reacts to user name change events by updating the last known name\r\n     * tracked in the associated SpeakerStats model.\r\n     *\r\n     * @param {string} userId - The user id of the user that left.\r\n     * @returns {void}\r\n     * @private\r\n     */\r\n    _onDisplayNameChange(userId, newName) {\r\n        const savedUser = this.stats.users[userId];\r\n\r\n        if (savedUser) {\r\n            savedUser.setDisplayName(newName);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Return a copy of the tracked SpeakerStats models.\r\n     *\r\n     * @returns {Object} The keys are the user ids and the values are the\r\n     * associated user's SpeakerStats model.\r\n     * @private\r\n     */\r\n    getStats() {\r\n        return this.stats.users;\r\n    }\r\n\r\n    /**\r\n     * Updates of the current stats is requested, passing the new values.\r\n     *\r\n     * @param {Object} newStats - The new values used to update current one.\r\n     * @private\r\n     */\r\n    _updateStats(newStats) {\r\n        for (const userId in newStats) { // eslint-disable-line guard-for-in\r\n            let speakerStatsToUpdate;\r\n            const newParticipant = this.conference.getParticipantById(userId);\r\n\r\n            // we want to ignore hidden participants\r\n            if (!newParticipant || !newParticipant.isHidden()) {\r\n                if (this.stats.users[userId]) {\r\n                    speakerStatsToUpdate = this.stats.users[userId];\r\n\r\n                    if (!speakerStatsToUpdate.getDisplayName()) {\r\n                        speakerStatsToUpdate\r\n                            .setDisplayName(newStats[userId].displayName);\r\n                    }\r\n                } else {\r\n                    speakerStatsToUpdate = new SpeakerStats(\r\n                        userId, newStats[userId].displayName);\r\n                    this.stats.users[userId] = speakerStatsToUpdate;\r\n                    speakerStatsToUpdate.markAsHasLeft();\r\n                }\r\n            }\r\n\r\n            speakerStatsToUpdate.totalDominantSpeakerTime\r\n                = newStats[userId].totalDominantSpeakerTime;\r\n        }\r\n    }\r\n}\r\n","const AudioRecorder = require('./audioRecorder');\r\nconst SphinxService = require(\r\n    './transcriptionServices/SphinxTranscriptionService');\r\n\r\nconst BEFORE_STATE = 'before';\r\nconst RECORDING_STATE = 'recording';\r\nconst TRANSCRIBING_STATE = 'transcribing';\r\nconst FINISHED_STATE = 'finished';\r\n\r\n// the amount of characters each line in the transcription will have\r\nconst MAXIMUM_SENTENCE_LENGTH = 80;\r\n\r\n/**\r\n * This is the main object for handing the Transcription. It interacts with\r\n * the audioRecorder to record every person in a conference and sends the\r\n * recorder audio to a transcriptionService. The returned speech-to-text result\r\n * will be merged to create a transcript\r\n * @param {AudioRecorder} audioRecorder An audioRecorder recording a conference\r\n */\r\nfunction Transcriber() {\r\n    // the object which can record all audio in the conference\r\n    this.audioRecorder = new AudioRecorder();\r\n\r\n    // this object can send the recorder audio to a speech-to-text service\r\n    this.transcriptionService = new SphinxService();\r\n\r\n    // holds a counter to keep track if merging can start\r\n    this.counter = null;\r\n\r\n    // holds the date when transcription started which makes it possible\r\n    // to calculate the offset between recordings\r\n    this.startTime = null;\r\n\r\n    // will hold the transcription once it is completed\r\n    this.transcription = null;\r\n\r\n    // this will be a method which will be called once the transcription is done\r\n    // with the transcription as parameter\r\n    this.callback = null;\r\n\r\n    // stores all the retrieved speech-to-text results to merge together\r\n    // this value will store an Array<Word> object\r\n    this.results = [];\r\n\r\n    // Stores the current state of the transcription process\r\n    this.state = BEFORE_STATE;\r\n\r\n    // Used in the updateTranscription method to add a new line when the\r\n    // sentence becomes to long\r\n    this.lineLength = 0;\r\n}\r\n\r\n/**\r\n * Method to start the transcription process. It will tell the audioRecorder\r\n * to start storing all audio streams and record the start time for merging\r\n * purposes\r\n */\r\nTranscriber.prototype.start = function start() {\r\n    if (this.state !== BEFORE_STATE) {\r\n        throw new Error(\r\n            `The transcription can only start when it's in the \"${\r\n                BEFORE_STATE}\" state. It's currently in the \"${\r\n                this.state}\" state`);\r\n    }\r\n    this.state = RECORDING_STATE;\r\n    this.audioRecorder.start();\r\n    this.startTime = new Date();\r\n};\r\n\r\n/**\r\n * Method to stop the transcription process. It will tell the audioRecorder to\r\n * stop, and get all the recorded audio to send it to the transcription service\r\n\r\n * @param callback a callback which will receive the transcription\r\n */\r\nTranscriber.prototype.stop = function stop(callback) {\r\n    if (this.state !== RECORDING_STATE) {\r\n        throw new Error(\r\n            `The transcription can only stop when it's in the \"${\r\n                RECORDING_STATE}\" state. It's currently in the \"${\r\n                this.state}\" state`);\r\n    }\r\n\r\n    // stop the recording\r\n    console.log('stopping recording and sending audio files');\r\n    this.audioRecorder.stop();\r\n\r\n    // and send all recorded audio to the transcription service\r\n    const callBack = blobCallBack.bind(null, this);\r\n\r\n    this.audioRecorder.getRecordingResults().forEach(recordingResult => {\r\n        this.transcriptionService.send(recordingResult, callBack);\r\n        this.counter++;\r\n    });\r\n\r\n    // set the state to \"transcribing\" so that maybeMerge() functions correctly\r\n    this.state = TRANSCRIBING_STATE;\r\n\r\n    // and store the callback for later\r\n    this.callback = callback;\r\n};\r\n\r\n/**\r\n * This method gets the answer from the transcription service, calculates the\r\n * offset and adds is to every Word object. It will also start the merging\r\n * when every send request has been received\r\n *\r\n * note: Make sure to bind this as a Transcription object\r\n * @param {Transcriber} transcriber the transcriber instance\r\n * @param {RecordingResult} answer a RecordingResult object with a defined\r\n * WordArray\r\n */\r\nfunction blobCallBack(transcriber, answer) {\r\n    console.log(\r\n        'retrieved an answer from the transcription service. The answer has an'\r\n            + ` array of length: ${answer.wordArray.length}`);\r\n\r\n    // first add the offset between the start of the transcription and\r\n    // the start of the recording to all start and end times\r\n    if (answer.wordArray.length > 0) {\r\n        let offset = answer.startTime.getUTCMilliseconds()\r\n            - transcriber.startTime.getUTCMilliseconds();\r\n\r\n        // transcriber time will always be earlier\r\n\r\n        if (offset < 0) {\r\n            offset = 0; // presume 0 if it somehow not earlier\r\n        }\r\n\r\n        let array = '[';\r\n\r\n        answer.wordArray.forEach(wordObject => {\r\n            wordObject.begin += offset;\r\n            wordObject.end += offset;\r\n            array += `${wordObject.word},`;\r\n        });\r\n        array += ']';\r\n        console.log(array);\r\n\r\n        // give a name value to the Array object so that the merging can access\r\n        // the name value without having to use the whole recordingResult object\r\n        // in the algorithm\r\n        answer.wordArray.name = answer.name;\r\n    }\r\n\r\n    // then store the array and decrease the counter\r\n    transcriber.results.push(answer.wordArray);\r\n    transcriber.counter--;\r\n    console.log(`current counter: ${transcriber.counter}`);\r\n\r\n    // and check if all results have been received.\r\n    transcriber.maybeMerge();\r\n}\r\n\r\n/**\r\n * this method will check if the counter is zero. If it is, it will call\r\n * the merging method\r\n */\r\nTranscriber.prototype.maybeMerge = function() {\r\n    if (this.state === TRANSCRIBING_STATE && this.counter === 0) {\r\n        // make sure to include the events in the result arrays before\r\n        // merging starts\r\n        this.merge();\r\n    }\r\n};\r\n\r\n/**\r\n * This method will merge all speech-to-text arrays together in one\r\n * readable transcription string\r\n */\r\nTranscriber.prototype.merge = function() {\r\n    console.log(\r\n        `starting merge process!\\n The length of the array: ${\r\n            this.results.length}`);\r\n    this.transcription = '';\r\n\r\n    // the merging algorithm will look over all Word objects who are at pos 0 in\r\n    // every array. It will then select the one closest in time to the\r\n    // previously placed word, while removing the selected word from its array\r\n    // note: words can be skipped the skipped word's begin and end time somehow\r\n    // end up between the closest word start and end time\r\n    const arrays = this.results;\r\n\r\n    // arrays of Word objects\r\n    const potentialWords = []; // array of the first Word objects\r\n    // check if any arrays are already empty and remove them\r\n\r\n    hasPopulatedArrays(arrays);\r\n\r\n    // populate all the potential Words for a first time\r\n    arrays.forEach(array => pushWordToSortedArray(potentialWords, array));\r\n\r\n    // keep adding words to transcription until all arrays are exhausted\r\n    while (hasPopulatedArrays(arrays)) {\r\n        // first select the lowest array;\r\n        let lowestWordArray = arrays[0];\r\n\r\n        arrays.forEach(wordArray => {\r\n            if (wordArray[0].begin < lowestWordArray[0].begin) {\r\n                lowestWordArray = wordArray;\r\n            }\r\n        });\r\n\r\n        // put the word in the transcription\r\n        let wordToAdd = lowestWordArray.shift();\r\n\r\n        this.updateTranscription(wordToAdd, lowestWordArray.name);\r\n\r\n        // keep going until a word in another array has a smaller time\r\n        // or the array is empty\r\n        while (lowestWordArray.length > 0) {\r\n            let foundSmaller = false;\r\n            const wordToCompare = lowestWordArray[0].begin;\r\n\r\n            arrays.forEach(wordArray => {\r\n                if (wordArray[0].begin < wordToCompare) {\r\n                    foundSmaller = true;\r\n                }\r\n            });\r\n\r\n            // add next word if no smaller time has been found\r\n            if (foundSmaller) {\r\n                break;\r\n            }\r\n\r\n            wordToAdd = lowestWordArray.shift();\r\n            this.updateTranscription(wordToAdd, null);\r\n        }\r\n\r\n    }\r\n\r\n    // set the state to finished and do the necessary left-over tasks\r\n    this.state = FINISHED_STATE;\r\n    if (this.callback) {\r\n        this.callback(this.transcription);\r\n    }\r\n};\r\n\r\n/**\r\n * Appends a word object to the transcription. It will make a new line with a\r\n * name if a name is specified\r\n * @param {Word} word the Word object holding the word to append\r\n * @param {String|null} name the name of a new speaker. Null if not applicable\r\n */\r\nTranscriber.prototype.updateTranscription = function(word, name) {\r\n    if (name !== undefined && name !== null) {\r\n        this.transcription += `\\n${name}:`;\r\n        this.lineLength = name.length + 1; // +1 for the semi-colon\r\n    }\r\n    if (this.lineLength + word.word.length > MAXIMUM_SENTENCE_LENGTH) {\r\n        this.transcription += '\\n    ';\r\n        this.lineLength = 4; // because of the 4 spaces after the new line\r\n    }\r\n    this.transcription += ` ${word.word}`;\r\n    this.lineLength += word.word.length + 1; // +1 for the space\r\n};\r\n\r\n/**\r\n * Check if the given 2 dimensional array has any non-zero Word-arrays in them.\r\n * All zero-element arrays inside will be removed\r\n * If any non-zero-element arrays are found, the method will return true.\r\n * otherwise it will return false\r\n * @param {Array<Array>} twoDimensionalArray the array to check\r\n * @returns {boolean} true if any non-zero arrays inside, otherwise false\r\n */\r\nfunction hasPopulatedArrays(twoDimensionalArray) {\r\n    for (let i = 0; i < twoDimensionalArray.length; i++) {\r\n        if (twoDimensionalArray[i].length === 0) {\r\n            twoDimensionalArray.splice(i, 1);\r\n        }\r\n    }\r\n\r\n    return twoDimensionalArray.length > 0;\r\n}\r\n\r\n/**\r\n * Push a word to the right location in a sorted array. The array is sorted\r\n * from lowest to highest start time. Every word is stored in an object which\r\n * includes the name of the person saying the word.\r\n *\r\n * @param {Array<Word>} array the sorted array to push to\r\n * @param {Word} word the word to push into the array\r\n */\r\nfunction pushWordToSortedArray(array, word) {\r\n    if (array.length === 0) {\r\n        array.push(word);\r\n    } else {\r\n        if (array[array.length - 1].begin <= word.begin) {\r\n            array.push(word);\r\n\r\n            return;\r\n        }\r\n\r\n        for (let i = 0; i < array.length; i++) {\r\n            if (word.begin < array[i].begin) {\r\n                array.splice(i, 0, word);\r\n\r\n                return;\r\n            }\r\n        }\r\n        array.push(word); // fail safe\r\n    }\r\n}\r\n\r\n/**\r\n * Gives the transcriber a JitsiTrack holding an audioStream to transcribe.\r\n * The JitsiTrack is given to the audioRecorder. If it doesn't hold an\r\n * audiostream, it will not be added by the audioRecorder\r\n * @param {JitsiTrack} track the track to give to the audioRecorder\r\n */\r\nTranscriber.prototype.addTrack = function(track) {\r\n    this.audioRecorder.addTrack(track);\r\n};\r\n\r\n/**\r\n * Remove the given track from the auioRecorder\r\n * @param track\r\n */\r\nTranscriber.prototype.removeTrack = function(track) {\r\n    this.audioRecorder.removeTrack(track);\r\n};\r\n\r\n/**\r\n * Will return the created transcription if it's avialable or throw an error\r\n * when it's not done yet\r\n * @returns {String} the transcription as a String\r\n */\r\nTranscriber.prototype.getTranscription = function() {\r\n    if (this.state !== FINISHED_STATE) {\r\n        throw new Error(\r\n            `The transcription can only be retrieved when it's in the \"${\r\n                FINISHED_STATE}\" state. It's currently in the \"${\r\n                this.state}\" state`);\r\n    }\r\n\r\n    return this.transcription;\r\n};\r\n\r\n/**\r\n * Returns the current state of the transcription process\r\n */\r\nTranscriber.prototype.getState = function() {\r\n    return this.state;\r\n};\r\n\r\n/**\r\n * Resets the state to the \"before\" state, such that it's again possible to\r\n * call the start method\r\n */\r\nTranscriber.prototype.reset = function() {\r\n    this.state = BEFORE_STATE;\r\n    this.counter = null;\r\n    this.transcription = null;\r\n    this.startTime = null;\r\n    this.callback = null;\r\n    this.results = [];\r\n    this.lineLength = 0;\r\n};\r\n\r\nmodule.exports = Transcriber;\r\n","import Statistics from '../statistics/statistics';\r\n\r\nconst logger = require('jitsi-meet-logger').getLogger(__filename);\r\n\r\n/**\r\n * Creates new instance of <tt>ComponentsVersions</tt> which will be discovering\r\n * the versions of conferencing system components in given\r\n * <tt>JitsiConference</tt>.\r\n * @param conference <tt>JitsiConference</tt> instance which will be used to\r\n *        listen for focus presence updates.\r\n * @constructor\r\n */\r\nexport default function ComponentsVersions(conference) {\r\n\r\n    this.versions = {};\r\n\r\n    this.conference = conference;\r\n    this.conference.addCommandListener(\r\n        'versions', this.processVersions.bind(this));\r\n}\r\n\r\nComponentsVersions.prototype.processVersions\r\n    = function(versions, mucResource, mucJid) {\r\n        if (!this.conference._isFocus(mucJid)) {\r\n            logger.warn(\r\n                `Received versions not from the focus user: ${versions}`,\r\n                mucJid);\r\n\r\n            return;\r\n        }\r\n\r\n        const log = [];\r\n\r\n        versions.children.forEach(component => {\r\n\r\n            const name = component.attributes.name;\r\n            const version = component.value;\r\n\r\n            if (this.versions[name] !== version) {\r\n                this.versions[name] = version;\r\n                logger.info(`Got ${name} version: ${version}`);\r\n\r\n                log.push({\r\n                    id: 'component_version',\r\n                    component: name,\r\n                    version\r\n                });\r\n            }\r\n        });\r\n\r\n        // logs versions to stats\r\n        if (log.length > 0) {\r\n            Statistics.sendLog(JSON.stringify(log));\r\n        }\r\n    };\r\n\r\n/**\r\n * Obtains the version of conferencing system component.\r\n * @param componentName the name of the component for which we want to obtain\r\n *        the version.\r\n * @returns {String} which describes the version of the component identified by\r\n *          given <tt>componentName</tt> or <tt>undefined</tt> if not found.\r\n */\r\nComponentsVersions.prototype.getComponentVersion = function(componentName) {\r\n    return this.versions[componentName];\r\n};\r\n","import { getLogger } from 'jitsi-meet-logger';\r\nconst logger = getLogger(__filename);\r\n\r\nimport XMPPEvents from '../../service/xmpp/XMPPEvents';\r\n\r\nimport JitsiVideoSIPGWSession from './JitsiVideoSIPGWSession';\r\nimport * as Constants from './VideoSIPGWConstants';\r\n\r\n/**\r\n * Main video SIP GW handler. Stores references of all created sessions.\r\n */\r\nexport default class VideoSIPGW {\r\n\r\n    /**\r\n     * Creates new handler.\r\n     *\r\n     * @param {ChatRoom} chatRoom - Tha chat room to handle.\r\n     */\r\n    constructor(chatRoom) {\r\n        this.chatRoom = chatRoom;\r\n        this.eventEmitter = chatRoom.eventEmitter;\r\n        logger.debug('creating VideoSIPGW');\r\n        this.sessions = {};\r\n\r\n        this.sessionStateChangeListener = this.sessionStateChanged.bind(this);\r\n\r\n        // VideoSIPGW, JitsiConference and ChatRoom are not reusable and no\r\n        // more than one VideoSIPGW can be created per JitsiConference,\r\n        // so we don't bother to cleanup\r\n        chatRoom.addPresenceListener('jibri-sip-call-state',\r\n            this.handleJibriSIPState.bind(this));\r\n    }\r\n\r\n    /**\r\n     * Handles presence nodes with name: jibri-sip-call-state.\r\n     *\r\n     * @param {Object} node the presence node Object to handle.\r\n     * Object representing part of the presence received over xmpp.\r\n     */\r\n    handleJibriSIPState(node) {\r\n        const attributes = node.attributes;\r\n\r\n        if (!attributes) {\r\n            return;\r\n        }\r\n\r\n        logger.debug('Handle video sip gw state : ', attributes);\r\n\r\n        const newState = attributes.state;\r\n\r\n        if (newState === this.state) {\r\n            return;\r\n        }\r\n\r\n        switch (newState) {\r\n        case Constants.STATE_ON:\r\n        case Constants.STATE_OFF:\r\n        case Constants.STATE_PENDING:\r\n        case Constants.STATE_RETRYING:\r\n        case Constants.STATE_FAILED: {\r\n            const address = attributes.sipaddress;\r\n\r\n            if (!address) {\r\n                return;\r\n            }\r\n\r\n            // find the corresponding session and set its state\r\n            const session = this.sessions[address];\r\n\r\n            if (session) {\r\n                session.setState(newState, attributes.failure_reason);\r\n            } else {\r\n                logger.warn('Video SIP GW session not found:', address);\r\n            }\r\n        }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Creates new session and stores its reference if it does not exist or\r\n     * returns an error otherwise.\r\n     *\r\n     * @param {string} sipAddress - The sip address to use.\r\n     * @param {string} displayName - The display name to use.\r\n     * @returns {JitsiVideoSIPGWSession|Error}\r\n     */\r\n    createVideoSIPGWSession(sipAddress, displayName) {\r\n        if (this.sessions[sipAddress]) {\r\n            logger.warn('There was already a Video SIP GW session for address',\r\n                sipAddress);\r\n\r\n            return new Error(Constants.ERROR_SESSION_EXISTS);\r\n        }\r\n\r\n        const session = new JitsiVideoSIPGWSession(\r\n            sipAddress, displayName, this.chatRoom);\r\n\r\n        session.addStateListener(this.sessionStateChangeListener);\r\n\r\n        this.sessions[sipAddress] = session;\r\n\r\n        return session;\r\n    }\r\n\r\n    /**\r\n     * Listener for session state changed. When a session goes to off or failed\r\n     * we delete its reference.\r\n     *\r\n     * @param {options} event - { address, oldState, newState, displayName }\r\n     */\r\n    sessionStateChanged(event) {\r\n        const address = event.address;\r\n\r\n        if (event.newState === Constants.STATE_OFF\r\n            || event.newState === Constants.STATE_FAILED) {\r\n            const session = this.sessions[address];\r\n\r\n            if (!session) {\r\n                logger.error('Missing Video SIP GW session with address:',\r\n                    address);\r\n\r\n                return;\r\n            }\r\n\r\n            session.removeStateListener(this.sessionStateChangeListener);\r\n            delete this.sessions[address];\r\n        }\r\n\r\n        this.eventEmitter.emit(\r\n            XMPPEvents.VIDEO_SIP_GW_SESSION_STATE_CHANGED,\r\n            event);\r\n    }\r\n}\r\n","import { getLogger } from 'jitsi-meet-logger';\r\nimport { $iq } from 'strophe.js';\r\n\r\nimport Listenable from '../util/Listenable';\r\n\r\nimport * as VideoSIPGWConstants from './VideoSIPGWConstants';\r\n\r\nconst logger = getLogger(__filename);\r\n\r\n/**\r\n * The event name for current sip video session state changed.\r\n * @type {string} event name for sip video session state changed.\r\n */\r\nconst STATE_CHANGED = 'STATE_CHANGED';\r\n\r\n/**\r\n * Jitsi video SIP GW session. Holding its state and able to start/stop it.\r\n * When session is in OFF or FAILED stated it cannot be used anymore.\r\n */\r\nexport default class JitsiVideoSIPGWSession extends Listenable {\r\n\r\n    /**\r\n     * Creates new session with the desired sip address and display name.\r\n     *\r\n     * @param {string} sipAddress - The sip address to use when\r\n     * starting the session.\r\n     * @param {string} displayName - The display name to use for\r\n     * that participant.\r\n     * @param {ChatRoom} chatRoom - The chat room this session is bound to.\r\n     */\r\n    constructor(sipAddress, displayName, chatRoom) {\r\n        super();\r\n\r\n        this.sipAddress = sipAddress;\r\n        this.displayName = displayName;\r\n        this.chatRoom = chatRoom;\r\n\r\n        /*\r\n         * The initial state is undefined. Initial state cannot be STATE_OFF,\r\n         * the session enters this state when it was in STATE_ON and was stopped\r\n         * and such session cannot be used anymore.\r\n         *\r\n         * @type {VideoSIPGWConstants|undefined}\r\n         */\r\n        this.state = undefined;\r\n    }\r\n\r\n    /**\r\n     * Stops the current session.\r\n     */\r\n    stop() {\r\n        if (this.state === VideoSIPGWConstants.STATE_OFF\r\n            || this.state === VideoSIPGWConstants.STATE_FAILED) {\r\n            logger.warn('Video SIP GW session already stopped or failed!');\r\n\r\n            return;\r\n        }\r\n\r\n        this._sendJibriIQ('stop');\r\n    }\r\n\r\n    /**\r\n     * Starts a new session. Sends an iq to the focus.\r\n     */\r\n    start() {\r\n        // if state is off, this session was active for some reason\r\n        // and we should create new one, rather than reusing it\r\n        if (this.state === VideoSIPGWConstants.STATE_ON\r\n            || this.state === VideoSIPGWConstants.STATE_OFF\r\n            || this.state === VideoSIPGWConstants.STATE_PENDING\r\n            || this.state === VideoSIPGWConstants.STATE_RETRYING) {\r\n            logger.warn('Video SIP GW session already started!');\r\n\r\n            return;\r\n        }\r\n\r\n        this._sendJibriIQ('start');\r\n    }\r\n\r\n    /**\r\n     * Changes the state of this session.\r\n     *\r\n     * @param {string} newState - The new {VideoSIPGWConstants} state to set.\r\n     * @param {string} [optional] failureReason - The reason why a failure state\r\n     * was entered.\r\n     * @returns {void}\r\n     */\r\n    setState(newState, failureReason) {\r\n        if (newState === this.state) {\r\n            return;\r\n        }\r\n\r\n        const oldState = this.state;\r\n\r\n        this.state = newState;\r\n        this.eventEmitter.emit(STATE_CHANGED,\r\n            {\r\n                address: this.sipAddress,\r\n                failureReason,\r\n                oldState,\r\n                newState: this.state,\r\n                displayName: this.displayName\r\n            }\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Subscribes the passed listener to the event for state change of this\r\n     * session.\r\n     *\r\n     * @param {Function} listener - The function that will receive the event.\r\n     */\r\n    addStateListener(listener) {\r\n        this.addListener(STATE_CHANGED, listener);\r\n    }\r\n\r\n    /**\r\n     * Unsubscribes the passed handler.\r\n     *\r\n     * @param {Function} listener - The function to be removed.\r\n     */\r\n    removeStateListener(listener) {\r\n        this.removeListener(STATE_CHANGED, listener);\r\n    }\r\n\r\n    /**\r\n     * Sends a jibri command using an iq.\r\n     *\r\n     * @private\r\n     * @param {string} action - The action to send ('start' or 'stop').\r\n     */\r\n    _sendJibriIQ(action) {\r\n        const attributes = {\r\n            'xmlns': 'http://jitsi.org/protocol/jibri',\r\n            'action': action,\r\n            sipaddress: this.sipAddress\r\n        };\r\n\r\n        attributes.displayname = this.displayName;\r\n\r\n        const iq = $iq({\r\n            to: this.chatRoom.focusMucJid,\r\n            type: 'set' })\r\n            .c('jibri', attributes)\r\n            .up();\r\n\r\n        logger.debug(`${action} video SIP GW session`, iq.nodeTree);\r\n        this.chatRoom.connection.sendIQ(\r\n            iq,\r\n            () => {}, // eslint-disable-line no-empty-function\r\n            error => {\r\n                logger.error(\r\n                    `Failed to ${action} video SIP GW session, error: `, error);\r\n                this.setState(VideoSIPGWConstants.STATE_FAILED);\r\n            });\r\n    }\r\n}\r\n","import { getLogger } from 'jitsi-meet-logger';\r\n\r\nimport * as JitsiTrackEvents from '../../JitsiTrackEvents';\r\nimport RTC from '../RTC/RTC';\r\nimport Statistics from '../statistics/statistics';\r\n\r\n\r\nconst logger = getLogger(__filename);\r\n\r\n// If after 3000 ms the detector did not find any active devices consider that there aren't any usable ones available\r\n// i.e. audioLevel > 0.008\r\nconst DETECTION_TIMEOUT = 3000;\r\n\r\n\r\n/**\r\n * Go through all audio devices on the system and return one that is active, i.e. has audio signal.\r\n *\r\n * @returns Promise<Object> - Object containing information about the found device.\r\n */\r\nexport default function getActiveAudioDevice() {\r\n\r\n    return new Promise(resolve => {\r\n        RTC.enumerateDevices(devices => {\r\n            const audioDevices = devices.filter(device => device.kind === 'audioinput');\r\n            const devicePromiseArray = [];\r\n\r\n\r\n            for (const micDevice of audioDevices) {\r\n                const devicePromise = RTC.obtainAudioAndVideoPermissions({ devices: [ 'audio' ],\r\n                    micDeviceId: micDevice.deviceId }).then(tracks => {\r\n\r\n                    // We expect a single device to be available when obtained from obtainAudioAndVideoPermissions\r\n                    // that's  why only take p.value[0].\r\n                    const track = tracks[0];\r\n                    const originalStream = track.getOriginalStream();\r\n\r\n                    Statistics.startLocalStats(originalStream, track.setAudioLevel.bind(track));\r\n                    track.addEventListener(JitsiTrackEvents.LOCAL_TRACK_STOPPED, () => {\r\n                        Statistics.stopLocalStats(originalStream);\r\n                    });\r\n\r\n                    return track;\r\n                });\r\n\r\n                devicePromiseArray.push(devicePromise);\r\n            }\r\n\r\n            Promise.allSettled(devicePromiseArray).then(outcomeArray => {\r\n                const successfulPromises = outcomeArray.filter(p => p.status === 'fulfilled');\r\n                const rejectedPromises = outcomeArray.filter(p => p.status === 'rejected');\r\n\r\n\r\n                const availableDevices = successfulPromises.map(p => p.value);\r\n                const rejectReasons = rejectedPromises.map(p => p.value);\r\n\r\n                for (const reason of rejectReasons) {\r\n                    logger.error('Failed to acquire audio device with error: ', reason);\r\n                }\r\n\r\n                // Setup event handlers for monitored devices.\r\n                for (const device of availableDevices) {\r\n                    device.on(JitsiTrackEvents.TRACK_AUDIO_LEVEL_CHANGED, audioLevel => {\r\n                        // This is a very naive approach but works, a more accurate one would be to use rnnoise in\r\n                        // order to limit  the number of false positives. The 0.008 constant is due to how\r\n                        // LocalStatsCollector from lib-jitsi-meet publishes audio-levels, in this case 0.008 denotes //\r\n                        // no input.\r\n                        if (audioLevel > 0.008) {\r\n                            stopActiveDevices(availableDevices);\r\n                            resolve({ deviceId: device.deviceId,\r\n                                deviceLabel: device.track.label });\r\n                        }\r\n                    });\r\n                }\r\n\r\n                // Cancel the detection in case no devices was found with audioLevel > 0 in the set timeout.\r\n                setTimeout(() => {\r\n                    stopActiveDevices(availableDevices);\r\n                    resolve({\r\n                        deviceId: '',\r\n                        deviceLabel: '' }\r\n                    );\r\n                }, DETECTION_TIMEOUT);\r\n\r\n            });\r\n\r\n        });\r\n    });\r\n}\r\n\r\n/**\r\n * Stop the streams of the provided JitsiLocalTracks.\r\n *\r\n * @param {Array<JitsiLocalTrack>} deviceList - Array of JitsiLocalTracks to stop.\r\n * @returns {void}\r\n */\r\nfunction stopActiveDevices(deviceList) {\r\n    for (const device of deviceList) {\r\n        device.stopStream();\r\n    }\r\n}\r\n","/* globals $ */\r\n\r\nimport { getLogger } from 'jitsi-meet-logger';\r\nimport { $iq } from 'strophe.js';\r\n\r\nimport * as MediaType from '../../service/RTC/MediaType';\r\nimport VideoType from '../../service/RTC/VideoType';\r\nimport RTC from '../RTC/RTC';\r\n\r\nimport ProxyConnectionPC from './ProxyConnectionPC';\r\nimport { ACTIONS } from './constants';\r\n\r\nconst logger = getLogger(__filename);\r\n\r\n/**\r\n * Instantiates a new ProxyConnectionPC and ensures only one exists at a given\r\n * time. Currently it assumes ProxyConnectionPC is used only for screensharing\r\n * and assumes IQs to be used for communication.\r\n */\r\nexport default class ProxyConnectionService {\r\n    /**\r\n     * Initializes a new {@code ProxyConnectionService} instance.\r\n     *\r\n     * @param {Object} options - Values to initialize the instance with.\r\n     * @param {boolean} [options.convertVideoToDesktop] - Whether or not proxied\r\n     * video should be returned as a desktop stream. Defaults to false.\r\n     * @param {Object} [options.iceConfig] - The {@code RTCConfiguration} to use\r\n     * for the peer connection.\r\n     * @param {JitsiConnection} [options.jitsiConnection] - The\r\n     * {@code JitsiConnection} which will be used to fetch TURN credentials for\r\n     * the P2P connection.\r\n     * @param {Function} options.onRemoteStream - Callback to invoke when a\r\n     * remote video stream has been received and converted to a\r\n     * {@code JitsiLocakTrack}. The {@code JitsiLocakTrack} will be passed in.\r\n     * @param {Function} options.onSendMessage - Callback to invoke when a\r\n     * message has to be sent (signaled) out. The arguments passed in are the\r\n     * jid to send the message to and the message\r\n     */\r\n    constructor(options = {}) {\r\n        const {\r\n            jitsiConnection,\r\n            ...otherOptions\r\n        } = options;\r\n\r\n        /**\r\n         * Holds a reference to the collection of all callbacks.\r\n         *\r\n         * @type {Object}\r\n         */\r\n        this._options = {\r\n            iceConfig: jitsiConnection\r\n                && jitsiConnection.xmpp.connection.jingle.p2pIceConfig,\r\n            ...otherOptions\r\n        };\r\n\r\n        /**\r\n         * The active instance of {@code ProxyConnectionService}.\r\n         *\r\n         * @type {ProxyConnectionPC|null}\r\n         */\r\n        this._peerConnection = null;\r\n\r\n        // Bind event handlers so they are only bound once for every instance.\r\n        this._onFatalError = this._onFatalError.bind(this);\r\n        this._onSendMessage = this._onSendMessage.bind(this);\r\n        this._onRemoteStream = this._onRemoteStream.bind(this);\r\n    }\r\n\r\n    /**\r\n     * Parses a message object regarding a proxy connection to create a new\r\n     * proxy connection or update and existing connection.\r\n     *\r\n     * @param {Object} message - A message object regarding establishing or\r\n     * updating a proxy connection.\r\n     * @param {Object} message.data - An object containing additional message\r\n     * details.\r\n     * @param {string} message.data.iq - The stringified iq which explains how\r\n     * and what to update regarding the proxy connection.\r\n     * @param {string} message.from - The message sender's full jid. Used for\r\n     * sending replies.\r\n     * @returns {void}\r\n     */\r\n    processMessage(message) {\r\n        const peerJid = message.from;\r\n\r\n        if (!peerJid) {\r\n            return;\r\n        }\r\n\r\n        // If a proxy connection has already been established and messages come\r\n        // from another peer jid then those messages should be replied to with\r\n        // a rejection.\r\n        if (this._peerConnection\r\n            && this._peerConnection.getPeerJid() !== peerJid) {\r\n            this._onFatalError(\r\n                peerJid,\r\n                ACTIONS.CONNECTION_ERROR,\r\n                'rejected'\r\n            );\r\n\r\n            return;\r\n        }\r\n\r\n        const iq = this._convertStringToXML(message.data.iq);\r\n        const $jingle = iq && iq.find('jingle');\r\n        const action = $jingle && $jingle.attr('action');\r\n\r\n        if (action === ACTIONS.INITIATE) {\r\n            this._peerConnection = this._createPeerConnection(peerJid, {\r\n                isInitiator: false,\r\n                receiveVideo: true\r\n            });\r\n        }\r\n\r\n        // Truthy check for peer connection added to protect against possibly\r\n        // receiving actions before an ACTIONS.INITIATE.\r\n        if (this._peerConnection) {\r\n            this._peerConnection.processMessage($jingle);\r\n        }\r\n\r\n        // Take additional steps to ensure the peer connection is cleaned up\r\n        // if it is to be closed.\r\n        if (action === ACTIONS.CONNECTION_ERROR\r\n            || action === ACTIONS.UNAVAILABLE\r\n            || action === ACTIONS.TERMINATE) {\r\n            this._selfCloseConnection();\r\n        }\r\n\r\n        return;\r\n    }\r\n\r\n    /**\r\n     * Instantiates and initiates a proxy peer connection.\r\n     *\r\n     * @param {string} peerJid - The jid of the remote client that should\r\n     * receive messages.\r\n     * @param {Array<JitsiLocalTrack>} localTracks - Initial media tracks to\r\n     * send through to the peer.\r\n     * @returns {void}\r\n     */\r\n    start(peerJid, localTracks = []) {\r\n        this._peerConnection = this._createPeerConnection(peerJid, {\r\n            isInitiator: true,\r\n            receiveVideo: false\r\n        });\r\n\r\n        this._peerConnection.start(localTracks);\r\n    }\r\n\r\n    /**\r\n     * Terminates any active proxy peer connection.\r\n     *\r\n     * @returns {void}\r\n     */\r\n    stop() {\r\n        if (this._peerConnection) {\r\n            this._peerConnection.stop();\r\n        }\r\n\r\n        this._peerConnection = null;\r\n    }\r\n\r\n    /**\r\n     * Transforms a stringified xML into a XML wrapped in jQuery.\r\n     *\r\n     * @param {string} xml - The XML in string form.\r\n     * @private\r\n     * @returns {Object|null} A jQuery version of the xml. Null will be returned\r\n     * if an error is encountered during transformation.\r\n     */\r\n    _convertStringToXML(xml) {\r\n        try {\r\n            const xmlDom = new DOMParser().parseFromString(xml, 'text/xml');\r\n\r\n            return $(xmlDom);\r\n        } catch (e) {\r\n            logger.error('Attempted to convert incorrectly formatted xml');\r\n\r\n            return null;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Helper for creating an instance of {@code ProxyConnectionPC}.\r\n     *\r\n     * @param {string} peerJid - The jid of the remote peer with which the\r\n     * {@code ProxyConnectionPC} will be established with.\r\n     * @param {Object} options - Additional defaults to instantiate the\r\n     * {@code ProxyConnectionPC} with. See the constructor of ProxyConnectionPC\r\n     * for more details.\r\n     * @private\r\n     * @returns {ProxyConnectionPC}\r\n     */\r\n    _createPeerConnection(peerJid, options = {}) {\r\n        if (!peerJid) {\r\n            throw new Error('Cannot create ProxyConnectionPC without a peer.');\r\n        }\r\n\r\n        const pcOptions = {\r\n            iceConfig: this._options.iceConfig,\r\n            onError: this._onFatalError,\r\n            onRemoteStream: this._onRemoteStream,\r\n            onSendMessage: this._onSendMessage,\r\n            peerJid,\r\n            ...options\r\n        };\r\n\r\n        return new ProxyConnectionPC(pcOptions);\r\n    }\r\n\r\n    /**\r\n     * Callback invoked when an error occurs that should cause\r\n     * {@code ProxyConnectionPC} to be closed if the peer is currently\r\n     * connected. Sends an error message/reply back to the peer.\r\n     *\r\n     * @param {string} peerJid - The peer jid with which the connection was\r\n     * attempted or started, and to which an iq with error details should be\r\n     * sent.\r\n     * @param {string} errorType - The constant indicating the type of the error\r\n     * that occured.\r\n     * @param {string} details - Optional additional data about the error.\r\n     * @private\r\n     * @returns {void}\r\n     */\r\n    _onFatalError(peerJid, errorType, details = '') {\r\n        logger.error(\r\n            'Received a proxy connection error', peerJid, errorType, details);\r\n\r\n        const iq = $iq({\r\n            to: peerJid,\r\n            type: 'set'\r\n        })\r\n            .c('jingle', {\r\n                xmlns: 'urn:xmpp:jingle:1',\r\n                action: errorType\r\n            })\r\n            .c('details')\r\n            .t(details)\r\n            .up();\r\n\r\n        this._onSendMessage(peerJid, iq);\r\n\r\n        if (this._peerConnection\r\n            && this._peerConnection.getPeerJid() === peerJid) {\r\n            this._selfCloseConnection();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Callback invoked when the remote peer of the {@code ProxyConnectionPC}\r\n     * has offered a media stream. The stream is converted into a\r\n     * {@code JitsiLocalTrack} for local usage if the {@code onRemoteStream}\r\n     * callback is defined.\r\n     *\r\n     * @param {JitsiRemoteTrack} jitsiRemoteTrack - The {@code JitsiRemoteTrack}\r\n     * for the peer's media stream.\r\n     * @private\r\n     * @returns {void}\r\n     */\r\n    _onRemoteStream(jitsiRemoteTrack) {\r\n        if (!this._options.onRemoteStream) {\r\n            logger.error('Remote track received without callback.');\r\n            jitsiRemoteTrack.dispose();\r\n\r\n            return;\r\n        }\r\n\r\n        const isVideo = jitsiRemoteTrack.isVideoTrack();\r\n        let videoType;\r\n\r\n        if (isVideo) {\r\n            videoType = this._options.convertVideoToDesktop\r\n                ? VideoType.DESKTOP : VideoType.CAMERA;\r\n        }\r\n\r\n        // Grab the webrtc media stream and pipe it through the same processing\r\n        // that would occur for a locally obtained media stream.\r\n        const mediaStream = jitsiRemoteTrack.getOriginalStream();\r\n        const jitsiLocalTracks = RTC.createLocalTracks(\r\n            [\r\n                {\r\n                    deviceId:\r\n                        `proxy:${this._peerConnection.getPeerJid()}`,\r\n                    mediaType: isVideo ? MediaType.VIDEO : MediaType.AUDIO,\r\n                    sourceType: 'proxy',\r\n                    stream: mediaStream,\r\n                    track: mediaStream.getVideoTracks()[0],\r\n                    videoType\r\n                }\r\n            ]);\r\n\r\n        this._options.onRemoteStream(jitsiLocalTracks[0]);\r\n    }\r\n\r\n    /**\r\n     * Formats and forwards a message an iq to be sent to a peer jid.\r\n     *\r\n     * @param {string} peerJid - The jid the iq should be sent to.\r\n     * @param {Object} iq - The iq which would be sent to the peer jid.\r\n     * @private\r\n     * @returns {void}\r\n     */\r\n    _onSendMessage(peerJid, iq) {\r\n        if (!this._options.onSendMessage) {\r\n            return;\r\n        }\r\n\r\n        try {\r\n            const stringifiedIq\r\n                = new XMLSerializer().serializeToString(iq.nodeTree || iq);\r\n\r\n            this._options.onSendMessage(peerJid, { iq: stringifiedIq });\r\n        } catch (e) {\r\n            logger.error('Attempted to send an incorrectly formatted iq.');\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Invoked when preemptively closing the {@code ProxyConnectionPC}.\r\n     *\r\n     * @private\r\n     * @returns {void}\r\n     */\r\n    _selfCloseConnection() {\r\n        this.stop();\r\n\r\n        this._options.onConnectionClosed\r\n            && this._options.onConnectionClosed();\r\n    }\r\n}\r\n","import { getLogger } from 'jitsi-meet-logger';\r\n\r\nimport RTCEvents from '../../service/RTC/RTCEvents';\r\nimport XMPPEvents from '../../service/xmpp/XMPPEvents';\r\nimport RTC from '../RTC/RTC';\r\nimport JingleSessionPC from '../xmpp/JingleSessionPC';\r\nimport { DEFAULT_STUN_SERVERS } from '../xmpp/xmpp';\r\n\r\nimport { ACTIONS } from './constants';\r\n\r\nconst logger = getLogger(__filename);\r\n\r\n/**\r\n * An adapter around {@code JingleSessionPC} so its logic can be re-used without\r\n * an XMPP connection. It is being re-used for consistency with the rest of the\r\n * codebase and to leverage existing peer connection event handling. Also\r\n * this class provides a facade to hide most of the API for\r\n * {@code JingleSessionPC}.\r\n */\r\nexport default class ProxyConnectionPC {\r\n    /**\r\n     * Initializes a new {@code ProxyConnectionPC} instance.\r\n     *\r\n     * @param {Object} options - Values to initialize the instance with.\r\n     * @param {Object} [options.iceConfig] - The {@code RTCConfiguration} to use\r\n     * for the peer connection.\r\n     * @param {boolean} [options.isInitiator] - If true, the local client should\r\n     * send offers. If false, the local client should send answers. Defaults to\r\n     * false.\r\n     * @param {Function} options.onRemoteStream - Callback to invoke when a\r\n     * remote media stream has been received through the peer connection.\r\n     * @param {string} options.peerJid - The jid of the remote client with which\r\n     * the peer connection is being establish and which should receive direct\r\n     * messages regarding peer connection updates.\r\n     * @param {boolean} [options.receiveVideo] - Whether or not the peer\r\n     * connection should accept incoming video streams. Defaults to false.\r\n     * @param {Function} options.onSendMessage - Callback to invoke when a\r\n     * message has to be sent (signaled) out.\r\n     */\r\n    constructor(options = {}) {\r\n        this._options = {\r\n            iceConfig: {},\r\n            isInitiator: false,\r\n            receiveAudio: false,\r\n            receiveVideo: false,\r\n            ...options\r\n        };\r\n\r\n        /**\r\n         * Instances of {@code JitsiTrack} associated with this instance of\r\n         * {@code ProxyConnectionPC}.\r\n         *\r\n         * @type {Array<JitsiTrack>}\r\n         */\r\n        this._tracks = [];\r\n\r\n        /**\r\n         * The active instance of {@code JingleSessionPC}.\r\n         *\r\n         * @type {JingleSessionPC|null}\r\n         */\r\n        this._peerConnection = null;\r\n\r\n        // Bind event handlers so they are only bound once for every instance.\r\n        this._onError = this._onError.bind(this);\r\n        this._onRemoteStream = this._onRemoteStream.bind(this);\r\n        this._onSendMessage = this._onSendMessage.bind(this);\r\n    }\r\n\r\n    /**\r\n     * Returns the jid of the remote peer with which this peer connection should\r\n     * be established with.\r\n     *\r\n     * @returns {string}\r\n     */\r\n    getPeerJid() {\r\n        return this._options.peerJid;\r\n    }\r\n\r\n    /**\r\n     * Updates the peer connection based on the passed in jingle.\r\n     *\r\n     * @param {Object} $jingle - An XML jingle element, wrapped in query,\r\n     * describing how the peer connection should be updated.\r\n     * @returns {void}\r\n     */\r\n    processMessage($jingle) {\r\n        switch ($jingle.attr('action')) {\r\n        case ACTIONS.ACCEPT:\r\n            this._onSessionAccept($jingle);\r\n            break;\r\n\r\n        case ACTIONS.INITIATE:\r\n            this._onSessionInitiate($jingle);\r\n            break;\r\n\r\n        case ACTIONS.TERMINATE:\r\n            this._onSessionTerminate($jingle);\r\n            break;\r\n\r\n        case ACTIONS.TRANSPORT_INFO:\r\n            this._onTransportInfo($jingle);\r\n            break;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Instantiates a peer connection and starts the offer/answer cycle to\r\n     * establish a connection with a remote peer.\r\n     *\r\n     * @param {Array<JitsiLocalTrack>} localTracks - Initial local tracks to add\r\n     * to add to the peer connection.\r\n     * @returns {void}\r\n     */\r\n    start(localTracks = []) {\r\n        if (this._peerConnection) {\r\n            return;\r\n        }\r\n\r\n        this._tracks = this._tracks.concat(localTracks);\r\n\r\n        this._peerConnection = this._createPeerConnection();\r\n\r\n        this._peerConnection.invite(localTracks);\r\n    }\r\n\r\n    /**\r\n     * Begins the process of disconnecting from a remote peer and cleaning up\r\n     * the peer connection.\r\n     *\r\n     * @returns {void}\r\n     */\r\n    stop() {\r\n        if (this._peerConnection) {\r\n            this._peerConnection.terminate();\r\n        }\r\n\r\n        this._onSessionTerminate();\r\n    }\r\n\r\n    /**\r\n     * Instantiates a new {@code JingleSessionPC} by stubbing out the various\r\n     * dependencies of {@code JingleSessionPC}.\r\n     *\r\n     * @private\r\n     * @returns {JingleSessionPC}\r\n     */\r\n    _createPeerConnection() {\r\n        /**\r\n         * {@code JingleSessionPC} takes in the entire jitsi-meet config.js\r\n         * object, which may not be accessible from the caller.\r\n         *\r\n         * @type {Object}\r\n         */\r\n        const configStub = {};\r\n\r\n        /**\r\n         * {@code JingleSessionPC} assumes an XMPP/Strophe connection object is\r\n         * passed through, which also has the jingle plugin initialized on it.\r\n         * This connection object is used to signal out peer connection updates\r\n         * via iqs, and those updates need to be piped back out to the remote\r\n         * peer.\r\n         *\r\n         * @type {Object}\r\n         */\r\n        const connectionStub = {\r\n            // At the time this is used for Spot and it's okay to say the connection is always connected, because if\r\n            // spot has no signalling it will not be in a meeting where this is used.\r\n            connected: true,\r\n            jingle: {\r\n                terminate: () => { /** no-op */ }\r\n            },\r\n            sendIQ: this._onSendMessage,\r\n\r\n            // Returns empty function, because it does not add any listeners for real\r\n            // eslint-disable-next-line no-empty-function\r\n            addEventListener: () => () => { }\r\n        };\r\n\r\n        /**\r\n         * {@code JingleSessionPC} can take in a custom ice configuration,\r\n         * depending on the peer connection type, peer-to-peer or other.\r\n         * However, {@code ProxyConnectionPC} always assume a peer-to-peer\r\n         * connection so the ice configuration is hard-coded with defaults.\r\n         *\r\n         * @type {Object}\r\n         */\r\n        const iceConfigStub = {\r\n            iceServers: DEFAULT_STUN_SERVERS,\r\n            ...this._options.iceConfig\r\n        };\r\n\r\n        /**\r\n         * {@code JingleSessionPC} expects an instance of\r\n         * {@code JitsiConference}, which has an event emitter that is used\r\n         * to signal various connection updates that the local client should\r\n         * act upon. The conference instance is not a dependency of a proxy\r\n         * connection, but the emitted events can be relevant to the proxy\r\n         * connection so the event emitter is stubbed.\r\n         *\r\n         * @param {string} event - The constant for the event type.\r\n         * @type {Function}\r\n         * @returns {void}\r\n         */\r\n        const emitter = event => {\r\n            switch (event) {\r\n            case XMPPEvents.CONNECTION_ICE_FAILED:\r\n            case XMPPEvents.CONNECTION_FAILED:\r\n                this._onError(ACTIONS.CONNECTION_ERROR, event);\r\n                break;\r\n            }\r\n        };\r\n\r\n        /**\r\n         * {@link JingleSessionPC} expects an instance of\r\n         * {@link ChatRoom} to be passed in. {@link ProxyConnectionPC}\r\n         * is instantiated outside of the {@code JitsiConference}, so it must be\r\n         * stubbed to prevent errors.\r\n         *\r\n         * @type {Object}\r\n         */\r\n        const roomStub = {\r\n            addPresenceListener: () => { /** no-op */ },\r\n            connectionTimes: [],\r\n            eventEmitter: { emit: emitter },\r\n            getMediaPresenceInfo: () => {\r\n                // Errors occur if this function does not return an object\r\n\r\n                return {};\r\n            },\r\n            removePresenceListener: () => { /** no-op */ }\r\n        };\r\n\r\n        /**\r\n         * A {@code JitsiConference} stub passed to the {@link RTC} module.\r\n         * @type {Object}\r\n         */\r\n        const conferenceStub = {};\r\n\r\n        /**\r\n         * Create an instance of {@code RTC} as it is required for peer\r\n         * connection creation by {@code JingleSessionPC}. An existing instance\r\n         * of {@code RTC} from elsewhere should not be re-used because it is\r\n         * a stateful grouping of utilities.\r\n         */\r\n        this._rtc = new RTC(conferenceStub, {});\r\n\r\n        /**\r\n         * Add the remote track listener here as {@code JingleSessionPC} has\r\n         * {@code TraceablePeerConnection} which uses {@code RTC}'s event\r\n         * emitter.\r\n         */\r\n        this._rtc.addListener(\r\n            RTCEvents.REMOTE_TRACK_ADDED,\r\n            this._onRemoteStream\r\n        );\r\n\r\n        const peerConnection = new JingleSessionPC(\r\n            undefined, // sid\r\n            undefined, // localJid\r\n            this._options.peerJid, // remoteJid\r\n            connectionStub, // connection\r\n            {\r\n                offerToReceiveAudio: this._options.receiveAudio,\r\n                offerToReceiveVideo: this._options.receiveVideo\r\n            }, // mediaConstraints\r\n            iceConfigStub, // iceConfig\r\n            true, // isP2P\r\n            this._options.isInitiator // isInitiator\r\n        );\r\n\r\n        /**\r\n         * An additional initialize call is necessary to properly set instance\r\n         * variable for calling.\r\n         */\r\n        peerConnection.initialize(roomStub, this._rtc, configStub);\r\n\r\n        return peerConnection;\r\n    }\r\n\r\n    /**\r\n     * Invoked when a connection related issue has been encountered.\r\n     *\r\n     * @param {string} errorType - The constant indicating the type of the error\r\n     * that occured.\r\n     * @param {string} details - Optional additional data about the error.\r\n     * @private\r\n     * @returns {void}\r\n     */\r\n    _onError(errorType, details = '') {\r\n        this._options.onError(this._options.peerJid, errorType, details);\r\n    }\r\n\r\n    /**\r\n     * Callback invoked when the peer connection has received a remote media\r\n     * stream.\r\n     *\r\n     * @param {JitsiRemoteTrack} jitsiRemoteTrack - The remote media stream\r\n     * wrapped in {@code JitsiRemoteTrack}.\r\n     * @private\r\n     * @returns {void}\r\n     */\r\n    _onRemoteStream(jitsiRemoteTrack) {\r\n        this._tracks.push(jitsiRemoteTrack);\r\n\r\n        this._options.onRemoteStream(jitsiRemoteTrack);\r\n    }\r\n\r\n    /**\r\n     * Callback invoked when {@code JingleSessionPC} needs to signal a message\r\n     * out to the remote peer.\r\n     *\r\n     * @param {XML} iq - The message to signal out.\r\n     * @private\r\n     * @returns {void}\r\n     */\r\n    _onSendMessage(iq) {\r\n        this._options.onSendMessage(this._options.peerJid, iq);\r\n    }\r\n\r\n    /**\r\n     * Callback invoked in response to an agreement to start a proxy connection.\r\n     * The passed in jingle element should contain an SDP answer to a previously\r\n     * sent SDP offer.\r\n     *\r\n     * @param {Object} $jingle - The jingle element wrapped in jQuery.\r\n     * @private\r\n     * @returns {void}\r\n     */\r\n    _onSessionAccept($jingle) {\r\n        if (!this._peerConnection) {\r\n            logger.error('Received an answer when no peer connection exists.');\r\n\r\n            return;\r\n        }\r\n\r\n        this._peerConnection.setAnswer($jingle);\r\n    }\r\n\r\n    /**\r\n     * Callback invoked in response to a request to start a proxy connection.\r\n     * The passed in jingle element should contain an SDP offer.\r\n     *\r\n     * @param {Object} $jingle - The jingle element wrapped in jQuery.\r\n     * @private\r\n     * @returns {void}\r\n     */\r\n    _onSessionInitiate($jingle) {\r\n        if (this._peerConnection) {\r\n            logger.error('Received an offer when an offer was already sent.');\r\n\r\n            return;\r\n        }\r\n\r\n        this._peerConnection = this._createPeerConnection();\r\n\r\n        this._peerConnection.acceptOffer(\r\n            $jingle,\r\n            () => { /** no-op */ },\r\n            () => this._onError(\r\n                this._options.peerJid,\r\n                ACTIONS.CONNECTION_ERROR,\r\n                'session initiate error'\r\n            )\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Callback invoked in response to a request to disconnect an active proxy\r\n     * connection. Cleans up tracks and the peer connection.\r\n     *\r\n     * @private\r\n     * @returns {void}\r\n     */\r\n    _onSessionTerminate() {\r\n        this._tracks.forEach(track => track.dispose());\r\n        this._tracks = [];\r\n\r\n        if (this._peerConnection) {\r\n            this._peerConnection.onTerminated();\r\n        }\r\n\r\n        if (this._rtc) {\r\n            this._rtc.removeListener(\r\n                RTCEvents.REMOTE_TRACK_ADDED,\r\n                this._onRemoteStream\r\n            );\r\n\r\n            this._rtc.destroy();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Callback invoked in response to ICE candidates from the remote peer.\r\n     * The passed in jingle element should contain an ICE candidate.\r\n     *\r\n     * @param {Object} $jingle - The jingle element wrapped in jQuery.\r\n     * @private\r\n     * @returns {void}\r\n     */\r\n    _onTransportInfo($jingle) {\r\n        this._peerConnection.addIceCandidates($jingle);\r\n    }\r\n}\r\n","export default {\r\n    error: {\r\n        BUSY: 'busy',\r\n        ERROR: 'error',\r\n        RESOURCE_CONSTRAINT: 'resource-constraint',\r\n        SERVICE_UNAVAILABLE: 'service-unavailable'\r\n    },\r\n    mode: {\r\n        FILE: 'file',\r\n        STREAM: 'stream'\r\n    },\r\n    status: {\r\n        OFF: 'off',\r\n        ON: 'on',\r\n        PENDING: 'pending'\r\n    }\r\n};\r\n","import EventEmitter from 'events';\r\n\r\nimport browser from '../browser';\r\nimport Settings from '../settings/Settings';\r\nimport ScriptUtil from '../util/ScriptUtil';\r\n\r\nimport { CALLSTATS_SCRIPT_URL } from './constants';\r\n\r\nconst PRECALL_TEST_RESULTS = 'preCallTestResults';\r\nconst emitter = new EventEmitter();\r\nlet _initialized = false;\r\nlet api = null;\r\n\r\n/**\r\n * Loads the callstats io script.\r\n *\r\n * @returns {Promise<void>}\r\n */\r\nfunction _loadScript() {\r\n    if (browser.isReactNative()) {\r\n        return;\r\n    }\r\n\r\n    return new Promise(resolve => {\r\n        ScriptUtil.loadScript(\r\n            CALLSTATS_SCRIPT_URL,\r\n            /* async */ true,\r\n            /* prepend */ true,\r\n            /* relativeURL */ undefined,\r\n            /* loadCallback */ resolve);\r\n    });\r\n}\r\n\r\n/**\r\n * Initializes the callstats lib and registers a callback to be invoked\r\n * when there are 'preCallTestResults'.\r\n *\r\n * @typedef PrecallTestOptions\r\n * @type {Object}\r\n * @property {string} callStatsID - Callstats credentials - the id.\r\n * @property {string} callStatsSecret - Callstats credentials - the secret.\r\n * @property {string} statisticsId - The user name to use when initializing callstats.\r\n * @property {string} statisticsDisplayName - The user display name.\r\n *\r\n * @param { PrecallTestOptions} options - The init options.\r\n * @returns {Promise<void>}\r\n */\r\nfunction _initialize(options) {\r\n    return new Promise((resolve, reject) => {\r\n        const appId = options.callStatsID;\r\n        const appSecret = options.callStatsSecret;\r\n        const userId = options.statisticsId || options.statisticsDisplayName || Settings.callStatsUserName;\r\n\r\n        api.initialize(appId, appSecret, userId, (status, message) => {\r\n            if (status === 'success') {\r\n                api.on(PRECALL_TEST_RESULTS, (...args) => {\r\n                    emitter.emit(PRECALL_TEST_RESULTS, ...args);\r\n                });\r\n                _initialized = true;\r\n                resolve();\r\n            } else {\r\n                reject({\r\n                    status,\r\n                    message\r\n                });\r\n            }\r\n        }, null, { disablePrecalltest: true });\r\n    });\r\n}\r\n\r\n/**\r\n * Loads the callstats script and initializes the library.\r\n *\r\n * @param {Function} onResult - The callback to be invoked when results are received.\r\n * @returns {Promise<void>}\r\n */\r\nexport async function init(options) {\r\n    if (_initialized) {\r\n        throw new Error('Precall Test already initialized');\r\n    }\r\n\r\n    const { callStatsID, callStatsSecret, disableThirdPartyRequests } = options;\r\n\r\n    if (!callStatsID || !callStatsSecret || disableThirdPartyRequests) {\r\n        throw new Error('Callstats is disabled');\r\n    }\r\n\r\n    await _loadScript();\r\n    // eslint-disable-next-line new-cap\r\n    api = new window.callstats();\r\n\r\n    return _initialize(options);\r\n}\r\n\r\n/**\r\n * Executes a pre call test.\r\n *\r\n * @typedef PrecallTestResults\r\n * @type {Object}\r\n * @property {boolean} mediaConnectivity - If there is media connectivity or not.\r\n * @property {number} throughput  - The average throughput.\r\n * @property {number} fractionalLoss - The packet loss.\r\n * @property {number} rtt - The round trip time.\r\n * @property {string} provider - It is usually 'callstats'.\r\n *\r\n * @returns {Promise<{PrecallTestResults}>}\r\n */\r\nexport function execute() {\r\n    if (!_initialized) {\r\n        return Promise.reject('uninitialized');\r\n    }\r\n\r\n    return new Promise((resolve, reject) => {\r\n        emitter.on(PRECALL_TEST_RESULTS, (status, payload) => {\r\n            if (status === 'success') {\r\n                resolve(payload);\r\n            } else {\r\n                reject({\r\n                    status,\r\n                    payload\r\n                });\r\n            }\r\n\r\n        });\r\n\r\n        api.makePrecallTest();\r\n    });\r\n}\r\n\r\nexport default {\r\n    init,\r\n    execute\r\n};\r\n","const AuthUtil = {\r\n    /**\r\n     * Creates the URL pointing to JWT token authentication service. It is\r\n     * formatted from the 'urlPattern' argument which can contain the following\r\n     * constants:\r\n     * '{room}' - name of the conference room passed as <tt>roomName</tt>\r\n     * argument to this method.\r\n     * '{roleUpgrade}' - will contain 'true' if the URL will be used for\r\n     * the role upgrade scenario, where user connects from anonymous domain and\r\n     * then gets upgraded to the moderator by logging-in from the popup window.\r\n     *\r\n     * @param urlPattern a URL pattern pointing to the login service\r\n     * @param roomName the name of the conference room for which the user will\r\n     * be authenticated\r\n     * @param {bool} roleUpgrade <tt>true</tt> if the URL will be used for role\r\n     * upgrade scenario, where the user logs-in from the popup window in order\r\n     * to have the moderator rights granted\r\n     *\r\n     * @returns {string|null} the URL pointing to JWT login service or\r\n     * <tt>null</tt> if 'urlPattern' is not a string and the URL can not be\r\n     * constructed.\r\n     */\r\n    getTokenAuthUrl(urlPattern, roomName, roleUpgrade) {\r\n        const url = urlPattern;\r\n\r\n        if (typeof url !== 'string') {\r\n            return null;\r\n        }\r\n\r\n        return url.replace('{room}', roomName)\r\n            .replace('{roleUpgrade}', roleUpgrade === true);\r\n    }\r\n};\r\n\r\nmodule.exports = AuthUtil;\r\n","/* global\r\n    __filename\r\n*/\r\n\r\nimport { getLogger } from 'jitsi-meet-logger';\r\n\r\nimport { createAudioContext } from './WebAudioUtils';\r\n\r\nconst logger = getLogger(__filename);\r\n\r\n/**\r\n * The AudioMixer, as the name implies, mixes a number of MediaStreams containing audio tracks into a single\r\n * MediaStream.\r\n */\r\nexport default class AudioMixer {\r\n    /**\r\n     * Create AudioMixer instance.\r\n     */\r\n    constructor() {\r\n        this._started = false;\r\n        this._streamsToMix = [];\r\n        this._streamMSSArray = [];\r\n    }\r\n\r\n    /**\r\n     * Add audio MediaStream to be mixed, if the stream doesn't contain any audio tracks it will be ignored.\r\n     *\r\n     * @param {MediaStream} stream - MediaStream to be mixed.\r\n     */\r\n    addMediaStream(stream) {\r\n        if (!stream.getAudioTracks()) {\r\n            logger.warn('Added MediaStream doesn\\'t contain audio tracks.');\r\n        }\r\n\r\n        this._streamsToMix.push(stream);\r\n    }\r\n\r\n    /**\r\n     * At this point a WebAudio ChannelMergerNode is created and and the two associated MediaStreams are connected to\r\n     * it; the resulting mixed MediaStream is returned.\r\n     *\r\n     * @returns {MediaStream} - MediaStream containing added streams mixed together, or null if no MediaStream\r\n     * is added.\r\n     */\r\n    start() {\r\n        // If the mixer was already started just return the existing mixed stream.\r\n        if (this._started) {\r\n            return this._mixedMSD.stream;\r\n        }\r\n\r\n        this._audioContext = createAudioContext();\r\n\r\n        if (!this._streamsToMix.length) {\r\n            logger.warn('No MediaStream\\'s added to AudioMixer, nothing will happen.');\r\n\r\n            return null;\r\n        }\r\n\r\n        this._started = true;\r\n\r\n        this._mixedMSD = this._audioContext.createMediaStreamDestination();\r\n\r\n        for (const stream of this._streamsToMix) {\r\n            const streamMSS = this._audioContext.createMediaStreamSource(stream);\r\n\r\n            streamMSS.connect(this._mixedMSD);\r\n\r\n            // Maintain a list of MediaStreamAudioSourceNode so we can disconnect them on reset.\r\n            this._streamMSSArray.push(streamMSS);\r\n        }\r\n\r\n        return this._mixedMSD.stream;\r\n    }\r\n\r\n    /**\r\n     * Disconnect MediaStreamAudioSourceNode and clear references.\r\n     *\r\n     * @returns {void}\r\n     */\r\n    reset() {\r\n        this._started = false;\r\n        this._streamsToMix = [];\r\n\r\n        // Clean up created MediaStreamAudioSourceNode.\r\n        for (const streamMSS of this._streamMSSArray) {\r\n            streamMSS.disconnect();\r\n        }\r\n\r\n        this._streamMSSArray = [];\r\n\r\n        if (this._audioContext) {\r\n            this._audioContext = undefined;\r\n        }\r\n    }\r\n}\r\n","import {contentTrackCarrierName, roomInfoPeeperName} from '@models/api/Constants'\r\nimport {ISharedContent} from '@models/ISharedContent'\r\nimport {CONTENT_OUT_OF_RANGE_VALUE} from '@models/ISharedContent'\r\nimport { KickTime } from '@models/KickTime'\r\nimport {t} from '@models/locales'\r\nimport {priorityCalculator} from '@models/middleware/trafficControl'\r\nimport {defaultRemoteInformation, PARTICIPANT_SIZE, RemoteInformation, TrackStates} from '@models/Participant'\r\nimport {urlParameters} from '@models/url'\r\nimport {Mouse, mouse2Str, pose2Str, str2Mouse, str2Pose} from '@models/utils'\r\nimport {normV, subV2} from '@models/utils'\r\nimport {assert} from '@models/utils'\r\nimport chat, { ChatMessage, ChatMessageToSend } from '@stores/Chat'\r\nimport errorInfo from '@stores/ErrorInfo'\r\nimport {MediaSettings} from '@stores/participants/LocalParticipant'\r\nimport participants from '@stores/participants/Participants'\r\nimport roomInfo from '@stores/RoomInfo'\r\nimport {extractContentDataAndIds, makeThemContents} from '@stores/sharedContents/SharedContentCreator'\r\nimport contents from '@stores/sharedContents/SharedContents'\r\nimport JitsiMeetJS from 'lib-jitsi-meet'\r\nimport _ from 'lodash'\r\nimport {autorun, IReactionDisposer} from 'mobx'\r\nimport {BMMessage} from './BMMessage'\r\nimport {Conference} from './Conference'\r\nimport {ConferenceEvents} from './Conference'\r\nimport {MessageType} from './MessageType'\r\nimport {notification} from './Notification'\r\n// config.js\r\ndeclare const config:any             //  from ../../config.js included from index.html\r\n\r\nexport const PropertyType = {\r\n  PARTICIPANT_INFO: 'p_info',                   //  -> presence\r\n  PARTICIPANT_POSE: 'p_pose',                   //  -> update presence once per 5 sec / message immediate value\r\n  PARTICIPANT_ON_STAGE: 'p_onStage',            //  -> presence\r\n  PARTICIPANT_TRACKSTATES: 'p_trackSt',         //  -> presence\r\n  MAIN_SCREEN_CARRIER: 'main_screen_carrier',   //  -> presence\r\n  MY_CONTENT: 'my_content',                     //  -> presence\r\n}\r\n\r\n//const FRAGMENTING_LENGTH = 200    //  For sctp\r\n//const FRAGMENTING_LENGTH = 9000000  //  For websocket never flagmenting\r\nconst FRAGMENTING_LENGTH = 512 //  For websocket never flagmenting\r\n\r\ninterface FragmentedMessageHead{\r\n  type: string\r\n  length: number\r\n}\r\ninterface FragmentedMessage{\r\n  c: number\r\n  s: string\r\n}\r\n\r\nconst SYNC_LOG = false\r\nconst syncLog = SYNC_LOG ? console.log : () => {}\r\n\r\nexport class ConferenceSync{\r\n  conference: Conference\r\n  disposers: IReactionDisposer[] = []\r\n\r\n  constructor(c:Conference) {\r\n    this.conference = c\r\n    //  setInterval(()=>{ this.checkRemoteAlive() }, 1000)\r\n  }\r\n  sendAllAboutMe(){\r\n    syncLog('sendAllAboutMe called.')\r\n    this.sendPoseMessageNow()\r\n    this.sendMouseMessageNow()\r\n    participants.local.sendInformation()\r\n    this.sendOnStage()\r\n    this.sendTrackStates()\r\n    if (contents.tracks.localMainConnection?.localId){ this.sendMainScreenCarrier(true) }\r\n    this.sendMyContents()\r\n    this.sendAfkChanged()\r\n  }\r\n  //\r\n  sendPoseMessageNow(){\r\n    if (this.conference.channelOpened){\r\n      const poseStr = pose2Str(participants.local.pose)\r\n      this.conference.sendMessage(MessageType.PARTICIPANT_POSE, poseStr)\r\n    }\r\n  }\r\n  sendMouseMessageNow(){\r\n    if (this.conference.channelOpened){\r\n      const mouseStr = mouse2Str(participants.local.mouse)\r\n      this.conference.sendMessage(MessageType.PARTICIPANT_MOUSE, mouseStr)\r\n    }\r\n  }\r\n  sendParticipantInfo(){\r\n    if (!participants.local.informationToSend){ return }\r\n    if (config.bmRelayServer){\r\n      this.conference.sendMessage(PropertyType.PARTICIPANT_INFO, {...participants.local.informationToSend})\r\n    }else{\r\n      this.conference.setLocalParticipantProperty(PropertyType.PARTICIPANT_INFO,\r\n        {...participants.local.informationToSend})\r\n    }\r\n    let name = participants.local.information.name\r\n    while(name.slice(0,1) === '_'){ name = name.slice(1) }\r\n    this.conference._jitsiConference?.setDisplayName(name)\r\n  }\r\n  sendOnStage(){\r\n    if (config.bmRelayServer){\r\n      this.conference.sendMessage(PropertyType.PARTICIPANT_ON_STAGE, participants.local.physics.onStage)\r\n    }else{\r\n      if (this.conference.channelOpened) {\r\n        this.conference.setLocalParticipantProperty(\r\n          PropertyType.PARTICIPANT_ON_STAGE, participants.local.physics.onStage)\r\n      }\r\n    }\r\n  }\r\n  sendTrackStates() {\r\n    if (config.bmRelayServer){\r\n      this.conference.sendMessage(PropertyType.PARTICIPANT_TRACKSTATES,\r\n        {...participants.local.trackStates})\r\n    }else{\r\n      this.conference.setLocalParticipantProperty(PropertyType.PARTICIPANT_TRACKSTATES,\r\n                                                {...participants.local.trackStates})\r\n    }\r\n  }\r\n  sendAfkChanged(){\r\n    this.conference.sendMessage(MessageType.PARTICIPANT_AFK, participants.local.awayFromKeyboard)\r\n  }\r\n\r\n  //  Only for test (admin config dialog).\r\n  sendTrackLimits(to:string, limits?:number[]) {\r\n    this.conference.sendMessage(MessageType.PARTICIPANT_TRACKLIMITS, limits ? limits :\r\n      [participants.local.remoteVideoLimit, participants.local.remoteAudioLimit],  to ? to : undefined)\r\n  }\r\n  //  Send content update request to pid\r\n  sendContentUpdateRequest(pid: string, updatedContents: ISharedContent[]) {\r\n    if (!this.conference.bmRelaySocket &&\r\n      updatedContents.map(c=>c.url ? c.url.length : 0).reduce((prev, cur) => prev+cur) > FRAGMENTING_LENGTH) {\r\n      this.sendFragmentedMessage(MessageType.CONTENT_UPDATE_REQUEST, updatedContents, pid)\r\n    }else {\r\n      this.conference.sendMessage(MessageType.CONTENT_UPDATE_REQUEST, updatedContents, pid)\r\n    }\r\n  }\r\n  //  Send content remove request to pid\r\n  sendContentRemoveRequest(pid: string, removedIds: string[]) {\r\n    this.conference.sendMessage(MessageType.CONTENT_REMOVE_REQUEST, removedIds, pid)\r\n  }\r\n  sendLeftContentRemoveRequest(removedIds: string[]) {\r\n    assert(!config.bmRelayServer)\r\n    this.conference.sendMessage(MessageType.LEFT_CONTENT_REMOVE_REQUEST, removedIds)\r\n  }\r\n  //  send main screen carrir\r\n  sendMainScreenCarrier(enabled: boolean) {\r\n    const carrierId = contents.tracks.localMainConnection?.getParticipantId()\r\n    if (carrierId) {\r\n      if (config.bmRelayServer){\r\n        this.conference.sendMessage(PropertyType.MAIN_SCREEN_CARRIER, {carrierId, enabled})\r\n      }else{\r\n        this.conference.setLocalParticipantProperty(PropertyType.MAIN_SCREEN_CARRIER, {carrierId, enabled})\r\n      }\r\n    }\r\n  }\r\n  //  send myContents of local to remote participants.\r\n  sendMyContents() {\r\n    if (config.bmRelayServer){\r\n      this.sendContentUpdateRequest('', Array.from(contents.roomContents.values()))\r\n    }else{\r\n      const cs = Array.from(contents.localParticipant.myContents.values())\r\n      const contentsToSend = extractContentDataAndIds(cs)\r\n      syncLog(`send all contents ${JSON.stringify(contentsToSend.map(c => c.id))}.`,\r\n              contentsToSend)\r\n      this.conference.setLocalParticipantProperty(PropertyType.MY_CONTENT, contentsToSend)\r\n    }\r\n  }\r\n\r\n  //  message handler\r\n  private onRoomProp(key: string, value: string){\r\n    roomInfo.onUpdateProp(key, value)\r\n  }\r\n  private onParticipantTrackLimits(limits:number[]){\r\n    participants.local.remoteVideoLimit = limits[0]\r\n    participants.local.remoteAudioLimit = limits[1]\r\n  }\r\n  private onParticipantLeft(id: string){\r\n    contents.onParticipantLeft(id)\r\n    chat.participantLeft(id)\r\n    participants.leave(id)\r\n    if (this.conference.bmRelaySocket?.readyState === WebSocket.OPEN){\r\n      this.conference.sendMessage(MessageType.PARTICIPANT_LEFT, id)\r\n    }\r\n  }\r\n  private onChatMessage(pid: string|undefined, msg: ChatMessageToSend){\r\n    assert(pid)\r\n    //  console.log(`PRIVATE_MESSAGE_RECEIVED id:${id}, text:${msg.msg}, ts:${msg.ts}`)\r\n    const from = participants.find(pid)\r\n    if (from){\r\n      chat.addMessage(new ChatMessage(msg.msg, from.id, from.information.name,\r\n        from.information.avatarSrc, from.getColor(), msg.ts, msg.to ? 'private':'text'))\r\n    }\r\n  }\r\n  private onCallRemote(from:string|undefined){\r\n    assert(from)\r\n    const caller = participants.find(from)\r\n    if (caller){\r\n      chat.calledBy(caller)\r\n      if (participants.local.information.notifyCall){\r\n        notification(t('noCalled', {name: caller?.information.name}), {icon: './favicon.ico'})\r\n      }\r\n    }\r\n  }\r\n  private onAfkChanged(from:string|undefined, afk: boolean){\r\n    assert(from)\r\n    const remote = participants.find(from)\r\n    if (remote){ remote.awayFromKeyboard = afk }\r\n  }\r\n  public onKicked(pid:string|undefined, reason:string){\r\n    assert(pid)\r\n    errorInfo.setType('kicked', participants.remote.get(pid)?.information.name, reason)\r\n    const str = window.localStorage.getItem('kickTimes')\r\n    let found:KickTime|undefined = undefined\r\n    let kickTimes:KickTime[] = []\r\n    if (this.conference.name){\r\n      if (str){\r\n        kickTimes = JSON.parse(str) as KickTime[]\r\n        found = kickTimes.find(kt => kt.room === this.conference.name)\r\n      }\r\n      if (!found){\r\n        found = {room:this.conference.name, time:0}\r\n        kickTimes.push(found)\r\n      }\r\n      found.time = Date.now()\r\n      window.localStorage.setItem('kickTimes', JSON.stringify(kickTimes))\r\n    }\r\n    setTimeout(()=>{\r\n      window.location.reload()\r\n    }, 10000)\r\n  }\r\n  private onParticipantOut(pids: string[]){\r\n    pids.forEach(pid => {\r\n      const participant = participants.find(pid)\r\n      if (participant){\r\n        participant.physics.located = false\r\n      }\r\n    })\r\n  }\r\n  private onMouseOut(pids: string[]){\r\n    pids.forEach(pid => {\r\n      const participant = participants.find(pid)\r\n      if (participant){\r\n        participant.mouse.position = [CONTENT_OUT_OF_RANGE_VALUE, CONTENT_OUT_OF_RANGE_VALUE]\r\n      }\r\n    })\r\n  }\r\n  private onContentOut(cids: string[]){\r\n    cids.forEach(cid => {\r\n      const content = contents.find(cid)\r\n      if (content){\r\n        const newContent = Object.assign({}, content)\r\n        newContent.pose = {position: [CONTENT_OUT_OF_RANGE_VALUE, CONTENT_OUT_OF_RANGE_VALUE],\r\n          orientation: content.pose.orientation}\r\n        contents.updateByRemoteRequest([newContent])\r\n        //  console.log(`content out ${cid}`)\r\n      }\r\n    })\r\n  }\r\n\r\n  private onParticipantInfo(from:string|undefined, info:RemoteInformation){\r\n    assert(from)\r\n    if (urlParameters.testBot !== null) { return }\r\n\r\n    const remote = participants.remote.get(from)\r\n    if (remote) {\r\n      const name = remote.information.name\r\n      Object.assign(remote.information, info)\r\n      if (name !== remote.information.name){\r\n        if (name === defaultRemoteInformation.name){\r\n          chat.participantJoined(from)\r\n        }else{\r\n          chat.participantNameChanged(from, name)\r\n        }\r\n      }\r\n      remote.informationReceived = true\r\n      syncLog(`Info of ${from} received.`)\r\n    }\r\n  }\r\n  private onParticipantTrackState(from:string|undefined, states:TrackStates){\r\n    assert(from)\r\n    if (urlParameters.testBot !== null) { return }\r\n\r\n    const remote = participants.remote.get(from)\r\n    if (remote) {\r\n      Object.assign(remote.trackStates, states)\r\n    }\r\n  }\r\n  private onParticipantPose(from:string|undefined, poseStr:string){\r\n    assert(from)\r\n    const pose = str2Pose(poseStr)\r\n    const remote = participants.remote.get(from)\r\n    const local = participants.local\r\n    if (remote) {\r\n      remote.pose.orientation = pose.orientation\r\n      remote.pose.position = pose.position\r\n      remote.physics.located = true\r\n      if (local.information.notifyNear || local.information.notifyTouch){\r\n        const distance = normV(subV2(remote.pose.position, local.pose.position))\r\n        const NEAR = PARTICIPANT_SIZE * 3\r\n        const TOUCH = PARTICIPANT_SIZE\r\n        if (remote.lastDistance > TOUCH &&  distance <= TOUCH\r\n          && local.information.notifyTouch){\r\n          notification(t('noTouched',{name: remote.information.name}), {icon: './favicon.ico'})\r\n        }else if (remote.lastDistance > NEAR && distance < NEAR && local.information.notifyNear){\r\n          notification(t('noNear', {name: remote.information.name}), {icon: './favicon.ico'})\r\n        }\r\n        remote.lastDistance = distance\r\n      }\r\n    }\r\n  }\r\n  private onParticipantMouse(from:string|undefined, mouseStr:string){\r\n    assert(from)\r\n    const mouse = str2Mouse(mouseStr)\r\n    if (urlParameters.testBot !== null) { return }\r\n    const remote = participants.remote.get(from)\r\n    if (remote) { Object.assign(remote.mouse, mouse) }\r\n  }\r\n  private onParticipantOnStage(from:string|undefined, onStage:boolean){\r\n    assert(from)\r\n    const remote = participants.remote.get(from)\r\n    if (remote) {\r\n      remote.physics.onStage = onStage\r\n    }\r\n  }\r\n  private onYarnPhone(from:string|undefined, connectedPids:string[]){\r\n    assert(from)\r\n    //  console.log(`yarn from ${from} local:${participants.localId}`)\r\n    const myself = connectedPids.find(id => id === participants.localId)\r\n    if (myself) {\r\n      if (!participants.yarnPhones.has(from)){\r\n        participants.yarnPhones.add(from)\r\n        if (participants.local.information.notifyYarn){\r\n          const remote = participants.find(from)\r\n          if (remote){\r\n            notification(t('noYarn', {name: remote.information.name}), {icon: './favicon.ico'})\r\n          }\r\n        }\r\n      }\r\n    }else {\r\n      participants.yarnPhones.delete(from)\r\n    }\r\n  }\r\n  private onMuteVideo(value: boolean){\r\n    const setting = {} as MediaSettings\r\n    participants.local.loadMediaSettingsFromStorage(setting)\r\n    participants.local.muteVideo = value || setting.stream.muteVideo\r\n  }\r\n  private onMuteAudio(value: boolean){\r\n    const setting = {} as MediaSettings\r\n    participants.local.loadMediaSettingsFromStorage(setting)\r\n    participants.local.muteAudio = value || setting.stream.muteAudio\r\n  }\r\n  private onReloadBrower(){\r\n    window.location.reload()\r\n  }\r\n  //  contents\r\n  private onMainScreenCarrier(from: string|undefined, msg:{carrierId:string, enabled:boolean}){\r\n    assert(from)\r\n    const remote = participants.remote.get(from)\r\n    if (remote) {\r\n      contents.tracks.onMainScreenCarrier(msg.carrierId, msg.enabled)\r\n    }\r\n  }\r\n  private onMyContent(from:string|undefined, cs_:ISharedContent[]){\r\n    assert(from)\r\n    const cs = makeThemContents(cs_)\r\n    contents.checkDuplicatedWallpaper(from, cs)\r\n    contents.replaceRemoteContents(cs, from)\r\n    // eslint-disable-next-line @typescript-eslint/no-unused-vars\r\n    const remote = participants.remote.get(from)\r\n    syncLog(`recv remote contents ${JSON.stringify(cs.map(c => c.id))} from ${from}.`, cs)\r\n  }\r\n  private onContentInfoUpdate(cs:ISharedContent[]){\r\n    assert(config.bmRelayServer)\r\n    cs.forEach(c => contents.roomContentsInfo.set(c.id, c))\r\n  }\r\n  private onContentUpdateRequest(cds:ISharedContent[]){\r\n    // eslint-disable-next-line @typescript-eslint/no-unused-vars\r\n    const cs = makeThemContents(cds)\r\n    contents.updateByRemoteRequest(cs)\r\n  }\r\n  private onContentRemoveRequest(cids:string[]){\r\n    contents.removeByRemoteRequest(cids)\r\n  }\r\n  private onLeftContentRemoveRequest(cids:string[]){\r\n    console.log(`onLeftContentRemoveRequest for ${cids}.`)\r\n    contents.removeLeftContentByRemoteRequest(cids)\r\n  }\r\n\r\n  bind() {\r\n    //  participant related -----------------------------------------------------------------------\r\n    //  track limit\r\n    this.conference.on(MessageType.PARTICIPANT_TRACKLIMITS, this.onParticipantTrackLimits)\r\n\r\n    //  left/join\r\n    this.conference.on(ConferenceEvents.USER_LEFT, this.onParticipantLeft.bind(this))\r\n    this.conference.on(ConferenceEvents.USER_JOINED, (id) => {\r\n      const name = this.conference._jitsiConference?.getParticipantById(id).getDisplayName()\r\n      if (name === contentTrackCarrierName || name === roomInfoPeeperName) {\r\n        //  do nothing\r\n      }else {\r\n        participants.join(id)\r\n      }\r\n    })\r\n\r\n    //  track\r\n    this.conference.on(ConferenceEvents.REMOTE_TRACK_ADDED, (track) => {\r\n      //  update priorty for setPerceptible message.\r\n      priorityCalculator.onRemoteTrackAdded(track)\r\n\r\n      //  console.log(`onRemoteTrackAdded ${track} videoType:'${track.videoType ? track.videoType : undefined}'.`)\r\n      if (!participants.addRemoteTrack(track)) {\r\n        contents.tracks.addRemoteTrack(track)\r\n      }\r\n    })\r\n    this.conference.on(ConferenceEvents.REMOTE_TRACK_REMOVED, (track) => {\r\n      //  console.log(`onRemoteTrackAdded ${track} videoType:'${track.videoType ? track.videoType : undefined}'.`)\r\n\r\n      if (!participants.removeRemoteTrack(track)) {\r\n        contents.tracks.removeRemoteTrack(track)\r\n      }\r\n    })\r\n\r\n    //  chat\r\n    this.conference.on(MessageType.CHAT_MESSAGE, this.onChatMessage)\r\n    //  call\r\n    this.conference.on(MessageType.CALL_REMOTE, this.onCallRemote)\r\n    //  kick\r\n    this.conference.on(MessageType.KICK, (pid:string, reason:string)=>{\r\n      this.conference._jitsiConference?.room.leave()\r\n      this.onKicked(pid, reason)\r\n    })\r\n    this.conference.on(MessageType.PARTICIPANT_AFK, this.onAfkChanged)\r\n    this.conference.on(PropertyType.PARTICIPANT_INFO, this.onParticipantInfo)\r\n    this.conference.on(PropertyType.PARTICIPANT_TRACKSTATES, this.onParticipantTrackState)\r\n    this.conference.on(MessageType.PARTICIPANT_POSE, this.onParticipantPose)\r\n    this.conference.on(PropertyType.PARTICIPANT_POSE, this.onParticipantPose)\r\n    this.conference.on(MessageType.PARTICIPANT_MOUSE, this.onParticipantMouse)\r\n    this.conference.on(PropertyType.PARTICIPANT_ON_STAGE, this.onParticipantOnStage)\r\n    this.conference.on(MessageType.YARN_PHONE, this.onYarnPhone)\r\n    this.conference.on(MessageType.MUTE_VIDEO, this.onMuteVideo)\r\n    this.conference.on(MessageType.MUTE_AUDIO, this.onMuteAudio)\r\n    this.conference.on(MessageType.RELOAD_BROWSER, this.onReloadBrower)\r\n\r\n    // contents related ---------------------------------------------------------------\r\n    //  main screen track's carrier id\r\n    this.conference.on(PropertyType.MAIN_SCREEN_CARRIER, this.onMainScreenCarrier)\r\n    //  Receive remote contents.\r\n    this.conference.on(PropertyType.MY_CONTENT, this.onMyContent)\r\n    //  request\r\n    this.conference.on(MessageType.CONTENT_UPDATE_REQUEST, this.onContentUpdateRequest)\r\n    this.conference.on(MessageType.CONTENT_REMOVE_REQUEST, this.onContentRemoveRequest)\r\n    this.conference.on(MessageType.LEFT_CONTENT_REMOVE_REQUEST, this.onLeftContentRemoveRequest)\r\n\r\n    //  Get data channel state\r\n    this.conference._jitsiConference?.addEventListener(JitsiMeetJS.events.conference.DATA_CHANNEL_OPENED, () => {\r\n      this.conference.channelOpened = true\r\n    })\r\n\r\n    //  fragmented message\r\n    this.conference.on(MessageType.FRAGMENT_HEAD, (from:string, msg:FragmentedMessageHead) => {\r\n      this.fragmentedMessageHead = msg\r\n      this.fragmentedMessages = []\r\n    })\r\n    this.conference.on(MessageType.FRAGMENT_CONTENT, (from:string, msg:FragmentedMessage) => {\r\n      this.fragmentedMessages[msg.c] = msg\r\n      if (this.fragmentedMessageHead.length && this.fragmentedMessages.length === this.fragmentedMessageHead.length\r\n        && (this.fragmentedMessages.findIndex(msg => msg === undefined) === -1)) {\r\n        let str = ''\r\n        this.fragmentedMessages.forEach(msg => str += msg.s)\r\n        //  console.log('JSON', str)\r\n        const obj = JSON.parse(str)\r\n        this.conference.emit(this.fragmentedMessageHead.type, from, obj)\r\n        this.fragmentedMessageHead = {type:'', length:0}\r\n        this.fragmentedMessages = []\r\n      }\r\n    })\r\n  }\r\n  observeStart(){\r\n    this.disposers.push(autorun(() => {\r\n      participants.remote.forEach((remote)=>{\r\n        if (remote.called){\r\n          remote.called = false\r\n          this.conference.sendMessage(MessageType.CALL_REMOTE, {}, remote.id)\r\n          chat.callTo(remote)\r\n        }\r\n      })\r\n    }))\r\n    this.disposers.push(autorun(this.sendAfkChanged.bind(this)))\r\n    this.disposers.push(autorun(this.sendParticipantInfo.bind(this)))\r\n    this.disposers.push(autorun(this.sendTrackStates.bind(this)))\r\n    if (config.bmRelayServer){\r\n      this.disposers.push(autorun(() => {\r\n        this.sendPoseMessageNow()\r\n        this.sendMouseMessageNow()\r\n      }))\r\n    }else{\r\n      //  pose via bridge\r\n      const calcWait = () => Math.ceil(Math.max((participants.remote.size / 4) * 50, 50))\r\n      let sendPoseMessage: (poseStr:string) => void = ()=>{}\r\n      let poseWait = 0\r\n      let lastPoseStr=''\r\n      this.disposers.push(autorun(() => {\r\n        const newWait = calcWait()\r\n        if (newWait !== poseWait) {\r\n          poseWait = newWait\r\n          sendPoseMessage = _.throttle((poseStr:string) => {\r\n            if (this.conference.channelOpened){\r\n              this.conference.sendMessage(MessageType.PARTICIPANT_POSE, poseStr)\r\n            }\r\n          },                           poseWait)  //  30fps\r\n          //  console.log(`poseWait = ${poseWait}`)\r\n        }\r\n\r\n        const poseStr = pose2Str(participants.local.pose)\r\n        if (this.conference.channelOpened && lastPoseStr !== poseStr) {\r\n          sendPoseMessage(poseStr)\r\n          lastPoseStr = poseStr\r\n        }\r\n      }))\r\n      let updateTimeForProperty = 0\r\n      let lastPoseStrProprty = ''\r\n      const setPoseProperty = () => {\r\n        const now = Date.now()\r\n        const period = calcWait() * 30 //  (33ms(1 remote) to 1000ms(100 remotes)) * 30\r\n        if (now - updateTimeForProperty > period) {  //  update period\r\n          const poseStr = pose2Str(participants.local.pose)\r\n          if (lastPoseStrProprty !== poseStr){\r\n            this.conference.setLocalParticipantProperty(PropertyType.PARTICIPANT_POSE, poseStr)\r\n            updateTimeForProperty = now\r\n            lastPoseStrProprty = poseStr\r\n          }\r\n        }\r\n      }\r\n      setPoseProperty()\r\n      setInterval(setPoseProperty, 2.5 * 1000)\r\n      //  mouse via bridge\r\n      let wait = 0\r\n      let sendMouseMessage = (mouse:Mouse) => {}\r\n      const sendMouse = (to: string) => {\r\n        const newWait = calcWait()\r\n        if (wait !== newWait) {\r\n          wait = newWait\r\n          sendMouseMessage = _.throttle((mouse: Mouse) => {\r\n            this.conference.sendMessage(MessageType.PARTICIPANT_MOUSE, mouse2Str(mouse))\r\n          },                            wait)\r\n        }\r\n        if (this.conference.channelOpened) {\r\n          sendMouseMessage({...participants.local.mouse})\r\n        }\r\n      }\r\n      this.disposers.push(autorun(() => { sendMouse('') }))\r\n    }\r\n\r\n    this.disposers.push(autorun(() => { this.sendOnStage() }))\r\n\r\n    const sendYarnPhones = () => {\r\n      if (this.conference.channelOpened && participants.yarnPhoneUpdated) {\r\n        participants.yarnPhoneUpdated = false\r\n        this.conference.sendMessage(MessageType.YARN_PHONE, Array.from(participants.yarnPhones))\r\n      }\r\n    }\r\n    this.disposers.push(autorun(() => { sendYarnPhones() }))\r\n  }\r\n  observeEnd() {\r\n    this.disposers.forEach(d => d())\r\n  }\r\n\r\n\r\n  //  Utilities\r\n  private fragmentedMessages:FragmentedMessage[] = []\r\n  private fragmentedMessageHead:FragmentedMessageHead = {type:'', length:0}\r\n  sendFragmentedMessage(type: string, value: Object, to: string) {\r\n    const str = JSON.stringify(value)\r\n    const head: FragmentedMessageHead = {type, length:Math.ceil(str.length / FRAGMENTING_LENGTH)}\r\n    this.conference.sendMessage(MessageType.FRAGMENT_HEAD, head, to)\r\n    let count = 0\r\n    for (let i = 0; i < str.length; i += FRAGMENTING_LENGTH) {\r\n      this.conference.sendMessage(MessageType.FRAGMENT_CONTENT, {c:count, s:str.slice(i, i + FRAGMENTING_LENGTH)}, to)\r\n      count += 1\r\n    }\r\n  }\r\n  // tslint:disable-next-line: cyclomatic-complexity\r\n  onBmMessage(msgs: BMMessage[]){\r\n    syncLog(`Receive ${msgs.length} relayed messages.`)\r\n    for(const msg of msgs){\r\n      switch(msg.t){\r\n        case MessageType.ROOM_PROP: this.onRoomProp(...(JSON.parse(msg.v) as [string, string])); break\r\n        case MessageType.REQUEST_TO: this.sendAllAboutMe(); break\r\n        case MessageType.PARTICIPANT_AFK: this.onAfkChanged(msg.p, JSON.parse(msg.v)); break\r\n        case MessageType.CALL_REMOTE: this.onCallRemote(msg.p); break\r\n        case MessageType.CHAT_MESSAGE: this.onChatMessage(msg.p, JSON.parse(msg.v)); break\r\n        case MessageType.CONTENT_REMOVE_REQUEST: this.onContentRemoveRequest(JSON.parse(msg.v)); break\r\n        case MessageType.LEFT_CONTENT_REMOVE_REQUEST: this.onLeftContentRemoveRequest(JSON.parse(msg.v)); break\r\n        case MessageType.CONTENT_UPDATE_REQUEST: this.onContentUpdateRequest(JSON.parse(msg.v)); break\r\n        case MessageType.CONTENT_INFO_UPDATE: this.onContentInfoUpdate(JSON.parse(msg.v)); break\r\n        case MessageType.PARTICIPANT_MOUSE: this.onParticipantMouse(msg.p, JSON.parse(msg.v)); break\r\n        case MessageType.PARTICIPANT_POSE: this.onParticipantPose(msg.p, JSON.parse(msg.v)); break\r\n        case MessageType.PARTICIPANT_TRACKLIMITS: this.onParticipantTrackLimits(JSON.parse(msg.v)); break\r\n        case MessageType.YARN_PHONE: this.onYarnPhone(msg.p, JSON.parse(msg.v)); break\r\n        case MessageType.RELOAD_BROWSER: this.onReloadBrower(); break\r\n        case MessageType.MUTE_VIDEO: this.onMuteVideo(JSON.parse(msg.v)); break\r\n        case MessageType.MUTE_AUDIO: this.onMuteAudio(JSON.parse(msg.v)); break\r\n        case MessageType.KICK: this.onKicked(msg.p, JSON.parse(msg.v)); break\r\n        case MessageType.PARTICIPANT_OUT: this.onParticipantOut(JSON.parse(msg.v)); break\r\n        case MessageType.MOUSE_OUT: this.onMouseOut(JSON.parse(msg.v)); break\r\n        case MessageType.CONTENT_OUT: this.onContentOut(JSON.parse(msg.v)); break\r\n        case PropertyType.MAIN_SCREEN_CARRIER: this.onMainScreenCarrier(msg.p, JSON.parse(msg.v)); break\r\n        case PropertyType.MY_CONTENT: this.onMyContent(msg.p, JSON.parse(msg.v)); break\r\n        case PropertyType.PARTICIPANT_INFO: this.onParticipantInfo(msg.p, JSON.parse(msg.v)); break\r\n        case PropertyType.PARTICIPANT_ON_STAGE: this.onParticipantOnStage(msg.p, JSON.parse(msg.v)); break\r\n        case PropertyType.PARTICIPANT_POSE: this.onParticipantPose(msg.p, JSON.parse(msg.v)); break\r\n        case PropertyType.PARTICIPANT_TRACKSTATES: this.onParticipantTrackState(msg.p, JSON.parse(msg.v)); break\r\n        default:\r\n          console.log(`Unhandled message type ${msg.t} from ${msg.p}`)\r\n          break\r\n      }\r\n    }\r\n    this.checkInfo()\r\n  }\r\n  checkInfo(){\r\n    const remotes = Array.from(participants.remote.values())\r\n    const ids = remotes.filter(remote => !remote.informationReceived).map(remote => remote.id)\r\n    if (ids.length){\r\n      syncLog(`checkInfo sent ${ids}`)\r\n      this.conference.pushOrUpdateMessageViaRelay(MessageType.REQUEST_TO, ids)\r\n    }\r\n  }\r\n}\r\n","import {KickTime} from '@models/KickTime'\r\nimport {assert} from '@models/utils'\r\nimport map from '@stores/Map'\r\nimport {participantsStore} from '@stores/participants'\r\nimport {default as participants} from '@stores/participants/Participants'\r\nimport roomInfo from '@stores/RoomInfo'\r\nimport contents from '@stores/sharedContents/SharedContents'\r\nimport {EventEmitter} from 'events'\r\nimport JitsiMeetJS, {JitsiLocalTrack, JitsiRemoteTrack, JitsiTrack, JitsiValues, TMediaType} from 'lib-jitsi-meet'\r\nimport JitsiParticipant from 'lib-jitsi-meet/JitsiParticipant'\r\nimport {makeObservable, observable} from 'mobx'\r\nimport {BMMessage} from './BMMessage'\r\nimport {ConferenceSync} from './ConferenceSync'\r\nimport {ClientToServerOnlyMessageType, MessageType, ObjectArrayMessageTypes, StringArrayMessageTypes} from './MessageType'\r\n\r\n//  Log level and module log options\r\nexport const JITSILOGLEVEL = 'warn'  // log level for lib-jitsi-meet {debug|log|warn|error}\r\nexport const CONNECTIONLOG = false\r\nexport const TRACKLOG = false        // show add, remove... of tracks\r\nexport const EVENTLOG = false\r\nexport const SENDLOG = false\r\nexport const trackLog = TRACKLOG ? console.log : (a:any) => {}\r\nexport const connLog = CONNECTIONLOG ? console.log : (a:any) => {}\r\nexport const connDebug = CONNECTIONLOG ? console.debug : (a:any) => {}\r\nexport const eventLog = EVENTLOG ? console.log : (a:any) => {}\r\nexport const sendLog = SENDLOG ? console.log : (a:any) => {}\r\n\r\n// config.js\r\ndeclare const config:any             //  from ../../config.js included from index.html\r\ndeclare const d:any                  //  from index.html\r\n\r\nconst CONF = JitsiMeetJS.events.conference\r\nexport const ConferenceEvents = {\r\n  USER_JOINED: 'joined',\r\n  USER_LEFT: 'left',\r\n  REMOTE_TRACK_ADDED: 'remote_track_added',\r\n  REMOTE_TRACK_REMOVED: 'remote_track_removed',\r\n//  MESSAGE_RECEIVED: 'message_received',\r\n//  PRIVATE_MESSAGE_RECEIVED: 'prev_message_received',\r\n}\r\n\r\n//  Cathegolies of BMMessage's types\r\nconst stringArrayMessageTypesForClient = new Set(StringArrayMessageTypes)\r\nstringArrayMessageTypesForClient.add(ClientToServerOnlyMessageType.CONTENT_UPDATE_REQUEST_BY_ID)\r\nstringArrayMessageTypesForClient.add(ClientToServerOnlyMessageType.REQUEST_PARTICIPANT_STATES)\r\n\r\nexport class Conference extends EventEmitter {\r\n  public _jitsiConference?: JitsiMeetJS.JitsiConference\r\n  public name=''\r\n  public localId = ''\r\n  sync = new ConferenceSync(this)\r\n  @observable channelOpened = false     //  is JVB message channel open ?\r\n  bmRelaySocket:WebSocket|undefined = undefined //  Socket for message passing via separate relay server\r\n  private lastRequestTime = Date.now()\r\n  private lastReceivedTime = Date.now()\r\n  private messagesToSendToRelay: BMMessage[] = []\r\n  relayRttLast = 50\r\n  relayRttAverage = 50\r\n\r\n  constructor(){\r\n    super()\r\n    makeObservable(this)\r\n  }\r\n\r\n  setRoomProp(name:string, value:string){\r\n    //  console.log(`setRoomProp(${name}, ${value})`)\r\n    this.pushOrUpdateMessageViaRelay(MessageType.ROOM_PROP, [name, value])\r\n    roomInfo.onUpdateProp(name, value)\r\n  }\r\n\r\n  public init(name:string, createJitsiConference:()=>JitsiMeetJS.JitsiConference|undefined){\r\n    //  check last kicked time\r\n    if (name){\r\n      const str = window.localStorage.getItem('kickTimes')\r\n      if (str){\r\n        const kickTimes = JSON.parse(str) as KickTime[]\r\n        const found = kickTimes.find(kt => kt.room === name)\r\n        if (found){\r\n          const diff = Date.now() - found.time\r\n          const KICK_WAIT_MIN = 15  //  Can not login KICK_WAIT_MIN minutes once kicked.\r\n          if (diff < KICK_WAIT_MIN * 60 * 1000){\r\n            window.location.reload()\r\n\r\n            return\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    //  register event handlers and join\r\n    this.name = name\r\n    this._jitsiConference = createJitsiConference()\r\n    this.registerJistiConferenceEvents()\r\n    this.sync.bind()\r\n    this._jitsiConference?.join('')\r\n    this._jitsiConference?.setSenderVideoConstraint(1080)\r\n    //  start relayServer communication.\r\n    this.step()\r\n\r\n    //  To access from debug console, add object d to the window.\r\n    d.conference = this\r\n    d.jc = this._jitsiConference\r\n    d.chatRoom = (this._jitsiConference as any).room\r\n    d.showState = () => {\r\n      console.log(`carrierMap: ${JSON.stringify(contents.tracks.carrierMap)}`)\r\n      console.log(`contentCarriers: ${JSON.stringify(contents.tracks.contentCarriers)}`)\r\n      console.log(`remoteMains: ${JSON.stringify(contents.tracks.remoteMains.keys())}`)\r\n    }\r\n  }\r\n\r\n  public uninit(){\r\n    if (config.bmRelayServer && participants.localId){\r\n      this.sendMessage(MessageType.PARTICIPANT_LEFT, participants.localId)\r\n    }\r\n    if (participants.local.tracks.audio) {\r\n      this.removeTrack(participants.local.tracks.audio as JitsiLocalTrack)?.then(()=>{\r\n        participants.local.tracks.audio?.dispose()\r\n      })\r\n    }\r\n    if (participants.local.tracks.avatar) {\r\n      this.removeTrack(participants.local.tracks.avatar as JitsiLocalTrack)?.then(()=>{\r\n        participants.local.tracks.avatar?.dispose()\r\n      })\r\n    }\r\n    this.sync.observeEnd()\r\n    //  stop relayServer communication.\r\n    this.stopStep = true\r\n\r\n    return new Promise((resolve, reject) => {\r\n      this._jitsiConference?.leave().then((arg) => {\r\n        let logStr = localStorage.getItem('log') ?? ''\r\n        logStr += `leave (${arg}). `\r\n        localStorage.setItem('log', logStr)\r\n        resolve(arg)\r\n      }).catch((reason)=>{\r\n        reject(reason)\r\n      }).finally(()=>{\r\n        this._jitsiConference = undefined\r\n      })\r\n    })\r\n  }\r\n\r\n  private stopStep = false\r\n  private step(){\r\n    const period = 50\r\n    if (this.bmRelaySocket?.readyState === WebSocket.OPEN){\r\n      const timeToProcess = period * 0.8\r\n      const deadline = Date.now() + timeToProcess\r\n      while(Date.now() < deadline && this.receivedMessages.length){\r\n        const msg = this.receivedMessages.shift()\r\n        if (msg){\r\n          this.sync.onBmMessage([msg])\r\n        }\r\n      }\r\n      const REQUEST_INTERVAL = Math.min(\r\n        Math.max((this.relayRttAverage-20) * participants.remote.size/40, 0) + 20,\r\n        3*1000)\r\n      const REQUEST_WAIT_TIMEOUT = REQUEST_INTERVAL + 20 * 1000  //  wait 20 sec when failed to receive message.\r\n      const now = Date.now()\r\n      if (now < deadline && this.bmRelaySocket && !this.receivedMessages.length\r\n        && now - this.lastRequestTime > REQUEST_INTERVAL\r\n        && (this.lastReceivedTime >= this.lastRequestTime\r\n          || now - this.lastRequestTime > REQUEST_WAIT_TIMEOUT)){\r\n          this.lastRequestTime = now\r\n          this.pushOrUpdateMessageViaRelay(MessageType.REQUEST_RANGE, [map.visibleArea(), participants.audibleArea()])\r\n          this.sendMessageViaRelay()\r\n      }\r\n      //console.log(`step RTT:${this.relayRttAverage} remain:${deadline - Date.now()}/${timeToProcess}`)\r\n    }\r\n    if (!this.stopStep){\r\n      setTimeout(()=>{this.step()}, period)\r\n    }else{\r\n      this.stopStep = false\r\n    }\r\n  }\r\n\r\n  //  Commmands for local tracks --------------------------------------------\r\n  private localMicTrack?: JitsiLocalTrack\r\n  private localCameraTrack?: JitsiLocalTrack\r\n  private doSetLocalMicTrack(track:JitsiLocalTrack) {\r\n    this.localMicTrack = track\r\n    this.localMicTrack.videoType = 'mic'\r\n    this._jitsiConference?.addTrack(this.localMicTrack)\r\n  }\r\n  public setLocalMicTrack(track: JitsiLocalTrack|undefined){\r\n    const promise = new Promise<JitsiLocalTrack|undefined>((resolveFunc, rejectionFunc) => {\r\n      if (track) {\r\n        if (this.localMicTrack) {\r\n          const prev = this.localMicTrack\r\n          this._jitsiConference?.removeTrack(this.localMicTrack).then(() => {\r\n            this.doSetLocalMicTrack(track)\r\n            resolveFunc(prev)\r\n          })\r\n        }else {\r\n          this.doSetLocalMicTrack(track)\r\n          resolveFunc(undefined)\r\n        }\r\n      }else {\r\n        if (this.localMicTrack) {\r\n          this._jitsiConference?.removeTrack(this.localMicTrack).then(() => {\r\n            const prev = this.localMicTrack\r\n            this.localMicTrack = undefined\r\n            resolveFunc(prev)\r\n          })\r\n        }else {\r\n          resolveFunc(undefined)\r\n        }\r\n      }\r\n    })\r\n\r\n    return promise\r\n\r\n  }\r\n\r\n\r\n  private doSetLocalCameraTrack(track:JitsiLocalTrack) {\r\n    this.localCameraTrack = track\r\n    this.localCameraTrack.videoType = 'camera'\r\n    this._jitsiConference?.addTrack(this.localCameraTrack)\r\n  }\r\n  public setLocalCameraTrack(track: JitsiLocalTrack|undefined) {\r\n    const promise = new Promise<JitsiLocalTrack|undefined>((resolveFunc, rejectionFunc) => {\r\n      if (track) {\r\n        //  this.cameraTrackConverter(track)\r\n        if (this.localCameraTrack) {\r\n          const prev = this.localCameraTrack\r\n          this._jitsiConference?.removeTrack(this.localCameraTrack).then(() => {\r\n            this.doSetLocalCameraTrack(track)\r\n            resolveFunc(prev)\r\n          })\r\n        }else {\r\n          this.doSetLocalCameraTrack(track)\r\n          resolveFunc(undefined)\r\n        }\r\n      }else {\r\n        if (this.localCameraTrack) {\r\n          this._jitsiConference?.removeTrack(this.localCameraTrack).then(() => {\r\n            const prev = this.localCameraTrack\r\n            this.localCameraTrack = undefined\r\n            resolveFunc(prev)\r\n          })\r\n        }else {\r\n          resolveFunc(undefined)\r\n        }\r\n      }\r\n    })\r\n\r\n    return promise\r\n  }\r\n  public getLocalMicTrack() {\r\n    return this.localMicTrack\r\n  }\r\n  public getLocalCameraTrack() {\r\n    return this.localCameraTrack\r\n  }\r\n\r\n  //  Jitsi API Calls ----------------------------------------\r\n  //  generic send command\r\n  public sendCommand(name: string, values: JitsiValues) {\r\n    sendLog(`SEND sendCommand ${name} ${JSON.stringify(values)}`)\r\n    this._jitsiConference?.sendCommand(name, values)\r\n  }\r\n  public removeCommand(name: string) {\r\n    this._jitsiConference?.removeCommand(name)\r\n  }\r\n  public addCommandListener(name: string, handler: (node: JitsiValues, jid:string, path:string) => void) {\r\n    this._jitsiConference?.addCommandListener(name, handler)\r\n  }\r\n  public setLocalParticipantProperty(name: string, value:Object) {\r\n    sendLog(`SEND setLocalParticipantProperty ${name} ${JSON.stringify(value)}`)\r\n    this._jitsiConference?.setLocalParticipantProperty(name, JSON.stringify(value))\r\n  }\r\n  public getLocalParticipantProperty(name: string): any {\r\n    return this._jitsiConference?.getLocalParticipantProperty(name)\r\n  }\r\n  public kickParticipant(pid: string){\r\n    this._jitsiConference?.kickParticipant(pid)\r\n  }\r\n  //\r\n  public setSenderVideoConstraint(height: number) {\r\n    this._jitsiConference?.setSenderVideoConstraint(height)\r\n  }\r\n\r\n  public setReceiverConstraints(videoConstraints: JitsiMeetJS.VideoConstraints){\r\n    this._jitsiConference?.setReceiverConstraints(videoConstraints)\r\n  }\r\n\r\n  //  send Perceptibles API added by hasevr\r\n  public setPerceptibles(perceptibles:[string[], string[]]) {\r\n    sendLog(`SEND setPerceptibles ${perceptibles[0].length} ${perceptibles[1].length}`)\r\n    if (this._jitsiConference?.setPerceptibles) {\r\n      this._jitsiConference.setPerceptibles(perceptibles)\r\n    }\r\n  }\r\n\r\n  /**\r\n   * reduce bit rate\r\n   * peerconnection as TraceablePeerConnection\r\n   * peerconnection.peerconnection as RTCPeerConnection */\r\n  private reduceBitrate() {\r\n    if (config.rtc && this._jitsiConference && this._jitsiConference.jvbJingleSession) {\r\n      const jingleSession = this._jitsiConference.jvbJingleSession\r\n      if (!jingleSession.bitRateAlreadyReduced && jingleSession.peerconnection.peerconnection) {\r\n        jingleSession.bitRateAlreadyReduced = true\r\n        const pc = jingleSession.peerconnection.peerconnection\r\n        // console.log('RTCPeerConnect:', pc)\r\n        pc.getSenders().forEach((sender) => {\r\n          // console.log(sender)\r\n          if (sender && sender.track) {\r\n            const params = sender.getParameters()\r\n            // console.log('params:', params)\r\n            if (params.encodings.length === 0) {\r\n              params.encodings.push({})\r\n            }\r\n            params.encodings.forEach((encording) => {\r\n              const ONE_KILO = 1024\r\n              if (sender.track!.kind === 'video' && config.rtc.maxBitrateForVideo) {\r\n                encording.maxBitrate = config.rtc.maxBitrateForVideo * ONE_KILO\r\n              }else if (sender.track!.kind === 'audio') {\r\n                encording.maxBitrate = config.rtc.maxBitrateForAudio * ONE_KILO\r\n              }\r\n            })\r\n            sender.setParameters(params)\r\n          }\r\n        })\r\n      }\r\n    }\r\n  }\r\n\r\n  sendMessage(type:string, value:any, to?: string) {\r\n    if (config.bmRelayServer){\r\n      this.pushOrUpdateMessageViaRelay(type, value, to)\r\n    }else{\r\n      this.sendMessageViaJitsi(type, value, to)\r\n    }\r\n  }\r\n  sendMessageViaJitsi(type:string, value:any, to?:string) {\r\n    const jc = this._jitsiConference as any\r\n    const viaBridge = jc?.rtc?._channel?.isOpen() ? true : false\r\n    const connected = jc?.chatRoom?.connection.connected\r\n    sendLog(`SEND sendMessage type:${type} to:${to} val:${JSON.stringify(value)}`)\r\n\r\n    if (viaBridge || connected){\r\n      const msg = viaBridge ? {type, value} : JSON.stringify({type, value})\r\n      this._jitsiConference?.sendMessage(msg, to ? to : '', viaBridge)\r\n    }else{\r\n      if (participants.remote.size){\r\n        console.log('Conference.sendMessageViaJitsi() failed: Not connected.')\r\n      }\r\n    }\r\n  }\r\n  receivedMessages: BMMessage[] = []\r\n  connectToRelayServer(){\r\n    if (this.bmRelaySocket){ return }\r\n    const onOpen = () => {\r\n      this.messagesToSendToRelay = []\r\n      this.pushOrUpdateMessageViaRelay(MessageType.REQUEST_ALL, {}, undefined, true)\r\n      this.sync.sendAllAboutMe()\r\n      this.sendMessageViaRelay()\r\n    }\r\n    const onMessage = (ev: MessageEvent<any>)=> {\r\n      //  console.log(`ws:`, ev)\r\n      if (typeof ev.data === 'string') {\r\n        this.lastReceivedTime = Date.now()\r\n        this.relayRttLast = this.lastReceivedTime - this.lastRequestTime\r\n\r\n        const msgs = JSON.parse(ev.data) as BMMessage[]\r\n        //  console.log(`Relay sock onMessage len:${msgs.length}`)\r\n        //*\r\n        if (msgs.length){\r\n          this.receivedMessages.push(...msgs)\r\n        }\r\n        const alpha = 0.3\r\n        if (msgs.length){\r\n          this.relayRttAverage = alpha * this.relayRttLast + (1-alpha) * this.relayRttAverage\r\n        }\r\n        /*/\r\n        setTimeout(()=>{\r\n          if (msgs.length){\r\n            this.receivedMessages.push(...msgs)\r\n          }\r\n          this.lastReceivedTime = Date.now()\r\n        }, 1000)  //  */\r\n      }\r\n    }\r\n    const onClose = () => {\r\n      setTimeout(()=>{\r\n        this.bmRelaySocket = new WebSocket(config.bmRelayServer)\r\n        setHandler()\r\n      }, 5 * 1000)\r\n    }\r\n    const onError = () => {\r\n      console.error(`Error in WebSocket for ${config.bmRelayServer}`)\r\n      this.bmRelaySocket?.close(3000, 'onError')\r\n      onClose()\r\n    }\r\n    const setHandler = () => {\r\n      this.bmRelaySocket?.addEventListener('error', onError)\r\n      this.bmRelaySocket?.addEventListener('message', onMessage)\r\n      this.bmRelaySocket?.addEventListener('open', onOpen)\r\n      this.bmRelaySocket?.addEventListener('close', onClose)\r\n\r\n      /*  Use Idle\r\n      if ((window as any).requestIdleCallback){\r\n        const idleFunc = (deadline: IdleDeadline) => {\r\n          this.onIdle(deadline);\r\n          (window as any).requestIdleCallback(idleFunc)\r\n        }\r\n        (window as any).requestIdleCallback(idleFunc)\r\n      }*/\r\n      //  Use timer\r\n    }\r\n    this.bmRelaySocket = new WebSocket(config.bmRelayServer)\r\n    setHandler()\r\n  }\r\n\r\n  pushOrUpdateMessageViaRelay(type:string, value:any, dest?:string, sendRandP?:boolean) {\r\n    assert(config.bmRelayServer)\r\n    if (!this.bmRelaySocket || this.bmRelaySocket.readyState !== WebSocket.OPEN){ return }\r\n    if (!this.name || !participants.localId){\r\n      console.warn(`Relay Socket: Not connected. room:${this.name} id:${participants.localId}.`)\r\n\r\n      return\r\n    }\r\n\r\n\r\n    const msg:BMMessage = {t:type, v:''}\r\n    if (sendRandP) {\r\n      msg.r = this.name\r\n      msg.p = participants.localId\r\n    }\r\n    if (dest){\r\n      msg.d = dest\r\n    }\r\n    const idx = this.messagesToSendToRelay.findIndex(m =>\r\n      m.t === msg.t && m.r === msg.r && m.p === msg.p && m.d === msg.d)\r\n    if (idx >= 0){\r\n      if (stringArrayMessageTypesForClient.has(msg.t)){\r\n        const oldV = JSON.parse(this.messagesToSendToRelay[idx].v) as string[]\r\n        for(const ne of value as string[]){\r\n          if (oldV.findIndex(e => e === ne) < 0){ oldV.push(ne) }\r\n        }\r\n        this.messagesToSendToRelay[idx].v = JSON.stringify(oldV)\r\n      }else if (ObjectArrayMessageTypes.has(msg.t)){\r\n        const oldV = JSON.parse(this.messagesToSendToRelay[idx].v) as {id:string}[]\r\n        for(const ne of value as {id:string}[]){\r\n          const found = oldV.findIndex(e => e.id === ne.id)\r\n          if (found >= 0){\r\n            oldV[found] = ne\r\n          }else{\r\n            oldV.push(ne)\r\n          }\r\n        }\r\n        this.messagesToSendToRelay[idx].v = JSON.stringify(oldV)\r\n      }else{  //  overwrite\r\n        //console.log(`overwrite messageType: ${msg.t}`)\r\n        msg.v = JSON.stringify(value)\r\n        this.messagesToSendToRelay[idx] = msg\r\n      }\r\n    }else{\r\n      msg.v = JSON.stringify(value)\r\n      this.messagesToSendToRelay.push(msg)\r\n      //console.log(`msg:${JSON.stringify(msg)} messages: ${JSON.stringify(this.messagesToSendToRelay)}`)\r\n    }\r\n  }\r\n  private sendMessageViaRelay() {\r\n    if (this.messagesToSendToRelay.length === 0){ return }\r\n\r\n    if (this.bmRelaySocket?.readyState === WebSocket.OPEN){\r\n      this.bmRelaySocket.send(JSON.stringify(this.messagesToSendToRelay))\r\n      //  console.log(`Sent bmMessages: ${JSON.stringify(this.messagesToSendToRelay)}`)\r\n      this.messagesToSendToRelay = []\r\n    }else{\r\n      //  console.log(`Wait to send bmMessages: ${JSON.stringify(this.messagesToSendToRelay)}`)\r\n      this.bmRelaySocket?.addEventListener('open', ()=> {\r\n        const waitAndSend = ()=>{\r\n          if(this.bmRelaySocket?.readyState !== WebSocket.OPEN){\r\n            setTimeout(waitAndSend, 100)\r\n          }else{\r\n            this.bmRelaySocket?.send(JSON.stringify(this.messagesToSendToRelay))\r\n            this.messagesToSendToRelay = []\r\n          }\r\n        }\r\n        waitAndSend()\r\n      })\r\n    }\r\n  }\r\n\r\n  //  register event handlers\r\n  private registerJistiConferenceEvents() {\r\n    if (!this._jitsiConference) {\r\n      console.error('Dose not connected to conference yet.')\r\n\r\n      return\r\n    }\r\n    this._jitsiConference.on(CONF.ENDPOINT_MESSAGE_RECEIVED, (participant:JitsiParticipant, msg:any) => {\r\n      eventLog(`ENDPOINT_MESSAGE_RECEIVED from ${participant.getId()}`, msg)\r\n      if (msg.values) {\r\n        this.emit(msg.type, participant.getId(), msg.values)\r\n      }else {\r\n        this.emit(msg.type, participant.getId(), msg.value)\r\n      }\r\n    })\r\n    this._jitsiConference.on(CONF.PARTICIPANT_PROPERTY_CHANGED, (participant:JitsiParticipant, name: string,\r\n                                                                 oldValue:any, value:any) => {\r\n      eventLog(`PARTICIPANT_PROPERTY_CHANGED from ${participant.getId()} prop:${name} old,new:`, oldValue, value)\r\n      if (name !== 'codecType'){\r\n        this.emit(name, participant.getId(), JSON.parse(value), oldValue)\r\n      }\r\n    })\r\n    this._jitsiConference.on(CONF.CONFERENCE_JOINED, () => {\r\n      connLog('Joined to a conference room.')\r\n      this.onConferenceJoined()\r\n    })\r\n    this._jitsiConference.on(CONF.USER_JOINED, (id: string, user: JitsiParticipant) => {\r\n      connLog(`New participant[${id}] joined.`)\r\n      this.emit(ConferenceEvents.USER_JOINED, id, user)\r\n    })\r\n    this._jitsiConference.on(CONF.USER_LEFT, (id: string, user: JitsiParticipant) => {\r\n      this.emit(ConferenceEvents.USER_LEFT, id, user)\r\n      connLog('A participant left.')\r\n    })\r\n    this._jitsiConference.on(CONF.TRACK_ADDED, (track: JitsiTrack) => {\r\n      trackLog(`TRACK_ADDED: ${track} type:${track.getType()} usage:${track.getUsageLabel()} tid:${track.getId()} msid:${track.getOriginalStream().id}`)\r\n      if (track.isLocal()) {\r\n        this.onLocalTrackAdded(track as JitsiLocalTrack)\r\n      }else {\r\n        this.emit(ConferenceEvents.REMOTE_TRACK_ADDED, track)\r\n        setTimeout(() => {\r\n          this.reduceBitrate()\r\n        },         3000)\r\n      }\r\n    })\r\n    this._jitsiConference.on(CONF.TRACK_REMOVED, (track: JitsiTrack) => {\r\n      trackLog(`TRACK_REMOVED: ${track} type:${track.getType()} ${track.getUsageLabel()} tid:${track.getId()} msid:${track.getOriginalStream().id}`)\r\n      if (track.isLocal()) {\r\n        this.onLocalTrackRemoved(track as JitsiLocalTrack)\r\n      }else {\r\n        this.emit(ConferenceEvents.REMOTE_TRACK_REMOVED, track)\r\n      }\r\n    })\r\n    this._jitsiConference.on(CONF.REMOTE_TRACK_VIDEOTYPE_CHANGING, (track: JitsiRemoteTrack, newType: string) => {\r\n      participants.removeRemoteTrack(track)\r\n    })\r\n    this._jitsiConference.on(CONF.REMOTE_TRACK_VIDEOTYPE_CHANGED, (track: JitsiRemoteTrack, oldType: string) => {\r\n      participants.addRemoteTrack(track)\r\n    })\r\n    this._jitsiConference.on(CONF.TRACK_MUTE_CHANGED, (track: JitsiTrack) => {\r\n      trackLog(`TRACK_MUTE_CHANGED on ${track}.`)\r\n      if (track.isLocal()) { return }\r\n      const remoteTrack = track as JitsiRemoteTrack\r\n      const target = participants.find(remoteTrack.getParticipantId())\r\n      if (target && remoteTrack.isVideoTrack()) {\r\n        target.muteVideo = remoteTrack.isMuted()\r\n      }\r\n    })\r\n\r\n    this._jitsiConference.on(JitsiMeetJS.events.conference.TRACK_AUDIO_LEVEL_CHANGED, (id:string, level:number) => {\r\n      const participant = participantsStore.find(id)\r\n      if (participant) {\r\n        if (! (participant === participantsStore.local && participant.muteAudio)) {\r\n          participant?.tracks.setAudioLevel(level)\r\n          //\tconsole.log(`pid:${participant.id} audio:${level}`)\r\n        }else {\r\n          participant?.tracks.setAudioLevel(0)\r\n        }\r\n      }\r\n    })\r\n\r\n    this._jitsiConference.on(JitsiMeetJS.events.conference.PRIVATE_MESSAGE_RECEIVED,\r\n      (id:string, text:string, timeStamp:number) => {\r\n        eventLog('PRIVATE_MESSAGE_RECEIVED', id, text, timeStamp)\r\n        //  this.emit(ConferenceEvents.PRIVATE_MESSAGE_RECEIVED, id, text, timeStamp)\r\n    })\r\n    this._jitsiConference.on(JitsiMeetJS.events.conference.MESSAGE_RECEIVED,\r\n      (id:string, text:string, timeStamp:number) => {\r\n        eventLog('MESSAGE_RECEIVED', id, text, timeStamp)\r\n        //  this.emit(ConferenceEvents.MESSAGE_RECEIVED, id, text, timeStamp)\r\n    })\r\n\r\n    //  kicked\r\n    this._jitsiConference.on(JitsiMeetJS.events.conference.KICKED,\r\n      (p:JitsiParticipant, r:string)=>{this.sync.onKicked(p.getId(),r)})\r\n  }\r\n  /*\r\n  private video:undefined | HTMLVideoElement = undefined\r\n  private canvas:undefined | HTMLCanvasElement = undefined\r\n  private cameraTrackConverter(track: JitsiLocalTrack) {\r\n    if (!this.video) {\r\n      this.video = document.createElement('video')\r\n    }\r\n    this.video.srcObject = new MediaStream([track.getTrack()])\r\n    let aspectRatio = track.getTrack().getSettings().aspectRatio\r\n    const videoCfg = config.rtc.videoConstraints.video\r\n    const VIDEO_SIZE = videoCfg.height.ideal ? videoCfg.height.ideal : videoCfg.width.ideal ? videoCfg.width.ideal : 360\r\n    if (!aspectRatio) { aspectRatio = 1 }\r\n    let sx = 0\r\n    let sy = 0\r\n    if (aspectRatio < 1) {\r\n      this.video.style.width = `${VIDEO_SIZE}px`\r\n      sy = (1 / aspectRatio - 1) * VIDEO_SIZE / 2\r\n    }else {\r\n      this.video.style.height = `${VIDEO_SIZE}px`\r\n      sx = (aspectRatio - 1) * VIDEO_SIZE / 2\r\n    }\r\n    this.video.autoplay = true\r\n    if (!this.canvas) {\r\n      this.canvas = document.createElement('canvas')\r\n      this.canvas.style.width = `${VIDEO_SIZE}px`\r\n      this.canvas.style.height = `${VIDEO_SIZE}px`\r\n      const ctx = this.canvas.getContext('2d')\r\n      const drawVideo = () => {\r\n        if (this.video) {\r\n          ctx?.drawImage(this.video, sx, sy, VIDEO_SIZE, VIDEO_SIZE, 0, 0, VIDEO_SIZE, VIDEO_SIZE)\r\n        }\r\n      }\r\n      const FRAMERATE = 20\r\n      setInterval(drawVideo, 1000 / FRAMERATE)\r\n      const stream = (this.canvas as any).captureStream(FRAMERATE) as MediaStream\r\n      (track as any).track = stream.getVideoTracks()[0]\r\n    }\r\n  }\r\n  */\r\n  private onConferenceJoined() {\r\n    //  set localId\r\n    this.localId = this._jitsiConference!.myUserId()\r\n    participants.setLocalId(this.localId)\r\n    this.sync.observeStart()\r\n    //  create tracks\r\n    for (const prop in participants.local.devicePreference) {\r\n      if (participants.local.devicePreference[prop] === undefined) {\r\n        participants.local.devicePreference[prop] = ''\r\n      }\r\n    }\r\n\r\n    //  load wallpapers after 2secs\r\n    if (!config.bmRelayServer){\r\n      setTimeout(contents.loadWallpaper.bind(contents), 2000)\r\n    }\r\n\r\n    //  request remote info\r\n    if (config.bmRelayServer){\r\n      this.connectToRelayServer()\r\n    }\r\n  }\r\n\r\n  private onLocalTrackAdded(track: JitsiLocalTrack) {\r\n    const local = participants.local\r\n    if (track.isAudioTrack()) {\r\n      if (local.muteAudio) { track.mute() }\r\n      else { track.unmute() }\r\n      local.tracks.audio = track\r\n    } else {\r\n      local.tracks.avatar = track\r\n      if (local.muteVideo) { this.removeTrack(track) }\r\n    }\r\n  }\r\n  private onLocalTrackRemoved(track: JitsiLocalTrack) {\r\n    const local = participants.local\r\n    if (track.isAudioTrack()) {\r\n      local.tracks.audio = undefined\r\n    } else {\r\n      local.tracks.avatar = undefined\r\n    }\r\n  }\r\n  public getLocalTracks(track ?: TMediaType):JitsiLocalTrack[] {\r\n    return this._jitsiConference ? this._jitsiConference.getLocalTracks(track) : []\r\n  }\r\n  public getLocalVideoTrack(): JitsiLocalTrack | null {\r\n    return this._jitsiConference ? this._jitsiConference.getLocalVideoTrack() : null\r\n  }\r\n  public replaceTrack(oldTrack: JitsiLocalTrack, newTrack: JitsiLocalTrack) {\r\n    if (this._jitsiConference) {\r\n      this._jitsiConference.replaceTrack(oldTrack, newTrack)\r\n    }\r\n  }\r\n  public removeTrack(track: JitsiLocalTrack) {\r\n    return this._jitsiConference?.removeTrack(track)\r\n  }\r\n  public removeTracks(tracks: JitsiLocalTrack[]) {\r\n    tracks.forEach(track =>  this._jitsiConference?.removeTrack(track))\r\n  }\r\n  public addTrack(track: JitsiLocalTrack) {\r\n    this._jitsiConference?.addTrack(track)\r\n  }\r\n  public addTracks(tracks: JitsiLocalTrack[]) {\r\n    for (const track of tracks) {\r\n      if (track !== tracks[tracks.length - 1]) {\r\n        this._jitsiConference?.addTrack(track)\r\n      }else {\r\n        this._jitsiConference?.addTrack(track).then(() => {\r\n          if (TRACKLOG) {\r\n            const locals = this._jitsiConference?.getLocalTracks()\r\n            if (locals) {\r\n              console.groupCollapsed(`addTracks([${tracks.length}]) called for ${tracks.map(t => t.rtcId)}`)\r\n              for (const t of locals) {\r\n                console.log(`${t} rtcid:${t.rtcId} msid:${t.getOriginalStream().id}`)\r\n              }\r\n              console.groupEnd()\r\n            }\r\n          }\r\n        })\r\n      }\r\n    }\r\n  }\r\n}\r\n","/* global __filename */\r\n\r\nimport Logger from 'jitsi-meet-logger';\r\n\r\nimport * as JitsiConferenceErrors from './JitsiConferenceErrors';\r\nimport * as JitsiConferenceEvents from './JitsiConferenceEvents';\r\nimport JitsiConnection from './JitsiConnection';\r\nimport * as JitsiConnectionErrors from './JitsiConnectionErrors';\r\nimport * as JitsiConnectionEvents from './JitsiConnectionEvents';\r\nimport JitsiMediaDevices from './JitsiMediaDevices';\r\nimport * as JitsiMediaDevicesEvents from './JitsiMediaDevicesEvents';\r\nimport JitsiTrackError from './JitsiTrackError';\r\nimport * as JitsiTrackErrors from './JitsiTrackErrors';\r\nimport * as JitsiTrackEvents from './JitsiTrackEvents';\r\nimport * as JitsiTranscriptionStatus from './JitsiTranscriptionStatus';\r\nimport RTC from './modules/RTC/RTC';\r\nimport browser from './modules/browser';\r\nimport NetworkInfo from './modules/connectivity/NetworkInfo';\r\nimport { ParticipantConnectionStatus }\r\n    from './modules/connectivity/ParticipantConnectionStatus';\r\nimport getActiveAudioDevice from './modules/detection/ActiveDeviceDetector';\r\nimport * as DetectionEvents from './modules/detection/DetectionEvents';\r\nimport TrackVADEmitter from './modules/detection/TrackVADEmitter';\r\nimport ProxyConnectionService\r\n    from './modules/proxyconnection/ProxyConnectionService';\r\nimport recordingConstants from './modules/recording/recordingConstants';\r\nimport Settings from './modules/settings/Settings';\r\nimport LocalStatsCollector from './modules/statistics/LocalStatsCollector';\r\nimport precallTest from './modules/statistics/PrecallTest';\r\nimport Statistics from './modules/statistics/statistics';\r\nimport AuthUtil from './modules/util/AuthUtil';\r\nimport GlobalOnErrorHandler from './modules/util/GlobalOnErrorHandler';\r\nimport ScriptUtil from './modules/util/ScriptUtil';\r\nimport * as VideoSIPGWConstants from './modules/videosipgw/VideoSIPGWConstants';\r\nimport AudioMixer from './modules/webaudio/AudioMixer';\r\nimport * as MediaType from './service/RTC/MediaType';\r\nimport * as ConnectionQualityEvents\r\n    from './service/connectivity/ConnectionQualityEvents';\r\nimport * as E2ePingEvents from './service/e2eping/E2ePingEvents';\r\nimport { createGetUserMediaEvent } from './service/statistics/AnalyticsEvents';\r\n\r\nconst logger = Logger.getLogger(__filename);\r\n\r\n/**\r\n * The amount of time to wait until firing\r\n * {@link JitsiMediaDevicesEvents.PERMISSION_PROMPT_IS_SHOWN} event.\r\n */\r\nconst USER_MEDIA_SLOW_PROMISE_TIMEOUT = 1000;\r\n\r\n/**\r\n * Extracts from an 'options' objects with a specific format (TODO what IS the\r\n * format?) the attributes which are to be logged in analytics events.\r\n *\r\n * @param options gum options (???)\r\n * @returns {*} the attributes to attach to analytics events.\r\n */\r\nfunction getAnalyticsAttributesFromOptions(options) {\r\n    const attributes = {\r\n        'audio_requested':\r\n            options.devices.includes('audio'),\r\n        'video_requested':\r\n            options.devices.includes('video'),\r\n        'screen_sharing_requested':\r\n            options.devices.includes('desktop')\r\n    };\r\n\r\n    if (attributes.video_requested) {\r\n        attributes.resolution = options.resolution;\r\n    }\r\n\r\n    return attributes;\r\n}\r\n\r\n/**\r\n * Tries to deal with the following problem: {@code JitsiMeetJS} is not only\r\n * this module, it's also a global (i.e. attached to {@code window}) namespace\r\n * for all globals of the projects in the Jitsi Meet family. If lib-jitsi-meet\r\n * is loaded through an HTML {@code script} tag, {@code JitsiMeetJS} will\r\n * automatically be attached to {@code window} by webpack. Unfortunately,\r\n * webpack's source code does not check whether the global variable has already\r\n * been assigned and overwrites it. Which is OK for the module\r\n * {@code JitsiMeetJS} but is not OK for the namespace {@code JitsiMeetJS}\r\n * because it may already contain the values of other projects in the Jitsi Meet\r\n * family. The solution offered here works around webpack by merging all\r\n * existing values of the namespace {@code JitsiMeetJS} into the module\r\n * {@code JitsiMeetJS}.\r\n *\r\n * @param {Object} module - The module {@code JitsiMeetJS} (which will be\r\n * exported and may be attached to {@code window} by webpack later on).\r\n * @private\r\n * @returns {Object} - A {@code JitsiMeetJS} module which contains all existing\r\n * value of the namespace {@code JitsiMeetJS} (if any).\r\n */\r\nfunction _mergeNamespaceAndModule(module) {\r\n    return (\r\n        typeof window.JitsiMeetJS === 'object'\r\n            ? Object.assign({}, window.JitsiMeetJS, module)\r\n            : module);\r\n}\r\n\r\n/**\r\n * The public API of the Jitsi Meet library (a.k.a. {@code JitsiMeetJS}).\r\n */\r\nexport default _mergeNamespaceAndModule({\r\n\r\n    version: '{#COMMIT_HASH#}',\r\n\r\n    JitsiConnection,\r\n\r\n    /**\r\n     * {@code ProxyConnectionService} is used to connect a remote peer to a\r\n     * local Jitsi participant without going through a Jitsi conference. It is\r\n     * currently used for room integration development, specifically wireless\r\n     * screensharing. Its API is experimental and will likely change; usage of\r\n     * it is advised against.\r\n     */\r\n    ProxyConnectionService,\r\n\r\n    constants: {\r\n        participantConnectionStatus: ParticipantConnectionStatus,\r\n        recording: recordingConstants,\r\n        sipVideoGW: VideoSIPGWConstants,\r\n        transcriptionStatus: JitsiTranscriptionStatus\r\n    },\r\n    events: {\r\n        conference: JitsiConferenceEvents,\r\n        connection: JitsiConnectionEvents,\r\n        detection: DetectionEvents,\r\n        track: JitsiTrackEvents,\r\n        mediaDevices: JitsiMediaDevicesEvents,\r\n        connectionQuality: ConnectionQualityEvents,\r\n        e2eping: E2ePingEvents\r\n    },\r\n    errors: {\r\n        conference: JitsiConferenceErrors,\r\n        connection: JitsiConnectionErrors,\r\n        track: JitsiTrackErrors\r\n    },\r\n    errorTypes: {\r\n        JitsiTrackError\r\n    },\r\n    logLevels: Logger.levels,\r\n    mediaDevices: JitsiMediaDevices,\r\n    analytics: Statistics.analytics,\r\n    init(options = {}) {\r\n        Settings.init(options.externalStorage);\r\n        Statistics.init(options);\r\n\r\n        // Initialize global window.connectionTimes\r\n        // FIXME do not use 'window'\r\n        if (!window.connectionTimes) {\r\n            window.connectionTimes = {};\r\n        }\r\n\r\n        if (options.enableAnalyticsLogging !== true) {\r\n            logger.warn('Analytics disabled, disposing.');\r\n            this.analytics.dispose();\r\n        }\r\n\r\n        if (options.enableWindowOnErrorHandler) {\r\n            GlobalOnErrorHandler.addHandler(\r\n                this.getGlobalOnErrorHandler.bind(this));\r\n        }\r\n\r\n        // Log deployment-specific information, if available. Defined outside\r\n        // the application by individual deployments\r\n        const aprops = options.deploymentInfo;\r\n\r\n        if (aprops && Object.keys(aprops).length > 0) {\r\n            const logObject = {};\r\n\r\n            for (const attr in aprops) {\r\n                if (aprops.hasOwnProperty(attr)) {\r\n                    logObject[attr] = aprops[attr];\r\n                }\r\n            }\r\n\r\n            logObject.id = 'deployment_info';\r\n            Statistics.sendLog(JSON.stringify(logObject));\r\n        }\r\n\r\n        if (this.version) {\r\n            const logObject = {\r\n                id: 'component_version',\r\n                component: 'lib-jitsi-meet',\r\n                version: this.version\r\n            };\r\n\r\n            Statistics.sendLog(JSON.stringify(logObject));\r\n        }\r\n\r\n        return RTC.init(options);\r\n    },\r\n\r\n    /**\r\n     * Returns whether the desktop sharing is enabled or not.\r\n     *\r\n     * @returns {boolean}\r\n     */\r\n    isDesktopSharingEnabled() {\r\n        return RTC.isDesktopSharingEnabled();\r\n    },\r\n\r\n    /**\r\n     * Returns whether the current execution environment supports WebRTC (for\r\n     * use within this library).\r\n     *\r\n     * @returns {boolean} {@code true} if WebRTC is supported in the current\r\n     * execution environment (for use within this library); {@code false},\r\n     * otherwise.\r\n     */\r\n    isWebRtcSupported() {\r\n        return RTC.isWebRtcSupported();\r\n    },\r\n\r\n    setLogLevel(level) {\r\n        Logger.setLogLevel(level);\r\n    },\r\n\r\n    /**\r\n     * Sets the log level to the <tt>Logger</tt> instance with given id.\r\n     *\r\n     * @param {Logger.levels} level the logging level to be set\r\n     * @param {string} id the logger id to which new logging level will be set.\r\n     * Usually it's the name of the JavaScript source file including the path\r\n     * ex. \"modules/xmpp/ChatRoom.js\"\r\n     */\r\n    setLogLevelById(level, id) {\r\n        Logger.setLogLevelById(level, id);\r\n    },\r\n\r\n    /**\r\n     * Registers new global logger transport to the library logging framework.\r\n     *\r\n     * @param globalTransport\r\n     * @see Logger.addGlobalTransport\r\n     */\r\n    addGlobalLogTransport(globalTransport) {\r\n        Logger.addGlobalTransport(globalTransport);\r\n    },\r\n\r\n    /**\r\n     * Removes global logging transport from the library logging framework.\r\n     *\r\n     * @param globalTransport\r\n     * @see Logger.removeGlobalTransport\r\n     */\r\n    removeGlobalLogTransport(globalTransport) {\r\n        Logger.removeGlobalTransport(globalTransport);\r\n    },\r\n\r\n    /**\r\n    * Sets global options which will be used by all loggers. Changing these\r\n    * works even after other loggers are created.\r\n    *\r\n    * @param options\r\n    * @see Logger.setGlobalOptions\r\n    */\r\n    setGlobalLogOptions(options) {\r\n        Logger.setGlobalOptions(options);\r\n    },\r\n\r\n    /**\r\n     * Creates the media tracks and returns them trough the callback.\r\n     *\r\n     * @param options Object with properties / settings specifying the tracks\r\n     * which should be created. should be created or some additional\r\n     * configurations about resolution for example.\r\n     * @param {Array} options.effects optional effects array for the track\r\n     * @param {boolean} options.firePermissionPromptIsShownEvent - if event\r\n     * JitsiMediaDevicesEvents.PERMISSION_PROMPT_IS_SHOWN should be fired\r\n     * @param {boolean} options.fireSlowPromiseEvent - if event\r\n     * JitsiMediaDevicesEvents.USER_MEDIA_SLOW_PROMISE_TIMEOUT should be fired\r\n     * @param {Array} options.devices the devices that will be requested\r\n     * @param {string} options.resolution resolution constraints\r\n     * @param {string} options.cameraDeviceId\r\n     * @param {string} options.micDeviceId\r\n     * @param {intiger} interval - the interval (in ms) for\r\n     * checking whether the desktop sharing extension is installed or not\r\n     * @param {Function} checkAgain - returns boolean. While checkAgain()==true\r\n     * createLocalTracks will wait and check on every \"interval\" ms for the\r\n     * extension. If the desktop extension is not install and checkAgain()==true\r\n     * createLocalTracks will finish with rejected Promise.\r\n     * @param {Function} listener - The listener will be called to notify the\r\n     * user of lib-jitsi-meet that createLocalTracks is starting external\r\n     * extension installation process.\r\n     * NOTE: If the inline installation process is not possible and external\r\n     * installation is enabled the listener property will be called to notify\r\n     * the start of external installation process. After that createLocalTracks\r\n     * will start to check for the extension on every interval ms until the\r\n     * plugin is installed or until checkAgain return false. If the extension\r\n     * is found createLocalTracks will try to get the desktop sharing track and\r\n     * will finish the execution. If checkAgain returns false, createLocalTracks\r\n     * will finish the execution with rejected Promise.\r\n     *\r\n     * @deprecated old firePermissionPromptIsShownEvent\r\n     * @returns {Promise.<{Array.<JitsiTrack>}, JitsiConferenceError>} A promise\r\n     * that returns an array of created JitsiTracks if resolved, or a\r\n     * JitsiConferenceError if rejected.\r\n     */\r\n    createLocalTracks(options = {}, oldfirePermissionPromptIsShownEvent) {\r\n        let promiseFulfilled = false;\r\n\r\n        const { firePermissionPromptIsShownEvent, fireSlowPromiseEvent, ...restOptions } = options;\r\n        const firePermissionPrompt = firePermissionPromptIsShownEvent || oldfirePermissionPromptIsShownEvent;\r\n\r\n        if (firePermissionPrompt && !RTC.arePermissionsGrantedForAvailableDevices()) {\r\n            JitsiMediaDevices.emitEvent(\r\n                JitsiMediaDevicesEvents.PERMISSION_PROMPT_IS_SHOWN,\r\n                browser.getName());\r\n        } else if (fireSlowPromiseEvent) {\r\n            window.setTimeout(() => {\r\n                if (!promiseFulfilled) {\r\n                    JitsiMediaDevices.emitEvent(JitsiMediaDevicesEvents.SLOW_GET_USER_MEDIA);\r\n                }\r\n            }, USER_MEDIA_SLOW_PROMISE_TIMEOUT);\r\n        }\r\n\r\n        if (!window.connectionTimes) {\r\n            window.connectionTimes = {};\r\n        }\r\n        window.connectionTimes['obtainPermissions.start']\r\n            = window.performance.now();\r\n\r\n        return RTC.obtainAudioAndVideoPermissions(restOptions)\r\n            .then(tracks => {\r\n                promiseFulfilled = true;\r\n\r\n                window.connectionTimes['obtainPermissions.end']\r\n                    = window.performance.now();\r\n\r\n                Statistics.sendAnalytics(\r\n                    createGetUserMediaEvent(\r\n                        'success',\r\n                        getAnalyticsAttributesFromOptions(restOptions)));\r\n\r\n                if (!RTC.options.disableAudioLevels) {\r\n                    for (let i = 0; i < tracks.length; i++) {\r\n                        const track = tracks[i];\r\n                        const mStream = track.getOriginalStream();\r\n\r\n                        if (track.getType() === MediaType.AUDIO) {\r\n                            Statistics.startLocalStats(mStream,\r\n                                track.setAudioLevel.bind(track));\r\n                            track.addEventListener(\r\n                                JitsiTrackEvents.LOCAL_TRACK_STOPPED,\r\n                                () => {\r\n                                    Statistics.stopLocalStats(mStream);\r\n                                });\r\n                        }\r\n                    }\r\n                }\r\n\r\n                // set real device ids\r\n                const currentlyAvailableMediaDevices\r\n                    = RTC.getCurrentlyAvailableMediaDevices();\r\n\r\n                if (currentlyAvailableMediaDevices) {\r\n                    for (let i = 0; i < tracks.length; i++) {\r\n                        const track = tracks[i];\r\n\r\n                        track._setRealDeviceIdFromDeviceList(\r\n                            currentlyAvailableMediaDevices);\r\n                    }\r\n                }\r\n\r\n                // set the contentHint to \"detail\" for desktop tracks\r\n                // eslint-disable-next-line prefer-const\r\n                for (const track of tracks) {\r\n                    if (track.type === MediaType.VIDEO\r\n                        && track.videoType === 'desktop') {\r\n                        this.setVideoTrackContentHints(track.track, 'detail');\r\n                    }\r\n                }\r\n\r\n                return tracks;\r\n            })\r\n            .catch(error => {\r\n                promiseFulfilled = true;\r\n\r\n                if (error.name === JitsiTrackErrors.SCREENSHARING_USER_CANCELED) {\r\n                    // User cancelled action is not really an error, so only\r\n                    // log it as an event to avoid having conference classified\r\n                    // as partially failed\r\n                    const logObject = {\r\n                        id: 'screensharing_user_canceled',\r\n                        message: error.message\r\n                    };\r\n\r\n                    Statistics.sendLog(JSON.stringify(logObject));\r\n\r\n                    Statistics.sendAnalytics(\r\n                        createGetUserMediaEvent(\r\n                            'warning',\r\n                            {\r\n                                reason: 'extension install user canceled'\r\n                            }));\r\n                } else if (error.name === JitsiTrackErrors.NOT_FOUND) {\r\n                    // logs not found devices with just application log to cs\r\n                    const logObject = {\r\n                        id: 'usermedia_missing_device',\r\n                        status: error.gum.devices\r\n                    };\r\n\r\n                    Statistics.sendLog(JSON.stringify(logObject));\r\n\r\n                    const attributes\r\n                        = getAnalyticsAttributesFromOptions(options);\r\n\r\n                    attributes.reason = 'device not found';\r\n                    attributes.devices = error.gum.devices.join('.');\r\n                    Statistics.sendAnalytics(\r\n                        createGetUserMediaEvent('error', attributes));\r\n                } else {\r\n                    // Report gUM failed to the stats\r\n                    Statistics.sendGetUserMediaFailed(error);\r\n\r\n                    const attributes\r\n                        = getAnalyticsAttributesFromOptions(options);\r\n\r\n                    attributes.reason = error.name;\r\n                    Statistics.sendAnalytics(\r\n                        createGetUserMediaEvent('error', attributes));\r\n                }\r\n\r\n                window.connectionTimes['obtainPermissions.end']\r\n                    = window.performance.now();\r\n\r\n                return Promise.reject(error);\r\n            });\r\n    },\r\n\r\n    /**\r\n     * Create a TrackVADEmitter service that connects an audio track to an VAD (voice activity detection) processor in\r\n     * order to obtain VAD scores for individual PCM audio samples.\r\n     * @param {string} localAudioDeviceId - The target local audio device.\r\n     * @param {number} sampleRate - Sample rate at which the emitter will operate. Possible values  256, 512, 1024,\r\n     * 4096, 8192, 16384. Passing other values will default to closes neighbor.\r\n     * I.e. Providing a value of 4096 means that the emitter will process 4096 PCM samples at a time, higher values mean\r\n     * longer calls, lowers values mean more calls but shorter.\r\n     * @param {Object} vadProcessor - VAD Processors that does the actual compute on a PCM sample.The processor needs\r\n     * to implement the following functions:\r\n     * - <tt>getSampleLength()</tt> - Returns the sample size accepted by calculateAudioFrameVAD.\r\n     * - <tt>getRequiredPCMFrequency()</tt> - Returns the PCM frequency at which the processor operates.\r\n     * i.e. (16KHz, 44.1 KHz etc.)\r\n     * - <tt>calculateAudioFrameVAD(pcmSample)</tt> - Process a 32 float pcm sample of getSampleLength size.\r\n     * @returns {Promise<TrackVADEmitter>}\r\n     */\r\n    createTrackVADEmitter(localAudioDeviceId, sampleRate, vadProcessor) {\r\n        return TrackVADEmitter.create(localAudioDeviceId, sampleRate, vadProcessor);\r\n    },\r\n\r\n    /**\r\n     * Create AudioMixer, which is essentially a wrapper over web audio ChannelMergerNode. It essentially allows the\r\n     * user to mix multiple MediaStreams into a single one.\r\n     *\r\n     * @returns {AudioMixer}\r\n     */\r\n    createAudioMixer() {\r\n        return new AudioMixer();\r\n    },\r\n\r\n    /**\r\n     * Go through all audio devices on the system and return one that is active, i.e. has audio signal.\r\n     *\r\n     * @returns Promise<Object> - Object containing information about the found device.\r\n     */\r\n    getActiveAudioDevice() {\r\n        return getActiveAudioDevice();\r\n    },\r\n\r\n    /**\r\n     * Checks if its possible to enumerate available cameras/microphones.\r\n     *\r\n     * @returns {Promise<boolean>} a Promise which will be resolved only once\r\n     * the WebRTC stack is ready, either with true if the device listing is\r\n     * available available or with false otherwise.\r\n     * @deprecated use JitsiMeetJS.mediaDevices.isDeviceListAvailable instead\r\n     */\r\n    isDeviceListAvailable() {\r\n        logger.warn('This method is deprecated, use '\r\n            + 'JitsiMeetJS.mediaDevices.isDeviceListAvailable instead');\r\n\r\n        return this.mediaDevices.isDeviceListAvailable();\r\n    },\r\n\r\n    /**\r\n     * Returns true if changing the input (camera / microphone) or output\r\n     * (audio) device is supported and false if not.\r\n     *\r\n     * @param {string} [deviceType] - type of device to change. Default is\r\n     * {@code undefined} or 'input', 'output' - for audio output device change.\r\n     * @returns {boolean} {@code true} if available; {@code false}, otherwise.\r\n     * @deprecated use JitsiMeetJS.mediaDevices.isDeviceChangeAvailable instead\r\n     */\r\n    isDeviceChangeAvailable(deviceType) {\r\n        logger.warn('This method is deprecated, use '\r\n            + 'JitsiMeetJS.mediaDevices.isDeviceChangeAvailable instead');\r\n\r\n        return this.mediaDevices.isDeviceChangeAvailable(deviceType);\r\n    },\r\n\r\n\r\n    /**\r\n     * Checks if the current environment supports having multiple audio\r\n     * input devices in use simultaneously.\r\n     *\r\n     * @returns {boolean} True if multiple audio input devices can be used.\r\n     */\r\n    isMultipleAudioInputSupported() {\r\n        return this.mediaDevices.isMultipleAudioInputSupported();\r\n    },\r\n\r\n    /**\r\n     * Checks if local tracks can collect stats and collection is enabled.\r\n     *\r\n     * @param {boolean} True if stats are being collected for local tracks.\r\n     */\r\n    isCollectingLocalStats() {\r\n        return Statistics.audioLevelsEnabled\r\n            && LocalStatsCollector.isLocalStatsSupported();\r\n    },\r\n\r\n    /**\r\n     * Executes callback with list of media devices connected.\r\n     *\r\n     * @param {function} callback\r\n     * @deprecated use JitsiMeetJS.mediaDevices.enumerateDevices instead\r\n     */\r\n    enumerateDevices(callback) {\r\n        logger.warn('This method is deprecated, use '\r\n            + 'JitsiMeetJS.mediaDevices.enumerateDevices instead');\r\n        this.mediaDevices.enumerateDevices(callback);\r\n    },\r\n\r\n    /* eslint-disable max-params */\r\n\r\n    /**\r\n     * @returns function that can be used to be attached to window.onerror and\r\n     * if options.enableWindowOnErrorHandler is enabled returns\r\n     * the function used by the lib.\r\n     * (function(message, source, lineno, colno, error)).\r\n     */\r\n    getGlobalOnErrorHandler(message, source, lineno, colno, error) {\r\n        logger.error(\r\n            `UnhandledError: ${message}`,\r\n            `Script: ${source}`,\r\n            `Line: ${lineno}`,\r\n            `Column: ${colno}`,\r\n            'StackTrace: ', error);\r\n        Statistics.reportGlobalError(error);\r\n    },\r\n\r\n    /**\r\n     * Informs lib-jitsi-meet about the current network status.\r\n     *\r\n     * @param {boolean} isOnline - {@code true} if the internet connectivity is online or {@code false}\r\n     * otherwise.\r\n     */\r\n    setNetworkInfo({ isOnline }) {\r\n        NetworkInfo.updateNetworkInfo({ isOnline });\r\n    },\r\n\r\n    /**\r\n     * Set the contentHint on the transmitted stream track to indicate\r\n     * charaterstics in the video stream, which informs PeerConnection\r\n     * on how to encode the track (to prefer motion or individual frame detail)\r\n     * @param {MediaStreamTrack} track - the track that is transmitted\r\n     * @param {String} hint - contentHint value that needs to be set on the track\r\n     */\r\n    setVideoTrackContentHints(track, hint) {\r\n        if ('contentHint' in track) {\r\n            track.contentHint = hint;\r\n            if (track.contentHint !== hint) {\r\n                logger.debug('Invalid video track contentHint');\r\n            }\r\n        } else {\r\n            logger.debug('MediaStreamTrack contentHint attribute not supported');\r\n        }\r\n    },\r\n\r\n    precallTest,\r\n\r\n    /* eslint-enable max-params */\r\n\r\n    /**\r\n     * Represents a hub/namespace for utility functionality which may be of\r\n     * interest to lib-jitsi-meet clients.\r\n     */\r\n    util: {\r\n        AuthUtil,\r\n        ScriptUtil,\r\n        browser\r\n    }\r\n});\r\n","const Constants = {\r\n    LOCAL_JID: 'local'\r\n};\r\n\r\nmodule.exports = Constants;\r\n","/* eslint-disable max-params */\r\n\r\n/**\r\n * This object stores variables needed around the recording of an audio stream\r\n * and passing this recording along with additional information along to\r\n * different processes\r\n * @param blob the recording audio stream as a single blob\r\n * @param name the name of the person of the audio stream\r\n * @param startTime the time in UTC when recording of the audiostream started\r\n * @param wordArray the recorder audio stream transcribed as an array of Word\r\n *                  objects\r\n */\r\nconst RecordingResult = function(blob, name, startTime, wordArray) {\r\n    this.blob = blob;\r\n    this.name = name;\r\n    this.startTime = startTime;\r\n    this.wordArray = wordArray;\r\n};\r\n\r\n/* eslint-enable max-params */\r\n\r\nmodule.exports = RecordingResult;\r\n","/* global config */\r\n\r\nconst Word = require('../word');\r\n\r\nconst audioRecorder = require('./../audioRecorder');\r\nconst TranscriptionService = require('./AbstractTranscriptionService');\r\n\r\n/**\r\n * Implements a TranscriptionService for a Sphinx4 http server\r\n */\r\nconst SphinxService = function() {\r\n    // set the correct url\r\n    this.url = getURL();\r\n};\r\n\r\n/**\r\n * Subclass of AbstractTranscriptionService\r\n */\r\nSphinxService.prototype = Object.create(TranscriptionService.prototype);\r\n\r\n/**\r\n * Set the right constructor\r\n */\r\nSphinxService.constructor = SphinxService;\r\n\r\n/**\r\n * Overrides the sendRequest method from AbstractTranscriptionService\r\n * it will send the audio stream the a Sphinx4 server to get the transcription\r\n *\r\n * @param audioFileBlob the recorder audio stream an a single Blob\r\n * @param callback the callback function retrieving the server response\r\n */\r\nSphinxService.prototype.sendRequest = function(audioFileBlob, callback) {\r\n    console.log(`sending an audio file  to ${this.url}`);\r\n    console.log(`the audio file being sent: ${audioFileBlob}`);\r\n    const request = new XMLHttpRequest();\r\n\r\n    request.onreadystatechange = function() {\r\n        if (request.readyState === XMLHttpRequest.DONE\r\n            && request.status === 200) {\r\n            callback(request.responseText);\r\n        } else if (request.readyState === XMLHttpRequest.DONE) {\r\n            throw new Error(\r\n                `unable to accept response from sphinx server. status: ${\r\n                    request.status}`);\r\n        }\r\n\r\n        // if not ready no point to throw an error\r\n    };\r\n    request.open('POST', this.url);\r\n    request.setRequestHeader('Content-Type',\r\n        audioRecorder.determineCorrectFileType());\r\n    request.send(audioFileBlob);\r\n    console.log(`send ${audioFileBlob}`);\r\n};\r\n\r\n/**\r\n * Overrides the formatResponse method from AbstractTranscriptionService\r\n * It will parse the answer from the server in the expected format\r\n *\r\n * @param response the JSON body retrieved from the Sphinx4 server\r\n */\r\nSphinxService.prototype.formatResponse = function(response) {\r\n    const result = JSON.parse(response).objects;\r\n\r\n    // make sure to delete the session id object, which is always\r\n    // the first value in the JSON array\r\n\r\n    result.shift();\r\n    const array = [];\r\n\r\n    result.forEach(\r\n        word =>\r\n            word.filler\r\n                || array.push(new Word(word.word, word.start, word.end)));\r\n\r\n    return array;\r\n};\r\n\r\n/**\r\n * checks wether the reply is empty, or doesn't contain a correct JSON object\r\n * @param response the server response\r\n * @return {boolean} whether the response is valid\r\n */\r\nSphinxService.prototype.verify = function(response) {\r\n    console.log(`response from server:${response.toString()}`);\r\n\r\n    // test if server responded with a string object\r\n    if (typeof response !== 'string') {\r\n        return false;\r\n    }\r\n\r\n    // test if the string can be parsed into valid JSON\r\n    let json;\r\n\r\n    try {\r\n        json = JSON.parse(response);\r\n    } catch (error) {\r\n        console.log(error);\r\n\r\n        return false;\r\n    }\r\n\r\n    // check if the JSON has a \"objects\" value\r\n    if (json.objects === undefined) {\r\n        return false;\r\n    }\r\n\r\n    // get the \"objects\" value and check for a session ID\r\n    const array = json.objects;\r\n\r\n    if (!(array[0] && array[0]['session-id'])) {\r\n        return false;\r\n    }\r\n\r\n    // everything seems to be in order\r\n    return true;\r\n};\r\n\r\n/**\r\n * Gets the URL to the Sphinx4 server from the config file. If it's not there,\r\n * it will throw an error\r\n *\r\n * @returns {string} the URL to the sphinx4 server\r\n */\r\nfunction getURL() {\r\n    const message = 'config does not contain an url to a Sphinx4 https server';\r\n\r\n    if (config.sphinxURL === undefined) {\r\n        console.log(message);\r\n    } else {\r\n        const toReturn = config.sphinxURL;\r\n\r\n        if (toReturn.includes !== undefined && toReturn.includes('https://')) {\r\n            return toReturn;\r\n        }\r\n        console.log(message);\r\n\r\n    }\r\n}\r\n\r\nmodule.exports = SphinxService;\r\n","/**\r\n * An object representing a transcribed word, with some additional information\r\n * @param word the word\r\n * @param begin the time the word was started being uttered\r\n * @param end the time the word stopped being uttered\r\n */\r\nconst Word = function(word, begin, end) {\r\n    this.word = word;\r\n    this.begin = begin;\r\n    this.end = end;\r\n};\r\n\r\n/**\r\n * Get the string representation of the word\r\n * @returns {*} the word as a string\r\n */\r\nWord.prototype.getWord = function() {\r\n    return this.word;\r\n};\r\n\r\n/**\r\n * Get the time the word started being uttered\r\n * @returns {*} the start time as an integer\r\n */\r\nWord.prototype.getBeginTime = function() {\r\n    return this.begin;\r\n};\r\n\r\n/**\r\n * Get the time the word stopped being uttered\r\n * @returns {*} the end time as an integer\r\n */\r\nWord.prototype.getEndTime = function() {\r\n    return this.end;\r\n};\r\n\r\nmodule.exports = Word;\r\n","/**\r\n * Abstract class representing an interface to implement a speech-to-text\r\n * service on.\r\n */\r\nconst TranscriptionService = function() {\r\n    throw new Error('TranscriptionService is abstract and cannot be'\r\n        + 'created');\r\n};\r\n\r\n/**\r\n * This method can be used to send the recorder audio stream and\r\n * retrieve the answer from the transcription service from the callback\r\n *\r\n * @param {RecordingResult} recordingResult a recordingResult object which\r\n * includes the recorded audio stream as a blob\r\n * @param {Function} callback  which will retrieve the a RecordingResult with\r\n *        the answer as a WordArray\r\n */\r\nTranscriptionService.prototype.send = function send(recordingResult, callback) {\r\n    this.sendRequest(recordingResult.blob, response => {\r\n        if (this.verify(response)) {\r\n            recordingResult.wordArray = this.formatResponse(response);\r\n        } else {\r\n            console.log('the retrieved response from the server is not valid!');\r\n            recordingResult.wordArray = [];\r\n        }\r\n        callback(recordingResult);\r\n    });\r\n};\r\n\r\n/**\r\n * Abstract method which will rend the recorder audio stream to the implemented\r\n * transcription service and will retrieve an answer, which will be\r\n * called on the given callback method\r\n *\r\n * @param {Blob} audioBlob the recorded audio stream as a single Blob\r\n * @param {function} callback function which will retrieve the answer\r\n *                            from the service\r\n */\r\n// eslint-disable-next-line no-unused-vars\r\nTranscriptionService.prototype.sendRequest = function(audioBlob, callback) {\r\n    throw new Error('TranscriptionService.sendRequest is abstract');\r\n};\r\n\r\n/**\r\n * Abstract method which will parse the output from the implemented\r\n * transcription service to the expected format\r\n *\r\n * The transcriber class expect an array of word objects, where each word\r\n * object is one transcribed word by the service.\r\n *\r\n * The expected output of this method is an array of word objects, in\r\n * the correct order. That is, the first object in the array is the first word\r\n * being said, and the last word in the array is the last word being said\r\n *\r\n * @param response the answer from the speech-to-text server which needs to be\r\n *                 formatted\r\n * @return {Array<Word>} an array of Word objects\r\n */\r\n// eslint-disable-next-line no-unused-vars\r\nTranscriptionService.prototype.formatResponse = function(response) {\r\n    throw new Error('TranscriptionService.format is abstract');\r\n};\r\n\r\n/**\r\n * Abstract method which will verify that the response from the server is valid\r\n *\r\n * @param response the response from the server\r\n * @return {boolean} true if response is valid, false otherwise\r\n */\r\n// eslint-disable-next-line no-unused-vars\r\nTranscriptionService.prototype.verify = function(response) {\r\n    throw new Error('TranscriptionService.verify is abstract');\r\n};\r\n\r\nmodule.exports = TranscriptionService;\r\n","import {Chat} from '@stores/Chat'\r\nimport {createContext, useContext} from 'react'\r\n\r\nexport const StoreContext = createContext<Chat>({} as Chat)\r\nexport const StoreProvider = StoreContext.Provider\r\nexport const useStore = () => useContext(StoreContext)\r\n","import {MapData} from '@stores/Map'\r\nimport {createContext, useContext} from 'react'\r\n\r\nexport const StoreContext = createContext<MapData>({} as MapData)\r\nexport const StoreProvider = StoreContext.Provider\r\nexport const useStore = () => useContext(StoreContext)\r\n","import {Participants} from '@stores/participants/Participants'\r\nimport {createContext, useContext} from 'react'\r\n\r\nexport const StoreContext = createContext<Participants>({} as Participants)\r\nexport const StoreProvider = StoreContext.Provider\r\nexport const useStore = () => useContext(StoreContext)\r\n","import {SharedContents} from '@stores/sharedContents/SharedContents'\r\nimport {createContext, useContext} from 'react'\r\n\r\nexport const StoreContext = createContext<SharedContents>({} as SharedContents)\r\nexport const StoreProvider = StoreContext.Provider\r\nexport const useStore = () => useContext(StoreContext)\r\n","import Button from '@material-ui/core/Button'\r\nimport DialogContent from '@material-ui/core/DialogContent'\r\nimport {t} from '@models/locales'\r\nimport {isSmartphone} from '@models/utils'\r\nimport errorInfo from '@stores/ErrorInfo'\r\nimport map from '@stores/Map'\r\nimport React, { useEffect } from 'react'\r\nimport {ErrorDialogFrame} from './ErrorDialog'\r\n\r\nexport const AfkDialog: React.FC<{}> = () => {\r\n  useEffect(()=>{\r\n    map.keyInputUsers.add('AfkDialog')\r\n  })\r\n  const onClose = (ev:{}) => {\r\n    map.keyInputUsers.delete('AfkDialog')\r\n    const evKey = ev as React.KeyboardEvent\r\n    if (evKey.code){\r\n      //  console.log(`onClose code=${evKey.code}`)\r\n      evKey.preventDefault()\r\n      evKey.stopPropagation()\r\n    }\r\n    errorInfo.clear()\r\n  }\r\n\r\n  return <ErrorDialogFrame onClose={onClose}>\r\n    <DialogContent style={{fontSize: isSmartphone() ? '2em' : '1em'}}>\r\n      <Button color=\"primary\" variant=\"contained\" style={{textTransform:'none'}} autoFocus={true}\r\n        onKeyDown={onClose} onClick={onClose}>\r\n        {t('afkMessage')}\r\n      </Button>\r\n      </DialogContent>\r\n  </ErrorDialogFrame>\r\n}\r\nAfkDialog.displayName = 'AfkDialog'\r\n","export default __webpack_public_path__ + \"static/media/usage.en.98a80f40.png\";","export default __webpack_public_path__ + \"static/media/usage.ja.0ce862b2.png\";","import {useStore as useParticipants} from '@hooks/ParticipantsStore'\r\nimport usageEn from '@images/usage.en.png'\r\nimport usageJa from '@images/usage.ja.png'\r\nimport Box from '@material-ui/core/Box'\r\nimport Button from '@material-ui/core/Button'\r\nimport DialogContent from '@material-ui/core/DialogContent'\r\nimport TextField from '@material-ui/core/TextField'\r\nimport TranslateIcon from '@material-ui/icons/Translate'\r\nimport {i18nSupportedLngs, useTranslation} from '@models/locales'\r\nimport {urlParameters} from '@models/url'\r\nimport {isSmartphone} from '@models/utils'\r\nimport errorInfo from '@stores/ErrorInfo'\r\nimport React, {useState} from 'react'\r\nimport {ErrorDialogFrame} from './ErrorDialog'\r\n\r\nexport const TheEntrance: React.FC<{}> = (props) => {\r\n  const participants = useParticipants()\r\n  const [name, setName] = useState(participants.local.information.name)\r\n  const savedRoom = sessionStorage.getItem('room')\r\n  const [room, setRoom] = useState(urlParameters.room ? urlParameters.room : savedRoom ? savedRoom : '')\r\n\r\n  const onClose = (save: boolean) => {\r\n    if (save) {\r\n      if (participants.local.information.name !== name){\r\n        participants.local.information.name = name\r\n        participants.local.sendInformation()\r\n        participants.local.saveInformationToStorage(true)\r\n      }\r\n      urlParameters.room = room\r\n      sessionStorage.setItem('room', room)\r\n    }\r\n    errorInfo.clear()\r\n  }\r\n  const onKeyPress = (ev:React.KeyboardEvent) => {\r\n    if (ev.key === 'Enter') {\r\n      onClose(true)\r\n    }else if (ev.key === 'Esc' || ev.key === 'Escape') {\r\n      onClose(false)\r\n    }\r\n  }\r\n\r\n  const {t, i18n} = useTranslation()\r\n\r\n  const tfIStyle = {fontSize: isSmartphone() ? '2em' : '1em',\r\n    height: isSmartphone() ? '2em' : '1.5em'}\r\n  const tfLStyle = {fontSize: isSmartphone() ? '1em' : '1em'}\r\n  const tfDivStyle = {height: isSmartphone() ? '4em' : '3em'}\r\n\r\n  return <ErrorDialogFrame onClose={()=>{errorInfo.clear()}}>\r\n    <DialogContent style={{fontSize: isSmartphone() ? '2em' : '1em'}}>\r\n      <Button style={{position:'absolute', top:30, right:20, display:'none'}} onClick = {() => {\r\n        const idx = (i18nSupportedLngs.findIndex(l => l === i18n.language) + 1) % i18nSupportedLngs.length\r\n        i18n.changeLanguage(i18nSupportedLngs[idx])\r\n      }}>\r\n        <TranslateIcon />\r\n      </Button>\r\n      <h2>EarShot Chat</h2>\r\n      <p>\r\n        <img style={{float: 'right', width:'28em', display:'none'}} src={i18n.language === 'ja' ? usageJa : usageEn}\r\n          alt=\"usage\" />\r\n        {t('enAbout')}&nbsp;\r\n      <a href={t('enTopPageUrl')}>{t('enMoreInfo')}</a>\r\n      </p>\r\n      <br />\r\n      <TextField label={t('YourName')} multiline={false} value={name} style={tfDivStyle}\r\n        inputProps={{style: tfIStyle, autoFocus:true}} InputLabelProps={{style: tfLStyle}}\r\n        onChange={event => setName(event.target.value)} onKeyPress={onKeyPress} fullWidth={true}\r\n      />\r\n      <Box mt={4}>\r\n      {/* readOnly: true */}\r\n        <TextField label={t('Venue')} multiline={false} value={room} style={tfDivStyle}\r\n        inputProps={{style: tfIStyle, autoFocus:false}} InputLabelProps={{style: tfLStyle}}\r\n        onChange={event => setRoom(event.target.value)} onKeyPress={onKeyPress} fullWidth={true}\r\n        />\r\n      </Box>\r\n      <Box mt={4}>\r\n        <Button variant=\"contained\" color=\"primary\" onClick={() => onClose(true)}\r\n          style={{fontSize:isSmartphone() ? '1.25em' : '1em'}}>\r\n          {t('EnterTheVenue')}\r\n        </Button>\r\n      </Box>\r\n    </DialogContent>\r\n  </ErrorDialogFrame>\r\n}\r\nTheEntrance.displayName = 'TheEntrance'\r\n","import Box from '@material-ui/core/Box'\r\nimport Button from '@material-ui/core/Button'\r\nimport Dialog from '@material-ui/core/Dialog'\r\nimport DialogContent from '@material-ui/core/DialogContent'\r\nimport DialogTitle from '@material-ui/core/DialogTitle'\r\nimport {t} from '@models/locales'\r\nimport errorInfo, {ErrorType} from '@stores/ErrorInfo'\r\nimport {Observer} from 'mobx-react-lite'\r\nimport React from 'react'\r\nimport {AfkDialog} from './AfkDialog'\r\nimport {TheEntrance} from './TheEntrance'\r\n\r\n\r\nexport const dialogs = new Map<ErrorType, JSX.Element>()\r\ndialogs.set('entrance', <TheEntrance />)\r\ndialogs.set('afk', <AfkDialog />)\r\n\r\nexport const ErrorDialogFrame: React.FC<{onClose:(event:{}, reason:string)=>void}> = (props) => {\r\n  return <Dialog {...props} open={errorInfo.show()}\r\n    onClose={props.onClose} maxWidth=\"md\" fullWidth={false} >\r\n  {errorInfo.title ?\r\n    <DialogTitle id=\"simple-dialog-title\">{errorInfo.title}</DialogTitle>\r\n    : undefined }\r\n  {props.children}\r\n</Dialog>\r\n}\r\n\r\n\r\nexport const ErrorDialog: React.FC<{}> = (props) => {\r\n  function close(){\r\n    if (errorInfo.type !== 'retry'){\r\n      errorInfo.clear()\r\n    }\r\n  }\r\n\r\n  return <Observer>{\r\n    () => {\r\n      if (errorInfo.type){\r\n        if (dialogs.has(errorInfo.type)) {\r\n          return dialogs.get(errorInfo.type)!\r\n        }else{\r\n          return <ErrorDialogFrame onClose={() => { close() }}>\r\n            <DialogContent>{errorInfo.message}</DialogContent>\r\n            {errorInfo.type !== 'retry' ?\r\n              <Box mt={2} mb={2} ml={4}>\r\n              <Button variant=\"contained\" color=\"primary\" style={{textTransform:'none'}}\r\n                onClick={() => { close() }} >\r\n                {t('emClose')}\r\n              </Button>&nbsp;\r\n              <Button variant=\"contained\" color=\"secondary\" style={{textTransform:'none'}}\r\n                onClick={() => {\r\n                  errorInfo.supressedTypes.add(errorInfo.type)\r\n                  close()\r\n                }}>\r\n                {t('emNeverShow')}\r\n              </Button>\r\n              </Box>\r\n            : undefined}\r\n          </ErrorDialogFrame>\r\n        }\r\n      }\r\n\r\n      return <></>\r\n    }\r\n  }</Observer>\r\n}\r\nErrorDialog.displayName = 'ErrorDialog'\r\n","import {assert} from '@models/utils'\r\nimport React from 'react'\r\n\r\nexport function acceleratorText2El(text:string) {\r\n  const texts = text.split('_')\r\n  assert(texts.length <= 2)\r\n\r\n  return <>{texts[0]}{texts[1] ?\r\n    <><strong>{texts[1].substr(0, 1)}</strong>{texts[1].substr(1)}</> : undefined}</>\r\n}\r\n","import {useStore} from '@hooks/ParticipantsStore'\r\nimport Button from '@material-ui/core/Button'\r\nimport FormControlLabel from '@material-ui/core/FormControlLabel'\r\nimport Grid from '@material-ui/core/Grid'\r\nimport Slider from '@material-ui/core/Slider'\r\nimport {connection} from '@models/api'\r\nimport {t} from '@models/locales'\r\nimport roomInfo from '@stores/RoomInfo'\r\nimport {useObserver} from 'mobx-react-lite'\r\nimport React from 'react'\r\n\r\ninterface MySliderProps{\r\n  value:number, setValue(v:number):void\r\n}\r\n\r\nconst MAX = 30\r\nconst MySlider: React.FC<MySliderProps> = (props) => {\r\n  return <Grid container={true} spacing={2}><Slider value={props.value} min={0} max={MAX}\r\n  track={false} valueLabelDisplay=\"auto\" aria-labelledby=\"continuous-slider\" style={{width:200}}\r\n  onChange={(ev, val) => props.setValue(val as number)} valueLabelFormat={v => v === MAX ? '' : v.toString()}\r\n  /></Grid>\r\n}\r\n\r\nexport const RemoteTrackLimitControl: React.FC<{}> = () => {\r\n  const local = useStore().local\r\n  const videoLimit = useObserver(() => local.remoteVideoLimit)\r\n  const audioLimit = useObserver(() => local.remoteAudioLimit)\r\n  const videoSlider = <MySlider value={videoLimit >= 0 ? videoLimit : MAX}\r\n    setValue={(v) => {\r\n      local.remoteVideoLimit = v === MAX ? -1 : v\r\n    } } />\r\n  const audioSlider = <MySlider value={audioLimit >= 0 ? audioLimit : MAX}\r\n    setValue={(v) => {\r\n      local.remoteAudioLimit = v === MAX ? -1 : v\r\n    } } />\r\n\r\n  return <>\r\n  <FormControlLabel\r\n    control={videoSlider}\r\n    label={t('videoLimit')}\r\n  />\r\n  <FormControlLabel\r\n    control={audioSlider}\r\n    label={t('audioLimit')}\r\n  /><br />\r\n  <Button variant=\"contained\" color={roomInfo.passMatched ? 'primary' : 'default'}\r\n      style={{textTransform:'none'}} disabled={!roomInfo.passMatched}\r\n      onClick = { () => {\r\n        if (roomInfo.passMatched){\r\n          connection.conference.sync.sendTrackLimits('', [local.remoteVideoLimit, local.remoteAudioLimit])\r\n        }\r\n      }}\r\n  >Sync limits</Button>\r\n  </>\r\n}\r\nRemoteTrackLimitControl.displayName = 'RemoteTrackLimitControl'\r\n","import Box from '@material-ui/core/Box'\r\nimport Button from '@material-ui/core/Button'\r\nimport Popover from '@material-ui/core/Popover'\r\nimport TextField from '@material-ui/core/TextField'\r\nimport {connection} from '@models/api'\r\nimport {MessageType} from '@models/api/MessageType'\r\nimport {isDarkColor, rgb2Color} from '@models/utils'\r\nimport roomInfo from '@stores/RoomInfo'\r\nimport contents from '@stores/sharedContents/SharedContents'\r\nimport {Observer} from 'mobx-react-lite'\r\nimport React from 'react'\r\nimport {SketchPicker} from 'react-color'\r\nimport {RemoteTrackLimitControl} from './RemoteTrackLimitControl'\r\n\r\nexport interface AdminConfigFormProps{\r\n  close?: () => void,\r\n}\r\nfunction onKeyPress(ev:React.KeyboardEvent){\r\n  if (ev.key === 'Enter') {\r\n    let pass = roomInfo.roomProps.get('password')\r\n    roomInfo.passMatched = roomInfo.password === (pass ? pass : '')\r\n  }\r\n}\r\nfunction btnColor(){\r\n  return roomInfo.passMatched ? 'primary' : 'default'\r\n}\r\nexport const AdminConfigForm: React.FC<AdminConfigFormProps> = (props: AdminConfigFormProps) => {\r\n  const [clearName, setClearName] = React.useState('')\r\n  const [showFillPicker, setShowFillPicker] = React.useState(false)\r\n  const [showColorPicker, setShowColorPicker] = React.useState(false)\r\n  const fillButton = React.useRef<HTMLButtonElement>(null)\r\n  const colorButton = React.useRef<HTMLButtonElement>(null)\r\n\r\n  return <Observer>{()=>{\r\n    const textForFill = isDarkColor(roomInfo.backgroundFill) ? 'white' : 'black'\r\n    const textForColor = isDarkColor(roomInfo.backgroundColor) ? 'white' : 'black'\r\n\r\n    return  <Box m={2}>\r\n      <Box m={2}>\r\n        <RemoteTrackLimitControl key=\"remotelimitcontrol\" />\r\n      </Box>\r\n      <Box mt={2} mb={2}>\r\n        <TextField autoFocus label=\"Admin password\" type=\"password\" style={{marginTop:-12}}\r\n          value={roomInfo?.password} onChange={(ev)=>{ roomInfo.password=ev.currentTarget.value}}\r\n          onKeyPress={onKeyPress}/>\r\n        &emsp;\r\n        <Button variant=\"contained\" color=\"primary\" style={{textTransform:'none'}} onClick={() => {\r\n          let pass = roomInfo.roomProps.get('password')\r\n          if (!pass){ pass = '' }\r\n          roomInfo.passMatched = roomInfo?.password === pass\r\n        }}> Check </Button>&emsp;\r\n        {roomInfo.passMatched ? 'OK': 'Not matched'}\r\n      </Box>\r\n      <Box mt={2} mb={2}>\r\n        <TextField label=\"New password to update\" type=\"text\" style={{marginTop:-12}}\r\n          value={roomInfo?.newPassword} onChange={(ev)=>{roomInfo.newPassword=ev.currentTarget.value}}\r\n        />&emsp;\r\n        <Button variant=\"contained\" color={btnColor()} disabled={!roomInfo.passMatched} style={{textTransform:'none'}}\r\n          onClick={() => {\r\n            if (roomInfo.passMatched){\r\n              connection.conference.setRoomProp('password', roomInfo.newPassword)\r\n            }\r\n          }}> Update password </Button>&emsp;\r\n      </Box>\r\n      <Box mt={2}>\r\n        <Button variant=\"contained\" color={btnColor()} style={{textTransform:'none'}}\r\n          disabled={!roomInfo.passMatched} onClick={() => {\r\n          if (roomInfo.passMatched) { connection.conference.sendMessage(MessageType.MUTE_VIDEO, true) }\r\n        }}> Mute all videos </Button> &nbsp;\r\n        <Button variant=\"contained\" color={btnColor()} style={{textTransform:'none'}}\r\n          disabled={!roomInfo.passMatched} onClick={() => {\r\n          if (roomInfo.passMatched) { connection.conference.sendMessage(MessageType.MUTE_VIDEO, false) }\r\n        }}> Show all videos </Button>&emsp;\r\n        <Button variant=\"contained\" color={btnColor()} style={{textTransform:'none'}}\r\n          disabled={!roomInfo.passMatched} onClick={() => {\r\n          if (roomInfo.passMatched) { connection.conference.sendMessage(MessageType.MUTE_AUDIO, true) }\r\n        }}> Mute all mics </Button>&nbsp;\r\n        <Button variant=\"contained\" color={btnColor()} style={{textTransform:'none'}}\r\n          disabled={!roomInfo.passMatched} onClick={() => {\r\n          if (roomInfo.passMatched) { connection.conference.sendMessage(MessageType.MUTE_AUDIO, false) }\r\n        }}> Switch on all mics </Button>\r\n      </Box>\r\n      <Box mt={2}>\r\n        <Button variant=\"contained\" color={btnColor()} style={{textTransform:'none'}}\r\n          disabled={!roomInfo.passMatched} onClick={() => {\r\n          if (roomInfo.passMatched) {\r\n            contents.removeAllContents()\r\n          }\r\n        }}> Remove all Contents </Button>&emsp;\r\n        <Button variant=\"contained\" color={btnColor()} style={{textTransform:'none'}}\r\n          disabled={!roomInfo.passMatched} onClick={() => {\r\n            if (roomInfo.passMatched){\r\n              contents.all.filter(c => c.ownerName === clearName).forEach(c => contents.removeByLocal(c.id))\r\n            }\r\n        }}> Clear contents by user name </Button> &thinsp;\r\n        <TextField label=\"name\" type=\"text\" style={{marginTop:-12}}\r\n            value={clearName} onChange={(ev)=>{setClearName(ev.currentTarget.value)}} />\r\n      </Box>\r\n      <Box mt={2}>\r\n        <Button variant=\"contained\" color={btnColor()} style={{textTransform:'none'}}\r\n          disabled={!roomInfo.passMatched} onClick={() => {\r\n          if (roomInfo.passMatched) {\r\n            connection.conference.sendMessageViaJitsi(MessageType.RELOAD_BROWSER, {})\r\n            if (connection.conference.bmRelaySocket?.readyState === WebSocket.OPEN){\r\n              /* connection.conference.sendMessageViaRelay(MessageType.RELOAD_BROWSER, {}) */\r\n              connection.conference.pushOrUpdateMessageViaRelay(MessageType.RELOAD_BROWSER, {})\r\n            }\r\n          }\r\n        }}> Reload </Button>&emsp;\r\n\r\n        <Button variant=\"contained\" disabled={!roomInfo.passMatched}\r\n          style={{backgroundColor:rgb2Color(roomInfo.backgroundFill), color:textForFill, textTransform:'none'}}\r\n          onClick={()=>{if (roomInfo.passMatched){ setShowFillPicker(true) }}} ref={fillButton}>\r\n          Back color</Button>\r\n        <Popover open={showFillPicker}\r\n          onClose={()=>{\r\n            setShowFillPicker(false)\r\n            connection.conference.setRoomProp('backgroundFill', JSON.stringify(roomInfo.backgroundFill))\r\n          }}\r\n          anchorEl={fillButton.current} anchorOrigin={{vertical:'bottom', horizontal:'right'}}>\r\n          <SketchPicker color = {{r:roomInfo.backgroundFill[0], g:roomInfo.backgroundFill[1],\r\n            b:roomInfo.backgroundFill[2]}} disableAlpha\r\n            onChange={(color, event)=>{\r\n              event.preventDefault()\r\n              roomInfo.backgroundFill = [color.rgb.r, color.rgb.g, color.rgb.b]\r\n            }}\r\n          />\r\n        </Popover>\r\n        &nbsp;\r\n        <Button variant=\"contained\" disabled={!roomInfo.passMatched}\r\n          style={{backgroundColor:rgb2Color(roomInfo.backgroundColor), color:textForColor, textTransform:'none'}}\r\n          onClick={()=>{if (roomInfo.passMatched){ setShowColorPicker(true)} }} ref={colorButton}>\r\n          Pattern color</Button>\r\n        <Popover open={showColorPicker}\r\n          onClose={()=>{\r\n            setShowColorPicker(false)\r\n            connection.conference.setRoomProp('backgroundColor', JSON.stringify(roomInfo.backgroundColor))\r\n          }}\r\n          anchorEl={colorButton.current} anchorOrigin={{vertical:'bottom', horizontal:'right'}}>\r\n          <SketchPicker color = {{r:roomInfo.backgroundColor[0], g:roomInfo.backgroundColor[1],\r\n            b:roomInfo.backgroundColor[2]}} disableAlpha\r\n            onChange={(color, event)=>{\r\n              event.preventDefault()\r\n              roomInfo.backgroundColor = [color.rgb.r, color.rgb.g, color.rgb.b]\r\n            }}\r\n          />\r\n        </Popover>&nbsp;\r\n        <Button variant=\"contained\" color={btnColor()} style={{textTransform:'none'}}\r\n          disabled={!roomInfo.passMatched} onClick={() => {\r\n          if (roomInfo.passMatched) {\r\n            roomInfo.backgroundFill = [0xDF, 0xDB, 0xE5]\r\n            roomInfo.backgroundColor = [0xB9, 0xB2, 0xC4]\r\n            connection.conference.setRoomProp('backgroundFill', JSON.stringify(roomInfo.backgroundFill))\r\n            connection.conference.setRoomProp('backgroundColor', JSON.stringify(roomInfo.backgroundColor))\r\n          }\r\n        }}> Default </Button>&emsp;\r\n\r\n      </Box>\r\n\r\n    </Box>}\r\n  }</Observer>\r\n}\r\n","import {useStore} from '@hooks/ParticipantsStore'\r\nimport Container from '@material-ui/core/Container'\r\nimport FormControlLabel from '@material-ui/core/FormControlLabel'\r\nimport Switch from '@material-ui/core/Switch'\r\nimport {useTranslation} from '@models/locales'\r\nimport {Observer} from 'mobx-react-lite'\r\nimport React from 'react'\r\n\r\nexport const BroadcastControl: React.FC<{}> = () => {\r\n  const local = useStore().local\r\n  const audioBroadcastSwitch = <Observer>{ () =>\r\n    <Switch checked={local.physics.onStage} name=\"broadcast\"\r\n      onChange={event => local.setPhysics({onStage: event.target.checked})} />\r\n  }</Observer>\r\n  const {t} = useTranslation()\r\n\r\n  return <Container>\r\n    <FormControlLabel\r\n      control={audioBroadcastSwitch}\r\n      label={t('broadcastMyVoice')}\r\n    />\r\n  </Container>\r\n}\r\nBroadcastControl.displayName = 'BroadcastControl'\r\n","import {useStore as useMapStore} from '@hooks/MapStore'\r\nimport IconButton from '@material-ui/core/IconButton'\r\nimport Zoom from '@material-ui/core/Zoom'\r\nimport MoreVertIcon from '@material-ui/icons/MoreVert'\r\nimport {MapData} from '@stores/Map'\r\nimport React, {CSSProperties} from 'react'\r\n\r\n//  utility to control more button\r\nexport interface MoreButtonMember{\r\n  timeout:NodeJS.Timeout|undefined\r\n}\r\nexport function moreButtonControl(setShowMore:(show:boolean) => void, member:MoreButtonMember) {\r\n  return {\r\n    onMouseOver(ev:React.MouseEvent) {\r\n      //  console.log('over')\r\n      if (! (ev.nativeEvent as any).sourceCapabilities?.firesTouchEvents) {\r\n        if (member.timeout) {\r\n          clearTimeout(member.timeout)\r\n          member.timeout = undefined\r\n        }\r\n        setShowMore(true)\r\n      }\r\n    },\r\n    onMouseOut(ev:React.MouseEvent) {\r\n      //  console.log('out')\r\n      if (member.timeout) {\r\n        clearTimeout(member.timeout)\r\n      }\r\n      member.timeout = setTimeout(() => {\r\n        setShowMore(false)\r\n        member.timeout = undefined\r\n      },                          500)\r\n    },\r\n  }\r\n}\r\n\r\n\r\nexport type IconColor = 'inherit' | 'disabled' | 'primary' | 'secondary' | 'action' | 'error' | undefined\r\nexport type FabColor = 'inherit' | 'default' | 'primary' | 'secondary' | undefined\r\nexport interface MoreButtonProps{\r\n  show: boolean\r\n  htmlColor?: string\r\n  iconColor?: IconColor\r\n  color?: FabColor\r\n  className?: string\r\n  style?: CSSProperties\r\n  onClickMore?(ev:React.PointerEvent|React.MouseEvent|React.TouchEvent, map:MapData): void\r\n  buttonRef?: React.RefObject<HTMLButtonElement>\r\n}\r\n\r\nexport const MoreButton: React.FC<MoreButtonProps> = (props) => {\r\n  const map = useMapStore()\r\n  const handleClick = (event: React.PointerEvent<HTMLButtonElement>) => {\r\n    if (props.onClickMore) { props.onClickMore(event, map) }\r\n  }\r\n\r\n  return <Zoom in={props.show} style={props.style} >\r\n    <IconButton className={props.className} color={props.color} onClick={handleClick}\r\n      size={'small'} ref={props.buttonRef}\r\n    >\r\n      <MoreVertIcon color={props.iconColor} htmlColor={props.htmlColor} fontSize=\"large\" />\r\n    </IconButton>\r\n  </Zoom>\r\n}\r\n","import {FabColor, IconColor, MoreButton, moreButtonControl, MoreButtonMember} from '@components/utils/MoreButton'\r\nimport {Tooltip} from '@material-ui/core'\r\nimport Fab from '@material-ui/core/Fab'\r\nimport {makeStyles} from '@material-ui/core/styles'\r\nimport React, {useRef, useState} from 'react'\r\n\r\nconst useStyles = makeStyles((theme) => {\r\n  return ({\r\n    container: {\r\n      display:'inline-block',\r\n      marginLeft: theme.spacing(2),\r\n      marginRight: theme.spacing(2),\r\n      marginTop: theme.spacing(1),\r\n      marginBottom: theme.spacing(1),\r\n      pointerEvents: 'auto',\r\n    },\r\n  })\r\n})\r\ninterface MyFabProps{\r\n  children: React.ReactElement,\r\n  onClick?: (e: React.MouseEvent<HTMLButtonElement, MouseEvent>|React.TouchEvent<HTMLButtonElement>) => void,\r\n  onClickMore?: (e: React.PointerEvent<HTMLButtonElement>\r\n    |React.MouseEvent<HTMLButtonElement, MouseEvent>|React.TouchEvent<HTMLButtonElement>) => void,\r\n  color?: FabColor\r\n  iconColor?: IconColor\r\n  htmlColor?: string\r\n  className?: string\r\n  style?: React.CSSProperties\r\n  title?: string | React.ReactElement,\r\n  size?: number,\r\n  divRef?: React.RefObject<HTMLDivElement>\r\n}\r\n\r\n\r\nexport const FabMain: React.FC<MyFabProps> = (props) => {\r\n  const classes = useStyles()\r\n  const [showMore, setShowMore] = useState<boolean>(false)\r\n  const memberRef = useRef<MoreButtonMember>({timeout:undefined})\r\n  const member = memberRef.current\r\n\r\n  return <div className={classes.container + (props.className ? ` ${props.className}` : '')}\r\n    style={props.style} ref={props.divRef}\r\n    {...moreButtonControl(setShowMore, member)}\r\n  >\r\n    <Fab style={{height:props.size, width:props.size}}\r\n      onClick = {(ev) => { if (props.onClick) { props.onClick(ev) } } }\r\n      onContextMenu={(ev) => {\r\n        ev.preventDefault()\r\n        if (props.onClickMore) { props.onClickMore(ev) }\r\n      }}\r\n      color = {props.color} onFocus = {(e) => { (e.target as HTMLElement)?.blur() }}>\r\n      {props.children}\r\n    </Fab>\r\n    {props.onClickMore ? <MoreButton style={{position:'relative', top:-35, left:-15, marginRight:-41}}\r\n    show={showMore} color={props.color} htmlColor={props.htmlColor} iconColor={props.iconColor}\r\n    onClickMore = {props.onClickMore}\r\n    /> : undefined}\r\n  </div>\r\n}\r\n\r\nexport const FabWithTooltip: React.FC<MyFabProps> = (props) => {\r\n  if (props.title) {\r\n    return <Tooltip placement=\"top-start\" arrow={true}\r\n    title={props.title}>\r\n    <span style={{paddingTop:20}} >\r\n      <FabMain {...props} />\r\n    </span>\r\n    </Tooltip>\r\n  }\r\n\r\n  return <FabMain {...props} />\r\n}\r\n","import {useStore as useMapStore} from '@hooks/MapStore'\r\nimport {useStore as useParticipants} from '@hooks/ParticipantsStore'\r\nimport {useStore as useContents} from '@hooks/SharedContentsStore'\r\nimport MenuItem from '@material-ui/core/MenuItem'\r\nimport {assert} from '@models/utils'\r\nimport {createContentOfVideo} from '@stores/sharedContents/SharedContentCreator'\r\nimport JitsiMeetJS, {JitsiLocalTrack} from 'lib-jitsi-meet'\r\nimport {makeObservable, observable} from 'mobx'\r\nimport {useObserver} from 'mobx-react-lite'\r\nimport React, {useEffect} from 'react'\r\nimport {DialogPageProps} from './DialogPage'\r\n\r\nexport class CameraSelectorMember{\r\n  @observable.shallow videos: MediaDeviceInfo[] = []\r\n  constructor(){\r\n    makeObservable(this)\r\n  }\r\n}\r\ninterface CameraSelectorProps extends DialogPageProps{\r\n  cameras: CameraSelectorMember\r\n}\r\n\r\nexport const CameraSelector: React.FC<CameraSelectorProps> = (props) => {\r\n  const {\r\n    setStep,\r\n  } = props\r\n  const contents = useContents()\r\n  const map = useMapStore()\r\n  const participants = useParticipants()\r\n  const videoMenuItems = useObserver(() =>\r\n    props.cameras.videos.map((info, idx) => makeMenuItem(info, closeVideoMenu, idx)))\r\n  function makeMenuItem(info: MediaDeviceInfo, close:(did:string) => void, key:number):JSX.Element {\r\n    let selected = false\r\n    selected = info.deviceId === participants.local.devicePreference.videoInputDevice\r\n    const keyStr = String.fromCharCode(65 + key)\r\n\r\n    return <MenuItem key={info.deviceId} onClick={() => { close(info.deviceId) }} >\r\n        { `${keyStr}\\u00A0${(selected ? '\\u00A0' : '\\u00A0\\u00A0\\u2003')}${info.label}` }\r\n      </MenuItem>  //  \\u00A0: NBSP, u2003: EM space.\r\n  }\r\n  function closeVideoMenu(did:string) {\r\n    setStep('none')\r\n    if (did) {\r\n      JitsiMeetJS.createLocalTracks({devices:['video'],\r\n        cameraDeviceId: did}).then((tracks: JitsiLocalTrack[]) => {\r\n          if (tracks.length) {\r\n            const content = createContentOfVideo(tracks, map, 'camera')\r\n            contents.shareContent(content)\r\n            assert(content.id)\r\n            contents.tracks.addLocalContent(content.id, tracks)\r\n          }\r\n        },\r\n      )\r\n    }\r\n  }\r\n\r\n  //  keyboard shortcut\r\n  useEffect(() => {\r\n    const onKeyPress = (e: KeyboardEvent) => {\r\n      if (e.code.substr(0, 3) === 'Key') {\r\n        const keyNum = e.code.charCodeAt(3) - 65\r\n        closeVideoMenu(props.cameras.videos[keyNum]?.deviceId)\r\n      }\r\n    }\r\n    window.addEventListener('keypress', onKeyPress)\r\n\r\n    return () => {\r\n      window.removeEventListener('keypress', onKeyPress)\r\n    }\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  },        [])\r\n\r\n\r\n  return <>\r\n    {videoMenuItems}\r\n  </>\r\n}\r\nCameraSelector.displayName = 'CameraSelector'\r\n","import Button from '@material-ui/core/Button'\r\nimport List from '@material-ui/core/List'\r\nimport ListItem from '@material-ui/core/ListItem'\r\nimport React from 'react'\r\nimport {DialogPageProps} from './DialogPage'\r\n\r\ninterface InputProps<T> extends DialogPageProps{\r\n  inputField: JSX.Element\r\n  value: T\r\n  onFinishInput: (text: T) => void\r\n}\r\n\r\nexport function Input<T>(props: InputProps<T>) {  // tslint: disable-line\r\n  const {\r\n    setStep,\r\n    value,\r\n    onFinishInput,\r\n    inputField,\r\n  } = props\r\n\r\n  return (\r\n    <List>\r\n      <ListItem>\r\n        {inputField}\r\n      </ListItem>\r\n      <ListItem>\r\n        <Button\r\n          variant=\"contained\"\r\n          color=\"primary\"\r\n          onClick={() => {\r\n            onFinishInput(value)\r\n            setStep('none')\r\n          }}\r\n        >\r\n          Done\r\n        </Button>\r\n      </ListItem>\r\n    </List>\r\n  )\r\n}\r\nInput.displayName = 'Input'\r\n","import {useStore as useMapStore} from '@hooks/MapStore'\r\nimport {useTranslation} from '@models/locales'\r\nimport {createContentOfImage} from '@stores/sharedContents/SharedContentCreator'\r\nimport sharedContents from '@stores/sharedContents/SharedContents'\r\nimport {DropzoneArea} from 'material-ui-dropzone'\r\nimport React, {useState} from 'react'\r\nimport {DialogPageProps} from './DialogPage'\r\nimport {Input} from './Input'\r\nimport {Step} from './Step'\r\n\r\n\r\ninterface ImageInputProps extends DialogPageProps{\r\n  type:Step\r\n}\r\n\r\nexport const ImageInput: React.FC<ImageInputProps> = (props) => {\r\n  \r\n  const {\r\n    setStep,\r\n    type,\r\n  } = props\r\n\r\n\r\n  const [files, setFiles] = useState<File[]>([])\r\n\r\n\r\n  const {t} = useTranslation()\r\n  const field = (\r\n    <DropzoneArea\r\n      acceptedFiles={['image/*']}\r\n      dropzoneText={t('imageDropzoneText')}\r\n      onChange={setFiles}\r\n    />\r\n  )\r\n\r\n  const map = useMapStore()\r\n\r\n  return (\r\n    <Input\r\n      setStep={setStep}\r\n      onFinishInput={(files) => {\r\n        // TODO modify store\r\n        files.forEach((file, i) => {\r\n          const IMAGE_OFFSET_X = 30\r\n          const IMAGE_OFFSET_Y = -20\r\n          \r\n          createContentOfImage(file, map, [IMAGE_OFFSET_X * i, IMAGE_OFFSET_Y * i], props.type).then(\r\n            imageContent => sharedContents.shareContent(imageContent))\r\n        })\r\n      }}\r\n      value={files}\r\n      inputField={field} />\r\n  )\r\n}\r\n","import {acceleratorText2El} from '@components/utils/formatter'\r\nimport ListItem from '@material-ui/core/ListItem'\r\nimport ListItemAvatar from '@material-ui/core/ListItemAvatar'\r\nimport ListItemText from '@material-ui/core/ListItemText'\r\nimport {isSmartphone} from '@models/utils'\r\nimport React from 'react'\r\n\r\ninterface ShareDialogItemProps {\r\n  icon?: JSX.Element\r\n  text: string\r\n  secondEl?: JSX.Element\r\n  onClick?: () => void\r\n  dense?: boolean\r\n}\r\n\r\nexport const ShareDialogItem: React.FC<ShareDialogItemProps> = (props) => {\r\n  const {\r\n    icon,\r\n    text,\r\n    onClick,\r\n  } = props\r\n  const textEl = acceleratorText2El(text)\r\n\r\n  return icon ?\r\n    <ListItem button dense={props.dense} onClick={onClick}>\r\n      <ListItemAvatar style={{fontSize: isSmartphone() ? '2.5em' : '1em'}}>\r\n        {icon}\r\n      </ListItemAvatar>\r\n      <ListItemText style={{fontSize: isSmartphone() ? '2.5em' : '1em'}}\r\n        primary={textEl} secondary={props.secondEl} />\r\n      {props.children}\r\n    </ListItem> :\r\n    <ListItem  dense={props.dense} onClick={onClick}>\r\n      <ListItemText style={{fontSize: isSmartphone() ? '2.5em' : '1em'}}\r\n        primary={textEl} secondary={props.secondEl} />\r\n      {props.children}\r\n    </ListItem>\r\n}\r\n","import {Stores} from '@components/utils'\r\nimport {useStore as useMapStore} from '@hooks/MapStore'\r\nimport {useStore as useParticipantsStore} from '@hooks/ParticipantsStore'\r\nimport {useStore as useContentsStore} from '@hooks/SharedContentsStore'\r\nimport bxWindowClose from '@iconify-icons/bx/bx-window-close'\r\nimport whiteboard24Regular from '@iconify-icons/fluent/whiteboard-24-regular'\r\nimport cursorDefaultOutline from '@iconify/icons-mdi/cursor-default-outline'\r\nimport {Icon} from '@iconify/react'\r\nimport Collapse from '@material-ui/core/Collapse'\r\nimport Divider from '@material-ui/core/Divider'\r\nimport FormControl from '@material-ui/core/FormControl'\r\nimport FormControlLabel from '@material-ui/core/FormControlLabel'\r\nimport List from '@material-ui/core/List'\r\nimport ListItem from '@material-ui/core/ListItem'\r\nimport Radio from '@material-ui/core/Radio'\r\nimport RadioGroup from '@material-ui/core/RadioGroup'\r\nimport CameraAltIcon from '@material-ui/icons/CameraAlt'\r\nimport ExpandLess from '@material-ui/icons/ExpandLess'\r\nimport ExpandMore from '@material-ui/icons/ExpandMore'\r\nimport DownloadIcon from '@material-ui/icons/GetApp'\r\nimport HttpIcon from '@material-ui/icons/Http'\r\nimport ImageIcon from '@material-ui/icons/Image'\r\nimport UploadIcon from '@material-ui/icons/Publish'\r\nimport ScreenShareIcon from '@material-ui/icons/ScreenShare'\r\nimport StopScreenShareIcon from '@material-ui/icons/StopScreenShare'\r\nimport SubjectIcon from '@material-ui/icons/Subject'\r\nimport {initOptions} from '@models/api/Connection'\r\nimport {connection} from '@models/api/ConnectionDefs'\r\nimport {ISharedContent} from '@models/ISharedContent'\r\nimport {useTranslation} from '@models/locales'\r\nimport {assert} from '@models/utils'\r\nimport {createContent, createContentOfIframe, createContentOfText,\r\n  createContentOfVideo, extractContentData, extractContentDatas} from '@stores/sharedContents/SharedContentCreator'\r\nimport {SharedContents} from '@stores/sharedContents/SharedContents'\r\nimport JitsiMeetJS, {JitsiLocalTrack} from 'lib-jitsi-meet'\r\nimport {isArray} from 'lodash'\r\nimport {Observer, useObserver} from 'mobx-react-lite'\r\nimport React, {useEffect, useRef} from 'react'\r\nimport {CameraSelectorMember} from './CameraSelector'\r\nimport {DialogPageProps} from './DialogPage'\r\nimport {ShareDialogItem} from './SharedDialogItem'\r\nimport {Step} from './Step'\r\n\r\nfunction startCapture(props:Stores) {\r\n  return new Promise<JitsiLocalTrack[]>((resolve, reject) => {\r\n    initOptions.desktopSharingFrameRate.max = props.contents.screenFps\r\n    JitsiMeetJS.createLocalTracks({devices:['desktop']}).then(capturedTracks => {\r\n      resolve(capturedTracks)\r\n    }).catch(reason => {\r\n      console.warn(`Share screen error: ${reason}`)\r\n    })\r\n  })\r\n}\r\n\r\nfunction downloadItems(contents:SharedContents) {\r\n  const content = JSON.stringify(extractContentDatas(contents.all))\r\n  const blob = new Blob([content], {type: 'text/plain'})\r\n\r\n  const a = document.createElement('a')\r\n  const url = URL.createObjectURL(blob)\r\n  a.href = url\r\n  a.download = 'BinauralMeetSharedItems.json'\r\n  document.body.appendChild(a)\r\n  a.click()\r\n  setTimeout(() => {\r\n    document.body.removeChild(a)\r\n    window.URL.revokeObjectURL(url)\r\n  },         0)\r\n}\r\nfunction importItems(ev: React.ChangeEvent<HTMLInputElement>, sharedContents: SharedContents) {\r\n  const files = ev.currentTarget?.files\r\n  if (files && files.length) {\r\n    files[0].text().then((text) => {\r\n      const items = JSON.parse(text)\r\n      if (isArray(items)) {\r\n        items.forEach((item) => {\r\n          const content = extractContentData(item as ISharedContent)\r\n          if (content.type === 'screen' || content.type === 'camera') { return }\r\n          const newContent = createContent()\r\n          Object.assign(newContent, content)\r\n          sharedContents.addLocalContent(newContent)\r\n        })\r\n      }\r\n    })\r\n  }\r\n}\r\n\r\ninterface ShareMenuProps extends DialogPageProps, Stores {\r\n  cameras: CameraSelectorMember\r\n}\r\n\r\n\r\nexport const ShareMenu: React.FC<ShareMenuProps> = (props) => {\r\n  const {t} = useTranslation()\r\n  const sharedContents = useContentsStore()\r\n  const participants = useParticipantsStore()\r\n  const map = useMapStore()\r\n  const sharing = useObserver(() => (\r\n    {main: sharedContents.tracks.localMains.size, contents: sharedContents.tracks.localContents.size}))\r\n  const showMouse = useObserver(() => participants.local.mouse.show)\r\n  const fileInput = useRef<HTMLInputElement>(null)\r\n  const [openMore, setOpenMore] = React.useState(false)\r\n\r\n  //  for CameraSelector\r\n  function updateDevices() {\r\n    navigator.mediaDevices.enumerateDevices().then((infos) => {\r\n      props.cameras.videos = infos.filter(info => info.kind === 'videoinput')\r\n    })\r\n    .catch(() => { console.warn('Device enumeration error') })\r\n  }\r\n  function setStep(step: Step) {\r\n    if (step === 'camera'){\r\n      updateDevices()\r\n    }\r\n    props.setStep(step)\r\n  }\r\n\r\n  //  menu handlers\r\n  const importFile = () => {\r\n    fileInput.current?.click()\r\n  }\r\n  const downloadFile = () => {\r\n    setStep('none')\r\n    downloadItems(sharedContents)\r\n  }\r\n  const createText = () => {\r\n    //  setStep('text')\r\n    setStep('none')\r\n    const tc = createContentOfText('', map)\r\n    sharedContents.shareContent(tc)\r\n    sharedContents.setEditing(tc.id)\r\n  }\r\n  const createWhiteboard = () => {\r\n    setStep('none')\r\n    let rand = new Uint32Array(4)\r\n    rand = window.crypto.getRandomValues(rand)\r\n    let randStr = ''\r\n    rand.forEach(i => randStr += i.toString(16))\r\n    createContentOfIframe(\r\n      `https://wbo.ophir.dev/boards/BinauralMeet_${connection.conference.name}_${randStr}`, map).then((c) => {\r\n      sharedContents.shareContent(c)\r\n       sharedContents.setEditing(c.id)\r\n    })\r\n  }\r\n  const createScreen = () => {\r\n    startCapture(props).then((tracks) => {\r\n      if (tracks.length) {\r\n        const content = createContentOfVideo(tracks, map, 'screen')\r\n        sharedContents.shareContent(content)\r\n        assert(content.id)\r\n        sharedContents.tracks.addLocalContent(content.id, tracks)\r\n      }\r\n    })\r\n    setStep('none')\r\n  }\r\n  const startMouse = () => {\r\n    participants.local.mouse.show = !showMouse\r\n    setStep('none')\r\n  }\r\n  const closeAllScreens = () => {\r\n    const cids = Array.from(sharedContents.tracks.localContents.keys())\r\n    cids.forEach(cid => sharedContents.removeByLocal(cid))\r\n    setStep('none')\r\n  }\r\n  const screenAsBackgrouond = () => {\r\n    if (sharing.main) {\r\n      sharedContents.tracks.clearLocalMains()\r\n    } else {\r\n      startCapture(props).then((tracks) => {\r\n        if (tracks.length) {\r\n          sharedContents.tracks.addLocalMains(tracks)\r\n        }\r\n      })\r\n    }\r\n    setStep('none')\r\n  }\r\n\r\n  //  keyboard shortcut\r\n  useEffect(() => {\r\n    const onKeyPress = (e: KeyboardEvent) => {\r\n      if (map.keyInputUsers.has('shareDialog')) {\r\n        if (e.code === 'KeyI') {  //  import\r\n          importFile()\r\n        }else if (e.code === 'KeyD') {  //  download\r\n          downloadFile()\r\n        }else if (e.code === 'KeyF') {  //  download\r\n          e.preventDefault()\r\n          setStep('iframe')\r\n        }else if (e.code === 'KeyT') {  //  download\r\n          e.preventDefault()\r\n          createText()\r\n        }else if (e.code === 'KeyG') {  //  download\r\n          e.preventDefault()\r\n          setStep('image')\r\n        }else if (e.code === 'KeyW') {  //  download\r\n          e.preventDefault()\r\n          createWhiteboard()\r\n        }else if (e.code === 'KeyB') {  //  download\r\n          screenAsBackgrouond()\r\n        }else if (e.code === 'KeyS') {  //  download\r\n          createScreen()\r\n        }else if (e.code === 'KeyM') {  //  download\r\n          startMouse()\r\n        }else if (e.code === 'KeyC') {\r\n          setStep('camera')\r\n        }else if (e.code === 'KeyL') {\r\n          closeAllScreens()\r\n        }\r\n      }\r\n    }\r\n    window.addEventListener('keypress', onKeyPress)\r\n\r\n    return () => {\r\n      window.removeEventListener('keypress', onKeyPress)\r\n    }\r\n    //  eslint-disable-next-line react-hooks/exhaustive-deps\r\n  },        [])\r\n\r\n\r\n  return (\r\n    <List>\r\n      <ShareDialogItem\r\n        key=\"shareImage\" text={t('shareImage')} icon={<ImageIcon />} onClick={() => setStep('image')}\r\n      />\r\n      <ShareDialogItem\r\n        key=\"shareText\" text={t('shareText')} icon={<SubjectIcon />} onClick={createText}\r\n      />\r\n      <ShareDialogItem\r\n        key=\"shareWhiteboard\" text={t('shareWhiteboard')} icon={<Icon icon={whiteboard24Regular} style={{fontSize:'1.5rem'}} />}\r\n         onClick={createWhiteboard}\r\n      />\r\n      <Divider />\r\n      <Divider />\r\n      <ShareDialogItem\r\n        key=\"shareZoneImage\" text={t('shareZoneImage')} icon={<ImageIcon />} onClick={() => setStep('zoneimage')}\r\n      />\r\n      <Divider />\r\n      <ShareDialogItem\r\n        key=\"shareMouse\"\r\n        icon={<Icon icon={cursorDefaultOutline} style={{fontSize:'1.5rem'}}/>}\r\n        text={showMouse ?  t('stopMouse') : t('shareMouse')}\r\n        onClick={() => {\r\n          participants.local.mouse.show = !showMouse\r\n          setStep('none')\r\n        }}\r\n      />\r\n      <ShareDialogItem key=\"shareCamera\" text={t('shareCamera')} icon={<CameraAltIcon />}\r\n        onClick={() => setStep('camera')}\r\n      />\r\n      <ShareDialogItem\r\n        key=\"shareScreenContent\"\r\n        icon={<ScreenShareIcon />}\r\n        text={t('shareScreenContent')}\r\n        onClick={createScreen}\r\n        secondEl = {<FormControl component=\"fieldset\">\r\n          <Observer>{\r\n            ()=> <RadioGroup row aria-label=\"screen-fps\" name=\"FPS\" value={props.contents.screenFps}\r\n              onChange={(ev)=>{ props.contents.setScreenFps(Number(ev.target.value)) }}\r\n              onClick={(ev)=>{\r\n                ev.stopPropagation()\r\n                setTimeout(createScreen, 100)\r\n              }}\r\n            >\r\n              <FormControlLabel value={1} control={<Radio />} label=\"1\" />\r\n              <FormControlLabel value={5} control={<Radio />} label=\"5\" />\r\n              <FormControlLabel value={15} control={<Radio />} label=\"15\" />\r\n              <FormControlLabel value={30} control={<Radio />} label=\"30\" />\r\n              <FormControlLabel value={60} control={<Radio />}\r\n                label={<span>60&nbsp;&nbsp;&nbsp;&nbsp;{t('fps')}</span>} />\r\n            </RadioGroup>\r\n          }</Observer>\r\n        </FormControl>}\r\n      />\r\n      {sharedContents.tracks.localContents.size ?\r\n        <div style={{paddingLeft:'1em'}}><ShareDialogItem dense key = \"stopScreen\"\r\n          icon={<Icon icon={bxWindowClose} style={{fontSize:'1.5rem'}}/>}\r\n          text={t('stopScreen')}\r\n          onClick={closeAllScreens}\r\n          /></div> : undefined}\r\n      <Divider />\r\n      <ListItem button dense onClick={()=>{ setOpenMore(!openMore) }}>\r\n        {openMore ? <ExpandLess /> : <ExpandMore />}\r\n      </ListItem>\r\n      <Collapse in={openMore} timeout=\"auto\" unmountOnExit>\r\n        <div style={{paddingLeft:'1em'}}>\r\n          <ShareDialogItem\r\n            key=\"shareIframe\" text={t('shareIframe')} icon={<HttpIcon />} onClick={() => setStep('iframe')}\r\n          />\r\n          <ShareDialogItem\r\n            key=\"shareScreenBackground\"\r\n            icon={sharing.main ? <StopScreenShareIcon /> : <ScreenShareIcon />}\r\n            text={sharing.main ? t('stopScreenBackground') : t('shareScreenBackground')}\r\n            onClick={screenAsBackgrouond}\r\n          />\r\n          <Divider />\r\n          <input type=\"file\" accept=\"application/json\" ref={fileInput} style={{display:'none'}}\r\n            onChange={\r\n              (ev) => {\r\n                setStep('none')\r\n                importItems(ev, sharedContents)\r\n              }\r\n            }\r\n          />\r\n          <ShareDialogItem\r\n            key=\"shareImport\" text={t('shareImport')} icon={<UploadIcon />} onClick={importFile}\r\n          />\r\n          <ShareDialogItem\r\n            key=\"shareDownload\" text={t('shareDownload')} icon={<DownloadIcon />} onClick={downloadFile}\r\n          />\r\n        </div>\r\n      </Collapse>\r\n    </List>\r\n  )\r\n}\r\nShareMenu.displayName = 'ShareMenu'\r\n","import TextField from '@material-ui/core/TextField'\r\nimport React, {useState} from 'react'\r\nimport {DialogPageProps} from './DialogPage'\r\nimport {Input} from './Input'\r\n\r\ninterface TextInputProps extends DialogPageProps{\r\n  onFinishInput: (text: string) => void\r\n  textLabel?: string\r\n  defaultValue?: string\r\n  multiline?: boolean\r\n}\r\n\r\nexport const TextInput: React.FC<TextInputProps> = (props) => {\r\n  const {\r\n    setStep,\r\n    onFinishInput,\r\n    textLabel,\r\n    defaultValue,\r\n  } = props\r\n  const [value, setValue] = useState<string>(defaultValue === undefined ? '' : defaultValue)\r\n  const field = (\r\n    <TextField  label={textLabel} multiline={props.multiline} value={value}\r\n        onChange={event => setValue(event.target.value)}\r\n        fullWidth={true} inputProps={{autoFocus:true}}\r\n        onKeyPress={(ev)=>{\r\n          if (!props.multiline && ev.key === 'Enter'){\r\n            onFinishInput(value)\r\n            setStep('none')\r\n          }\r\n        }}\r\n    />\r\n  )\r\n\r\n  return (\r\n    <Input setStep={setStep} onFinishInput={onFinishInput} value={value} inputField={field} />\r\n  )\r\n}\r\nTextInput.displayName = 'TextInput'\r\n","import {Stores} from '@components/utils'\r\nimport {useStore as useMapStore} from '@hooks/MapStore'\r\nimport Dialog from '@material-ui/core/Dialog'\r\nimport DialogContent from '@material-ui/core/DialogContent'\r\nimport DialogTitle from '@material-ui/core/DialogTitle'\r\nimport {useTranslation} from '@models/locales'\r\nimport {isSmartphone} from '@models/utils'\r\nimport {createContentOfIframe, createContentOfText} from '@stores/sharedContents/SharedContentCreator'\r\nimport sharedContents from '@stores/sharedContents/SharedContents'\r\nimport React, {useRef, useState} from 'react'\r\nimport {CameraSelector} from './CameraSelector'\r\nimport {CameraSelectorMember} from './CameraSelector'\r\nimport {ImageInput} from './ImageInput'\r\nimport {ShareMenu} from './Menu'\r\nimport {Step} from './Step'\r\nimport {TextInput} from './TextInput'\r\n\r\ninterface ShareDialogProps extends Stores{\r\n  open: boolean\r\n  onClose: () => void\r\n}\r\n\r\nexport const ShareDialog: React.FC<ShareDialogProps> = (props) => {\r\n  const {\r\n    open,\r\n    onClose,\r\n  } = props\r\n\r\n  const cameras = useRef(new CameraSelectorMember())\r\n\r\n  const map = useMapStore()\r\n  const [step, setStep] = useState<Step>('menu')\r\n\r\n  const wrappedSetStep = (step: Step) => {\r\n    if (step === 'none') {\r\n      onClose()\r\n    } else {\r\n      setStep(step)\r\n    }\r\n  }\r\n  function getPage(step: Step, setStep: (step: Step) => void): JSX.Element | undefined {\r\n    switch (step) {\r\n      case 'menu':\r\n        return <ShareMenu {...props} setStep={setStep} cameras={cameras.current} />\r\n      case 'text':\r\n        return <TextInput\r\n            setStep={setStep}\r\n            onFinishInput={(value) => {\r\n              sharedContents.shareContent(createContentOfText(value, map))\r\n              //  console.debug(`share text: ${value}`)\r\n            }}\r\n            textLabel = \"Text\"\r\n            multiline = {true}\r\n          />\r\n      case 'iframe':\r\n        return <TextInput\r\n            setStep={setStep}\r\n            onFinishInput={(value) => {\r\n              createContentOfIframe(value, map).then((c) => {\r\n                sharedContents.shareContent(c)\r\n              })\r\n            }}\r\n            textLabel = \"URL\"\r\n            multiline = {false}\r\n          />\r\n      case 'image':\r\n        return <ImageInput setStep={setStep} type={step} />\r\n      case 'zoneimage':\r\n        return <ImageInput setStep={setStep} type={step} />\r\n      case 'camera':\r\n        return <CameraSelector setStep={setStep} cameras={cameras.current} />\r\n      default:\r\n        throw new Error(`Unknown step: ${step}`)\r\n    }\r\n  }\r\n\r\n  //  console.debug(`step=${step}, pasteEnabled=${sharedContents.pasteEnabled}`)\r\n  sharedContents.pasteEnabled = step === 'none' || step === 'menu'\r\n\r\n  const {t} = useTranslation()\r\n  const stepTitle: {\r\n    [key: string]: string,\r\n  } = {\r\n    menu: t('Create and Share'),\r\n    text: t('Share Text'),\r\n    iframe: t('Share iframe'),\r\n    image: t('Share image'),\r\n    zoneimage: t('Share zone image'),\r\n    none: 'None',\r\n    camera: t('Select video camera to share'),\r\n  }\r\n  const title = stepTitle[step]\r\n  const page: JSX.Element | undefined = getPage(step, wrappedSetStep)\r\n\r\n  return  <Dialog open={open} onClose={onClose} onExited={() => setStep('menu')} maxWidth=\"sm\" fullWidth={true}\r\n      onPointerMove = {(ev) => {\r\n        map.setMouse([ev.clientX, ev.clientY])\r\n      }}\r\n    >\r\n    <DialogTitle id=\"simple-dialog-title\" style={{fontSize: isSmartphone() ? '2.5em' : '1em'}}>\r\n      {title}</DialogTitle>\r\n    <DialogContent>{page}</DialogContent>\r\n  </Dialog>\r\n}\r\n\r\nShareDialog.displayName = 'ShareDialog'\r\n","import {Stores} from '@components/utils'\r\nimport {acceleratorText2El} from '@components/utils/formatter'\r\nimport {useStore as useContentsStore} from '@hooks/SharedContentsStore'\r\nimport windowArrowUp from '@iconify-icons/fluent/window-arrow-up-24-regular'\r\n\r\nimport {Icon} from '@iconify/react'\r\nimport {makeStyles} from '@material-ui/styles'\r\nimport {useTranslation} from '@models/locales'\r\nimport {useObserver} from 'mobx-react-lite'\r\nimport React from 'react'\r\nimport {FabWithTooltip} from '../FabEx'\r\nimport {ShareDialog} from './ShareDialog'\r\n\r\n\r\nconst useStyles = makeStyles({\r\n  root: {\r\n    display: 'inline-block',\r\n  },\r\n})\r\ninterface ShareButtonProps extends Stores{\r\n  showDialog:boolean\r\n  setShowDialog(flag: boolean):void\r\n  size?: number\r\n  iconSize?: number\r\n}\r\nexport const ShareButton: React.FC<ShareButtonProps> = (props) => {\r\n  const classes = useStyles()\r\n  const store = useContentsStore()\r\n  const sharing = useObserver(() => store.tracks.localMains.size + store.tracks.localContents.size)\r\n  const {t} = useTranslation()\r\n\r\n  return (\r\n    <div className={classes.root}>\r\n      <FabWithTooltip size={props.size} color={sharing ? 'secondary' : 'primary'}\r\n        title = {acceleratorText2El(t('ttCreateAndshare'))}\r\n        aria-label=\"share\" onClick={() => props.setShowDialog(true)}>\r\n        <Icon icon={windowArrowUp} style={{width:props.iconSize, height:props.iconSize}} />\r\n      </FabWithTooltip>\r\n      <ShareDialog {...props} open={props.showDialog} onClose={() => props.setShowDialog(false)} />\r\n    </div>\r\n  )\r\n}\r\n\r\nShareButton.displayName = 'ShareButton'\r\n","import {useStore as useParticipantsStore} from '@hooks/ParticipantsStore'\r\nimport Container from '@material-ui/core/Container'\r\nimport Grid from '@material-ui/core/Grid'\r\nimport Popover from '@material-ui/core/Popover'\r\nimport Switch from '@material-ui/core/Switch'\r\nimport HeadsetIcon from '@material-ui/icons/HeadsetMic'\r\nimport SpeakerIcon from '@material-ui/icons/Speaker'\r\nimport {useTranslation} from '@models/locales'\r\nimport {isChromium} from '@models/utils'\r\nimport participants from '@stores/participants/Participants'\r\nimport {useObserver} from 'mobx-react-lite'\r\nimport React from 'react'\r\nimport {FabWithTooltip} from './FabEx'\r\n\r\nexport const SoundLocalizationSetting: React.FC<{}> = () => {\r\n  const soundLocalizationBase = useObserver(() => participants.local.soundLocalizationBase)\r\n  const {t} = useTranslation()\r\n\r\n  return <Container>\r\n    <Grid component=\"label\" container={true} alignItems=\"center\" spacing={1}>\r\n      <Grid item={true}>{t('slUser')}</Grid>\r\n      <Grid item={true}>\r\n        <Switch checked={soundLocalizationBase === 'avatar'} onChange={() => {\r\n          participants.local.soundLocalizationBase = soundLocalizationBase === 'avatar' ? 'user' : 'avatar'\r\n          participants.local.saveMediaSettingsToStorage()\r\n        }} name=\"soundLoc\" />\r\n      </Grid>\r\n      <Grid item={true}>{t('slAvatar')}</Grid>\r\n    </Grid>\r\n  </Container>\r\n}\r\nSoundLocalizationSetting.displayName = 'SoundLocalizationSetting'\r\n\r\n\r\nexport const StereoAudioSwitch: React.FC<{size?: number, iconSize:number}> = (props) => {\r\n  const participants = useParticipantsStore()\r\n  const stereo = useObserver(() => participants.local.useStereoAudio)\r\n  const [button, setButton] = React.useState<Element|null>(null)\r\n\r\n  const switchStereo = () => {\r\n    participants.local.useStereoAudio = !stereo\r\n    participants.local.saveMediaSettingsToStorage()\r\n  }\r\n\r\n  const {t} = useTranslation()\r\n\r\n  return <>\r\n    <FabWithTooltip size={props.size} title={\r\n        <>\r\n          {isChromium ? t('headphoneL1Chrome') : t('headphoneL1')} <br />\r\n          {t('headphoneL2')}\r\n        </>}\r\n      onClick={switchStereo} color = {stereo ? 'secondary' : 'primary'}\r\n      onClickMore = {stereo ? (ev) => { setButton(ev.currentTarget) } : undefined} >\r\n      {stereo ? <HeadsetIcon style={{width:props.iconSize, height:props.iconSize}} />  :\r\n      <SpeakerIcon style={{width:props.iconSize, height:props.iconSize}} /> }\r\n    </FabWithTooltip>\r\n    <Popover open={Boolean(button)} onClose={() => setButton(null)}\r\n      anchorEl={button} anchorOrigin={{vertical:'top', horizontal:'left'}}\r\n      anchorReference = \"anchorEl\" >\r\n      <div style={{padding:20}}>\r\n        {t('soundLocalizationBasedOn')} <br />\r\n        <SoundLocalizationSetting />\r\n      </div>\r\n    </Popover>\r\n  </>\r\n}\r\nStereoAudioSwitch.displayName = 'StereoAudioSwtich'\r\n","import {ErrorDialog} from '@components/error/ErrorDialog'\r\nimport {Stores} from '@components/utils'\r\nimport {acceleratorText2El} from '@components/utils/formatter'\r\nimport megaphoneIcon from '@iconify/icons-mdi/megaphone'\r\nimport {Icon} from '@iconify/react'\r\nimport {Collapse} from '@material-ui/core'\r\nimport Menu from '@material-ui/core/Menu'\r\nimport MenuItem from '@material-ui/core/MenuItem'\r\nimport Popover from '@material-ui/core/Popover'\r\nimport {makeStyles} from '@material-ui/core/styles'\r\nimport MicIcon from '@material-ui/icons/Mic'\r\nimport MicOffIcon from '@material-ui/icons/MicOff'\r\nimport SettingsIcon from '@material-ui/icons/Settings'\r\nimport VideoIcon from '@material-ui/icons/Videocam'\r\nimport VideoOffIcon from '@material-ui/icons/VideocamOff'\r\nimport SpeakerOffIcon from '@material-ui/icons/VolumeOff'\r\nimport SpeakerOnIcon from '@material-ui/icons/VolumeUp'\r\nimport {useTranslation} from '@models/locales'\r\nimport {useObserver} from 'mobx-react-lite'\r\nimport React, {useEffect, useRef} from 'react'\r\nimport {AdminConfigForm} from './adminConfig/AdminConfigForm'\r\nimport {BroadcastControl} from './BroadcastControl'\r\nimport {FabMain, FabWithTooltip} from './FabEx'\r\nimport {ShareButton} from './share/ShareButton'\r\nimport {StereoAudioSwitch} from './StereoAudioSwitch'\r\n\r\nconst useStyles = makeStyles({\r\n  container:{\r\n    position: 'absolute',\r\n    width: '100%',\r\n    bottom: 0,\r\n    padding: 0,\r\n    outline: 'none',\r\n    pointerEvents: 'none',\r\n  },\r\n  wrapper:{width:'100%'},\r\n  wrapperInner:{width:'100%', display:'flex', alignItems:'flex-end'},\r\n})\r\n\r\nclass Member{\r\n  timeoutOut:NodeJS.Timeout|undefined = undefined\r\n  touched = false\r\n}\r\n\r\nexport const Footer: React.FC<Stores&{height?:number}> = (props) => {\r\n  //  showor not\r\n  const [show, setShow] = React.useState<boolean>(true)\r\n  const [showAdmin, setShowAdmin] = React.useState<boolean>(false)\r\n  const [showShare, setShowShareRaw] = React.useState<boolean>(false)\r\n  function setShowShare(flag: boolean) {\r\n    if (flag) {\r\n      props.map.keyInputUsers.add('shareDialog')\r\n    }else {\r\n      props.map.keyInputUsers.delete('shareDialog')\r\n    }\r\n    setShowShareRaw(flag)\r\n  }\r\n\r\n  const memberRef = useRef<Member>(new Member())\r\n  const member = memberRef.current\r\n  const containerRef = useRef<HTMLDivElement>(null)\r\n  const adminButton = useRef<HTMLDivElement>(null)\r\n  //  observers\r\n  const participants = props.participants\r\n  const mute = useObserver(() => ({\r\n    muteA: participants.local.muteAudio,  //  mic\r\n    muteS: participants.local.muteSpeaker,  //  speaker\r\n    muteV: participants.local.muteVideo,  //  camera\r\n    onStage: participants.local.physics.onStage\r\n  }))\r\n  //  Fab state and menu\r\n  const [deviceInfos, setDeviceInfos] = React.useState<MediaDeviceInfo[]>([])\r\n  const [micMenuEl, setMicMenuEl] = React.useState<Element|null>(null)\r\n  const [speakerMenuEl, setSpeakerMenuEl] = React.useState<Element|null>(null)\r\n  const [videoMenuEl, setVideoMenuEl] = React.useState<Element|null>(null)\r\n\r\n  const {t} = useTranslation()\r\n  const classes = useStyles()\r\n\r\n  //  Footer collapse conrtrol\r\n  function checkMouseOnBottom() {\r\n    return props.map.screenSize[1] - (props.map.mouse[1] - props.map.offset[1]) < 90\r\n  }\r\n  const mouseOnBottom = useObserver(checkMouseOnBottom)\r\n  useEffect(() => {\r\n    if (checkMouseOnBottom()) { member.touched = true }\r\n    setShowFooter(mouseOnBottom || !member.touched)\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  },        [mouseOnBottom, member.touched])\r\n  function setShowFooter(show: boolean) {\r\n    if (show) {\r\n      setShow(true)\r\n      if (member.timeoutOut) {\r\n        clearTimeout(member.timeoutOut)\r\n        member.timeoutOut = undefined\r\n      }\r\n      containerRef.current?.focus()\r\n    }else {\r\n      if (!member.timeoutOut) {\r\n        member.timeoutOut = setTimeout(() => {\r\n          setShow(false)\r\n          member.timeoutOut = undefined\r\n        },                             500)\r\n      }\r\n    }\r\n  }\r\n\r\n  //  keyboard shortcut\r\n  useEffect(() => {\r\n    const onKeyDown = (e: KeyboardEvent) => {\r\n      //  console.log(`onKeyDown: code: ${e.code}`)\r\n      if (props.map.keyInputUsers.size === 0) {\r\n        if (!e.ctrlKey && !e.metaKey && !e.altKey){\r\n          if (e.code === 'KeyM') {  //  mute/unmute audio\r\n            participants.local.muteAudio = !participants.local.muteAudio\r\n            setShowFooter(true)\r\n          }\r\n          if (e.code === 'KeyC') {  //  Create share dialog\r\n            setShowFooter(true)\r\n            setShowShare(true)\r\n            e.preventDefault()\r\n            e.stopPropagation()\r\n          }\r\n          if (e.code === 'KeyL' || e.code === 'Escape') {  //  Leave from keyboard\r\n            participants.local.awayFromKeyboard = true\r\n          }\r\n        }\r\n      }\r\n    }\r\n    window.addEventListener('keydown', onKeyDown)\r\n\r\n    return () => {\r\n      window.removeEventListener('keydown', onKeyDown)\r\n    }\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  },        [])\r\n\r\n  //  render footer\r\n  return React.useMemo(() => {\r\n    //  Create menu list for device selection\r\n    function makeMenuItem(info: MediaDeviceInfo, close:(did:string) => void):JSX.Element {\r\n      let selected = false\r\n      if (info.kind === 'audioinput') {\r\n        selected = info.deviceId === participants.local.devicePreference.audioInputDevice\r\n      }else if (info.kind === 'audiooutput') {\r\n        selected = info.deviceId === participants.local.devicePreference.audioOutputDevice\r\n      }else if (info.kind === 'videoinput') {\r\n        selected = info.deviceId === participants.local.devicePreference.videoInputDevice\r\n      }\r\n\r\n      return <MenuItem key={info.deviceId}\r\n        onClick={() => { close(info.deviceId) }}\r\n        > { (selected ? '\\u00A0' : '\\u2003') + info.label }</MenuItem>  //  \\u00A0: NBSP, u2003: EM space.\r\n    }\r\n\r\n    const micMenuItems:JSX.Element[] = [<MenuItem  key = {'broadcast'} ><BroadcastControl /></MenuItem>]\r\n    const speakerMenuItems:JSX.Element[] = []\r\n    const videoMenuItems:JSX.Element[] = []\r\n    deviceInfos.forEach((info) => {\r\n      if (info.kind === 'audioinput') {\r\n        const broadcastControl = micMenuItems.pop() as JSX.Element\r\n        micMenuItems.push(makeMenuItem(info, closeMicMenu))\r\n        micMenuItems.push(broadcastControl)\r\n      }\r\n      if (info.kind === 'audiooutput') {\r\n        speakerMenuItems.push(makeMenuItem(info, closeSpeakerMenu))\r\n      }\r\n      if (info.kind === 'videoinput') {\r\n        videoMenuItems.push(makeMenuItem(info, closeVideoMenu))\r\n      }\r\n    })\r\n    function closeMicMenu(did:string) {\r\n      if (did) {\r\n        participants.local.devicePreference.audioInputDevice = did\r\n        participants.local.saveMediaSettingsToStorage()\r\n      }\r\n      setMicMenuEl(null)\r\n    }\r\n    function closeSpeakerMenu(did:string) {\r\n      if (did) {\r\n        participants.local.devicePreference.audioOutputDevice = did\r\n        participants.local.saveMediaSettingsToStorage()\r\n      }\r\n      setSpeakerMenuEl(null)\r\n    }\r\n    function closeVideoMenu(did:string) {\r\n      if (did) {\r\n        participants.local.devicePreference.videoInputDevice = did\r\n        participants.local.saveMediaSettingsToStorage()\r\n      }\r\n      setVideoMenuEl(null)\r\n    }\r\n\r\n    //  Device list update when the user clicks to show the menu\r\n    const fabSize = props.height\r\n    const iconSize = props.height ? props.height * 0.7 : 36\r\n    function updateDevices(ev:React.PointerEvent | React.MouseEvent | React.TouchEvent) {\r\n      navigator.mediaDevices.enumerateDevices()\r\n      .then(setDeviceInfos)\r\n      .catch(() => { console.log('Device enumeration error') })\r\n    }\r\n\r\n    function openAdmin(){\r\n      props.map.keyInputUsers.add('adminForm')\r\n      setShowAdmin(true)\r\n    }\r\n    function closeAdmin(){\r\n      props.map.keyInputUsers.delete('adminForm')\r\n      setShowAdmin(false)\r\n    }\r\n\r\n    return <div ref={containerRef} className={classes.container} onClickCapture={()=>{props.contents.setEditing('')}}>\r\n      <Collapse in={show} classes={classes}>\r\n        <StereoAudioSwitch size={fabSize} iconSize={iconSize} />\r\n        <FabMain size={fabSize} color={mute.muteS ? 'primary' : 'secondary' }\r\n          aria-label=\"speaker\" onClick={() => {\r\n            participants.local.muteSpeaker = !mute.muteS\r\n            if (participants.local.muteSpeaker) {\r\n              participants.local.muteAudio = true\r\n            }\r\n            participants.local.saveMediaSettingsToStorage()\r\n          }}\r\n          onClickMore = { (ev) => {\r\n            updateDevices(ev)\r\n            setSpeakerMenuEl(ev.currentTarget)\r\n          }}\r\n          >\r\n          {mute.muteS ? <SpeakerOffIcon style={{width:iconSize, height:iconSize}} />\r\n            : <SpeakerOnIcon style={{width:iconSize, height:iconSize}} /> }\r\n        </FabMain>\r\n        <Menu anchorEl={speakerMenuEl} keepMounted={true}\r\n          open={Boolean(speakerMenuEl)} onClose={() => { closeSpeakerMenu('') }}>\r\n          {speakerMenuItems}\r\n        </Menu>\r\n\r\n        <FabWithTooltip size={fabSize} color={mute.muteA ? 'primary' : 'secondary' } aria-label=\"mic\"\r\n          title = {acceleratorText2El(t('ttMicMute'))}\r\n          onClick = { () => {\r\n            participants.local.muteAudio = !mute.muteA\r\n            if (!participants.local.muteAudio) {\r\n              participants.local.muteSpeaker = false\r\n            }\r\n            participants.local.saveMediaSettingsToStorage()\r\n          }}\r\n          onClickMore = { (ev) => {\r\n            updateDevices(ev)\r\n            setMicMenuEl(ev.currentTarget)\r\n          } }\r\n          >\r\n          {mute.muteA ? <MicOffIcon style={{width:iconSize, height:iconSize}} /> :\r\n            mute.onStage ?\r\n              <Icon icon={megaphoneIcon} style={{width:iconSize, height:iconSize}} color=\"gold\" />\r\n              : <MicIcon style={{width:iconSize, height:iconSize}} /> }\r\n        </FabWithTooltip>\r\n        <Menu anchorEl={micMenuEl} keepMounted={true}\r\n          open={Boolean(micMenuEl)} onClose={() => { closeMicMenu('') }}>\r\n          {micMenuItems}\r\n        </Menu>\r\n\r\n        <FabMain size={fabSize} color={mute.muteV ? 'primary' : 'secondary'} aria-label=\"camera\"\r\n          onClick = { () => {\r\n            participants.local.muteVideo = !mute.muteV\r\n            participants.local.saveMediaSettingsToStorage()\r\n          }}\r\n          onClickMore = { (ev) => {\r\n            updateDevices(ev)\r\n            setVideoMenuEl(ev.currentTarget)\r\n          } }\r\n        >\r\n          {mute.muteV ? <VideoOffIcon style={{width:iconSize, height:iconSize}} />\r\n            : <VideoIcon style={{width:iconSize, height:iconSize}} /> }\r\n        </FabMain>\r\n        <Menu anchorEl={videoMenuEl} keepMounted={true}\r\n          open={Boolean(videoMenuEl)} onClose={() => { closeVideoMenu('') }}>\r\n          {videoMenuItems}\r\n        </Menu>\r\n\r\n        <ShareButton {...props} size={fabSize} iconSize={iconSize} showDialog={showShare}\r\n          setShowDialog={setShowShare} />\r\n\r\n        <ErrorDialog />\r\n\r\n        <FabMain size={fabSize} onClick={openAdmin} divRef={adminButton}\r\n          style={{marginLeft:'auto', marginRight:10, opacity:0.1}}>\r\n          <SettingsIcon style={{width:iconSize, height:iconSize}} />\r\n        </FabMain>\r\n        <Popover open={showAdmin} onClose={closeAdmin}\r\n          anchorEl={adminButton.current} anchorOrigin={{vertical:'top', horizontal:'left'}}\r\n          anchorReference = \"anchorEl\" >\r\n          <AdminConfigForm close={closeAdmin} />\r\n        </Popover>\r\n      </Collapse>\r\n    </div >\r\n  },\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n    [mute.muteA, mute.muteS, mute.muteV, mute.onStage,\r\n    show, showAdmin, showShare, micMenuEl, speakerMenuEl, videoMenuEl, deviceInfos]\r\n\r\n    )\r\n}\r\nFooter.displayName = 'Footer'\r\n","\r\nimport {makeStyles} from '@material-ui/core/styles'\r\n\r\nexport const styleCommon = makeStyles({\r\n  back:{\r\n    position: 'absolute',\r\n    width: '100%',\r\n    height: '100%',\r\n    top: 0,\r\n    left: 0,\r\n    /* backgroundColor: '#DFDBE5', */\r\n   /*  backgroundColor: '#FF00FF30', */\r\n  },\r\n  fill:{\r\n    position: 'absolute',\r\n    width: '100%',\r\n    height: '100%',\r\n    top: 0,\r\n    left: 0,\r\n  },\r\n})\r\n\r\nexport const styleForSplit = makeStyles({\r\n  resizerVertical: {\r\n    background: '#000',\r\n    zIndex: 1,\r\n    boxSizing: 'border-box',\r\n    backgroundClip: 'padding-box',\r\n    width: 11,\r\n    margin: '0 -10px 0 0',\r\n    borderLeft: '1px solid gray',\r\n    borderRight: 'transparent 10px solid',\r\n    cursor: 'col-resize',\r\n  },\r\n  resizerHorizontal: {\r\n    background: 'gray',\r\n    zIndex: 1,\r\n    boxSizing: 'border-box',\r\n    backgroundClip: 'padding-box',\r\n    height: 10.5,\r\n    margin: '-5px 0 -5px 0',\r\n    borderTop: '5px transparent solid',\r\n    borderBottom: '5px transparent solid',\r\n    cursor: 'row-resize',\r\n  },\r\n})\r\n\r\nexport interface ListLineProps{\r\n  height:number\r\n  fontSize:number\r\n}\r\n\r\nexport const styleForList = makeStyles({\r\n  container: {\r\n    width:'100%',\r\n  },\r\n  title: (props: ListLineProps) => ({\r\n    fontSize: props.fontSize * 0.8,\r\n    justifyContent: 'start',\r\n    justifyItems: 'start',\r\n    alignItems: 'center',\r\n    userSelect: 'none',\r\n    userDrag: 'none',\r\n    whiteSpace: 'nowrap',\r\n    width: '100%',\r\n  }),\r\n  outer: {\r\n    display: 'flex',\r\n    whiteSpace: 'nowrap',\r\n  },\r\n  line: (props: ListLineProps) => ({\r\n    display: 'flex',\r\n    justifyContent: 'start',\r\n    justifyItems: 'start',\r\n    alignItems: 'center',\r\n    userSelect: 'none',\r\n    userDrag: 'none',\r\n    whiteSpace: 'nowrap',\r\n    fontSize: props.fontSize,\r\n    height: props.height,\r\n    width: '100%',\r\n    margin: '1px 0 1px 0',\r\n  }),\r\n})\r\n","import Avatar from '@material-ui/core/Avatar'\r\nimport {makeStyles} from '@material-ui/core/styles'\r\nimport {Property} from 'csstype'\r\nimport { Observer } from 'mobx-react-lite'\r\nimport React from 'react'\r\n\r\nexport interface ImageAvatarProps {\r\n  name: string\r\n  avatarSrc: string\r\n  colors: string[]\r\n  size: number\r\n  style?: any\r\n  border?: boolean\r\n}\r\n\r\nfunction avatarCommon(props: ImageAvatarProps){\r\n  const style = {\r\n    width: props.size,\r\n    height: props.size,\r\n    color:props.colors[1],\r\n    backgroundColor:props.colors[0],\r\n    pointerEvents: 'none' as Property.PointerEvents,\r\n    userDrag: 'none',\r\n    fontSize: props.size * 0.3,\r\n    display:'inline-block',\r\n  }\r\n\r\n  return style\r\n}\r\nconst BORDER_WIDTH = 0.04\r\nconst BORDER_CONTENT = 1 - BORDER_WIDTH*2\r\n\r\nfunction addBoarder(style:Object, props:ImageAvatarProps){\r\n  const border = {\r\n    width: props.size * BORDER_CONTENT,\r\n    height: props.size * BORDER_CONTENT,\r\n    borderStyle: 'solid',\r\n    borderWidth: props.size * BORDER_WIDTH,\r\n    borderColor: props.colors[0],\r\n  }\r\n\r\n  return Object.assign(style, border)\r\n}\r\n\r\nconst useStyles = makeStyles({\r\n  imageAvatar: (props: ImageAvatarProps) => {\r\n    const style = avatarCommon(props)\r\n    Object.assign(style, {textAlign:'right' as Property.TextAlign,\r\n      verticalAlign: 'top' as Property.VerticalAlign})\r\n    if (props.border){ addBoarder(style, props) }\r\n\r\n    return style\r\n  },\r\n  textAvatar: (props: ImageAvatarProps) => {\r\n    const style = avatarCommon(props)\r\n    if (props.border){ addBoarder(style, props) }\r\n\r\n    return style\r\n  }\r\n})\r\n\r\n\r\nexport const RawImageAvatar: React.FC<ImageAvatarProps> = (props: ImageAvatarProps) => {\r\n  const classes = useStyles(props)\r\n\r\n  return <Observer>{()=>{\r\n    //console.log(`render ImageAvatar src=${props.avatarSrc}`)\r\n\r\n    let initial = ''\r\n    if (!props.avatarSrc){\r\n      const nameArray = props.name.split(' ')\r\n      nameArray.forEach(s => initial += s ? s.substring(0,1) : '')\r\n      initial = initial.substring(0,2)\r\n    }\r\n    const size = props.border ? props.size * BORDER_CONTENT : props.size\r\n\r\n    return props.avatarSrc ? <Avatar src={props.avatarSrc} className={classes.imageAvatar}/> :\r\n      <Avatar className={classes.textAvatar}>\r\n        <div style={{height:size, width:size, textAlign:'center',\r\n          verticalAlign:'middle', display:'table-cell', whiteSpace:'nowrap'}}>\r\n        {initial}</div></Avatar>\r\n    }\r\n  }</Observer>\r\n}\r\nRawImageAvatar.displayName = 'RawImageAvatar'\r\n\r\nexport const ImageAvatar = (props: ImageAvatarProps) =>\r\n  React.useMemo(() => <RawImageAvatar {...props} />,\r\n  //  eslint-disable-next-line react-hooks/exhaustive-deps\r\n  [props.avatarSrc, props.border, props.colors, props.name, props.size, props.style])\r\nImageAvatar.displayName = 'ImageAvatar'\r\n","import {Chat} from '@stores/Chat'\r\nimport {MapData} from '@stores/Map'\r\nimport {Participants} from '@stores/participants/Participants'\r\nimport {SharedContents} from '@stores/sharedContents/SharedContents'\r\nexport interface Stores {\r\n  map: MapData\r\n  participants: Participants\r\n  contents: SharedContents\r\n  chat: Chat\r\n}\r\n\r\nexport interface BaseProps extends Stores {\r\n  transparent?: boolean\r\n}\r\n\r\nexport function formatTimestamp(stamp: number){\r\n  const textDate = new Date(stamp)\r\n  const now = new Date()\r\n  const year = now.getFullYear() !== textDate.getFullYear() ? textDate.getFullYear() : undefined\r\n  const month = year || now.getMonth() !== textDate.getMonth() ? textDate.getMonth() + 1 : undefined\r\n  const date = (year || month || now.getDate() !== textDate.getDate()) ? textDate.getDate() : undefined\r\n  const time = `${textDate.getHours()}:${textDate.getMinutes()}:${textDate.getSeconds()}`\r\n  const timestamp = `${year ? `${year}.` : ''}${month ? `${month}.` : ''}${date ? `${date} ` : ''}${time}`\r\n\r\n  return timestamp\r\n}\r\n\r\nexport * from './formatter'\r\n","import { ImageAvatar } from '@components/avatar/ImageAvatar'\r\nimport {formatTimestamp} from '@components/utils'\r\nimport {Tooltip} from '@material-ui/core'\r\nimport IconButton from '@material-ui/core/IconButton'\r\nimport TextField from '@material-ui/core/TextField'\r\nimport SendIcon from '@material-ui/icons/Send'\r\nimport {connection} from '@models/api/ConnectionDefs'\r\nimport {MessageType} from '@models/api/MessageType'\r\nimport {t} from '@models/locales'\r\nimport {isDarkColor} from '@models/utils'\r\nimport chat, {ChatMessage, ChatMessageToSend, ChatMessageType} from '@stores/Chat'\r\nimport roomInfo from '@stores/RoomInfo'\r\nimport {Observer} from 'mobx-react-lite'\r\nimport React from 'react'\r\nimport {Stores} from '../utils'\r\nimport {styleForList} from '../utils/styles'\r\nimport {TextLineStyle} from './LeftBar'\r\n\r\nconst colorMapBlack: { [key in ChatMessageType]: string } = {\r\n  text: 'black',\r\n  called: 'red',\r\n  callTo: 'black',\r\n  log: 'black',\r\n  private: 'purple',\r\n}\r\nconst colorMapWhite: { [key in ChatMessageType]: string } = {\r\n  text: 'white',\r\n  called: 'red',\r\n  callTo: 'white',\r\n  log: 'white',\r\n  private: 'purple',\r\n}\r\n\r\n\r\nexport const ChatLine: React.FC<Stores & TextLineStyle &{message: ChatMessage}> = (props) => {\r\n  const scale = props.message.type === 'log' || props.message.type === 'callTo' ? 0.6 : 1\r\n  const lineHeight = props.lineHeight * scale\r\n  const fontSize = props.fontSize * scale\r\n\r\n  return <Observer>{() => {\r\n    const timestamp = formatTimestamp(props.message.timestamp)    //  make formated timestamp for tooltip\r\n    const colorMap = isDarkColor(roomInfo.backgroundFill) ? colorMapWhite : colorMapBlack\r\n    const backColor = isDarkColor(roomInfo.backgroundFill) ? 'rgba(0, 0, 0, 0.3)' : 'rgba(255, 255, 255, 0.3)'\r\n\r\n    return <Tooltip title={\r\n      props.message.type==='private' ?\r\n      <>{t(props.message.pid===props.participants.localId ? 'cmPrivateTo' : 'cmPrivateFrom',\r\n        {name:props.message.name})}<br/>{timestamp}</>\r\n        : <>{props.message.name}<br/>{timestamp}</>\r\n      } placement=\"right\">\r\n      <div style={{wordWrap:'break-word', marginTop:2, fontSize, backgroundColor:backColor}}>\r\n        <span style={{marginRight:'0.3em'}} onClick={()=>{\r\n          const from = props.participants.find(props.message.pid)\r\n          if (from) { props.map.focusOn(from) }\r\n        }}>\r\n          <ImageAvatar name={props.message.name} colors={props.message.colors}\r\n            avatarSrc={props.message.avatarUrl} size={lineHeight} border={true}\r\n          />\r\n        </span>\r\n        <span style={{color:colorMap[props.message.type]}}>\r\n          {props.message.text}\r\n        </span>\r\n    </div>\r\n   </Tooltip>\r\n  }}</Observer>\r\n}\r\n\r\nfunction sendChatMessage(text: string, sendTo: string, props: Stores){\r\n  const msg:ChatMessageToSend = {msg:text, ts: Date.now(), to: sendTo}\r\n  connection.conference.sendMessage(MessageType.CHAT_MESSAGE, msg, sendTo)\r\n  const local = props.participants.local\r\n  if (sendTo) {\r\n    const remote = props.participants.remote.get(sendTo)\r\n    if (remote){\r\n      chat.addMessage(new ChatMessage(text, local.id, remote.information.name,\r\n        local.information.avatarSrc, local.getColor(), Date.now(), 'private'))\r\n    }\r\n  }else{\r\n    chat.addMessage(new ChatMessage(text, local.id, local.information.name,\r\n      local.information.avatarSrc, local.getColor(), Date.now(), 'text'))\r\n  }\r\n}\r\n\r\nexport const ChatInBar: React.FC<Stores&TextLineStyle>  = (props) => {\r\n  //  console.log('Render RawContentList')\r\n  const classes = styleForList({height:props.lineHeight, fontSize:props.fontSize})\r\n  const [text, setText] = React.useState('')\r\n\r\n  return <div className={classes.container}\r\n    style={{height:'100%', display:'flex', flexDirection: 'column-reverse',\r\n    overflowY:'auto', overflowX:'clip', whiteSpace: 'pre-line'}} >\r\n    <form noValidate autoComplete=\"off\">\r\n      <Tooltip title={t('cmSend')} placement=\"right\">\r\n        <div style={{position:'relative', top:26, marginTop:-26, textAlign:'right', zIndex:1000}}>\r\n          <IconButton size={'small'} onClick={()=>{\r\n            const nameTo = props.chat.sendTo ?\r\n              props.participants?.find(props.chat.sendTo)?.information?.name : undefined\r\n            sendChatMessage(text, nameTo ? props.chat.sendTo : '', props)\r\n            setText('')\r\n          }}>\r\n            <SendIcon color=\"primary\" />\r\n          </IconButton>\r\n        </div>\r\n      </Tooltip>\r\n      <Observer>{()=>{\r\n        const nameTo = props.chat.sendTo ? props.participants?.find(props.chat.sendTo)?.information?.name : undefined\r\n        const textColor = isDarkColor(roomInfo.backgroundFill) ? 'white' : 'black'\r\n\r\n        return <TextField label={nameTo ? t('cmToName', {name: nameTo}) : t('cmToAll')} multiline={true} value={text}\r\n          style={{width:'100%', userSelect:'none'}} size={props.lineHeight > 20 ? 'medium' : 'small'}\r\n          InputProps={{style:{color:textColor}}}\r\n          InputLabelProps={{style:{color:textColor}}}\r\n          onFocus={()=>{props.map.keyInputUsers.add('chat')}}\r\n          onBlur={()=>{props.map.keyInputUsers.delete('chat')}}\r\n          onKeyDown={(ev)=>{\r\n            //  console.log(`key = ${ev.key}`, ev)\r\n            if (ev.key === 'Escape' || ev.key === 'Esc'){ //  Esc key\r\n              props.chat.sendTo = ''\r\n            }\r\n          }}\r\n          onKeyPress={(ev)=>{\r\n            //  if (ev.key === 'Enter'){  }\r\n            if (ev.key === '\\n'){ //  CTRL + Enter\r\n              sendChatMessage(text, nameTo ? props.chat.sendTo : '', props)\r\n              setText('')\r\n            }\r\n          }}\r\n          onChange={(ev)=>{ setText(ev.target.value) }}\r\n        />\r\n      }}</Observer>\r\n    </form>\r\n    <div>{  /* for indent: style={{marginLeft: '0.5em', textIndent: '-0.5em'}} */}\r\n      <Observer>{()=><>{\r\n        props.chat.messages.map((m, idx) =>\r\n          <ChatLine key={idx} message={m} {...props} /> )\r\n        }</>}</Observer>\r\n    </div>\r\n  </div>\r\n}\r\nChatInBar.displayName = 'Chat'\r\n\r\n","export class Settings{\r\n  useTransparent = true\r\n}\r\nexport const settings = new Settings()\r\nexport default settings\r\n","import {useStore} from '@hooks/SharedContentsStore'\r\nimport {makeStyles} from '@material-ui/core/styles'\r\nimport {t} from '@models/locales'\r\nimport {assert} from '@models/utils'\r\nimport {getGDriveUrl, getInformationOfGDriveContent, getParamsFromUrl,\r\n  getStringFromParams, isGDrivePreviewScrollable} from '@stores/sharedContents/SharedContentCreator'\r\nimport _ from 'lodash'\r\nimport {useObserver} from 'mobx-react-lite'\r\nimport React, {useEffect, useRef} from 'react'\r\nimport {ContentProps} from './Content'\r\n\r\nconst useStyles = makeStyles({\r\n  iframe: {\r\n    width: '100%',\r\n    height: '100%',\r\n    pointerEvents: 'none',\r\n  },\r\n  iframeEdit: {\r\n    width: '100%',\r\n    height: '100%',\r\n  },\r\n  iframeVScrool: (props: ContentProps) => ({\r\n    width:props.content.size[0] + 13 + 10,\r\n    height: props.content.size[0] * 100,\r\n    pointerEvents: 'none',\r\n  }),\r\n  divScroll:(props:ContentProps) => ({\r\n    width:props.content.size[0] + 100,\r\n    height: '100%',\r\n    position:'relative',\r\n    left:-15,\r\n    overflow:'scroll',\r\n  }),\r\n  divClip:{\r\n    width: '100%',\r\n    height: '100%',\r\n    overflow: 'hidden',\r\n  },\r\n  divError:{\r\n    width: '100%',\r\n    height: '100%',\r\n    overflow: 'hidden',\r\n    backgroundColor: 'white',\r\n  },\r\n})\r\n\r\ninterface Member{\r\n  props: ContentProps\r\n  params: Map<string, string>\r\n  scrolling: boolean\r\n}\r\n\r\nfunction updateUrl(member: Member) {\r\n  const url = getStringFromParams(member.params)\r\n\r\n  if (url !== member.props.content.url && member.props.updateAndSend) {\r\n    member.props.content.url = url\r\n    member.props.updateAndSend(member.props.content)\r\n  }\r\n}\r\n\r\nexport const GDrive: React.FC<ContentProps> = (props:ContentProps) => {\r\n  assert(props.content.type === 'gdrive')\r\n  const divScroll = useRef<HTMLDivElement>(null)\r\n  const contents = useStore()\r\n  const params = getParamsFromUrl(props.content.url)\r\n  const fileId = params.get('id')\r\n  const mimeType = params.get('mimeType')\r\n  const memberRef = useRef<Member>({props, params, scrolling:false})\r\n  const member = memberRef.current\r\n  member.props = props\r\n  member.params = params\r\n  if (!mimeType && fileId) {\r\n    getInformationOfGDriveContent(fileId).then((res)=>{\r\n      if ((res.name && props.content.name !== res.name) || res.mimeType){\r\n        member.params.set('mimeType', res.mimeType)\r\n        if (res.name){ props.content.name = res.name }\r\n        updateUrl(member)\r\n      }\r\n    })\r\n  }\r\n  //  console.log(`Name:${props.content.name} mime: ${mimeType}`)\r\n  const classes = useStyles(props)\r\n  const editing = useObserver(() => props.contents.editing === props.content.id)\r\n  const url = getGDriveUrl(editing, member.params)\r\n\r\n  //  scroll to given 'top' param\r\n  useEffect(() => {\r\n    const top = Number(member.params.get('top'))\r\n    if (!editing && !member.scrolling && divScroll.current\r\n      && !isNaN(top) && top !== divScroll.current.scrollTop) {\r\n      const onscroll = divScroll.current.onscroll\r\n      divScroll.current.onscroll = () => {}\r\n      divScroll.current.scrollTop = top\r\n      divScroll.current.onscroll = onscroll\r\n      //  console.log(`scrool to top=${top}`)\r\n    }\r\n  })\r\n\r\n  //  Set onscroll handler setting 'top' param\r\n  useEffect(() => {\r\n    function doSendScroll() {\r\n      const top = Number(member.params.get('top'))\r\n      if (divScroll.current && divScroll.current.scrollTop !== top) {\r\n        //  console.log(`doSendScrool top=${divScroll.current.scrollTop}`)\r\n        member.params.set('top', divScroll.current.scrollTop.toString())\r\n        updateUrl(member)\r\n      }\r\n    }\r\n    if (divScroll.current) {\r\n      const mine = contents.localParticipant.myContents.has(props.content.id)\r\n      const INTERVAL = 100\r\n      const sendScroll = mine ? _.throttle(() => setTimeout(doSendScroll, INTERVAL), INTERVAL)\r\n        : _.debounce(doSendScroll, INTERVAL)\r\n      const endScroll = _.debounce(() => {\r\n        member.scrolling = false\r\n        //  console.log(`scrolling: ${member.current.scrolling}`)\r\n      },                           INTERVAL)\r\n\r\n      divScroll.current.onscroll = () => {\r\n        member.scrolling = true\r\n        //  console.log(`scrolling: ${member.current.scrolling}`)\r\n        sendScroll()\r\n        endScroll()\r\n      }\r\n    }\r\n  // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  },        [contents.localParticipant.myContents, props.content.id])\r\n\r\n  const vscroll = isGDrivePreviewScrollable(mimeType)\r\n\r\n  return <div className={mimeType ? classes.divClip : classes.divError} >\r\n    {mimeType ?\r\n      <div className={(editing || !vscroll) ? classes.divClip : classes.divScroll} ref={divScroll}\r\n        onWheel = {ev => ev.ctrlKey || ev.stopPropagation() } >\r\n        <iframe src={url} title={props.content.url}\r\n          className={editing ? classes.iframeEdit : vscroll ? classes.iframeVScrool : classes.iframe}\r\n        />\r\n    </div> :\r\n    !editing ? <div style={{margin:'1em', whiteSpace:'pre-wrap'}}>{t('gdFailed')}</div> :\r\n      <div className={classes.divClip} onWheel = {ev => ev.ctrlKey || ev.stopPropagation() } >\r\n      <iframe src={url} title={props.content.url}\r\n        className={classes.iframeEdit}\r\n      />\r\n      </div>\r\n    }\r\n  </div>\r\n}\r\n","import {Collapse, Grid, TextField} from '@material-ui/core'\r\nimport IconButton from '@material-ui/core/IconButton'\r\nimport NavigateBeforeIcon from '@material-ui/icons/NavigateBefore'\r\nimport NavigateNextIcon from '@material-ui/icons/NavigateNext'\r\nimport {getProxiedUrl} from '@models/api/CORS'\r\nimport {assert} from '@models/utils'\r\nimport {makeObservable, observable} from 'mobx'\r\nimport {Observer, useObserver} from 'mobx-react-lite'\r\nimport {getDocument, GlobalWorkerOptions, renderTextLayer} from 'pdfjs-dist/es5/build/pdf'\r\nimport {PDFDocumentProxy, PDFPageProxy} from 'pdfjs-dist/types/display/api'\r\nimport React, {useEffect, useRef} from 'react'\r\nimport {ContentProps} from './Content'\r\n\r\n////GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@2.7.570/es5/build/pdf.worker.js'\r\nGlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@2.7.570/build/pdf.worker.js'\r\nconst CANVAS_SCALE = 3\r\n\r\nexport declare class RenderTask {\r\n  constructor(internalRenderTask: any);\r\n  _internalRenderTask: any\r\n  /**\r\n   * Callback for incremental rendering -- a function that will be called\r\n   * each time the rendering is paused.  To continue rendering call the\r\n   * function that is the first argument to the callback.\r\n   * @type {function}\r\n   */\r\n  onContinue: Function\r\n  /**\r\n   * Promise for rendering task completion.\r\n   * @type {Promise<void>}\r\n   */\r\n  get promise(): Promise<void>;\r\n  /**\r\n   * Cancels the rendering task. If the task is currently rendering it will\r\n   * not be cancelled until graphics pauses with a timeout. The promise that\r\n   * this object extends will be rejected when cancelled.\r\n   */\r\n  cancel(): void\r\n}\r\n\r\n\r\nclass Member{\r\n  newProps!: ContentProps\r\n  props!: ContentProps\r\n  mainUrl!: string\r\n  document?: PDFDocumentProxy = undefined\r\n  pages: PDFPageProxy[] = []\r\n  renderTask?: RenderTask = undefined\r\n  canvas: HTMLCanvasElement|null = null\r\n  textDiv: HTMLDivElement|null = null\r\n  annotationDiv: HTMLDivElement|null = null\r\n  prevSize = [0,0]\r\n  pageNum = 0\r\n  @observable numPages = 0\r\n  @observable showTop = true\r\n  @observable pageText = ''\r\n  constructor(){\r\n    makeObservable(this)\r\n  }\r\n  render(){\r\n    const page = this.pages[this.pageNum]\r\n    if (this.canvas && page){\r\n      const viewport1 = page.getViewport({scale:1})\r\n      const c = this.props.content\r\n      if (c.originalSize[0] !== viewport1.width || c.originalSize[1] !== viewport1.height) {\r\n        c.originalSize = [viewport1.width, viewport1.height]\r\n        c.size = [c.size[0], c.size[0] * c.originalSize[1] / c.originalSize[0]]\r\n        this.props.updateOnly(this.props.content)\r\n\r\n        return false\r\n      }\r\n      const scale = CANVAS_SCALE * this.props.content.size[0] / viewport1.width\r\n      const viewport = page.getViewport({scale})\r\n      this.canvas.width = viewport.width\r\n      this.canvas.height = viewport.height\r\n      const ctx = this.canvas.getContext('2d')\r\n      if (ctx){\r\n        if (this.renderTask){\r\n          this.renderTask.cancel()\r\n        }\r\n        this.renderTask = page.render({canvasContext: ctx, viewport})\r\n        this.renderTask.promise.then(()=>{\r\n          page.getTextContent().then((textContent)=>{\r\n            // Pass the data to the method for rendering of text over the pdf canvas.\r\n            if (this.textDiv) {\r\n              const children = this.textDiv.childNodes\r\n              Array.from(children.values()).forEach(c => c.remove())\r\n              const texts: HTMLElement[] = []\r\n              renderTextLayer({\r\n                textContent: textContent,\r\n                container: this.textDiv,\r\n                viewport,\r\n                textDivs: texts\r\n              })\r\n              texts.forEach(text => {\r\n                text.style.position='absolute'\r\n                text.style.color='transparent'\r\n                text.style.whiteSpace='pre'\r\n                text.style.transformOrigin='0% 0%'\r\n                text.style.whiteSpace='nowrap'\r\n                text.style.verticalAlign='top'\r\n              })\r\n            }\r\n          })\r\n          this.renderTask = undefined\r\n        }).catch(reason => {\r\n          //  console.log(`Rendering canceled reason:${reason}`)\r\n        })\r\n      }\r\n\r\n      return true\r\n    }\r\n\r\n    return false\r\n  }\r\n  updateProps(){\r\n    if (this.newProps === this.props) {\r\n      //  console.log('PDF c:', this.newProps === this.props, this.newProps.content.url, this.props?.content?.url)\r\n\r\n      return\r\n    }\r\n\r\n    this.props = this.newProps\r\n\r\n    const url = new URL(this.props.content.url)\r\n    this.mainUrl = url.hash ? url.href.substring(0, url.href.length - url.hash.length) : url.href\r\n    let pageNum = this.pageNum\r\n    if (url.hash.substr(0,6) === '#page='){\r\n      pageNum = Number(url.hash.substr(6)) - 1 ?? 0\r\n      if (pageNum < 0){ pageNum = 0 }\r\n      if (this.numPages && pageNum >= this.numPages){ pageNum = this.numPages-1 }\r\n    }\r\n    if (!this.document || pageNum !== this.pageNum){\r\n      //  console.log(`doc${this.document}  page=${this.pageNum} -> ${pageNum}`)\r\n      this.getPage(pageNum).then(()=>{\r\n        this.render()\r\n      })\r\n      this.pageNum = pageNum\r\n      this.pageText = String(pageNum + 1)\r\n    }else if(this.prevSize[0] !== this.props.content.size[0] || this.prevSize[1] !== this.props.content.size[1]){\r\n      if (this.render()){\r\n        this.prevSize = Array.from(this.props.content.size)\r\n      }\r\n    }\r\n  }\r\n  getDocument(){\r\n    const rv = new Promise<PDFDocumentProxy>((resolve, reject)=>{\r\n      if (this.document){\r\n        resolve(this.document)\r\n      }else{\r\n        const task = getDocument({\r\n          url: getProxiedUrl(this.mainUrl),\r\n          cMapUrl: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@2.7.570/cmaps/',\r\n          cMapPacked: true,\r\n        })\r\n        task.promise.then((doc) => {\r\n          this.document = doc\r\n          this.numPages = doc.numPages\r\n          resolve(this.document)\r\n        }).catch(reason => {\r\n          console.error(`PDF: failed to load ${this.mainUrl}`)\r\n          reject(reason)\r\n        })\r\n//        task.onProgress = (progress:{loaded: number, total: number}) => {\r\n//          console.log(`PDF progress ${progress.loaded}/${progress.total}`)\r\n//        }\r\n      }\r\n    })\r\n\r\n    return rv\r\n  }\r\n  getPage(pageNum:number) {\r\n    const rv = new Promise<PDFPageProxy>((resolve, reject) => {\r\n      if (this.pages[pageNum]){\r\n        resolve(this.pages[pageNum])\r\n      }else{\r\n        this.getDocument().then((doc)=>{\r\n          doc.getPage(pageNum+1).then((page)=>{\r\n            this.pages[pageNum] = page\r\n            resolve(this.pages[pageNum])\r\n          }).catch((reason)=> {\r\n            reject(reason)\r\n          })\r\n        }).catch((reason)=> {\r\n          reject(reason)\r\n        })\r\n      }\r\n    })\r\n\r\n    return rv\r\n  }\r\n  updateUrl(pageNum?: number){\r\n    if (pageNum === undefined || !Number.isFinite(pageNum)) {pageNum = this.pageNum}\r\n    if (pageNum < 0) {pageNum = 0}\r\n    if (pageNum >= this.numPages) {pageNum = this.numPages-1}\r\n    const url = `${this.mainUrl}#page=${pageNum+1}`\r\n    if (url !== this.props.content.url) {\r\n      const c = Object.assign({}, this.props.content)\r\n      c.url = url\r\n      this.props.updateAndSend(c)\r\n    }\r\n  }\r\n}\r\n\r\nconst stopper = {\r\n  onMouseDown: (ev:React.MouseEvent) => {ev.stopPropagation()},\r\n  onMouseUp: (ev:React.MouseEvent) => {ev.stopPropagation()},\r\n  onPointerDown: (ev:React.MouseEvent) => {ev.stopPropagation()},\r\n  onPointerUp: (ev:React.MouseEvent) => {ev.stopPropagation()},\r\n}\r\n\r\nexport const PDF: React.FC<ContentProps> = (props:ContentProps) => {\r\n  assert(props.content.type === 'pdf')\r\n  const memberRef = useRef<Member>(new Member())\r\n  const member = memberRef.current\r\n  member.newProps = props\r\n  const refCanvas = useRef<HTMLCanvasElement>(null)\r\n  const refTextDiv = useRef<HTMLDivElement>(null)\r\n  const refAnnotationDiv = useRef<HTMLDivElement>(null)\r\n  const editing = useObserver(() => props.contents.editing === props.content.id)\r\n\r\n  useEffect(()=>{\r\n    member.canvas = refCanvas.current\r\n    member.textDiv = refTextDiv.current\r\n    member.annotationDiv = refAnnotationDiv.current\r\n  // eslint-disable-next-line  react-hooks/exhaustive-deps\r\n  }, [refCanvas.current])\r\n\r\n  useEffect(()=>{\r\n    member.updateProps()\r\n  })\r\n\r\n  return <div style={{overflow: 'hidden', pointerEvents: 'auto', userSelect: editing? 'text':'none'}}\r\n    onDoubleClick = {(ev) => { if (!editing) {\r\n      ev.stopPropagation()\r\n      ev.preventDefault()\r\n      props.contents.setEditing(props.content.id)\r\n    } }} >\r\n    <canvas style={{ width:`${CANVAS_SCALE*100}%`, height:`${CANVAS_SCALE*100}%`,\r\n      transformOrigin:'top left', transform:`scale(${1/CANVAS_SCALE})`}} ref={refCanvas} />\r\n    <div ref={refTextDiv} style={{position:'absolute', left:0, top:0,\r\n      width:`${CANVAS_SCALE*100}%`, height:`${CANVAS_SCALE*100}%`,\r\n      transformOrigin:'top left', transform:`scale(${1/CANVAS_SCALE})`, lineHeight: 1,\r\n      overflow:'hidden'}} />\r\n    <div ref={refAnnotationDiv} />\r\n    <div style={{position:'absolute', top:0, left:0, width:'100%', height:40}}\r\n      onPointerEnter={()=>{member.showTop = true}} onPointerLeave={()=>{member.showTop = false}}>\r\n      <Observer>{()=>\r\n        <Collapse in={member.showTop} style={{position:'absolute', top:0, left:0, width:'100%'}}>\r\n          <Grid container alignItems=\"center\">\r\n            <Grid item >\r\n              <IconButton size=\"small\" color={member.pageNum>0?'primary':'default'} {...stopper}\r\n                onClick={(ev) => { ev.stopPropagation(); member.updateUrl(member.pageNum - 1) }}\r\n                onDoubleClick={(ev) => {ev.stopPropagation() }} >\r\n              <NavigateBeforeIcon />\r\n              </IconButton>\r\n            </Grid>\r\n            <Grid item xs={1}>\r\n              <TextField value={member.pageText} {...stopper}\r\n                inputProps={{min: 0, style: { textAlign: 'center' }}}\r\n                onChange={(ev)=> { member.pageText = ev.target.value}}\r\n                onBlur={(ev) => {\r\n                  const num = Number(member.pageText)\r\n                  if (num > 0) { member.updateUrl(num-1) }\r\n                }}\r\n                onKeyPress={(ev)=>{\r\n                  if (ev.key === 'Enter'){\r\n                    const num = Number(member.pageText)\r\n                    if (num > 0) { member.updateUrl(num-1) }\r\n                  }\r\n                }}\r\n              />\r\n            </Grid>\r\n            <Grid item style={{fontSize:15}}>/ {member.numPages}</Grid>\r\n            <Grid item >\r\n              <IconButton size=\"small\" color={member.pageNum<member.numPages-1?'primary':'default'} {...stopper}\r\n                onClick={(ev) => { ev.stopPropagation(); member.updateUrl(member.pageNum + 1) }}\r\n                onDoubleClick={(ev) => {ev.stopPropagation() }} >\r\n              <NavigateNextIcon />\r\n              </IconButton>\r\n            </Grid>\r\n          </Grid>\r\n        </Collapse>\r\n      }</Observer>\r\n    </div>\r\n  </div>\r\n}\r\n","import {makeStyles} from '@material-ui/core/styles'\r\nimport {ISharedContent} from '@models/ISharedContent'\r\nimport {assert, mulV2} from '@models/utils'\r\nimport sharedContents from '@stores/sharedContents/SharedContents'\r\nimport {JitsiLocalTrack, JitsiRemoteTrack} from 'lib-jitsi-meet'\r\nimport _ from 'lodash'\r\nimport {useObserver} from 'mobx-react-lite'\r\nimport React, {useEffect, useRef} from 'react'\r\nimport {ContentProps} from './Content'\r\n\r\nconst useStyles = makeStyles({\r\n  video: {\r\n    width: '100%',\r\n    height: '100%',\r\n  },\r\n})\r\n\r\ninterface ScreenContentMember{\r\n  locals: JitsiLocalTrack[]\r\n  remotes: JitsiRemoteTrack[]\r\n  content: ISharedContent\r\n}\r\n\r\nexport const ScreenContent: React.FC<ContentProps> = (props:ContentProps) => {\r\n  assert(props.content.type === 'screen' || props.content.type === 'camera')\r\n  const classes = useStyles()\r\n  const ref = useRef<HTMLVideoElement>(null)\r\n  const [muted, setMuted] = React.useState(false)\r\n  const member = useRef<ScreenContentMember>({} as ScreenContentMember)\r\n  member.current = {\r\n    locals: useObserver<JitsiLocalTrack[]>(() =>\r\n      Array.from(sharedContents.tracks.localContents.get(props.content.id) || [])),\r\n    remotes: useObserver<JitsiRemoteTrack[]>(() =>\r\n      Array.from(sharedContents.tracks.remoteContents.get(props.content.id) || [])),\r\n    content: props.content,\r\n  }\r\n  if (member.current.locals.length > 2) {\r\n    console.error(`content ${props.content.id} has ${member.current.locals.length} local tracks`, member.current.locals)\r\n  }\r\n  if (member.current.remotes.length > 2) {\r\n    console.error(\r\n      `content ${props.content.id} has ${member.current.remotes.length} remote tracks`, member.current.remotes)\r\n  }\r\n\r\n  function setTrack() {\r\n    assert(member.current.locals.length===0 || member.current.remotes.length===0)\r\n    if (ref.current) {\r\n      const ms = new MediaStream()\r\n      member.current.locals.forEach((track) => {\r\n        if (track.getType() !== 'audio') { //  Never play local audio. It makes echo.\r\n          ms.addTrack(track.getTrack())\r\n        }\r\n      })\r\n      member.current.remotes.forEach((track) => {\r\n        if (track.getType() !== 'audio') { //  Remote audio is played by ConnectedMananger\r\n          ms.addTrack(track.getTrack())\r\n          const onMuteLater = _.debounce(()=>{setMuted(true)}, 3000)\r\n          track.getTrack().onmute = onMuteLater\r\n          track.getTrack().onunmute = () => {\r\n            onMuteLater.cancel()\r\n            setMuted(false)\r\n          }\r\n        }\r\n      })\r\n\r\n      const old = ref.current.srcObject instanceof MediaStream && ref.current.srcObject.getTracks()\r\n      const cur = ms.getTracks()\r\n      if (cur.length) {\r\n        if (! _.isEqual(old, cur)) {\r\n          console.log('prev-next:', old, cur)\r\n          ref.current.srcObject = ms\r\n          ref.current.autoplay = true\r\n        }\r\n      }\r\n    }\r\n  }\r\n  //  const simulcastRatios = [0.25, 0.5, 0.75, 4.0 / 3, 2, 4]\r\n  const simulcastRatios:number[] = []\r\n  function checkVideoSize() {\r\n    if (member.current.locals.length && ref.current) {\r\n      const tracks = ref.current.srcObject instanceof MediaStream && ref.current.srcObject.getTracks()\r\n      if (tracks && tracks.length) {\r\n        const video = tracks.find(track => track.kind === 'video')\r\n        const settings = video?.getSettings()\r\n        const newSize = [settings?.width || 0, settings?.height || 0] as [number, number]\r\n        if (newSize[0] && member.current.content.originalSize.toString() !== newSize.toString()) {\r\n          if (member.current.content.originalSize[0]){\r\n            const sx = member.current.content.originalSize[0] / newSize[0]\r\n            const sy = member.current.content.originalSize[1] / newSize[1]\r\n            if (sx === sy && simulcastRatios.find(s => s === sx)) { return }\r\n          }\r\n          const scale = member.current.content.size[0] /\r\n            (member.current.content.originalSize[0] ? member.current.content.originalSize[0] : newSize[0])\r\n          member.current.content.originalSize = newSize\r\n          member.current.content.size = mulV2(scale, newSize)\r\n          props.updateAndSend(member.current.content)\r\n        }\r\n      }\r\n    }\r\n  }\r\n  useEffect(() => {\r\n    setTrack()\r\n  },        [member.current.locals, member.current.remotes])\r\n  useEffect(() => {\r\n    const interval = setInterval(checkVideoSize, 333)   //  Notification of exact video size may take time.\r\n\r\n    return () => clearInterval(interval)\r\n  })\r\n\r\n  return <video className={classes.video} style={muted ? {filter: 'brightness(80%) sepia(25%)'} : {}} ref={ref} />\r\n}\r\n","import {formatTimestamp} from '@components/utils'\r\nimport {Tooltip} from '@material-ui/core'\r\nimport {makeStyles} from '@material-ui/core/styles'\r\nimport {CSSProperties} from '@material-ui/styles'\r\nimport settings from '@models/api/Settings'\r\nimport {compTextMessage, TextMessage, TextMessages} from '@models/ISharedContent'\r\nimport {assert, findTextColorRGB, isSelfUrl} from '@models/utils'\r\nimport {getRandomColorRGB, rgba} from '@models/utils'\r\nimport _ from 'lodash'\r\nimport {Observer, useObserver} from 'mobx-react-lite'\r\nimport React, {useEffect, useRef} from 'react'\r\nimport {ContentProps} from './Content'\r\n\r\nclass TextMember{\r\n  messages: TextMessage[] = []\r\n  isStatic = false\r\n  abortScroll = false\r\n  editing = false\r\n}\r\n//  Update (send) the content if needed\r\nfunction onUpdateTexts(messages: TextMessage[], div:HTMLDivElement, props: ContentProps) {\r\n  const newTexts: TextMessages = {messages, scroll:[div.scrollLeft, div.scrollTop]}\r\n  const newUrl = JSON.stringify(newTexts)\r\n  if (props.content.url !== newUrl && props.updateAndSend) {\r\n    props.content.url = newUrl\r\n    props.updateAndSend(props.content)\r\n  }\r\n}\r\n\r\n\r\ninterface TextDivProps extends ContentProps{\r\n  text: TextMessage\r\n  textEditing: boolean\r\n  textToShow: JSX.Element[]\r\n  member: TextMember\r\n  div: HTMLDivElement | null\r\n  autoFocus: boolean\r\n}\r\ninterface TextEditProps extends TextDivProps{\r\n  css: React.CSSProperties\r\n}\r\n\r\nfunction sendText(text: string, props: TextEditProps){\r\n  //  console.log(`send text ${text}`)\r\n  props.text.message = text\r\n  const messagesToSend = props.member.messages.filter(text => text.message.length)\r\n  if (props.div){\r\n    onUpdateTexts(messagesToSend, props.div, props)\r\n  }\r\n}\r\n\r\n\r\nexport const TextEdit: React.FC<TextEditProps> = (props:TextEditProps) => {\r\n  const [text, setText] = React.useState(props.text.message)\r\n  const sendTextLaterRef = useRef<any>(undefined)\r\n  useEffect(() => {\r\n    sendTextLaterRef.current = _.throttle(sendText, 1000, {leading: false})\r\n  }, [])\r\n  const sendTextLater = sendTextLaterRef.current\r\n\r\n  return <Observer>{() =>\r\n  <div style={{...props.css, position:'relative', margin:0, border:0, padding:0, backgroundColor:'none'}}>\r\n    <div style={{...props.css, color:'red', position:'relative', width:'100%',\r\n      overflow: 'hidden', visibility:'hidden'}}>{text+'\\u200b'}</div>\r\n    <textarea value={text} autoFocus={props.autoFocus}\r\n      style={{...props.css, font: 'inherit', verticalAlign:'baseline', resize:'none',\r\n      position:'absolute', top:0, left:0, width:'100%', height:'100%', border:'none',\r\n      letterSpacing: 'inherit', overflow: 'hidden'\r\n    }}\r\n      onChange={(ev) => {\r\n        setText(ev.currentTarget.value)\r\n        if (sendTextLater){\r\n          sendTextLater(ev.currentTarget.value, props)\r\n        }\r\n      }}\r\n      onBlur={()=>{\r\n        if (sendTextLater){ sendTextLater.cancel() }\r\n        sendText(text, props)\r\n      }}\r\n      onKeyDown={(ev) => {\r\n        if (ev.key === 'Escape' || ev.key === 'Esc') {\r\n          ev.stopPropagation()\r\n          ev.preventDefault()\r\n          if (sendTextLater){ sendTextLater.cancel() }\r\n          sendText(text, props)\r\n          props.contents.setEditing('')\r\n        }\r\n      }}\r\n    />\r\n  </div>}</Observer>\r\n}\r\n\r\nexport const TextDiv: React.FC<TextDivProps> = (props:TextDivProps) => {\r\n  const timestamp = formatTimestamp(props.text.time)    //  make formated timestamp for tooltip\r\n  const rgb = props.text.color?.length ? props.text.color : getRandomColorRGB(props.text.name)\r\n  const textColor = props.text.textColor?.length ? props.text.textColor : findTextColorRGB(rgb)\r\n  const css:CSSProperties = {\r\n    color: rgba(textColor, 1),\r\n    backgroundColor:settings.useTransparent ? rgba(rgb, 0.5) : rgba(rgb, 1),\r\n    padding:'0.1em',\r\n    fontSize: 16,\r\n    lineHeight: 1.2,\r\n    width:'100%',\r\n    overflow: 'clip',\r\n    boxSizing: 'border-box',\r\n    whiteSpace: 'pre-wrap',\r\n    wordWrap: 'break-word',\r\n    overflowWrap: 'break-word',\r\n  }\r\n  const {backgroundColor, ...cssEdit} = css\r\n  cssEdit.backgroundColor = rgba(rgb, 1)\r\n\r\n  return <Tooltip title={<React.Fragment>{props.text.name} <br /> {timestamp}</React.Fragment>}\r\n  placement=\"left\" arrow={true} suppressContentEditableWarning={true}><div>\r\n  {props.textEditing ? <TextEdit {...props} css={cssEdit} /> :\r\n  <div style={css}\r\n    //  Select text by static click\r\n    onPointerDown={()=>{ props.member.isStatic = true }}\r\n    onPointerMove={()=>{ props.member.isStatic = false }}\r\n    onPointerUp={(ev)=>{\r\n      if (!props.member.isStatic){ return }\r\n      const target = ev.target\r\n      if (target instanceof Node){\r\n        ev.preventDefault()\r\n        const selection = window.getSelection()\r\n        if (selection){\r\n          if (selection.rangeCount && selection.getRangeAt(0).toString()){\r\n            selection.removeAllRanges()\r\n          }else{\r\n            const range = document.createRange()\r\n            range.selectNode(target)\r\n            selection.removeAllRanges()\r\n            selection.addRange(range)\r\n          }\r\n        }\r\n      }\r\n    }}\r\n  >\r\n    {props.textToShow}\r\n  </div>}\r\n  </div></Tooltip>\r\n}\r\n\r\nfunction makeLink(key:number, regResult: string[]){\r\n  //console.log('reg:', regResult)\r\n  let href='', target='', disp=''\r\n  if (regResult[1]) { disp=href=regResult[1]; target='_blank' }\r\n  else if (regResult[2]) {\r\n    href = regResult[2]\r\n    disp = regResult[6] ? regResult[6] : regResult[2]\r\n    target = regResult[3] ? '_self' : '_blank'\r\n  }\r\n  else {\r\n    disp = regResult[7]\r\n    href = regResult[11]\r\n    target = (regResult[9]||regResult[10]) ? '_self' : '_blank'\r\n  }\r\n  if (isSelfUrl(new URL(href))){\r\n    target = '_self'\r\n  }\r\n\r\n  return <a key={key} href={href} target={target} rel=\"noreferrer\">{disp}</a>\r\n}\r\n\r\nconst cssText: CSSProperties = {\r\n  height: '100%',\r\n  width: '100%',\r\n  whiteSpace: 'pre-line',\r\n  pointerEvents: 'auto',\r\n  overflowY: 'auto',\r\n  overflowX: 'visible',\r\n  wordWrap: 'break-word',\r\n}\r\nconst useStyles = makeStyles({\r\n  text: cssText,\r\n  textEdit: {\r\n    ...cssText,\r\n    cursor: 'default',\r\n    userSelect: 'text',\r\n  },\r\n})\r\n\r\nexport const Text: React.FC<ContentProps> = (props:ContentProps) => {\r\n  assert(props.content.type === 'text')\r\n  const memberRef = React.useRef<TextMember>(new TextMember())\r\n  const member = memberRef.current\r\n  const classes = useStyles()\r\n  const ref = useRef<HTMLDivElement>(null)\r\n  const url = props.content.url\r\n  const newTexts = JSON.parse(url) as TextMessages\r\n  //const refEdit = useRef<HTMLDivElement>(null)\r\n  const editing = useObserver(() => props.contents.editing === props.content.id)\r\n  if (editing){\r\n    props.contents.setBeforeChangeEditing((cur, next) => {\r\n      if (cur === props.content.id && next === ''){\r\n        if (ref.current){\r\n          member.messages = member.messages.filter(text => text.message.length)\r\n          onUpdateTexts(member.messages, ref.current, props)\r\n        }\r\n        props.contents.setBeforeChangeEditing() //  clear me\r\n      }\r\n    })\r\n  }\r\n  useEffect(() => {\r\n    if (!editing && ref.current) {\r\n      if (ref.current.scrollLeft!==newTexts.scroll[0] || ref.current.scrollTop!==newTexts.scroll[1]){\r\n        member.abortScroll = true\r\n        ref.current?.scroll(newTexts.scroll[0], newTexts.scroll[1])\r\n      }\r\n    }\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  },        [newTexts.scroll[0], newTexts.scroll[1], editing])\r\n\r\n  //  Update remote messages\r\n  const indices = new Set<number>()\r\n  newTexts.messages.forEach((newMessage) => {\r\n    const index = member.messages.findIndex(msg => msg.pid === newMessage.pid && msg.time === newMessage.time)\r\n    if (index === -1) {\r\n      indices.add(member.messages.length)\r\n      member.messages.push(newMessage)       //  Add new messages\r\n    }else if (newMessage.pid !== props.participants.localId){\r\n      indices.add(index)\r\n      member.messages[index] = newMessage  //  Update remote messages\r\n    }\r\n  })\r\n  //  remove removed messages\r\n  member.messages = member.messages.filter((msg, idx) =>\r\n    msg.pid === props.participants.localId || indices.has(idx))\r\n  member.messages.sort(compTextMessage)\r\n\r\n  let focusToEdit:undefined|TextMessage = undefined\r\n  if (editing) {\r\n    //  Make a new message to edit if needed.\r\n    const last = member.messages.pop()\r\n    if (last) {\r\n      member.messages.push(last)\r\n    }\r\n    if (last?.pid !== props.participants.localId) {\r\n      member.messages.push({message:'', pid:props.participants.localId,\r\n        name:props.participants.local.information.name,\r\n        color: props.participants.local.information.color,\r\n        textColor: props.participants.local.information.textColor,\r\n        time:Date.now()})\r\n    }\r\n    if (!member.editing) {  //  Find the message to focus to edit, i.e. my last message.\r\n      member.messages.reverse()\r\n      focusToEdit = member.messages.find(message => message.pid === props.participants.localId)\r\n      member.messages.reverse()\r\n    }\r\n  }\r\n\r\n  //  Makeing text (JSX element) to show\r\n  const textDivs = member.messages.map((text, idx) => {\r\n    const textEditing = (editing &&\r\n      (text.pid === props.participants.localId || !props.participants.remote.has(text.pid)))\r\n\r\n    const textToShow:JSX.Element[] = []\r\n    if (!textEditing){\r\n      //  add link to URL strings\r\n      const urlReg = 'https?:\\\\/\\\\/[-_.!~*\\'()a-zA-Z0-9;/?:@&=+$,%#]+'\r\n      const urlRegExp = new RegExp(`(${urlReg})|` +\r\n        `\\\\[(${urlReg})(( *>)|( +move))?\\\\s*(\\\\S+)\\\\]` +\r\n        `|\\\\[(\\\\S+)((\\\\s*>)|(\\\\s+move)|\\\\s)\\\\s*(${urlReg})\\\\]`)\r\n      let regResult:RegExpExecArray | null\r\n      let start = 0\r\n      while ((regResult = urlRegExp.exec(text.message.slice(start))) !== null) {\r\n        const before = text.message.slice(start, start + regResult.index)\r\n        if (before) {\r\n          textToShow.push(<span key={start}>{before}</span>)\r\n        }\r\n        textToShow.push(makeLink(start + before.length, regResult))\r\n        start += before.length + regResult[0].length\r\n      }\r\n      textToShow.push(<span key={start}>{text.message.slice(start)}</span>)\r\n    }\r\n\r\n    return <TextDiv {...props} key={idx} text={text} div={ref.current} textToShow={textToShow}\r\n      member={member} textEditing={textEditing} autoFocus = {text === focusToEdit} />\r\n  })\r\n  const INTERVAL = 200\r\n  const handleScroll = _.debounce((ev:React.UIEvent<HTMLDivElement, UIEvent>) => {\r\n    if (ref.current){\r\n      if (member.abortScroll) {\r\n        member.abortScroll = false\r\n      }else{\r\n        //\tconsole.log('sendScroll')\r\n        onUpdateTexts(member.messages, ref.current, props)\r\n      }\r\n    }\r\n  }, INTERVAL)\r\n  member.editing = editing\r\n\r\n  return  <div ref={ref} className = {editing ? classes.textEdit : classes.text}\r\n    onWheel = {ev => ev.ctrlKey || ev.stopPropagation() }\r\n    onScroll = {(ev) => { if (!editing) {  handleScroll(ev) } }}\r\n    >\r\n    {textDivs}\r\n  </div>\r\n}\r\n","import {PARTICIPANT_SIZE} from '@models/Participant'\r\nimport {Pose3DAudio, convertToAudioCoordinate} from '@models/utils'\r\nimport {mulV3, normV} from '@models/utils/coordinates'\r\nimport errorInfo from '@stores/ErrorInfo'\r\nimport {ConfigurableParams, ConfigurableProp} from './StereoParameters'\r\nimport contents from '@stores/sharedContents/SharedContents'\r\n//import { participants } from '@stores/'\r\n//import {useStore} from '@hooks/MapStore'\r\nimport participants from '@stores/participants/Participants'\r\n\r\n\r\nexport function setAudioOutputDevice(audio: HTMLAudioElement, deviceId: string) {\r\n  const audioEx:any = audio\r\n  if (audioEx.setSinkId) {\r\n    audioEx.setSinkId(deviceId).then(\r\n      () => {\r\n        //  console.debug('audio.setSinkId:', deviceId, ' success')\r\n      },\r\n    ).catch(\r\n      () => { console.warn('audio.setSinkId:', deviceId, ' failed') },\r\n    )\r\n  }\r\n}\r\n\r\n\r\n// NOTE Set default value will change nothing. Because value will be overwrite by store in ConnectedGroup\r\n/*\r\nconst DEFAULT_PANNER_NODE_CONFIG: Partial<PannerNode> & {refDistance: number} = {\r\n  panningModel: 'HRTF',\r\n  distanceModel: 'inverse',\r\n  refDistance: PARTICIPANT_SIZE,\r\n  maxDistance: 10000,\r\n  rolloffFactor: 1,\r\n  coneInnerAngle: 45,\r\n  coneOuterAngle: 360,\r\n  coneOuterGain: 0,\r\n}\r\n*/\r\nexport const BROADCAST_DISTANCE = 100000\r\n\r\nexport type PlayMode = 'Context' | 'Element' | 'Pause'\r\n\r\n\r\n\r\nexport class NodeGroup {\r\n  private sourceNode: MediaStreamAudioSourceNode | undefined = undefined\r\n  private audioElement: HTMLAudioElement | undefined = undefined\r\n\r\n  private readonly gainNode: GainNode\r\n  private readonly pannerNode: PannerNode\r\n  private readonly destination: MediaStreamAudioDestinationNode\r\n\r\n  private readonly context: AudioContext\r\n  private playMode: PlayMode|undefined\r\n  private audioDeviceId = ''\r\n  private distance = 1\r\n\r\n  constructor(context: AudioContext, destination: MediaStreamAudioDestinationNode,\r\n              playMode: PlayMode|undefined, audibility: boolean) {\r\n    this.context = context\r\n    this.destination = destination\r\n\r\n    this.gainNode = this.createGainNode(context)\r\n    this.pannerNode = this.createPannerNode(context)\r\n\r\n    this.gainNode.connect(this.pannerNode)\r\n    this.pannerNode.connect(this.destination)\r\n\r\n    this.playMode = playMode\r\n    this.updateAudibility(audibility)\r\n  }\r\n\r\n  interval:NodeJS.Timeout|undefined = undefined\r\n  setPlayMode(playMode: PlayMode|undefined) {\r\n    this.playMode = playMode\r\n\r\n    switch (playMode) {\r\n      case 'Pause': {\r\n        this.sourceNode?.disconnect()\r\n        /*try {\r\n          this.pannerNode.disconnect(this.destination)\r\n        }catch (e) {}*/\r\n\r\n        if (this.interval) {\r\n          clearInterval(this.interval)\r\n          this.interval = undefined\r\n        }\r\n        if (this.audioElement) {\r\n          this.audioElement.pause()\r\n        }\r\n        break\r\n      }\r\n      case 'Context': {\r\n        this.sourceNode?.connect(this.gainNode)\r\n        //  this.pannerNode.connect(this.destination)\r\n        if (this.interval) {\r\n          clearInterval(this.interval)\r\n          this.interval = undefined\r\n        }\r\n        if (this.audioElement) {\r\n          this.audioElement.pause()\r\n        }\r\n        break\r\n      }\r\n      case 'Element': {\r\n        this.sourceNode?.disconnect()\r\n        /*try {\r\n          this.pannerNode.disconnect(this.destination)\r\n        }catch (e) {}*/\r\n\r\n        if (!this.audioElement) {\r\n          this.audioElement = this.createAudioElement()\r\n        }\r\n        this.audioElement.muted = false\r\n        if (!this.interval) {\r\n          this.interval = setInterval(\r\n            () => {\r\n              if (!errorInfo.type) {\r\n                this?.audioElement?.play().then(() => {\r\n                  //  console.warn(`Succeed to play in NodeGroup`)\r\n                  if (this.interval) {\r\n                    clearInterval(this.interval)\r\n                    this.interval = undefined\r\n                  }\r\n                }).catch(reason => {\r\n                  //  console.warn(`Failed to play in NodeGroup reason:${reason}`)\r\n                })\r\n              }\r\n            },\r\n            500,\r\n          )\r\n        }\r\n        break\r\n      }\r\n      default:\r\n        console.error(`Unknown output: ${playMode}`)\r\n        break\r\n    }\r\n\r\n    this.updateAudibility(this.audibility)\r\n    this.updateVolume()\r\n  }\r\n\r\n  setAudioOutput(id: string) {\r\n    if (this.audioDeviceId !== id) {\r\n      this.audioDeviceId = id\r\n      if (this.audioElement) {\r\n        setAudioOutputDevice(this.audioElement, this.audioDeviceId)\r\n      }\r\n    }\r\n  }\r\n\r\n  updateStream(stream: MediaStream | undefined) {\r\n    this.updateSourceStream(stream)\r\n    this.setPlayMode(this.playMode)\r\n  }\r\n\r\n  updatePose(pose: Pose3DAudio) {\r\n    const participant_pose = pose\r\n    const dist = normV(pose.position)\r\n\r\n    \r\n\r\n    const mul = ((dist * dist) / (this.pannerNode.refDistance * this.pannerNode.refDistance)\r\n      + this.pannerNode.refDistance - 1) / (dist ? dist : 1)\r\n    this.distance = mul * dist\r\n\r\n    if (this.pannerNode.positionX && this.pannerNode.orientationX) {\r\n      this.pannerNode.positionX.setValueAtTime(mul * pose.position[0], this.context.currentTime)\r\n      this.pannerNode.positionY.setValueAtTime(mul * pose.position[1], this.context.currentTime)\r\n      this.pannerNode.positionZ.setValueAtTime(mul * pose.position[2], this.context.currentTime)\r\n      this.pannerNode.orientationX.setValueAtTime(pose.orientation[0], this.context.currentTime)\r\n      this.pannerNode.orientationY.setValueAtTime(pose.orientation[1], this.context.currentTime)\r\n      this.pannerNode.orientationZ.setValueAtTime(pose.orientation[2], this.context.currentTime)\r\n    }else {\r\n      this.pannerNode.setPosition(...mulV3(mul, pose.position))\r\n      this.pannerNode.setOrientation(...pose.orientation)\r\n    }\r\n    //this.updateVolume()\r\n    this.updateVolumeWithAssets(participant_pose)\r\n  }\r\n  private getContentsStatus(_x: number, _y:number) {\r\n    \r\n    let _status = 0\r\n    //console.log(contents.all, \" all content\")\r\n    let cLength = contents.all.length\r\n    let cWidth = 0\r\n    let cHeight = 0\r\n    let xUpdated = 0\r\n    let yUpdated = 0\r\n\r\n    let xDiff = 0\r\n    let yDiff = 0\r\n    let wDiff = 0\r\n    let hDiff = 0\r\n    //let found = false\r\n\r\n    let xPos = _x\r\n    let yPos = _y\r\n    \r\n    \r\n    /*let wDiff = 0;\r\n    let hDiff = 0;\r\n    let _XX = _x */\r\n\r\n    if(_x < 0) {\r\n      xUpdated = (_x + 190) * -1\r\n      \r\n    } else {\r\n      xUpdated = (_x - 190) * -1\r\n    }\r\n\r\n    if(_y < 0) {\r\n      yUpdated = _y - 30 //(_y + 50) * -1\r\n    } else {\r\n      yUpdated = _y - 35 //(_y - 50) * -1\r\n    }\r\n\r\n\r\n    _x = (_x + 30) * - 1\r\n    _y = (_y - 30)\r\n\r\n    let xD = (_x - 100)\r\n    let yD = (_y - 100)\r\n    \r\n    participants.local.setPhysics({inProximity: true})\r\n\r\n    \r\n\r\n    //console.log(contents.all)\r\n    for (let i=0; i<cLength; i++) {\r\n\r\n\r\n      \r\n      \r\n      //participants.local.savePhysicsToStorage(false)\r\n      \r\n\r\n      \r\n\r\n      wDiff = ((contents.all[i].pose.position[0] + contents.all[i].size[0]) + 100)\r\n      hDiff = ((contents.all[i].pose.position[1] + contents.all[i].size[1]) + 100)\r\n\r\n      xDiff = contents.all[i].pose.position[0] - 200\r\n      yDiff = contents.all[i].pose.position[1] - 200\r\n\r\n      //if(xUpdated >= xDiff && xUpdated < wDiff && yUpdated >= yDiff && yUpdated <= hDiff) {\r\n        //if(contents.all[i].proximity === true) {\r\n        \r\n        //if(xUpdated >= xDiff && xUpdated < wDiff && yUpdated >= yDiff && yUpdated <= hDiff) {\r\n\r\n        \r\n\r\n          cWidth = ((contents.all[i].pose.position[0] + contents.all[i].size[0]) - 50)\r\n          cHeight = ((contents.all[i].pose.position[1] + contents.all[i].size[1]) - 60)\r\n\r\n          let cPose = convertToAudioCoordinate(contents.all[i].pose)\r\n      \r\n          //console.log(_x, \" DISTANCE Content \", cPose.position[0])\r\n\r\n          //console.log(_x, \" -- \", cPose, \" -------- \", contents.all[i].pose)\r\n\r\n\r\n          // , \" -- y user\", (yPos + 475), \" -- y content \", cPose.position[2]\r\n          //console.log((xPos + 30) * -1, \" <- x user : x content -> \", cPose.position[0])\r\n          //console.log((yPos - 30), \" <- y user : y content -> \", (cPose.position[2] * -1))\r\n\r\n          let diffX = ((xPos + 30) * - 1)\r\n          let diffY = (yPos - 30)\r\n          let xContent = cPose.position[0]\r\n          let yContent = (cPose.position[2] * -1)\r\n\r\n          let xContentProx = cPose.position[0] - 100\r\n          let yContentProx = ((cPose.position[2] * -1)) - 150\r\n\r\n          let  cW1 = ((cPose.position[0] + contents.all[i].size[0])) - 60\r\n          let  cH1 = (((cPose.position[2] * -1) + contents.all[i].size[1])) - 60\r\n\r\n          let  cWProx = (((cPose.position[0] + contents.all[i].size[0])) - 60) + 100\r\n          let  cHProx = ((((cPose.position[2] * -1) + contents.all[i].size[1])) - 60) + 100\r\n\r\n          //console.log(diffY, \" -- \", cH1)\r\n          \r\n\r\n          let  cW = ((cPose.position[0] + contents.all[i].size[0]) - 60)\r\n          let  cH = (((cPose.position[2] * -1) + contents.all[i].size[1]) - 60)\r\n\r\n            //if((diffX >= xContent && diffX <= cW1) && (diffY >= yContent && diffY <= cH1)) {\r\n            if((diffX >= (xContent-100) && diffX <= (cW1+100)) && (diffY >= (yContent-100) && diffY <= (cH1+100))) {\r\n              if((diffX >= xContent && diffX <= cW1) && (diffY >= yContent && diffY <= cH1)) {\r\n                if(contents.all[i].proximity === true) {\r\n                  //console.log(\"inside image\")\r\n                  _status = 1\r\n                  break\r\n                }\r\n              } else {\r\n                if(contents.all[i].proximity === true) {\r\n                  //console.log(\"inside image proxy area\")\r\n                  _status = 2\r\n                  break\r\n                }\r\n              }\r\n            } \r\n            /* else if((diffX >= xContentProx && diffX <= xContent) || (diffY >= yContentProx && diffY <= yContent) || (diffX >= cW1 && diffX <= cWProx) || (diffY >= cH1 && diffY <= cHProx)) {\r\n              if(contents.all[i].proximity === true) {\r\n                if(((diffX - xContent) <= 100) && ((diffY - yContent) <= 100) && ((diffX - cW1) <= 100) && ((diffY - cH1) <= 100)) {\r\n                  //console.log(\"in proxy area\")\r\n                  _status = 2\r\n                }\r\n              }\r\n            } */\r\n\r\n          let wD = (cW + 100)\r\n          let hD = (cH + 100)\r\n\r\n          //if(_x >= xD && _x < wD && _y >= yD && _y <= hD) {\r\n\r\n          //console.log(_x, \" : User X -- Content X : \", cPose.position[0], \" W : \", cWidth, \" ::: \", _y, \" : User Y --- Content Y : \", cPose.position[2], \" H : \", cHeight)\r\n\r\n          //console.log(_x, \" : User X -- Content X : \", cPose.position[0], \" W: \", cW, \" ::: \", _y, \" : User Y --- Content Y : \", (cPose.position[2] * - 1), \" H : \", cH)\r\n\r\n          //console.log(_x , \" x Diff \", xD, \" ::: \", _y, \" y diff \", yD, \" :::: W diff \", wD, \" :::: H diff \", hD)\r\n          \r\n           /*  if((_x >= cPose.position[0] && _x <= cW) && (_y >= (cPose.position[2]* - 1) && _y <= cH)) {\r\n              if(contents.all[i].proximity === true) {\r\n                //console.log(\" sound zone : \", i)\r\n                _status = 1\r\n                break\r\n              }\r\n            } else {\r\n              //if((_x >= (cPose.position[0]-100) && _x <= (cPose.position[0])) || (_x >= (cW) && _x <= (cW-100)) || (_y >= ((cPose.position[2]* - 1) - 100) && _y <= (cPose.position[2]* - 1)) || (_y >= (cH) && _y <= (cH+100))){ \r\n              if(((_x >= (cPose.position[0]-100) && _x <= (cPose.position[0])) || (_x >= (cW) && _x <= (cW-100))) || ((_y >= ((cPose.position[2]* - 1) - 100) && _y <= (cPose.position[2]* - 1)) || (_y >= (cH) && _y <= (cH+100)))){ \r\n                if(contents.all[i].proximity === true) {\r\n                  //console.log(\" no sound zone \")\r\n                  _status = 2\r\n                }\r\n              } \r\n            } */\r\n\r\n          //}\r\n\r\n          //console.log(xUpdated, \" --- \", contents.all[i].pose.position[0], \" w : \", cWidth)\r\n\r\n\r\n          //console.log(yUpdated, \" --- \", contents.all[i].pose.position[1], \" x \", xUpdated, \" -- \", contents.all[i].pose.position[0], \" w : \", cWidth, \" h : \", cHeight)\r\n\r\n          /* if((xUpdated >= contents.all[i].pose.position[0] && xUpdated <= cWidth) && (yUpdated >= contents.all[i].pose.position[1] && yUpdated <= cHeight)) {\r\n            if(contents.all[i].proximity === true) {\r\n              //console.log(\"enter image : \", i)\r\n              _status = 1\r\n            }\r\n          } else {\r\n            if(contents.all[i].proximity === true) {\r\n              _status = 2\r\n            } else {\r\n              _status = 0\r\n            }\r\n          }  */\r\n        //}\r\n      \r\n      /* if(xUpdated >= xDiff && xUpdated < wDiff && yUpdated >= yDiff && yUpdated <= hDiff) {\r\n        found = true\r\n        if(contents.all[i].proximity === true) {\r\n        _status = 2\r\n        } else {\r\n          _status = 0\r\n        }\r\n      } else {\r\n        if(found === false) {\r\n        _status = 0\r\n        }\r\n      } */\r\n\r\n\r\n\r\n      \r\n      /* \r\n      if(contents.all[i].proximity === true) {\r\n      //yDiff = contents.all[i].pose.position[1] - _y\r\n      //wDiff = contents.all[i].size[0] - _x\r\n      //hDiff = contents.all[i].size[1] - _y\r\n      cWidth = ((contents.all[i].pose.position[0] + contents.all[i].size[0]) - 50)\r\n      cHeight = ((contents.all[i].pose.position[1] + contents.all[i].size[1]) - 60)\r\n\r\n      wDiff = ((contents.all[i].pose.position[0] + contents.all[i].size[0]) + 100)\r\n      hDiff = ((contents.all[i].pose.position[1] + contents.all[i].size[1]) + 100)\r\n\r\n      //xUpdated = (_x + 110) * -1\r\n      //yUpdated = (_y - 480)\r\n\r\n      \r\n      //console.log(_x, \" --- \", contents.all[i].pose.position[0])\r\n\r\n      if(_x < 0) {\r\n        xUpdated = (_x + 30) * -1\r\n      } else {\r\n        xUpdated = (_x + 30) * -1\r\n      }\r\n\r\n      if(_y < 0) {\r\n        //console.log(\"neg y\")\r\n        yUpdated = _y - 30 //(_y + 50) * -1\r\n      } else {\r\n        //console.log(\"pos y\")\r\n        yUpdated = _y - 35 //(_y - 50) * -1\r\n      }\r\n\r\n      \r\n        xDiff = contents.all[i].pose.position[0] - 100\r\n        yDiff = contents.all[i].pose.position[1] - 100\r\n      \r\n\r\n\r\n      //console.log(yUpdated, \" --- \", contents.all[i].pose.position[1], \" x \", xUpdated, \" -- \", contents.all[i].pose.position[0])\r\n      \r\n        found = true\r\n        if((xUpdated >= contents.all[i].pose.position[0] && xUpdated <= cWidth) && (yUpdated >= contents.all[i].pose.position[1] && yUpdated <= cHeight)) {\r\n          //console.log(\" HIT AREA \")\r\n          _status = 1\r\n        } else if(xUpdated >= xDiff && xUpdated < wDiff && yUpdated >= yDiff && yUpdated <= hDiff) {\r\n          _status = 2\r\n        } else {\r\n          _status = 0\r\n        }\r\n    } else {\r\n        if(found === false) {\r\n          _status = 0\r\n        }\r\n    } */\r\n\r\n      //console.log(xUpdated, \" >= \", contents.all[i].pose.position[0], \" || AND \", yUpdated, \" >= \", contents.all[i].pose.position[1], \"- size\", contents.all[i].size[0], \" w \", cWidth, \" -size h \", contents.all[i].size[1], \" h \", cHeight, \" proxi \", contents.all[i].proximity)\r\n      /*if((_x >= contents.all[i].pose.position[0] && _x <= cWidth) && (_y >= contents.all[i].pose.position[1] && _y <= cHeight) && contents.all[i].proximity === true) {\r\n        _status = 1\r\n      } else {\r\n        if(contents.all[i].proximity === true) {\r\n        _status = 2\r\n        } else {\r\n          _status = 0\r\n        }\r\n      }*/\r\n    }\r\n    return _status\r\n  }\r\n  private updateVolumeWithAssets(participant_pose:Pose3DAudio) {\r\n    let volume = 0\r\n    let touchStatus = 0\r\n    let xParticipant = 0;\r\n    let yParticipant = 0;\r\n    // checking content pos\r\n    //this.localParticipant.myContents.forEach((c) => {\r\n       // (c.pose, t.pose)\r\n    //}\r\n    if (this.playMode === 'Element') {\r\n      xParticipant = ((participant_pose.position[0]));\r\n      yParticipant = ((participant_pose.position[2]))\r\n      touchStatus = this.getContentsStatus(xParticipant, yParticipant)\r\n      \r\n      //console.log(touchStatus, \" touch \")\r\n      \r\n      if(touchStatus === 1) {\r\n        this.distance = 90\r\n      } else if(touchStatus === 2) {\r\n        this.distance = 150\r\n      }\r\n        volume = Math.pow(Math.max(this.distance, this.pannerNode.refDistance) / this.pannerNode.refDistance,\r\n                          - this.pannerNode.rolloffFactor)\r\n    }\r\n    if (this.audioElement) {\r\n      //console.log (volume, \" NodeG volume \")\r\n      this.audioElement.volume = volume\r\n    }\r\n  }\r\n  private updateVolume() {\r\n    let volume = 0\r\n    if (this.playMode === 'Element') {\r\n      volume = Math.pow(Math.max(this.distance, this.pannerNode.refDistance) / this.pannerNode.refDistance,\r\n                        - this.pannerNode.rolloffFactor)\r\n    }\r\n    if (this.audioElement) {\r\n      this.audioElement.volume = volume\r\n    }\r\n  }\r\n\r\n  private _defaultPannerRefDistance = PARTICIPANT_SIZE\r\n  private get defaultPannerRefDistance () { return this._defaultPannerRefDistance }\r\n  private set defaultPannerRefDistance(val: number) {\r\n    this._defaultPannerRefDistance = val\r\n    if (this.pannerNode.refDistance !== BROADCAST_DISTANCE) { // not in broadcast mode\r\n      this.pannerNode.refDistance = this._defaultPannerRefDistance\r\n    }\r\n  }\r\n  updateBroadcast(broadcast: boolean) {\r\n    if (!broadcast) {\r\n      this.pannerNode.refDistance = this.defaultPannerRefDistance\r\n    } else {\r\n      this.pannerNode.refDistance = BROADCAST_DISTANCE\r\n    }\r\n  }\r\n\r\n  updatePannerConfig(config: ConfigurableParams) {\r\n    const observedPannerKeys: ConfigurableProp[] =\r\n      ['coneInnerAngle', 'coneOuterAngle', 'coneOuterGain', 'distanceModel', 'maxDistance', 'distanceModel', 'panningModel', 'refDistance', 'rolloffFactor']\r\n    observedPannerKeys.forEach((key) => {\r\n      if (key === 'refDistance') {\r\n        this.defaultPannerRefDistance = config['refDistance']\r\n      } else {\r\n        (this.pannerNode[key] as any) = config[key]\r\n      }\r\n    })\r\n  }\r\n\r\n  private audibility = false\r\n  updateAudibility(audibility: boolean) {\r\n    if (audibility) {\r\n      this.gainNode.connect(this.pannerNode)\r\n    } else {\r\n      this.gainNode.disconnect()\r\n    }\r\n\r\n    if (this.audioElement) {\r\n      this.audioElement.muted = !audibility\r\n    }\r\n\r\n    this.audibility = audibility\r\n  }\r\n\r\n  disconnect() {\r\n    if (this.sourceNode) {\r\n      this.sourceNode.disconnect()\r\n    }\r\n\r\n    this.gainNode.disconnect()\r\n    this.pannerNode.disconnect()\r\n    if (this.audioElement) {\r\n      this.audioElement.volume = 0\r\n      this.audioElement.pause()\r\n      this.audioElement.remove()\r\n    }\r\n  }\r\n\r\n  get isBroadcast(): boolean {\r\n    return this.pannerNode.refDistance === BROADCAST_DISTANCE\r\n  }\r\n\r\n  private createGainNode(context: AudioContext) {\r\n    const gain = context.createGain()\r\n\r\n    gain.gain.value = 1\r\n\r\n    return gain\r\n  }\r\n\r\n  private createPannerNode(context: AudioContext) {\r\n    const panner = context.createPanner()\r\n\r\n    \r\n\r\n    return panner\r\n  }\r\n\r\n  private updateSourceStream(stream: MediaStream | undefined) {\r\n    if (this.sourceNode) {\r\n      this.sourceNode.disconnect()\r\n    }\r\n\r\n    if (stream === undefined) {\r\n      this.sourceNode = undefined\r\n\r\n      return\r\n    }\r\n\r\n    this.sourceNode = this.context.createMediaStreamSource(stream)\r\n\r\n    //  Anyway, soruce must be connected audioElement, for the case of Element mode.\r\n    //    if (isChrome) { // NOTE Chorme would not work if not connect stream to audio tag\r\n    if (this.audioElement === undefined) {\r\n      this.audioElement = this.createAudioElement()\r\n    }\r\n\r\n    this.audioElement.srcObject = stream\r\n    //    }\r\n  }\r\n\r\n  createAudioElement() {\r\n    const audio = new Audio()\r\n    setAudioOutputDevice(audio, this.audioDeviceId)\r\n\r\n    return audio\r\n  }\r\n}\r\n","import {BROADCAST_DISTANCE} from '@models/audio/NodeGroup'\r\nimport {ConfigurableParams} from '@models/audio/StereoParameters'\r\nimport {PARTICIPANT_SIZE} from '@models/Participant'\r\nimport participants from '@stores/participants/Participants'\r\nimport {action, autorun, computed, makeObservable, observable} from 'mobx'\r\n\r\nconst PERCENT = 100\r\nconst REFDISTANCE_MAX = 12 * PARTICIPANT_SIZE  // max of no attenuation range\r\n\r\n// Doc of panner node parameters: https://developer.mozilla.org/en-US/docs/Web/API/PannerNode\r\nexport class StereoParameters implements ConfigurableParams {\r\n  @observable coneInnerAngle = 0\r\n  @observable coneOuterAngle = 180\r\n  @observable coneOuterGain = 1\r\n  @observable maxDistance = 10000\r\n  @observable panningModel: PanningModelType = 'HRTF'\r\n  @observable distanceModel: DistanceModelType = 'exponential'\r\n  @observable refDistance = PARTICIPANT_SIZE * 1.5\r\n  @observable rolloffFactor = 38 // 36\r\n  refDistanceNormal:number = this.refDistance\r\n\r\n  constructor(){\r\n    makeObservable(this)\r\n  }\r\n\r\n  //  0 to 100, 0 has strongest attenuation\r\n  @computed\r\n  get hearableRange() {\r\n    return this.refDistance * PERCENT / REFDISTANCE_MAX\r\n  }\r\n\r\n  @action\r\n  setHearableRange(range:number) {\r\n    this.refDistanceNormal = range / PERCENT * REFDISTANCE_MAX\r\n    const onStage = participants.local.physics.onStage\r\n    this.setBroadcast(onStage)\r\n  }\r\n\r\n  // make all participants hearable\r\n  @action\r\n  setBroadcast(bcast:boolean) {\r\n    this.refDistance = bcast ? BROADCAST_DISTANCE - 1 : this.refDistanceNormal\r\n    //  console.log(`setBroadcast is called bcast=${bcast}  distance=${this.refDistanceNormal}`)\r\n  }\r\n\r\n  @action\r\n  updateParameters(params: Partial<ConfigurableParams>) {\r\n    Object.assign(this, params)\r\n  }\r\n}\r\n\r\nconst stereoParameters = new StereoParameters()\r\nexport default stereoParameters\r\n\r\nautorun(() => {\r\n  const bcast = participants.local.physics.onStage\r\n  stereoParameters.setBroadcast(bcast)\r\n})\r\n\r\nexport function calcVolume(dist: number){\r\n  const mul = ((dist * dist) / (stereoParameters.refDistance * stereoParameters.refDistance)\r\n  + stereoParameters.refDistance - 1) / (dist ? dist : 1)\r\n  const distance = mul * dist\r\n  const volume = Math.pow(Math.max(distance, stereoParameters.refDistance) / stereoParameters.refDistance,\r\n  - stereoParameters.rolloffFactor)\r\n\r\n  return volume\r\n}\r\n","import {makeStyles} from '@material-ui/core/styles'\r\nimport {PARTICIPANT_SIZE} from '@models/Participant'\r\nimport {assert, normV, shallowEqualsForMap, subV2} from '@models/utils'\r\nimport {calcVolume} from '@stores/AudioParameters/StereoParameters'\r\nimport {contentLog} from '@stores/sharedContents/SharedContents'\r\nimport {useObserver} from 'mobx-react-lite'\r\nimport React, {useEffect, useRef} from 'react'\r\nimport YouTubePlayer from 'yt-player'\r\nimport {ContentProps} from './Content'\r\n\r\nconst PLAYTIME_TOLERANCE = 0.1\r\n//const contentLog = console.log\r\nconst CHECK_INTERVAL = 333\r\nconst VOLUME_INTERVAL = 200\r\n\r\nfunction getCurrentTimestamp() {\r\n\r\n  return Date.now() * 0.001\r\n}\r\n\r\nconst useStyles = makeStyles({\r\n  iframe: {\r\n    width: '100%',\r\n    height: '100%',\r\n  },\r\n})\r\ntype YTState = 'paused' | 'playing' | 'ended'\r\ntype YTParam = YTState | 'rate' | 'index' | 'list' | 'v'\r\n\r\nclass YTMember{\r\n  player?:YouTubePlayer\r\n  goal: YTState|'' = ''\r\n  skipOnPlaying = 0\r\n  pauseIntervalTimer = 0\r\n  lastCurrentTimePaused = 0\r\n  playTimeout = 0\r\n  pauseTimeout = 0\r\n  params: Map<YTParam, string|undefined> = new Map()\r\n  editing = false\r\n  prevRelPos:[number, number] = [0, 0]\r\n  volumeUI = 0.5          //  volume set by user\r\n  volumeDist = 0          //  volume by distance\r\n  prevVolumeDist = 0      //  previous volume by distance\r\n  volumeIntervalTimer = 0 //  interval timer to check and update volume\r\n  props!: ContentProps\r\n}\r\n\r\nexport function paramArray2map(paramArray: string[]):Map<YTParam, string|undefined> {\r\n  return new Map<YTParam, string|undefined>(\r\n    paramArray.map(param => param.split('=') as [YTParam, string]))\r\n}\r\nexport function paramStr2map(paramStr: string):Map<YTParam, string|undefined> {\r\n  const paramArray = paramStr.split('&')\r\n\r\n  return paramArray2map(paramArray)\r\n}\r\nexport function paramMap2Str(params:Map<string, string|undefined>) {\r\n  let str = ''\r\n  let sep = ''\r\n  for (const param of params) {\r\n    str += `${sep}${param[0]}=${param[1]}`\r\n    sep = '&'\r\n  }\r\n\r\n  return str\r\n}\r\nfunction clearAllTimer(member: YTMember){\r\n  if (member.playTimeout){\r\n    clearTimeout(member.playTimeout)\r\n    member.playTimeout = 0\r\n  }\r\n  if (member.pauseTimeout){\r\n    clearTimeout(member.pauseTimeout)\r\n    member.pauseTimeout = 0\r\n  }\r\n}\r\n\r\nfunction ytSeekAndPlay(start:number, index: number, member: YTMember) {\r\n  assert(member.player)\r\n  member.goal = 'playing'\r\n  clearAllTimer(member)\r\n  const now = getCurrentTimestamp()\r\n  let seekTo = (now - start) * member.player.getPlaybackRate()\r\n  if (member.player.getState() === 'playing' &&\r\n    (member.player.getPlaylist().length === 0 || member.player.getPlaylistIndex() === index) &&\r\n    Math.abs(member.player.getCurrentTime() - seekTo) < PLAYTIME_TOLERANCE) {\r\n\r\n    return  //  already playing and position is good.\r\n  }\r\n\r\n  //  seek and play\r\n  let seekTarget = -1000\r\n  const onTime:TimerHandler = () => {\r\n    if (!member.player) { return }\r\n    const cur = member.player.getCurrentTime()\r\n    //  In case we can start to play now\r\n    if (member.player.getState() === 'paused' && Math.abs(seekTarget - cur) < PLAYTIME_TOLERANCE){\r\n      member.player.play()\r\n      contentLog(`ytSeekAndPlay: ${member.player.getState()}  ` +\r\n      `cur:${member.player.getCurrentTime()}  toSeek:${seekTo}`, member.params)\r\n\r\n      return\r\n    }\r\n\r\n    //  Otherwise, seek, pause and wait again.\r\n    const now = getCurrentTimestamp()\r\n    seekTo = (now - start) * member.player.getPlaybackRate()\r\n    const TIMETOSEEK = 1\r\n    seekTarget = seekTo + TIMETOSEEK * member.player.getPlaybackRate()\r\n    let duration = member.player.getDuration()\r\n    if (member.player.getState() === 'unstarted' || !duration){\r\n      member.skipOnPlaying = 1\r\n      member.player.play()\r\n      duration = member.player.getDuration()\r\n    }\r\n    if (index >= 0 && index !== member.player.getPlaylistIndex()) {\r\n      member.skipOnPlaying = 1\r\n      member.player.playVideoAt(index)\r\n      duration = member.player.getDuration()\r\n    }\r\n    if (duration){\r\n      member.player.pause()\r\n      if (seekTarget > duration) {\r\n        seekTarget = seekTarget % duration\r\n        start = now + TIMETOSEEK - seekTarget / member.player.getPlaybackRate()\r\n      }\r\n      member.player.seek(seekTarget)\r\n    }\r\n    member.playTimeout = setTimeout(onTime, TIMETOSEEK * 1000)\r\n  }\r\n  onTime()\r\n}\r\nfunction ytSeekAndPause(time:number, member: YTMember) {\r\n  assert(member.player)\r\n  member.goal = 'paused'\r\n  clearAllTimer(member)\r\n  const pauseCheck:TimerHandler = () => {\r\n    if (!member.player) { return }\r\n    const indexStr = member.params.get('index')\r\n    const index = Number(indexStr ? indexStr : -1)\r\n    //  make it paused state.\r\n    if (member.player.getState() !== 'paused' ||\r\n      (index >= 0 && index !== member.player.getPlaylistIndex())) {\r\n      if (member.player.getState() === 'unstarted') { member.player.play() }\r\n      if (index >= 0 && index !== member.player.getPlaylistIndex()) {\r\n        member.player.playVideoAt(index)\r\n      }\r\n      member.player.pause()\r\n      member.pauseTimeout = setTimeout(pauseCheck, CHECK_INTERVAL)\r\n\r\n      return\r\n    }\r\n    //  Check if the seek time achieves goal\r\n    if (member.player.getCurrentTime() !== time) {\r\n      member.player.seek(time)\r\n      contentLog(`ytSeekAndPause seek to ${time}`, member.params)\r\n    }\r\n    member.lastCurrentTimePaused = member.player.getCurrentTime()\r\n  }\r\n  pauseCheck()\r\n}\r\nfunction deleteState(params: Map<string, string|undefined>){\r\n  params.delete('playing')\r\n  params.delete('paused')\r\n  params.delete('ended')\r\n}\r\n\r\nfunction ytUpdateState(newState: YTState, time:number, member: YTMember) {\r\n  deleteState(member.params)\r\n  member.params.set(newState, String(time))\r\n  member.params.set('rate', String(member.player?.getPlaybackRate()))\r\n  const idx = member.player?.getPlaylistIndex()\r\n  member.params.set('index', String(idx ? idx : -1))\r\n  member.props.content.url = paramMap2Str(member.params)\r\n  member.props.updateAndSend(member.props.content)\r\n  contentLog(`YT SEND state ${newState} t=${time}`, member.params)\r\n}\r\n\r\nfunction ytPauseInterval(member: YTMember) {  //  Seeked by user duruing paused.\r\n  if (!member.player) { return }\r\n  const state = member.player.getState()\r\n  if (!member.editing && member.goal==='' && state === 'paused') {\r\n    //  when local and remote state is paused (already sent paused).\r\n    const currentTime = member.player.getCurrentTime()\r\n    contentLog(`YT ytPauseInterval cur:${currentTime}, last:${member.lastCurrentTimePaused} param${member.params.get('paused')}`)\r\n    if (Math.abs(currentTime - member.lastCurrentTimePaused) > PLAYTIME_TOLERANCE) {\r\n      member.lastCurrentTimePaused = currentTime\r\n      const paramTime = Number(member.params.get('paused'))\r\n      if (currentTime !== paramTime){\r\n        ytUpdateState('paused', currentTime, member)\r\n      }\r\n    }\r\n  }else {\r\n    if (member.pauseIntervalTimer) {\r\n      clearInterval(member.pauseIntervalTimer)\r\n      member.pauseIntervalTimer = 0\r\n    }\r\n  }\r\n\r\n  return undefined\r\n}\r\n\r\nfunction updateUIVolume(member:YTMember){\r\n  if (!member.player){ return }\r\n  if (member.volumeDist === 1 && member.prevVolumeDist === 1){\r\n    const curVolume = member.player.getVolume() / 100\r\n    if (curVolume !== member.volumeUI){\r\n      member.volumeUI = curVolume\r\n      //  console.log(`volumeUI Changed:${member.volumeUI} cur:${curVolume}`)\r\n    }\r\n  }else{\r\n    member.player.setVolume(member.volumeUI * member.volumeDist * 100)\r\n  }\r\n  member.prevVolumeDist = member.volumeDist\r\n}\r\nfunction updateVolume(distance:number, member: YTMember){\r\n  if (member.player){\r\n    member.volumeDist = calcVolume(distance)\r\n    member.player.setVolume(member.volumeUI * member.volumeDist * 100)\r\n    //  console.log(`updateVolume(${distance}) UI:${member.volumeUI} D:${member.volumeDist}`)\r\n  }\r\n}\r\nfunction checkPositionsForVolume(member:YTMember){\r\n  if (!member.props.participants) { return }\r\n  updateUIVolume(member)\r\n  const relPos = subV2(member.props.content.pose.position, member.props.participants.local.pose.position)\r\n  const diff = subV2(relPos, member.prevRelPos)\r\n  if (normV(diff) > PARTICIPANT_SIZE * 0.1){\r\n    member.prevRelPos = [relPos[0], relPos[1]]\r\n    for(let i=0; i<2; i++){\r\n      if (relPos[i] < 0){\r\n        relPos[i] += member.props.content.size[i]\r\n        if (relPos[i] > 0) { relPos[i] = 0 }\r\n      }\r\n    }\r\n    const dist = normV(relPos)\r\n    updateVolume(dist, member)\r\n  }\r\n}\r\n\r\n\r\n/* Memo about youtube state\r\n *  played=time time=start time stamp  in ms\r\n *  paused=time time=current time in the clip.\r\n*/\r\n\r\nexport const YouTube: React.FC<ContentProps> = (props:ContentProps) => {\r\n  assert(props.content.type === 'youtube')\r\n  const classes = useStyles()\r\n  const memberRef = useRef<YTMember>(new YTMember())\r\n  const member = memberRef.current\r\n  member.props = props\r\n\r\n  //  Editing (No sync) ?\r\n  const editing = useObserver(() => props.contents.editing === props.content.id)\r\n\r\n  //  Check params and reflect them to ytPlayer\r\n  const oldParams = member.params\r\n  member.params = paramStr2map(props.content.url)\r\n  if (!editing && (member.editing || !shallowEqualsForMap(member.params, oldParams))) {\r\n    if (member.player) {\r\n      if (member.params.get('rate') !== oldParams.get('rate')){ //  set playback rate\r\n        member.player.setPlaybackRate(Number(member.params.get('rate')))\r\n      }\r\n      //  set state\r\n      const newPlaying = member.params.get('playing')\r\n      const moveToPlay = newPlaying!==undefined && newPlaying !== oldParams.get('playing')\r\n      const newPaused = member.params.get('paused')\r\n      const moveToPause = newPaused!==undefined && newPaused !== oldParams.get('paused')\r\n      if (moveToPlay) {\r\n        contentLog(`YT render move to play=${newPlaying} state`)\r\n        ytSeekAndPlay(Number(member.params.get('playing')), Number(member.params.get('index')), member)\r\n      }else if (moveToPause) {\r\n        contentLog(`YT render move to pause=${newPaused} state`)\r\n        ytSeekAndPause(Number(member.params.get('paused')), member)\r\n      }\r\n    }\r\n  }\r\n  member.editing = editing\r\n\r\n  //  Create player when the component is created.\r\n  useEffect(\r\n    () => {\r\n      assert(props.content.id)\r\n      let selfPlayed = false\r\n      if (!member.player) {\r\n        const id = `#YT${props.content.id}`\r\n        const player = new YouTubePlayer(id)\r\n        if (!member.params.has('playing') && !member.params.has('paused') && !member.params.has('ended')){\r\n          //member.skipOnPlaying = 1\r\n          selfPlayed = true\r\n          member.params.set('playing', String(-1))\r\n          player.play()\r\n        }\r\n        member.player = player\r\n        contentLog(`YTPlayer for ${id} created`)\r\n        //  set initial parameters\r\n        if (member.params.has('rate')){\r\n          player.setPlaybackRate(Number(member.params.get('rate')))\r\n        }\r\n        if (!member.editing){\r\n          if (member.params.has('paused')) {\r\n            ytSeekAndPause(Number(member.params.get('paused')), member)\r\n          }else if (!selfPlayed && member.params.has('playing')){\r\n            ytSeekAndPlay(Number(member.params.get('playing')), Number(member.params.get('index')), member)\r\n          }\r\n        }\r\n\r\n        ///*\r\n        player.on('error', (err:any) => contentLog('YT on error ', err))\r\n        player.on('buffering', () => contentLog('YT on buffering'))\r\n        player.on('cued', () => contentLog('YT on cued'))     //  */\r\n\r\n        player.on('unstarted', () => {\r\n          contentLog('YT on unstarted')\r\n          player.unMute()\r\n        })\r\n        player.on('ended', () => {\r\n          contentLog('YT on ended')\r\n          if (member.player){\r\n            const now = getCurrentTimestamp()\r\n            ytSeekAndPlay(now, 0, member)\r\n          }\r\n          //ytUpdateState('ended', 0, member)\r\n        })\r\n        player.on('paused', () => {\r\n          contentLog(`YT on paused at ${player.getCurrentTime()} goal:${member.goal}`, member.params)\r\n          if (member.goal === 'paused') { //  paused by remote\r\n            member.goal = ''\r\n          }else if(member.goal === ''){   //  paused by user's operation\r\n            if (!member.params.has('paused')) {\r\n              setTimeout(()=>{\r\n                if (!member.params.has('paused') && !member.params.has('playing') && player.getState() === 'paused'){\r\n                  ytUpdateState('paused', player.getCurrentTime(), member)\r\n                }\r\n              }, 1000)\r\n            }\r\n          }else{\r\n            contentLog(`paused for goal ${member.goal}`)\r\n          }\r\n          //  Add interval timer to check seek when paused is acheived.\r\n          if (member.goal === '' && !member.pauseIntervalTimer) {\r\n            member.pauseIntervalTimer\r\n              = setInterval(ytPauseInterval, CHECK_INTERVAL, member)\r\n          }\r\n        })\r\n        player.on('playing', () => {\r\n          contentLog(`YT on playing goal=${member.goal} skip=${member.skipOnPlaying}`, member.params)\r\n          let indexUpdated = false\r\n          if (player.getPlaylist().length > 0) {\r\n            if (player.getPlaylistIndex() !== Number(member.params.get('index'))) {\r\n              member.params.set('index', String(player.getPlaylistIndex()))\r\n              indexUpdated = true\r\n            }\r\n          }\r\n          if (member.goal === 'playing'){ //  play by remote\r\n            if (member.skipOnPlaying){\r\n              member.skipOnPlaying = 0\r\n            }else{\r\n              member.goal = ''\r\n            }\r\n          }else if (member.goal === ''){\r\n            const now = getCurrentTimestamp()\r\n            const elasp = player.getCurrentTime() / player.getPlaybackRate()\r\n            const start = now - elasp\r\n            let started = Number(member.params.get('playing'))\r\n            if (started === -1){ started = start }\r\n            const diff = start - started\r\n            if (!member.params.has('playing') || indexUpdated || Math.abs(diff) > PLAYTIME_TOLERANCE) {\r\n              //  play by user or index in play list changed or seeked.\r\n              ytUpdateState('playing', start, member)\r\n            }\r\n          }\r\n        })\r\n        player.on('playbackRateChange', () => {\r\n          contentLog(`YT on playbackRateChange`)\r\n          const now = getCurrentTimestamp()\r\n          const elasp = player.getCurrentTime() / player.getPlaybackRate()\r\n          const start = now - elasp\r\n          const state = player.getState()\r\n          const ytState:YTState = state === 'paused' ? 'paused' : state === 'playing' ? 'playing' : 'ended'\r\n          ytUpdateState(ytState, start, member)\r\n        })\r\n      }\r\n\r\n      //  set video clip id\r\n      const player = member.player\r\n      if (player) {\r\n        if (member.params.has('list')) {\r\n          player.loadList({\r\n            listType:'playlist',\r\n            list:member.params.get('list') as string,\r\n          })\r\n          contentLog(`YT loadList: ${member.params.get('list')}`)\r\n        }else if (member.params.has('v')) {\r\n          player.load(member.params.get('v') as string)\r\n          contentLog(`YT load: ${member.params.get('v')}`)\r\n        }\r\n      }\r\n\r\n      if (!member.volumeIntervalTimer){\r\n        member.volumeIntervalTimer = setInterval(checkPositionsForVolume, VOLUME_INTERVAL, member)\r\n      }\r\n\r\n      return () => {\r\n        if (member.player) {\r\n          member.player.destroy()\r\n        }\r\n        member.player = undefined\r\n        if (member.volumeIntervalTimer){\r\n          clearInterval(member.volumeIntervalTimer)\r\n        }\r\n      }\r\n    },\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n    [],\r\n  )\r\n\r\n  return <div id={`YT${props.content.id}`} className={classes.iframe} />\r\n}\r\n","import {Stores} from '@components/utils'\r\nimport whiteboard24Regular from '@iconify-icons/fluent/whiteboard-24-regular'\r\nimport filePdfBox from '@iconify/icons-mdi/file-pdf-box'\r\nimport GoogleDriveIcon from '@iconify/icons-mdi/google-drive'\r\nimport {Icon} from '@iconify/react'\r\nimport {makeStyles} from '@material-ui/core/styles'\r\nimport CameraAltIcon from '@material-ui/icons/CameraAlt'\r\nimport HttpIcon from '@material-ui/icons/Http'\r\nimport PhotoIcon from '@material-ui/icons/Photo'\r\nimport ScreenShareIcon from '@material-ui/icons/ScreenShare'\r\nimport SubjectIcon from '@material-ui/icons/Subject'\r\nimport YouTubeIcon from '@material-ui/icons/YouTube'\r\nimport {ContentType, ISharedContent} from '@models/ISharedContent'\r\nimport {t} from '@models/locales'\r\nimport {useObserver} from 'mobx-react-lite'\r\nimport React from 'react'\r\nimport {GDrive} from './GDrive'\r\nimport {PDF} from './PDF'\r\nimport {ScreenContent} from './ScreenContent'\r\nimport {Text} from './Text'\r\nimport {YouTube} from './YouTube'\r\n\r\nexport function contentTypeIcons(type: ContentType, size = 12, width = -1) {\r\n  if (width < 0) { width = size }\r\n  const icons = {\r\n    img: <PhotoIcon style={{fontSize:size, width}} />,\r\n    zoneimg: <PhotoIcon style={{fontSize:size, width}} />,\r\n    text:<SubjectIcon style={{fontSize:size, width}} />,\r\n    iframe: <HttpIcon style={{fontSize:size, width}} />,\r\n    youtube: <YouTubeIcon style={{fontSize:size, width}} />,\r\n    screen: <ScreenShareIcon style={{fontSize:size, width}} />,\r\n    gdrive: <span style={{width, height:size}}><Icon icon={GoogleDriveIcon} height={size} /></span>,\r\n    whiteboard: <span style={{width, height:size}}><Icon icon={whiteboard24Regular} height={size} /></span>,\r\n    camera: <CameraAltIcon style={{fontSize:size, width}} />,\r\n    pdf : <span style={{width, height:size}}><Icon icon={filePdfBox} height={size} /></span>,\r\n    '': undefined,\r\n  }\r\n\r\n  return icons[type]\r\n}\r\nexport function editButtonTip(editing: boolean, c?: ISharedContent){\r\n  const type = c ? c.type : ''\r\n  if (type === 'whiteboard'){\r\n    return editing ? t('ctEndEditWhiteboard') : t('ctEditWhiteboard')\r\n  }else if (type === 'gdrive'){\r\n    return editing ? t('ctEndEditGDrive') : t('ctEditGDrive')\r\n  }else if (type === 'youtube'){\r\n    return editing ? t('ctEndEditYoutube') : t('ctEditYoutube')\r\n  }else if (type === 'iframe'){\r\n    return editing ? t('ctEndEditIframe') : t('ctEditIframe')\r\n  }else if (type === 'text'){\r\n    return editing ? t('ctEndEditText') : t('ctEditText')\r\n  }\r\n\r\n  return ''\r\n}\r\n\r\n\r\nconst useStyles = makeStyles({\r\n  img: {\r\n    width: '100%',\r\n    height: '100%',\r\n    verticalAlign: 'bottom',\r\n    userDrag: 'none',\r\n    pointerEvents: 'none',\r\n  },\r\n  iframe: {\r\n    width: '100%',\r\n    height: '100%',\r\n    pointerEvents: 'none',\r\n    border: 'none',\r\n  },\r\n  iframeEdit: {\r\n    width: '100%',\r\n    height: '100%',\r\n    border: 'none',\r\n  },\r\n  div:{\r\n    width: '100%',\r\n    height: '100%',\r\n  },\r\n})\r\nexport interface ContentProps extends Stores{\r\n  content:ISharedContent\r\n  updateAndSend: (c: ISharedContent) => void\r\n  updateOnly: (c:ISharedContent) => void\r\n}\r\nexport const RawContent: React.FC<ContentProps> = (props:ContentProps) => {\r\n  const classes = useStyles()\r\n  const editing = useObserver(() => props.contents.editing === props.content.id)\r\n\r\n  let rv\r\n  if (props.content.type === 'img') {\r\n    rv = <img className={classes.img} src={props.content.url} alt={props.content.name}/>\r\n  }else if (props.content.type === 'iframe' || props.content.type === 'whiteboard') {\r\n    rv = <div className={classes.div}>\r\n      <iframe className={editing ? classes.iframeEdit : classes.iframe}\r\n        style={props.content.type==='whiteboard'?{backgroundColor:'white'}:{}}\r\n        src={props.content.url} key={props.content.name} title={props.content.name}/>\r\n      </div>\r\n  }else if (props.content.type === 'youtube') {\r\n    rv = <YouTube {...props} />\r\n  }else if (props.content.type === 'gdrive') {\r\n    rv = <GDrive {...props} />\r\n  }else if (props.content.type === 'pdf') {\r\n    rv = <PDF {...props} />\r\n  }else if (props.content.type === 'text') {\r\n    rv = <Text {...props} />\r\n  }else if (props.content.type === 'screen' || props.content.type === 'camera') {\r\n    rv = <ScreenContent {...props} />\r\n  }else {\r\n    rv = <div>Unknown type:{props.content.type} for {props.content.url}</div>\r\n  }\r\n\r\n  return rv\r\n}\r\n\r\nexport const Content = (props: ContentProps) =>\r\n  React.useMemo(() => <RawContent {...props} />,\r\n  //  eslint-disable-next-line react-hooks/exhaustive-deps\r\n  [props.content.url, props.content.id, props.content.type, props.contents.editing === props.content.id,\r\n   props.content.pose, props.content.size, props.content.originalSize])\r\nContent.displayName = 'Content'\r\n","import imageLine from '@iconify-icons/clarity/image-line'\r\nimport imageOutlineBadged from '@iconify-icons/clarity/image-outline-badged'\r\nimport clipboardCopy from '@iconify-icons/heroicons-outline/clipboard-copy'\r\nimport biDashCircleDotted from '@iconify/icons-bi/dash-circle-dotted'\r\nimport biImage from '@iconify/icons-bi/image'\r\nimport biImageNoFrame from '@iconify/icons-bi/image-alt'\r\nimport biPlusCircleFill from '@iconify/icons-bi/plus-circle-fill'\r\nimport pinIcon from '@iconify/icons-mdi/pin'\r\nimport pinOffIcon from '@iconify/icons-mdi/pin-off'\r\nimport {Icon} from '@iconify/react'\r\nimport Box from '@material-ui/core/Box'\r\nimport Button from '@material-ui/core/Button'\r\nimport DialogContent from '@material-ui/core/DialogContent'\r\nimport Popover, { PopoverProps } from '@material-ui/core/Popover'\r\nimport Slider from '@material-ui/core/Slider'\r\nimport Switch from '@material-ui/core/Switch'\r\nimport Table from '@material-ui/core/Table'\r\nimport TableBody from '@material-ui/core/TableBody'\r\nimport TableCell from '@material-ui/core/TableCell'\r\nimport TableRow from '@material-ui/core/TableRow'\r\nimport TextField from '@material-ui/core/TextField'\r\nimport CloseRoundedIcon from '@material-ui/icons/CloseRounded'\r\nimport DoneIcon from '@material-ui/icons/Done'\r\nimport EditIcon from '@material-ui/icons/Edit'\r\nimport FlipToBackIcon from '@material-ui/icons/FlipToBack'\r\nimport FlipToFrontIcon from '@material-ui/icons/FlipToFront'\r\nimport {ISharedContent} from '@models/ISharedContent'\r\nimport {canContentBeAWallpaper, isContentEditable, isContentWallpaper} from '@models/ISharedContent'\r\nimport {t} from '@models/locales'\r\nimport {Pose2DMap} from '@models/utils'\r\nimport {copyContentToClipboard,  makeContentWallpaper,\r\n   moveContentToBottom, moveContentToTop} from '@stores/sharedContents/SharedContentCreator'\r\nimport {Observer} from 'mobx-react-lite'\r\nimport React, {Fragment} from 'react'\r\nimport {contentTypeIcons, editButtonTip} from './Content'\r\nimport {RndContentProps, TITLE_HEIGHT} from './RndContent'\r\n\r\ntype PopoverPropsNoOnClose = Omit<PopoverProps, 'onClose'>\r\nexport interface SharedContentFormProps extends Omit<RndContentProps, 'content'>, PopoverPropsNoOnClose{\r\n  close: () => void,\r\n  content?: ISharedContent\r\n  open: boolean\r\n}\r\n\r\ntype ContentType = JSX.Element | string\r\n\r\nfunction Row(left1: ContentType, left2: ContentType, center: ContentType,\r\n  right2: ContentType, right1: ContentType, key?: string|number){\r\n  const cellstyle = {\r\n    margin:0,\r\n    padding:2,\r\n    border:'none',\r\n  }\r\n\r\n  return <TableRow key={key}>\r\n    <TableCell align=\"right\" style={cellstyle}>{left1}</TableCell>\r\n    <TableCell align=\"right\" style={cellstyle}>{left2}</TableCell>\r\n    <TableCell align=\"center\" style={cellstyle}>{center}</TableCell>\r\n    <TableCell style={cellstyle}>{right2}</TableCell>\r\n    <TableCell style={cellstyle}>{right1}</TableCell>\r\n  </TableRow>\r\n}\r\n\r\nclass SharedContentFormMember{\r\n  zorder!: number\r\n  pinned!: boolean\r\n  editing!: string\r\n  name!: string\r\n  pose!: Pose2DMap\r\n  constructor(props: SharedContentFormProps){\r\n    this.save(props)\r\n  }\r\n  save(props: SharedContentFormProps){\r\n    if (!props.content) { return }\r\n    this.zorder = props.content.zorder\r\n    this.pinned = props.content.pinned\r\n    this.name = props.content.name\r\n    this.pose = props.content.pose\r\n    this.editing = props.contents.editing\r\n  }\r\n  restore(props: SharedContentFormProps){\r\n    if (!props.content) { return }\r\n    props.content.zorder = this.zorder\r\n    props.content.pinned = this.pinned\r\n    props.content.name = this.name\r\n    props.content.pose = this.pose\r\n    props.contents.setEditing(this.editing)\r\n  }\r\n}\r\nexport const SharedContentForm: React.FC<SharedContentFormProps> = (props: SharedContentFormProps) => {\r\n  const memberRef = React.useRef(new SharedContentFormMember(props))\r\n  const member = memberRef.current\r\n  function closeForm(ev:Object, reason:string) {\r\n    if (reason === 'enter' || reason==='backdropClick'){\r\n      member.save(props)\r\n      if (props.content){\r\n        props.updateAndSend(props.content)\r\n      }\r\n    }\r\n    props.close()\r\n  }\r\n  const onKeyPress = (ev:React.KeyboardEvent) => {\r\n    if (ev.key === 'Enter') {\r\n      closeForm(ev, 'enter')\r\n    }\r\n  }\r\n\r\n  const extractPopoverProps = ({onClose, autoHideTitle, updateAndSend, updateOnly, close, ...reminder}\r\n    : SharedContentFormProps) => reminder\r\n    const popoverProps:PopoverPropsNoOnClose = extractPopoverProps(props)\r\n\r\n  return <Popover onClose={closeForm} {...popoverProps} onMouseDown={(ev)=>{\r\n    ev.stopPropagation()\r\n  }}>\r\n    <Observer>{()=>\r\n      <DialogContent>\r\n        <table><tbody><tr><td>\r\n       {contentTypeIcons(props.content ? props.content.type : '', TITLE_HEIGHT)}\r\n       </td><td>\r\n        <TextField label={t('ctName')} multiline={false} value={props.content ? props.content.name : ''}\r\n          inputProps={{autoFocus:true}}\r\n          style={{marginLeft:20, width:'100%'}}\r\n          onChange={event => {\r\n            //setName(event.target.value)\r\n            if (!props.content) { return }\r\n            props.content.name = event.target.value\r\n            props.updateOnly(props.content)\r\n          }}\r\n          onKeyPress={onKeyPress} fullWidth={true}\r\n        />\r\n        </td></tr></tbody></table>\r\n        <Box mt={2} mb={2}>\r\n          <Button variant=\"contained\" style={{textTransform:'none'}}\r\n            onClick={()=>{\r\n              if (!props.content) { return }\r\n              moveContentToTop(props.content)\r\n              props.updateOnly(props.content)\r\n            }}><FlipToFrontIcon />&nbsp; {t('ctMoveTop')}</Button> &nbsp;\r\n          <Button variant=\"contained\" style={{textTransform:'none'}}\r\n            onClick={()=>{\r\n              if (!props.content) { return }\r\n              moveContentToBottom(props.content)\r\n              props.updateOnly(props.content)\r\n            }}><FlipToBackIcon />&nbsp; {t('ctMoveBottom')}</Button> &nbsp;\r\n        </Box>\r\n        <Box mt={2} mb={2}>\r\n          <Button variant=\"contained\" style={{textTransform:'none'}}\r\n            onClick={()=>{\r\n              if (!props.content) { return }\r\n              copyContentToClipboard(props.content)\r\n            }}><Icon icon={clipboardCopy} height={TITLE_HEIGHT}/>&nbsp; {t('ctCopyToClipboard')}</Button> &nbsp;\r\n          <Button variant=\"contained\" style={{textTransform:'none'}}\r\n            onClick={()=>{\r\n              if (!props.content) { return }\r\n              props.map.focusOn(props.content)\r\n            }}>{t('ctFocus')}</Button>\r\n        </Box>\r\n        <Table size=\"small\" ><TableBody>{[\r\n          Row(t('ctUnpin'),<Icon icon={pinOffIcon} height={TITLE_HEIGHT} />,\r\n            <Switch color=\"primary\" checked={props.content?.pinned} onChange={(ev, checked)=>{\r\n              if (!props.content) { return }\r\n              props.content.pinned = checked\r\n              props.updateOnly(props.content)\r\n            }}/>, <Icon icon={pinIcon} height={TITLE_HEIGHT} />, t('ctPin'), 'pin'),\r\n          <Fragment key=\"edit\">{isContentEditable(props.content) ?\r\n            Row(editButtonTip(true, props.content),<DoneIcon />,\r\n            <Switch color=\"primary\" checked={props.content?.id === props.contents.editing} onChange={(ev, checked)=>{\r\n              if (!props.content) { return }\r\n              props.contents.setEditing(checked ? props.content.id : '')\r\n            }}/>, <EditIcon />, editButtonTip(false, props.content)) : undefined}</Fragment>,\r\n          <Fragment key=\"wall\">{canContentBeAWallpaper(props.content) ?\r\n            Row(t('ctUnWallpaper'), <Icon icon={imageLine} height={TITLE_HEIGHT}/>,\r\n            <Switch color=\"primary\" checked={isContentWallpaper(props.content)} onChange={(ev, checked)=>{\r\n              if (!props.content) { return }\r\n              makeContentWallpaper(props.content, checked)\r\n              props.updateOnly(props.content)\r\n            }}/>, <Icon icon={imageOutlineBadged} height={TITLE_HEIGHT}/>, t('ctWallpaper')) : undefined}</Fragment>,\r\n          <Fragment key=\"noFrame\">{\r\n            Row(t('ctFrameVisible'), <Icon icon={biImage} height={TITLE_HEIGHT}/>,\r\n            <Switch color=\"primary\" checked={props.content?.noFrame} onChange={(ev, checked)=>{\r\n              if (!props.content) { return }\r\n              props.content.noFrame = checked ? true : undefined\r\n              props.updateOnly(props.content)\r\n            }}/>, <Icon icon={biImageNoFrame} height={TITLE_HEIGHT}/>, t('ctFrameInvisible')) }</Fragment>,\r\n          <Fragment key=\"opacity\">{\r\n            Row(t('ctTransparent'), <Icon icon={biDashCircleDotted} height={TITLE_HEIGHT}/>,\r\n            <Slider color=\"primary\" value={props.content?.opacity===undefined ? 1000 : props.content.opacity*1000}\r\n              min={0} max={1000}\r\n              style={{width:'6em', marginLeft:'0.4em', marginRight:'0.4em'}}\r\n              onChange={(ev, value) => {\r\n                if (!props.content) { return }\r\n                props.content.opacity = value === 1000 ? undefined : (value as number) / 1000\r\n                props.updateOnly(props.content)\r\n            }} />, <Icon icon={biPlusCircleFill} height={TITLE_HEIGHT}/>, t('ctOpaque')) }</Fragment>,\r\n            ]}</TableBody></Table>\r\n        <Box mt={2} mb={2}>\r\n          <Button variant=\"contained\" color=\"primary\" style={{textTransform:'none'}}\r\n            onClick={()=>{\r\n              closeForm({}, 'enter')\r\n            }}>{t('btSave')}</Button>\r\n          <Button variant=\"contained\" color=\"secondary\" style={{textTransform:'none', marginLeft:15}}\r\n            onClick={()=>{\r\n              if (!props.content) { return }\r\n              member.restore(props)\r\n              props.updateOnly(props.content)\r\n            }}>{t('btCancel')}</Button>\r\n          <Button variant=\"contained\" color=\"secondary\" style={{textTransform:'none', marginLeft:60}}\r\n            onClick={(ev)=>{\r\n              props.onClose(ev)\r\n            }}><CloseRoundedIcon /> &nbsp; {t('ctDelete')}</Button> &nbsp;&nbsp;\r\n        </Box>\r\n      </DialogContent>}\r\n    </Observer>\r\n  </Popover>\r\n}\r\n","import clipboardCopy from '@iconify-icons/heroicons-outline/clipboard-copy'\r\nimport pinIcon from '@iconify/icons-mdi/pin'\r\nimport pinOffIcon from '@iconify/icons-mdi/pin-off'\r\nimport {Icon} from '@iconify/react'\r\nimport {Tooltip} from '@material-ui/core'\r\nimport {makeStyles} from '@material-ui/core/styles'\r\nimport {CreateCSSProperties} from '@material-ui/core/styles/withStyles'\r\nimport DoneIcon from '@material-ui/icons/CheckCircle'\r\nimport CloseRoundedIcon from '@material-ui/icons/CloseRounded'\r\nimport EditIcon from '@material-ui/icons/Edit'\r\nimport FlipToBackIcon from '@material-ui/icons/FlipToBack'\r\nimport FlipToFrontIcon from '@material-ui/icons/FlipToFront'\r\nimport MoreHorizIcon from '@material-ui/icons/MoreHoriz'\r\nimport proximityIcon from '@images/earshot-on.png'\r\nimport proximityOffIcon from '@images/earshot-off.png'\r\nimport settings from '@models/api/Settings'\r\nimport {isContentEditable, ISharedContent} from '@models/ISharedContent'\r\nimport {t} from '@models/locales'\r\nimport {Pose2DMap} from '@models/utils'\r\nimport {addV2, extractScaleX, extractScaleY, mulV, rotateVector2DByDegree, subV2, mulV2, normV} from '@models/utils'\r\nimport {copyContentToClipboard, moveContentToBottom, moveContentToTop} from '@stores/sharedContents/SharedContentCreator'\r\nimport _, { stubFalse } from 'lodash'\r\nimport {useObserver} from 'mobx-react-lite'\r\nimport React, {useEffect, useLayoutEffect, useRef, useState} from 'react'\r\nimport {Rnd} from 'react-rnd'\r\nimport {useGesture} from 'react-use-gesture'\r\nimport { FullGestureState, UserHandlersPartial } from 'react-use-gesture/dist/types'\r\nimport {Content, contentTypeIcons, editButtonTip} from './Content'\r\nimport {ISharedContentProps} from './SharedContent'\r\nimport {SharedContentForm} from './SharedContentForm'\r\nimport {useStore} from '@hooks/ParticipantsStore'\r\nimport {useStore as useMapStore} from '@hooks/MapStore'\r\n\r\n\r\nconst MOUSE_RIGHT = 2\r\nconst TIMER_DELAY = 3 * 1000 // For 3 secs\r\nconst BORDER_TIMER_DELAY = 1 * 1000 // For 1 secs\r\n\r\nexport type MouseOrTouch = React.MouseEvent | React.TouchEvent\r\nexport interface RndContentProps extends ISharedContentProps {\r\n  hideAll ?: boolean\r\n  autoHideTitle ?: boolean\r\n  onShare ?: (evt: MouseOrTouch) => void\r\n  onClose: (evt: MouseOrTouch) => void\r\n  updateAndSend: (c: ISharedContent) => void\r\n  updateOnly: (c: ISharedContent) => void\r\n}\r\ninterface StyleProps{\r\n  props: RndContentProps,\r\n  pose: Pose2DMap,\r\n  size: [number, number],\r\n  showTitle: boolean,\r\n  pinned: boolean,\r\n  dragging: boolean,\r\n  editing: boolean\r\n  //proximity: boolean\r\n}\r\nclass RndContentMember{\r\n  buttons = 0\r\n  dragCanceled = false\r\n  _down = false\r\n  downTime = 0\r\n  upTime = 0\r\n  _item = ''\r\n  _timer = 0\r\n  _borderTimer = 0\r\n}\r\n\r\n\r\n//  -----------------------------------------------------------------------------------\r\n//  The RnDContent component\r\nexport const TITLE_HEIGHT = 24\r\n\r\nexport const RndContent: React.FC<RndContentProps> = (props:RndContentProps) => {\r\n  /*\r\n  function rotateG2C(gv: [number, number]) {\r\n    const lv = mapData.rotateFromWindow(gv)\r\n    const cv = rotateVector2DByDegree(-pose.orientation, lv)\r\n    //  console.log('rotateG2C called ori', pose.orientation, ' tran:', transform.rotation)\r\n\r\n    return cv\r\n  }*/\r\n  /*\r\n  function rotateG2L(gv: [number, number]) {\r\n    const lv = transform.rotateG2L(gv)\r\n\r\n    return lv\r\n  }\r\n  function rotateC2G(cv: [number, number]) {\r\n    const lv = rotateVector2DByDegree(pose.orientation, cv)\r\n    const gv = transform.rotateL2G(lv)\r\n\r\n    return gv\r\n  }*/\r\n\r\n  \r\n\r\n  // states\r\n  const [pose, setPose] = useState(props.content.pose)  //  pose of content\r\n  const [size, setSize] = useState(props.content.size)  //  size of content\r\n  const [resizeBase, setResizeBase] = useState(size)    //  size when resize start\r\n  const [resizeBasePos, setResizeBasePos] = useState(pose.position)    //  position when resize start\r\n  const [showTitle, setShowTitle] = useState(!props.autoHideTitle || !props.content.pinned)\r\n  const [showForm, setShowForm] = useState(false)\r\n  const [preciseOrientation, setPreciseOrientation] = useState(pose.orientation)\r\n  const [dragging, setDragging] = useState(false)\r\n  const rnd = useRef<Rnd>(null)                         //  ref to rnd to update position and size\r\n  const contents = props.contents\r\n\r\n  // For dotted border\r\n  const [showBorder, setShowBorder] = useState(false)\r\n\r\n\r\n\r\n  const participants = useStore()\r\n  const mapStore = useMapStore()\r\n\r\n  //console.log(props.content)\r\n  \r\n\r\n  const editing = useObserver(() => contents.editing === props.content.id)\r\n  function setEditing(flag: boolean) { contents.setEditing(flag ? props.content.id : '') }\r\n  const memberRef = useRef<RndContentMember>(new RndContentMember())\r\n  const member = memberRef.current\r\n\r\n  useEffect(  //  update pose\r\n    ()=> {\r\n      member.dragCanceled = true\r\n      if(props.content.shareType != \"img\") {\r\n        window.setTimeout( function() {\r\n          //console.log(showTitle, \" Calling function everytime\")\r\n          //if(showTitle === true) return\r\n           setShowTitle(false)\r\n        }, TIMER_DELAY)\r\n      }\r\n      if (!_.isEqual(size, props.content.size)) {\r\n        setSize(_.cloneDeep(props.content.size))\r\n      }\r\n      if (!_.isEqual(pose, props.content.pose)) {\r\n        setPose(_.cloneDeep(props.content.pose))\r\n      }\r\n    },\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n    [props.content],\r\n  )\r\n\r\n  function setPoseAndSizeToRnd(){\r\n    if (rnd.current) { rnd.current.resizable.orientation = pose.orientation + props.map.rotation }\r\n    const titleHeight = showTitle ? TITLE_HEIGHT : 0\r\n    rnd.current?.updatePosition({x:pose.position[0], y:pose.position[1] - titleHeight})\r\n    rnd.current?.updateSize({width:size[0], height:size[1] + titleHeight})\r\n  }\r\n  useLayoutEffect(  //  reflect pose etc. to rnd size\r\n    () => {\r\n      setPoseAndSizeToRnd()\r\n    },\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n    [pose, size, showTitle, props.map.rotation],\r\n  )\r\n\r\n  //  handlers\r\n  function stop(ev:MouseOrTouch|React.PointerEvent) {\r\n    ev.stopPropagation()\r\n    ev.preventDefault()\r\n  }\r\n  function onClickShare(evt: MouseOrTouch) {\r\n    stop(evt)\r\n    props.onShare?.call(null, evt)\r\n  }\r\n  function onClickClose(evt: MouseOrTouch) {\r\n    stop(evt)\r\n    props.onClose?.call(null, evt)\r\n  }\r\n  function onClickEdit(evt: MouseOrTouch) {\r\n    stop(evt)\r\n    setEditing(!editing)\r\n  }\r\n  function onClickMoveToTop(evt: MouseOrTouch) {\r\n    stop(evt)\r\n    moveContentToTop(props.content)\r\n    props.updateAndSend(props.content)\r\n  }\r\n  function onClickMoveToBottom(evt: MouseOrTouch) {\r\n    stop(evt)\r\n    moveContentToBottom(props.content)\r\n    props.updateAndSend(props.content)\r\n  }\r\n  function onClickPin(evt: MouseOrTouch) {\r\n    stop(evt)\r\n    props.content.pinned = !props.content.pinned\r\n    props.updateAndSend(props.content)\r\n  }\r\n\r\n  function onClickProxomity(evt: MouseOrTouch) {\r\n    stop(evt)\r\n    props.content.proximity = !props.content.proximity\r\n    props.updateAndSend(props.content)\r\n  }\r\n\r\n  function onClickCopy(evt: MouseOrTouch){\r\n    stop(evt)\r\n    copyContentToClipboard(props.content)\r\n  }\r\n  function onClickMore(evt: MouseOrTouch){\r\n    stop(evt)\r\n    props.map.keyInputUsers.add('contentForm')\r\n    setShowForm(true)\r\n  }\r\n  function onCloseForm(){\r\n    setShowForm(false)\r\n    if (props.content.pinned){\r\n      setShowTitle(false)\r\n    }\r\n    props.map.keyInputUsers.delete('contentForm')\r\n    props.updateAndSend(props.content)\r\n  }\r\n  function updateHandler() {\r\n    if (JSON.stringify(pose) !== JSON.stringify(props.content.pose) ||\r\n      JSON.stringify(size) !== JSON.stringify(props.content.size)) {\r\n      props.content.size = [...size] //  Must be new object to compare the pose or size object.\r\n      props.content.pose = {...pose} //  Must be new object to compare the pose or size object.\r\n      props.updateAndSend(props.content)\r\n    }\r\n  }\r\n\r\n  //  drag for title area\r\n  function dragHandler(delta:[number, number], buttons:number, event:any) {\r\n    if (member.dragCanceled){ return }\r\n    const ROTATION_IN_DEGREE = 360\r\n    const ROTATION_STEP = 15\r\n    if (buttons === MOUSE_RIGHT) {\r\n      setPreciseOrientation((preciseOrientation + delta[0] + delta[1]) % ROTATION_IN_DEGREE)\r\n      let newOri\r\n      if (event?.shiftKey || event?.ctrlKey) {\r\n        newOri = preciseOrientation\r\n      }else {\r\n        newOri = preciseOrientation - preciseOrientation % ROTATION_STEP\r\n      }\r\n      //    mat.translateSelf(...addV2(props.pose.position, mulV(0.5, size)))\r\n      const CENTER_IN_RATIO = 0.5\r\n      const center = addV2(pose.position, mulV(CENTER_IN_RATIO, size))\r\n      pose.position = addV2(pose.position,\r\n                            subV2(rotateVector2DByDegree(pose.orientation - newOri, center), center))\r\n      pose.orientation = newOri\r\n      setPose(Object.assign({}, pose))\r\n    }else {\r\n      const lv = props.map.rotateFromWindow(delta)\r\n      const cv = rotateVector2DByDegree(-pose.orientation, lv)\r\n      pose.position = addV2(pose.position, cv)\r\n      setPose(Object.assign({}, pose))\r\n    }\r\n  }\r\n\r\n  \r\n  const isFixed = (props.autoHideTitle && props.content.pinned)\r\n  const handlerForTitle:UserHandlersPartial = {\r\n    \r\n    //onMouseEnter:(evt)=>{\r\n      //if (props.autoHideTitle) { setShowTitle(true) } \r\n    //},\r\n\r\n    //onMouseLeave: (evt) => {\r\n      //if (props.autoHideTitle && !editing && props.content.pinned) { setShowTitle(false) }\r\n    //},\r\n\r\n    /* onTouchStart: (evt) => {\r\n      if (props.autoHideTitle) {\r\n        if (!showTitle) {\r\n          setShowTitle(true)\r\n        } else if (props.content.pinned) {\r\n          setShowTitle(false)\r\n        }\r\n      }\r\n    }, */\r\n\r\n    onDoubleClick: (evt)=>{\r\n      if (isContentEditable(props.content)){\r\n        stop(evt)\r\n        setEditing(!editing)\r\n      }\r\n    },\r\n    onDrag: ({down, delta, event, xy, buttons}) => {\r\n      //  console.log('onDragTitle:', delta)\r\n      \r\n      if (isFixed) { return }\r\n      event?.stopPropagation()\r\n      if (down) {\r\n        //  event?.preventDefault()\r\n        dragHandler(delta, buttons, event)\r\n      }\r\n    },\r\n    onDragStart: ({event, currentTarget, delta, buttons}) => {   // to detect click\r\n      //  console.log(`dragStart delta=${delta}  buttons=${buttons}`)\r\n      setDragging(true)\r\n      member.buttons = buttons\r\n      member.dragCanceled = false\r\n      if (currentTarget instanceof Element && event instanceof PointerEvent){\r\n        currentTarget.setPointerCapture(event?.pointerId)\r\n      }\r\n    },\r\n    onDragEnd: ({event, currentTarget, delta, buttons}) => {\r\n      //  console.log(`dragEnd delta=${delta}  buttons=${buttons}`)\r\n      setDragging(false)\r\n      if (!member.dragCanceled){ updateHandler() }\r\n      member.dragCanceled = false\r\n\r\n      if (currentTarget instanceof Element && event instanceof PointerEvent){\r\n        currentTarget.releasePointerCapture(event?.pointerId)\r\n      }\r\n      if (!props.map.keyInputUsers.size && member.buttons === MOUSE_RIGHT){ //  right click\r\n        setShowForm(true)\r\n        props.map.keyInputUsers.add('contentForm')\r\n      }\r\n      member.buttons = 0\r\n    },\r\n    \r\n    onPointerUp: (arg) => { if(editing) {arg.stopPropagation()}},\r\n    onPointerDown: (arg) => { if(editing) {arg.stopPropagation()} },\r\n    onMouseUp: (arg) => { \r\n      if(editing) {arg.stopPropagation()}\r\n      else\r\n      {\r\n        member.upTime = new Date().getSeconds()\r\n        let diffTime = member.upTime - member.downTime\r\n        //console.log(diffTime, \" ft \", String(Object(arg.target).tagName))\r\n        if(diffTime < 1 && String(Object(arg.target).tagName) === \"DIV\") {\r\n          if(member._down === false) return\r\n            const local = participants.local\r\n            const diff = subV2(mapStore.mouseOnMap, local.pose.position)\r\n            if (normV(diff) > 60 / 2) {\r\n              const dir = mulV2(normV(diff) / normV(diff), diff)\r\n              local.pose.orientation = Math.atan2(dir[0], -dir[1]) * 180 / Math.PI\r\n              //if (move) {\r\n              local.pose.position = addV2(local.pose.position, dir)\r\n              //}\r\n              local.savePhysicsToStorage(false)\r\n\r\n              // Showing border around\r\n              setShowBorder(true)\r\n              // Start Timer to disable border\r\n              clearTimeout(member._borderTimer)\r\n              showHideBorder()\r\n            }\r\n          }\r\n         \r\n        }\r\n      member._down = false;\r\n      //member._down = true;\r\n      member._item = String(Object(arg.target).tagName)\r\n\r\n      clearTimeout(member._timer)\r\n      showHideTimer()\r\n    },\r\n    onMouseMove: (arg) => {member._down = false},\r\n    onMouseOver: (arg) => {\r\n        member._down = true\r\n        member._item = String(Object(arg.target).tagName)\r\n        //showHideTimer(true, String(Object(arg.target).tagName))\r\n\r\n        clearTimeout(member._timer)\r\n        showHideTimer()\r\n    },\r\n    onMouseDown: (arg) => {\r\n      if(editing) {\r\n        arg.stopPropagation()\r\n      } else {\r\n        member._down = true\r\n        member.downTime = new Date().getSeconds()\r\n\r\n        \r\n\r\n\r\n        //console.log(member._down, \" -- \", moving)\r\n        setTimeout(() => {\r\n          //function moveParticipant(move: boolean) {\r\n            //console.log(props)    \r\n            //if(dragging === false) {\r\n            if (props.autoHideTitle && props.content.noFrame && member._down === true) { \r\n              //if (props.autoHideTitle && props.content.noFrame && props.content.pinned && member._down === true) { \r\n                //console.log(showTitle, \" showTitle\")\r\n                if(showTitle === false) {\r\n                  setShowTitle(true)\r\n                  \r\n                  //showHideTimer(true, String(Object(arg.target).tagName))\r\n                  \r\n                } else {\r\n                  //setShowTitle(false) \r\n                }\r\n              } \r\n            //} else {\r\n            //const TIMER_INTERVAL = move ? 33 : 800\r\n            //setTimeout(() => { moveParticipant(true) }, TIMER_INTERVAL)\r\n            //}\r\n          //}\r\n          //moveParticipant(false)\r\n        }, 1500)\r\n\r\n        // Showing border around\r\n        // setShowBorder(true)\r\n      } \r\n    },\r\n    onTouchStart: (arg) => { if(editing) {arg.stopPropagation() }},\r\n    onTouchEnd: (arg) => { if(editing) {arg.stopPropagation()} },\r\n  }\r\n\r\n  function showHideBorder() {  \r\n    member._borderTimer = window.setTimeout( function() {\r\n      setShowBorder(false)\r\n     }, BORDER_TIMER_DELAY)\r\n  }\r\n\r\n  //function showHideTimer(vis:boolean, onItemType:string) {\r\n  function showHideTimer() {  \r\n    //console.log(onItemType, \" >onItemType \", vis, \" --- \", member._down)\r\n    //console.log(member._item, \"onItem\");\r\n    if(member._item != \"DIV\") return\r\n    member._timer = window.setTimeout( function() {\r\n      //console.log(onItemType, \" >onItemType \", vis, \" --- \", member._down)\r\n      setShowTitle(false)\r\n      /* if(props.content.shareType != \"img\" && onItemType === \"DIV\") {\r\n        if(vis) {\r\n          setShowTitle(false)\r\n        } else {\r\n          setShowTitle(true)\r\n        }\r\n      } */\r\n     }, TIMER_DELAY)\r\n  }\r\n\r\n  const handlerForContent:UserHandlersPartial = Object.assign({}, handlerForTitle)\r\n  handlerForContent.onDrag = (args: FullGestureState<'drag'>) => {\r\n    //  console.log('onDragBody:', args.delta)\r\n    if (isFixed || props.map.keyInputUsers.has(props.content.id)) { return }\r\n    handlerForTitle.onDrag?.call(this, args)\r\n  }\r\n\r\n  function onResizeStart(evt:React.MouseEvent<HTMLDivElement> | React.TouchEvent<HTMLDivElement>){\r\n    member.dragCanceled = false\r\n    evt.stopPropagation(); evt.preventDefault()\r\n    setResizeBase(size)\r\n    setResizeBasePos(pose.position)\r\n  }\r\n  function onResizeStop(){\r\n    if (!member.dragCanceled){ updateHandler() }\r\n    member.dragCanceled = false\r\n  }\r\n  function onResize(evt:MouseEvent | TouchEvent, dir: any, elem:HTMLDivElement, delta:any, pos:any) {\r\n    evt.stopPropagation(); evt.preventDefault()\r\n    //  console.log(`dragcancel:${member.dragCanceled}`)\r\n    if (member.dragCanceled) {\r\n      setPoseAndSizeToRnd()\r\n\r\n      return\r\n    }\r\n\r\n    const scale = (extractScaleX(props.map.matrix) + extractScaleY(props.map.matrix)) / 2\r\n    const cd:[number, number] = [delta.width / scale, delta.height / scale]\r\n    // console.log('resize dir:', dir, ' delta:', delta, ' d:', d, ' pos:', pos)\r\n    if (dir === 'left' || dir === 'right') {\r\n      cd[1] = 0\r\n    }\r\n    if (dir === 'top' || dir === 'bottom') {\r\n      cd[0] = 0\r\n    }\r\n    let posChange = false\r\n    const deltaPos: [number, number] = [0, 0]\r\n    if (dir === 'left' || dir === 'topLeft' || dir === 'bottomLeft') {\r\n      deltaPos[0] = -cd[0]\r\n      posChange = posChange || cd[0] !== 0\r\n    }\r\n    if (dir === 'top' || dir === 'topLeft' || dir === 'topRight') {\r\n      deltaPos[1] = -cd[1]\r\n      posChange = posChange || cd[1] !== 0\r\n    }\r\n    if (posChange) {\r\n      pose.position = addV2(resizeBasePos, deltaPos)\r\n      setPose(Object.assign({}, pose))\r\n      //console.log(`setPose ${pose.position}`)\r\n    }\r\n    const newSize = addV2(resizeBase, cd)\r\n    if (props.content.originalSize[0]) {\r\n      const ratio = props.content.originalSize[0] / props.content.originalSize[1]\r\n      if (newSize[0] > ratio * newSize[1]) { newSize[0] = ratio * newSize[1] }\r\n      if (newSize[0] < ratio * newSize[1]) { newSize[1] = newSize[0] / ratio }\r\n    }\r\n    setSize(newSize)\r\n  }\r\n\r\n\r\n  const classes = useStyles({props, pose, size, showTitle, pinned:props.content.pinned, dragging, editing})\r\n  //  console.log('render: TITLE_HEIGHT:', TITLE_HEIGHT)\r\n  const contentRef = React.useRef<HTMLDivElement>(null)\r\n  const formRef = React.useRef<HTMLDivElement>(null)\r\n  const gestureForContent = useGesture(handlerForContent)\r\n  const gestureForTitle = useGesture(handlerForTitle)\r\n  const theContent =\r\n    <div className={classes.rndContainer} {...gestureForContent()}>\r\n      <div className={classes.titlePosition} {...gestureForTitle() /* title can be placed out of Rnd */}>\r\n        <div className={classes.titleContainer}\r\n            /* onMouseEnter = {() => { if (props.autoHideTitle) { setShowTitle(true) } }} */\r\n            /* onMouseLeave = {() => {\r\n              if (props.autoHideTitle && !editing && props.content.pinned) { setShowTitle(false) } }}\r\n            onTouchStart = {() => {\r\n              if (props.autoHideTitle) {\r\n                if (!showTitle) {\r\n                  setShowTitle(true)\r\n                }else if (props.content.pinned) {\r\n                  setShowTitle(false)\r\n                }\r\n              }\r\n            }} */\r\n            onContextMenu = {() => {\r\n              setShowForm(true)\r\n              props.map.keyInputUsers.add('contentForm')\r\n            }}\r\n            >\r\n          <div className={classes.type}>\r\n            {contentTypeIcons(props.content.type, TITLE_HEIGHT, TITLE_HEIGHT*1.1)}\r\n          </div>\r\n          <Tooltip placement=\"top\" title={props.content.pinned ? t('ctUnpin') : t('ctPin')} >\r\n          <div className={classes.pin} onClick={onClickPin} onTouchStart={stop}>\r\n            <Icon icon={props.content.pinned ? pinIcon : pinOffIcon} height={TITLE_HEIGHT} width={TITLE_HEIGHT*1.1} />\r\n          </div></Tooltip>\r\n          <Tooltip placement=\"top\" title={editButtonTip(editing, props.content)} >\r\n            <div className={classes.edit} onClick={onClickEdit} onTouchStart={stop}>\r\n             {\r\n              editing ? <DoneIcon style={{fontSize:TITLE_HEIGHT}} />\r\n                : <EditIcon style={{fontSize:TITLE_HEIGHT}} />}\r\n            </div>\r\n          </Tooltip>\r\n          {props.content.pinned ? undefined :\r\n            <Tooltip placement=\"top\" title={t('ctMoveTop')} >\r\n              <div className={classes.titleButton} onClick={onClickMoveToTop}\r\n                onTouchStart={stop}><FlipToFrontIcon /></div></Tooltip>}\r\n          {props.content.pinned ? undefined :\r\n            <Tooltip placement=\"top\" title={t('ctMoveBottom')} >\r\n              <div className={classes.titleButton} onClick={onClickMoveToBottom}\r\n                onTouchStart={stop}><FlipToBackIcon /></div></Tooltip>}\r\n\r\n          {/*(props.content.pinned || !canContentBeAWallpaper(props.content)) ? undefined :\r\n            <div className={classes.titleButton} onClick={onClickWallpaper}\r\n              onTouchStart={stop}>\r\n                <Tooltip placement=\"top\" title={isContentWallpaper(props.content) ?\r\n                  t('ctUnWallpaper') : t('ctWallpaper')}>\r\n                  <div><WallpaperIcon />{isContentWallpaper(props.content) ?\r\n                    <CloseRoundedIcon style={{marginLeft:'-1em'}} /> : undefined }</div>\r\n                </Tooltip>\r\n                  </div> */}\r\n          <Tooltip placement=\"top\" title={t('ctCopyToClipboard')} >\r\n            <div className={classes.titleButton} onClick={onClickCopy}\r\n              onTouchStart={stop}>\r\n                <Icon icon={clipboardCopy} height={TITLE_HEIGHT}/>\r\n            </div>\r\n          </Tooltip>\r\n          \r\n          {props.content.shareType === \"img\" ? undefined :\r\n          <Tooltip placement=\"top\" title={props.content.proximity ? t('ctUnProximity') : t('ctProximity')} >\r\n          <div className={classes.pin} onClick={onClickProxomity} onTouchStart={stop}>\r\n            <img src={props.content.proximity ? proximityIcon : proximityOffIcon} height={TITLE_HEIGHT} width={TITLE_HEIGHT*1.1} alt=\"\"/>\r\n          </div>\r\n          </Tooltip>\r\n          }\r\n\r\n          <div className={classes.titleButton} onClick={onClickMore} onTouchStart={stop} ref={formRef}>\r\n              <MoreHorizIcon />\r\n          </div>\r\n          <SharedContentForm open={showForm} {...props} close={onCloseForm}\r\n            anchorEl={contentRef.current} anchorOrigin={{vertical:'top', horizontal:'right'}}\r\n          />\r\n          <div className={classes.note} onClick={onClickShare} onTouchStart={stop}>Share</div>\r\n          {props.content.pinned ? undefined :\r\n            <div className={classes.close} onClick={onClickClose} onTouchStart={stop}>\r\n              <CloseRoundedIcon /></div>}\r\n        </div>\r\n      </div>\r\n      <div className={classes.content} ref={contentRef}>\r\n        <Content {...props}/>\r\n        <div className={showBorder ? classes.dashed : undefined}></div>\r\n      </div>\r\n    </div>\r\n  //  console.log('Rnd rendered.')\r\n\r\n\r\n  return (\r\n    <div className={classes.container} style={{zIndex:props.content.zIndex}} onContextMenu={\r\n      (evt) => {\r\n        evt.stopPropagation()\r\n        evt.preventDefault()\r\n      }\r\n    }>\r\n      <Rnd className={classes.rndCls} enableResizing={isFixed ? resizeDisable : resizeEnable}\r\n        disableDragging={isFixed} ref={rnd}\r\n        onResizeStart = {onResizeStart}\r\n        onResize = {onResize}\r\n        onResizeStop = {onResizeStop}\r\n      >\r\n        {theContent}\r\n      </Rnd>\r\n    </div >\r\n  )\r\n}\r\n\r\nconst buttonStyle = {\r\n  '&:hover': {\r\n    backgroundColor: 'rosybrown',\r\n  },\r\n  '&:active': {\r\n    backgroundColor: 'firebrick',\r\n  },\r\n}\r\n\r\nconst BORDER_WIDTH = 3\r\n\r\nconst useStyles = makeStyles({\r\n  container: (props: StyleProps) => {\r\n    const mat = new DOMMatrix()\r\n    mat.rotateSelf(0, 0, props.pose.orientation)\r\n\r\n    return ({\r\n      display: props.props.hideAll ? 'none' : 'block',\r\n      width:0,\r\n      height:0,\r\n      transform: mat.toString(),\r\n      position: 'absolute',\r\n      \r\n    })\r\n  },\r\n  rndCls: (props: StyleProps) => ({\r\n    borderRadius: props.showTitle ? '0.5em 0.5em 0 0' : '0 0 0 0',\r\n    backgroundColor: props.props.content.noFrame ? 'rgba(0,0,0,0)' :\r\n      settings.useTransparent ? 'rgba(200,200,200,0.5)' : 'rgba(200,200,200,1)',\r\n    boxShadow: props.props.content.noFrame ? undefined :\r\n      settings.useTransparent ? '0.2em 0.2em 0.2em 0.2em rgba(0,0,0,0.4)' :\r\n        '0.2em 0.2em 0.2em 0.2em rgba(100,100,100,1)',\r\n\r\n        \r\n  }),\r\n  rndContainer: (props: StyleProps) => ({\r\n    width:'100%',\r\n    height:'100%',\r\n   /*  borderWidth:2,\r\n    borderStyle: 'dashed',\r\n    borderColor:'red',\r\n    borderRadius:1, */\r\n  }),\r\n  dashed:(props: StyleProps) => ({\r\n    position: 'relative',\r\n    width:'102%',\r\n    height:'102%',\r\n    borderWidth:4,\r\n    borderStyle: 'dashed',\r\n    borderColor:'red',\r\n    borderRadius:0,\r\n    top: ((-(props.size[1])) - 6) + \"px\",\r\n    left: '-6px',\r\n  }),\r\n\r\n  titlePosition: (props:StyleProps) => (\r\n    props.showTitle ?\r\n    {}\r\n    :\r\n    {\r\n      width:0,\r\n      heihgt:0,\r\n      position:'absolute',\r\n      top:0,\r\n    }\r\n  ),\r\n  titleContainer: (props:StyleProps) => {\r\n    const rv:CreateCSSProperties = {\r\n      display:'flex',\r\n      width: props.size[0],\r\n      overflow: 'hidden',\r\n      userSelect: 'none',\r\n      userDrag: 'none',\r\n    }\r\n    if (!props.showTitle) {\r\n      rv['position'] = 'absolute'\r\n      rv['bottom'] = 0\r\n    }\r\n\r\n    return rv\r\n  },\r\n  content: (props: StyleProps) => ({\r\n    position: 'absolute',\r\n    top: (props.showTitle ? TITLE_HEIGHT : 0) - (props.editing ? BORDER_WIDTH : 0),\r\n    left: props.editing ? -BORDER_WIDTH : 0,\r\n    width: props.size[0],\r\n    height: props.size[1],\r\n    userDrag: 'none',\r\n    pointerEvents: props.dragging ? 'auto' : 'auto',\r\n    borderWidth: BORDER_WIDTH,\r\n    borderColor: 'yellow',\r\n    borderStyle: props.editing ? 'solid' : 'none',\r\n    cursor: props.editing ? 'default' : 'default',\r\n    opacity: props.props.content.opacity,\r\n  }),\r\n  note: (props:StyleProps) => (\r\n    props.showTitle ? {\r\n      visibility: props.props.onShare ? 'visible' : 'hidden',\r\n      whiteSpace: 'pre',\r\n      borderRadius: '0.5em 0 0 0',\r\n      ...buttonStyle,\r\n    } : {\r\n      visibility: 'hidden',\r\n    }),\r\n  pin: (props:StyleProps) => (\r\n    props.showTitle ? {\r\n      display: props.props.onShare ? 'none' : 'block',\r\n      height: TITLE_HEIGHT,\r\n      whiteSpace: 'pre',\r\n      cursor: 'default',\r\n      ...buttonStyle,\r\n    } : {display:'none'}\r\n  ),\r\n  titleButton: (props:StyleProps) => (\r\n    props.showTitle ? {\r\n      display: 'block',\r\n      height: TITLE_HEIGHT,\r\n      whiteSpace: 'pre',\r\n      cursor: 'default',\r\n      ...buttonStyle,\r\n    } : {display:'none'}\r\n  ),\r\n  edit: (props:StyleProps) => (\r\n    props.showTitle ? {\r\n      display: (props.props.onShare || !isContentEditable(props.props.content)) ? 'none' : 'block',\r\n      height: TITLE_HEIGHT,\r\n      whiteSpace: 'pre',\r\n      cursor: 'default',\r\n      ...buttonStyle,\r\n    } : {display:'none'}\r\n  ),\r\n  type: (props: StyleProps) => ({\r\n    display: props.showTitle ? 'block' : 'none',\r\n    height: TITLE_HEIGHT,\r\n  }),\r\n  close: (props: StyleProps) => ({\r\n    visibility: props.showTitle ? 'visible' : 'hidden',\r\n    position:'absolute',\r\n    right:0,\r\n    margin:0,\r\n    padding:0,\r\n    height: TITLE_HEIGHT,\r\n    borderRadius: '0 0.5em 0 0',\r\n    cursor: 'default',\r\n    ...buttonStyle,\r\n  }),\r\n})\r\n\r\nconst resizeEnable = {\r\n  bottom: true,\r\n  bottomLeft: true,\r\n  bottomRight: true,\r\n  left: true,\r\n  right: true,\r\n  top: true,\r\n  topLeft: true,\r\n  topRight:true,\r\n}\r\nconst resizeDisable = {\r\n  bottom: false,\r\n  bottomLeft: false,\r\n  bottomRight: false,\r\n  left: false,\r\n  right: false,\r\n  top: false,\r\n  topLeft: false,\r\n  topRight:false,\r\n}\r\n\r\nRndContent.displayName = 'RndContent'\r\n","export default \"data:image/png;base64,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\"","export default \"data:image/png;base64,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\"","import {Stores} from '@components/utils'\r\nimport {doseContentEditingUseKeyinput, ISharedContent} from '@models/ISharedContent'\r\nimport {SharedContentInfo} from '@models/ISharedContent'\r\nimport {contentLog} from '@stores/sharedContents/SharedContents'\r\nimport {useObserver} from 'mobx-react-lite'\r\nimport React from 'react'\r\nimport {MouseOrTouch, RndContent} from './RndContent'\r\nexport interface ISharedContentProps extends Stores{\r\n  content: ISharedContent,\r\n}\r\n\r\nexport const sharedContentHandler = (props: Stores&{content:SharedContentInfo}) => {\r\n  return {\r\n    onClose: (evt: MouseOrTouch) => {\r\n      contentLog('RndContent onClose for ', props.content.id)\r\n      evt.stopPropagation()\r\n      props.map.keyInputUsers.delete(props.content.id)\r\n      props.map.keyInputUsers.delete('contentForm')\r\n      props.contents.removeByLocal(props.content.id)\r\n    },\r\n    updateAndSend:(c: ISharedContent) => {\r\n      //\tconsole.log('updateByLocal(send content)')\r\n      props.contents.updateByLocal(Object.assign({}, c))\r\n    },\r\n    updateOnly:(c: ISharedContent) => {\r\n      props.contents.updateLocalOnly(Object.assign({}, c))\r\n    }\r\n  }\r\n}\r\n\r\nexport const SharedContent: React.FC<ISharedContentProps> = (props:ISharedContentProps) => {\r\n  //  set whether use keyboard input or not\r\n  const map = props.map\r\n  \r\n  const editing = useObserver(() => props.contents.editing === props.content.id)\r\n  if (doseContentEditingUseKeyinput(props.content)){\r\n    if (editing) {\r\n      map.keyInputUsers.add(props.content.id)\r\n    }else {\r\n      map.keyInputUsers.delete(props.content.id)\r\n    } }\r\n\r\n  return <RndContent {...props} autoHideTitle={true} {... sharedContentHandler(props)} />\r\n}\r\n\r\nSharedContent.displayName = 'SharedContent'\r\n","import {sharedContentHandler} from '@components/map/ShareLayer/SharedContent'\r\nimport {SharedContentForm} from '@components/map/ShareLayer/SharedContentForm'\r\nimport {Tooltip} from '@material-ui/core'\r\nimport {SharedContentInfo} from '@models/ISharedContent'\r\nimport {useTranslation} from '@models/locales'\r\nimport {getRandomColor, rgb2Color} from '@models/utils'\r\nimport {isDarkColor} from '@models/utils'\r\nimport {ParticipantBase} from '@stores/participants/ParticipantBase'\r\nimport roomInfo from '@stores/RoomInfo'\r\nimport contents from '@stores/sharedContents/SharedContents'\r\nimport { autorun } from 'mobx'\r\nimport {Observer} from 'mobx-react-lite'\r\nimport {useObserver} from 'mobx-react-lite'\r\nimport React from 'react'\r\nimport {contentTypeIcons} from '../map/ShareLayer/Content'\r\nimport {Stores} from '../utils'\r\nimport {styleForList} from '../utils/styles'\r\nimport {TextLineStyle} from './LeftBar'\r\n\r\nexport const ContentLine: React.FC<TextLineStyle & Stores &\r\n{participant: ParticipantBase, content: SharedContentInfo}> = (props) => {\r\n  const classes = styleForList({height:props.lineHeight, fontSize:props.fontSize})\r\n  const [showForm, setShowForm] = React.useState(false)\r\n  const ref = React.useRef<HTMLDivElement>(null)\r\n  const {lineHeight, content, ...contentProps} = props\r\n\r\n  return <Observer>{()=> {\r\n    const typeIcon = contentTypeIcons(props.content.type, props.fontSize)\r\n    const colors = getRandomColor(props.content.ownerName)\r\n    const content = props.contents.find(props.content.id)\r\n    if (props.content.color?.length){ colors[0] = rgb2Color(props.content.color) }\r\n    if (props.content.textColor?.length){ colors[1] = rgb2Color(props.content.textColor) }\r\n\r\n    return <>\r\n      <Tooltip title={props.content.ownerName} placement=\"right\">\r\n        <div className={classes.line} style={{backgroundColor:colors[0], color:colors[1]}} ref={ref}\r\n          onClick={() => {\r\n            const found = contents.find(props.content.id)\r\n            if (found){\r\n              props.map.focusOn(found)\r\n            }else{\r\n              contents.requestContent([props.content.id])\r\n              const disposer = autorun(()=>{\r\n                const found = contents.find(props.content.id)\r\n                if (found){\r\n                  props.map.focusOn(found)\r\n                  disposer()\r\n                }\r\n              })\r\n            }\r\n          }}\r\n          onContextMenu={() => {\r\n            const found = contents.find(props.content.id)\r\n            if (found){\r\n              setShowForm(true)\r\n              props.map.keyInputUsers.add('contentForm')\r\n            }else{\r\n              contents.requestContent([props.content.id])\r\n              const disposer = autorun(()=>{\r\n                const found = contents.find(props.content.id)\r\n                if (found){\r\n                  setShowForm(true)\r\n                  props.map.keyInputUsers.add('contentForm')\r\n                  disposer()\r\n                }\r\n              })\r\n            }\r\n          }}\r\n        >\r\n          {typeIcon}{props.content.name}\r\n        </div>\r\n      </Tooltip>\r\n      <SharedContentForm {...contentProps} contents={props.contents} content={content}\r\n        {...sharedContentHandler(props)} open={showForm}\r\n        close={()=>{\r\n          setShowForm(false)\r\n          props.map.keyInputUsers.delete('contentForm')\r\n        }}\r\n        anchorEl={ref.current} anchorOrigin={{vertical:'top', horizontal:'right'}}\r\n      />\r\n    </>\r\n  }}</Observer>\r\n}\r\n\r\nexport const ContentList: React.FC<Stores&TextLineStyle>  = (props) => {\r\n  //  console.log('Render RawContentList')\r\n  const contents = props.contents\r\n  const all = useObserver(() => {\r\n    const all:SharedContentInfo[] =\r\n      Array.from(contents.roomContentsInfo.size ? contents.roomContentsInfo.values() : contents.all)\r\n    all.sort((a,b) => {\r\n      let rv = a.name.localeCompare(b.name)\r\n      if (rv === 0){ rv = a.ownerName.localeCompare(b.ownerName) }\r\n      if (rv === 0){ rv = a.type.localeCompare(b.type) }\r\n      if (rv === 0){ rv = a.id.localeCompare(b.id) }\r\n\r\n      return rv\r\n    })\r\n\r\n    return all\r\n  })\r\n\r\n  const classes = styleForList({height:props.lineHeight, fontSize:props.fontSize})\r\n  const participants = props.participants\r\n  const elements = all.map(c =>\r\n    <ContentLine key={c.id} content = {c} {...props}\r\n      participant={participants.find(contents.owner.get(c.id) as string) as ParticipantBase} />)\r\n  const {t} = useTranslation()\r\n  const textColor = useObserver(() => isDarkColor(roomInfo.backgroundFill) ? 'white' : 'black')\r\n\r\n  return <div className={classes.container} >\r\n    <div className={classes.title} style={{color:textColor}}>{t('Contents')}</div>\r\n    {elements}\r\n  </div>\r\n}\r\nContentList.displayName = 'ContentList'\r\n","import {useStore} from '@hooks/ParticipantsStore'\r\nimport Box from '@material-ui/core/Box'\r\nimport Button from '@material-ui/core/Button'\r\nimport Checkbox from '@material-ui/core/Checkbox'\r\nimport DialogContent from '@material-ui/core/DialogContent'\r\nimport DialogTitle from '@material-ui/core/DialogTitle'\r\nimport FormControlLabel from '@material-ui/core/FormControlLabel'\r\nimport Popover, { PopoverProps } from '@material-ui/core/Popover'\r\nimport TextField from '@material-ui/core/TextField'\r\nimport {uploadToGyazo} from '@models/api/Gyazo'\r\nimport {useTranslation} from '@models/locales'\r\nimport {isDarkColor, rgb2Color} from '@models/utils'\r\nimport {isSmartphone} from '@models/utils/utils'\r\nimport {MapData} from '@stores/Map'\r\nimport {Observer} from 'mobx-react-lite'\r\nimport React, {useState} from 'react'\r\nimport {SketchPicker} from 'react-color'\r\n\r\nexport interface LocalParticipantFormProps extends PopoverProps{\r\n  close: () => void,\r\n  map: MapData\r\n}\r\n\r\nconst tfIStyle = {fontSize: isSmartphone() ? '2em' : '1em',\r\nheight: isSmartphone() ? '2em' : '1.5em'}\r\nconst tfDivStyle = {height: isSmartphone() ? '4em' : '3em'}\r\nconst tfLStyle = {fontSize: isSmartphone() ? '1em' : '1em'}\r\nconst iStyle = {fontSize: isSmartphone() ? '2.5rem' : '1rem'}\r\n\r\nexport const LocalParticipantForm: React.FC<LocalParticipantFormProps> = (props: LocalParticipantFormProps) => {\r\n  const participants = useStore()\r\n  const local = participants.local\r\n  const [file, setFile] = useState<File|null>()\r\n  const [showColorPicker, setShowColorPicker] = useState(false)\r\n  const [showTextColorPicker, setShowTextColorPicker] = useState(false)\r\n  const {t} = useTranslation()\r\n\r\n  function closeConfig(ev:Object, reason:string) {\r\n    if (reason === 'enter' || reason==='backdropClick'){\r\n      local.sendInformation()\r\n      local.saveInformationToStorage(true)\r\n    }\r\n    props.close()\r\n  }\r\n\r\n\r\n  const onKeyPress = (ev:React.KeyboardEvent) => {\r\n    if (ev.key === 'Enter') {\r\n      closeConfig(ev, 'enter')\r\n    }else if (ev.key === 'Esc' || ev.key === 'Escape') {\r\n      local.loadInformationFromStorage()\r\n    }\r\n  }\r\n  function clearAvatarSrc(ev: React.FormEvent) {\r\n    ev.preventDefault()\r\n    setFile(null)\r\n    local.information.avatarSrc = ''\r\n  }\r\n  function uploadAvatarSrc(ev: React.FormEvent) {\r\n    ev.preventDefault()\r\n    if (file) {\r\n      uploadToGyazo(file).then((url) => {\r\n        local.information.avatarSrc = url\r\n      })\r\n    }\r\n  }\r\n\r\n  const colorButton = React.useRef<HTMLButtonElement>(null)\r\n  const textColorButton = React.useRef<HTMLButtonElement>(null)\r\n  const {close, ...popoverProps} = props\r\n\r\n  return <Popover {...popoverProps} onClose={closeConfig}>\r\n    <DialogTitle>\r\n      <span  style={{fontSize: isSmartphone() ? '2.5em' : '1em'}}>\r\n        {t('lsTitle')}\r\n      </span>\r\n    </DialogTitle>\r\n    <DialogContent>\r\n      <Observer>{ ()=> {\r\n        const rgb = local.getColorRGB()\r\n        const textRgb = local.getTextColorRGB()\r\n        const textColor = isDarkColor(rgb) ? 'white' : 'black'\r\n        const backColor = isDarkColor(textRgb) ? 'lightgray' : 'gray'\r\n        //  console.log('render color picker', rgb)\r\n\r\n        return  <>\r\n          <TextField label={t('YourName')} multiline={false} value={local.information.name} style={tfDivStyle}\r\n            inputProps={{style: tfIStyle, autoFocus:true}} InputLabelProps={{style: tfLStyle}}\r\n            onChange={event => {local.information.name = event.target.value}}\r\n            onKeyPress={onKeyPress} fullWidth={true}\r\n          />\r\n          <Box mt={3}>\r\n            <div style={{fontSize:12}}>{t('lsColor')}</div>\r\n            <Box ml={2}>\r\n              <Button variant=\"contained\"\r\n                style={{backgroundColor:rgb2Color(rgb), color:textColor, textTransform:'none'}}\r\n                onClick={()=>{setShowColorPicker(true)}} ref={colorButton}>\r\n                {t('lsColorAvatar')}</Button>\r\n              <Popover open={showColorPicker} onClose={()=>{setShowColorPicker(false)}}\r\n                anchorEl={colorButton.current} anchorOrigin={{vertical:'bottom', horizontal:'right'}}>\r\n                <SketchPicker color = {{r:rgb[0], g:rgb[1], b:rgb[2]}} disableAlpha\r\n                  onChange={(color, event)=>{\r\n                    event.preventDefault()\r\n                    local.information.color = [color.rgb.r, color.rgb.g, color.rgb.b]\r\n                  }}\r\n                  />\r\n              </Popover>\r\n              <Button variant=\"contained\"\r\n                style={{color:rgb2Color(textRgb), backgroundColor:backColor, marginLeft:15, textTransform:'none'}}\r\n                onClick={()=>{setShowTextColorPicker(true)}} ref={textColorButton}>\r\n                {t('lsColorText')}</Button>\r\n              <Popover open={showTextColorPicker} anchorOrigin={{vertical:'bottom', horizontal:'right'}}\r\n                onClose={()=>{setShowTextColorPicker(false)}} anchorEl={textColorButton.current}>\r\n                <SketchPicker color = {{r:textRgb[0], g:textRgb[1], b:textRgb[2]}}\r\n                  onChange={(color, event)=>{\r\n                    event.preventDefault()\r\n                    local.information.textColor = [color.rgb.r, color.rgb.g, color.rgb.b]\r\n                  }}\r\n                />\r\n              </Popover>\r\n              <Button variant=\"contained\" style={{marginLeft:15, textTransform:'none'}}\r\n                onClick={()=>{local.information.color=[]; local.information.textColor=[]}} >\r\n                {t('lsAutoColor')}</Button>\r\n            </Box>\r\n          </Box>\r\n          <Box mt={3}>\r\n            <div style={{fontSize:12}}>{t('lsImage')}</div>\r\n            <Box mt={-1} ml={2}>\r\n              <form key=\"information\" onSubmit = {uploadAvatarSrc}\r\n                style={{lineHeight:'2em', fontSize: isSmartphone() ? '2.5em' : '1em'}}>\r\n                <div style={{fontSize:12, marginTop:8}}>{t('lsImageFile')}</div>\r\n                {local.information.avatarSrc ? <>\r\n                  <img src={local.information.avatarSrc} style={{height:'1.5em', verticalAlign:'middle'}} alt=\"avatar\"/>\r\n                  <input style={iStyle} type=\"submit\" onClick={clearAvatarSrc} value=\"\" /> &nbsp;\r\n                </> : undefined}\r\n                <input style={iStyle} type=\"file\" onChange={(ev) => {\r\n                  setFile(ev.target.files?.item(0))\r\n                }} />\r\n                <input style={iStyle} type=\"submit\" value=\"Upload\" />\r\n              </form>\r\n              <TextField label={t('lsEmail')} multiline={false} value={local.info.email}\r\n                style={{...tfDivStyle, marginTop:8}}\r\n                inputProps={{style: tfIStyle, autoFocus:true}} InputLabelProps={{style: tfLStyle}}\r\n                onChange={event => local.info.email = event.target.value}\r\n                onKeyPress={onKeyPress} fullWidth={true}\r\n              />\r\n            </Box>\r\n          </Box>\r\n          <Box mt={3}>\r\n            <div style={{fontSize:12}}>{t('lsNotification')}</div>\r\n            <Box mt={-1} ml={2}>\r\n            <FormControlLabel control={\r\n              <Checkbox color=\"primary\" checked={local.information.notifyCall}\r\n              onChange={(ev)=>{local.information.notifyCall = ev.target.checked}} />\r\n              } label={t('lsNotifyCall')} />\r\n            <FormControlLabel control={\r\n              <Checkbox color=\"primary\" checked={local.information.notifyTouch}\r\n                onChange={(ev)=>{local.information.notifyTouch = ev.target.checked}} />\r\n              } label={t('lsNotifyTouch')} />\r\n            <FormControlLabel control={\r\n              <Checkbox color=\"primary\" checked={local.information.notifyNear}\r\n                onChange={(ev)=>{local.information.notifyNear = ev.target.checked}} />\r\n              } label={t('lsNotifyNear')} />\r\n            <FormControlLabel control={\r\n              <Checkbox color=\"primary\" checked={local.information.notifyYarn}\r\n                onChange={(ev)=>{local.information.notifyYarn = ev.target.checked}} />\r\n              } label={t('lsNotifyYarn')} />\r\n            </Box>\r\n          </Box>\r\n        </>}}\r\n      </Observer>\r\n      <Box mt={4} mb={3}>\r\n        <Button variant=\"contained\" color=\"primary\" style={{textTransform:'none'}}\r\n          onClick={()=>{\r\n            closeConfig({}, 'enter')\r\n          }}>{t('btSave')}</Button>\r\n        <Button variant=\"contained\" color=\"secondary\" style={{marginLeft:15, textTransform:'none'}}\r\n          onClick={()=>{ local.loadInformationFromStorage()}}>{t('btCancel')}</Button>\r\n        <Button variant=\"contained\" style={{marginLeft:15, textTransform:'none'}}\r\n          onClick={()=>{\r\n            props.map.focusOn(local)\r\n          }}>{t('ctFocus')}</Button>\r\n      </Box>\r\n    </DialogContent>\r\n  </Popover>\r\n}\r\n","import { TextField } from '@material-ui/core'\r\nimport Box from '@material-ui/core/Box'\r\nimport Button from '@material-ui/core/Button'\r\nimport DialogContent from '@material-ui/core/DialogContent'\r\nimport DialogTitle from '@material-ui/core/DialogTitle'\r\nimport Popover, { PopoverProps } from '@material-ui/core/Popover'\r\nimport {connection} from '@models/api'\r\nimport {MessageType} from '@models/api/MessageType'\r\nimport {t} from '@models/locales'\r\nimport chat from '@stores/Chat'\r\nimport {MapData} from '@stores/Map'\r\nimport participants from '@stores/participants/Participants'\r\nimport {RemoteParticipant} from '@stores/participants/RemoteParticipant'\r\nimport roomInfo from '@stores/RoomInfo'\r\nimport contents from '@stores/sharedContents/SharedContents'\r\nimport React from 'react'\r\n\r\nexport interface RemoteParticipantFormProps extends PopoverProps{\r\n  close: () => void,\r\n  participant?: RemoteParticipant\r\n  map: MapData\r\n}\r\n\r\nexport const RemoteParticipantForm: React.FC<RemoteParticipantFormProps> = (props: RemoteParticipantFormProps) => {\r\n  const [kick, setKick] = React.useState<string>('')\r\n  const [clear, setClear] = React.useState<string>('')\r\n  function onKeyPressKick(ev:React.KeyboardEvent){\r\n    if (ev.key === 'Enter' && kick === 'kick') {\r\n      if (!props.participant) { return }\r\n      connection.conference.kickParticipant(props.participant.id)\r\n      setTimeout(()=>{connection.conference.sendMessage(\r\n        MessageType.KICK, 'Kicked by administrator.', props.participant!.id)}, 5000)\r\n      props.close()\r\n    }\r\n  }\r\n  function onKeyPressClear(ev:React.KeyboardEvent){\r\n    if (ev.key === 'Enter' && clear === 'clear') {\r\n      if (!props.participant) { return }\r\n      const participant = contents.participants.get(props.participant.id)\r\n      participant?.myContents.forEach(c => contents.removeByLocal(c.id))\r\n      props.close()\r\n    }\r\n  }\r\n  function closeConfig(ev:Object, reason:string) {\r\n    if (reason === 'enter' || reason==='backdropClick'){\r\n    }\r\n    props.close()\r\n  }\r\n\r\n  const popoverProps = Object.assign({}, props)\r\n  delete (popoverProps as Partial<RemoteParticipantFormProps>).close\r\n\r\n  return <Popover {...popoverProps} onClose={closeConfig}>\r\n    <DialogTitle>\r\n      {props.participant?.information.name}\r\n    </DialogTitle>\r\n    <DialogContent>\r\n      <Box mb={2}>\r\n      <Button variant=\"contained\" style={{textTransform:'none'}}\r\n          onClick={()=>{\r\n            closeConfig({}, 'enter')\r\n            props.participant?.call()\r\n          }}>{t('rsCall')}</Button>\r\n      </Box>\r\n      <Box mb={2}>\r\n      <Button variant=\"contained\" style={{textTransform:'none'}}\r\n        onClick={()=>{\r\n          if (!props.participant) { return }\r\n          if (participants.yarnPhones.has(props.participant.id)){\r\n            participants.yarnPhones.delete(props.participant.id)\r\n          }else{\r\n            participants.yarnPhones.add(props.participant.id)\r\n          }\r\n          closeConfig({}, 'enter')\r\n        }}>\r\n          {props.participant && participants.yarnPhones.has(props.participant.id) ?\r\n            t('rsCutYarnPhone') : t('rsConnectYarnPhone')}</Button>\r\n      </Box>\r\n      <Box mb={2}>\r\n      <Button variant=\"contained\" style={{textTransform:'none'}}\r\n        onClick={()=>{\r\n          if (!props.participant) { return }\r\n          chat.sendTo = props.participant.id\r\n          closeConfig({}, 'enter')\r\n        }}>\r\n          {t('rsChatTo', {name: props.participant?.information.name})}</Button>\r\n      </Box>\r\n      <Box mb={2}>\r\n      <Button variant=\"contained\" style={{textTransform:'none'}}\r\n      onClick={()=>{\r\n        if (!props.participant) { return }\r\n        props.map.focusOn(props.participant)\r\n      }}>{t('ctFocus')}</Button>\r\n      </Box>\r\n      { roomInfo.passMatched && <>\r\n          <Box mb={2}>\r\n            To kick this user type 'kick' and enter. &thinsp;\r\n            <TextField label=\"kick\" type=\"text\" style={{marginTop:-22}}\r\n              value={kick} onChange={(ev)=>{setKick(ev.currentTarget.value)}} onKeyPress={onKeyPressKick}\r\n            />\r\n          </Box>\r\n          <Box mb={2}>\r\n            Clear this user's contents.&thinsp;\r\n            <TextField label=\"clear\" type=\"text\" style={{marginTop:-22}}\r\n              value={clear} onChange={(ev)=>{setClear(ev.currentTarget.value)}} onKeyPress={onKeyPressClear}\r\n            />\r\n         </Box>\r\n        </>\r\n      }\r\n    </DialogContent>\r\n  </Popover>\r\n}\r\n","import Button from '@material-ui/core/Button'\r\nimport Paper from '@material-ui/core/Paper'\r\nimport Popper, { PopperProps } from '@material-ui/core/Popper'\r\nimport { connection } from '@models/api'\r\nimport React from 'react'\r\nimport {useState} from 'react'\r\nimport {Stores} from '../utils'\r\n\r\ndeclare const config:any             //  from ../../config.js included from index.html\r\n\r\nexport interface StatusDialogProps extends Omit<PopperProps, 'children'>, Stores{\r\n  close: () => void,\r\n}\r\n\r\nclass Remote{\r\n  address = ''\r\n  port = 0\r\n  protocol = ''\r\n}\r\nclass Session{\r\n  remotes: Remote[] = []\r\n}\r\nclass Status{\r\n  sessions: Session[] = []\r\n  open = false\r\n  update = false\r\n  interval: NodeJS.Timeout|undefined = undefined\r\n  messageServer = ''\r\n}\r\nconst status = new Status()\r\n\r\nexport const StatusDialog: React.FC<StatusDialogProps> = (props: StatusDialogProps) => {\r\n  const [update,setUpdate] = useState<boolean>(false)\r\n  status.open = props.open === true\r\n  status.update = update\r\n\r\n  function updateStatus(){\r\n    const chatRoom = connection.conference._jitsiConference?.room\r\n    if (status.open && chatRoom){\r\n      const sessions = chatRoom.xmpp?.connection?.jingle?.sessions\r\n      const nSessions = Object.keys(sessions).length\r\n      status.sessions.splice(nSessions)\r\n      while (status.sessions.length < nSessions){ status.sessions.push(new Session()) }\r\n      for(const id in sessions){\r\n        const pc = sessions[id]?.peerconnection?.peerconnection as RTCPeerConnection\r\n        if (pc){\r\n          pc.getStats().then((stats) => {\r\n            const pairs: any[] = []\r\n            stats.forEach((v, k) => {\r\n              if (v.type === 'candidate-pair' && (v.bytesReceived > 0 || v.bytesSent > 0)) {\r\n                pairs.push(v)\r\n              }\r\n            })\r\n            const remoteCandidateIds = pairs.map(p => p.remoteCandidateId)\r\n            const sess = status.sessions[status.sessions.length-1]\r\n            sess.remotes=[]\r\n            remoteCandidateIds.forEach(id => {\r\n              const remote = new Remote()\r\n              const v = stats.get(id)\r\n              remote.address = v.address\r\n              remote.port = v.port\r\n              remote.protocol = v.protocol\r\n              sess.remotes.push(remote)\r\n            })\r\n          })\r\n        }\r\n      }\r\n      setUpdate(status.update ? false : true)\r\n    }\r\n    if (connection.conference.bmRelaySocket?.readyState === WebSocket.OPEN) {\r\n      status.messageServer = config.bmRelayServer\r\n    }else{\r\n      const chatRoom = connection.conference._jitsiConference?.room\r\n      if (status.open && chatRoom){\r\n        status.messageServer = 'bridge'\r\n      }else{\r\n        status.messageServer = 'prosody'\r\n      }\r\n    }\r\n  }\r\n  if (props.open){\r\n    if (!status.interval){\r\n      status.interval = setInterval(updateStatus, 100)\r\n      console.log('setInterval')\r\n    }\r\n  }else{\r\n    if (status.interval){\r\n      clearInterval(status.interval)\r\n      status.interval = undefined\r\n      console.log('clearInterval')\r\n    }\r\n  }\r\n  const {close, ...poperProps} = props\r\n\r\n  return <Popper {...poperProps}>\r\n    <Paper style={{background:'rgba(255,255,255,0.6)', padding:'0.4em'}}>\r\n      <div style={{overflowY:'auto'}}>\r\n        <strong>Servers</strong><br />\r\n        {status.sessions.length === 0 ? <div>No WebRTC</div> :\r\n        status.sessions.map((sess, idx) => <div key={idx}>\r\n          WebRTC: {sess.remotes.map((r,k) => <span key={k.toString()}>{r.address} {r.port}/{r.protocol}<br /></span>)}\r\n        </div>)}\r\n        <div> Message: {status.messageServer}</div>\r\n      </div>\r\n      <Button variant=\"contained\" color=\"primary\" style={{textTransform:'none', marginTop:'0.4em'}}\r\n        onClick={close}\r\n        > Close </Button>\r\n\r\n    </Paper>\r\n  </Popper>\r\n}\r\n","import {ImageAvatar} from '@components/avatar/ImageAvatar'\r\nimport {LocalParticipantForm} from '@components/map/ParticipantsLayer/LocalParticipantForm'\r\nimport {RemoteParticipantForm} from '@components/map/ParticipantsLayer/RemoteParticipantForm'\r\nimport {Tooltip} from '@material-ui/core'\r\nimport {connection} from '@models/api'\r\nimport { MessageType } from '@models/api/MessageType'\r\nimport {getColorOfParticipant} from '@models/Participant'\r\nimport {isDarkColor} from '@models/utils'\r\nimport {ParticipantBase} from '@stores/participants/ParticipantBase'\r\nimport roomInfo from '@stores/RoomInfo'\r\nimport { autorun } from 'mobx'\r\nimport {useObserver} from 'mobx-react-lite'\r\nimport React from 'react'\r\nimport {Stores} from '../utils'\r\nimport {styleForList} from '../utils/styles'\r\nimport {TextLineStyle} from './LeftBar'\r\nimport {StatusDialog} from './StatusDialog'\r\n\r\n// config.js\r\ndeclare const config:any             //  from ../../config.js included from index.html\r\n\r\nexport const ParticipantLine: React.FC<TextLineStyle&Stores&{participant: ParticipantBase}> = (props) => {\r\n  const name = useObserver(() => (props.participant.information.name))\r\n  const avatarSrc = useObserver(() => (props.participant.information.avatarSrc))\r\n  const colors = useObserver(() => getColorOfParticipant(props.participant.information))\r\n  const size = useObserver(() => props.lineHeight)\r\n  const classes = styleForList({height:props.lineHeight, fontSize:props.fontSize})\r\n  const [showForm, setShowForm] = React.useState(false)\r\n  const ref = React.useRef<HTMLDivElement>(null)\r\n  //  console.log(`PColor pid:${props.participant.id} colors:${colors}`, props.participant)\r\n\r\n  return <>\r\n    <Tooltip title={props.participant.id} placement=\"right\">\r\n      <div className={classes.outer} ref={ref}\r\n        onClick={() => {\r\n          if (props.participant.physics.located){\r\n            props.map.focusOn(props.participant)\r\n          }else{\r\n            if(config.bmRelayServer){\r\n              // sendMessageViaRelay\r\n              connection.conference.pushOrUpdateMessageViaRelay(\r\n                MessageType.REQUEST_PARTICIPANT_STATES, [props.participant.id])\r\n            }\r\n            const disposer = autorun(()=>{\r\n              if (props.participant.physics.located){\r\n                props.map.focusOn(props.participant)\r\n                disposer()\r\n              }\r\n            })\r\n          }\r\n        }}\r\n        onContextMenu={() => {\r\n          if (props.participant.physics.located){\r\n            setShowForm(true)\r\n            props.map.keyInputUsers.add('participantList')\r\n          }else{\r\n            if(config.bmRelayServer){\r\n              //sendMessageViaRelay\r\n              connection.conference.pushOrUpdateMessageViaRelay(\r\n                MessageType.REQUEST_PARTICIPANT_STATES, [props.participant.id])\r\n            }\r\n            const disposer = autorun(()=>{\r\n              if (props.participant.physics.located){\r\n                setShowForm(true)\r\n                props.map.keyInputUsers.add('participantList')\r\n                disposer()\r\n              }\r\n            })\r\n          }\r\n        }}>\r\n        <ImageAvatar border={true} colors={colors} size={size * 1.05}\r\n          name={name} avatarSrc={avatarSrc} />\r\n        <div className={classes.line} style={{backgroundColor:colors[0], color:colors[1], width:'100%'}}>\r\n          {name}\r\n        </div>\r\n      </div>\r\n    </Tooltip>\r\n    {props.participant.id === props.participants.localId ?\r\n      <LocalParticipantForm map={props.map} open={showForm} close={()=>{\r\n        setShowForm(false)\r\n        props.map.keyInputUsers.delete('participantList')\r\n      }} anchorEl={ref.current} anchorOrigin={{vertical:'top', horizontal:'right'}} /> :\r\n      <RemoteParticipantForm {...props} open={showForm} close={()=>{\r\n        setShowForm(false)\r\n        props.map.keyInputUsers.delete('participantList')\r\n      }} participant={props.participants.remote.get(props.participant.id)}\r\n        anchorEl={ref.current} anchorOrigin={{vertical:'top', horizontal:'right'}} />\r\n    }\r\n  </>\r\n}\r\n\r\nexport const RawParticipantList: React.FC<Stores&TextLineStyle&{localId: string, remoteIds: string[]}> = (props) => {\r\n  const [showStat, setShowStat] = React.useState(false)\r\n  const store = props.participants\r\n  const classes = styleForList({height: props.lineHeight, fontSize: props.fontSize})\r\n  const {localId, remoteIds, lineHeight, fontSize, ...statusProps} = props\r\n  const textColor = useObserver(() => isDarkColor(roomInfo.backgroundFill) ? 'white' : 'black')\r\n\r\n  remoteIds.sort((a, b) => {\r\n    const pa = store.remote.get(a)\r\n    const pb = store.remote.get(b)\r\n    let rv = pa!.information.name.localeCompare(pb!.information.name, undefined, {sensitivity: 'accent'})\r\n    if (rv === 0) {\r\n      rv = (pa!.information.avatarSrc || '').localeCompare(pb!.information.avatarSrc || '', undefined, {sensitivity: 'accent'})\r\n    }\r\n\r\n    return rv\r\n  })\r\n  const remoteElements = remoteIds.map(id =>\r\n    <ParticipantLine key={id}\r\n      participant={store.remote.get(id)!}\r\n      {...props} />)\r\n  const localElement = (<ParticipantLine key={localId} participant={store.local} {...props} />)\r\n  const ref = React.useRef<HTMLDivElement>(null)\r\n\r\n  return (\r\n    <div className={classes.container} >\r\n      <div className={classes.title} style={{color:textColor}} ref={ref}\r\n        onClick={()=>{setShowStat(true)}}\r\n      >{(store.remote.size + 1).toString()} in {connection.conference.name}</div>\r\n      <StatusDialog open={showStat}\r\n        close={()=>{setShowStat(false)}} {...statusProps} anchorEl={ref.current}/>\r\n      {localElement}{remoteElements}\r\n    </div>\r\n  )\r\n}\r\nRawParticipantList.displayName = 'ParticipantList'\r\n\r\nexport const ParticipantList = React.memo<Stores&TextLineStyle>(\r\n  (props) => {\r\n    const localId = useObserver(() => props.participants.localId)\r\n    const ids = useObserver(() => Array.from(props.participants.remote.keys()))\r\n\r\n    return <RawParticipantList {...props} localId={localId} remoteIds = {ids} />\r\n  },\r\n)\r\n","import React, {useState, useEffect} from 'react'\r\nimport SplitPane from 'react-split-pane'\r\nimport {useGesture} from 'react-use-gesture'\r\nimport {Stores} from '../utils'\r\nimport {styleForSplit} from '../utils/styles'\r\nimport {ChatInBar} from './Chat'\r\nimport {ContentList} from './ContentList'\r\nimport {ParticipantList} from './ParticipantList'\r\nimport { rgb2Color } from '@models/utils'\r\nimport roomInfo from '@stores/RoomInfo'\r\n\r\n\r\nexport interface TextLineStyle {\r\n  lineHeight: number\r\n  fontSize: number\r\n}\r\nconst defaultTextLineHeight = {\r\n  lineHeight:20,\r\n  fontSize:16,\r\n}\r\n\r\nfunction limitScale(currentScale: number, scale: number): number {\r\n  const targetScale = currentScale * scale\r\n  const maxScale = 4\r\n  const minScale = 0.5\r\n\r\n  if (targetScale > maxScale) { return maxScale }\r\n  if (targetScale < minScale) { return minScale }\r\n\r\n  return targetScale\r\n}\r\nconst textLineStyle = Object.assign({}, defaultTextLineHeight)\r\n\r\nexport const LeftBar: React.FC<Stores> = (stores) => {\r\n  const classes = styleForSplit()\r\n  const [scale, doSetScale] = useState<number>(1)\r\n  \r\n  const setScale = (scale:number) => {\r\n    Object.assign(textLineStyle, defaultTextLineHeight)\r\n    textLineStyle.fontSize *= scale\r\n    textLineStyle.lineHeight *= scale\r\n    doSetScale(scale)\r\n  }\r\n\r\n  const bind = useGesture(\r\n    {\r\n\r\n      onClickCapture: ()=>{\r\n        stores.contents.setEditing('')\r\n      },\r\n      onPinch: ({da: [d, a], origin, event, memo}) => {\r\n        if (memo === undefined) {\r\n          return [d, a]\r\n        }\r\n        const [md] = memo\r\n\r\n        const MIN_D = 10\r\n        const scaleChange = d > MIN_D ? d / md : d <  -MIN_D ? md / d : (1 + (d - md) / MIN_D)\r\n        setScale(limitScale(scale, scaleChange))\r\n        //  console.log(`Pinch: da:${[d, a]} origin:${origin}  memo:${memo}  scale:${scale}`)\r\n\r\n        return [d, a]\r\n      },\r\n    },\r\n    {\r\n      eventOptions:{passive:false}, //  This prevents default zoom by browser when pinch.\r\n    },\r\n  )\r\n\r\n  /* \r\n  //  keyboard shortcut\r\n  useEffect(() => {\r\n    const onKeyPress = (e: KeyboardEvent) => {\r\n      e.preventDefault();\r\n      if(e.key.toString() === \"F3\") {\r\n      }\r\n    }\r\n    window.addEventListener('keydown', onKeyPress)\r\n\r\n    return () => {\r\n      window.removeEventListener('keydown', onKeyPress)\r\n    }\r\n    //  eslint-disable-next-line react-hooks/exhaustive-deps\r\n  },        [])\r\n */\r\n\r\n  return (\r\n    <div {...bind()} style={{backgroundColor: rgb2Color(roomInfo.backgroundLeftFill)}}>\r\n      <SplitPane split=\"horizontal\" defaultSize=\"80%\" resizerClassName = {classes.resizerHorizontal}\r\n        paneStyle = {{overflowY: 'auto', overflowX: 'hidden', width:'100%'}} >\r\n        <SplitPane split=\"horizontal\" defaultSize=\"50%\" resizerClassName = {classes.resizerHorizontal}\r\n          paneStyle = {{overflowY: 'auto', overflowX: 'hidden', width:'100%'}} >\r\n          <ParticipantList {...stores} {...textLineStyle} />\r\n          <ContentList {...stores}  {...textLineStyle} />\r\n        </SplitPane >\r\n        <ChatInBar {...stores}  {...textLineStyle} />\r\n      </SplitPane >\r\n    </div>\r\n  )\r\n}\r\nLeftBar.displayName = 'LeftBar'\r\n","import {useStore as useContentsStore} from '@hooks/SharedContentsStore'\r\nimport {makeStyles} from '@material-ui/core'\r\nimport TraceablePeerConnection from 'lib-jitsi-meet/modules/RTC/TraceablePeerConnection'\r\nimport _ from 'lodash'\r\nimport {useObserver} from 'mobx-react-lite'\r\nimport React, {useEffect, useRef, useState} from 'react'\r\n\r\ndeclare const d:any                  //  from index.html\r\n\r\nconst useStyles = makeStyles({\r\n  videoContainer: {\r\n    height: '100%',\r\n    width: '100%',\r\n    backgroundColor: 'none',\r\n  },\r\n  video:{\r\n    marginLeft: 'auto',\r\n    marginRight: 'auto',\r\n    display: 'block',\r\n    //  height: '100%',\r\n    width: '100%',\r\n  },\r\n})\r\n\r\nconst setStream = (\r\n  video: HTMLVideoElement,\r\n  stream: MediaStream | null,\r\n  ) => {\r\n  video.srcObject = stream\r\n  video.autoplay = true\r\n}\r\nexport interface MainScreenProps{\r\n  showAllTracks?:boolean\r\n}\r\n\r\nexport const MainScreen: React.FC<MainScreenProps> = (props) => {\r\n  const classes = useStyles()\r\n  const store = useContentsStore()\r\n  const stream = useObserver(() => (store.tracks.mainStream))\r\n  const videoRef = useRef<HTMLVideoElement>(null)\r\n  useEffect(\r\n    () => {\r\n      if (videoRef && videoRef.current) {\r\n        setStream(videoRef.current, stream ? stream : null)\r\n      }\r\n    },\r\n    [stream],\r\n  )\r\n  //  for showAllTracks (or DEBUG_VIDEO) ---------------------------------------\r\n  interface DebugVideo{\r\n    stream: MediaStream\r\n    label: string\r\n    color: string\r\n  }\r\n  const [debugVideos, setDebugVideos] = useState<DebugVideo[]>()\r\n  const member = useRef<any>({})\r\n  member.current.debugVideos = debugVideos\r\n  const refs = useRef<React.RefObject<HTMLVideoElement>[]>([])\r\n\r\n  if (props.showAllTracks) {\r\n    while (refs.current.length < (debugVideos ? debugVideos.length : 0)) {\r\n      refs.current.push(React.createRef<HTMLVideoElement>())\r\n    }\r\n    refs.current.forEach((ref, idx) => {\r\n      if (ref.current && debugVideos && idx < debugVideos.length) {\r\n        setStream(ref.current, debugVideos[idx].stream)\r\n        //  console.log(`setStream for ${idx} ${ref.current}`)\r\n      }\r\n    })\r\n  }\r\n  useEffect(\r\n    () => {\r\n      if (props.showAllTracks) {\r\n        const INTERVAL = 1000\r\n        if (member.current?.interval){\r\n          clearInterval(member.current.interval)\r\n          member.current.interval = undefined\r\n        }\r\n        member.current.interval = setInterval(() => {\r\n          const tpc = d.tpc as TraceablePeerConnection\r\n          if (!tpc || !tpc.peerconnection) { return }\r\n\r\n          const newVideos:DebugVideo[] = []\r\n          const localStreams = new Set((tpc.peerconnection as any).getLocalStreams() as MediaStream[])\r\n          const remoteStreams = new Set((tpc.peerconnection as any).getRemoteStreams() as MediaStream[])\r\n          tpc.localTracks.forEach((track, id) => {\r\n            const stream = track.getOriginalStream()\r\n            const ok = localStreams.delete(stream)\r\n            newVideos.push({\r\n              stream,\r\n              // tslint:disable-next-line: prefer-template\r\n              label: `Local ssrc:${tpc.getLocalSSRC(track)}\\ntype:${track.getType()}\\n`\r\n              + `videoType:${track.videoType}\\nmsid:${stream?.id}`\r\n              + (ok ? 'OK' : ' NOT in pc'),\r\n              color:'blue',\r\n            })\r\n          })\r\n\r\n          for (const stream of localStreams.values()) {\r\n            newVideos.push({\r\n              stream,\r\n              // tslint:disable-next-line: prefer-template\r\n              label: `Local X msid:${stream?.id}`,\r\n              color:'red',\r\n            })\r\n          }\r\n\r\n          tpc.remoteTrackMaps.forEach((remoteTrackMap) => {\r\n            remoteTrackMap.forEach((track, id) => {\r\n              const stream = track.getOriginalStream()\r\n              const ok = remoteStreams.delete(stream)\r\n              newVideos.push({\r\n                stream,\r\n                // tslint:disable-next-line: prefer-template\r\n                label: `Remote ssrc:${track.getSSRC()}\\ntype:${track.getType()}\\n`\r\n                + `videoType:${track.videoType}\\nmsid:${stream?.id}`\r\n                + (ok ? 'OK' : ' NOT in pc'),\r\n                color:'red',\r\n              })\r\n            })\r\n          })\r\n\r\n          for (const stream of remoteStreams.values()) {\r\n            newVideos.push({\r\n              stream,\r\n              // tslint:disable-next-line: prefer-template\r\n              label: `Remote X msid:${stream?.id}`,\r\n              color:'blue',\r\n            })\r\n          }\r\n\r\n          const elementFlags = refs.current.map(e => e ? true : false)\r\n          if (!_.isEqual(member.current.elementFlags, elementFlags)\r\n            || !_.isEqual(member.current.debugVideos, newVideos)) {\r\n            // console.log(member.current.debugVideos, newVideos)\r\n            setDebugVideos(newVideos)\r\n            member.current.elementFlags = _.cloneDeep(elementFlags)\r\n          }\r\n        },                                    INTERVAL)\r\n      }else {\r\n        if (member.current?.interval) {\r\n          clearInterval(member.current.interval)\r\n          member.current.interval = undefined\r\n        }\r\n      }\r\n    },\r\n    [props.showAllTracks],\r\n  )\r\n\r\n  const videos = (props.showAllTracks && debugVideos) ? debugVideos.map((debugVideo, idx) =>\r\n    <div key={idx} style={{display:'inline-block', position:'relative', verticalAlign:'top'}}>\r\n      <video style={{width:300}} ref={refs.current[idx]} />\r\n      <div style={{position:'absolute', left:0, top:0,\r\n        color:debugVideo.color, whiteSpace: 'pre-wrap'}}>\r\n        {debugVideo.label}\r\n      </div>\r\n    </div>,\r\n    ) : undefined\r\n  //  -----------------------------------------------------------------------\r\n\r\n  return (\r\n    <div className={classes.videoContainer} >\r\n      <video ref={videoRef} className={classes.video} style={{visibility : stream ? 'visible' : 'hidden'} } />\r\n      <div style={{position:'absolute', left:0, top:0}}>\r\n        {videos /* for DEBUG_VIDEO */}\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\nMainScreen.displayName = 'MainScreen'\r\n","import {BaseProps as BP} from '@components/utils'\r\nimport {useStore as useMapStore} from '@hooks/MapStore'\r\nimport {useStore} from '@hooks/ParticipantsStore'\r\nimport {makeStyles} from '@material-ui/core/styles'\r\nimport {PARTICIPANT_SIZE} from '@models/Participant'\r\nimport {\r\n  crossProduct, extractRotation, extractScaleX,\r\n  radian2Degree, rotate90ClockWise, rotateVector2D, transformPoint2D, transfromAt, vectorLength,\r\n} from '@models/utils'\r\nimport {addV2, mulV2, normV, subV2} from '@models/utils/coordinates'\r\nimport {useObserver} from 'mobx-react-lite'\r\nimport React, {useEffect, useRef} from 'react'\r\nimport ResizeObserver from 'react-resize-observer'\r\nimport {useGesture} from 'react-use-gesture'\r\n//import { keys, parseInt } from 'lodash'\r\n//import { RemoteParticipant } from '@stores/participants/RemoteParticipant'\r\n\r\n\r\n\r\n\r\n//  utility\r\nfunction limitScale(currentScale: number, scale: number): number {\r\n  const targetScale = currentScale * scale\r\n\r\n  if (targetScale > options.maxScale) {\r\n    return options.maxScale / currentScale\r\n  }\r\n\r\n  if (targetScale < options.minScale) {\r\n    return options.minScale / currentScale\r\n  }\r\n\r\n  return scale\r\n}\r\n\r\ninterface StyleProps {\r\n  matrix: DOMMatrixReadOnly,\r\n}\r\n\r\nconst useStyles = makeStyles({\r\n  root: {\r\n    position: 'absolute',\r\n    width: '100%',\r\n    height: '100%',\r\n    top: 0,\r\n    left: 0,\r\n    userDrag: 'none',\r\n    userSelect: 'none',\r\n    overflow: 'hidden',\r\n  },\r\n  center:{\r\n    position: 'absolute',\r\n    margin: 'auto',\r\n    left:0, right:0, top:0, bottom:0,\r\n    width:0, height:0,\r\n  },\r\n  transform: (props: StyleProps) => ({\r\n    position: 'absolute',\r\n    width:0, height:0,\r\n    transform: props.matrix.toString(),\r\n  }),\r\n})\r\n\r\ntype BaseProps = React.PropsWithChildren<BP>\r\n\r\nconst options = {\r\n  minScale: 0.2,\r\n  maxScale: 5,\r\n}\r\n\r\nclass BaseMember{\r\n  prebThirdPersonView = false\r\n  mouseDown = false\r\n  dragging = false\r\n  upTime = 0\r\n  downTime = 0\r\n\r\n  downXpos = 0\r\n  downYpos = 0\r\n\r\n  upXpos = 0\r\n  upYpos = 0\r\n}\r\n\r\nexport const Base: React.FC<BaseProps> = (props: BaseProps) => {\r\n  const mapStore = useMapStore()\r\n  const matrix = useObserver(() => mapStore.matrix)\r\n  const container = useRef<HTMLDivElement>(null)\r\n  const outer = useRef<HTMLDivElement>(null)\r\n  function offset():[number, number] {\r\n    return mapStore.offset\r\n  }\r\n  const participants = useStore()\r\n  const thirdPersonView = useObserver(() => participants.local.thirdPersonView)\r\n  const memRef = useRef<BaseMember>(new BaseMember())\r\n  const mem = memRef.current\r\n\r\n  \r\n\r\n \r\n\r\n  const center = transformPoint2D(matrix, participants.local.pose.position)\r\n  if (thirdPersonView !== mem.prebThirdPersonView) {\r\n    mem.prebThirdPersonView = thirdPersonView\r\n    if (thirdPersonView) {\r\n      const mapRot = radian2Degree(extractRotation(matrix))\r\n      if (mapRot) {\r\n        const newMatrix = rotateMap(-mapRot, center)\r\n        mapStore.setCommittedMatrix(newMatrix)\r\n      }\r\n    }else {\r\n      const avatarRot = participants.local.pose.orientation\r\n      const mapRot = radian2Degree(extractRotation(matrix))\r\n      if (avatarRot + mapRot) {\r\n        const newMatrix = rotateMap(-(avatarRot + mapRot), center)\r\n        mapStore.setCommittedMatrix(newMatrix)\r\n      }\r\n    }\r\n  }\r\n\r\n  //  utility\r\n  function rotateMap(degree:number, center:[number, number]) {\r\n    const changeMatrix = (new DOMMatrix()).rotateSelf(0, 0, degree)\r\n    const newMatrix = transfromAt(center, changeMatrix, matrix)\r\n    mapStore.setMatrix(newMatrix)\r\n\r\n    return newMatrix\r\n  }\r\n\r\n/* \r\n  function hasParticipantOverlapped() {\r\n    let found = false\r\n    const remotes = Array.from(participants.remote.keys()).filter(key => key !== participants.localId)\r\n    //remotes.forEach(pid=>(mapStore.mouseOnMap[0] === participants.remote.get(pid)?.pose.position[0] && mapStore.mouseOnMap[1] === participants.remote.get(pid)?.pose.position[1]) ? found=true : \"\")\r\n\r\n     for (const [i, pid] of remotes.entries()) {\r\n      if((mapStore.mouseOnMap[0] >= (participants.remote.get(pid)?.pose.position[0]-30)) && (mapStore.mouseOnMap[0] <= (participants.remote.get(pid)?.pose.position[0]+30)) && (mapStore.mouseOnMap[1] >= (participants.remote.get(pid)?.pose.position[1]-30)) && (mapStore.mouseOnMap[1] <= (participants.remote.get(pid)?.pose.position[1]+30))) {\r\n        found = true\r\n      }\r\n    }\r\n    return found\r\n  }\r\n */\r\n  //  Mouse and touch operations ----------------------------------------------\r\n  const MOUSE_LEFT = 1\r\n  const MOUSE_RIGHT = 2\r\n  \r\n  \r\n  \r\n  const bind = useGesture(\r\n    {\r\n      \r\n      onDragStart: ({buttons, xy}) => {\r\n        document.body.focus()\r\n        mem.dragging = true\r\n        mem.mouseDown = true\r\n        \r\n  \r\n        //  console.log('Base StartDrag:')\r\n        if (buttons === MOUSE_LEFT) {\r\n          //  move participant to mouse position\r\n          mem.downTime = new Date().getSeconds()\r\n\r\n          mem.downXpos = xy[0]\r\n          mem.downYpos = xy[1]\r\n          \r\n         //console.log(xy, \" down xy\")\r\n        \r\n          /* setTimeout(() => {\r\n            function moveParticipant(move: boolean) {\r\n             \r\n              if (mem.mouseDown) {\r\n                const local = participants.local\r\n\r\n                //console.log(mapStore.mouseOnMap, \" click\")\r\n\r\n                // Working Block\r\n                //const remote = ((participants.remote as Object))\r\n                const remotes = Array.from(participants.remote.keys()).filter(key => key !== participants.localId)\r\n                //remotes.forEach(pid=>console.log(participants.remote.get(pid)?.pose.position[0]))\r\n                //remotes.forEach(pid=>console.log(participants.remote.get(pid)?.pose.position[1], \"--\", mapStore.mouseOnMap[1]))\r\n\r\n                //remotes.forEach(pid=>(mapStore.mouseOnMap[0] === participants.remote.get(pid)?.pose.position[0] && mapStore.mouseOnMap[1] === participants.remote.get(pid)?.pose.position[1] ? console.log(participants.remote.get(pid)?.pose.position[1], \"--\", mapStore.mouseOnMap[1]) : console.log(\"no\")))\r\n\r\n\r\n                //let overlapped = hasParticipantOverlapped(participants)\r\n\r\n                //console.log(overlapped, \" overlapped\")\r\n\r\n                for (const [i, id] of remotes.entries()) {\r\n                  let remoteX = Number(participants.remote.get(remotes[i])?.pose.position[0])\r\n                  let remoteY = Number(participants.remote.get(remotes[i])?.pose.position[1])\r\n                  let mouseX = Number(mapStore.mouseOnMap[0])\r\n                  let mouseY = Number(mapStore.mouseOnMap[1])\r\n                  \r\n                  if(mouseX >= (remoteX-30) && mouseX <= (remoteX+30) && mouseY >= (remoteY-30) && mouseY <= (remoteY+30)) {\r\n                    //console.log(\"found\")\r\n                    return\r\n                  }\r\n                } */\r\n\r\n                //remotes.forEach(pid=>(mapStore.mouseOnMap[0] >= participants.remote.get(pid)?.pose.position[0]-30 && mapStore.mouseOnMap[0] <= )console.log(participants.remote.get(pid)?.pose.position[0], \"--\", mapStore.mouseOnMap[0]))\r\n                //remotes.forEach(pid=>mapStore.mouseOnMap[0] >= participants.remote.get(pid)?.pose.position[0]-30 && mapStore.mouseOnMap[0] <= participants.remote.get(pid)?.pose.position[0]+30) && (mapStore.mouseOnMap[1] >= participants.remote.get(pid)?.pose.position[1]-30 && mapStore.mouseOnMap[1] <= participants.remote.get(pid)?.pose.position[1]+30 ? console.log(participants.remote.get(pid)?.pose.position[0]) : console.log(\"move\"))\r\n                //remotes.forEach(pid=>console.log(participants.remote.get(pid)?.pose.position[0])\r\n\r\n/* \r\n                if (participants.remote.has(participants.)) {\r\n                  console.log(\"remote\")\r\n                } else {\r\n                  console.log(\"local : \", participants.localId, \" -- \", participants.remote.entries)\r\n                }\r\n */\r\n                /* const diff = subV2(mapStore.mouseOnMap, local.pose.position)\r\n                if (normV(diff) > PARTICIPANT_SIZE / 2) {\r\n                  const dir = mulV2(normV(diff) / normV(diff), diff)\r\n                  local.pose.orientation = Math.atan2(dir[0], -dir[1]) * 180 / Math.PI\r\n                  if (move) {\r\n                    local.pose.position = addV2(local.pose.position, dir)\r\n                  }\r\n                  local.savePhysicsToStorage(false)\r\n                }\r\n                const TIMER_INTERVAL = move ? 33 : 200\r\n                \r\n                setTimeout(() => { moveParticipant(true) }, TIMER_INTERVAL)\r\n              }\r\n            }\r\n            moveParticipant(false)\r\n          }, 200) */\r\n        }\r\n      },\r\n      onDrag: ({down, delta, xy, buttons}) => {\r\n        if (delta[0] || delta[1]) { mem.mouseDown = false }\r\n        //  if (mapStore.keyInputUsers.size) { return }\r\n        if (mem.dragging && down && outer.current) {\r\n          if (!thirdPersonView && buttons === MOUSE_RIGHT) {  // right mouse drag - rotate map\r\n            const center = transformPoint2D(matrix, participants.local.pose.position)\r\n            const target:[number, number] = addV2(xy, offset())\r\n            const radius1 = subV2(target, center)\r\n            const radius2 = subV2(radius1, delta)\r\n\r\n            const cosAngle = crossProduct(radius1, radius2) / (vectorLength(radius1) * vectorLength(radius2))\r\n            const flag = crossProduct(rotate90ClockWise(radius1), delta) > 0 ? -1 : 1\r\n            const angle = Math.acos(cosAngle) * flag\r\n            if (isNaN(angle)) {  // due to accuracy, angle might be NaN when cosAngle is larger than 1\r\n              return  // no need to update matrix\r\n            }\r\n\r\n            const newMatrix = rotateMap(radian2Degree(angle), center)\r\n            participants.local.pose.orientation = -radian2Degree(extractRotation(newMatrix))\r\n          } else {\r\n            // left mouse drag or touch screen drag - translate map\r\n            const diff = rotateVector2D(matrix.inverse(), delta)\r\n            const newMatrix = matrix.translate(...diff)\r\n            mapStore.setMatrix(newMatrix)\r\n            //  console.log('Base onDrag:', delta)\r\n          }\r\n        }\r\n      },\r\n      onDragEnd: ({event, currentTarget, delta,xy, buttons}) => {\r\n        if (mem.mouseDown) {\r\n          props.contents.setEditing('')\r\n        } \r\n        //console.log(Object(event?.target).tagName)\r\n        //console.log('Base onDragEnd:')\r\n\r\n        //console.log(mem.dragging, \" && \", outer.current, \"&&\", delta[0], \"&&\", delta[1])\r\n\r\n        mem.upXpos = xy[0]\r\n        mem.upYpos = xy[1]\r\n\r\n        //console.log(mem.downXpos, \" -- \", mem.downYpos, \" ==== \", mem.upXpos, \" --- \", mem.upYpos, \" LLL \", mem.mouseDown)\r\n\r\n        //console.log((mem.upXpos >= (mem.downXpos - 10) && mem.upXpos <= (mem.downXpos+10) && (mem.upYpos >= (mem.downYpos - 10) && mem.upYpos <= (mem.downYpos+10))))\r\n\r\n        //console.log(xy, \" up xy\")\r\n\r\n        mem.upTime = new Date().getSeconds()\r\n        //console.log(mem.downTime, \" -- \", mem.upTime)\r\n        let timeDiff = mem.upTime - mem.downTime;\r\n        //if(timeDiff === 1 && mem.mouseDown && String(Object(event?.target).tagName) === \"DIV\") {\r\n        //if((mem.upXpos >= (mem.downXpos - 10) && mem.upXpos <= (mem.downXpos+10) && (mem.upYpos >= (mem.downYpos - 10) && mem.upYpos <= (mem.downYpos+10))) && mem.mouseDown && String(Object(event?.target).tagName) === \"DIV\") {\r\n        if((mem.upXpos >= (mem.downXpos-20) && mem.upXpos <= (mem.downXpos+20) && (mem.upYpos >= (mem.downYpos-20) && mem.upYpos <= (mem.downYpos+20))) && String(Object(event?.target).tagName) === \"DIV\" && timeDiff < 2) {\r\n          const local = participants.local\r\n          const remotes = Array.from(participants.remote.keys()).filter(key => key !== participants.localId)\r\n          for (const [i, id] of remotes.entries()) {\r\n            let remoteX = Number(participants.remote.get(remotes[i])?.pose.position[0])\r\n            let remoteY = Number(participants.remote.get(remotes[i])?.pose.position[1])\r\n            let mouseX = Number(mapStore.mouseOnMap[0])\r\n            let mouseY = Number(mapStore.mouseOnMap[1])\r\n            if(mouseX >= (remoteX-30) && mouseX <= (remoteX+30) && mouseY >= (remoteY-30) && mouseY <= (remoteY+30)) {\r\n              return\r\n            }\r\n          }\r\n          const diff = subV2(mapStore.mouseOnMap, local.pose.position)\r\n          if (normV(diff) > PARTICIPANT_SIZE / 2) {\r\n            const dir = mulV2(normV(diff) / normV(diff), diff)\r\n            local.pose.orientation = Math.atan2(dir[0], -dir[1]) * 180 / Math.PI\r\n            //if (move) {\r\n            local.pose.position = addV2(local.pose.position, dir)\r\n            //}\r\n            local.savePhysicsToStorage(false)\r\n          }\r\n        }\r\n\r\n\r\n        /* \r\n        // Position Avatar\r\n        setTimeout(() => {\r\n          function moveParticipant(move: boolean) {\r\n           \r\n            if (!mem.mouseDown) {\r\n              const local = participants.local\r\n              const remotes = Array.from(participants.remote.keys()).filter(key => key !== participants.localId)\r\n              for (const [i, id] of remotes.entries()) {\r\n                let remoteX = Number(participants.remote.get(remotes[i])?.pose.position[0])\r\n                let remoteY = Number(participants.remote.get(remotes[i])?.pose.position[1])\r\n                let mouseX = Number(mapStore.mouseOnMap[0])\r\n                let mouseY = Number(mapStore.mouseOnMap[1])\r\n                if(mouseX >= (remoteX-30) && mouseX <= (remoteX+30) && mouseY >= (remoteY-30) && mouseY <= (remoteY+30)) {\r\n                  return\r\n                }\r\n              }\r\n              const diff = subV2(mapStore.mouseOnMap, local.pose.position)\r\n              if (normV(diff) > PARTICIPANT_SIZE / 2) {\r\n                const dir = mulV2(normV(diff) / normV(diff), diff)\r\n                local.pose.orientation = Math.atan2(dir[0], -dir[1]) * 180 / Math.PI\r\n                if (move) {\r\n                  local.pose.position = addV2(local.pose.position, dir)\r\n                }\r\n                local.savePhysicsToStorage(false)\r\n              }\r\n              const TIMER_INTERVAL = move ? 33 : 200\r\n              setTimeout(() => { moveParticipant(true) }, TIMER_INTERVAL)\r\n            }\r\n          }\r\n          moveParticipant(false)\r\n        }, 200) */\r\n\r\n        mapStore.setCommittedMatrix(matrix)\r\n        mem.dragging = false\r\n        mem.mouseDown = false\r\n\r\n      },\r\n      onPinch: ({da: [d, a], origin, event, memo}) => {\r\n        if (memo === undefined) {\r\n          return [d, a]\r\n        }\r\n\r\n        const [md, ma] = memo\r\n\r\n        const center = addV2(origin as [number, number], offset())\r\n\r\n        const MIN_D = 10\r\n        let scale = d > MIN_D ? d / md : d <  -MIN_D ? md / d : (1 + (d - md) / MIN_D)\r\n        //console.log(`Pinch: da:${[d, a]} origin:${origin}  memo:${memo}  scale:${scale}`)\r\n\r\n        scale = limitScale(extractScaleX(matrix), scale)\r\n\r\n        const changeMatrix = thirdPersonView ?\r\n          (new DOMMatrix()).scaleSelf(scale, scale, 1) :\r\n          (new DOMMatrix()).scaleSelf(scale, scale, 1).rotateSelf(0, 0, a - ma)\r\n\r\n        const newMatrix = transfromAt(center, changeMatrix, matrix)\r\n        mapStore.setMatrix(newMatrix)\r\n\r\n        if (!thirdPersonView) {\r\n          participants.local.pose.orientation = -radian2Degree(extractRotation(newMatrix))\r\n        }\r\n\r\n        return [d, a]\r\n      },\r\n      onPinchEnd: () => mapStore.setCommittedMatrix(matrix),\r\n      onWheel: ({movement, ctrlKey, event}) => {\r\n        //  event?.preventDefault()\r\n\r\n        if (false) {  // false:alwas zoom (or ctrlKey: scroll and zoom)\r\n          // scroll wheel - translate map\r\n          const diff = mulV2(0.2, rotateVector2D(matrix.inverse(), movement))\r\n          const newMatrix = matrix.translate(-diff[0], -diff[1])\r\n          mapStore.setMatrix(newMatrix)\r\n        }else {\r\n          //  CTRL+weel - zoom map\r\n          let scale = Math.pow(1.2, movement[1] / 1000)\r\n          scale = limitScale(extractScaleX(matrix), scale)\r\n          if (scale === 1){ return }\r\n\r\n          //  console.log(`Wheel: ${movement}  scale=${scale}`)\r\n          const newMatrix = matrix.scale(scale, scale, 1, ...transformPoint2D(matrix.inverse(), mapStore.mouse))\r\n          mapStore.setMatrix(newMatrix)\r\n        }\r\n      },\r\n      onWheelEnd: () => mapStore.setCommittedMatrix(matrix),\r\n      onMove:({xy}) => {\r\n        mapStore.setMouse(xy)\r\n        participants.local.mouse.position = Object.assign({}, mapStore.mouseOnMap)\r\n      },\r\n      onTouchStart:(ev) => {\r\n        mapStore.setMouse([ev.touches[0].clientX, ev.touches[0].clientY])\r\n        participants.local.mouse.position = Object.assign({}, mapStore.mouseOnMap)\r\n      },\r\n    },\r\n    {\r\n      eventOptions:{passive:false}, //  This prevents default zoom by browser when pinch.\r\n    },\r\n  )\r\n\r\n  //  setClientRect of the outer.\r\n  useEffect(\r\n    () => {\r\n      onResizeOuter()\r\n    },\r\n    // eslint-disable-next-line  react-hooks/exhaustive-deps\r\n    [],\r\n  )\r\n\r\n  // Prevent browser's zoom\r\n  useEffect(\r\n    () => {\r\n      function handler(event:WheelEvent) {\r\n        //  console.log(event)\r\n        if (event.ctrlKey) {\r\n          if (window.visualViewport && window.visualViewport.scale > 1){\r\n            if (event.deltaY < 0){\r\n              event.preventDefault()\r\n              //  console.log('prevent', event.deltaY)\r\n            }else{\r\n              //  console.log('through', event.deltaY)\r\n            }\r\n          }else{\r\n            event.preventDefault()\r\n          }\r\n          //  console.log('CTRL + mouse wheel = zoom prevented.', event)\r\n        }\r\n      }\r\n      window.document.body.addEventListener('wheel', handler, {passive: false})\r\n\r\n      return () => window.document.body.removeEventListener('wheel', handler)\r\n    },\r\n    [],\r\n  )\r\n  /*  //  This has no effect for iframe and other cases can be handled by onMove. So this is useless\r\n  //  preview mouse move on outer\r\n  useEffect(\r\n    () => {\r\n      function handler(ev:MouseEvent) {\r\n        mapStore.setMouse([ev.clientX, ev.clientY])\r\n      }\r\n      if (outer.current) {\r\n        outer.current.addEventListener('mousemove', handler, {capture:true})\r\n      }\r\n\r\n      return () => {\r\n        if (outer.current) {\r\n          outer.current.removeEventListener('mousemove', handler)\r\n        }\r\n      }\r\n    },\r\n    [outer])\r\n  */\r\n  //  Event handlers when use scroll ----------------------------------------------\r\n  //  Move to center when root div is created.\r\n  /*\r\n  useEffect(\r\n    () => {\r\n      if (outer.current) {\r\n        const elem = outer.current\r\n        console.log('useEffect[outer] called')\r\n        elem.scrollTo((MAP_SIZE - elem.clientWidth) * HALF, (MAP_SIZE - elem.clientHeight) *  HALF)\r\n      }\r\n    },\r\n    [outer],\r\n  )\r\n  if (!showScrollbar) {\r\n    const elem = outer.current\r\n    if (elem) {\r\n      elem.scrollTo((MAP_SIZE - elem.clientWidth) * HALF, (MAP_SIZE - elem.clientHeight) *  HALF)\r\n    }\r\n  }\r\n  */\r\n  // scroll range\r\n  /*  useEffect(\r\n    () => {\r\n      const orgMat = new DOMMatrix(matrix.toString())\r\n      setMatrix(orgMat)\r\n    },\r\n    [outer],\r\n  )\r\n  */\r\n  //  update offset\r\n  const onResizeOuter = useRef(\r\n      () => {\r\n      if (outer.current) {\r\n        let cur = outer.current as HTMLElement\r\n        let offsetLeft = 0\r\n        while (cur) {\r\n          offsetLeft += cur.offsetLeft\r\n          cur = cur.offsetParent as HTMLElement\r\n        }\r\n        //  console.log(`sc:[${outer.current.clientWidth}, ${outer.current.clientHeight}] left:${offsetLeft}`)\r\n        mapStore.setScreenSize([outer.current.clientWidth, outer.current.clientHeight])\r\n        mapStore.setLeft(offsetLeft)\r\n        // mapStore.setOffset([outer.current.scrollLeft, outer.current.scrollTop])  //  when use scroll\r\n      }\r\n    }\r\n  ).current\r\n\r\n  const styleProps: StyleProps = {\r\n    matrix,\r\n  }\r\n  const classes = useStyles(styleProps)\r\n\r\n  return (\r\n    <div className={classes.root} ref={outer} {...bind()} >\r\n      <ResizeObserver onResize = { onResizeOuter } />\r\n      <div className={classes.center}>\r\n        <div id=\"map-transform\" className={classes.transform} ref={container}>\r\n            {props.children}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\nBase.displayName = 'MapBase'\r\n\r\n","import {useEffect, useRef} from 'react'\r\n\r\nexport function KeyHandlerReact<ET extends Element> () {\r\n  const keys = new Set<number>()\r\n  const bindObject = {\r\n    onKeyDown: (e: React.KeyboardEvent<ET>) => {\r\n      e.stopPropagation()\r\n      keys.add(e.keyCode)\r\n      console.log('onKeyDown', keys)\r\n    },\r\n    onKeyUp: (e: React.KeyboardEvent<ET>) => {\r\n      e.stopPropagation()\r\n      keys.delete(e.keyCode)\r\n      console.log('onKeyUp', keys)\r\n    },\r\n    onBlur:() => {\r\n      keys.clear()\r\n      console.log('onBlur', keys)\r\n    },\r\n  }\r\n  return bindObject\r\n}\r\n\r\n\r\ntype KeyHandlerPlain_OnTimer = (keys:Set<string>) => boolean\r\n\r\nclass KeyHandlerPlainState{\r\n  timerId ?:number\r\n  event?: KeyboardEvent\r\n  keys = new Set<string>()\r\n  timerAgain = false\r\n}\r\n\r\nexport function KeyHandlerPlain(onTimer: KeyHandlerPlain_OnTimer, interval?:number,\r\n  preventList?:Set<string>, stopList?:Set<string>, enabled?:() => boolean){\r\n  const state = useRef<KeyHandlerPlainState>(new KeyHandlerPlainState()).current\r\n  if (!interval) { interval = 33 }\r\n  function timerFunc() {\r\n    if (state.timerAgain || state.keys.size) {\r\n      if (state.timerAgain || state.event?.target === document.body) {\r\n        state.timerAgain = onTimer(state.keys)\r\n      }\r\n    }else {\r\n      if (state.timerId) {\r\n        clearInterval(state.timerId)\r\n        state.timerId = undefined\r\n      }\r\n    }\r\n  }\r\n\r\n  const onKeyDown = (e: KeyboardEvent) => {\r\n    if (enabled && !enabled()) { return }\r\n    if (!preventList || preventList?.has(e.code)) { e.preventDefault() }\r\n    if (!stopList || stopList?.has(e.code)) { e.stopPropagation() }\r\n    state.event = e\r\n    state.keys.add(e.code)\r\n    //  console.log('onKeyDown', this.state.keys, e.target, e.target === document.body)\r\n    if (!state.timerId && state.event.target === document.body) {\r\n      state.timerId = setInterval(timerFunc, interval)\r\n    }\r\n  }\r\n  const onKeyUp = (e: KeyboardEvent) => {\r\n    if (enabled && !enabled()) { return }\r\n    if (!preventList || preventList?.has(e.code)) { e.preventDefault() }\r\n    if (!stopList || stopList?.has(e.code)) { e.stopPropagation() }\r\n    state.event = e\r\n    state.keys.delete(e.code)\r\n    //  console.log('onKeyUp', this.state.keys, e.target)\r\n  }\r\n  const onBlur = () => {\r\n    state.keys.clear()\r\n    //  console.log('onBlur', this.state.keys)\r\n  }\r\n\r\n  useEffect(() => {\r\n    window.addEventListener('keydown', onKeyDown)\r\n    window.addEventListener('keyup', onKeyUp)\r\n    window.addEventListener('blur', onBlur)\r\n\r\n    return () => {\r\n      window.removeEventListener('keydown', onKeyDown)\r\n      window.removeEventListener('keyup', onKeyUp)\r\n      window.removeEventListener('blur', onBlur)\r\n    }\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  },        [])\r\n}\r\n","import {makeStyles} from '@material-ui/core/styles'\r\nimport React, {useEffect, useRef} from 'react'\r\n\r\nconst CENTER = 0.5\r\nconst useStyles = makeStyles({\r\n  root: (props: StreamAvatarProps) => ({\r\n    display: 'flex',\r\n    justifyContent: 'center',\r\n    alignItems: 'center',\r\n    width: props.size,\r\n    height: props.size,\r\n//    borderRadius: (props.size || 0) / 2,\r\n    clipPath: `circle(${(props.size || 0) * CENTER}px  at center)`,\r\n    overflow: 'hidden',\r\n  }),\r\n  videoLargerWidth: (props: StreamAvatarProps) => ({\r\n    height: '100%',\r\n    transform: `scale(${props.mirror ? -1 : 1}, 1)`,\r\n  }),\r\n  videoLargerHeight: (props: StreamAvatarProps) => ({\r\n    width: '100%',\r\n    transform: `scale(${props.mirror ? -1 : 1}, 1)`,\r\n  }),\r\n})\r\n\r\nexport interface StreamAvatarProps {\r\n  stream: MediaStream\r\n  size?: number\r\n  style?: any\r\n  mirror?: boolean\r\n}\r\n\r\nconst setStream = (\r\n  video: HTMLVideoElement,\r\n  stream: MediaStream,\r\n  videoLargerWidthClass: string,\r\n  videoLargerHeightClass: string,\r\n  ) => {\r\n  video.srcObject = stream\r\n  video.autoplay = true\r\n\r\n  video.onloadedmetadata = () => {\r\n    const settings = {\r\n      width: video.width,\r\n      height: video.height,\r\n    }\r\n\r\n    if (settings.width !== undefined && settings.height !== undefined) {\r\n      video.className = settings.width >= settings.height ? videoLargerWidthClass : videoLargerHeightClass\r\n    } else {\r\n      console.error('video stream width || height is undefined')\r\n      video.className = videoLargerWidthClass\r\n    }\r\n  }\r\n}\r\n\r\nexport const StreamAvatar: React.FC<StreamAvatarProps> = (props: StreamAvatarProps) => {\r\n  const classes = useStyles(props)\r\n  const videoRef = useRef<HTMLVideoElement>(null)\r\n\r\n  useEffect(\r\n    () => {\r\n      if (videoRef !== null && videoRef.current !== null) {\r\n        setStream(videoRef.current, props.stream,\r\n                  classes.videoLargerWidth, classes.videoLargerHeight)\r\n      }\r\n    },\r\n    [videoRef, classes.videoLargerWidth, classes.videoLargerHeight, props.stream],\r\n  )\r\n\r\n  return <div className={classes.root} style={props.style}>\r\n    <video ref={videoRef} style={props.style} />\r\n  </div>\r\n}\r\n\r\nStreamAvatar.defaultProps = {\r\n  size: 100,\r\n}\r\nStreamAvatar.displayName = 'StreamAvatar'\r\n","import React from 'react'\r\nimport {ImageAvatar, ImageAvatarProps} from './ImageAvatar'\r\nimport {StreamAvatar, StreamAvatarProps} from './StreamAvatar'\r\n\r\ntype ComposedAvatarProps = ImageAvatarProps & Partial<StreamAvatarProps>\r\n\r\nexport const ComposedAvatar: React.FC<ComposedAvatarProps> = (props: ComposedAvatarProps) => {\r\n  const {\r\n    name,\r\n    avatarSrc,\r\n    colors,\r\n    stream,\r\n    ...remainProps\r\n  } = props\r\n\r\n  if (stream === undefined) {\r\n    return <ImageAvatar name={name} colors={colors}\r\n    avatarSrc={avatarSrc} {...remainProps} />\r\n  }\r\n\r\n  return <StreamAvatar stream={stream} {...remainProps} />\r\n}\r\nComposedAvatar.displayName = 'ComposedAvatar'\r\n","import {LocalParticipant} from '@stores/participants/LocalParticipant'\r\nimport {RemoteParticipant} from '@stores/participants/RemoteParticipant'\r\nimport {Observer} from 'mobx-react-lite'\r\nimport React from 'react'\r\nimport {AvatarProps} from '.'\r\nimport {ComposedAvatar} from './ComposedAvatar'\r\n\r\nexport interface ConnectedAvatarProps {\r\n  participant: LocalParticipant | RemoteParticipant\r\n  size: number\r\n  isLocal: boolean\r\n}\r\n\r\nconst ConnectedAvatar: React.FC<ConnectedAvatarProps> = (props) => {\r\n  const participant = props.participant\r\n  //  console.log('ConnectedAvatar is rendered.')\r\n\r\n  return <Observer>{() => {\r\n    const colors = participant.getColor()\r\n    const {avatarSrc, name} = participant.information\r\n    const args = {colors, avatarSrc, name}\r\n\r\n    return <ComposedAvatar {...args}\r\n    stream={participant.showVideo ? participant.tracks.avatarStream : undefined}\r\n      colors={colors} size={props.size} style={{pointerEvents:'none'}}\r\n      mirror={props.isLocal}\r\n    />\r\n  }}</Observer>\r\n}\r\n\r\nexport const MemoedAvatar = (props: AvatarProps) =>\r\n  React.useMemo(() => <ConnectedAvatar {...props} />,\r\n  //  eslint-disable-next-line react-hooks/exhaustive-deps\r\n  [props.size,\r\n    props.participant.information.avatarSrc,\r\n    props.participant.information.color,\r\n    props.participant.information.name,\r\n    props.participant.information.textColor,\r\n  ])\r\nMemoedAvatar.displayName = 'MemorizedAvatar'\r\n","export default \"data:image/png;base64,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\"","import {Avatar} from '@components/avatar'\r\nimport {useStore as useMapStore} from '@hooks/MapStore'\r\nimport megaphoneIcon from '@iconify/icons-mdi/megaphone'\r\nimport {Icon} from '@iconify/react'\r\nimport {Tooltip} from '@material-ui/core'\r\nimport {makeStyles} from '@material-ui/core/styles'\r\nimport HeadsetIcon from '@material-ui/icons/HeadsetMic'\r\nimport MicOffIcon from '@material-ui/icons/MicOff'\r\nimport SpeakerOffIcon from '@material-ui/icons/VolumeOff'\r\nimport proximityVolumeIcon from '@images/whoo-emoticons_voice.png'\r\n//import {addV2, mulV2, normV, rotateVector2DByDegree, subV2} from '@models/utils'\r\nimport {MapData} from '@stores/Map'\r\nimport {LocalParticipant} from '@stores/participants/LocalParticipant'\r\nimport {Participants} from '@stores/participants/Participants'\r\nimport {RemoteParticipant} from '@stores/participants/RemoteParticipant'\r\nimport {useObserver} from 'mobx-react-lite'\r\nimport React from 'react'\r\ndeclare const config:any             //  from ../../config.js included from index.html\r\n\r\ninterface StyleProps {\r\n  position: [number, number],\r\n  orientation: number,\r\n  size: number,\r\n}\r\n\r\n// const SVG_RATIO = 18\r\nconst SVG_RATIO = 12\r\nconst HALF = 0.5\r\n\r\nconst useStyles = makeStyles({\r\n  root: (props: StyleProps) => ({\r\n    position: 'absolute',\r\n    left: props.position[0],\r\n    top: props.position[1],\r\n  }),\r\n  pointerRotate: (props: StyleProps) => ({\r\n    transform: `rotate(${props.orientation}deg)`,\r\n  }),\r\n  pointer: (props: StyleProps) => ({\r\n    position: 'absolute',\r\n    width: `${SVG_RATIO * props.size}`,\r\n    left: `-${SVG_RATIO * props.size * HALF}px`,\r\n    top: `-${SVG_RATIO * props.size * HALF}px`,\r\n    pointerEvents: 'none',\r\n  }),\r\n  avatar: (props: StyleProps) => ({\r\n    position: 'absolute',\r\n    left: `-${props.size * HALF}px`,\r\n    top: `-${props.size * HALF}px`,\r\n  }),\r\n  icon: (props: StyleProps) => ({\r\n    position: 'absolute',\r\n    width: props.size * 0.4 ,\r\n    height: props.size * 0.4,\r\n    left: props.size * 0.6,\r\n    top: props.size * 0.6,\r\n    pointerEvents: 'none',\r\n  }),\r\n  iconProximity: (props: StyleProps) => ({\r\n    position: 'absolute',\r\n    width: props.size * 0.6 ,\r\n    height: props.size * 0.6,\r\n    left: props.size * 0.7,\r\n    top: props.size * 0.4,\r\n    pointerEvents: 'none',\r\n  }),\r\n  more: (props: StyleProps) => ({\r\n    position: 'absolute',\r\n    width: props.size * 0.4 ,\r\n    height: props.size * 0.4,\r\n    left: props.size * 0.9,\r\n    top: -props.size * 0.3,\r\n  }),\r\n})\r\n\r\nexport interface ParticipantProps{\r\n  participant: LocalParticipant | RemoteParticipant\r\n  participants: Participants\r\n  size: number\r\n  onContextMenu?:(ev:React.MouseEvent<HTMLDivElement, MouseEvent>) => void\r\n  map: MapData\r\n  \r\n}\r\nexport interface RawParticipantProps extends ParticipantProps{\r\n  isLocal: boolean\r\n  \r\n}\r\n\r\nconst RawParticipant: React.ForwardRefRenderFunction<HTMLDivElement , RawParticipantProps> = (props, ref) => {\r\n  const mapData = useMapStore()\r\n//  const participants = useStore()\r\n  const participant = props.participant\r\n  \r\n  const participantProps = useObserver(() => ({\r\n    position: participant.pose.position,\r\n    orientation: participant.pose.orientation,\r\n    mousePosition: participant.mouse.position,\r\n    awayFromKeyboard: participant.awayFromKeyboard,\r\n  }))\r\n  //const ky = useObserver(()=> participant!.physics.inProximity)\r\n  const name = useObserver(() => participant!.information.name)\r\n  const audioLevel = useObserver(() =>\r\n    participant!.trackStates.micMuted ? 0 : Math.pow(participant!.tracks.audioLevel, 0.5))\r\n  // console.log(`audioLevel ${audioLevel}`)\r\n  const micMuted = useObserver(() => participant.trackStates.micMuted)\r\n  const speakerMuted = useObserver(() => participant.trackStates.speakerMuted)\r\n  const headphone = useObserver(() => participant.trackStates.headphone)\r\n  const onStage = useObserver(() => participant.physics.onStage)\r\n  \r\n\r\n  const classes = useStyles({\r\n    ...participantProps,\r\n    size: props.size,\r\n  })\r\n\r\n  const [color, textColor] = participant ? participant.getColor() : ['white', 'black']\r\n  const outerRadius = props.size / 2 + 2\r\n  const isLocal = props.isLocal\r\n  \r\n\r\n  const AUDIOLEVELSCALE = props.size * SVG_RATIO * HALF\r\n  const svgCenter = SVG_RATIO * props.size * HALF\r\n\r\n  /* \r\n  const dir = subV2(participantProps.mousePosition, participantProps.position)\r\n  const eyeOffsets:[[number, number], [number, number]]\r\n    = [[0.4 * outerRadius, -outerRadius], [-0.4 * outerRadius, -outerRadius]]\r\n  const dirs = eyeOffsets.map(offset => subV2(dir, rotateVector2DByDegree(participantProps.orientation, offset)))\r\n  const eyeballsGlobal = dirs.map((dir) => {\r\n    const norm = normV(dir)\r\n    const dist = Math.log(norm < 1 ? 1 : norm) * 0.3\r\n    const limit = 0.1 * outerRadius\r\n    const offset = dist > limit ? limit : dist\r\n\r\n    return mulV2(offset / norm, dir)\r\n  })\r\n  const eyeballs = eyeballsGlobal.map(g => addV2([0, -0.04 * outerRadius],\r\n                                                 rotateVector2DByDegree(-participantProps.orientation, g)))\r\n  function onClickEye(ev: React.MouseEvent | React.TouchEvent | React.PointerEvent){\r\n    if (props.participant.id === props.participants.localId){\r\n      ev.stopPropagation()\r\n      ev.preventDefault()\r\n      props.participants.local.awayFromKeyboard = true\r\n    }\r\n  }\r\n  const eyeClick = {\r\n    onMouseDown: onClickEye,\r\n    onTouchStart: onClickEye,\r\n    onPointerDown: onClickEye,\r\n  }\r\n */\r\n \r\n const inProxZone = participant.physics.inProximity\r\n\r\n//console.log(participant.physics.inProximity, \" >inProximimty\")\r\n//participant.setPhysics({inProximity: false})\r\n//console.log(participant.physics.inProximity, \" >inProximimty\")\r\n\r\n  const audioMeterSteps = [0.1, 0.2, 0.3, 0.4, 0.5, 0.6]\r\n  const audioMeter = audioMeterSteps.map(step => audioLevel > step ?\r\n    <React.Fragment key={step}>\r\n      <circle r={props.size * HALF + step * AUDIOLEVELSCALE} cy={svgCenter} cx={svgCenter}\r\n        stroke={color} fill=\"none\" opacity={0.4 * (1 - step)} strokeDasharray=\"4 4 4 24\" />\r\n      <circle r={props.size * HALF + step * AUDIOLEVELSCALE} cy={svgCenter} cx={svgCenter}\r\n      stroke=\"black\" fill=\"none\" opacity={0.4 * (1 - step)} strokeDasharray=\"4 32\" strokeDashoffset=\"-4\" />\r\n    </React.Fragment>\r\n    : undefined)\r\n\r\n  const iconMeter = audioMeterSteps.map(step => audioLevel > step ?\r\n    <React.Fragment key={step}>\r\n      <img src={proximityVolumeIcon} className={classes.iconProximity} alt=\"\"/>\r\n    </React.Fragment>\r\n    : undefined)\r\n\r\n  return (\r\n    <div className={classes.root + ' dragHandle'} onContextMenu={props.onContextMenu}>\r\n      <div className={classes.pointerRotate}>\r\n      \r\n        <svg className={classes.pointer} width={props.size * SVG_RATIO} height={props.size * SVG_RATIO} xmlns=\"http://www.w3.org/2000/svg\">\r\n          <circle r={outerRadius} cy={svgCenter} cx={svgCenter} stroke=\"none\" fill={color} />\r\n          {inProxZone ? audioMeter : undefined}\r\n          {config.avatar === 'arrow' ?  //  arrow (circle with a corner) type avatar\r\n            <g transform={`translate(${svgCenter} ${svgCenter}) rotate(-135) `}>\r\n              <rect style={{pointerEvents: 'fill'}}\r\n                height={outerRadius} width={outerRadius} fill={color} />\r\n              {isLocal ?\r\n                <path  d={`M 0 ${outerRadius} h ${outerRadius} v ${-outerRadius}` +\r\n                  `a ${outerRadius} ${outerRadius} 0 1 0 ${-outerRadius} ${outerRadius}`}\r\n                  fill=\"none\" stroke={textColor} />\r\n                : undefined}\r\n            </g>\r\n            : // Frog type (two eyes) avatar\r\n            <g style={{pointerEvents: 'fill'}} >\r\n\r\n            {/* \r\n              {isLocal ?\r\n                <circle r={outerRadius} cy={svgCenter} cx={svgCenter} fill=\"none\" stroke={textColor} />\r\n                : undefined}\r\n              <circle {...eyeClick} r={0.35 * outerRadius} cy={svgCenter + eyeOffsets[0][1]}\r\n                cx={svgCenter + eyeOffsets[0][0]} fill={color} />\r\n              <circle {...eyeClick} r={0.35 * outerRadius} cy={svgCenter + eyeOffsets[1][1]}\r\n                cx={svgCenter + eyeOffsets[1][0]} fill={color} />\r\n              {participantProps.awayFromKeyboard === true ?\r\n                undefined\r\n              :<>\r\n                <circle {...eyeClick} r={0.25 * outerRadius} cy={svgCenter + eyeOffsets[0][1]}\r\n                  cx={svgCenter + eyeOffsets[0][0]} fill=\"white\" />\r\n                <circle {...eyeClick} r={0.25 * outerRadius} cy={svgCenter + eyeOffsets[1][1]}\r\n                  cx={svgCenter + eyeOffsets[1][0]} fill=\"white\" />\r\n                <circle {...eyeClick} r={0.14 * outerRadius} cy={svgCenter + eyeOffsets[0][1] + eyeballs[0][1]}\r\n                  cx={svgCenter + eyeOffsets[0][0] +  eyeballs[0][0]} fill=\"black\" />\r\n                <circle {...eyeClick} r={0.14 * outerRadius} cy={svgCenter + eyeOffsets[1][1] + eyeballs[1][1]}\r\n                  cx={svgCenter + eyeOffsets[1][0] +  eyeballs[1][0]} fill=\"black\" />\r\n              </>}\r\n\r\n                 */}\r\n\r\n            </g>\r\n          }\r\n        </svg>\r\n      </div>\r\n      <div className={classes.avatar}\r\n        style = {{transform: `rotate(${-mapData.rotation}deg)`}} >\r\n        <Tooltip title={name}>\r\n          <div>\r\n            <Avatar {...props} />\r\n            {iconMeter}\r\n            {headphone ? <HeadsetIcon className={classes.icon} htmlColor=\"rgba(0, 0, 0, 0.3)\" /> : undefined}\r\n            {speakerMuted ? <SpeakerOffIcon className={classes.icon} color=\"secondary\" /> :\r\n              (micMuted ? <MicOffIcon className={classes.icon} color=\"secondary\" /> : undefined)}\r\n            {!micMuted && onStage ? <Icon className={classes.icon} icon={megaphoneIcon} color=\"gold\" /> : undefined }\r\n          </div>\r\n        </Tooltip>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\nRawParticipant.displayName = 'RawParticipant'\r\n\r\n//export const Participant = forwardRef(RawParticipant)\r\n//Participant.displayName = 'Participant'\r\n\r\nexport const Participant = (props: RawParticipantProps) =>\r\n  React.useMemo(() => <RawParticipant {...props} />,\r\n  //  eslint-disable-next-line react-hooks/exhaustive-deps\r\n  [props.size, props.participant.id,\r\n    props.participant.information.avatarSrc,\r\n    props.participant.information.color,\r\n    props.participant.information.name,\r\n    props.participant.information.textColor,\r\n  ])\r\nParticipant.displayName = 'MemorizedParticipant'\r\n","import {MAP_SIZE} from '@components/Constants'\r\nimport {MoreButton, moreButtonControl, MoreButtonMember} from '@components/utils/MoreButton'\r\nimport {useStore} from '@hooks/ParticipantsStore'\r\nimport {makeStyles} from '@material-ui/core/styles'\r\nimport {addV2, assert, mulV2, rotateVector2DByDegree, subV2, transformPoint2D, transfromAt} from '@models/utils'\r\nimport {useObserver} from 'mobx-react-lite'\r\nimport React, {useEffect, useRef} from 'react'\r\nimport {DragHandler, DragState} from '../../utils/DragHandler'\r\nimport {KeyHandlerPlain} from '../../utils/KeyHandler'\r\nimport {LocalParticipantForm} from './LocalParticipantForm'\r\nimport {Participant, ParticipantProps} from './Participant'\r\n\r\nconst AVATAR_SPEED_LIMIT = 50\r\nconst MAP_SPEED_LIMIT = 600\r\nconst MAP_SPEED_MIN = 100\r\nconst HALF_DEGREE = 180\r\nconst WHOLE_DEGREE = 360\r\nconst HALF = 0.5\r\n\r\n\r\ntype LocalParticipantProps = ParticipantProps\r\n\r\ninterface StyleProps {\r\n  position: [number, number],\r\n  size: number,\r\n}\r\n\r\nconst useStyles = makeStyles({\r\n  more: (props: StyleProps) => ({\r\n    position: 'absolute',\r\n    width: props.size * 0.5 ,\r\n    height: props.size * 0.5,\r\n    left: props.position[0] + props.size * 0.4,\r\n    top: props.position[1] - props.size * 0.8,\r\n  }),\r\n})\r\n\r\ninterface LocalParticipantMember extends MoreButtonMember{\r\n  smoothedDelta: [number, number]\r\n  scrollAgain: boolean\r\n}\r\nconst LocalParticipant: React.FC<LocalParticipantProps> = (props) => {\r\n  const participants = useStore()\r\n  const participant = participants.local\r\n  assert(props.participant.id === participant.id)\r\n  const member = useRef<LocalParticipantMember>({} as LocalParticipantMember).current\r\n\r\n\r\n  const moveParticipant = (state: DragState<HTMLDivElement>) => {\r\n    //  move local participant\r\n    let delta = subV2(state.xy, props.map.toWindow(participant!.pose.position))\r\n    const norm = Math.sqrt(delta[0] * delta[0] + delta[1] * delta[1])\r\n    if (norm > AVATAR_SPEED_LIMIT) {\r\n      delta = mulV2(AVATAR_SPEED_LIMIT / norm, delta)\r\n    }\r\n\r\n    if (participants.local.thirdPersonView) {\r\n      const localDelta = props.map.rotateFromWindow(delta)  // transform.rotateG2L(delta)\r\n      participant!.pose.position = addV2(participant!.pose.position, localDelta)\r\n      const SMOOTHRATIO = 0.8\r\n      if (!member.smoothedDelta) { member.smoothedDelta = [delta[0], delta[1]] }\r\n      member.smoothedDelta = addV2(mulV2(1 - SMOOTHRATIO, localDelta), mulV2(SMOOTHRATIO, member.smoothedDelta))\r\n      const dir = Math.atan2(member.smoothedDelta[0], -member.smoothedDelta[1]) * HALF_DEGREE / Math.PI\r\n      let diff = dir - participant!.pose.orientation\r\n      if (diff < -HALF_DEGREE) { diff += WHOLE_DEGREE }\r\n      if (diff > HALF_DEGREE) { diff -= WHOLE_DEGREE }\r\n      const ROTATION_SPEED = 0.2\r\n      participant!.pose.orientation += diff * ROTATION_SPEED\r\n    } else {\r\n      participant!.pose.position = addV2(props.map.rotateFromWindow(delta), //    transform.rotateG2L(delta),\r\n                                         participant!.pose.position)\r\n    }\r\n    participant.savePhysicsToStorage(false)\r\n  }\r\n  const moveParticipantByKey = (keys:Set<string>) => {\r\n    let deltaF = 0\r\n    let deltaA = 0\r\n    const VEL = 10\r\n    const ANGVEL = 5\r\n    let relatedKeyPressed = false\r\n    if (keys.has('ArrowUp') || keys.has('KeyW')) {\r\n      deltaF = VEL\r\n      relatedKeyPressed = true\r\n    }\r\n    if (keys.has('ArrowDown') || keys.has('KeyS')) {\r\n      deltaF = -VEL * HALF\r\n      relatedKeyPressed = true\r\n    }\r\n    if (keys.has('ArrowLeft') || keys.has('KeyA') || keys.has('KeyQ')) {\r\n      deltaA = -ANGVEL\r\n      relatedKeyPressed = true\r\n    }\r\n    if (keys.has('ArrowRight') || keys.has('KeyD') || keys.has('KeyE')) {\r\n      deltaA = ANGVEL\r\n      relatedKeyPressed = true\r\n    }\r\n    if (keys.has('ShiftLeft') || keys.has('ShiftRight')) {\r\n      deltaA *= 2\r\n      deltaF *= 2\r\n    }\r\n    let newA = participant!.pose.orientation + deltaA\r\n    if (newA > HALF_DEGREE) { newA -= WHOLE_DEGREE }\r\n    if (newA < -HALF_DEGREE) { newA += WHOLE_DEGREE }\r\n    participant.pose.orientation = newA\r\n    if (!participants.local.thirdPersonView) {\r\n      const center = transformPoint2D(props.map.matrix, participants.local.pose.position)\r\n      const changeMatrix = (new DOMMatrix()).rotateSelf(0, 0, -deltaA)\r\n      const newMatrix = transfromAt(center, changeMatrix, props.map.matrix)\r\n      props.map.setMatrix(newMatrix)\r\n      props.map.setCommittedMatrix(newMatrix)\r\n    }\r\n    const delta = rotateVector2DByDegree(participant!.pose.orientation, [0, -deltaF])\r\n    //  console.log(participant!.pose.position, delta)\r\n    const newPos = addV2(participant!.pose.position, delta)\r\n    if (newPos[0] < -MAP_SIZE * HALF) { newPos[0] = -MAP_SIZE * HALF }\r\n    if (newPos[0] > MAP_SIZE * HALF) { newPos[0] = MAP_SIZE * HALF }\r\n    if (newPos[1] < -MAP_SIZE * HALF) { newPos[1] = -MAP_SIZE * HALF }\r\n    if (newPos[1] > MAP_SIZE * HALF) { newPos[1] = MAP_SIZE * HALF }\r\n    participant.pose.position = newPos\r\n    participant.savePhysicsToStorage(false)\r\n\r\n    return relatedKeyPressed\r\n  }\r\n\r\n  const scrollMap = () => {\r\n    const posOnScreen = props.map.toWindow(participant!.pose.position)\r\n    const target = [posOnScreen[0], posOnScreen[1]]\r\n    const RATIO = 0.2\r\n    const left = props.map.left + props.map.screenSize[0] * RATIO\r\n    const right = props.map.left + props.map.screenSize[0] * (1 - RATIO)\r\n    const bottom = props.map.screenSize[1] * (1 - RATIO)\r\n    const top = participants.local.thirdPersonView ? props.map.screenSize[1] * RATIO : bottom\r\n    if (target[0] < left) { target[0] = left }\r\n    if (target[0] > right) { target[0] = right }\r\n    if (target[1] < top) { target[1] = top }\r\n    if (target[1] > bottom) { target[1] = bottom }\r\n    let diff = subV2(posOnScreen, target) as [number, number]\r\n    const norm = Math.sqrt(diff[0] * diff[0] + diff[1] * diff[1])\r\n    if (norm > MAP_SPEED_LIMIT) {\r\n      diff = mulV2(MAP_SPEED_LIMIT / norm, diff) as [number, number]\r\n    }else if (norm < MAP_SPEED_MIN){\r\n      diff = mulV2(MAP_SPEED_MIN / norm, diff) as [number, number]\r\n    }\r\n    const SCROOL_SPEED = 0.1\r\n    const mapMove = mulV2(SCROOL_SPEED, props.map.rotateFromWindow(diff) as [number, number])\r\n    const EPSILON = 0.2\r\n    if (Math.abs(mapMove[0]) + Math.abs(mapMove[1]) > EPSILON) {\r\n      const newMat = props.map.matrix.translate(-mapMove[0], -mapMove[1])\r\n      const trans = props.map.rotateFromWindow([newMat.e, newMat.f])\r\n      const HALF = 0.5\r\n      let changed = false\r\n      if (trans[0] < -MAP_SIZE * HALF) { trans[0] = -MAP_SIZE * HALF; changed = true }\r\n      if (trans[0] > MAP_SIZE * HALF) { trans[0] = MAP_SIZE * HALF; changed = true }\r\n      if (trans[1] < -MAP_SIZE * HALF) { trans[1] = -MAP_SIZE * HALF; changed = true }\r\n      if (trans[1] > MAP_SIZE * HALF) { trans[1] = MAP_SIZE * HALF; changed = true }\r\n      const transMap = props.map.rotateToWindow(trans);\r\n      [newMat.e, newMat.f] = transMap\r\n      props.map.setMatrix(newMat)\r\n      props.map.setCommittedMatrix(newMat)\r\n      member.scrollAgain = !changed\r\n\r\n      return !changed\r\n    }\r\n    member.scrollAgain = false\r\n\r\n    return false\r\n  }\r\n  const onTimer = (state:DragState<HTMLDivElement>) => {\r\n    if (state.dragging) {\r\n      onDrag(state)\r\n    }\r\n    const rv = scrollMap()\r\n    //  console.log(`onTimer: drag:${state.dragging} again:${rv}`)\r\n\r\n    return rv\r\n  }\r\n  const onDrag = (state:DragState<HTMLDivElement>) => {\r\n    //  console.log('participant onDrag')\r\n    moveParticipant(state)\r\n  }\r\n  const onKeyTimer = (keys:Set<string>) => {\r\n    //   console.log('onKeyTimer()', keys)\r\n    const participantMoved = moveParticipantByKey(keys)\r\n\r\n    if (member.scrollAgain || participantMoved) {\r\n      return scrollMap()\r\n    }\r\n\r\n    return false\r\n  }\r\n  const keycodesUse = new Set(['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight',\r\n    'KeyQ', 'KeyW', 'KeyE', 'KeyA', 'KeyS', 'KeyD'])\r\n  KeyHandlerPlain(onKeyTimer, 33, keycodesUse, keycodesUse, () => (props.map.keyInputUsers.size === 0))\r\n\r\n  //  pointer drag\r\n  const TIMER_INTERVAL = 33\r\n  const drag = DragHandler<HTMLDivElement>(onDrag, 'dragHandle',\r\n                                               onTimer, TIMER_INTERVAL, () => { setShowConfig(true) })\r\n  useEffect(() => {\r\n    drag.target.current?.focus({preventScroll:true})\r\n  })\r\n\r\n/*  rotation changes sound localization and frequent changes are not good to hear.\r\n  //  Rotate participant to look at the pointer\r\n  useEffect(() => {\r\n    const cleanup = reaction(() => mapData.mouse, (mouse) => {\r\n      //  look at mouse\r\n      if (participant.thirdPersonView && !drag.memo?.state?.dragging) {\r\n        const dir = subV2(mapData.mouseOnMap, participant.pose.position)\r\n        const norm = normV(dir)\r\n        if (norm > PARTICIPANT_SIZE / 2) {\r\n          participant.pose.orientation = Math.atan2(dir[0], -dir[1]) * HALF_DEGREE / Math.PI\r\n        }\r\n      }\r\n    })\r\n\r\n    return cleanup\r\n  },\r\n            [])\r\n*/\r\n  const styleProps = useObserver(() => ({\r\n    position: participant.pose.position,\r\n    size: props.size,\r\n  }))\r\n  const [color] = participant ? participant.getColor() : ['white', 'black']\r\n  const classes = useStyles(styleProps)\r\n  const [showMore, setShowMore] = React.useState(false)\r\n  const [showConfig, setShowConfig] = React.useState(false)\r\n  const moreControl = moreButtonControl(setShowMore, member)\r\n  function onClose() {\r\n    setShowConfig(false)\r\n    props.map.keyInputUsers.delete('LocalParticipantConfig')\r\n  }\r\n  function openConfig() {\r\n    setShowConfig(true)\r\n    props.map.keyInputUsers.add('LocalParticipantConfig')\r\n  }\r\n  const ref = useRef<HTMLButtonElement>(null)\r\n\r\n  return (\r\n    <div ref={drag.target} {...drag} {...moreControl}>\r\n    <Participant {...props} isLocal={true}\r\n      onContextMenu={(ev) => {\r\n        ev.preventDefault()\r\n        openConfig()\r\n      }}\r\n    />\r\n    <MoreButton show={showMore} className={classes.more} htmlColor={color} {...moreControl}\r\n      buttonRef = {ref}\r\n      onClickMore = {openConfig} />\r\n    <LocalParticipantForm map={props.map} open={showConfig} close={onClose}\r\n      anchorEl={ref.current} anchorOrigin={{vertical:'top', horizontal:'left'}}\r\n      anchorReference = \"anchorEl\"\r\n    />\r\n    </div>\r\n  )\r\n}\r\n\r\nexport const MemoedLocalParticipant = (props: ParticipantProps) =>\r\n  React.useMemo(() => <LocalParticipant {...props} />,\r\n  //  eslint-disable-next-line react-hooks/exhaustive-deps\r\n  [props.size, props.participant.id,\r\n    props.participant.information.avatarSrc,\r\n    props.participant.information.color,\r\n    props.participant.information.name,\r\n    props.participant.information.textColor,\r\n  ])\r\n  MemoedLocalParticipant.displayName = 'MemorizedLocalParticipant'\r\n","import {normV, subV2} from '@models/utils'\r\nimport React, {useEffect, useRef} from 'react'\r\n\r\nfunction checkClass<ET extends Element>(el: Element, stop:ET, clsToFind: string):Element | null {\r\n  let cur = el\r\n  while (cur && cur !== stop) {\r\n    if (cur.attributes) {\r\n      const cls = cur.attributes.getNamedItem('class')\r\n      if (cls) {\r\n        if (cls.value.includes(clsToFind)) {\r\n          return cur\r\n        }\r\n        //  console.log(cls.value)\r\n      }\r\n    }\r\n    cur = cur.parentNode as Element\r\n  }\r\n\r\n  return null\r\n}\r\n\r\nexport interface DragState<ET extends Element>{\r\n  buttons: number\r\n  xy: [number, number]\r\n  start: [number, number]\r\n  startTime: number\r\n  dragging: boolean\r\n  event:React.PointerEvent<ET>|undefined\r\n}\r\ninterface DragMemo<ET extends Element>{\r\n  timerAgain:boolean\r\n  timerId: number\r\n  state: DragState<ET>\r\n}\r\n/*\r\nexport class DragHandler<ET extends Element>{  //  pointer drag\r\n  onDrag: (state:DragState<ET>) => void\r\n  onTimer?: (state:DragState<ET>) => boolean\r\n  onContextMenu?: (ev: React.TouchEvent<ET>) => void\r\n  interval?: number\r\n  handle?: string  //  class name of dragging handle\r\n  target: React.RefObject<ET>\r\n  memo: DragMemo<ET>\r\n*/\r\nexport function DragHandler<ET extends Element>(onDrag:(state:DragState<ET>) => void, handle?: string,\r\n              onTimer?:(state:DragState<ET>) => boolean, interval?: number,\r\n              onContextMenu?:(ev: React.TouchEvent<ET>) => void) {\r\n  const target = useRef<ET>(null)\r\n  const memo = useRef<DragMemo<ET>>({state:{}} as DragMemo<ET>).current\r\n\r\n  const timerFunc = () => {\r\n    if (!memo.state.dragging && !memo.timerAgain) {\r\n      clearInterval(memo.timerId)\r\n      memo.timerId = 0\r\n    }else if (onTimer) {\r\n      memo.timerAgain = onTimer(memo.state)\r\n    }\r\n  }\r\n\r\n  //  To prevent browser zoom, onTouchMove must call preventDefault() and need {passive:false}\r\n  function onTouchMove(ev: Event) {\r\n    ev.preventDefault()\r\n    ev.stopPropagation()\r\n  }\r\n\r\n  useEffect(() => {\r\n    const current = target.current\r\n    current?.addEventListener('touchmove', onTouchMove, {passive:false})\r\n\r\n    return () => {\r\n      current?.removeEventListener('touchmove', onTouchMove)\r\n    }\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  },        [target.current])\r\n  const bindObject = {\r\n    target: target,\r\n    onMouseDown: (e: React.MouseEvent<ET>) => { e.stopPropagation() },\r\n    onTouchStart: (e: React.TouchEvent<ET>) => { e.stopPropagation() },\r\n    onPointerDown: (e: React.PointerEvent<ET>) => {\r\n      e.stopPropagation()\r\n      memo.state = {dragging:false, buttons:e.buttons, xy:[e.clientX, e.clientY],\r\n        start:[e.clientX, e.clientY], startTime:Date.now(), event:e}\r\n      if ((e.buttons & 1) && target.current &&\r\n        (!handle || checkClass(e.target as Element, target.current, handle))) {\r\n        (e.target as Element).setPointerCapture(e.pointerId)\r\n\r\n        if (!memo.timerId) {\r\n          memo.timerId = setInterval(timerFunc, interval)\r\n        }\r\n        memo.state.dragging = true\r\n      }\r\n      //  console.log(`onPointerDown: ${this.memo.state.dragging}`)\r\n    },\r\n    onPointerOut: (e: React.PointerEvent<ET>) => {\r\n      e.stopPropagation()\r\n      Object.assign(memo.state, {dragging:false, buttons:e.buttons, xy:[e.clientX, e.clientY], event:e})\r\n      //  console.log(`onPointerOut: ${this.memo.state.dragging}`)\r\n    },\r\n    onPointerUp: (e: React.PointerEvent<ET>) => {\r\n      bindObject.onPointerOut(e)\r\n    },\r\n    onTouchEnd:(e: React.TouchEvent<ET>) => {\r\n      e.stopPropagation()\r\n      const delta = normV(subV2(memo.state.xy, memo.state.start))\r\n      const deltaT = Date.now() - memo.state.startTime\r\n      if (delta < 5 && deltaT > 0.5 && onContextMenu) {\r\n        onContextMenu(e)\r\n      }\r\n    },\r\n    onPointerMove: (e: React.PointerEvent<ET>) => {\r\n      e.stopPropagation()\r\n      Object.assign(memo.state, {dragging:memo.state?.dragging ? true :false,\r\n        buttons:e.buttons, xy:[e.clientX, e.clientY], event:e})\r\n      //  console.log(`onPointerMove xy:${e.clientX},${e.clientY} buttons:${e.buttons} drag:${this.dragging ? 1 : 0}`)\r\n\r\n      if (memo.state.dragging) {\r\n        if ((e.buttons & 1)) {\r\n          onDrag(memo.state)\r\n        }else {\r\n          memo.state.dragging = false\r\n        }\r\n      }\r\n    },\r\n  }\r\n\r\n  return bindObject\r\n}\r\n","import {useStore} from '@hooks/ParticipantsStore'\r\nimport {Tooltip} from '@material-ui/core'\r\nimport {ParticipantBase} from '@stores/participants/ParticipantBase'\r\nimport {useObserver} from 'mobx-react-lite'\r\nimport React from 'react'\r\n\r\ninterface MouseCursorProps{\r\n  participantId: string\r\n}\r\n\r\n\r\nexport const MouseCursor: React.FC<MouseCursorProps> = (props:MouseCursorProps) => {\r\n  const participants = useStore()\r\n  const participant = participants.find(props.participantId) as ParticipantBase\r\n  const position = useObserver(() => participant.mouse.position)\r\n  const name = useObserver(() => participant.information.name)\r\n  const [color] = participant.getColor()\r\n  if (!position) {\r\n    return <div />\r\n  }\r\n  const isLocal = props.participantId === participants.localId\r\n\r\n  const cursor = <div style={{width:18, height:30, left:position[0], top:position[1], position:'absolute',\r\n    pointerEvents: isLocal ? 'none' : 'auto',\r\n  }}>\r\n    <svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 60 100\">\r\n      <polygon points=\"32,100 53,92 36,57 60,56 0,0 0,81 16,65 32,100\" stroke=\"black\" fill={color} strokeWidth=\"6\" />\r\n    </svg>\r\n  </div>\r\n\r\n  return isLocal ? cursor\r\n    :<Tooltip title={name}>{cursor}</Tooltip>\r\n}\r\n","import {MoreButton, moreButtonControl, MoreButtonMember} from '@components/utils/MoreButton'\r\nimport {makeStyles} from '@material-ui/core/styles'\r\nimport participants from '@stores/participants/Participants'\r\nimport {RemoteParticipant as RemoteParticipantStore} from '@stores/participants/RemoteParticipant'\r\nimport {useObserver} from 'mobx-react-lite'\r\nimport React from 'react'\r\nimport {Participant, ParticipantProps} from './Participant'\r\nimport {RemoteParticipantForm} from './RemoteParticipantForm'\r\n\r\ninterface RemoteParticipantMember extends MoreButtonMember{\r\n  timeout:NodeJS.Timeout|undefined\r\n}\r\n\r\ninterface StyleProps {\r\n  position: [number, number],\r\n  size: number,\r\n}\r\nconst useStyles = makeStyles({\r\n  more: (props: StyleProps) => ({\r\n    position: 'absolute',\r\n    width: props.size * 0.5 ,\r\n    height: props.size * 0.5,\r\n    left: props.position[0] + props.size * 0.4,\r\n    top: props.position[1] - props.size * 0.8,\r\n  }),\r\n})\r\n\r\nexport const RemoteParticipant: React.FC<ParticipantProps> = (props) => {\r\n  const member = React.useRef<RemoteParticipantMember>({} as RemoteParticipantMember).current\r\n  const [showMore, setShowMore] = React.useState(false)\r\n  const moreControl = moreButtonControl(setShowMore, member)\r\n  const [showForm, setShowForm] = React.useState(false)\r\n  const [color] = props.participant.getColor()\r\n  const styleProps = useObserver(() => ({\r\n    position: props.participant.pose.position,\r\n    size: props.size,\r\n  }))\r\n  const classes = useStyles(styleProps)\r\n  function switchYarnPhone(ev:React.MouseEvent<HTMLDivElement>, id:string){\r\n    if (showForm){ return }\r\n    if (participants.yarnPhones.has(id)) {\r\n      participants.yarnPhones.delete(id)\r\n    }else {\r\n      participants.yarnPhones.add(id)\r\n    }\r\n  }\r\n  function onClose() {\r\n    props.map.keyInputUsers.delete('remoteForm')\r\n    setShowForm(false)\r\n  }\r\n  function openForm() {\r\n    props.map.keyInputUsers.add('remoteForm')\r\n    setShowForm(true)\r\n  }\r\n  const buttonRef=React.useRef<HTMLButtonElement>(null)\r\n\r\n  return (\r\n    <div {...moreControl}\r\n      onClick = {(ev)=>switchYarnPhone(ev, props.participant.id)}\r\n      onContextMenu={(ev) => {ev.preventDefault(); openForm()}}\r\n    >\r\n      <Participant {...props} isLocal={false} />\r\n      <MoreButton show={showMore} className={classes.more} htmlColor={color} {...moreControl}\r\n      buttonRef={buttonRef}\r\n      onClickMore = {(ev)=>{\r\n        ev.stopPropagation()\r\n        openForm()\r\n      }} />\r\n      <RemoteParticipantForm open={showForm} close={onClose} map={props.map}\r\n        participant={props.participant as RemoteParticipantStore}\r\n        anchorEl={buttonRef.current} anchorOrigin={{vertical:'top', horizontal:'left'}}\r\n        anchorReference = \"anchorEl\"\r\n      />\r\n    </div>\r\n  )\r\n}\r\n","import {useStore} from '@hooks/ParticipantsStore'\r\nimport {PARTICIPANT_SIZE} from '@models/Participant'\r\nimport {urlParameters} from '@models/url'\r\nimport {MapData} from '@stores/Map'\r\nimport {Participants} from '@stores/participants/Participants'\r\nimport {useObserver} from 'mobx-react-lite'\r\nimport React from 'react'\r\nimport {MemoedLocalParticipant as LocalParticipant} from './LocalParticipant'\r\nimport {MouseCursor} from './MouseCursor'\r\nimport {RemoteParticipant} from './RemoteParticipant'\r\ninterface LineProps {\r\n  start: [number, number]\r\n  end: [number, number]\r\n  participants: Participants,\r\n  remote: string,\r\n}\r\n\r\nconst Line: React.FC<LineProps> = (props) => {\r\n  const left = Math.min(props.start[0], props.end[0])\r\n  const top = Math.min(props.start[1], props.end[1])\r\n  const width = Math.abs(props.start[0] - props.end[0])\r\n  const height = Math.abs(props.start[1] - props.end[1])\r\n\r\n  return <svg xmlns=\"http://www.w3.org/2000/svg\" style={{position:'absolute', left, top, width, height, pointerEvents:'stroke'}}\r\n    viewBox={`0, 0, ${width}, ${height}`}\r\n    onClick = {() => { props.participants.yarnPhones.delete(props.remote) }}\r\n    >\r\n    <line x1={props.start[0] - left} y1={props.start[1] - top}\r\n      x2={props.end[0] - left} y2={props.end[1] - top} stroke=\"black\" />\r\n  </svg>\r\n}\r\n\r\nexport const ParticipantsLayer: React.FC<{map:MapData}> = (props) => {\r\n  const store = useStore()\r\n  const ids = useObserver(() => Array.from(store.remote.keys()).filter((id) => {\r\n    const remote = store.find(id)!\r\n\r\n    return remote.physics.located\r\n  }))\r\n  const localId = useObserver(() => store.localId)\r\n  const remoteElements = ids.map(id => <RemoteParticipant map={props.map} key={id} participants={store}\r\n    participant={store.remote.get(id)!} size={PARTICIPANT_SIZE} />)\r\n  const localElement = (<LocalParticipant map={props.map} key={'local'} participants={store}\r\n    participant={store.local} size={PARTICIPANT_SIZE} />)\r\n  const lines = useObserver(\r\n    () => Array.from(store.yarnPhones).map((rid) => {\r\n      const start = store.local.pose.position\r\n      const remote = store.remote.get(rid)\r\n      if (!remote) { return undefined }\r\n      const end = remote.pose.position\r\n\r\n      return <Line start={start} end={end} key={rid} participants={store} remote={rid} />\r\n    }),\r\n  )\r\n\r\n  const mouseIds = useObserver(() => Array.from(store.remote.keys()).filter(id => (store.find(id)!.mouse.show)))\r\n  const remoteMouseCursors = mouseIds.map(id => <MouseCursor key={`M_${id}`} participantId={id} />)\r\n\r\n  const showLocalMouse = useObserver(() => store.local.mouse.show)\r\n  const localMouseCursor = showLocalMouse ? <MouseCursor key={'M_local'} participantId={localId} /> : undefined\r\n\r\n  if (urlParameters.testBot !== null) { return <div /> }\r\n\r\n  //  zIndex is needed to show the participants over the share layer.\r\n  return(\r\n    <div style={{position:'absolute', zIndex:0x7FFF}}>\r\n      {lines}\r\n      {remoteElements}\r\n      {localElement}\r\n      {remoteMouseCursors}\r\n      {localMouseCursor}\r\n    </div>\r\n  )\r\n}\r\n\r\nParticipantsLayer.displayName = 'ParticipantsLayer'\r\n","import {Stores} from '@components/utils'\r\nimport {ISharedContent, TIME_RESOLUTION_IN_MS} from '@models/ISharedContent'\r\nimport { isSelfUrl } from '@models/utils'\r\nimport {MapData} from '@stores/Map'\r\nimport {createContent, createContentOfIframe, createContentOfImage, createContentOfImageUrl,\r\n  createContentOfPdf, createContentOfText} from '@stores/sharedContents/SharedContentCreator'\r\nimport {default as sharedContents} from '@stores/sharedContents/SharedContents'\r\nimport _ from 'lodash'\r\nimport {useObserver} from 'mobx-react-lite'\r\nimport React, {useEffect} from 'react'\r\nimport {MouseOrTouch, RndContent} from './RndContent'\r\n\r\nexport interface PastedContentProps extends Stores{\r\n}\r\n\r\nexport const PastedContent: React.FC<PastedContentProps> = (props:PastedContentProps) => {\r\n  const map = props.map\r\n  //  Pasted handler. It prevents paste to dialog.\r\n  function onPaste(evt: ClipboardEvent) {\r\n    //  console.log(`onPaste called enabled:${sharedContents.pasteEnabled}`)\r\n    if (sharedContents.pasteEnabled && map.keyInputUsers.size === 0 && evt.clipboardData) {\r\n      evt.preventDefault()\r\n      setContent(evt.clipboardData)\r\n    }\r\n  }\r\n  function onDrop(evt: DragEvent) {\r\n    //  console.log('onDrop', evt)\r\n    evt.preventDefault()\r\n    evt.stopPropagation()\r\n    /* if (evt.dataTransfer) {\r\n      setContent(evt.dataTransfer)\r\n    } */\r\n  }\r\n\r\n  //  set pasted or dragged content to pasted content (not shared) or create shared content directly\r\n  const SHARE_DIRECT = true\r\n  function setContent(dataTransfer: DataTransfer) {\r\n\r\n    if (dataTransfer?.types.includes('Files')) {   //  If file is pasted)\r\n      Array.from(dataTransfer.items).forEach((item) => {\r\n        const file = item.getAsFile()\r\n        if (item.kind === 'file' && file) {\r\n          let creator: ((file:File, map:MapData, offset?:[number, number]) => Promise<ISharedContent>)\r\n            | undefined = undefined\r\n          if (item.type.indexOf('image') !== -1) {\r\n            creator = createContentOfImage\r\n          }else if (item.type === 'application/pdf') {\r\n            creator = createContentOfPdf\r\n          }\r\n          if (creator) {\r\n            creator(file, map).then((content) => {\r\n              content.name = file.name\r\n              if (SHARE_DIRECT) {\r\n                sharedContents.shareContent(content)\r\n              } else {\r\n                sharedContents.setPasted(content)\r\n              }\r\n            })\r\n          }\r\n        }\r\n      })\r\n    } else if (dataTransfer?.types.includes('text/plain')) {\r\n      dataTransfer.items[0].getAsString((str:string) => {\r\n        let content = undefined\r\n        if (str.indexOf('http://') === 0 || str.indexOf('https://') === 0) {\r\n          const url = new URL(str)\r\n          const ext = str.slice(-4)\r\n          if (isSelfUrl(url)) {\r\n            //  Openning of self url makes infinite loop. So, create text instead.\r\n            content = createContentOfText(str, map)\r\n            content.name = '! recursive reference'\r\n          }else if (ext === '.jpg' || ext === '.JPG' || ext === 'jpeg' || ext === 'JPEG' || ext === '.png' || ext === '.PNG' || ext === '.gif' || ext === '.GIF' || ext === '.svg' || ext === '.SVG') {\r\n            createContentOfImageUrl(str, map).then((content) => {\r\n              content.name = url.pathname\r\n              if (SHARE_DIRECT) {\r\n                sharedContents.shareContent(content)\r\n              } else {\r\n                sharedContents.setPasted(content)\r\n              }\r\n            })\r\n          }else {\r\n            createContentOfIframe(str, map).then((content) => {\r\n              if (content.type === 'iframe') {\r\n                //  iframe is not work well because of CORS problem.\r\n                content = createContentOfText(str, map)\r\n                content.name = `${url.host}${url.pathname}${url.search}`\r\n              }\r\n              if (content.type === 'youtube') {\r\n                content.name = `${url.search.substring(1)}`\r\n              }else {\r\n                content.name = `${url.host}${url.pathname}${url.search}`\r\n              }\r\n              if (SHARE_DIRECT) {\r\n                sharedContents.shareContent(content)\r\n              } else {\r\n                sharedContents.setPasted(content)\r\n              }\r\n            })\r\n          }\r\n        } else {\r\n          content = createContentOfText(str, map)\r\n          content.name = str.substring(0, 20)\r\n        }\r\n        if (content) {\r\n          if (SHARE_DIRECT) {\r\n            sharedContents.shareContent(content)\r\n          } else {\r\n            sharedContents.setPasted(content)\r\n          }\r\n        }\r\n      })\r\n    }else {\r\n      console.error('Unhandled content types=', dataTransfer?.types)\r\n    }\r\n  }\r\n\r\n  function onShare() {\r\n    // console.log(\"onClick b:\", evt.button, \" bs:\" ,evt.buttons, \" d:\", evt.detail, \" p:\", evt.eventPhase)\r\n    //  Add the pasted content to sharedContents and clear the pastedContent.\r\n    pastedContent.zorder = Math.floor(Date.now() / TIME_RESOLUTION_IN_MS)\r\n    pastedContent.pinned = true\r\n    pastedContent.proximity = true\r\n    sharedContents.addLocalContent(_.cloneDeep(pastedContent))\r\n    sharedContents.setPasted(createContent())\r\n  }\r\n\r\n  useEffect(\r\n    () => {\r\n      window.document.body.addEventListener(\r\n        'paste',\r\n        (event) => {\r\n          onPaste(event)\r\n        },\r\n        {passive:false},\r\n      )\r\n      window.document.body.addEventListener(\r\n        'drop',\r\n        (event) => {\r\n          onDrop(event)\r\n        },\r\n        {passive:false},\r\n      )\r\n      window.document.body.addEventListener(\r\n        'dragover',\r\n        (ev) => {\r\n          // console.log('dragover called', ev)\r\n          ev.preventDefault()\r\n          ev.stopPropagation()\r\n          if (ev.dataTransfer?.dropEffect) {\r\n            ev.dataTransfer.dropEffect = 'copy'\r\n          }\r\n        },\r\n        {passive:false},\r\n      )\r\n    },\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n    [],\r\n  )\r\n  const pastedContent = useObserver(() => sharedContents.pasted)\r\n  //  console.log('Pasted contents rendered.')\r\n\r\n  return (\r\n    <RndContent {...props} hideAll={pastedContent.type === ''} content={pastedContent}\r\n      onShare = {(evt: MouseOrTouch) => { onShare() }}\r\n      onClose = {(evt: MouseOrTouch) => {\r\n        sharedContents.setPasted(createContent())\r\n        evt.stopPropagation()\r\n      }}\r\n      updateAndSend = {(nc: ISharedContent) => {\r\n        sharedContents.setPasted(nc)\r\n      }}\r\n      updateOnly = {(nc: ISharedContent) => {\r\n        sharedContents.setPasted(nc)\r\n      }}\r\n    />\r\n  )\r\n}\r\n","import {BaseProps} from '@components/utils'\r\nimport {makeStyles} from '@material-ui/core/styles'\r\nimport {isContentWallpaper} from '@models/ISharedContent'\r\nimport _ from 'lodash'\r\nimport {Observer} from 'mobx-react-lite'\r\nimport React from 'react'\r\nimport {PastedContent} from './PastedContent'\r\nimport {SharedContent} from './SharedContent'\r\n\r\nconst useStyles = makeStyles({\r\n  slContainer:{\r\n    userDrag: 'none',\r\n    userSelect: 'none',\r\n  },\r\n})\r\n\r\nexport const ShareLayer = React.memo<BaseProps>(\r\n  (props) => {\r\n    const classes = useStyles()\r\n    const {transparent, ...contentProps} = props\r\n\r\n    return  <div className={classes.slContainer} >\r\n      <Observer>{\r\n        ()=>{\r\n          const all = Array.from(props.contents.all)\r\n          const filtered = props.transparent ? all.filter(c => !isContentWallpaper(c)) : all\r\n\r\n          return <>{\r\n            filtered.map(val =>\r\n              <SharedContent key={val.id} content={val} {...contentProps} />)\r\n          }</>\r\n        }\r\n      }</Observer>\r\n    <PastedContent {...contentProps} />\r\n    </div>\r\n  },\r\n  (prev, next) => {\r\n    return _.isEqual(prev.contents.all, next.contents.all) && prev.transparent === next.transparent\r\n  },\r\n)\r\nShareLayer.displayName = 'ShareLayer'\r\n","import {MAP_SIZE} from '@components/Constants'\r\n//import jitsiIcon from '@images/jitsi/Poweredby_Jitsi_logo_white_04_2020_white.png'\r\nimport {makeStyles} from '@material-ui/core/styles'\r\nimport { rgb2Color} from '@models/utils'\r\nimport roomInfo from '@stores/RoomInfo'\r\nimport { Observer, useObserver } from 'mobx-react-lite'\r\nimport React from 'react'\r\nconst HALF = 0.5\r\n\r\nconst useStyles = makeStyles({\r\n  img: (props:BackgroundStyleProps) => {\r\n    if (props.transparent) {\r\n      return {display: 'none'}\r\n    }\r\n    //const color = `%23${rgb2Color(props.color).substring(1)}`\r\n    const fill = rgb2Color(props.fill)\r\n\r\n    return {\r\n      position: 'absolute',\r\n      top: - MAP_SIZE * HALF,\r\n      left: - MAP_SIZE * HALF,\r\n      backgroundColor: fill,\r\n      //backgroundImage: `url(\"data:image/svg+xml,%3Csvg width='120' height='120' viewBox='0 0 80 80' xmlns='http://www.w3.org/2000/svg'%3E%3Cg ` +\r\n      //  `fill='none' fill-rule='evenodd'%3E%3Cg fill='${color}' %3E%3Cpath d='M50 50c0-5.523 4.477-10 10-10s10 4.477 10 10-4.477 10-10 10c0 5.523-4.477 10-10 10s-10-4.477-10-10 4.477-10 10-10zM10 10c0-5.523 4.477-10 10-10s10 4.477 10 10-4.477 10-10 10c0 5.523-4.477 10-10 10S0 25.523 0 20s4.477-10 10-10zm10 8c4.418 0 8-3.582 8-8s-3.582-8-8-8-8 3.582-8 8 3.582 8 8 8zm40 40c4.418 0 8-3.582 8-8s-3.582-8-8-8-8 3.582-8 8 3.582 8 8 8z' /%3E%3C/g%3E%3C/g%3E%3C/svg%3E\")`,\r\n      height: MAP_SIZE,\r\n      width: MAP_SIZE,\r\n    }\r\n  },\r\n  logo: (props:BackgroundProps) => {\r\n    if (props.transparent) {\r\n      return {\r\n        display:'none',\r\n      }\r\n    }\r\n\r\n    return {\r\n      position: 'absolute',\r\n      top: 0,\r\n      right: 0,\r\n      bottom: 0,\r\n      left: 0,\r\n      margin: 'auto',\r\n      height: '10em',\r\n      userDrag: 'none',\r\n      userSelect: 'none',\r\n      pointerEvents: 'none',\r\n    }\r\n  },\r\n})\r\n\r\nexport interface BackgroundProps{\r\n  transparent?: boolean\r\n}\r\ninterface BackgroundStyleProps extends BackgroundProps{\r\n  color: number[]\r\n  fill: number[]\r\n}\r\n\r\nexport const Background: React.FC<BackgroundProps> = (props) => {\r\n  const styleProps = {\r\n    color: [0,0,0],\r\n    fill: [0,0,0],\r\n    ...props\r\n  }\r\n  useObserver(()=>{\r\n    styleProps.color = roomInfo.backgroundColor\r\n    styleProps.fill = roomInfo.backgroundFill\r\n  })\r\n  const classes = useStyles(styleProps)\r\n\r\n  return <Observer>{() => {\r\n    return <div className={classes.img}>\r\n      {/* <img className={classes.logo} src={jitsiIcon} alt=\"jitsi icon\"/> */}\r\n    </div>\r\n  }}</Observer>\r\n}\r\nBackground.displayName = 'Background'\r\n","import {Base} from '@components/map/Base'\r\nimport {ParticipantsLayer} from '@components/map/ParticipantsLayer'\r\nimport {ShareLayer} from '@components/map/ShareLayer'\r\nimport {BaseProps} from '@components/utils'\r\n//import {useStore as useParticipantsStore} from '@hooks/ParticipantsStore'\r\n//import {useStore as useContentsStore} from '@hooks/SharedContentsStore'\r\n//import {useObserver} from 'mobx-react-lite'\r\nimport React from 'react'\r\nimport {BackgroundLayer} from './BackgroundLayer'\r\n\r\n\r\nexport const Map: React.FC<BaseProps> = (props) => {\r\n\r\n  return (\r\n    <Base {...props}>\r\n      <BackgroundLayer transparent={props.transparent} />\r\n      <ShareLayer {...props} />\r\n      <ParticipantsLayer {...props}/>\r\n    </Base>\r\n  )\r\n}\r\nMap.displayName = 'Map'\r\n","import {StoreProvider as ChatProvider} from '@hooks/ChatStore'\r\nimport {StoreProvider as MapProvider} from '@hooks/MapStore'\r\nimport {StoreProvider as ParticipantsProvider} from '@hooks/ParticipantsStore'\r\nimport {StoreProvider as ContentsProvider} from '@hooks/SharedContentsStore'\r\nimport {urlParameters} from '@models/url'\r\nimport {isPortrait, isSmartphone} from '@models/utils'\r\nimport { rgb2Color } from '@models/utils'\r\nimport chatStore from '@stores/Chat'\r\nimport errorInfo from '@stores/ErrorInfo'\r\nimport mapStore from '@stores/Map'\r\nimport participantsStore from '@stores/participants/Participants'\r\nimport roomInfo from '@stores/RoomInfo'\r\nimport sharedContentsStore from '@stores/sharedContents/SharedContents'\r\nimport {Observer} from 'mobx-react-lite'\r\nimport React, {Fragment, useRef, useState} from 'react'\r\nimport SplitPane from 'react-split-pane'\r\nimport {Footer} from './footer/Footer'\r\nimport {LeftBar} from './leftBar/LeftBar'\r\nimport {MainScreen} from './map/MainScreen'\r\nimport {Map} from './map/map'\r\nimport {Stores} from './utils'\r\nimport {styleCommon, styleForSplit} from './utils/styles'\r\n\r\nexport const App: React.FC<{}> = () => {\r\n\r\n  \r\n\r\n  const clsSplit = styleForSplit()\r\n  const classes = styleCommon()\r\n  const DEBUG_VIDEO = false //  To see all local and remote tracks or not.\r\n\r\n  \r\n\r\n  const stores:Stores = {\r\n    map: mapStore,\r\n    participants: participantsStore,\r\n    contents: sharedContentsStore,\r\n    chat: chatStore,\r\n  }\r\n\r\n  const refDiv = useRef<HTMLDivElement>(null)\r\n  const refPane = useRef<SplitPane>(null)\r\n  const [able, setAble] = useState<Boolean>(false)\r\n\r\n  let press = false\r\n\r\n  // For toggle right panel that has users/contents/chat\r\n  window.addEventListener('keydown', (ev) => {\r\n    //ev.preventDefault()\r\n    if(ev.key === \"F3\" && press === false) {\r\n      ev.preventDefault()\r\n      press = true;\r\n      if(able === true) {\r\n        setAble(false)\r\n      } else\r\n      if(able === false) {\r\n        setAble(true)\r\n      } \r\n    }\r\n  }, {})\r\n\r\n  //  toucmove: prevent browser zoom by pinch\r\n  window.addEventListener('touchmove', (ev) => {\r\n    //  if (ev.touches.length > 1) {\r\n    ev.preventDefault()\r\n    //  }\r\n  },                      {passive: false, capture: false})\r\n  //  contextmenu: prevent to show context menu with right mouse click\r\n  window.addEventListener('contextmenu', (ev) => {\r\n    ev.preventDefault()\r\n  },                      {passive: false, capture: false})\r\n\r\n  //  Global error handler\r\n  window.onerror = (message, source, lineno, colno, error) => {\r\n    if ((error?.message === 'Ping timeout' || error?.message === 'Strophe: Websocket error [object Event]')\r\n     && message === null && source === null && lineno === null && colno === null){\r\n      errorInfo.setType('connection')\r\n      if (urlParameters.testBot !== null){  //  testBot\r\n        window.location.reload()  //  testBot will reload when connection is cutted off.\r\n      }\r\n    }else{\r\n      console.warn(`Global handler: ${message}`, source, lineno, colno, error)\r\n    }\r\n    return true\r\n  }\r\n\r\n  return <Observer>{()=>{\r\n    return <ParticipantsProvider value={participantsStore}>\r\n    <ChatProvider value={chatStore}>\r\n    <ContentsProvider value={sharedContentsStore}>\r\n    <MapProvider value={mapStore}>\r\n      <div ref={refDiv} className={classes.back}>\r\n        <SplitPane pane2Style={able === true ? {display: 'block', backgroundColor: '#FF00FF30'} : {display: 'none', backgroundColor: '#FFF'}} ref={refPane} className={classes.fill} split=\"vertical\" resizerClassName={clsSplit.resizerVertical}\r\n          minSize={0} defaultSize={able === true ? \"85%\" : \"100%\"}>\r\n          \r\n          <Fragment>\r\n            <MainScreen showAllTracks = {DEBUG_VIDEO} />\r\n            <Observer>{() => <Map transparent={sharedContentsStore.tracks.mainStream !== undefined\r\n             || DEBUG_VIDEO} {...stores} />\r\n            }</Observer>\r\n            <Footer {...stores} height={(isSmartphone() && isPortrait()) ? 100 : undefined} />\r\n          </Fragment>\r\n          <div style={{display: (able === true ? \"block\" : \"none\")}}>\r\n            <LeftBar {...stores} />\r\n          </div>\r\n        </SplitPane>\r\n      </div>\r\n    </MapProvider>\r\n    </ContentsProvider>\r\n    </ChatProvider>\r\n    </ParticipantsProvider >\r\n  }}</Observer>\r\n}\r\nApp.displayName = 'App'\r\n","import stereoParameters from './StereoParameters'\r\nexport const stereoParametersStore = stereoParameters\r\n","import {MAP_SIZE} from '@components/Constants'\r\nimport {LocalParticipant, PARTICIPANT_SIZE, RemoteParticipant} from '@models/Participant'\r\nimport {ISharedContent} from '@models/ISharedContent'\r\nimport {Pose2DMap} from '@models/utils'\r\nimport {addV2, convertToAudioCoordinate, getRelativePose, mulV2, normV, subV2} from '@models/utils'\r\nimport {stereoParametersStore} from '@stores/AudioParameters'\r\nimport participants from '@stores/participants/Participants'\r\nimport contents from '@stores/sharedContents/SharedContents'\r\nimport {JitsiRemoteTrack, JitsiTrack} from 'lib-jitsi-meet'\r\nimport _ from 'lodash'\r\nimport {autorun, IObservableValue, IReactionDisposer} from 'mobx'\r\nimport {NodeGroup} from './NodeGroup'\r\n\r\n\r\nfunction getRelativePoseFromObject(localPose: Pose2DMap, participant: RemoteParticipant|undefined,\r\n                                   content: ISharedContent|undefined) {\r\n  const remotePose = _.cloneDeep(participant ? participant.pose :\r\n    content ? content.pose : {position:[0, 0], orientation:0}) as Pose2DMap\r\n  if (content) {\r\n    //  remotePose.position = remotePose.position.map((pos, idx) => pos - 0.5 * content.size[idx]) as [number, number]\r\n    localPose.position.forEach((pos, idx) => {\r\n      if (localPose.position[idx] > remotePose.position[idx]) {\r\n        const fromLT = localPose.position[idx] - remotePose.position[idx]\r\n        remotePose.position[idx] += Math.min(content.size[idx], fromLT > 0 ? fromLT : 0)\r\n      }\r\n    })\r\n  }else if (participant && participants.yarnPhones.has(participant.id)) {\r\n    //  This remote participant is directly connected to local participant\r\n    const diff = subV2(remotePose.position, localPose.position)\r\n    const dist = normV(diff)\r\n    if (dist > PARTICIPANT_SIZE * 0.5) {\r\n      const dir = mulV2(0.5 / dist, diff)\r\n      remotePose.position = addV2(localPose.position, dir)\r\n    }\r\n  }\r\n\r\n  return getRelativePose(localPose, remotePose)\r\n}\r\n\r\nexport class ConnectedGroup {\r\n  private readonly disposers: IReactionDisposer[] = []\r\n\r\n  constructor(local: IObservableValue<LocalParticipant>, remote: RemoteParticipant|undefined,\r\n              contentTrack: JitsiRemoteTrack|undefined, group: NodeGroup) {\r\n    this.disposers.push(autorun(\r\n      () => {\r\n        const carrierId = contentTrack?.getParticipantId()\r\n        const cid = carrierId && contents.tracks.carrierMap.get(carrierId)\r\n        const content = cid ? contents.find(cid) : undefined\r\n        const base = _.clone(local.get().pose)\r\n        \r\n\r\n        if (local.get().soundLocalizationBase === 'user') { base.orientation = 0 }\r\n        if (remote && !remote.physics.located) {\r\n          // not located yet -> mute sound\r\n          group.updatePose(convertToAudioCoordinate({orientation:0, position:[MAP_SIZE, MAP_SIZE]}))\r\n        } else {\r\n          const relativePose = getRelativePoseFromObject(base, remote, content)\r\n          const pose = convertToAudioCoordinate(relativePose)\r\n          group.updatePose(pose)\r\n        }\r\n      },\r\n    ))\r\n\r\n    this.disposers.push(autorun(\r\n      () => {\r\n        const track: JitsiTrack | undefined = remote ? remote.tracks.audio : contentTrack\r\n        group.updateStream(track?.getOriginalStream())\r\n      },\r\n    ))\r\n\r\n    this.disposers.push(autorun(\r\n      () => group.updatePannerConfig(stereoParametersStore),\r\n    ))\r\n\r\n    this.disposers.push(autorun(\r\n      () => group.updateBroadcast(remote?.physics.onStage ? true : false),\r\n    ))\r\n  }\r\n\r\n  dispose() {\r\n    for (const disposer of this.disposers) {\r\n      disposer()\r\n    }\r\n  }\r\n}\r\n","import {priorityCalculator} from '@models/middleware/trafficControl'\r\nimport {assert} from '@models/utils'\r\nimport errorInfo from '@stores/ErrorInfo'\r\nimport {autorun} from 'mobx'\r\nimport {NodeGroup, PlayMode, setAudioOutputDevice} from './NodeGroup'\r\n\r\nexport class StereoManager {\r\n  private readonly audioContext: AudioContext = new window.AudioContext()\r\n  private readonly audioDestination = this.audioContext.createMediaStreamDestination()\r\n\r\n  private readonly audioElement = new Audio()   //  audioElement for context mode\r\n  private playMode: PlayMode = 'Pause'\r\n\r\n  nodes: {\r\n    [key: string]: NodeGroup,\r\n  } = {}\r\n\r\n  constructor() {\r\n    if (false) {\r\n      //  For ACE workaround for chrome, make local RTC loopback. But it also make sound monaural and useless.\r\n      const peerGo = new RTCPeerConnection()\r\n      const peerBack = new RTCPeerConnection()\r\n      this.audioDestination.stream.getAudioTracks().forEach(track => peerGo.addTrack(track))\r\n      let inboundStream:MediaStream|undefined = undefined\r\n      peerBack.ontrack = (ev) => {\r\n        if (ev.streams && ev.streams[0]) {\r\n          this.audioElement.srcObject = ev.streams[0]\r\n        }else {\r\n          if (!inboundStream) {\r\n            inboundStream = new MediaStream()\r\n          }\r\n          inboundStream.addTrack(ev.track)\r\n          this.audioElement.srcObject = inboundStream\r\n        }\r\n      }\r\n      peerGo.createOffer().then((offer) => {\r\n        return peerGo.setLocalDescription(offer)\r\n      }).then(() => {\r\n        console.log('peerGo set offer.')\r\n      }).catch((reason) => {\r\n        console.error('peerGo set offer failed', reason)\r\n      })\r\n\r\n      let bAnswerSent = false\r\n      peerGo.onicecandidate = (ev) => {\r\n        if (bAnswerSent) { return }\r\n        bAnswerSent = true\r\n\r\n        const offer = peerGo.localDescription\r\n        if (offer) {\r\n          peerBack.setRemoteDescription(offer).then(() => {\r\n            peerBack.createAnswer().then((answer) => {\r\n              peerBack.setLocalDescription(answer)\r\n              console.log('peerBack set answer.')\r\n\r\n              console.log('peerGo.signalingState', peerGo.signalingState)\r\n              peerGo.setRemoteDescription(answer)\r\n              .then(() => {\r\n                console.log('peerGo set answer.')\r\n              }).catch((err) => {\r\n                console.error('peerGo set answer failed:', err)\r\n              })\r\n            })\r\n          })\r\n        }else {\r\n          console.error('onicecnadidate: offer is null')\r\n        }\r\n      }\r\n    }else {\r\n      this.audioElement.srcObject = this.audioDestination.stream\r\n    }\r\n  }\r\n\r\n  addSpeaker(id: string) {\r\n    assert(this.nodes[id] === undefined)\r\n    this.nodes[id] = new NodeGroup(this.audioContext, this.audioDestination,\r\n                                   this.playMode, !this.audioOutputMuted)\r\n\r\n    return this.nodes[id]\r\n  }\r\n\r\n  removeSpeaker(id: string) {\r\n    //  console.log('remove speaker')\r\n    this.nodes[id].disconnect()\r\n    delete this.nodes[id]\r\n  }\r\n\r\n  switchPlayMode(playMode: PlayMode, muted: boolean) {\r\n    assert(playMode !== 'Pause')\r\n    if (this.playMode === 'Pause') {\r\n      //  this occurs only once when valid playMode has been set\r\n      autorun(() => {\r\n        const accepts = new Set(priorityCalculator.tracksToAccept[1].map(info => info.endpointId))\r\n        for (const id in this.nodes) {\r\n          if (accepts.has(id)) {\r\n            this.nodes[id].setPlayMode(this.playMode)\r\n          }else {\r\n            this.nodes[id].setPlayMode('Pause')\r\n          }\r\n        }\r\n      })\r\n    }\r\n\r\n    if (playMode === this.playMode && muted === this.audioOutputMuted) {\r\n      return\r\n    }\r\n    this.playMode = playMode\r\n\r\n    switch (playMode) {\r\n      case 'Context':\r\n        // For Chrome, resume audio context when loaded (https://goo.gl/7K7WLu)\r\n        // AudioContext must be resumed (or created) after a user gesture on the page.\r\n        const interval = setInterval(\r\n          () => {\r\n            if (errorInfo.type) { return }\r\n            // console.log(`Audio context = ${this.audioContext.state}  element = ${this.audioElement.played}`)\r\n            if (this.audioContext.state !== 'suspended') {\r\n              //  console.log('AudioContext successfully resumed')\r\n              clearInterval(interval)\r\n            }\r\n            this.audioContext.resume()\r\n            this.audioElement.play()  //  play() must be delayed\r\n          },\r\n          1000,\r\n        )\r\n\r\n        for (const id in this.nodes) {\r\n          this.nodes[id].setPlayMode(playMode)\r\n        }\r\n        break\r\n\r\n      case 'Element':\r\n        this.audioContext.suspend()\r\n        this.audioElement.pause()\r\n\r\n        for (const id in this.nodes) {\r\n          this.nodes[id].setPlayMode(playMode)\r\n        }\r\n        break\r\n\r\n      default:\r\n        console.error(`Unsupported play mode: ${playMode}`)\r\n        break\r\n    }\r\n\r\n    this.audioOutputMuted = muted\r\n  }\r\n\r\n  setAudioOutput(deviceId:string) {\r\n    setAudioOutputDevice(this.audioElement, deviceId)\r\n    for (const node in this.nodes) {\r\n      this.nodes[node].setAudioOutput(deviceId)\r\n    }\r\n\r\n  }\r\n\r\n  set audioOutputMuted(muted: boolean) {\r\n    for (const id in this.nodes) {\r\n      this.nodes[id].updateAudibility(!muted)\r\n    }\r\n    this.audioDestination.stream.getTracks().forEach((track) => { track.enabled = !muted })\r\n  }\r\n  get audioOutputMuted():boolean {\r\n    return !(this.audioDestination.stream.getTracks().length > 0\r\n      && this.audioDestination.stream.getTracks()[0].enabled)\r\n  }\r\n}\r\n","import {ConnectedManager} from './ConnectedManager'\r\n\r\nexport const manager = new ConnectedManager()\r\n","import {RemoteParticipant} from '@models/Participant'\r\nimport {urlParameters} from '@models/url'\r\nimport {diffMap} from '@models/utils'\r\nimport participants from '@stores/participants/Participants'\r\nimport contents from '@stores/sharedContents/SharedContents'\r\nimport {JitsiRemoteTrack} from 'lib-jitsi-meet'\r\nimport {autorun} from 'mobx'\r\nimport {ConnectedGroup} from './ConnectedGroup'\r\nimport {StereoManager} from './StereoManager'\r\nexport class ConnectedManager {\r\n  private readonly manager = new StereoManager()\r\n\r\n  private readonly connectedGroups: {\r\n    [key: string]: ConnectedGroup,\r\n  } = {}\r\n\r\n  private participantsMemo = new Map<string, RemoteParticipant>()\r\n  private contentsMemo = new Map<string, Set<JitsiRemoteTrack>>()\r\n\r\n  public setAudioOutput(deviceId: string) {\r\n    this.manager.setAudioOutput(deviceId)\r\n  }\r\n  constructor() {\r\n    if (urlParameters.testBot !== null) { return }\r\n\r\n    autorun(this.onPopulationChange)\r\n    autorun(this.onScreenContentsChange)\r\n    autorun(\r\n      () => {\r\n        const muteSpeaker = participants.local.muteSpeaker || participants.local.awayFromKeyboard\r\n        this.manager.switchPlayMode(participants.local.useStereoAudio ? 'Context' : 'Element', muteSpeaker)\r\n      },\r\n    )\r\n  }\r\n\r\n  private onPopulationChange = () => {\r\n    const newRemotes = new Map(participants.remote)\r\n    const added = diffMap(newRemotes, this.participantsMemo)\r\n    const removed = diffMap(this.participantsMemo, newRemotes)\r\n    removed.forEach(this.remove)\r\n    added.forEach(this.add)\r\n    this.participantsMemo = newRemotes\r\n    //  console.log('Update connectedGroups:', this.connectedGroups)\r\n  }\r\n\r\n  private onScreenContentsChange = () => {\r\n    const newRemotes = new Map(contents.tracks.remoteContents)\r\n    const added = diffMap(newRemotes, this.contentsMemo)\r\n    const removed = diffMap(this.contentsMemo, newRemotes)\r\n    removed.forEach(this.removeContent)\r\n    added.forEach(this.addContent)\r\n    this.contentsMemo = newRemotes\r\n  }\r\n\r\n  private remove = (rp: RemoteParticipant) => {\r\n    const id = rp.id\r\n    this.connectedGroups[id].dispose()\r\n    delete this.connectedGroups[id]\r\n\r\n    this.manager.removeSpeaker(id)\r\n  }\r\n\r\n  private add = (remote: RemoteParticipant) => {\r\n    const group = this.manager.addSpeaker(remote.id)\r\n    this.connectedGroups[remote.id] = new ConnectedGroup(participants.local_, remote, undefined, group)\r\n  }\r\n\r\n  private removeContent = (tracks: Set<JitsiRemoteTrack>) => {\r\n    const audioTrack = Array.from(tracks.values()).find(track => track.getType() === 'audio')\r\n\r\n    if (audioTrack) {\r\n      const carrierId = audioTrack.getParticipantId()\r\n      if (carrierId) {\r\n        this.connectedGroups[carrierId].dispose()\r\n        delete this.connectedGroups[carrierId]\r\n\r\n        this.manager.removeSpeaker(carrierId)\r\n      }else {\r\n        console.error('removeContent: track does not have content id.', audioTrack)\r\n      }\r\n    }\r\n  }\r\n\r\n  private addContent = (tracks: Set<JitsiRemoteTrack>) => {\r\n    const audioTrack = Array.from(tracks.values()).find(track => track.getType() === 'audio')\r\n    if (audioTrack) {\r\n      const carrierId = audioTrack.getParticipantId()\r\n      if (carrierId) {\r\n        const group = this.manager.addSpeaker(carrierId)\r\n        this.connectedGroups[carrierId] = new ConnectedGroup(participants.local_, undefined, audioTrack, group)\r\n      }else {\r\n        console.error('addContent: track does not have content id.', audioTrack)\r\n      }\r\n    }\r\n  }\r\n}\r\n","import {connection} from '@models/api'\r\nimport { getNotificationPermission } from '@models/api/Notification'\r\nimport {manager as audioManager} from '@models/audio'\r\nimport {urlParameters} from '@models/url'\r\nimport participants from '@stores/participants/Participants'\r\nimport JitsiMeetJS, {JitsiLocalTrack} from 'lib-jitsi-meet'\r\nimport {autorun} from 'mobx'\r\n\r\n// config.js\r\ndeclare const config:any                  //  from ../../config.js included from index.html\r\n\r\n//  mic device selection\r\nexport function createLocalMic() {\r\n  const promise = new Promise<JitsiLocalTrack>((resolutionFunc, rejectionFunc) => {\r\n    const did = participants.local.devicePreference.audioInputDevice\r\n    JitsiMeetJS.createLocalTracks({devices:['audio'],\r\n      constraints: config.rtc.audioConstraints, micDeviceId: did}).then(\r\n      (tracks: JitsiLocalTrack[]) => {\r\n        connection.conference.setLocalMicTrack(tracks[0])\r\n        resolutionFunc(tracks[0])\r\n      },\r\n    ).catch(rejectionFunc)\r\n  })\r\n\r\n  return promise\r\n}\r\n\r\n//  Mute reaction for mic\r\n/*\r\nconst DELETE_MIC_TRACK = false\r\nif (DELETE_MIC_TRACK){\r\n  autorun(() => {\r\n    const did = participants.local.devicePreference.audioInputDevice\r\n    const muted = participants.local.muteAudio|| participants.local.awayFromKeyboard\r\n    if (participants.localId && !muted && urlParameters.testBot === null) {\r\n      const track = connection.conference.getLocalMicTrack()\r\n      if (track && track.getDeviceId() === did) { return }\r\n      createLocalMic().finally(getNotificationPermission)\r\n    }else{\r\n      connection.conference.setLocalMicTrack(undefined).then(track => track?.dispose())\r\n    }\r\n    if (participants.local.muteAudio) {\r\n      participants.local.tracks.audioLevel = 0\r\n    }\r\n  })\r\n}else{\r\n  autorun(() => {\r\n    const muteAudio = participants.local.muteAudio\r\n     || participants.local.awayFromKeyboard\r\n    const track = participants.local.tracks.audio as JitsiLocalTrack\r\n    if (track) { muteAudio ? track.mute() : track.unmute() }\r\n    if (muteAudio) {\r\n      participants.local.tracks.audioLevel = 0\r\n    }\r\n  })\r\n}\r\n*/\r\n//  mic mute and audio input device selection\r\nconst DELETE_MIC_TRACK = true\r\nautorun(() => {\r\n  const did = participants.local.devicePreference.audioInputDevice\r\n  const muted = participants.local.muteAudio || participants.local.awayFromKeyboard\r\n  if (participants.localId && !muted && urlParameters.testBot === null) {\r\n    const track = connection.conference.getLocalMicTrack()\r\n    if (track && track.getDeviceId() === did) { return }\r\n    createLocalMic().finally(getNotificationPermission)\r\n  }else{\r\n    if (DELETE_MIC_TRACK){\r\n      connection.conference.setLocalMicTrack(undefined).then(track => {\r\n        track?.dispose()\r\n        participants.local.tracks.audioLevel = 0\r\n      })\r\n    } else {\r\n      const track = connection.conference.getLocalMicTrack()\r\n      if (track) { connection.conference.removeTrack(track) }\r\n      participants.local.tracks.audioLevel = 0\r\n    }\r\n  }\r\n})\r\n\r\n/*\r\n//  microphone or audio input device update\r\nautorun(() => {\r\n  const did = participants.local.devicePreference.audioInputDevice\r\n  const muted = participants.local.muteAudio\r\n  if (participants.localId && !muted && urlParameters.testBot === null) {\r\n    const track = connection.conference.getLocalMicTrack()\r\n    if (track && track.getDeviceId() === did) { return }\r\n    createLocalMic().finally(getNotificationPermission)\r\n  }\r\n})\r\n*/\r\n\r\n//  headphone or audio output device update\r\nautorun(() => {\r\n  const did = participants.local.devicePreference.audioOutputDevice\r\n  if (did) {\r\n    audioManager.setAudioOutput(did)\r\n  }\r\n})\r\n\r\n//  camera device selection\r\nexport function createLocalCamera() {\r\n  const promise = new Promise<JitsiLocalTrack>((resolutionFunc, rejectionFunc) => {\r\n    const did = participants.local.devicePreference.videoInputDevice\r\n    JitsiMeetJS.createLocalTracks({devices:['video'],\r\n      constraints: config.rtc.videoConstraints, cameraDeviceId: did}).then(\r\n      (tracks: JitsiLocalTrack[]) => {\r\n        connection.conference.setLocalCameraTrack(tracks[0])\r\n        resolutionFunc(tracks[0])\r\n      },\r\n    ).catch(rejectionFunc)\r\n  })\r\n\r\n  return promise\r\n}\r\n\r\n//  camera mute and camera device update\r\nconst DELETE_TRACK = true\r\nautorun(() => {\r\n  const did = participants.local.devicePreference.videoInputDevice\r\n  const muted = participants.local.muteVideo\r\n    || participants.local.awayFromKeyboard\r\n  if (participants.localId && !muted && urlParameters.testBot === null) {\r\n    const track = connection.conference.getLocalCameraTrack()\r\n    if (track && track.getDeviceId() === did) { return }\r\n    createLocalCamera().finally(getNotificationPermission)\r\n  }else{\r\n    if (DELETE_TRACK){\r\n      connection.conference.setLocalCameraTrack(undefined).then(track => track?.dispose())\r\n    } else {\r\n      const track = connection.conference.getLocalCameraTrack()\r\n      if (track) { connection.conference.removeTrack(track) }\r\n    }\r\n  }\r\n})\r\n","import {App} from '@components/App'\r\nimport {connection} from '@models/api'\r\nimport '@models/audio'  // init audio manager (DO NOT delete)\r\nimport {i18nInit} from '@models/locales'\r\nimport '@models/middleware'\r\nimport {urlParameters} from '@models/url'\r\nimport {resolveAtEnd} from '@models/utils'\r\nimport errorInfo from '@stores/ErrorInfo'\r\nimport '@stores/index'  // init store (DO NOT delete)\r\nimport contents from '@stores/sharedContents/SharedContents'\r\nimport {when} from 'mobx'\r\nimport {configure} from \"mobx\"\r\nimport ReactDOM from 'react-dom'\r\n\r\nconfigure({\r\n    enforceActions: \"never\",\r\n})\r\n\r\n\r\ni18nInit().then(main)\r\n\r\nfunction main() {\r\n  const startPromise = resolveAtEnd(onStart)()\r\n  startPromise.then(resolveAtEnd(renderDOM))\r\n  startPromise.then(resolveAtEnd(connectConference))\r\n}\r\n\r\nfunction onStart() {\r\n  //  console.debug('start')\r\n}\r\n\r\nfunction renderDOM() {\r\n  ReactDOM.render(\r\n      <App />,\r\n    document.getElementById('root')\r\n  )\r\n}\r\n\r\nlet logStr = ''\r\nfunction connectConference() {\r\n  window.addEventListener('beforeunload', (ev) => {\r\n    logStr = `${logStr}beforeunload called. ${Date()} `\r\n    localStorage.setItem('log', logStr)\r\n\r\n    //  prevent leaving from and reloading browser, when the user shares screen(s).\r\n    if (!errorInfo.type &&\r\n      (contents.tracks.localMains.size || contents.tracks.localContents.size)) {\r\n      logStr += 'Ask user. '\r\n      ev.preventDefault()\r\n      ev.stopImmediatePropagation()\r\n      ev.returnValue = ''\r\n      localStorage.setItem('log', logStr)\r\n\r\n      return ev.returnValue\r\n    }\r\n    connection.leaveConference()\r\n    connection.disconnect().then((arg) => {\r\n      logStr += `Diconnected (${arg}). `\r\n      localStorage.setItem('log', logStr)\r\n    }).catch((reason) => {\r\n      logStr += `Failed to diconnected (${reason}). `\r\n      localStorage.setItem('log', logStr)\r\n    })\r\n  })\r\n\r\n  errorInfo.connectionStart()\r\n  connection.init().then(\r\n    () => {\r\n      when(() => errorInfo.type === '', () => {\r\n        const conferenceName = urlParameters.room || '_'\r\n        connection.joinConference(conferenceName)\r\n      })\r\n    },\r\n  )\r\n}\r\n"],"sourceRoot":""}